name: Deploy to Netlify

on:
  workflow_run:
    workflows: ["Build"]
    types:
      - completed

permissions:
  actions: write
  contents: read
  pull-requests: write

jobs:
  deploy:
    name: Deploy to Netlify
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - uses: actions/checkout@v4

      - name: Set build identifier
        id: build-id
        env:
          EVENT: ${{ github.event.workflow_run.event }}
          HEAD_OWNER: ${{ github.event.workflow_run.head_repository.owner.login }}
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          if [ "$EVENT" = "push" ]; then
            BUILD_ID="main"
            echo "is_main=true" >> $GITHUB_OUTPUT
          else
            # Derive PR number from the workflow run's head branch via API
            # instead of trusting the artifact (which fork PRs can manipulate)
            PR_NUMBER=$(gh api "repos/$REPO/pulls?head=$HEAD_OWNER:$HEAD_BRANCH&state=open" \
              --jq '.[0].number // empty')
            if [ -z "$PR_NUMBER" ]; then
              echo "::error::Could not find PR for $HEAD_OWNER:$HEAD_BRANCH"
              exit 1
            fi
            BUILD_ID="$PR_NUMBER"
            echo "is_main=false" >> $GITHUB_OUTPUT
          fi
          echo "value=$BUILD_ID" >> $GITHUB_OUTPUT

      - name: Download build artifacts
        uses: actions/github-script@v7
        env:
          ARTIFACT_NAME: website-build-${{ steps.build-id.outputs.value }}
          EXTRACT_PATH: website/build
        with:
          script: |
            const { downloadArtifact } = require('./.github/scripts/artifact-utils.js');
            await downloadArtifact({ github, context });

      - name: Clean up GitHub artifacts
        uses: actions/github-script@v7
        env:
          BUILD_ID: ${{ steps.build-id.outputs.value }}
        with:
          script: |
            const { deleteBuildArtifacts } = require('./.github/scripts/artifact-utils.js');
            await deleteBuildArtifacts({ github, context });

      - name: Install Netlify CLI
        run: npm install -g netlify-cli

      - name: Deploy to Netlify
        working-directory: website
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
          BUILD_ID: ${{ steps.build-id.outputs.value }}
          IS_MAIN: ${{ steps.build-id.outputs.is_main }}
          ACTION_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ "$IS_MAIN" = "true" ]; then
            ALIAS="main"
            MESSAGE="Main Deploy - GitHub Action: ${ACTION_URL}"
          else
            ALIAS="pr-${BUILD_ID}"
            MESSAGE="PR Preview #${BUILD_ID} - GitHub Action: ${ACTION_URL}"
          fi
          netlify deploy \
            --dir=build \
            --no-build \
            --alias="$ALIAS" \
            --message="$MESSAGE"

      - name: Comment PR with preview URL
        if: ${{ steps.build-id.outputs.is_main == 'false' }}
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.build-id.outputs.value }}
          NETLIFY_DOMAIN: ${{ secrets.NETLIFY_SITE_NAME }}
          DEPLOY_ACTION_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          BUILD_ACTION_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}
        with:
          script: |
            const script = require('./.github/scripts/preview-comment.js');
            await script({ github, context });
