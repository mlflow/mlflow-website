<!doctype html><html lang=en dir=ltr class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated=false><head><meta charset=UTF-8><meta name=generator content="Docusaurus v3.9.2"><title data-rh=true>From Natural Language to SQL: Building and Tracking a Multi-Lingual Query Engine | MLflow</title><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"/><meta data-rh=true name=twitter:card content=summary_large_image /><meta data-rh=true property=og:url content=http://mlflow.org/mlflow-website/blog/from-natural-language-to-sql /><meta data-rh=true property=og:locale content=en /><meta data-rh=true name=docusaurus_locale content=en /><meta data-rh=true name=docusaurus_tag content=default /><meta data-rh=true name=docsearch:language content=en /><meta data-rh=true name=docsearch:docusaurus_tag content=default /><meta data-rh=true property=og:title content="From Natural Language to SQL: Building and Tracking a Multi-Lingual Query Engine | MLflow"/><meta data-rh=true name=description content="MLflow Models from Code and MLflow Tracing applied to AI Workflows"/><meta data-rh=true property=og:description content="MLflow Models from Code and MLflow Tracing applied to AI Workflows"/><meta data-rh=true property=og:image content=http://mlflow.org/mlflow-website/img/blog/from-natural-language-to-sql.png /><meta data-rh=true name=twitter:image content=http://mlflow.org/mlflow-website/img/blog/from-natural-language-to-sql.png /><meta data-rh=true property=og:type content=article /><meta data-rh=true property=article:published_time content=2025-01-23T00:00:00.000Z /><meta data-rh=true property=article:author content=https://www.linkedin.com/in/hugodscarvalho/,https://www.linkedin.com/in/joanaferreira96/,https://www.linkedin.com/in/rahulpandey1901/ /><meta data-rh=true property=article:tag content=pyfunc,mlflow,sql-generator,models-from-code,tracing /><link data-rh=true rel=icon href=/mlflow-website/img/mlflow-favicon.ico /><link data-rh=true rel=canonical href=http://mlflow.org/mlflow-website/blog/from-natural-language-to-sql /><link data-rh=true rel=alternate href=http://mlflow.org/mlflow-website/blog/from-natural-language-to-sql hreflang=en /><link data-rh=true rel=alternate href=http://mlflow.org/mlflow-website/blog/from-natural-language-to-sql hreflang=x-default /><script data-rh=true type=application/ld+json>{"@context":"https://schema.org","@id":"http://mlflow.org/mlflow-website/blog/from-natural-language-to-sql","@type":"BlogPosting","author":[{"@type":"Person","description":"Machine Learning Analyst at adidas","image":"/mlflow-website/img/authors/hugo_carvalho.png","name":"Hugo Carvalho","url":"https://www.linkedin.com/in/hugodscarvalho/"},{"@type":"Person","description":"Machine Learning Engineer at adidas","image":"/mlflow-website/img/authors/joana_ferreira.png","name":"Joana Ferreira","url":"https://www.linkedin.com/in/joanaferreira96/"},{"@type":"Person","description":"Sr. Solutions Architect at adidas","image":"/mlflow-website/img/authors/rahul_pandey.png","name":"Rahul Pandey","url":"https://www.linkedin.com/in/rahulpandey1901/"}],"datePublished":"2025-01-23T00:00:00.000Z","description":"MLflow Models from Code and MLflow Tracing applied to AI Workflows","headline":"From Natural Language to SQL: Building and Tracking a Multi-Lingual Query Engine","image":{"@id":"http://mlflow.org/mlflow-website/img/blog/from-natural-language-to-sql.png","@type":"ImageObject","caption":"title image for the blog post: From Natural Language to SQL: Building and Tracking a Multi-Lingual Query Engine","contentUrl":"http://mlflow.org/mlflow-website/img/blog/from-natural-language-to-sql.png","url":"http://mlflow.org/mlflow-website/img/blog/from-natural-language-to-sql.png"},"isPartOf":{"@id":"http://mlflow.org/mlflow-website/blog","@type":"Blog","name":"Blog"},"keywords":[],"mainEntityOfPage":"http://mlflow.org/mlflow-website/blog/from-natural-language-to-sql","name":"From Natural Language to SQL: Building and Tracking a Multi-Lingual Query Engine","url":"http://mlflow.org/mlflow-website/blog/from-natural-language-to-sql"}</script><link rel=preconnect href=https://www.google-analytics.com><link rel=preconnect href=https://www.googletagmanager.com><script async src="https://www.googletagmanager.com/gtag/js?id=AW-16857946923"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","AW-16857946923",{anonymize_ip:!0})</script><link rel=preconnect href=https://www.googletagmanager.com><script>window.dataLayer=window.dataLayer||[],function(e,t,a,n,r){e[n]=e[n]||[],e[n].push({"gtm.start":new Date().getTime(),event:"gtm.js"});var d=t.getElementsByTagName(a)[0],g=t.createElement(a);g.async=!0,g.src="https://www.googletagmanager.com/gtm.js?id="+r+("dataLayer"!=n?"&l="+n:""),d.parentNode.insertBefore(g,d)}(window,document,"script","dataLayer","GTM-N6WMTTJ")</script><link rel=alternate type=application/rss+xml href=/mlflow-website/blog/rss.xml title="MLflow RSS Feed"><link rel=alternate type=application/atom+xml href=/mlflow-website/blog/atom.xml title="MLflow Atom Feed"><link rel=alternate type=application/rss+xml href=/mlflow-website/releases/rss.xml title="MLflow RSS Feed"><link rel=alternate type=application/atom+xml href=/mlflow-website/releases/atom.xml title="MLflow Atom Feed"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin=anonymous><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" display=swap><link rel=stylesheet href=/mlflow-website/assets/css/styles.d55e5617.css /><script src=/mlflow-website/assets/js/runtime~main.89e1452c.js defer></script><script src=/mlflow-website/assets/js/main.e4060ac2.js defer></script></head><body class=navigation-with-keyboard><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-N6WMTTJ" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript>


<svg style="display: none;"><defs>
<symbol id=theme-svg-external-link viewBox="0 0 24 24"><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"light"),document.documentElement.setAttribute("data-theme-choice",t||"light")}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="theme-layout-navbar navbar navbar--fixed-top"><div class=navbar__inner><div class="theme-layout-navbar-left navbar__items"><a class=navbar__brand href=/mlflow-website/></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type=button disabled title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill=currentColor d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"/></svg></button></div><div class=navbarSearchContainer_Bca1></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="flex flex-col min-h-screen w-full bg-[#0E1416]"><nav class="fixed w-full z-20 top-0 start-0 bg-black/20 border-b border-[#F7F8F8]/8 backdrop-blur-[20px] overflow-y-auto"><div class="flex flex-wrap items-center mx-auto px-6 lg:px-20 py-2 max-w-container"><div class="md:contents flex flex-row justify-between w-full sticky top-[8px]"><a class="flex items-center space-x-3 rtl:space-x-reverse grow basis-0" href=/mlflow-website/><svg xmlns=http://www.w3.org/2000/svg width=109 height=40 fill=none viewBox="0 0 109 40" class=h-[36px]><path fill=#fff d="M0 31.032v-15.53h3.543v1.968c.893-1.594 2.84-2.425 4.593-2.425 2.042 0 3.828.926 4.658 2.745 1.216-2.043 3.034-2.745 5.043-2.745 2.81 0 5.49 1.787 5.49 5.904v10.083h-3.574v-9.478c0-1.818-.926-3.19-3-3.19-1.947 0-3.224 1.53-3.224 3.445v9.22H9.893v-9.475c0-1.786-.898-3.18-3.003-3.18-1.977 0-3.223 1.467-3.223 3.444v9.221ZM27.855 31.032V7.929h3.703v23.103ZM30.07 39.487c.833.232 1.582.383 3.17.383 2.953 0 6.436-1.665 7.353-6.339l3.786-18.739h5.629l.687-3.117h-5.686l.765-3.725c.586-2.892 2.186-4.358 4.754-4.358.668 0 .48.058 1.076.17L52.427.57c-.793-.237-1.503-.379-3.049-.379a7.32 7.32 0 0 0-4.528 1.484c-1.441 1.114-2.393 2.75-2.827 4.863l-1.066 5.137h-5.034l-.411 3.12h4.823L36.859 32.12c-.383 1.965-1.5 4.315-4.708 4.315-.727 0-.463-.055-1.121-.162ZM53.342 30.905H49.64l5.074-23.309h3.701ZM71.807 16.477A7.962 7.962 0 0 0 60.97 27.904l2.425-1.78a5.005 5.005 0 0 1 3.845-8.145v1.895ZM62.618 29.472a7.962 7.962 0 0 0 10.836-11.428l-2.425 1.78a5.005 5.005 0 0 1-3.845 8.145v-1.894ZM78.092 15.493h4.044l.823 10.612 5.759-10.612 3.839.055 1.508 10.557 5.074-10.612 3.701.055-7.678 15.493H91.46l-1.783-11.106-5.895 11.106h-3.84ZM105.072 15.768h-.766v-.266h1.845v.272h-.765v2.243h-.314ZM106.614 15.502h.383l.482 1.34q.091.259.178.524h.018c.059-.176.113-.352.172-.524l.478-1.34h.383v2.515h-.298V16.63c0-.22.024-.523.04-.747h-.016l-.191.574-.475 1.304h-.208l-.481-1.302-.191-.574h-.015c.017.224.042.527.042.747v1.387h-.291Z"/></svg></a><div class="flex flex-row items-center gap-6 md:order-2 space-x-3 md:space-x-0 rtl:space-x-reverse grow justify-end basis-0"><a class="hidden md:block" href=/mlflow-website/#get-started><button class="rounded-xl inline-flex items-center justify-center whitespace-nowrap font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 hover:cursor-pointer bg-white text-black hover:bg-gray-900 text-[15px] px-4 py-2 w-fit">Get started</button></a><button data-collapse-toggle=navbar-sticky type=button class="inline-flex items-center p-2 w-10 h-10 justify-center text-sm text-white md:hidden focus:outline-none cursor-pointer"><span class=sr-only>Open main menu</span><svg class="w-5 h-5" aria-hidden=true xmlns=http://www.w3.org/2000/svg fill=none viewBox="0 0 17 14"><path stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M1 1h15M1 7h15M1 13h15"/></svg></button></div></div><div class="items-center justify-between w-full md:w-auto md:order-1 mt-4 md:mt-0 hidden md:flex"><ul class="flex flex-col font-medium md:flex-row gap-y-6 gap-x-4 lg:gap-x-10 w-full md:w-auto"><li class="w-full md:w-auto md:hidden"><button type=button aria-expanded=false aria-controls=mobile-components-submenu class="flex items-center justify-between gap-2 py-2 text-white text-lg w-full cursor-pointer transition-colors duration-200 hover:text-white/60">Components<svg xmlns=http://www.w3.org/2000/svg width=16 height=17 fill=none viewBox="0 0 16 17" class="w-6 h-6 transition-transform duration-300"><path fill=#F7F8F8 fill-rule=evenodd d="m8 10.776 3.61-3.61-.943-.942L8 8.89 5.333 6.224l-.942.943z" clip-rule=evenodd /></svg></button><div id=mobile-components-submenu class="transition-all duration-300 ease-in-out overflow-hidden max-h-0 opacity-0"><div class="flex flex-col md:flex-row md:max-w-4xl mx-auto gap-6 md:gap-8 lg:gap-10 px-1 md:px-4 lg:pl-0 products-submenu overflow-x-hidden"><div class="flex flex-col gap-4"><div class="flex flex-col gap-1 md:gap-4 border-b border-[#F7F8F8]/8 pb-4 group"><a href=/mlflow-website/genai><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">GenAI Apps & Agents</h3><p class="text-[#F7F8F8]/60 m-0">Ship high-quality GenAI, fast</p></a></div><div class="flex flex-col gap-3"><span class="text-[#F7F8F8]/60 text-sm">Features</span><div class="flex flex-row gap-6 xxs:gap-8"><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/observability>Observability</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/evaluations>Evaluations</a></div><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/prompt-registry>Prompt Registry</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/ai-gateway>AI Gateway</a></div></div></div></div><div class="flex flex-col gap-4"><div class="flex flex-col gap-1 md:gap-4 border-b border-[#F7F8F8]/8 pb-4 group"><a href=/mlflow-website/classical-ml><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">Model Training</h3><p class="text-[#F7F8F8]/60 m-0">Mastering the ML lifecycle</p></a></div><div class="flex flex-col gap-3"><span class="text-[#F7F8F8]/60 text-sm">Features</span><div class="flex flex-row gap-6 xxs:gap-8"><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/experiment-tracking>Experiment tracking</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/model-evaluation>Model evaluation</a></div><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/models>MLflow models</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/model-registry>Model Registry & deployment</a></div></div></div></div></div></div><li class="w-full md:w-auto hidden md:block"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60">Components<svg xmlns=http://www.w3.org/2000/svg width=16 height=17 fill=none viewBox="0 0 16 17" class="w-6 h-6"><path fill=#F7F8F8 fill-rule=evenodd d="m8 10.776 3.61-3.61-.943-.942L8 8.89 5.333 6.224l-.942.943z" clip-rule=evenodd /></svg></a><li class="w-full md:w-auto"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/releases>Releases</a><li class="w-full md:w-auto"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/blog>Blog</a><li class="w-full md:w-auto md:hidden"><button type=button aria-expanded=false aria-controls=mobile-docs-submenu class="flex items-center justify-between gap-2 py-2 text-white text-lg w-full cursor-pointer transition-colors duration-200 hover:text-white/60">Docs<svg xmlns=http://www.w3.org/2000/svg width=16 height=17 fill=none viewBox="0 0 16 17" class="w-6 h-6 transition-transform duration-300"><path fill=#F7F8F8 fill-rule=evenodd d="m8 10.776 3.61-3.61-.943-.942L8 8.89 5.333 6.224l-.942.943z" clip-rule=evenodd /></svg></button><div id=mobile-docs-submenu class="transition-all duration-300 ease-in-out overflow-hidden max-h-0 opacity-0"><div class="flex flex-col md:flex-row md:max-w-2xl mx-auto gap-6 md:gap-8 lg:gap-10 px-1 md:px-4 lg:pl-0 docs-submenu overflow-x-hidden"><div class="flex flex-col gap-1 md:gap-2 pb-4 flex-1 group"><a href=https://mlflow.org/docs/latest/genai/ target=_blank rel="noopener noreferrer"><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">GenAI Apps & Agents</h3><p class="text-[#F7F8F8]/60 m-0">Learn how to track, evaluate, and optimize your GenAI applications and agent workflows.</p></a></div><div class="flex flex-col gap-1 md:gap-2 pb-4 flex-1 group"><a href=https://mlflow.org/docs/latest/ml/ target=_blank rel="noopener noreferrer"><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">Model Training</h3><p class="text-[#F7F8F8]/60 m-0">Get started with the core functionality for traditional machine learning workflows, hyperparameter tuning, and model lifecycle management.</p></a></div></div></div><li class="w-full md:w-auto hidden md:block"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60">Docs<svg xmlns=http://www.w3.org/2000/svg width=16 height=17 fill=none viewBox="0 0 16 17" class="w-6 h-6"><path fill=#F7F8F8 fill-rule=evenodd d="m8 10.776 3.61-3.61-.943-.942L8 8.89 5.333 6.224l-.942.943z" clip-rule=evenodd /></svg></a><li class="w-full md:w-auto"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/ambassadors>Ambassador Program</a><li class="w-full md:w-auto md:hidden"><a href=/mlflow-website/#get-started><button class="rounded-xl inline-flex items-center justify-center whitespace-nowrap font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 hover:cursor-pointer bg-white text-black hover:bg-gray-900 text-[15px] px-4 py-2 w-full">Get started</button></a></ul></div></div><div class="flex-col w-full py-6 hidden"><div class="flex flex-col md:flex-row md:max-w-4xl mx-auto gap-6 md:gap-8 lg:gap-10 px-1 md:px-4 lg:pl-0 products-submenu overflow-x-hidden"><div class="flex flex-col gap-4"><div class="flex flex-col gap-1 md:gap-4 border-b border-[#F7F8F8]/8 pb-4 group"><a href=/mlflow-website/genai><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">GenAI Apps & Agents</h3><p class="text-[#F7F8F8]/60 m-0">Ship high-quality GenAI, fast</p></a></div><div class="flex flex-col gap-3"><span class="text-[#F7F8F8]/60 text-sm">Features</span><div class="flex flex-row gap-6 xxs:gap-8"><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/observability>Observability</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/evaluations>Evaluations</a></div><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/prompt-registry>Prompt Registry</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/ai-gateway>AI Gateway</a></div></div></div></div><div class="flex flex-col gap-4"><div class="flex flex-col gap-1 md:gap-4 border-b border-[#F7F8F8]/8 pb-4 group"><a href=/mlflow-website/classical-ml><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">Model Training</h3><p class="text-[#F7F8F8]/60 m-0">Mastering the ML lifecycle</p></a></div><div class="flex flex-col gap-3"><span class="text-[#F7F8F8]/60 text-sm">Features</span><div class="flex flex-row gap-6 xxs:gap-8"><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/experiment-tracking>Experiment tracking</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/model-evaluation>Model evaluation</a></div><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/models>MLflow models</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/model-registry>Model Registry & deployment</a></div></div></div></div></div></div><div class="flex-col w-full py-6 hidden"><div class="flex flex-col md:flex-row md:max-w-2xl mx-auto gap-6 md:gap-8 lg:gap-10 px-1 md:px-4 lg:pl-0 docs-submenu overflow-x-hidden"><div class="flex flex-col gap-1 md:gap-2 pb-4 flex-1 group"><a href=https://mlflow.org/docs/latest/genai/ target=_blank rel="noopener noreferrer"><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">GenAI Apps & Agents</h3><p class="text-[#F7F8F8]/60 m-0">Learn how to track, evaluate, and optimize your GenAI applications and agent workflows.</p></a></div><div class="flex flex-col gap-1 md:gap-2 pb-4 flex-1 group"><a href=https://mlflow.org/docs/latest/ml/ target=_blank rel="noopener noreferrer"><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">Model Training</h3><p class="text-[#F7F8F8]/60 m-0">Get started with the core functionality for traditional machine learning workflows, hyperparameter tuning, and model lifecycle management.</p></a></div></div></div></nav><main class="flex flex-col"><div class="relative flex flex-col gap-20 bg-no-repeat w-full py-32"><div style="position:absolute;width:100%;top:0;pointer-events:none;mask-composite:intersect;height:820px;background-image:repeating-linear-gradient(
        to right,
        rgba(0, 0, 0, 0.05),
        rgba(0, 0, 0, 0.25) 24px,
        transparent 2px,
        transparent 10px
      ),
      radial-gradient(
        circle at top center,
        var(--color-brand-red) 0%,
        transparent 60%
      ),
      linear-gradient(to right, color-mix(in srgb, var(--color-brand-red), oklch(0.33 0.15 328.37) 80%), color-mix(in srgb, var(--color-brand-red), oklch(0.66 0.17 248.82) 100%));mask-image:linear-gradient(to bottom, black 40%, transparent 90%)"></div><div class=z-1><div class="flex flex-col gap-24 w-full px-6 md:px-20 max-w-container"><div class="flex flex-col max-w-7xl mx-auto w-full"><article class=""><header><h1 class=title_f1Hy>From Natural Language to SQL: Building and Tracking a Multi-Lingual Query Engine</h1><div class="container_mt6G margin-vert--md"><time datetime=2025-01-23T00:00:00.000Z>January 23, 2025</time> · <!-- -->39 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href=https://www.linkedin.com/in/hugodscarvalho/ target=_blank rel="noopener noreferrer" class=avatar__photo-link><img class="avatar__photo authorImage_XqGP" src=/mlflow-website/img/authors/hugo_carvalho.png alt="Hugo Carvalho"/></a><div class="avatar__intro authorDetails_lV9A"><div class=avatar__name><a href=https://www.linkedin.com/in/hugodscarvalho/ target=_blank rel="noopener noreferrer"><span class=authorName_yefp translate=no>Hugo Carvalho</span></a></div><small class=authorTitle_nd0D title="Machine Learning Analyst at adidas">Machine Learning Analyst at adidas</small><div class=authorSocials_rSDt></div></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href=https://www.linkedin.com/in/joanaferreira96/ target=_blank rel="noopener noreferrer" class=avatar__photo-link><img class="avatar__photo authorImage_XqGP" src=/mlflow-website/img/authors/joana_ferreira.png alt="Joana Ferreira"/></a><div class="avatar__intro authorDetails_lV9A"><div class=avatar__name><a href=https://www.linkedin.com/in/joanaferreira96/ target=_blank rel="noopener noreferrer"><span class=authorName_yefp translate=no>Joana Ferreira</span></a></div><small class=authorTitle_nd0D title="Machine Learning Engineer at adidas">Machine Learning Engineer at adidas</small><div class=authorSocials_rSDt></div></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href=https://www.linkedin.com/in/rahulpandey1901/ target=_blank rel="noopener noreferrer" class=avatar__photo-link><img class="avatar__photo authorImage_XqGP" src=/mlflow-website/img/authors/rahul_pandey.png alt="Rahul Pandey"/></a><div class="avatar__intro authorDetails_lV9A"><div class=avatar__name><a href=https://www.linkedin.com/in/rahulpandey1901/ target=_blank rel="noopener noreferrer"><span class=authorName_yefp translate=no>Rahul Pandey</span></a></div><small class=authorTitle_nd0D title="Sr. Solutions Architect at adidas">Sr. Solutions Architect at adidas</small><div class=authorSocials_rSDt></div></div></div></div></div></header><div id=__blog-post-container class=markdown><p>If you're looking to build a Multi-Lingual Query Engine that combines natural language to SQL generation with query execution while fully leveraging MLflow’s features, this blog post is your guide. We’ll explore how to leverage <strong>MLflow Models from Code</strong> to enable seamless tracking and versioning of AI Workflows. Additionally, we’ll deep dive into <strong>MLflow’s Tracing</strong> feature, which introduces observability into the many different components of an AI Workflow by tracking inputs, outputs, and metadata at every intermediate step.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=introduction>Introduction<a href=#introduction class=hash-link aria-label="Direct link to Introduction" title="Direct link to Introduction" translate=no>​</a></h2>
<p>SQL is a fundamental skill for managing and accessing data within relational databases. However, constructing complex SQL queries to answer intricate data questions can be challenging and time-consuming. This complexity can make it difficult to fully leverage data effectively. Natural language to SQL (NL2SQL) systems help in solving this problem by providing a translation from natural language to SQL commands allowing non-technical people to interact with data: users can just ask questions in a natural language they are comfortable speaking and these systems will assist them in returning the appropriate information.</p>
<p>However, there are also a number of problems that remain when creating a NL2SQL system such as semantic ambiguity, schema mapping or error handling and user feedback. Therefore, it is very important that while building such systems, we must put some guardrails instead of completely relying on LLM.</p>
<p>In this blog post, we’ll walk you through the process of building a Multi-Lingual Query Engine. This engine supports natural language inputs in multiple languages, generates an SQL query based on the translated user input, and executes the query. Let's jump into an example: using a database containing information about a company's customers, products, and orders, a user might ask a question in any language, such as "Quantos clientes temos por país?" (Portuguese for "How many customers do we have per country?"). The AI Workflow translates the input into English, outputting "How many customers do we have per country?". It then validates the input for safety, checks if the question can be answered using the database schema, generates the appropriate SQL query (e.g., <code>SELECT COUNT(CustomerID) AS NumberOfCustomers, Country FROM Customers GROUP BY Country;</code>), and validates the query to ensure no harmful commands (e.g., DROP) are present. Finally, it executes the query against the database to retrieve the results.</p>
<p>We’ll start by demonstrating how to leverage <a href=https://www.langchain.com/langgraph target=_blank rel="noopener noreferrer" class="">LangGraph’s</a> capabilities to build a dynamic AI workflow. This workflow integrates OpenAI and external data sources, such as a Vector Store and a SQLite database, to process user input, perform safety checks, query databases, and generate meaningful responses.</p>
<p>Throughout this post, we’ll leverage <a href=https://mlflow.org/docs/latest/model/models-from-code.html target=_blank rel="noopener noreferrer" class="">MLflow’s Models from Code</a> feature to enable seamless tracking and versioning of AI Workflows. Additionally, we’ll deep dive into <a href=https://mlflow.org/docs/latest/llms/tracing/index.html target=_blank rel="noopener noreferrer" class="">MLflow’s Tracing</a> feature, designed to enhance the observability of the many different components of an AI workflow by tracking inputs, outputs, and metadata associated with each intermediate step. This enables easy identification of bugs and unexpected behaviors, providing greater transparency over the workflow.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=prerequisites>Prerequisites<a href=#prerequisites class=hash-link aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites" translate=no>​</a></h2>
<p>To set up and run this project, ensure the following <strong>Python packages</strong> are installed:</p>
<ul>
<li class=""><code>faiss-cpu</code></li>
<li class=""><code>langchain</code></li>
<li class=""><code>langchain-core</code></li>
<li class=""><code>langchain-openai</code></li>
<li class=""><code>langgraph</code></li>
<li class=""><code>langchain-community</code></li>
<li class=""><code>pydantic >=2</code></li>
<li class=""><code>typing_extensions</code></li>
<li class=""><code>python-dotenv</code></li>
</ul>
<p>Additionally, an <strong>MLflow Tracking Server</strong> is required to log and manage experiments, models, and traces effectively. For local setup, refer to the official MLflow documentation for instructions on <a href=https://mlflow.org/docs/latest/tracking/server.html target=_blank rel="noopener noreferrer" class="">configuring a simple MLflow Tracking Server</a>.</p>
<p>Finally, ensure that your OpenAI API key is saved within a .env file in the project directory. This allows the application to securely access the OpenAI services required for building the AI workflow. The .env file should include a line like:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token plain">OPENAI_API_KEY=your_openai_api_key</span><br/></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=multi-lingual-query-engine-using-langgraph>Multi-Lingual Query Engine using LangGraph<a href=#multi-lingual-query-engine-using-langgraph class=hash-link aria-label="Direct link to Multi-Lingual Query Engine using LangGraph" title="Direct link to Multi-Lingual Query Engine using LangGraph" translate=no>​</a></h2>
<p>The Multi-Lingual Query Engine leverages the <a href=https://langchain-ai.github.io/langgraph/ target=_blank rel="noopener noreferrer" class="">LangGraph</a> library, an AI orchestration tool designed to create stateful, multi-agent, and cyclical graph architectures for applications powered by LLMs.</p>
<p>Compared to other AI orchestrators, LangGraph offers three core benefits: cycles, controllability, and persistence. It allows the definition of AI workflows with cycles, which are essential for implementing retry mechanisms like the SQL query generation retries in the Multi-Lingual Query Engine (where the query loops back for regeneration if validation fails). This makes LangGraph the ideal tool for building our Multi-Lingual Query Engine.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id=key-langgraph-features>Key LangGraph features:<a href=#key-langgraph-features class=hash-link aria-label="Direct link to Key LangGraph features:" title="Direct link to Key LangGraph features:" translate=no>​</a></h3>
<ol>
<li class="">
<p><strong>Stateful Architecture</strong>: The engine maintains a dynamic snapshot of the graph’s execution status. This snapshot acts as a shared resource across nodes, enabling efficient decision-making and real-time updates at each node execution.</p>
</li>
<li class="">
<p><strong>Multi-Agent Design</strong>: The AI Workflow includes multiple interactions with OpenAI and other external tools throughout the workflow.</p>
</li>
<li class="">
<p><strong>Cyclical Graph Structure</strong>: The graph’s cyclical nature introduces a robust retry mechanism. This mechanism dynamically addresses failures by looping back to previous stages when needed, ensuring continuous graph execution. (Details of this mechanism will be discussed later.)</p>
</li>
</ol>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=ai-workflow-overview>AI Workflow Overview<a href=#ai-workflow-overview class=hash-link aria-label="Direct link to AI Workflow Overview" title="Direct link to AI Workflow Overview" translate=no>​</a></h2>
<p>The Multi-Lingual Query Engine’s advanced AI workflow is composed of interconnected nodes and edges, each representing a crucial stage:</p>
<ol>
<li class="">
<p><strong>Translation Node</strong>: Converts the user’s input into English.</p>
</li>
<li class="">
<p><strong>Pre-safety Check</strong>: Ensures user input is free from toxic or inappropriate content and does not contain harmful SQL commands (e.g., <code>DELETE</code>, <code>DROP</code>).</p>
</li>
<li class="">
<p><strong>Database Schema Extraction</strong>: Retrieves the schema of the target database to understand its structure and available data.</p>
</li>
<li class="">
<p><strong>Relevancy Validation</strong>: Validates the user’s input against the database schema to ensure alignment with the database’s context.</p>
</li>
<li class="">
<p><strong>SQL Query Generation</strong>: Generates an SQL query based on the user’s input and the current database schema.</p>
</li>
<li class="">
<p><strong>Post-safety Check</strong>: Ensures the generated SQL Query does not contain harmful SQL commands (e.g., <code>DELETE</code>, <code>DROP</code>).</p>
</li>
<li class="">
<p><strong>SQL Query Validation</strong>: Executes the SQL query in a rollback-safe environment to ensure its validity before running it.</p>
</li>
<li class="">
<p><strong>Dynamic State Evaluation</strong>: Determines the next steps based on the current state. If the SQL query validation fails, it loops back to Stage 5 to regenerate the query.</p>
</li>
<li class="">
<p><strong>Query Execution and Result Retrieval</strong>: Executes the SQL query and returns the results if it’s a <code>SELECT</code> statement.</p>
</li>
</ol>
<p>The retry mechanism is introduced in Stage 8, where the system dynamically evaluates the current graph state. Specifically, when the SQL query validation node (Stage 7) detects an issue, the state triggers a loop back to the SQL Generation node (Stage 5) for a new SQL Generation attempt (with a maximum of 3 attempts).</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id=components>Components<a href=#components class=hash-link aria-label="Direct link to Components" title="Direct link to Components" translate=no>​</a></h3>
<p>The Multi-Lingual Query Engine interacts with several external components to transform natural language user inputs into SQL queries and execute them in a safe and robust manner. In this section, we will take a detailed look at the key AI Workflow components: OpenAI, Vector Store, SQLite Database, and SQL Generation Chain.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id=openai>OpenAI<a href=#openai class=hash-link aria-label="Direct link to OpenAI" title="Direct link to OpenAI" translate=no>​</a></h4>
<p>OpenAI, more specifically the <code>gpt-4o-mini</code> language model, plays a crucial role in multiple stages of the workflow. It provides the intelligence required for:</p>
<ol>
<li class="">
<p><strong>Translation</strong>: Translates user input into English. If the text is already in English, it simply repeats the input.</p>
</li>
<li class="">
<p><strong>Safety Checks</strong>: Analyzes user input to ensure that it does not contain toxic or inappropriate content.</p>
</li>
<li class="">
<p><strong>Relevance Checks</strong>: Evaluates whether the user's question is relevant given the database schema.</p>
</li>
<li class="">
<p><strong>SQL Generation</strong>: Generates valid and executable SQL queries based on user input, SQL generation documentation, and the database schema.</p>
</li>
</ol>
<p>Details on OpenAI implementation will be provided later on in the <a href=#node-descriptions class="">Node Descriptions</a> section.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id=faiss-vector-store>FAISS Vector Store<a href=#faiss-vector-store class=hash-link aria-label="Direct link to FAISS Vector Store" title="Direct link to FAISS Vector Store" translate=no>​</a></h4>
<p>To build an effective natural language to SQL engine capable of generating accurate and executable SQL queries, we leverage Langchain's FAISS Vector Store feature. This setup allows the system to search and extract SQL query generation guidelines from <a href=https://www.w3schools.com/sql/ target=_blank rel="noopener noreferrer" class="">W3Schools SQL documents</a> previously stored in the Vector Database, enhancing the success of SQL query generation.</p>
<p>For demo purposes, we are using FAISS, an in-memory vector store where vectors are stored directly in RAM. This provides fast access but means data is not persisted between runs. For a more scalable solution that enables embeddings to be stored and shared across multiple projects, we recommend alternatives like <a href=https://aws.amazon.com/what-is/opensearch/ target=_blank rel="noopener noreferrer" class="">AWS OpenSearch</a>, <a href=https://cloud.google.com/vertex-ai/docs/vector-search/overview target=_blank rel="noopener noreferrer" class="">Vertex AI Vector Search</a>, <a href=https://learn.microsoft.com/en-us/azure/search/vector-search-overview target=_blank rel="noopener noreferrer" class="">Azure Vector Search</a>, or <a href=https://docs.databricks.com/en/generative-ai/vector-search.html target=_blank rel="noopener noreferrer" class="">Mosaic AI Vector Search</a>. These cloud-based solutions offer persistent storage, automatic scaling, and seamless integration with other cloud services, making them well-suited for large-scale applications.</p>
<h5 class="anchor anchorTargetStickyNavbar_Vzrq" id=step-1-load-sql-documentation>Step 1: Load SQL Documentation<a href=#step-1-load-sql-documentation class=hash-link aria-label="Direct link to Step 1: Load SQL Documentation" title="Direct link to Step 1: Load SQL Documentation" translate=no>​</a></h5>
<p>The first step in creating a FAISS Vector Store with SQL query generation guidelines is to load SQL documentation from the <a href=https://www.w3schools.com/sql/ target=_blank rel="noopener noreferrer" class="">W3Schools SQL page</a> using LangChain's <code>RecursiveUrlLoader</code>. This tool retrieves the documentation, allowing us to use it as a knowledge base for our engine.</p>
<h5 class="anchor anchorTargetStickyNavbar_Vzrq" id=step-2-split-the-text-into-manageable-chunks>Step 2: Split the Text into Manageable Chunks<a href=#step-2-split-the-text-into-manageable-chunks class=hash-link aria-label="Direct link to Step 2: Split the Text into Manageable Chunks" title="Direct link to Step 2: Split the Text into Manageable Chunks" translate=no>​</a></h5>
<p>The loaded SQL documentation is a lengthy text, making it difficult to be effectively ingested by the LLM. To address this, the next step involves splitting the text into smaller, manageable chunks using Langchain's <code>RecursiveCharacterTextSplitter</code>. By splitting the text into chunks of 500 characters with a 50-character overlap, we ensure the language model has sufficient context while minimizing the risk of losing important information that spans across chunks. The <code>split_text</code> method applies this splitting process, storing the resulting pieces in a list called 'documents'.</p>
<h5 class="anchor anchorTargetStickyNavbar_Vzrq" id=step-3-generate-embedding-model>Step 3: Generate Embedding Model<a href=#step-3-generate-embedding-model class=hash-link aria-label="Direct link to Step 3: Generate Embedding Model" title="Direct link to Step 3: Generate Embedding Model" translate=no>​</a></h5>
<p>The third step is to create a model that converts these chunks into embeddings (vectorized numerical representations of each text chunk). Embeddings enable the system to compare the similarity between chunks and the user's input, facilitating the retrieval of the most relevant matches for SQL query generation.</p>
<h5 class="anchor anchorTargetStickyNavbar_Vzrq" id=step-4-create-and-store-embeddings-in-faiss-vector-store>Step 4: Create and Store Embeddings in FAISS Vector Store<a href=#step-4-create-and-store-embeddings-in-faiss-vector-store class=hash-link aria-label="Direct link to Step 4: Create and Store Embeddings in FAISS Vector Store" title="Direct link to Step 4: Create and Store Embeddings in FAISS Vector Store" translate=no>​</a></h5>
<p>Finally, we create and store the embeddings using FAISS. The <code>FAISS.from_texts</code> method takes all the chunks, computes their embeddings, and stores them in a high speed searchable vector database. This searchable database allows the engine to efficiently retrieve relevant SQL guidelines, significantly improving the success rate of executable SQL query generation.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> logging</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> os</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> bs4 </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> BeautifulSoup </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> Soup</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">text_splitter </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> RecursiveCharacterTextSplitter</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> langchain_community</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">document_loaders</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">recursive_url_loader </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> RecursiveUrlLoader</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> langchain_community</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">vectorstores </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> FAISS</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> langchain_openai </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> OpenAIEmbeddings</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">setup_vector_store</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> logging</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""Setup or load the vector store."""</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">not</span><span class="token plain"> os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">exists</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"data"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">makedirs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"data"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    vector_store_dir </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"data/vector_store"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">exists</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">vector_store_dir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Load the vector store from disk</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Loading vector store from disk..."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        vector_store </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> FAISS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">load_local</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            vector_store_dir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            OpenAIEmbeddings</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            allow_dangerous_deserialization</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Creating new vector store..."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Load SQL documentation</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        url </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"https://www.w3schools.com/sql/"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        loader </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> RecursiveUrlLoader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            url</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">url</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> max_depth</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> extractor</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token keyword" style="color:rgb(86, 156, 214)">lambda</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Soup</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"html.parser"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">text</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        docs </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> loader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">load</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Split documents into chunks</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        text_splitter </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> RecursiveCharacterTextSplitter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            chunk_size</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">500</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            chunk_overlap</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">50</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            separators</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"\n\n"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"\n"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"!"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"?"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">","</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">" "</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">""</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        documents </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> doc </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> docs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            splits </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> text_splitter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">split_text</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">doc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">page_content</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> split </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">enumerate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">splits</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                documents</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">"content"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> split</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">"metadata"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">"source"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> doc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">metadata</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"source"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"chunk"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Compute embeddings and create vector store</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        embedding_model </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> OpenAIEmbeddings</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        vector_store </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> FAISS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">from_texts</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">doc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"content"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> doc </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> documents</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            embedding_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            metadatas</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">doc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"metadata"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> doc </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> documents</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Save the vector store to disk</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        vector_store</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">save_local</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">vector_store_dir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Vector store created and saved to disk."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> vector_store</span><br/></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id=sqlite-database>SQLite Database<a href=#sqlite-database class=hash-link aria-label="Direct link to SQLite Database" title="Direct link to SQLite Database" translate=no>​</a></h4>
<p>The SQLite database is a key component of the Multi-Lingual Query Engine serving as the structured data repository. SQLite offers a lightweight, fast, and self-contained relational database engine that requires no server setup or installation. Its compact size (under 500KB) and zero-configuration nature make it incredibly easy to use, while its platform-agnostic database format ensures seamless portability across different systems. As a local disk database, SQLite was the ideal choice for avoiding the complexity of setting up MySQL or PostgreSQL, while still providing a reliable, full-featured SQL engine with outstanding performance.</p>
<p>The SQLite database supports efficient SQL query generation, validation and execution by enabling:</p>
<ol>
<li class="">
<p><strong>Schema Extraction</strong>: Suplying schema information for user’s input context validation (Stage 4) and executable SQL Query Generation (Stage 5).</p>
</li>
<li class="">
<p><strong>Query Execution</strong>: Executing SQL queries in a rollback-safe environment in Validation Stage (Stage 7) and in Query Execution Stage (Stage 9) fetching results for <code>SELECT</code> statements and committing changes for other query types.</p>
</li>
</ol>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id=sqlite-database-initialization>SQLite Database Initialization<a href=#sqlite-database-initialization class=hash-link aria-label="Direct link to SQLite Database Initialization" title="Direct link to SQLite Database Initialization" translate=no>​</a></h4>
<p>The database is initialized using the <code>setup_database</code> function when the AI Workflow is initialized. This process involves:</p>
<ol>
<li class="">
<p><strong>Setting the SQLite Database Connection</strong>: Establishes a connection to the SQLite database, enabling data interaction.</p>
</li>
<li class="">
<p><strong>Table Creation</strong>: Defines and creates the necessary database tables for the AI Workflow.</p>
</li>
<li class="">
<p><strong>Data Population</strong>: Populates the tables with sample data to support query execution and validation stages.</p>
</li>
</ol>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> logging</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> os</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> sqlite3</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">create_connection</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">db_file</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"data/database.db"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""Create a database connection to the SQLite database."""</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    conn </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> sqlite3</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">connect</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">db_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> conn</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">create_tables</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">conn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""Create tables in the database."""</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    cursor </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> conn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Create Customers table</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    CREATE TABLE IF NOT EXISTS Customers (</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        CustomerID INTEGER PRIMARY KEY,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        CustomerName TEXT,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        ContactName TEXT,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Address TEXT,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        City TEXT,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        PostalCode TEXT,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Country TEXT</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    )</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Create Orders table</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    CREATE TABLE IF NOT EXISTS Orders (</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        OrderID INTEGER PRIMARY KEY,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        CustomerID INTEGER,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        OrderDate TEXT,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        FOREIGN KEY (CustomerID) REFERENCES Customers (CustomerID)</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    )</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Create OrderDetails table</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    CREATE TABLE IF NOT EXISTS OrderDetails (</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        OrderDetailID INTEGER PRIMARY KEY,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        OrderID INTEGER,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        ProductID INTEGER,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Quantity INTEGER,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        FOREIGN KEY (OrderID) REFERENCES Orders (OrderID),</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        FOREIGN KEY (ProductID) REFERENCES Products (ProductID)</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    )</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Create Products table</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    CREATE TABLE IF NOT EXISTS Products (</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        ProductID INTEGER PRIMARY KEY,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        ProductName TEXT,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Price REAL</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    )</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    conn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">commit</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">populate_tables</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">conn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""Populate tables with sample data if they are empty."""</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    cursor </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> conn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Populate Customers table if empty</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"SELECT COUNT(*) FROM Customers"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">fetchone</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        customers </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> i </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">range</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">51</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            customers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    i</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f"Customer </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">i</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f"Contact </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">i</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f"Address </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">i</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f"City </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">i </span><span class="token string-interpolation interpolation operator" style="color:rgb(212, 212, 212)">%</span><span class="token string-interpolation interpolation"> </span><span class="token string-interpolation interpolation number" style="color:rgb(181, 206, 168)">10</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f"</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation number" style="color:rgb(181, 206, 168)">10000</span><span class="token string-interpolation interpolation"> </span><span class="token string-interpolation interpolation operator" style="color:rgb(212, 212, 212)">+</span><span class="token string-interpolation interpolation"> i</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f"Country </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">i </span><span class="token string-interpolation interpolation operator" style="color:rgb(212, 212, 212)">%</span><span class="token string-interpolation interpolation"> </span><span class="token string-interpolation interpolation number" style="color:rgb(181, 206, 168)">5</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">executemany</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        INSERT INTO Customers (CustomerID, CustomerName, ContactName, Address, City, PostalCode, Country)</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        VALUES (?, ?, ?, ?, ?, ?, ?)</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        """</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            customers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Populate Products table if empty</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"SELECT COUNT(*) FROM Products"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">fetchone</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        products </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> i </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">range</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">51</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            products</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f"Product </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">i</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">round</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">10</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0.5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">executemany</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        INSERT INTO Products (ProductID, ProductName, Price)</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        VALUES (?, ?, ?)</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        """</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            products</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Populate Orders table if empty</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"SELECT COUNT(*) FROM Orders"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">fetchone</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        orders </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> datetime </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> datetime</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> timedelta</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        base_date </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> datetime</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">2023</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> i </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">range</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">51</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            order_date </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> base_date </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> timedelta</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">days</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            orders</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    i</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    i </span><span class="token operator" style="color:rgb(212, 212, 212)">%</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">50</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># CustomerID between 1 and 50</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    order_date</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">strftime</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"%Y-%m-%d"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">executemany</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        INSERT INTO Orders (OrderID, CustomerID, OrderDate)</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        VALUES (?, ?, ?)</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        """</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            orders</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Populate OrderDetails table if empty</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"SELECT COUNT(*) FROM OrderDetails"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">fetchone</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        order_details </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> i </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">range</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">51</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            order_details</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    i</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    i </span><span class="token operator" style="color:rgb(212, 212, 212)">%</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">50</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># OrderID between 1 and 50</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    i </span><span class="token operator" style="color:rgb(212, 212, 212)">%</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">50</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># ProductID between 1 and 50</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">i </span><span class="token operator" style="color:rgb(212, 212, 212)">%</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">5</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Quantity between 2 and 10</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">executemany</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        INSERT INTO OrderDetails (OrderDetailID, OrderID, ProductID, Quantity)</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        VALUES (?, ?, ?, ?)</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        """</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            order_details</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    conn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">commit</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">setup_database</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> logging</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""Setup the database and return the connection."""</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    db_file </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"data/database.db"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">not</span><span class="token plain"> os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">exists</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"data"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">makedirs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"data"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    db_exists </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">exists</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">db_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    conn </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> create_connection</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">db_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">not</span><span class="token plain"> db_exists</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Setting up the database..."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        create_tables</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">conn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        populate_tables</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">conn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Database already exists. Skipping setup."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> conn</span><br/></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id=sql-generation-chain>SQL Generation Chain<a href=#sql-generation-chain class=hash-link aria-label="Direct link to SQL Generation Chain" title="Direct link to SQL Generation Chain" translate=no>​</a></h4>
<p>The <strong>SQL Generation Chain</strong> (<code>sql_gen_chain</code>) is the backbone of automated SQL query generation in our workflow. This chain leverages LangChain's modular capabilities and OpenAI's advanced natural language processing to transform user questions into precise and executable SQL queries.</p>
<p><strong>Core Features</strong>:</p>
<ul>
<li class="">
<p><strong>Prompt-Driven Generation</strong>: Begins with a thoughtfully designed prompt that integrates the database schema and documentation snippets, ensuring queries are contextually accurate.</p>
</li>
<li class="">
<p><strong>Structured Responses</strong>: Delivers outputs in a predefined format, including:</p>
<ul>
<li class="">
<p>A <strong>description</strong> of the query's purpose.</p>
</li>
<li class="">
<p>The corresponding <strong>SQL code</strong> ready for execution.</p>
</li>
</ul>
</li>
<li class="">
<p><strong>Adaptable and Reliable</strong>: Uses <code>gpt-4o-mini</code> for robust, consistent query generation, minimizing manual effort and errors.</p>
</li>
</ul>
<p>This chain is a critical component in our workflow, enabling seamless integration of SQL query generation with downstream processes, ensuring accuracy, and significantly improving efficiency.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> pydantic </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> BaseModel</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> Field</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> langchain_core</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">prompts </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> ChatPromptTemplate</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> langchain_openai </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> ChatOpenAI</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">SQLQuery</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">BaseModel</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""Schema for SQL query solutions to questions."""</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    description</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> Field</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">description</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"Description of the SQL query"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    sql_code</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> Field</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">description</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"The SQL code block"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">get_sql_gen_chain</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""Set up the SQL generation chain."""</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    sql_gen_prompt </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ChatPromptTemplate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">from_messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">"system"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""You are a SQL assistant with expertise in SQL query generation. \n</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">Answer the user's question based on the provided documentation snippets and the database schema provided below. Ensure any SQL query you provide is valid and executable. \n</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">Structure your answer with a description of the query, followed by the SQL code block. Here are the documentation snippets:\n{retrieved_docs}\n\nDatabase Schema:\n{database_schema}"""</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"placeholder"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"{messages}"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Initialize the OpenAI LLM</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    llm </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ChatOpenAI</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">temperature</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"gpt-4o-mini"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Create the code generation chain</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    sql_gen_chain </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> sql_gen_prompt </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"> llm</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">with_structured_output</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">SQLQuery</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> sql_gen_chain</span><br/></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id=workflow-setup-and-initialization>Workflow Setup and Initialization<a href=#workflow-setup-and-initialization class=hash-link aria-label="Direct link to Workflow Setup and Initialization" title="Direct link to Workflow Setup and Initialization" translate=no>​</a></h4>
<p>Before delving into the workflow nodes, it's crucial to set up the necessary components and define the structure of the workflow. This section explains the initialization of essential libraries, logging, and the custom <code>GraphState</code> class, as well as the main workflow compilation function.</p>
<h5 class="anchor anchorTargetStickyNavbar_Vzrq" id=defining-graphstate>Defining <code>GraphState</code><a href=#defining-graphstate class=hash-link aria-label="Direct link to defining-graphstate" title="Direct link to defining-graphstate" translate=no>​</a></h5>
<p>The <code>GraphState</code> class is a custom <code>TypedDict</code> that maintains the state information as the workflow progresses. It acts as a shared data structure across the nodes, ensuring continuity and consistency. Key fields include:</p>
<ul>
<li class=""><strong><code>error</code></strong>: Tracks whether an error has occurred.</li>
<li class=""><strong><code>messages</code></strong>: Stores a list of user and system messages.</li>
<li class=""><strong><code>generation</code></strong>: Holds the generated SQL query.</li>
<li class=""><strong><code>iterations</code></strong>: Tracks the number of retry attempts in case of errors.</li>
<li class=""><strong><code>results</code></strong>: Stores the SQL execution results, if any.</li>
<li class=""><strong><code>no_records_found</code></strong>: Flags if no records are returned by the query.</li>
<li class=""><strong><code>translated_input</code></strong>: Contains the user's translated input.</li>
<li class=""><strong><code>database_schema</code></strong>: Maintains the database schema for context validation.</li>
</ul>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> logging</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> re</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> typing </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> List</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> Optional</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> langchain_openai </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> ChatOpenAI</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> langgraph</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">graph </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> END</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> START</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> StateGraph</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> sql_generation </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> get_sql_gen_chain</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> typing_extensions </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> TypedDict</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Initialize the logger</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">_logger </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> logging</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">getLogger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">__name__</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">_logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">setLevel</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">logging</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">INFO</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">handler </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> logging</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">StreamHandler</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">formatter </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> logging</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Formatter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"%(asctime)s - %(name)s - %(levelname)s - %(message)s"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">handler</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">setFormatter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">formatter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">_logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">addHandler</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">handler</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">GraphState</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">TypedDict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    error</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Tracks if an error has occurred</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> List  </span><span class="token comment" style="color:rgb(106, 153, 85)"># List of messages (user input and assistant messages)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    generation</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Optional</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Holds the generated SQL query</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    iterations</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">int</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Keeps track of how many times the workflow has retried</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    results</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Optional</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">List</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Holds the results of SQL execution</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    no_records_found</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">bool</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Flag for whether any records were found in the SQL result</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    translated_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Holds the translated user input</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    database_schema</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Holds the extracted database schema for context checking</span><br/></span></code></pre></div></div>
<h5 class="anchor anchorTargetStickyNavbar_Vzrq" id=workflow-compilation-function>Workflow Compilation Function<a href=#workflow-compilation-function class=hash-link aria-label="Direct link to Workflow Compilation Function" title="Direct link to Workflow Compilation Function" translate=no>​</a></h5>
<p>The main function, <code>get_workflow</code>, is responsible for defining and compiling the workflow. Key components include:</p>
<ul>
<li class=""><strong><code>conn</code> and <code>cursor</code></strong>: Used for database connectivity and query execution.</li>
<li class=""><strong><code>vector_store</code></strong>: A vector database for contextual retrieval.</li>
<li class=""><strong><code>max_iterations</code></strong>: Sets a limit on retry attempts to prevent infinite loops.</li>
<li class=""><strong><code>sql_gen_chain</code></strong>: Retrieves the SQL generation chain from <code>sql_generation</code> for producing SQL queries based on contextual inputs.</li>
<li class=""><strong><code>ChatOpenAI</code></strong>: Initializes the OpenAI <code>gpt-4o-mini</code> model for tasks like safety checks and query translation.</li>
</ul>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">get_workflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">conn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> vector_store</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""Define and compile the LangGraph workflow."""</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Max iterations: defines how many times the workflow should retry in case of errors</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    max_iterations </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">3</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># SQL generation chain: this is a chain that will generate SQL based on retrieved docs</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    sql_gen_chain </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> get_sql_gen_chain</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Initialize OpenAI LLM for translation and safety checks</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    llm </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ChatOpenAI</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">temperature</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"gpt-4o-mini"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Define the individual nodes of the workflow</span><br/></span></code></pre></div></div>
<p>This function acts as the entry point for creating a complete workflow using <code>StateGraph</code>. Individual nodes within the workflow will be defined and connected in subsequent sections.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id=node-descriptions>Node Descriptions<a href=#node-descriptions class=hash-link aria-label="Direct link to Node Descriptions" title="Direct link to Node Descriptions" translate=no>​</a></h4>
<h5 class="anchor anchorTargetStickyNavbar_Vzrq" id=1-translate-input>1. Translate Input<a href=#1-translate-input class=hash-link aria-label="Direct link to 1. Translate Input" title="Direct link to 1. Translate Input" translate=no>​</a></h5>
<p>The <code>translate_input</code> node translates user queries into English to standardize processing and ensure compatibility with downstream nodes. Translating user input as the first step in the AI Workflow ensures task segregation and improves observability. Task segregation simplifies the workflow by isolating translation from the other dowstream tasks like user input safety validation and SQL generation. Improved observability provides clear traces in MLflow, making it easier to debug and monitor the process.</p>
<ul>
<li class=""><strong>Examples:</strong>
<ul>
<li class="">Input: <em>"Quantos pedidos foram realizados em Novembro?"</em></li>
<li class="">Translated: <em>"How many orders were made in November?"</em></li>
<li class="">Input: <em>"Combien de ventes avons-nous enregistrées en France ?"</em></li>
<li class="">Translated: <em>"How many sales did we record in France?"</em></li>
</ul>
</li>
<li class=""><strong>Code:</strong></li>
</ul>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">translate_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> GraphState</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> GraphState</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Translates user input to English using an LLM. If the input is already in English,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    it is returned as is. This ensures consistent input for downstream processing.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Args:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        state (GraphState): The current graph state containing user messages.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Returns:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        GraphState: The updated state with the translated input.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Starting translation of user input to English."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    messages </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"messages"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    user_input </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Get the latest user input</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Translation prompt for the model</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    translation_prompt </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">    Translate the following text to English. If the text is already in English, repeat it exactly without any additional explanation.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">    Text:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">    </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">user_input</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">    """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Call the OpenAI LLM to translate the text</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    translated_response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> llm</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">invoke</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">translation_prompt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    translated_text </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> translated_response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">content</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">strip</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Access the 'content' attribute and strip any extra spaces</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Update state with the translated input</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"translated_input"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> translated_text</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Translation completed successfully. Translated input: %s"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> translated_text</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> state</span><br/></span></code></pre></div></div>
<h5 class="anchor anchorTargetStickyNavbar_Vzrq" id=2-pre-safety-check>2. Pre-safety Check<a href=#2-pre-safety-check class=hash-link aria-label="Direct link to 2. Pre-safety Check" title="Direct link to 2. Pre-safety Check" translate=no>​</a></h5>
<p>The <code>pre_safety_check</code> node ensures early detection of disallowed SQL operations and inappropriate content in the user's input. While the check for harmful SQL commands (e.g., <code>CREATE</code>, <code>DELETE</code>, <code>DROP</code>, <code>INSERT</code>, <code>UPDATE</code>) will occur again later in the workflow, specifically after generating the SQL query, this pre-safety check is crucial for identifying potential issues at the input stage. By doing so, it prevents unnecessary computation and offers immediate feedback to the user.</p>
<p>While the use of a disallow list for harmful SQL operations provides a quick way to safeguard against destructive queries, maintaining a comprehensive disallow list can become hard to manage when dealing with complex SQL backends like T-SQL. An alternative approach is adopting an allowlist, restricting queries to only safe operations (e.g., <code>SELECT</code>, <code>JOIN</code>). This approach ensures a more robust solution by narrowing down permissible actions rather than attempting to block every risky command.</p>
<p>To achieve an enterprise-grade solution, the project could leverage frameworks like <a href=https://github.com/unitycatalog/unitycatalog/blob/main/ai/core/README.md target=_blank rel="noopener noreferrer" class="">Unity Catalog</a>, which provide a centralized and robust approach to managing security-related functions, such as the <code>pre_safety_check</code> for AI workflows. By registering and managing reusable functions within such a framework, you can enforce consistent and reliable behavior across all AI workflows, enhancing both security and scalability.</p>
<p>Additionally, the node leverages the LLM to analyze the input for offensive or inappropriate content. If unsafe queries or inappropriate content are detected, the state is updated with an error flag and transparent feedback is provided, safeguarding the workflow from malicious or destructive elements early on.</p>
<ul>
<li class=""><strong>Examples:</strong></li>
</ul>
<ol>
<li class="">
<p><strong>Disallowed Operations:</strong></p>
<ul>
<li class="">
<p><strong>Input:</strong> <em>"DROP TABLE customers;"</em></p>
</li>
<li class="">
<p><strong>Response:</strong> <em>"Your query contains disallowed SQL operations and cannot be processed."</em></p>
</li>
<li class="">
<p><strong>Input:</strong> _"SELECT _ FROM orders;"*</p>
</li>
<li class="">
<p><strong>Response:</strong> <em>"Query allowed."</em></p>
</li>
</ul>
</li>
<li class="">
<p><strong>Inappropriate Content:</strong></p>
<ul>
<li class=""><strong>Input:</strong> <em>"Show me orders where customers have names like 'John the Idiot';"</em></li>
<li class=""><strong>Response:</strong> <em>"Your query contains inappropriate content and cannot be processed."</em></li>
<li class=""><strong>Input:</strong> <em>"Find total sales by region."</em></li>
<li class=""><strong>Response:</strong> <em>"Input is safe to process."</em></li>
</ul>
</li>
</ol>
<ul>
<li class=""><strong>Code:</strong></li>
</ul>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">pre_safety_check</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> GraphState</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> GraphState</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Perform safety checks on the user input to ensure that no dangerous SQL operations</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    or inappropriate content is present. The function checks for SQL operations like</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    DELETE, DROP, and others, and also evaluates the input for toxic or unsafe content.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Args:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        state (GraphState): The current graph state containing the translated user input.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Returns:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        GraphState: The updated state with error status and messages if any issues are found.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Performing safety check."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    translated_input </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"translated_input"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    messages </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"messages"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    error </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"no"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># List of disallowed SQL operations (e.g., DELETE, DROP)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    disallowed_operations </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">'CREATE'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">'DELETE'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">'DROP'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">'INSERT'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">'UPDATE'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">'ALTER'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">'TRUNCATE'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">'EXEC'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">'EXECUTE'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    pattern </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> re</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token builtin" style="color:rgb(86, 156, 214)">compile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">r'\b('</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">'|'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">join</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">disallowed_operations</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">r')\b'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> re</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">IGNORECASE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Check if the input contains disallowed SQL operations</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> pattern</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">search</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">translated_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">warning</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Input contains disallowed SQL operations. Halting the workflow."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        error </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"yes"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        messages </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"assistant"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"Your query contains disallowed SQL operations and cannot be processed."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Check if the input contains inappropriate content</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        safety_prompt </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">        Analyze the following input for any toxic or inappropriate content.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">        Respond with only "safe" or "unsafe", and nothing else.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">        Input:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">        </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">translated_input</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">        """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        safety_invoke </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> llm</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">invoke</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">safety_prompt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        safety_response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> safety_invoke</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">content</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">strip</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">lower</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Access the 'content' attribute and strip any extra spaces</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> safety_response </span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"safe"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Input is safe to process."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">warning</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Input contains inappropriate content. Halting the workflow."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            error </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"yes"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            messages </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"assistant"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"Your query contains inappropriate content and cannot be processed."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Update state with error status and messages</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"error"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> error</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"messages"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> messages</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> state</span><br/></span></code></pre></div></div>
<h5 class="anchor anchorTargetStickyNavbar_Vzrq" id=3-schema-extract>3. Schema Extract<a href=#3-schema-extract class=hash-link aria-label="Direct link to 3. Schema Extract" title="Direct link to 3. Schema Extract" translate=no>​</a></h5>
<p>The <code>schema_extract</code> node dynamically retrieves the database schema, including table names and column details, by querying metadata. The formatted schema is stored in the state, enabling validation of user queries while adapting to the current database structure.</p>
<ul>
<li class=""><strong>Examples:</strong>
<ul>
<li class="">Input: Request for schema extraction.<br/>
<!-- -->Schema Output:<!-- -->
<ul>
<li class="">Customers(CustomerID (INTEGER), CustomerName (TEXT), ContactName (TEXT), Address (TEXT), City (TEXT), PostalCode (TEXT), Country (TEXT))</li>
<li class="">Orders(OrderID (INTEGER), CustomerID (INTEGER), OrderDate (TEXT))</li>
<li class="">OrderDetails(OrderDetailID (INTEGER), OrderID (INTEGER), ProductID (INTEGER), Quantity (INTEGER))</li>
<li class="">Products(ProductID (INTEGER), ProductName (TEXT), Price (REAL))</li>
</ul>
</li>
</ul>
</li>
<li class=""><strong>Code:</strong></li>
</ul>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">schema_extract</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> GraphState</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> GraphState</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Extracts the database schema, including all tables and their respective columns,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    from the connected SQLite database. This function retrieves the list of tables and</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    iterates through each table to gather column definitions (name and data type).</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Args:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        state (GraphState): The current graph state, which will be updated with the database schema.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Returns:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        GraphState: The updated state with the extracted database schema.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Extracting database schema."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Extract the schema from the database</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"SELECT name FROM sqlite_master WHERE type='table';"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    tables </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">fetchall</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    schema_details </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Loop through each table and retrieve column information</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> table_name_tuple </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> tables</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        table_name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> table_name_tuple</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f"PRAGMA table_info(</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">table_name</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">);"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        columns </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">fetchall</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Format column definitions</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        column_defs </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">', '</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">join</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f"</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">col</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string-interpolation interpolation number" style="color:rgb(181, 206, 168)">1</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)"> (</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">col</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string-interpolation interpolation number" style="color:rgb(181, 206, 168)">2</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">)"</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> col </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> columns</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        schema_details</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f"- </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">table_name</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">(</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">column_defs</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">)"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Save the schema in the state</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    database_schema </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">'\n'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">join</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">schema_details</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"database_schema"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> database_schema</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f"Database schema extracted:\n</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">database_schema</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> state</span><br/></span></code></pre></div></div>
<h5 class="anchor anchorTargetStickyNavbar_Vzrq" id=4-context-check>4. Context Check<a href=#4-context-check class=hash-link aria-label="Direct link to 4. Context Check" title="Direct link to 4. Context Check" translate=no>​</a></h5>
<p>The <code>context_check</code> node validates user queries by comparing them against the extracted database schema to ensure alignment and relevance. Queries that do not correspond to the schema are flagged as irrelevant, preventing resource waste and enabling user feedback for query reformulation.</p>
<ul>
<li class=""><strong>Examples:</strong>
<ul>
<li class="">Input: <em>"What is the average order value?"</em><br/>
<!-- -->Schema Match: Input is relevant to the database schema.</li>
<li class="">Input: <em>"Show me data from the inventory table."</em><br/>
<!-- -->Response: <em>"Your question is not related to the database and cannot be processed."</em></li>
</ul>
</li>
<li class=""><strong>Code:</strong></li>
</ul>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">context_check</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> GraphState</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> GraphState</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Checks whether the user's input is relevant to the database schema by comparing</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    the user's question with the database schema. Uses a language model to determine if</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    the question can be answered using the provided schema.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Args:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        state (GraphState): The current graph state, which contains the translated input</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">                            and the database schema.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Returns:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        GraphState: The updated state with error status and messages if the input is irrelevant.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Performing context check."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Extract relevant data from the state</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    translated_input </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"translated_input"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    messages </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"messages"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    error </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"no"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    database_schema </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"database_schema"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Get the schema from the state</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Use the LLM to determine if the input is relevant to the database schema</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    context_prompt </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">    Determine whether the following user input is a question that can be answered using the database schema provided below.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">    Respond with only "relevant" if the input is relevant to the database schema, or "irrelevant" if it is not.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">    User Input:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">    </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">translated_input</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">    Database Schema:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">    </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">database_schema</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">    """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Call the LLM for context check</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    llm_invoke </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> llm</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">invoke</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">context_prompt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    llm_response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> llm_invoke</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">content</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">strip</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">lower</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Access the 'content' attribute and strip any extra spaces and lower case</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Process the response from the LLM</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> llm_response </span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"relevant"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Input is relevant to the database schema."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Input is not relevant. Halting the workflow."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        error </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"yes"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        messages </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"assistant"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"Your question is not related to the database and cannot be processed."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Update the state with error and messages</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"error"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> error</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"messages"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> messages</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> state</span><br/></span></code></pre></div></div>
<h5 class="anchor anchorTargetStickyNavbar_Vzrq" id=5-generate>5. Generate<a href=#5-generate class=hash-link aria-label="Direct link to 5. Generate" title="Direct link to 5. Generate" translate=no>​</a></h5>
<p>The <code>generate</code> node constructs SQL queries from natural language input by retrieving relevant documentation from the vector store and leveraging a pre-defined SQL generation chain. It aligns the query with the user’s intent and schema context, updating the state with the generated SQL and its description.</p>
<ul>
<li class=""><strong>Examples:</strong>
<ul>
<li class="">Input: <em>"Find total sales."</em><br/>
<!-- -->Generated SQL: <em>"SELECT SUM(Products.Price * OrderDetails.Quantity) AS TotalSales FROM OrderDetails LEFT JOIN Products ON OrderDetails.ProductID = Products.ProductID;"</em></li>
<li class="">Input: <em>"List all customers in New York."</em><br/>
<!-- -->Generated SQL: <em>"SELECT name FROM customers WHERE location = 'New York';"</em></li>
</ul>
</li>
<li class=""><strong>Code:</strong></li>
</ul>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">generate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> GraphState</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> GraphState</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Generates an SQL query based on the user's input. The node retrieves relevant documents from</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    the vector store and uses a generation chain to produce an SQL query.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Args:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        state (GraphState): The current graph state, which contains the translated input and</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">                            other relevant data such as messages and iteration count.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Returns:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        GraphState: The updated state with the generated SQL query and related messages.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Generating SQL query."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Extract relevant data from the state</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    messages </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"messages"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    iterations </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"iterations"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    translated_input </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"translated_input"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    database_schema </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"database_schema"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Retrieve relevant documents from the vector store based on the translated user input</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    docs </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> vector_store</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">similarity_search</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">translated_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> k</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">4</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    retrieved_docs </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"\n\n"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">join</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">doc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">page_content </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> doc </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> docs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Generate the SQL query using the SQL generation chain</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    sql_solution </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> sql_gen_chain</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">invoke</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"retrieved_docs"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> retrieved_docs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"database_schema"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> database_schema</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"messages"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"user"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> translated_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Save the generated SQL query in the state</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    messages </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"assistant"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f"</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">sql_solution</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-interpolation interpolation">description</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">\nSQL Query:\n</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">sql_solution</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-interpolation interpolation">sql_code</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    iterations </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Log the generated SQL query</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Generated SQL query:\n%s"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> sql_solution</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sql_code</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Update the state with the generated SQL query and updated message list</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"generation"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> sql_solution</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"messages"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> messages</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"iterations"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> iterations</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> state</span><br/></span></code></pre></div></div>
<h5 class="anchor anchorTargetStickyNavbar_Vzrq" id=6-post-safety-check>6. Post-safety Check<a href=#6-post-safety-check class=hash-link aria-label="Direct link to 6. Post-safety Check" title="Direct link to 6. Post-safety Check" translate=no>​</a></h5>
<p>The <code>post_safety_check</code> node ensures the generated SQL query is safe by performing a final validation for harmful SQL commands. While the earlier pre-safety check identifies disallowed operations in user inputs, this post-safety check verifies that the SQL query produced after generation adheres to security guidelines. This two-step approach ensures that even if disallowed operations are inadvertently introduced during query generation, they can be caught and flagged. If unsafe queries are detected, the node halts the workflow, updates the state with an error flag, and provides feedback to the user.</p>
<ul>
<li class=""><strong>Examples:</strong></li>
</ul>
<ol>
<li class=""><strong>Disallowed Operations:</strong>
<ul>
<li class=""><strong>Generated Query:</strong> <em>"DROP TABLE orders;"</em></li>
<li class=""><strong>Response:</strong> <em>"The generated SQL query contains disallowed SQL operations: DROP and cannot be processed."</em></li>
<li class=""><strong>Generated Query:</strong> <em>"SELECT name FROM customers;"</em></li>
<li class=""><strong>Response:</strong> <em>"Query is valid."</em></li>
</ul>
</li>
</ol>
<ul>
<li class=""><strong>Code:</strong></li>
</ul>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">post_safety_check</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> GraphState</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> GraphState</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Perform safety checks on the generated SQL query to ensure that it doesn't contain disallowed operations</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    such as CREATE, DELETE, DROP, etc. This node checks the SQL query generated earlier in the workflow.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Args:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        state (GraphState): The current graph state containing the generated SQL query.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Returns:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        GraphState: The updated state with error status and messages if any issues are found.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Performing post-safety check on the generated SQL query."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Retrieve the generated SQL query from the state</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    sql_solution </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"generation"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    sql_query </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> sql_solution</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"sql_code"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">""</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">strip</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    messages </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"messages"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    error </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"no"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># List of disallowed SQL operations</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    disallowed_operations </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">'CREATE'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">'DELETE'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">'DROP'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">'INSERT'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">'UPDATE'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">'ALTER'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">'TRUNCATE'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">'EXEC'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">'EXECUTE'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    pattern </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> re</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token builtin" style="color:rgb(86, 156, 214)">compile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">r'\b('</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">'|'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">join</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">disallowed_operations</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">r')\b'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> re</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">IGNORECASE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Check if the generated SQL query contains disallowed SQL operations</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    found_operations </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> pattern</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">findall</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">sql_query</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> found_operations</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">warning</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"Generated SQL query contains disallowed SQL operations: %s. Halting the workflow."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">", "</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">join</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token builtin" style="color:rgb(86, 156, 214)">set</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">found_operations</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        error </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"yes"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        messages </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"assistant"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f"The generated SQL query contains disallowed SQL operations: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation string" style="color:rgb(206, 145, 120)">', '</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-interpolation interpolation">join</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation interpolation builtin" style="color:rgb(86, 156, 214)">set</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation interpolation">found_operations</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)"> and cannot be processed."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Generated SQL query passed the safety check."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Update state with error status and messages</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"error"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> error</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"messages"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> messages</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> state</span><br/></span></code></pre></div></div>
<h5 class="anchor anchorTargetStickyNavbar_Vzrq" id=7-sql-check>7. SQL Check<a href=#7-sql-check class=hash-link aria-label="Direct link to 7. SQL Check" title="Direct link to 7. SQL Check" translate=no>​</a></h5>
<p>The <code>sql_check</code> node ensures the generated SQL query is safe and syntactically valid by executing it within a transactional savepoint. Any changes are rolled back after validation, with errors flagged and detailed feedback provided to maintain query integrity.</p>
<ul>
<li class=""><strong>Examples:</strong>
<ul>
<li class="">Input SQL: <em>"SELECT name FROM customers WHERE city = 'New York';"</em><br/>
<!-- -->Validation: Query is valid.</li>
<li class="">Input SQL: <em>"SELECT MONTH(date) AS month, SUM(total) AS total_sales FROM orders GROUP BY MONTH(date);"</em><br/>
<!-- -->Response: <em>"Your SQL query failed to execute: no such function: MONTH."</em></li>
</ul>
</li>
<li class=""><strong>Code:</strong></li>
</ul>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">sql_check</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> GraphState</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> GraphState</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Validates the generated SQL query by attempting to execute it on the database.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    If the query is valid, the changes are rolled back to ensure no data is modified.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    If there is an error during execution, the error is logged and the state is updated accordingly.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Args:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        state (GraphState): The current graph state, which contains the generated SQL query</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">                             and the messages to communicate with the user.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Returns:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        GraphState: The updated state with error status and messages if the query is invalid.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Validating SQL query."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Extract relevant data from the state</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    messages </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"messages"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    sql_solution </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"generation"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    error </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"no"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    sql_code </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> sql_solution</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sql_code</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">strip</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">try</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Start a savepoint for the transaction to allow rollback</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        conn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">'SAVEPOINT sql_check;'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Attempt to execute the SQL query</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">sql_code</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Roll back to the savepoint to undo any changes</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        conn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">'ROLLBACK TO sql_check;'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"SQL query validation: success."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">except</span><span class="token plain"> Exception </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> e</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Roll back in case of error</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        conn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">'ROLLBACK TO sql_check;'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">error</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"SQL query validation failed. Error: %s"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        messages </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"user"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f"Your SQL query failed to execute: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">e</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        error </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"yes"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Update the state with the error status</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"error"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> error</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"messages"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> messages</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> state</span><br/></span></code></pre></div></div>
<h5 class="anchor anchorTargetStickyNavbar_Vzrq" id=8-run-query>8. Run Query<a href=#8-run-query class=hash-link aria-label="Direct link to 8. Run Query" title="Direct link to 8. Run Query" translate=no>​</a></h5>
<p>The <code>run_query</code> node executes the validated SQL query, connecting to the database to retrieve results. It updates the state with the query output, ensuring the data is formatted for further analysis or reporting while implementing robust error handling.</p>
<ul>
<li class=""><strong>Examples:</strong>
<ul>
<li class="">Input SQL: <em>"SELECT COUNT(*) FROM Customers WHERE City = 'New York';"</em><br/>
<!-- -->Query Result: <em>"(0,)"</em></li>
<li class="">Input SQL: _"SELECT SUM(Products.Price * OrderDetails.Quantity) AS TotalSales FROM OrderDetails LEFT JOIN Products ON OrderDetails.ProductID = Products.ProductID;"*<br/>
<!-- -->Query Result: _"(6925.0,)"_</li>
</ul>
</li>
<li class=""><strong>Code:</strong></li>
</ul>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">run_query</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> GraphState</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> GraphState</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Executes the generated SQL query on the database and retrieves the results if it is a SELECT query.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    For non-SELECT queries, commits the changes to the database. If no records are found for a SELECT query,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    the `no_records_found` flag is set to True.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Args:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        state (GraphState): The current graph state, which contains the generated SQL query and other relevant data.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Returns:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        GraphState: The updated state with the query results, or a flag indicating if no records were found.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Running SQL query."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Extract the SQL query from the state</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    sql_solution </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"generation"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    sql_code </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> sql_solution</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sql_code</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">strip</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    results </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    no_records_found </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">False</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Flag to indicate no records found</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">try</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Execute the SQL query</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">sql_code</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># For SELECT queries, fetch and store results</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> sql_code</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">upper</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">startswith</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"SELECT"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            results </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">fetchall</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">not</span><span class="token plain"> results</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                no_records_found </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">True</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"SQL query execution: success. No records found."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"SQL query execution: success."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># For non-SELECT queries, commit the changes</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            conn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">commit</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"SQL query execution: success. Changes committed."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">except</span><span class="token plain"> Exception </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> e</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">error</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"SQL query execution failed. Error: %s"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Update the state with results and flag for no records found</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"results"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> results</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"no_records_found"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> no_records_found</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> state</span><br/></span></code></pre></div></div>
<h5 class="anchor anchorTargetStickyNavbar_Vzrq" id=decision-step-determine-next-action>Decision Step: Determine Next Action<a href=#decision-step-determine-next-action class=hash-link aria-label="Direct link to Decision Step: Determine Next Action" title="Direct link to Decision Step: Determine Next Action" translate=no>​</a></h5>
<p>The <code>decide_next_step</code> function acts as a control point in the workflow, deciding what action should be taken next based on the current state. It evaluates the <code>error</code> status and the number of iterations performed so far to determine if the query should be run, the workflow should be finished, or if the system should retry generating the SQL query.</p>
<ul>
<li class="">
<p><strong>Process:</strong></p>
<ul>
<li class="">If there is no error (<code>error == "no"</code>), the system proceeds with running the SQL query.</li>
<li class="">If the maximum number of iterations (<code>max_iterations</code>) has been reached, the workflow ends.</li>
<li class="">If an error occurred and the maximum iterations haven't been reached, the system will retry the query generation.</li>
</ul>
</li>
<li class="">
<p><strong>Example Workflow Decisions:</strong></p>
<ul>
<li class=""><strong>No Error, Proceed with Query</strong>: If no errors are found in the previous steps, the workflow moves forward to run the query.</li>
<li class=""><strong>Maximum Iterations Reached, End Workflow</strong>: If the workflow has already attempted a set number of times (<code>max_iterations</code>), it terminates.</li>
<li class=""><strong>Error Detected, Retry SQL Generation</strong>: If an error occurs and the system has not yet reached the retry limit, it will attempt to regenerate the SQL query.</li>
</ul>
</li>
<li class="">
<p><strong>Code:</strong></p>
</li>
</ul>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">decide_next_step</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> GraphState</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Determines the next step in the workflow based on the current state, including whether the query</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    should be run, the workflow should be finished, or if the query generation needs to be retried.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Args:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        state (GraphState): The current graph state, which contains error status and iteration count.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Returns:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        str: The next step in the workflow, which can be "run_query", "generate", or END.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Deciding next step based on current state."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    error </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"error"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    iterations </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"iterations"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> error </span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"no"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Error status: no. Proceeding with running the query."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"run_query"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">elif</span><span class="token plain"> iterations </span><span class="token operator" style="color:rgb(212, 212, 212)">>=</span><span class="token plain"> max_iterations</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Maximum iterations reached. Ending the workflow."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> END</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Error detected. Retrying SQL query generation."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"generate"</span><br/></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id=workflow-orchestration-and-conditional-logic>Workflow Orchestration and Conditional Logic<a href=#workflow-orchestration-and-conditional-logic class=hash-link aria-label="Direct link to Workflow Orchestration and Conditional Logic" title="Direct link to Workflow Orchestration and Conditional Logic" translate=no>​</a></h4>
<p>To define the orchestration of tasks in our system, we construct a workflow graph using the <code>StateGraph</code> class. Each task is represented as a node, and the transitions between tasks are defined as edges. Conditional edges are used to control the flow based on the state of the workflow.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">get_workflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">conn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> vector_store</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""Define and compile the LangGraph workflow."""</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Max iterations: defines how many times the workflow should retry in case of errors</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    max_iterations </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">3</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># SQL generation chain: this is a chain that will generate SQL based on retrieved docs</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    sql_gen_chain </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> get_sql_gen_chain</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Initialize OpenAI LLM for translation and safety checks</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    llm </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ChatOpenAI</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">temperature</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"gpt-4o-mini"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Define the individual nodes of the workflow</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)"># Insert nodes code defined above here</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Build the workflow graph</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    workflow </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> StateGraph</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">GraphState</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Define workflow nodes</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    workflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">add_node</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"translate_input"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> translate_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Translate user input to structured format</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    workflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">add_node</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"pre_safety_check"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> pre_safety_check</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Perform a pre-safety check on input</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    workflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">add_node</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"schema_extract"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> schema_extract</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Extract the database schema</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    workflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">add_node</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"context_check"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> context_check</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Validate input relevance to context</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    workflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">add_node</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"generate"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> generate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Generate SQL query</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    workflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">add_node</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"post_safety_check"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> post_safety_check</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Perform a post-safety check on generated SQL query</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    workflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">add_node</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"sql_check"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> sql_check</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Validate the generated SQL query</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    workflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">add_node</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"run_query"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> run_query</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Execute the SQL query</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Define workflow edges</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    workflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">add_edge</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">START</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"translate_input"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Start at the translation step</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    workflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">add_edge</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"translate_input"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"pre_safety_check"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Move to safety checks</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Conditional edge after safety check</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    workflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">add_conditional_edges</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">"pre_safety_check"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Start at the pre_safety_check node</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">lambda</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"schema_extract"</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"error"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"no"</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token plain"> END</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Decide next step</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">"schema_extract"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"schema_extract"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> END</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> END</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Map states to nodes</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    workflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">add_edge</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"schema_extract"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"context_check"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Proceed to context validation</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Conditional edge after context check</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    workflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">add_conditional_edges</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">"context_check"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Start at the context_check node</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">lambda</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"generate"</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"error"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"no"</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token plain"> END</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Decide next step</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">"generate"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"generate"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> END</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> END</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    workflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">add_edge</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"generate"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"post_safety_check"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Proceed to post-safety check</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Conditional edge after post-safety check</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    workflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">add_conditional_edges</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"post_safety_check"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Start at the post_safety_check node</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">lambda</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"sql_check"</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"error"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"no"</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token plain"> END</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># If no error, proceed to sql_check, else END</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">"sql_check"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"sql_check"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> END</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> END</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Conditional edge after SQL validation</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    workflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">add_conditional_edges</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">"sql_check"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Start at the sql_check node</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        decide_next_step</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Function to determine the next step</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"run_query"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"run_query"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># If SQL is valid, execute the query</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"generate"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"generate"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># If retry is needed, go back to generation</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            END</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> END  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Otherwise, terminate the workflow</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    workflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">add_edge</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"run_query"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> END</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Final step is to end the workflow</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Compile and return the workflow application</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    app </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> workflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token builtin" style="color:rgb(86, 156, 214)">compile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> app</span><br/></span></code></pre></div></div>
<ol>
<li class=""><strong>Start to <code>translate_input</code></strong>:<br/>
<!-- -->The workflow begins by translating user input into a structured format.</li>
<li class=""><strong><code>translate_input</code> to <code>pre_safety_check</code></strong>:<br/>
<!-- -->After translation, the workflow proceeds to check the safety of the input.</li>
<li class=""><strong><code>pre_safety_check</code> Conditional Rule</strong>:<!-- -->
<ul>
<li class="">If the input passes the pre-safety check (<code>state["error"] == "no"</code>), the workflow moves to <code>schema_extract</code>.</li>
<li class="">If the input fails the pre-safety check, the workflow terminates (<code>END</code>).</li>
</ul>
</li>
<li class=""><strong><code>schema_extract</code> to <code>context_check</code></strong>:<br/>
<!-- -->The schema is extracted, and then the workflow validates the input’s relevance to the database context.</li>
<li class=""><strong><code>context_check</code> Conditional Rule</strong>:<!-- -->
<ul>
<li class="">If the input is relevant (<code>state["error"] == "no"</code>), the workflow moves to <code>generate</code>.</li>
<li class="">If not, the workflow terminates (<code>END</code>).</li>
</ul>
</li>
<li class=""><strong><code>generate</code> to <code>post_safety_check</code></strong>:<br/>
<!-- -->The workflow generates an SQL query and sends it for validation.\</li>
<li class=""><strong><code>post_safety_check</code> Conditional Rule</strong>: - If the input passes the post-safety check (<code>state["error"] == "no"</code>), the workflow moves to <code>sql_check</code>. - If the input fails the post-safety check, the workflow terminates (<code>END</code>).</li>
<li class=""><strong><code>sql_check</code> Conditional Rule</strong>:<!-- -->
<ul>
<li class="">If the query is valid, the workflow proceeds to <code>run_query</code>.</li>
<li class="">If the query needs adjustments and the number of iteractions is lower than 3, the workflow loops back to <code>generate</code>.</li>
<li class="">If validation fails and the number of iteractions is higher than 3, the workflow terminates (<code>END</code>).</li>
</ul>
</li>
<li class=""><strong><code>run_query</code> to <code>END</code></strong>:<br/>
<!-- -->Once the query is executed, the workflow ends.</li>
</ol>
<p>The schema above provides a representation of the LangGraph Nodes and Edges:</p>
<img src=/mlflow-website/assets/images/graph-37d109015dac66cc4ba91020cf15d09a.png alt="Graph Representation of our Agent" width=50% />
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=logging-the-model-in-mlflow>Logging the Model in MLflow<a href=#logging-the-model-in-mlflow class=hash-link aria-label="Direct link to Logging the Model in MLflow" title="Direct link to Logging the Model in MLflow" translate=no>​</a></h2>
<p>Now that we have built a Multi-Lingual Query Engine using LangGraph, we are ready to log the model using MLflow’s <a href=https://mlflow.org/docs/latest/model/models-from-code.html target=_blank rel="noopener noreferrer" class="">Models from Code</a>. Logging the model into MLflow allows us to treat the Multi-Lingual Query Engine as a traditional ML model, enabling seamless tracking, versioning, and packaging for deployment across diverse serving infrastructures. MLflow’s Models from Code strategy, where we log the code that represents the model, contrasts with MLflow object-based logging, where a model object is created, serialized, and logged as a pickle or JSON object.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id=step-1-create-our-model-from-code-file>Step 1: Create our Model from Code File<a href=#step-1-create-our-model-from-code-file class=hash-link aria-label="Direct link to Step 1: Create our Model from Code File" title="Direct link to Step 1: Create our Model from Code File" translate=no>​</a></h3>
<p>So far, we have defined the <code>get_workflow</code> function in a file named <code>workflow.py</code>. In this step, we will create a new file, <code>sql_model.py</code>, which introduces the <code>SQLGenerator</code> class. This script will:</p>
<ol>
<li class="">Import the <code>get_workflow</code> function from <code>workflow.py</code>.</li>
<li class="">Define the <code>SQLGenerator</code> class as a <code>PythonModel</code>, including a predict method that utilizes the <code>get_workflow</code> function to initialize the LangGraph workflow.</li>
<li class="">Use <code>mlflow.models.set_model</code> to designate the <code>SQLGenerator PythonModel</code> class as the model of interest for MLflow.</li>
</ol>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> mlflow</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> definitions </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> REMOTE_SERVER_URI</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> workflow </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> get_workflow</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_tracking_uri</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">REMOTE_SERVER_URI</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">SQLGenerator</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">pyfunc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">PythonModel</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">predict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> model_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> get_workflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            model_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"conn"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> model_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"cursor"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> model_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"vector_store"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">models</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">SQLGenerator</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br/></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id=step-2-log-with-mlflow-models-from-code-feature>Step 2: Log with MLflow Models from Code feature<a href=#step-2-log-with-mlflow-models-from-code-feature class=hash-link aria-label="Direct link to Step 2: Log with MLflow Models from Code feature" title="Direct link to Step 2: Log with MLflow Models from Code feature" translate=no>​</a></h3>
<p>With the SQLGenerator custom Python model defined, the next step is to log it using MLflow's Models from Code feature. This involves using the log model standard API specifying the path to the sql_model.py script and using the code_paths parameter to include workflow.py as a dependency. This approach ensures that all necessary code files are available when the model is loaded in a different environment or on another machine.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> mlflow</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> definitions </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    EXPERIMENT_NAME</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    MODEL_ALIAS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    REGISTERED_MODEL_NAME</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    REMOTE_SERVER_URI</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> mlflow </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> MlflowClient</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">client </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> MlflowClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">tracking_uri</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">REMOTE_SERVER_URI</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_tracking_uri</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">REMOTE_SERVER_URI</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_experiment</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">EXPERIMENT_NAME</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">with</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">start_run</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    logged_model_info </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">pyfunc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">log_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        python_model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"sql_model.py"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        artifact_path</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"sql_generator"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        registered_model_name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">REGISTERED_MODEL_NAME</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        code_paths</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"workflow.py"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">client</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_registered_model_alias</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    REGISTERED_MODEL_NAME</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> MODEL_ALIAS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> logged_model_info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">registered_model_version</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br/></span></code></pre></div></div>
<p>In the MLflow UI, the stored model includes both the <code>sql_model.py</code> and <code>workflow.py</code> scripts as artifacts within the run. This logging from code feature not only records the model's parameters and metrics but also captures the code defining its functionality. This ensures observability, seamless tracking, and straightforward debugging directly through the UI. However, it is crucial to ensure that sensitive elements, such as API keys or credentials, are never hardcoded into these scripts. Since the code is stored as-is, any sensitive information included may lead to token leakage and pose security risks. Instead, sensitive data should be securely managed using environment variables, secret management systems, or other secure methods.</p>
<p><img decoding=async loading=lazy alt=model_as_code_artifact src=/mlflow-website/assets/images/model_as_code-95d70b56ca83f408bfefac190d0a51cc.png width=1915 height=962 class=img_ev3q /></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=use-the-logged-multi-lingual-query-engine-in-mainpy>Use the Logged Multi-Lingual Query Engine in <code>main.py</code><a href=#use-the-logged-multi-lingual-query-engine-in-mainpy class=hash-link aria-label="Direct link to use-the-logged-multi-lingual-query-engine-in-mainpy" title="Direct link to use-the-logged-multi-lingual-query-engine-in-mainpy" translate=no>​</a></h2>
<p>After logging the model, it can be loaded back from the MLflow Tracking Server using the model URI and the standard <code>mlflow.pyfunc.load_model</code> API. When the model is loaded, the <code>workflow.py</code> script will be executed along with the <code>sql_model.py</code> script, ensuring that the <code>get_workflow</code> function is available when the <code>predict</code> method is called.</p>
<p>Executing the code below, we demonstrate that our Multi-Lingual Query Engine is able to perform natural language to SQL generation and query execution.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> os</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> logging</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> mlflow</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> database </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> setup_database</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> definitions </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    EXPERIMENT_NAME</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    MODEL_ALIAS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    REGISTERED_MODEL_NAME</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    REMOTE_SERVER_URI</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> dotenv </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> load_dotenv</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> vector_store </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> setup_vector_store</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_tracking_uri</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">REMOTE_SERVER_URI</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_experiment</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">EXPERIMENT_NAME</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">langchain</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">autolog</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Initialize the logger</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">_logger </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> logging</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">getLogger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">__name__</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">_logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">setLevel</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">logging</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">INFO</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">handler </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> logging</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">StreamHandler</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">formatter </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> logging</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Formatter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"%(asctime)s - %(name)s - %(levelname)s - %(message)s"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">handler</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">setFormatter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">formatter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">_logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">addHandler</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">handler</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">main</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Load environment variables from .env file</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    load_dotenv</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Access secrets using os.getenv</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"OPENAI_API_KEY"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"OPENAI_API_KEY"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Setup database and vector store</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    conn </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> setup_database</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    cursor </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> conn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    vector_store </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> setup_vector_store</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Load the model</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    model_uri </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f"models:/</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">REGISTERED_MODEL_NAME</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">@</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">MODEL_ALIAS</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    model </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">pyfunc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">load_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">model_uri</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    model_input </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">"conn"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> conn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"cursor"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> cursor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"vector_store"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> vector_store</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    app </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">predict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">model_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># save image</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    app</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get_graph</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">draw_mermaid_png</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        output_file_path</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"sql_agent_with_safety_checks.png"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Example user interaction</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Welcome to the SQL Assistant!"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">while</span><span class="token plain"> </span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        question </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"\nEnter your SQL question (or type 'exit' to quit): "</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> question</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">lower</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"exit"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">break</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Initialize the state with all required keys</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        initial_state </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"messages"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"user"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> question</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"iterations"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"error"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">""</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"results"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"generation"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"no_records_found"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token boolean">False</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"translated_input"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">""</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Initialize translated_input</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        solution </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> app</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">invoke</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">initial_state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Check if an error was set during the safety check</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> solution</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"error"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"yes"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"\nAssistant Message:\n"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">solution</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"messages"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Display the assistant's message</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">continue</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Skip to the next iteration</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Extract the generated SQL query from solution["generation"]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        sql_query </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> solution</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"generation"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sql_code</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"\nGenerated SQL Query:\n"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">sql_query</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Extract and display the query results</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> solution</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"no_records_found"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"\nNo records found matching your query."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">elif</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"results"</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> solution </span><span class="token keyword" style="color:rgb(86, 156, 214)">and</span><span class="token plain"> solution</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"results"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">is</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">not</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"\nQuery Results:\n"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> row </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> solution</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"results"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">row</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"\nNo results returned or query did not execute successfully."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    _logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Goodbye!"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"__main__"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    main</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=project-file-structure>Project File Structure<a href=#project-file-structure class=hash-link aria-label="Direct link to Project File Structure" title="Direct link to Project File Structure" translate=no>​</a></h2>
<p>The Project follows a simple file structure:</p>
<img src=/mlflow-website/assets/images/file_structure-93a5eec4529aff31b94a1e91072ff864.png alt="file structure" width=60% />
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=mlflow-tracing>MLflow Tracing<a href=#mlflow-tracing class=hash-link aria-label="Direct link to MLflow Tracing" title="Direct link to MLflow Tracing" translate=no>​</a></h2>
<p><a href=https://mlflow.org/docs/latest/llms/tracing/index.html target=_blank rel="noopener noreferrer" class="">MLflow Automated Tracing</a> provides fully automated integrations with various GenAI libraries such as LangChain, OpenAI, LlamaIndex, DSPy, and AutoGen. Since our AI Workflow is built using LangGraph, we can activate automated LangChain tracing by enabling <code>mlflow.langchain.autolog()</code>.</p>
<p>With LangChain autologging, traces are automatically logged to the active MLflow experiment whenever invocation APIs are called on chains. This seamless integration ensures that every interaction is captured for monitoring and analysis.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id=viewing-traces-in-mlflow>Viewing Traces in MLflow<a href=#viewing-traces-in-mlflow class=hash-link aria-label="Direct link to Viewing Traces in MLflow" title="Direct link to Viewing Traces in MLflow" translate=no>​</a></h3>
<p>Traces can be easily accessed by navigating to the MLflow experiment of interest and clicking on the "Tracing" tab. Once inside, selecting a specific trace provides detailed execution information.</p>
<p>Each trace includes:</p>
<ol>
<li class=""><strong>Execution Graphs</strong>: Visualizations of the workflow steps.</li>
<li class=""><strong>Inputs and Outputs</strong>: Detailed logs of data processed at each step.</li>
</ol>
<p>By leveraging MLflow Tracing, we gain granular visibility into the whole graph execution. AI workflows graphs can often feel like a black box, making it challenging to debug and understand what is happening at each step. However, with just a single line of code to enable tracing, MLflow provides clear and detailed insights into the workflow, allowing developers to effectively debug, monitor, and optimize every node of the graph ensuring that our Multi-Lingual Query Engine remains transparent, auditable, and scalable.</p>
<p><img decoding=async loading=lazy alt=mlflow_tracing_gif src=/mlflow-website/assets/images/mlflow_trace-ded83c22f153c03b7179262b98dc7d68.gif width=2048 height=1067 class=img_ev3q /></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=conclusion>Conclusion<a href=#conclusion class=hash-link aria-label="Direct link to Conclusion" title="Direct link to Conclusion" translate=no>​</a></h2>
<p>Throughout this post, we explored the process of building and managing a Multi-Lingual Query Engine using LangGraph and MLflow. By integrating LangGraph’s dynamic AI workflows with MLflow’s robust lifecycle management and tracing features, we’ve created a system that not only delivers accurate and efficient natural language to SQL generation and execution but is also transparent and scalable.</div><footer class=docusaurus-mt-lg><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class=col><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class=tag_QGVx><a rel=tag class="tag_zVej tagRegular_sFm0" href=/mlflow-website/blog/tags/pyfunc>pyfunc</a><li class=tag_QGVx><a rel=tag class="tag_zVej tagRegular_sFm0" href=/mlflow-website/blog/tags/mlflow>mlflow</a><li class=tag_QGVx><a rel=tag class="tag_zVej tagRegular_sFm0" href=/mlflow-website/blog/tags/sql-generator>sql-generator</a><li class=tag_QGVx><a rel=tag class="tag_zVej tagRegular_sFm0" href=/mlflow-website/blog/tags/models-from-code>models-from-code</a><li class=tag_QGVx><a rel=tag class="tag_zVej tagRegular_sFm0" href=/mlflow-website/blog/tags/tracing>tracing</a></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href=/mlflow-website/blog/custom-tracing><div class=pagination-nav__sublabel>Newer post</div><div class=pagination-nav__label>Beyond Autolog: Add MLflow Tracing to a New LLM Provider</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/mlflow-website/blog/mlflow-tracing-in-jupyter><div class=pagination-nav__sublabel>Older post</div><div class=pagination-nav__label>MLflow Tracing in Jupyter Notebooks</div></a></nav></div></div></div></div></main><footer class="relative pb-30 flex flex-col pt-30"><div style="position:absolute;width:100%;bottom:0;pointer-events:none;mask-composite:intersect;height:360px;background-image:repeating-linear-gradient(
        to right,
        rgba(0, 0, 0, 0.05),
        rgba(0, 0, 0, 0.25) 18px,
        transparent 2px,
        transparent 10px
      ),
      radial-gradient(
        circle at bottom center,
        var(--color-brand-red) 0%,
        transparent 60%
      ),
      linear-gradient(to right, color-mix(in srgb, var(--color-brand-red), oklch(0.33 0.15 328.37) 80%), color-mix(in srgb, var(--color-brand-red), oklch(0.66 0.17 248.82) 100%));mask-image:radial-gradient(ellipse at center bottom, black 60%, transparent 80%),
      linear-gradient(to top, black 10%, transparent 40%)"></div><div class=z-1><div class="flex flex-row justify-between items-start px-6 lg:px-20 gap-10 xs:gap-0 max-w-container"><div class="flex flex-col gap-8"><svg xmlns=http://www.w3.org/2000/svg width=109 height=40 fill=none viewBox="0 0 109 40" class="h-[36px] shrink-0"><path fill=#fff d="M0 31.032v-15.53h3.543v1.968c.893-1.594 2.84-2.425 4.593-2.425 2.042 0 3.828.926 4.658 2.745 1.216-2.043 3.034-2.745 5.043-2.745 2.81 0 5.49 1.787 5.49 5.904v10.083h-3.574v-9.478c0-1.818-.926-3.19-3-3.19-1.947 0-3.224 1.53-3.224 3.445v9.22H9.893v-9.475c0-1.786-.898-3.18-3.003-3.18-1.977 0-3.223 1.467-3.223 3.444v9.221ZM27.855 31.032V7.929h3.703v23.103ZM30.07 39.487c.833.232 1.582.383 3.17.383 2.953 0 6.436-1.665 7.353-6.339l3.786-18.739h5.629l.687-3.117h-5.686l.765-3.725c.586-2.892 2.186-4.358 4.754-4.358.668 0 .48.058 1.076.17L52.427.57c-.793-.237-1.503-.379-3.049-.379a7.32 7.32 0 0 0-4.528 1.484c-1.441 1.114-2.393 2.75-2.827 4.863l-1.066 5.137h-5.034l-.411 3.12h4.823L36.859 32.12c-.383 1.965-1.5 4.315-4.708 4.315-.727 0-.463-.055-1.121-.162ZM53.342 30.905H49.64l5.074-23.309h3.701ZM71.807 16.477A7.962 7.962 0 0 0 60.97 27.904l2.425-1.78a5.005 5.005 0 0 1 3.845-8.145v1.895ZM62.618 29.472a7.962 7.962 0 0 0 10.836-11.428l-2.425 1.78a5.005 5.005 0 0 1-3.845 8.145v-1.894ZM78.092 15.493h4.044l.823 10.612 5.759-10.612 3.839.055 1.508 10.557 5.074-10.612 3.701.055-7.678 15.493H91.46l-1.783-11.106-5.895 11.106h-3.84ZM105.072 15.768h-.766v-.266h1.845v.272h-.765v2.243h-.314ZM106.614 15.502h.383l.482 1.34q.091.259.178.524h.018c.059-.176.113-.352.172-.524l.478-1.34h.383v2.515h-.298V16.63c0-.22.024-.523.04-.747h-.016l-.191.574-.475 1.304h-.208l-.481-1.302-.191-.574h-.015c.017.224.042.527.042.747v1.387h-.291Z"/></svg><div class="text-xs text-gray-800 text-left md:text-nowrap md:w-0">© 2025 MLflow Project, a Series of LF Projects, LLC.</div></div><div class="flex flex-col flex-wrap justify-end md:text-right md:flex-row gap-x-10 lg:gap-x-20 gap-y-5 w-2/5 md:w-auto md:pt-2 max-w-fit"><div><a href=/mlflow-website/>Components</a></div><div><a href=/mlflow-website/releases>Releases</a></div><div><a href=/mlflow-website/blog>Blog</a></div><div><a href=https://mlflow.org/docs/latest/ target=_blank rel="noopener noreferrer">Docs</a></div><div><a href=/mlflow-website/ambassadors>Ambassador Program</a></div></div></div></div></footer></div></div></div></body>