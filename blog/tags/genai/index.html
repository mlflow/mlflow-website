<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">11 posts tagged with &quot;genai&quot; | MLflow</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="http://mlflow.org/mlflow-website/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="http://mlflow.org/mlflow-website/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="http://mlflow.org/mlflow-website/blog/tags/genai"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="11 posts tagged with &quot;genai&quot; | MLflow"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/mlflow-website/img/mlflow-favicon.ico"><link data-rh="true" rel="canonical" href="http://mlflow.org/mlflow-website/blog/tags/genai"><link data-rh="true" rel="alternate" href="http://mlflow.org/mlflow-website/blog/tags/genai" hreflang="en"><link data-rh="true" rel="alternate" href="http://mlflow.org/mlflow-website/blog/tags/genai" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/mlflow-website/blog/rss.xml" title="MLflow RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/mlflow-website/blog/atom.xml" title="MLflow Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=AW-16857946923"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","AW-16857946923",{anonymize_ip:!0})</script>
<link rel="preconnect" href="https://www.googletagmanager.com">
<script>window.dataLayer=window.dataLayer||[]</script>
<script>!function(e,t,a,n,g){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var m=t.getElementsByTagName(a)[0],r=t.createElement(a);r.async=!0,r.src="https://www.googletagmanager.com/gtm.js?id=GTM-TEST",m.parentNode.insertBefore(r,m)}(window,document,"script","dataLayer")</script>



<link rel="alternate" type="application/rss+xml" href="/mlflow-website/releases/rss.xml" title="MLflow RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/mlflow-website/releases/atom.xml" title="MLflow Atom Feed">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&amp;display=swap" display="swap"><link rel="stylesheet" href="/mlflow-website/assets/css/styles.4d0f8295.css">
<script src="/mlflow-website/assets/js/runtime~main.10805425.js" defer="defer"></script>
<script src="/mlflow-website/assets/js/main.c6f9124e.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TEST" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/mlflow-website/"></a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="flex flex-col min-h-screen w-full bg-[#0E1416]"><nav class="fixed w-full z-20 top-0 start-0 bg-[#F7F8F8]/1 border-b border-[#F7F8F8]/8 backdrop-blur-[20px]"><div class="flex flex-wrap items-center justify-between mx-auto px-6 md:px-20 py-2"><a href="/" class="flex items-center space-x-3 rtl:space-x-reverse"><svg width="109" height="40" viewBox="0 0 109 40" fill="none" xmlns="http://www.w3.org/2000/svg" class="h-[36px]"><path d="M0 31.032v-15.53h3.543v1.968c.893-1.594 2.84-2.425 4.593-2.425 2.042 0 3.828.926 4.658 2.745 1.216-2.043 3.034-2.745 5.043-2.745 2.81 0 5.49 1.787 5.49 5.904v10.083h-3.574v-9.478c0-1.818-.926-3.19-3-3.19-1.947 0-3.224 1.53-3.224 3.445v9.22H9.893v-9.475c0-1.786-.898-3.18-3.003-3.18-1.977 0-3.223 1.467-3.223 3.444v9.221ZM27.855 31.032V7.929h3.703v23.103ZM30.07 39.487c.833.232 1.582.383 3.17.383 2.953 0 6.436-1.665 7.353-6.339l3.786-18.739h5.629l.687-3.117h-5.686l.765-3.725c.586-2.892 2.186-4.358 4.754-4.358.668 0 .48.058 1.076.17L52.427.57c-.793-.237-1.503-.379-3.049-.379a7.319 7.319 0 0 0-4.528 1.484c-1.441 1.114-2.393 2.75-2.827 4.863l-1.066 5.137h-5.034l-.411 3.12h4.823L36.859 32.12c-.383 1.965-1.5 4.315-4.708 4.315-.727 0-.463-.055-1.121-.162ZM53.342 30.905H49.64l5.074-23.309h3.701ZM71.807 16.477A7.962 7.962 0 0 0 60.97 27.904l2.425-1.78a5.005 5.005 0 0 1 3.845-8.145v1.895ZM62.618 29.472a7.962 7.962 0 0 0 10.836-11.428l-2.425 1.78a5.005 5.005 0 0 1-3.845 8.145v-1.894ZM78.092 15.493h4.044l.823 10.612 5.759-10.612 3.839.055 1.508 10.557 5.074-10.612 3.701.055-7.678 15.493H91.46l-1.783-11.106-5.895 11.106h-3.84ZM105.072 15.768h-.766v-.266h1.845v.272h-.765v2.243h-.314ZM106.614 15.502h.383l.482 1.34c.062.172.119.348.178.524h.018c.059-.176.113-.352.172-.524l.478-1.34h.383v2.515h-.298V16.63c0-.22.024-.523.04-.747h-.016l-.191.574-.475 1.304h-.208l-.481-1.302-.191-.574h-.015c.017.224.042.527.042.747v1.387h-.291Z" fill="#fff"></path></svg></a><div class="flex flex-row items-center gap-6 md:order-2 space-x-3 md:space-x-0 rtl:space-x-reverse"><a href="https://login.databricks.com/" class="py-2 text-gray-900 w-full md:w-auto hidden md:block">Login</a><a href="https://login.databricks.com/?intent=SIGN_UP" class="hidden md:block"><button class="rounded-xl inline-flex items-center justify-center whitespace-nowrap font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:size-4 [&amp;_svg]:shrink-0 hover:cursor-pointer bg-white text-black hover:bg-white/90 text-[15px] px-4 py-2 w-fit">Sign up</button></a><button data-collapse-toggle="navbar-sticky" type="button" class="inline-flex items-center p-2 w-10 h-10 justify-center text-sm text-white md:hidden focus:outline-none cursor-pointer"><span class="sr-only">Open main menu</span><svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 17 14"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 1h15M1 7h15M1 13h15"></path></svg></button></div><div class="items-center justify-between w-full md:w-auto md:order-1 mt-4 md:mt-0 hidden md:flex"><ul class="flex flex-col font-medium md:flex-row gap-6 md:gap-10 w-full md:w-auto"><li class="w-full md:w-auto"><a href="/product" class="block py-2 text-gray-900 w-full md:w-auto">Product</a></li><li class="w-full md:w-auto"><a href="/releases" class="block py-2 text-gray-900 w-full md:w-auto">Releases</a></li><li class="w-full md:w-auto"><a href="/blog" class="block py-2 text-gray-900 w-full md:w-auto">Blog</a></li><li class="w-full md:w-auto"><a href="https://mlflow.org/docs/latest/" class="block py-2 text-gray-900 w-full md:w-auto">Docs</a></li><li class="w-full md:w-auto md:hidden"><a href="https://login.databricks.com/" class="block py-2 text-gray-900 w-full md:w-auto">Login</a></li><li class="w-full md:w-auto md:hidden"><a href="https://login.databricks.com/?intent=SIGN_UP"><button class="rounded-xl inline-flex items-center justify-center whitespace-nowrap font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:size-4 [&amp;_svg]:shrink-0 hover:cursor-pointer bg-white text-black hover:bg-white/90 text-[15px] px-4 py-2 w-full">Sign up</button></a></li></ul></div></div></nav><main class="flex flex-col"><div class="flex flex-col px-6 md:px-20 pt-32"><header class="margin-bottom--xl"><h1>11 posts tagged with &quot;genai&quot;</h1><a href="/mlflow-website/blog/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="A practical guide to using Cleanlab&#x27;s Trustworthy Language Models (TLM) to evaluate LLM responses captured in MLflow"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/mlflow-website/blog/tlm-tracing">Automatically find the bad LLM responses in your LLM Evals with Cleanlab</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-04-01T00:00:00.000Z" itemprop="datePublished">April 1, 2025</time> · <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/chris-mauck/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="/img/authors/chris_mauck.jpg" alt="Chris Mauck" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/chris-mauck/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Chris Mauck</span></a></div><small class="avatar__subtitle" itemprop="description">Data Scientist at Cleanlab</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>This guide will walk you through the process of evaluating LLM responses captured in MLflow with Cleanlab&#x27;s Trustworthy Language Models (TLM).</p>
<p>TLM boosts the reliability of any LLM application by indicating when the model’s response is untrustworthy. It works by analyzing the prompt and the generated response to calculate a <code>trustworthiness_score</code>, helping to automatically identify potentially incorrect or hallucinated outputs without needing ground truth labels. TLM can also provide explanations for its assessment.</p>
<p>MLflow provides tracing and evaluation capabilities that can be used to monitor, review, and debug the performance of AI applications. This post will show how to apply Cleanlab&#x27;s TLM to LLM responses recorded with MLflow tracing. Using Cleanlab&#x27;s TLM with MLflow enables you to systematically log, track, and analyze the trustworthiness evaluations provided by TLM for your LLM interactions.</p>
<p>You can find a notebook version of this guide <a href="https://github.com/cleanlab/cleanlab-tools/blob/main/TLM-MLflow-Integration/evaluating_traces_TLM_mlflow_dl.ipynb" target="_blank" rel="noopener noreferrer">here</a>.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>This guide requires a Cleanlab TLM API key. If you don&#x27;t have one, you can sign up for a free trial <a href="https://tlm.cleanlab.ai/" target="_blank" rel="noopener noreferrer">here</a>.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="install-dependencies--set-environment-variables">Install dependencies &amp; Set environment variables<a href="#install-dependencies--set-environment-variables" class="hash-link" aria-label="Direct link to Install dependencies &amp; Set environment variables" title="Direct link to Install dependencies &amp; Set environment variables">​</a></h2>
<p>To work through this guide, you&#x27;ll need to install the MLflow, OpenAI, and Cleanlab TLM Python packages:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">pip install -q mlflow openai cleanlab-tlm --upgrade</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Next, import the dependencies:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> mlflow</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> json</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> pandas </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> pd</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> rich </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> openai </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> OpenAI</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> getpass </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> getpass</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="api-keys">API Keys<a href="#api-keys" class="hash-link" aria-label="Direct link to API Keys" title="Direct link to API Keys">​</a></h3>
<p>This guide requires two API keys:</p>
<ul>
<li><a href="https://platform.openai.com/api-keys" target="_blank" rel="noopener noreferrer">OpenAI API Key</a></li>
<li><a href="https://tlm.cleanlab.ai/" target="_blank" rel="noopener noreferrer">Cleanlab TLM API Key</a></li>
</ul>
<p>If they are not already set as environment variables, you can set them manually as follows:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">not</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">openai_api_key </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;OPENAI_API_KEY&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    openai_api_key </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> getpass</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;🔑 Enter your OpenAI API key: &quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">not</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">cleanlab_tlm_api_key </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">getenv</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;CLEANLAB_TLM_API_KEY&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    cleanlab_tlm_api_key </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> getpass</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;🔑 Enter your Cleanlab TLM API key: &quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;OPENAI_API_KEY&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> openai_api_key</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;CLEANLAB_TLM_API_KEY&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> cleanlab_tlm_api_key</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="set-up-mlflow-tracking-server-and-logging">Set Up MLflow Tracking Server and Logging<a href="#set-up-mlflow-tracking-server-and-logging" class="hash-link" aria-label="Direct link to Set Up MLflow Tracking Server and Logging" title="Direct link to Set Up MLflow Tracking Server and Logging">​</a></h3>
<p>To manage our experiments, parameters, and results effectively, we&#x27;ll <a href="https://mlflow.org/docs/latest/getting-started/logging-first-model/step1-tracking-server" target="_blank" rel="noopener noreferrer">start a local MLflow Tracking Server</a>. This provides a dedicated UI for <a href="https://mlflow.org/docs/latest/tracking/" target="_blank" rel="noopener noreferrer">monitoring and managing our experiments</a> and allows us to <a href="https://mlflow.org/docs/latest/getting-started/" target="_blank" rel="noopener noreferrer">configure MLflow to connect to this server</a>. We&#x27;ll then enable autologging for OpenAI to automatically capture relevant information from our API calls.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># This will start a server on port 8080, in the background</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Navigate to http://localhost:8080 to see the MLflow UI</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token operator" style="color:rgb(212, 212, 212)">%</span><span class="token operator" style="color:rgb(212, 212, 212)">%</span><span class="token plain">bash </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">bg</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">mlflow server </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">host </span><span class="token number" style="color:rgb(181, 206, 168)">127.0</span><span class="token number" style="color:rgb(181, 206, 168)">.0</span><span class="token number" style="color:rgb(181, 206, 168)">.1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">port </span><span class="token number" style="color:rgb(181, 206, 168)">8080</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># Set up MLflow tracking server</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_tracking_uri</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;http://localhost:8080&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Enable logging for OpenAI SDK</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">openai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">autolog</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Set experiment name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_experiment</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Eval OpenAI Traces with TLM&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Get experiment ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">experiment_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get_experiment_by_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Eval OpenAI Traces with TLM&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">experiment_id</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="trace-some-llm-interactions-with-mlflow">Trace Some LLM Interactions with MLflow<a href="#trace-some-llm-interactions-with-mlflow" class="hash-link" aria-label="Direct link to Trace Some LLM Interactions with MLflow" title="Direct link to Trace Some LLM Interactions with MLflow">​</a></h2>
<p>For the sake of demonstration purposes, we&#x27;ll briefly generate some traces and track them in MLflow. Typically, you would have already captured traces in MLflow and would skip to &quot;Download Traces from the MLflow Tracking Server.&quot;</p>
<p>In this example, we&#x27;ll use some tricky trivia questions to generate some traces.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>TLM requires the entire input to the LLM to be provided. This includes any system prompts, context, or other information that was originally provided to the LLM to generate the response. Notice below that we include the system prompt in the trace metadata since by default the trace does not include the system prompt within the input.</p></div></div>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># Let&#x27;s use some tricky trivia questions to generate some traces</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">trivia_questions </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;What is the 3rd month of the year in alphabetical order?&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;What is the capital of France?&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;How many seconds are in 100 years?&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Alice, Bob, and Charlie went to a café. Alice paid twice as much as Bob, and Bob paid three times as much as Charlie. If the total bill was $72, how much did each person pay?&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;When was the Declaration of Independence signed?&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">client </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> OpenAI</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">generate_answers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">trivia_question</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> client</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">client</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    system_prompt </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;You are a trivia master.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">chat</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">completions</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">create</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;gpt-4o-mini&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        messages</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;role&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;system&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> system_prompt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;role&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;user&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> trivia_question</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    answer </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">choices</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">content</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> answer</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Generate answers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">answers </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> i </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">range</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token builtin" style="color:rgb(86, 156, 214)">len</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">trivia_questions</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    answer </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> generate_answers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">trivia_questions</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    answers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">answer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f&quot;Question </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">i</span><span class="token string-interpolation interpolation operator" style="color:rgb(212, 212, 212)">+</span><span class="token string-interpolation interpolation number" style="color:rgb(181, 206, 168)">1</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">trivia_questions</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string-interpolation interpolation">i</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f&quot;Answer </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">i</span><span class="token string-interpolation interpolation operator" style="color:rgb(212, 212, 212)">+</span><span class="token string-interpolation interpolation number" style="color:rgb(181, 206, 168)">1</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">:\n</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">answer</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">\n&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f&quot;Generated </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation builtin" style="color:rgb(86, 156, 214)">len</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation interpolation">answers</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)"> answers and tracked them in MLflow.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We can see the resulting traces in the MLflow UI and, if you are running this code in a Jupyter notebook, you can see the traces <a href="https://mlflow.org/blog/mlflow-tracing-in-jupyter" target="_blank" rel="noopener noreferrer">in the notebook cell output</a>.</p>
<p><img loading="lazy" alt="MLflow Traces" src="/mlflow-website/assets/images/1_trace-ff3ddd2c139d1b9725b8e6746dc62ec5.png" width="2962" height="2118" class="img_ev3q"></p>
<p>Next, we&#x27;ll download the generated traces from the MLflow tracking server so we can evaluate them with TLM. This illustrates how MLflow tracing can be used to generate datasets for downstream tasks like evaluation.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="download-traces-from-the-mlflow-tracking-server">Download Traces from the MLflow Tracking Server<a href="#download-traces-from-the-mlflow-tracking-server" class="hash-link" aria-label="Direct link to Download Traces from the MLflow Tracking Server" title="Direct link to Download Traces from the MLflow Tracking Server">​</a></h2>
<p>Fetching traces from MLflow is straightforward. Just set up the MLflow client and use the <code>search_traces()</code> function to fetch the data. We&#x27;ll fetch the traces and evaluate them. After that, we&#x27;ll add our scores back into MLflow.</p>
<p>The <code>search_traces()</code> function has arguments to filter the traces by tags, timestamps, and beyond. You can find more about other methods to <a href="https://mlflow.org/docs/latest/python_api/mlflow.client.html#mlflow.client.MlflowClient.search_traces" target="_blank" rel="noopener noreferrer">query traces</a> in the docs.</p>
<p>In this example, we&#x27;ll fetch all traces from the experiment.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">client </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">MlflowClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">traces </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">search_traces</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">experiment_ids</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">experiment_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Print the first trace</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">traces</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="evaluate-trustworthiness-with-tlm">Evaluate Trustworthiness with TLM<a href="#evaluate-trustworthiness-with-tlm" class="hash-link" aria-label="Direct link to Evaluate Trustworthiness with TLM" title="Direct link to Evaluate Trustworthiness with TLM">​</a></h2>
<p>Now that we have our traces, we can use TLM to generate trustworthiness scores and explanations for each trace.</p>
<p>Instead of running TLM individually on each trace, we&#x27;ll provide all of the <code>(prompt, response)</code> pairs in a list to TLM in a single call. This is more efficient and allows us to get scores and explanations for all of the traces at once. Then, using the trace request IDs, we can attach the scores and explanations back to the correct trace in MLflow.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> cleanlab_tlm </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> TLM</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">tlm </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> TLM</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">options</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;log&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;explanation&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We&#x27;ll use the following helper function to extract the prompt and response from each trace and return three lists: request IDs, prompts, and responses. We can then construct a DataFrame with the evaluation results, sort and filter the results by trustworthiness score, and tag the traces in MLflow with the scores and explanations.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">get_prompt_response_pairs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">traces</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    prompts </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    responses </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> trace </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> traces</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Parse request and response JSON</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        request_data </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> json</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">loads</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">request</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        response_data </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> json</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">loads</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Extract system prompt and user message from request</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        system_prompt </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> request_data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;messages&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        user_message </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> request_data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;messages&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Extract assistant&#x27;s response from response</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        assistant_response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> response_data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;choices&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;message&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        prompts</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">system_prompt </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;\n&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> user_message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        responses</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">assistant_response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> prompts</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> responses</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">request_ids </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">request_id </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> trace </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> traces</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">prompts</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> responses </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> get_prompt_response_pairs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">traces</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now, let&#x27;s use TLM to generate a <code>trustworthiness score</code> and <code>explanation</code> for each trace.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>It is essential to always include any system prompts, context, or other information that was originally provided to the LLM to generate the response. You should construct the prompt input to <code>get_trustworthiness_score()</code> in a way that is as similar as possible to the original prompt. This is why we included the system prompt in the trace metadata.</p></div></div>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># Evaluate each of the prompt, response pairs using TLM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">evaluations </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> tlm</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get_trustworthiness_score</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">prompts</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> responses</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Extract the trustworthiness scores and explanations from the evaluations</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">trust_scores </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">entry</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;trustworthiness_score&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> entry </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> evaluations</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">explanations </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">entry</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;log&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;explanation&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> entry </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> evaluations</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Create a DataFrame with the evaluation results</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">trace_evaluations </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">DataFrame</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;request_id&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> request_ids</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;prompt&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> prompts</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;response&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> responses</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;trust_score&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> trust_scores</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;explanation&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> explanations</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now we have a DataFrame mapping trace IDs to their scores and explanations. We&#x27;ve also included the prompt and response for each trace for demonstration purposes to find the <strong>least trustworthy trace!</strong></p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">sorted_df </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> trace_evaluations</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sort_values</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">by</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;trust_score&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> ascending</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">sorted_df</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">head</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">3</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># Let&#x27;s look at the least trustworthy trace.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Prompt: &quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> sorted_df</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">iloc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;prompt&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;\n&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;OpenAI Response: &quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> sorted_df</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">iloc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;response&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;\n&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;TLM Trust Score: &quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> sorted_df</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">iloc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;trust_score&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;\n&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;TLM Explanation: &quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> sorted_df</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">iloc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;explanation&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Which returns the following:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">Prompt:  You are a trivia master.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">What is the 3rd month of the year in alphabetical order?</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">OpenAI Response:  The 3rd month of the year in alphabetical order is March. The months in alphabetical order are:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">1. April</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">2. August</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">3. December</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">4. February</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">5. January</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">6. July</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">7. June</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">8. March</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">9. May</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">10. November</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">11. October</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">12. September</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">So, March is the 8th month, not the 3rd. The 3rd month in alphabetical order is February.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">TLM Trust Score:  0.04388514403195165</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">TLM Explanation:  The proposed response incorrectly identifies the 3rd month of the year in alphabetical order. The</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">months of the year, when arranged alphabetically, are as follows:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">1. April</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">2. August</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">3. December</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">4. February</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">5. January</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">6. July</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">7. June</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">8. March</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">9. May</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">10. November</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">11. October</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">12. September</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">In this list, February is indeed the 4th month, not the 3rd. The 3rd month in alphabetical order is actually</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">December. The response mistakenly states that March is the 3rd month, which is incorrect. Therefore, the answer to</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">the user&#x27;s request is that the 3rd month in alphabetical order is December, not February or March.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">This response is untrustworthy due to lack of consistency in possible responses from the model. Here&#x27;s one</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">inconsistent alternate response that the model considered (which may not be accurate either):</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">December.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Awesome! TLM was able to identify multiple traces that contained incorrect answers from OpenAI. In the example above, it correctly noted that the original response actually included <em>two</em> incorrect answers, making it both wrong and inconsistent.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Tracing TLM</div><div class="admonitionContent_BuS1"><p>You could also trace the TLM API call itself. This will log the trustworthiness scores and explanations for each trace. Here&#x27;s an example of how to do this by wrapping the TLM API call in a custom function and tracing it with the <code>@mlflow.trace</code> decorator.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># Tracing TLM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">@mlflow</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">trace</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">tlm_trustworthiness_wrapper</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">inputs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> predictions</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    tlm </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> TLM</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">options</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;log&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;explanation&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    evaluations </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> tlm</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get_trustworthiness_score</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">inputs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> predictions</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> evaluations</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">tlm_trustworthiness_wrapper</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">prompts</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> answers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<p>Now, let&#x27;s upload the <code>trust_score</code> and <code>explanation</code> columns to MLflow.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tag-traces-with-tlm-evaluations">Tag Traces with TLM Evaluations<a href="#tag-traces-with-tlm-evaluations" class="hash-link" aria-label="Direct link to Tag Traces with TLM Evaluations" title="Direct link to Tag Traces with TLM Evaluations">​</a></h3>
<p>We&#x27;ll use the <code>set_trace_tag()</code> function to save the TLM scores and explanations as tags on the traces.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> idx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> row </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> trace_evaluations</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">iterrows</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    request_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> row</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;request_id&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    trust_score </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> row</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;trust_score&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    explanation </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> row</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;explanation&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Add the trustworthiness score and explanation to the trace as a tag</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    client</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_trace_tag</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">request_id</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">request_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> key</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;trust_score&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> value</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">trust_score</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    client</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_trace_tag</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">request_id</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">request_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> key</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;explanation&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> value</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">explanation</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should now see the TLM trustworthiness score and explanation in the MLflow UI! From here you can continue collecting and evaluating traces.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-tlm-with-mlflow-evaluation">Using TLM with MLflow Evaluation<a href="#using-tlm-with-mlflow-evaluation" class="hash-link" aria-label="Direct link to Using TLM with MLflow Evaluation" title="Direct link to Using TLM with MLflow Evaluation">​</a></h2>
<p>MLflow Evaluation helps assess AI applications using built-in and custom metrics to score model outputs. Results, including scores and justifications, are logged and can be compared in the MLflow UI for systematic performance tracking. In this section, we will create a custom metric that uses TLM to evaluate the trustworthiness of LLM responses, providing a straightforward way to integrate TLM into your MLflow workflows.</p>
<p>Using MLflow Evaluation with our custom TLM metric will log a table of trustworthiness scores and explanations and also provide an interface in the UI for comparing scores across runs. For example, you could use this to compare the trustworthiness scores of different models across the same set of prompts.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> mlflow</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">metrics </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> MetricValue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> make_metric</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> cleanlab_tlm </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> TLM</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">_tlm_eval_fn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">predictions</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> inputs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> targets</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Evaluate trustworthiness using Cleanlab TLM.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Args:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        predictions: The model outputs/answers</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        targets: Not used for this metric</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        **kwargs: Should contain &#x27;inputs&#x27; with the prompts</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Initialize TLM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    tlm </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> TLM</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">options</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;log&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;explanation&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    inputs </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> inputs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">to_list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    predictions </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> predictions</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">to_list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Get trustworthiness scores</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    evaluations </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> tlm</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get_trustworthiness_score</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">inputs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> predictions</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Extract scores and explanations</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    scores </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token builtin" style="color:rgb(86, 156, 214)">float</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">eval_result</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;trustworthiness_score&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> eval_result </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> evaluations</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    justifications </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">eval_result</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;log&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;explanation&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> eval_result </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> evaluations</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Return metric value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> MetricValue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        scores</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">scores</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        justifications</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">justifications</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        aggregate_results</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;mean&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">sum</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">scores</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">len</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">scores</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;min&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">min</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">scores</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;max&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">max</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">scores</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">tlm_trustworthiness</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&quot;&quot;&quot;Creates a metric for evaluating trustworthiness using Cleanlab TLM&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> make_metric</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        eval_fn</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">_tlm_eval_fn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        greater_is_better</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;tlm_trustworthiness&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now that we have defined the custom metric, let&#x27;s use it to evaluate the trustworthiness of our LLM responses. We will use the same responses and prompts that we collected from our traces before.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">tlm_metric </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> tlm_trustworthiness</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">eval_df </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">DataFrame</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;inputs&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> prompts</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;outputs&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> responses</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">results </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">evaluate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    data</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">eval_df</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    predictions</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;outputs&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    extra_metrics</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">tlm_metric</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    evaluator_config</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;col_mapping&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;inputs&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;inputs&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;predictions&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;outputs&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now we can see the results in the MLflow Evaluation UI.</p>
<p><img loading="lazy" alt="MLflow Evaluation" src="/mlflow-website/assets/images/2_eval_ui-fb093c18e47d491a8c4a5c23721fc58f.png" width="3760" height="2304" class="img_ev3q"></p>
<p>This approach is especially useful once you start comparing scores across different models, prompts, or other criteria.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>In this post, we showed how to use Cleanlab&#x27;s TLM to evaluate the trustworthiness of LLM responses captured in MLflow. We demonstrated how to use TLM to generate trustworthiness scores and explanations for each trace, tag the traces with the scores and explanations, and use MLflow Evaluation to log and compare the scores across runs.</p>
<p>This approach provides a straightforward way to integrate TLM into your MLflow workflows for systematic performance tracking and debugging of AI applications. It also highlights a key use case for MLflow tracing: generating datasets for downstream tasks like evaluation.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mlflow-website/blog/tags/genai">genai</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mlflow-website/blog/tags/observability">observability</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mlflow-website/blog/tags/tracing">tracing</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="A practical guide to implementing AI tracing in your GenAI applications"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/mlflow-website/blog/ai-observability-mlflow-tracing">Practical AI Observability: Getting Started with MLflow Tracing</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-03-06T00:00:00.000Z" itemprop="datePublished">March 6, 2025</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/danielliden" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="/img/authors/daniel_liden.png" alt="Daniel Liden" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/danielliden" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Daniel Liden</span></a></div><small class="avatar__subtitle" itemprop="description">Developer Advocate at Databricks</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="mlflow-tracing-observability-for-genai">MLflow Tracing: Observability for GenAI<a href="#mlflow-tracing-observability-for-genai" class="hash-link" aria-label="Direct link to MLflow Tracing: Observability for GenAI" title="Direct link to MLflow Tracing: Observability for GenAI">​</a></h2>
<p>GenAI providers and frameworks often respond with complicated and hard-to-read data structures or with simple responses that hide intermediate steps. Furthermore, it can be hard to keep track of and compare GenAI model/framework calls over time, especially if you are moving between frameworks and scripts.</p>
<p><a href="https://mlflow.org/docs/latest/llms/tracing/index.html" target="_blank" rel="noopener noreferrer">MLflow&#x27;s LLM tracing</a> solves these issues by recording all of your GenAI calls, including both individual LLM calls and multi-step agentic workflows, and providing an easy-to-read interface for browsing and comparing them. You can enable this functionality for most GenAI providers with a single line of code: <code>mlflow.&lt;provider&gt;.autolog()</code>.</p>
<p>This blog will show how to get started with MLflow tracing—in about five minutes. It assumes some familiarity with GenAI APIs (e.g. the OpenAI API), but does not assume any prior familiarity with MLflow.</p>
<figure><img src="/img/blog/tracing-intro/05_langchain.png" alt="Alt text"><figcaption><i>Tracing a LangChain Application with MLflow Tracing</i></figcaption></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="quickstart">Quickstart<a href="#quickstart" class="hash-link" aria-label="Direct link to Quickstart" title="Direct link to Quickstart">​</a></h2>
<p>We&#x27;ll start by showing how to use MLflow autologging to automatically trace calls to OpenAI models, though MLflow supports automatic tracing for an <a href="https://mlflow.org/docs/latest/llms/tracing/index.html#automatic-tracing" target="_blank" rel="noopener noreferrer">ever-growing number of providers and frameworks</a> including Anthropic, Ollama, Langchain, LlamaIndex, and may others. To get started, install the MLflow and OpenAI Python packages with:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">pip install mlflow openai</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="collecting-traces-with-autologging">Collecting Traces with Autologging<a href="#collecting-traces-with-autologging" class="hash-link" aria-label="Direct link to Collecting Traces with Autologging" title="Direct link to Collecting Traces with Autologging">​</a></h3>
<p>In a Python script or notebook, import MLflow and the GenAI provider you&#x27;re working with, and enable tracing with <code>mlflow.&lt;provider&gt;.autolog</code>. Here&#x27;s how to set up automatic tracing for OpenAI:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> mlflow</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> openai </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> OpenAI</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">openai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">autolog</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Make sure to <a href="https://platform.openai.com/docs/quickstart?language=python#create-and-export-an-api-key" target="_blank" rel="noopener noreferrer">create and set your OpenAI API key</a>! You can set it in your environment with</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">export OPENAI_API_KEY=&quot;your_api_key_here&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now, when you use the OpenAI library, MLflow will capture <em>traces</em> of your model calls. For example, MLflow will log a trace of the following OpenAI invocation because we have enabled autologging.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">client </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> OpenAI</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">completion </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">chat</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">completions</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">create</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;gpt-4o-mini&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    messages</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;role&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;system&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;You are a helpful assistant.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;role&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;user&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;What is an MLflow tracking server?&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="viewing-your-llm-traces">Viewing your LLM Traces<a href="#viewing-your-llm-traces" class="hash-link" aria-label="Direct link to Viewing your LLM Traces" title="Direct link to Viewing your LLM Traces">​</a></h3>
<p>The MLflow UI provides an AI observability dashboard for viewing your traces. Start the MLflow UI from your terminal with:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">mlflow ui</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Navigate to the UI. the output of the <code>mlflow ui</code> command will tell you where to go (<code>http://localhost:5000</code> by default). In the UI, navigate to the &quot;Traces&quot; tab. This will list all of the collected traces. Click on a trace&#x27;s Trace ID to open up a new pane with more details.</p>
<p><img loading="lazy" alt="Traces in the MLflow UI" src="/mlflow-website/assets/images/01_tracing_ui-8e76a8ca87a7fe97bf0131dafe98b57d.gif" width="1280" height="738" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>By default, the MLflow server will listen on <code>http://localhost:5000</code>. You can choose a different port with <code>mlflow ui -p &lt;port&gt;</code>. For example, to listen on port 5001, use <code>mlflow ui -p 5001</code>.</p></div></div>
<p>Starting the MLflow tracking server with <code>mlflow ui</code> also enables you to <a href="https://mlflow.org/blog/mlflow-tracing-in-jupyter" target="_blank" rel="noopener noreferrer">view traces right in a Jupyter notebook</a>! You just have to set the tracking uri to the location specified above:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_tracking_uri</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;http://localhost:5000&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then, when you invoke an AI model/framework with tracing enabled, the generated trace(s) will appear right in the notebook outputs.</p>
<p><img loading="lazy" alt="Tracing in Jupyter Notebooks" src="/mlflow-website/assets/images/02_jupyter-5d2a220fed5d83148404a27d50b2c3af.gif" width="1280" height="746" class="img_ev3q"></p>
<p>You can disable this functionality with <code>mlflow.tracing.disable_notebook_display()</code>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="organizing-your-traces">Organizing your Traces<a href="#organizing-your-traces" class="hash-link" aria-label="Direct link to Organizing your Traces" title="Direct link to Organizing your Traces">​</a></h2>
<p>If you use tracing across multiple different projects and tasks, you might want to organize the traces into separate groups.</p>
<p>The easiest way to organize your traces is to separate them into <a href="https://mlflow.org/docs/latest/tracking.html#experiments" target="_blank" rel="noopener noreferrer"><em>experiments</em></a>. Each experiment has its own traces tab, which displays the traces for that experiment.</p>
<p>You can create an experiment in the UI (With the &quot;+&quot; button next to &quot;Experiments&quot;), with the MLflow CLI, or with Python. Let&#x27;s create a new experiment called &quot;Quickstart&quot; and log a trace.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_experiment</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;quickstart&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">completion </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">chat</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">completions</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">create</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;gpt-4o-mini&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    messages</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;role&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;system&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;You are a helpful assistant.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;role&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;user&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;What is an MLflow tracking server?&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We can now find this trace in the &quot;Traces&quot; tab in the &quot;quickstart&quot; experiment.</p>
<p><img loading="lazy" alt="Trace in Experiment" src="/mlflow-website/assets/images/03_experiment-bc7a7c3bfd2722df1c738a478d29b1a1.png" width="2444" height="1438" class="img_ev3q"></p>
<p>The <code>set_experiment</code> function specifies which experiment traces should be logged to, creating it if it does not exist, so the code snippet above created a new &quot;quickstart&quot; experiment.</p>
<p>You can also organize your traces with <a href="https://mlflow.org/docs/latest/tracing#trace-tags" target="_blank" rel="noopener noreferrer">tags</a> and <a href="https://mlflow.org/docs/latest/tracing#q-how-can-i-associate-a-trace-with-an-mlflow-run" target="_blank" rel="noopener noreferrer">runs</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="tracing-other-providers">Tracing Other Providers<a href="#tracing-other-providers" class="hash-link" aria-label="Direct link to Tracing Other Providers" title="Direct link to Tracing Other Providers">​</a></h2>
<p>Our quickstart example focused on OpenAI, but MLflow supports automatic tracing of <a href="https://mlflow.org/docs/latest/tracing#automatic-tracing" target="_blank" rel="noopener noreferrer">many different AI providers and frameworks</a>. The approach is the same: just add the line <code>mlflow.&lt;provider&gt;.autolog</code> to your notebook or script.</p>
<p>Here are a few examples. See <a href="https://mlflow.org/docs/latest/tracing#automatic-tracing" target="_blank" rel="noopener noreferrer">here</a> for the full list of supported providers.</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">Anthropic</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">LangChain</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Ollama</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><p>Enable automatic tracing for Anthropic model calls with <code>mlflow.anthropic.autolog()</code>.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> anthropic</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> mlflow</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">anthropic</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">autolog</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">client </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> anthropic</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Anthropic</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">message </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">create</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;claude-3-7-sonnet-20250219&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    max_tokens</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">1000</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    temperature</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    messages</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;role&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;user&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;What is an MLflow tracking server?&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This returns the following in the MLflow UI:</p><p><img loading="lazy" alt="Anthropic tracing" src="/mlflow-website/assets/images/04_anthropic-6794542fdcd30d9d698a3b6ea186855a.png" width="2516" height="1936" class="img_ev3q"></p></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><p>Enable automatic tracing for LangChain and LangGraph with <code>mlflow.langchain.autolog()</code>. MLflow automatic tracing captures all LangChain component executions, including chains, LLMs, agents, tools, prompts, and retrievers.</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> mlflow</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> langchain</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">prompts </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> PromptTemplate</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> langchain_core</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">output_parsers </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> StrOutputParser</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> langchain_openai </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> ChatOpenAI</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_experiment</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;quickstart&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">langchain</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">autolog</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">llm </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ChatOpenAI</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;gpt-4o-mini&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> temperature</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> max_tokens</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">500</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">prompt_template </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> PromptTemplate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">from_template</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Explain the following MLflow concept at the specified technical level. &quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;For &#x27;beginner&#x27;, use simple analogies and avoid complex terms. &quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;For &#x27;intermediate&#x27;, include more technical details and some code examples. &quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;For &#x27;advanced&#x27;, go deep into implementation details and provide comprehensive explanations. &quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Technical level: {level}. Question: {question}&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">chain </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> prompt_template </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"> llm </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"> StrOutputParser</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">chain</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">invoke</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;level&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;beginner&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;question&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;How do MLflow tracking servers help with experiment management?&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This example LangChain chain includes multiple components:</p><ul>
<li>The <code>PromptTemplate</code>, which assembles the prompt based on the user input</li>
<li>The <code>ChatOpenAI</code> model, which is used to call the OpenAI <code>gpt-4o-mini</code> model</li>
<li>The <code>StrOutputParser</code>, which returns the final answer to the user&#x27;s query as a string</li>
</ul><p>We can see each of these components in the MLflow UI, nested under the parent <code>RunnableSequence</code> chain.</p><p><img loading="lazy" alt="LangChain Tracing" src="/mlflow-website/assets/images/05_langchain-1dfddf4fb18ed0a80bf6b419fca3532f.png" width="2738" height="2078" class="img_ev3q"></p></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><p><a href="https://ollama.com/" target="_blank" rel="noopener noreferrer">Ollama</a> is a tool for running open source AI models locally. You can enable automatic tracing of Ollama models via Ollama&#x27;s <a href="https://github.com/ollama/ollama/blob/main/docs/openai.md" target="_blank" rel="noopener noreferrer">OpenAI-compatible API</a> and MLflow&#x27;s OpenAI autologging. You just need to set the base URL to your Ollama REST endpoint.</p><p>This pattern should work with any provider that offers an OpenAI-compatible endpoint, even those that are not explicitly referenced in the docs.</p><p>Here&#x27;s how it works for Ollama:</p><ol>
<li>First, run the Ollama server with your desired model.</li>
</ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">ollama run phi3:latest</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2">
<li>Configure the OpenAI client, setting the <code>base_url</code> to the Ollama OpenAI-compatible endpoint.</li>
</ol><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> openai </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> OpenAI</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">client </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> OpenAI</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    base_url</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;http://localhost:11434/v1&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># The local Ollama REST endpoint</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    api_key</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;dummy&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Required to instantiate OpenAI client, it can be a random string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="3">
<li>Enable MLflow OpenAI autologging and query the model</li>
</ol><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">openai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">autolog</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">completion </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">chat</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">completions</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">create</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;phi3:latest&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    messages</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;role&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;system&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;You are a helpful assistant.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;role&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;user&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;What is an MLflow tracking server?&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Here is the trace of the Ollama model call in the MLflow UI.</p><p><img loading="lazy" alt="Ollama Tracing" src="/mlflow-website/assets/images/06_ollama-8e0d6bf2dac8ef784677e50d09a3fa19.png" width="2738" height="2078" class="img_ev3q"></p></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion-effective-llm-tracing-with-one-line-of-code">Conclusion: Effective LLM tracing with one line of code<a href="#conclusion-effective-llm-tracing-with-one-line-of-code" class="hash-link" aria-label="Direct link to Conclusion: Effective LLM tracing with one line of code" title="Direct link to Conclusion: Effective LLM tracing with one line of code">​</a></h2>
<p>In this guide, you have learned how to use MLflow&#x27;s autologging capabilities to get a complete AI observability solution with a single line of code. If you are using one of the <a href="https://mlflow.org/docs/latest/tracing#automatic-tracing" target="_blank" rel="noopener noreferrer">many GenAI frameworks/providers</a> for which MLflow offers automatic tracing—including any providers with OpenAI-compatible endpoints—automatic logging is the easiest way to visualize and debug your AI application behavior. All you need is <code>mlflow.&lt;provider&gt;.autolog()</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="next-steps">Next Steps<a href="#next-steps" class="hash-link" aria-label="Direct link to Next Steps" title="Direct link to Next Steps">​</a></h3>
<p>Autologging is a great place to start with MLflow tracing, but you may need more flexibility in how you collect and use traces as you develop more complex GenAI applications. Furthermore, MLflow includes many tools for working with GenAI applications beyond tracing.</p>
<ul>
<li>For a longer conceptual introduction to tracing, read <a href="https://mlflow.org/docs/latest/tracing/" target="_blank" rel="noopener noreferrer">this guide</a> on tracing concepts.</li>
<li>MLflow traces can provide an excellent source of data for evaluation, SME review, fine-tuning, and more. Learn about searching and retrieving trace data <a href="https://mlflow.org/docs/latest/tracing/api/search" target="_blank" rel="noopener noreferrer">here</a>.</li>
<li>MLflow provides <a href="https://mlflow.org/docs/latest/llms/llm-evaluate/index.html" target="_blank" rel="noopener noreferrer">LLM evaluation functionality</a> for running structured experiments with your AI models and applications.</li>
<li>You can add tracing to your own AI applications with the tracing <a href="https://mlflow.org/docs/latest/tracing/api/manual-instrumentation" target="_blank" rel="noopener noreferrer">fluent APIs</a> and <a href="https://mlflow.org/docs/latest/tracing/api/client" target="_blank" rel="noopener noreferrer">client APIs</a>. You can also <a href="https://mlflow.org/blog/custom-tracing" target="_blank" rel="noopener noreferrer">add tracing to libraries and frameworks</a> that do not (yet) have autologging support.</li>
</ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mlflow-website/blog/tags/genai">genai</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mlflow-website/blog/tags/observability">observability</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mlflow-website/blog/tags/tracing">tracing</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="In this post, we will show how to add MLflow Tracing to a new LLM provider by adding tracing support to the chat method of the Ollama Python SDK."><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/mlflow-website/blog/custom-tracing">Beyond Autolog: Add MLflow Tracing to a New LLM Provider</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-01-30T00:00:00.000Z" itemprop="datePublished">January 30, 2025</time> · <!-- -->17 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/danielliden" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="/img/authors/daniel_liden.png" alt="Daniel Liden" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/danielliden" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Daniel Liden</span></a></div><small class="avatar__subtitle" itemprop="description">Developer Advocate at Databricks</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>In this post, we will show how to add MLflow Tracing to a new LLM provider by adding tracing support to the <code>chat</code> method of the Ollama Python SDK.</p>
<p><a href="https://mlflow.org/docs/latest/llms/tracing/index.html" target="_blank" rel="noopener noreferrer">MLflow Tracing</a> is an observability tool in MLflow that captures detailed execution traces for GenAI applications and workflows. In addition to inputs, outputs, and metadata for individual calls, MLflow tracing can also capture intermediate steps such as tool calls, reasoning steps, retrieval steps, or other custom steps.</p>
<p>MLflow provides <a href="https://mlflow.org/docs/latest/llms/tracing/index.html#automatic-tracing" target="_blank" rel="noopener noreferrer">built-in Tracing support</a> for many popular LLM providers and orchestration frameworks. If you are using one of these providers, you can enable tracing with a single line of code: <code>mlflow.&lt;provider&gt;.autolog()</code>. While MLflow&#x27;s autologging capabilities cover many of the most widely-used LLM providers and orchestration frameworks, there may be times when you need to add tracing to an unsupported provider or customize tracing beyond what autologging provides. This post demonstrates how flexible and extensible MLflow Tracing can be by:</p>
<ul>
<li>Adding basic tracing support to an unsupported provider (the Ollama Python SDK)</li>
<li>Showing how to capture both simple completions and more complex tool-calling workflows</li>
<li>Illustrating how tracing can be added with minimal changes to existing code</li>
</ul>
<p>We&#x27;ll use <a href="https://github.com/ollama/ollama-python" target="_blank" rel="noopener noreferrer">the Ollama Python SDK</a>, an open-source Python SDK for the <a href="https://ollama.ai/" target="_blank" rel="noopener noreferrer">Ollama</a> LLM platform, as our example. We&#x27;ll work through the process step-by-step, showing how to capture the key information with MLflow tracing while maintaining a clean integration with the provider&#x27;s SDK. Note that MLflow <em>does</em> have autologging support for Ollama, but currently only for use via the OpenAI client, not directly with the Ollama Python SDK.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="adding-mlflow-tracing-to-a-new-provider-general-principles">Adding MLflow Tracing to a New Provider: General Principles<a href="#adding-mlflow-tracing-to-a-new-provider-general-principles" class="hash-link" aria-label="Direct link to Adding MLflow Tracing to a New Provider: General Principles" title="Direct link to Adding MLflow Tracing to a New Provider: General Principles">​</a></h2>
<p>The MLflow docs have an <a href="https://mlflow.org/docs/latest/llms/tracing/contribute.html" target="_blank" rel="noopener noreferrer">excellent guide</a> to contributing to MLflow tracing. Though we will not be contributing to MLflow itself in this example, we will follow the same general principles.</p>
<p>This post assumes that you have a basic understanding of what MLflow Tracing is and how it works. If you are just learning, or you need a refresher, take a look at the <a href="https://mlflow.org/docs/latest/llms/tracing/overview.html" target="_blank" rel="noopener noreferrer">Tracing Concepts</a> guide.</p>
<p>Adding tracing to a new provider involves a few key considerations:</p>
<ol>
<li>
<p><strong>Understand the Provider&#x27;s key functionality:</strong> We first need to understand what API methods need to be traced in order to get the tracing information we want. For LLM inference providers, this typically involves operations such as chat completions, tool calls, or embedding generation. In orchestration frameworks, this may involve operations such as retrieval, reasoning, routing, or any of a wide range of custom steps. In our Ollama example, we will focus on the chat completions API. This step will vary significantly depending on the provider.</p>
</li>
<li>
<p><strong>Map operations to spans:</strong> MLflow tracing uses different <em>span types</em> to represent different types of operations. You can find descriptions of built-in span types <a href="https://mlflow.org/docs/latest/llms/tracing/index.html#span-type" target="_blank" rel="noopener noreferrer">here</a>. Different span types are displayed differently in the MLflow UI and can enable specific functionality. Within spans, we also want to map the provider&#x27;s inputs and outputs to the formats expected by MLflow. MLflow offers utilities for recording chat and tool inputs and outputs, which are then displayed as formatted messages in the MLflow UI.</p>
<p><img loading="lazy" alt="Chat Messages" src="/mlflow-website/assets/images/1_chat_type-31c3db50724a332d9bd61791e84338f7.png" width="1384" height="1106" class="img_ev3q"></p>
<p>When adding tracing to a new provider, our main task is to map the provider&#x27;s API methods to MLflow Tracing spans with appropriate span types.</p>
</li>
<li>
<p><strong>Structure and preserve key data:</strong> For each operation we want to trace, we need to identify the key information we want to preserve and make sure it is captured and displayed in a useful way. For example, we may want to capture the input and configuration data that control the operation&#x27;s behavior, the outputs and metadata that explain the results, errors that terminated the operation prematurely, etc. Looking at traces and tracing implementations for similar providers can provide a good starting point for how to structure and preserve these data.</p>
</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="adding-tracing-to-the-ollama-python-sdk">Adding tracing to the Ollama Python SDK<a href="#adding-tracing-to-the-ollama-python-sdk" class="hash-link" aria-label="Direct link to Adding tracing to the Ollama Python SDK" title="Direct link to Adding tracing to the Ollama Python SDK">​</a></h2>
<p>Now that we have a high-level understanding of the key step of adding tracing to a new provider, let&#x27;s work through the process and add tracing to the Ollama Python SDK.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-1-install-and-test-the-ollama-python-sdk">Step 1: Install and Test the Ollama Python SDK<a href="#step-1-install-and-test-the-ollama-python-sdk" class="hash-link" aria-label="Direct link to Step 1: Install and Test the Ollama Python SDK" title="Direct link to Step 1: Install and Test the Ollama Python SDK">​</a></h3>
<p>First, we need to install the Ollama Python SDK and figure out what methods we need to pay attention to when adding tracing support. You can install the Ollama Python SDK with <code>pip install ollama-python</code>.</p>
<p>If you have used the OpenAI Python SDK, the Ollama Python SDK will feel quite familiar. Here&#x27;s how we use it to make a chat completion call:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> ollama </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> chat</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> rich </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> chat</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;llama3.2&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     messages </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">         </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;role&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;user&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Briefly describe the components of an MLflow model&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Which will return:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">ChatResponse</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;llama3.2&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    created_at</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;2025-01-30T15:57:39.097119Z&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    done</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    done_reason</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;stop&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    total_duration</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">7687553708</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    load_duration</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">823704250</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    prompt_eval_count</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">35</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    prompt_eval_duration</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">3414000000</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    eval_count</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">215</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    eval_duration</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">3447000000</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    message</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">Message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        role</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;assistant&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        content</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">&quot;In MLflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> a model consists of several key components</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain">\n\n1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token plain">Model Registry</span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> A centralized</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">storage </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> models</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> containing metadata such </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> the model&#x27;s name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> version</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">and</span><span class="token plain"> description</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">\n2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token plain">Model Version</span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">A specific iteration of a model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> represented by a unique version number</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"> This can be thought of </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> a snapshot of</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">the model at a particular point </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> time</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">\n3</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token plain">Model Artifacts</span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> The actual model code</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> parameters</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">and</span><span class="token plain"> data used</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">to train the model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"> These artifacts are stored </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> the Model Registry </span><span class="token keyword" style="color:rgb(86, 156, 214)">and</span><span class="token plain"> can be easily deployed </span><span class="token keyword" style="color:rgb(86, 156, 214)">or</span><span class="token plain"> reused</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">\n4</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token plain">Experiment</span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> A collection of runs that use the same hyperparameters </span><span class="token keyword" style="color:rgb(86, 156, 214)">and</span><span class="token plain"> model version to train </span><span class="token keyword" style="color:rgb(86, 156, 214)">and</span><span class="token plain"> evaluate a</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"> Experiments </span><span class="token builtin" style="color:rgb(86, 156, 214)">help</span><span class="token plain"> track progress</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> provide reproducibility</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">and</span><span class="token plain"> facilitate collaboration</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">\n5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token plain">Run</span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> An</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">individual instance of training </span><span class="token keyword" style="color:rgb(86, 156, 214)">or</span><span class="token plain"> testing a model using a specific experiment</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"> Runs capture the output of each</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">run</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> including metrics such </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> accuracy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> loss</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">and</span><span class="token plain"> more</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">\n\nThese components work together to enable efficient</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">model management</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> version control</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">and</span><span class="token plain"> reproducibility </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> machine learning workflows</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        images</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        tool_calls</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We have verified that the Ollama Python SDK is set up and working. We also know what method we need to focus on when adding tracing support: <code>ollama.chat</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-2-write-a-tracing-decorator">Step 2: Write a Tracing Decorator<a href="#step-2-write-a-tracing-decorator" class="hash-link" aria-label="Direct link to Step 2: Write a Tracing Decorator" title="Direct link to Step 2: Write a Tracing Decorator">​</a></h3>
<p>There are several ways we could add tracing to Ollama&#x27;s SDK—we could modify the SDK code directly, create a wrapper class, or use Python&#x27;s method patching capabilities. For this example, we&#x27;ll use a decorator to patch the SDK&#x27;s <code>chat</code> method. This approach lets us add tracing without modifying the SDK code or creating additional wrapper classes, though it does require understanding both Python&#x27;s decorator pattern and how MLflow tracing works.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> mlflow</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">entities </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> SpanType</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tracing</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">utils </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> set_span_chat_messages</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> functools </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> wraps</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> ollama </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> chat </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> ollama_chat</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">_get_span_type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">task_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    span_type_mapping </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;chat&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> SpanType</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">CHAT_MODEL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> span_type_mapping</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">task_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> SpanType</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">UNKNOWN</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">trace_ollama_chat</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">func</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">@wraps</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">func</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">wrapper</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">args</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token plain">kwargs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">with</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">start_span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;ollama.chat&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            span_type</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">_get_span_type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;chat&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Set model name as a span attribute</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            model_name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> kwargs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;model&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_attribute</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;model_name&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> model_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Log the inputs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            input_messages </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> kwargs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;messages&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_inputs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;messages&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> input_messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;model&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> model_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Set input messages</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            set_span_chat_messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> input_messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Make the API call</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> func</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">args</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token plain">kwargs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Log the outputs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">hasattr</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;to_dict&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                output </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">to_dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                output </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> response</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_outputs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">output</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            output_message </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">message</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Append the output message</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            set_span_chat_messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;role&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> output_message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">role</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> output_message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">content</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> append</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> response</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> wrapper</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Let&#x27;s break down the code and see how it works.</p>
<ol>
<li>
<p>We start by defining a helper function, <code>_get_span_type</code>, that maps Ollama methods to MLflow span types. This isn&#x27;t strictly necessary as we are currently only tracing the <code>chat</code> function, but it shows a pattern that could be applied to other methods. This follows the reference implementation for the <a href="https://github.com/mlflow/mlflow/blob/master/mlflow/anthropic/autolog.py" target="_blank" rel="noopener noreferrer">Anthropic provider</a>, as recommended in the tracing contribution guide.</p>
</li>
<li>
<p>We define a decorator, <code>trace_ollama_chat</code>, using <a href="https://docs.python.org/3/library/functools.html#functools.wraps" target="_blank" rel="noopener noreferrer"><code>functools.wraps</code></a>, that patches the <code>chat</code> function. There are a few key steps here:</p>
<ol>
<li>
<p>We start a new span with <code>mlflow.start_span</code>. The span name is set to &quot;ollama.chat&quot; and the span type is set to the value returned by <code>_get_span_type</code>.</p>
</li>
<li>
<p>We set <code>model_name</code> as an attribute on the span with <code>span.set_attribute</code>. This isn&#x27;t strictly necessary as model name will be captured in the inputs, but it illustrates how to set arbitrary attributes on a span.</p>
</li>
<li>
<p>We log the messages as inputs to the span with <code>span.set_inputs</code>. We get these from the <code>messages</code> argument by accessing the <code>kwargs</code> dictionary. These messages will be logged to the &quot;inputs&quot; section of the span in the MLflow UI. We also log the model name as an input, again to illustrate how to record arbitrary inputs.</p>
<p><img loading="lazy" alt="Inputs" src="/mlflow-website/assets/images/2_log_inputs-10584fdd103f701729749620de7d5f20.png" width="1446" height="792" class="img_ev3q"></p>
</li>
<li>
<p>We use MLflow&#x27;s <code>set_span_chat_messages</code> utility function to format the input messages in a way that will be displayed nicely in the MLflow UI&#x27;s Chat panel. This helper ensures that the messages are properly formatted and displayed with appropriate styling for each message role.</p>
</li>
<li>
<p>We call the original function with <code>func(*args, **kwargs)</code>. This is the Ollama <code>chat</code> function.</p>
</li>
<li>
<p>We log the outputs of the function as a span attribute with <code>span.set_outputs</code>. This takes the response from the Ollama API and sets it as an attribute on the span. These outputs will be logged to the &quot;outputs&quot; section of the span in the MLflow UI.</p>
<p><img loading="lazy" alt="Outputs" src="/mlflow-website/assets/images/3_log_outputs-653a54208f3f6c1e5ffc1efac431fa99.png" width="1434" height="1294" class="img_ev3q"></p>
</li>
<li>
<p>We extract the output message from the response and use <code>set_span_chat_messages</code> again to append it to the chat history, ensuring it appears in the Chat panel of the MLflow UI.</p>
<p><img loading="lazy" alt="Messages Panel" src="/mlflow-website/assets/images/4_chat_panel-33af7b0d1baf67d6c7767d7d12ac07a0.png" width="1434" height="860" class="img_ev3q"></p>
</li>
<li>
<p>Finally, we return the response from the API call, without any changes. Now, when we patch the chat function with <code>trace_ollama_chat</code>, the function will be traced, but will otherwise behave as normal.</p>
</li>
</ol>
</li>
</ol>
<p>A few points to note:</p>
<ul>
<li>This implementation uses a simple decorator pattern that adds tracing without modifying the underlying Ollama SDK code. This makes it a lightweight and maintainable approach.</li>
<li>The use of <code>set_span_chat_messages</code> ensures that both input and output messages are displayed in a user-friendly way in the MLflow UI&#x27;s Chat panel, making it easy to follow the conversation flow.</li>
<li>There are several other ways we could have implemented this tracing behavior. We could have written a wrapper class or used a simple wrapper function that decorates the <code>chat</code> function with <code>@mlflow.trace</code>. Some orchestration frameworks may require a more complex approach, such as callbacks or API hooks. See the <a href="https://mlflow.org/docs/latest/llms/tracing/contribute.html" target="_blank" rel="noopener noreferrer">MLflow Tracing Contribution Guide</a> for more details.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-3-patch-the-chat-method-and-try-it-out">Step 3: Patch the <code>chat</code> method and try it out<a href="#step-3-patch-the-chat-method-and-try-it-out" class="hash-link" aria-label="Direct link to step-3-patch-the-chat-method-and-try-it-out" title="Direct link to step-3-patch-the-chat-method-and-try-it-out">​</a></h3>
<p>Now that we have a tracing decorator, we can patch Ollama&#x27;s <code>chat</code> method and try it out.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">original_chat </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ollama_chat</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">chat </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> trace_ollama_chat</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ollama_chat</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This code effectively patches the <code>ollama.chat</code> function in the current scope. We first store the original function in <code>original_chat</code> for safekeeping, then reassign <code>chat</code> to the decorated version. This means that any subsequent calls to <code>chat()</code> in our code will use the traced version, while still preserving the original functionality.</p>
<p>Now, when we call <code>chat()</code>, the method will be traced and the results will be logged to the MLflow UI:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_experiment</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;ollama-tracing&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> chat</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;llama3.2&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     messages </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">         </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;role&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;user&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Briefly describe the components of an MLflow model&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img loading="lazy" alt="Tracing results" src="/mlflow-website/assets/images/5_trace_results-f6a33f3cc529287c67ac845ab6d4d278.png" width="2468" height="1844" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="tracing-tools-and-tool-calls">Tracing Tools and Tool Calls<a href="#tracing-tools-and-tool-calls" class="hash-link" aria-label="Direct link to Tracing Tools and Tool Calls" title="Direct link to Tracing Tools and Tool Calls">​</a></h2>
<p>The Ollama Python SDK supports tool calls. We want to record two main things:</p>
<ol>
<li>The tools that are available to the LLM</li>
<li>The actual tool calls, including the specific tool and the arguments passed to it.</li>
</ol>
<p>Note that a &quot;tool call&quot; refers to the LLM&#x27;s specification of which tool to use and what arguments to pass to it—not the actual execution of that tool. When an LLM makes a tool call, it&#x27;s essentially saying &quot;this tool should be run with these parameters&quot; rather than running the tool itself. The actual execution of the tool happens separately, typically in the application code.</p>
<p>Here is an updated version of the tracing code, patching the Ollama chat method, that records the available tools and captures tool calls:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">entities </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> SpanType</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tracing</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">utils </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> set_span_chat_messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> set_span_chat_tools</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> functools </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> wraps</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> ollama </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> chat </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> ollama_chat</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> json</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> uuid </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> uuid4</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">_get_span_type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">task_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    span_type_mapping </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;chat&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> SpanType</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">CHAT_MODEL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> span_type_mapping</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">task_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> SpanType</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">UNKNOWN</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">trace_ollama_chat</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">func</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">@wraps</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">func</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">wrapper</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">args</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token plain">kwargs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">with</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">start_span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;ollama.chat&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            span_type</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">_get_span_type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;chat&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Set model name as a span attribute</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            model_name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> kwargs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;model&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_attribute</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;model_name&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> model_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Log the inputs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            input_messages </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> kwargs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;messages&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            tools </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> kwargs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;tools&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_inputs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;messages&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> input_messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;model&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> model_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;tools&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> tools</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Set input messages and tools</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            set_span_chat_messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> input_messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> tools</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                set_span_chat_tools</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> tools</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Make the API call</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> func</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">args</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token plain">kwargs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Log the outputs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">hasattr</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;to_dict&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                output </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">to_dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                output </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> response</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_outputs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">output</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            output_message </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">message</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Prepare the output message for span</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            output_span_message </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;role&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> output_message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">role</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> output_message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">content</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Handle tool calls if present</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> output_message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tool_calls</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                tool_calls </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> tool_call </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> output_message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tool_calls</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    tool_calls</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;id&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">uuid4</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;type&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;function&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;function&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;name&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> tool_call</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">function</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;arguments&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> json</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">dumps</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">tool_call</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">function</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">arguments</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                output_span_message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;tool_calls&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> tool_calls</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Append the output message</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            set_span_chat_messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">output_span_message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> append</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> response</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> wrapper</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The key changes here are:</p>
<ul>
<li>We extracted the list of available tools from the <code>tools</code> argument with <code>tools = kwargs.get(&quot;tools&quot;, [])</code>, logged them as inputs, and use <code>set_span_chat_tools</code> to capture them for inclusion in the Chat panel.</li>
<li>We added a specific handling for tool calls in the output message, making sure to format them according to the <a href="https://mlflow.org/docs/latest/python_api/mlflow.types.html#mlflow.types.llm.ToolCall" target="_blank" rel="noopener noreferrer">ToolCall</a> specification.</li>
</ul>
<p>Now let&#x27;s test this with a simple tip calculation tool. Tools are defined according to the <a href="https://platform.openai.com/docs/guides/function-calling#defining-functions" target="_blank" rel="noopener noreferrer">OpenAI specification</a> for tool calls.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">chat </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> trace_ollama_chat</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ollama_chat</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">tools </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;type&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;function&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;function&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;name&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;calculate_tip&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;description&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Calculate the tip amount based on the bill amount and tip percentage&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;parameters&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;type&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;object&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;properties&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;bill_amount&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;type&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;number&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;description&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;The total bill amount&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;tip_percentage&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;type&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;number&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;description&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;The percentage of the bill to be given as a tip, given as a whole number.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;required&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;bill_amount&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;tip_percentage&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> chat</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;llama3.2&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    messages</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;role&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;user&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;What is the tip for a $187.32 bill with a 22% tip?&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    tools</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">tools</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We can inspect the trace in the MLflow UI, now with both the available tools and the tool call results displayed:</p>
<p><img loading="lazy" alt="Tool Call Results" src="/mlflow-website/assets/images/6_tool_call-292eaae4c2bcc07d0215b3bcdc349714.png" width="2024" height="2236" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="orchestration-building-a-tool-calling-loop">Orchestration: Building a tool calling loop<a href="#orchestration-building-a-tool-calling-loop" class="hash-link" aria-label="Direct link to Orchestration: Building a tool calling loop" title="Direct link to Orchestration: Building a tool calling loop">​</a></h2>
<p>So far, the Ollama example just generates a single span whenever a chat completion is made. But many GenAI applications include multiple LLM calls, retrieval steps, tool executions, and other custom steps. While we won&#x27;t go into detail on adding tracing to orchestration frameworks here, we will illustrate some of the key concepts by defining a tool calling loop based on the tool we defined earlier.</p>
<p>The tool calling loop will follow this pattern:</p>
<ol>
<li>Take user prompt as input</li>
<li>Respond with a tool call or calls</li>
<li>For each tool call, execute the tool and store the results</li>
<li>Append the tool call results to the message history with the <code>tool</code> role</li>
<li>Call the LLM again with the tool call results, prompting it for a final answer to the user&#x27;s prompt</li>
</ol>
<p>Here&#x27;s an implementation with just one tool call.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">ToolExecutor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">__init__</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tools </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;type&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;function&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;function&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;name&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;calculate_tip&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;description&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Calculate the tip amount based on the bill amount and tip percentage&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;parameters&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;type&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;object&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;properties&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;bill_amount&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;type&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;number&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;description&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;The total bill amount&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;tip_percentage&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;type&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;number&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;description&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;The percentage of the bill to be given as a tip, represented as a whole number.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;required&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;bill_amount&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;tip_percentage&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Map tool names to their Python implementations</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tool_implementations </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;calculate_tip&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_calculate_tip</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">_calculate_tip</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> bill_amount</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">float</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> tip_percentage</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">float</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">float</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&quot;&quot;&quot;Calculate the tip amount based on the bill amount and tip percentage.&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        bill_amount </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">float</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">bill_amount</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        tip_percentage </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">float</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">tip_percentage</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">round</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">bill_amount </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">tip_percentage </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">100</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">execute_tool_calling_loop</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&quot;&quot;&quot;Execute a complete tool calling loop with tracing.&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">with</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">start_span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;ToolCallingLoop&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            span_type</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;CHAIN&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> parent_span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Set initial inputs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            parent_span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_inputs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;initial_messages&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;available_tools&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tools</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Set input messages</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            set_span_chat_messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">parent_span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># First LLM call (already traced by our chat method patch)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> chat</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                messages</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;llama3.2&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                tools</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tools</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            tool_calls </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tool_calls</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            tool_results </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Execute tool calls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> tool_call </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> tool_calls</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">with</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">start_span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f&quot;ToolExecution_</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">tool_call</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-interpolation interpolation">function</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-interpolation interpolation">name</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    span_type</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;TOOL&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> tool_span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Parse tool inputs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    tool_inputs </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> tool_call</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">function</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">arguments</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    tool_span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_inputs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">tool_inputs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Execute tool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    func </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tool_implementations</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">tool_call</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">function</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> func </span><span class="token keyword" style="color:rgb(86, 156, 214)">is</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token keyword" style="color:rgb(86, 156, 214)">raise</span><span class="token plain"> ValueError</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f&quot;No implementation for tool: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">tool_call</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-interpolation interpolation">function</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-interpolation interpolation">name</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    result </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> func</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token plain">tool_inputs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    tool_span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_outputs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;result&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> result</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    tool_results</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;tool_call_id&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">uuid4</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;output&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">result</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;role&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;tool&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;tool_call_id&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">uuid4</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">result</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Prepare messages for final response</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;role&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;user&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Answer the initial question based on the tool call results. Do not refer to the tool call results in your response. Just give a direct answer.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Final LLM call (already traced by our chat method patch)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            final_response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> chat</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                messages</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;llama3.2&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Set the final output for the parent span</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            parent_span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_outputs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;final_response&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> final_response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">content</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;tool_results&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> tool_results</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">final_response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># set output messages</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            set_span_chat_messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">parent_span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">final_response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">model_dump</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> append</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> final_response</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here&#x27;s how we handled tracing in this tool calling loop:</p>
<ol>
<li>We first set up a parent span for the tool calling loop with <code>mlflow.start_span</code>. We set the span name to &quot;ToolCallingLoop&quot; and the span type to &quot;CHAIN&quot;, representing a chain of operations.</li>
<li>We record the initial messages and available tools as inputs to the span. This could be helpful for future debugging by allowing us to verify that tools are made available and configured correctly.</li>
<li>We make the first LLM call with our patched <code>chat</code> function. This call is already traced by our decorator, so we don&#x27;t need to do anything special to trace it.</li>
<li>We iterate over the tool calls, executing each tool and storing the results. Each tool execution is traced with a new span, named after the tool function name. The inputs and outputs are logged as attributes on the span.</li>
<li>We append the tool call results to the message history with the <code>tool</code> role. This allows the LLM to see the results of the tool calls in subsequent requests. It also allows us to see the tool call results in the MLflow UI.</li>
<li>We prepare messages for the final response, including a prompt to answer the initial question based on the tool call results.</li>
<li>We make the final LLM call with our patched <code>chat</code> function. Again, because we are using the patched function, this call is already traced.</li>
<li>We set the final output for the parent span, including both the final response from the LLM and the tool results.</li>
<li>Finally, we use <code>set_span_chat_messages</code> to append the final response to the chat history in the MLflow UI. Note that, to keep things clean and simple, we only record the user&#x27;s initial query and the final response to the parent span with <code>set_span_chat_messages</code>. We can click into the nested spans to see the tool call results and other details.</li>
</ol>
<p>This process creates a comprehensive trace of the entire tool calling loop, from the initial request through tool executions and the final response.</p>
<p>We can execute this as follows. However, note that you should <em>not</em> run arbitrary code generated or invoked by LLMs without fully understanding what it will do on your system.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">executor </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ToolExecutor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> executor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">execute_tool_calling_loop</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    messages</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;role&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;user&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;What is the tip for a $235.32 bill with a 22% tip?&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Resulting in the following trace:</p>
<p><img loading="lazy" alt="Tool Calling Loop" src="/mlflow-website/assets/images/7_tool_loop-db29a3ec8eee8a67b8c7013e23cf3154.png" width="2286" height="1986" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>This post has shown how to extend MLflow Tracing beyond its built-in provider support. We started with a simple example—adding tracing to the Ollama Python SDK&#x27;s <code>chat</code> method—and saw how, with a lightweight patch, we could capture detailed information about each chat completion. We then built on this foundation to trace a more complex tool execution loop.</p>
<p>The key takeaways are:</p>
<ul>
<li>MLflow Tracing is highly customizable and can be adapted to providers for which autologging is not available</li>
<li>Adding basic tracing support can often be done with minimal code changes. In this case, we patched the Ollama Python SDK&#x27;s <code>chat</code> method and wrote a few lines of code to add tracing support.</li>
<li>The same principles used for simple API calls can be extended to complex workflows with multiple steps. In this case, we traced a tool calling loop that included multiple steps and tool calls.</li>
</ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mlflow-website/blog/tags/genai">genai</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mlflow-website/blog/tags/tracing">tracing</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mlflow-website/blog/tags/ollama">ollama</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="Introducing MLflow Tracing&#x27;s Jupyter integration"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/mlflow-website/blog/mlflow-tracing-in-jupyter">MLflow Tracing in Jupyter Notebooks</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-12-20T00:00:00.000Z" itemprop="datePublished">December 20, 2024</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/daniel-yk-lok/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="/img/authors/daniel_lok.png" alt="Daniel Lok" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/daniel-yk-lok/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Daniel Lok</span></a></div><small class="avatar__subtitle" itemprop="description">Software Engineer at Databricks</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><img loading="lazy" alt="Thumbnail" src="/mlflow-website/assets/images/mlflow-tracing-in-jupyter-title-9583055b007cdf23970047cfad4b9b8a.png" width="1185" height="238" class="img_ev3q"></p>
<p>🚀 We&#x27;re excited to announce a major upgrade to the <a href="https://mlflow.org/docs/latest/llms/tracing/index.html" target="_blank" rel="noopener noreferrer">MLflow Tracing</a>
experience!</p>
<p>If you&#x27;re not familiar with MLflow Tracing, it&#x27;s an observability tool that allows you record the inputs and
outputs of intermediate function executions. It&#x27;s particularly useful in debugging GenAI applications, and MLflow has over
a <a href="https://mlflow.org/docs/latest/llms/tracing/index.html#automatic-tracing" target="_blank" rel="noopener noreferrer">dozen integrations with popular GenAI frameworks</a>
to automatically generate traces without requiring you to change your existing code.</p>
<p>As of <strong>MLflow 2.20</strong>, you can now view the MLflow Trace UI directly within Jupyter notebooks, allowing
you to debug your applications without having to tab out of your development environment. Context
switching can often be disruptive to one&#x27;s workflow, and this feature makes it easier to stay focused while
still being able to visualize the trace data that you generate.</p>
<figure><p><img loading="lazy" alt="MLflow Trace UI in Jupyter Notebook" src="/mlflow-website/assets/images/jupyter-trace-ui-a11c56c439864da666540e9d501329cb.png" width="2440" height="1586" class="img_ev3q">
</p><figcaption style="text-align:center">An example of the UI in JupyterLab</figcaption><p></p></figure>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="getting-started">Getting Started<a href="#getting-started" class="hash-link" aria-label="Direct link to Getting Started" title="Direct link to Getting Started">​</a></h2>
<p>To get started, you&#x27;ll need to be using an <a href="https://mlflow.org/docs/latest/tracking/server.html" target="_blank" rel="noopener noreferrer">MLflow Tracking Server</a>.
Under the hood, the MLflow client needs to make network requests in order to fetch the UI assets and trace data.</p>
<p>If you don&#x27;t use a remote server, you can always start one locally by running the <code>mlflow server</code>
<a href="https://mlflow.org/docs/latest/tracking/server.html#start-the-tracking-server" target="_blank" rel="noopener noreferrer">CLI command</a>. By default,
the server will start up at <code>http://localhost:5000</code>.</p>
<p>In your notebook, simply ensure that the MLflow Tracking URI is set to your tracking server, and you&#x27;re good to go!</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> mlflow</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># replace this with your own URI, if it differs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">tracking_uri </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;http://localhost:5000&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_tracking_uri</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">tracking_uri</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># create a new experiment to avoid cluttering the default experiment</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">experiment </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_experiment</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;mlflow-trace-ui-demo&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># the trace UI should now show up whenever traces are generated,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># for example:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">@mlflow</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">trace</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">add</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">a</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> b</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> a </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> b</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># running the traced function triggers the UI display</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">add</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The trace UI will show up whenever any of the following events happen:</p>
<ol>
<li>A trace is generated in the cell (via automatic tracing, or when running manually traced functions)</li>
<li>When a trace object is explicitly displayed (e.g. via IPython&#x27;s <code>display()</code> function)</li>
<li>When the <code>mlflow.search_traces()</code> API is called</li>
</ol>
<p>For a hands-on experience with this feature, please try running our
<a href="https://github.com/mlflow/mlflow/blob/master/docs/docs/tracing/tutorials/jupyter-trace-demo.ipynb" target="_blank" rel="noopener noreferrer"><strong>demo notebook</strong></a>!
The notebook contains detailed examples of all three scenarios above, as well as a short LangChain RAG demo to
get a more realistic impression of how this feature will feel during your development loop.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="disabling-and-re-enabling-the-display">Disabling and Re-enabling the Display<a href="#disabling-and-re-enabling-the-display" class="hash-link" aria-label="Direct link to Disabling and Re-enabling the Display" title="Direct link to Disabling and Re-enabling the Display">​</a></h2>
<p>This feature is enabled by default, but it can be turned off any time by calling <code>mlflow.tracing.disable_notebook_display()</code>.
To remove the displays that have already rendered, you&#x27;ll need to re-run the cells (or simply clear the cell output).</p>
<p>If you want to re-enable the display, you can call <code>mlflow.tracing.enable_notebook_display()</code>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="bug-reports-and-feedback">Bug Reports and Feedback<a href="#bug-reports-and-feedback" class="hash-link" aria-label="Direct link to Bug Reports and Feedback" title="Direct link to Bug Reports and Feedback">​</a></h2>
<p>To report bugs or provide feedback, please file an issue in the
<a href="https://github.com/mlflow/mlflow/issues" target="_blank" rel="noopener noreferrer">MLflow GitHub repo</a>. We&#x27;re looking forward to hearing from you!</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mlflow-website/blog/tags/genai">genai</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mlflow-website/blog/tags/mlops">mlops</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mlflow-website/blog/tags/tracing">tracing</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="A guide for using BedRock Runtime Agent with ChatModel and custom trace handling."><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/mlflow-website/blog/bedrock-chat-model-part-1">Using Bedrock Agent as an MLflow ChatModel with Tracing</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-11-07T00:00:00.000Z" itemprop="datePublished">November 7, 2024</time> · <!-- -->62 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/jas-bali-195ba410a/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="/img/authors/jas_bali.png" alt="Jas Bali" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/jas-bali-195ba410a/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Jas Bali</span></a></div><small class="avatar__subtitle" itemprop="description">Lead Specialist Solutions Architect at Databricks</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><img loading="lazy" alt="Thumbnail" src="/mlflow-website/assets/images/bedrock_chatmodel-d0f0e66cc93ae5d58f3fcaafbb5e79b1.png" width="2282" height="1280" class="img_ev3q"></p>
<p><strong>In this blog post, we delve into the integration of AWS Bedrock Agent as a ChatModel within MLflow, focusing on
how to leverage Bedrock&#x27;s <a href="https://docs.aws.amazon.com/bedrock/latest/userguide/agents-action-create.html" target="_blank" rel="noopener noreferrer">Action Groups</a>
and <a href="https://docs.aws.amazon.com/bedrock/latest/userguide/agents-kb-add.html" target="_blank" rel="noopener noreferrer">Knowledge Bases</a> to build a
conversational AI application. The blog will guide you through setting up the Bedrock Agent, configuring
Action Groups to enable custom actions with Lambda, and utilizing knowledge bases for context-aware interactions.
A special emphasis is placed on implementing tracing within MLflow.By the end of this article, you&#x27;ll have a good
understanding of how to combine AWS Bedrock&#x27;s advanced features with MLflow&#x27;s capabilities such as agent request
tracing, model tracking and consistent signatures for input examples.</strong></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-aws-bedrock">What is AWS Bedrock?<a href="#what-is-aws-bedrock" class="hash-link" aria-label="Direct link to What is AWS Bedrock?" title="Direct link to What is AWS Bedrock?">​</a></h2>
<p>Amazon Bedrock is a managed service by AWS that simplifies the development of generative AI applications. It provides access to a variety of foundation models (FMs) from leading AI providers through a single API, enabling developers to build and scale AI solutions securely and efficiently.</p>
<p>Key Components Relevant to This Integration:</p>
<p><strong>Bedrock Agent</strong>: At a high level, a bedrock agent is an abstraction within bedrock that consists of a foundation model,
action groups and knowledge bases.</p>
<p><strong>Action Groups</strong>: These are customizable sets of actions that define what tasks the Bedrock Agent can perform.
Action Groups consist of an OpenAPI Schema and the corresponding Lambda functions that will be used to execute tool calls.
The OpenAPI Schema is used to define APIs available for the agent to invoke and complete tasks.</p>
<p><strong>Knowledge Bases</strong>: Amazon Bedrock supports the creation of Knowledge Bases to implement
Retrieval Augmented Generation workflows. It consists of data sources (on S3 or webpages)
and a vector store that contains the embedded references to this data.</p>
<p>Bedrock&#x27;s Agent execution process and the corresponding tracing for Agent instrumentation is grouped as follows:</p>
<p><strong>Pre-processing</strong>
This step validates, contextualizes and categorizes user input.</p>
<p><strong>Orchestration</strong>
This step handles the interpretation of user inputs, deciding when to and which tasks to perform,
and iteratively refines responses</p>
<p><strong>Post-processing (Optional)</strong>
This step formats the final response before returning to the user.</p>
<p><strong>Traces</strong>
Each step above has an execution trace, which consists of rationale, actions, queries and observations at each step
of the agent&#x27;s response. This includes both the inputs and outputs of action groups and knowledge base queries.</p>
<p>We will look at these traces in detail below.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-a-chatmodel-in-mlflow">What is a ChatModel in MLflow?<a href="#what-is-a-chatmodel-in-mlflow" class="hash-link" aria-label="Direct link to What is a ChatModel in MLflow?" title="Direct link to What is a ChatModel in MLflow?">​</a></h2>
<p>The <a href="https://mlflow.org/docs/latest/llms/chat-model-guide/index.html" target="_blank" rel="noopener noreferrer">ChatModel class</a> is specifically
designed to make it easier to implement models that are compatible with
popular large language model (LLM) chat APIs. It enables you to seamlessly bring in your own models or agents and
leverage MLflow&#x27;s functionality, even if those models aren&#x27;t natively supported as a flavor in MLflow. Additionally,
It provides default signatures, which are static for ChatModel, unlike PythonModel.</p>
<p>In the following sections, we will use ChatModel to wrap the Bedrock Agent.</p>
<p>For more detailed information about ChatModel, you can read the MLflow documentation
<a href="https://mlflow.org/docs/latest/llms/chat-model-guide/index.html" target="_blank" rel="noopener noreferrer">here</a> and
<a href="https://mlflow.org/docs/latest/python_api/mlflow.pyfunc.html#mlflow.pyfunc.ChatModel" target="_blank" rel="noopener noreferrer">here</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="setting-up-aws-bedrock-agent-with-an-action-group">Setting up AWS Bedrock Agent with an Action group<a href="#setting-up-aws-bedrock-agent-with-an-action-group" class="hash-link" aria-label="Direct link to Setting up AWS Bedrock Agent with an Action group" title="Direct link to Setting up AWS Bedrock Agent with an Action group">​</a></h2>
<p>In this section, we will deploy all components of a bedrock agent so that we can invoke it as a <code>ChatModel</code> in MLflow.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a href="#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">​</a></h3>
<p>You will need to setup following items (either via the AWS console or SDKs):</p>
<ul>
<li>Setting up role for the agent and Lambda function. <a href="https://github.com/awsdocs/aws-doc-sdk-examples/blob/main/python/example_code/bedrock-agent/scenario_get_started_with_agents.py#L148" target="_blank" rel="noopener noreferrer">Example</a></li>
<li>Create/deploy the agent. <a href="https://github.com/awsdocs/aws-doc-sdk-examples/blob/main/python/example_code/bedrock-agent/scenario_get_started_with_agents.py#L191" target="_blank" rel="noopener noreferrer">Example</a>
<ul>
<li><strong>Important</strong>: Save the agent ID here as we will need this below.</li>
</ul>
</li>
<li>Creating a Lambda function. <a href="https://github.com/awsdocs/aws-doc-sdk-examples/blob/main/python/example_code/bedrock-agent/scenario_get_started_with_agents.py#L218" target="_blank" rel="noopener noreferrer">Example</a></li>
<li>Configuring IAM permissions for agent-Lambda interaction. <a href="https://github.com/awsdocs/aws-doc-sdk-examples/blob/main/python/example_code/bedrock-agent/scenario_get_started_with_agents.py#L283" target="_blank" rel="noopener noreferrer">Example</a> and <a href="https://github.com/awsdocs/aws-doc-sdk-examples/blob/main/python/example_code/bedrock-agent/scenario_get_started_with_agents.py#L297" target="_blank" rel="noopener noreferrer">Example</a></li>
<li>Creating an action group to link the agent and Lambda. <a href="https://github.com/awsdocs/aws-doc-sdk-examples/blob/main/python/example_code/bedrock-agent/scenario_get_started_with_agents.py#L312" target="_blank" rel="noopener noreferrer">Example</a>
<ul>
<li><strong>Important</strong>:Save<!-- --> the agent alias ID here as we will need this below.</li>
</ul>
</li>
<li>Deploy Bedrock agent with an alias. <a href="https://github.com/awsdocs/aws-doc-sdk-examples/blob/main/python/example_code/bedrock-agent/scenario_get_started_with_agents.py#L342" target="_blank" rel="noopener noreferrer">Example</a></li>
</ul>
<b>In our case, we are going to deploy the following example action group, which calculates the next optimal departure
date for a Hohmann transfer from Earth to Mars, based on the spacecraft&#x27;s mass and specific impulse.</b>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="openapi-schema-for-action-groups">OpenAPI schema for Action Groups<a href="#openapi-schema-for-action-groups" class="hash-link" aria-label="Direct link to OpenAPI schema for Action Groups" title="Direct link to OpenAPI schema for Action Groups">​</a></h3>
<p>As described above, here is the OpenAPI Schema for our example action group:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token key atrule">openapi</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> 3.0.0</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token key atrule">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">title</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Time API</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> 1.0.0</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">description</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> API to get the next optimal departure date for a Hohmann transfer from Earth to Mars.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token key atrule">paths</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">/get-next-mars-launch-window</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token key atrule">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token key atrule">summary</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Gets the next optimal launch window to Mars.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token key atrule">description</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Gets the next optimal launch window to Mars.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token key atrule">operationId</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> getNextMarsLaunchWindow</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token key atrule">parameters</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> total_mass</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token key atrule">in</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> query</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token key atrule">description</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Total mass of the spacecraft including fuel (kg)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token key atrule">required</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token key atrule">schema</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> dry_mass</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token key atrule">in</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> query</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token key atrule">description</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Mass of the spacecraft without fuel (kg).</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token key atrule">required</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token key atrule">schema</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> specific_impulse</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token key atrule">in</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> query</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token key atrule">description</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Specific impulse of the propulsion system (s).</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token key atrule">required</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token key atrule">schema</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token key atrule">responses</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token key atrule">&quot;200&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token key atrule">description</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> The next optimal departure date for a Hohmann transfer from Earth to Mars</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> based on the spacecraft&#x27;s mass and specific impulse.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token key atrule">content</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token key atrule">&quot;application/json&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">              </span><span class="token key atrule">schema</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> object</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                  </span><span class="token key atrule">next_launch_window</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token key atrule">description</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Next Mars Launch Window</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="action-groups---lamda-function">Action groups - Lamda function<a href="#action-groups---lamda-function" class="hash-link" aria-label="Direct link to Action groups - Lamda function" title="Direct link to Action groups - Lamda function">​</a></h3>
<p>Here is the code deployment for action group&#x27;s example Lambda:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> json</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> math</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> datetime </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> datetime</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> timedelta</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">lambda_handler</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">_calculate_optimal_departure_window</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        total_mass</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> dry_mass</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> specific_impulse</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Calculate the next optimal departure date for a Hohmann transfer from Earth to Mars,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        based on the spacecraft&#x27;s mass and specific impulse.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Parameters:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        - total_mass (float): Total mass of the spacecraft including fuel (kg).</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        - dry_mass (float): Mass of the spacecraft without fuel (kg).</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        - specific_impulse (float): Specific impulse of the propulsion system (s).</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Returns:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        - dict: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            &#x27;next_launch_date&#x27;: datetime,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            &#x27;synodic_period_days&#x27;: float,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            &#x27;transfer_time_days&#x27;: float,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            &#x27;delta_v_available_m_s&#x27;: float,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            &#x27;delta_v_required_m_s&#x27;: float,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            &#x27;is_feasible&#x27;: bool</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">          }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        current_date </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Constants</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        G0 </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">9.80665</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># m/s^2, standard gravity</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        MU_SUN </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token number" style="color:rgb(181, 206, 168)">1.32712440018e20</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># m^3/s^2, standard gravitational parameter for the Sun</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        AU </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1.496e11</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># meters, astronomical unit</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        EARTH_ORBITAL_PERIOD </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">365.25</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># days</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        MARS_ORBITAL_PERIOD </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">686.98</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># days</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        SYNODIC_PERIOD </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">abs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> EARTH_ORBITAL_PERIOD</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> MARS_ORBITAL_PERIOD</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        TRANSFER_TIME </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">259</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># days, approximate duration of Hohmann transfer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        BASE_LAUNCH_DATE </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> datetime</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">2020</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">7</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># A reference past launch window date</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Orbital Radii (assuming circular orbits for simplicity)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        r1 </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> AU  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Earth&#x27;s orbital radius in meters</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        r2 </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1.524</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> AU  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Mars&#x27; orbital radius in meters</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Calculate Required Delta-V for Hohmann Transfer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Using vis-viva equation for Hohmann transfer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">calculate_hohmann_delta_v</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">mu</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> r_start</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> r_end</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Velocity of departure orbit (Earth)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            v_start </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> math</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sqrt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">mu </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> r_start</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Velocity of transfer orbit at departure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            a_transfer </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">r_start </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> r_end</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            v_transfer_start </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> math</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sqrt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">mu </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> r_start </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> a_transfer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            delta_v1 </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> v_transfer_start </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> v_start</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Velocity of arrival orbit (Mars)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            v_end </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> math</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sqrt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">mu </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> r_end</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Velocity of transfer orbit at arrival</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            v_transfer_end </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> math</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sqrt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">mu </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> r_end </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> a_transfer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            delta_v2 </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> v_end </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> v_transfer_end</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> delta_v1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> delta_v2</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        delta_v1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> delta_v2 </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> calculate_hohmann_delta_v</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">MU_SUN</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> r1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> r2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        delta_v_required </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">abs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">delta_v1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">abs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">delta_v2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Total delta-v in m/s</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Delta-V using Tsiolkovsky Rocket Equation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> dry_mass </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">or</span><span class="token plain"> total_mass </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;=</span><span class="token plain"> dry_mass</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">raise</span><span class="token plain"> ValueError</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Total mass must be greater than dry mass.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        delta_v_available </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            specific_impulse </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> G0 </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> math</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">log</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">total_mass </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> dry_mass</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># m/s</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        is_feasible </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> delta_v_available </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;=</span><span class="token plain"> delta_v_required</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> current_date </span><span class="token keyword" style="color:rgb(86, 156, 214)">is</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            current_date </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> datetime</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">now</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        days_since_base </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">current_date </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> BASE_LAUNCH_DATE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">days</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> days_since_base </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Current date is before the base launch date</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            next_launch_date </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> BASE_LAUNCH_DATE</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            synodic_periods_passed </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> days_since_base </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> SYNODIC_PERIOD</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            synodic_periods_passed_int </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> math</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">floor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">synodic_periods_passed</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            next_launch_date </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> BASE_LAUNCH_DATE </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> timedelta</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                days</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">synodic_periods_passed_int </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> SYNODIC_PERIOD</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        next_launch_date </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> next_launch_date</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">replace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            hour</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> minute</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> second</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> microsecond</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;next_launch_date&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> next_launch_date</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;synodic_period_days&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> SYNODIC_PERIOD</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;transfer_time_days&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> TRANSFER_TIME</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;delta_v_available_m_s&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> delta_v_available</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;delta_v_required_m_s&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> delta_v_required</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;is_feasible&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> is_feasible</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    query_params </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;name&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;value&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> event </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;parameters&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    total_mass </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">float</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">query_params</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;total_mass&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    dry_mass </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">float</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">query_params</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;dry_mass&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    specific_impulse </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">float</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">query_params</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;specific_impulse&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;next_launch_window&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> _calculate_optimal_departure_window</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            total_mass</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> dry_mass</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> specific_impulse</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    response_body </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;application/json&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;body&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> json</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">dumps</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    action_response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;actionGroup&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;actionGroup&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;apiPath&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;apiPath&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;httpMethod&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;httpMethod&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;httpStatusCode&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">200</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;responseBody&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> response_body</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    session_attributes </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;sessionAttributes&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    prompt_session_attributes </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;promptSessionAttributes&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;messageVersion&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;1.0&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;response&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> action_response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;sessionAttributes&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> session_attributes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;promptSessionAttributes&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> prompt_session_attributes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Next, we are going to wrap Bedrock agent as a ChatModel so that we can register and load it for inference.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="writing-chatmodel-for-bedrock-agent">Writing ChatModel for Bedrock agent<a href="#writing-chatmodel-for-bedrock-agent" class="hash-link" aria-label="Direct link to Writing ChatModel for Bedrock agent" title="Direct link to Writing ChatModel for Bedrock agent">​</a></h2>
<p>Here are the top-level packages used for running the following example locally in <strong>Python 3.12.7</strong>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">boto3==1.35.31</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">mlflow==2.16.2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="implementing-bedrock-agent-as-an-mlflow-chatmodel-with-tracing">Implementing Bedrock Agent as an MLflow ChatModel with Tracing<a href="#implementing-bedrock-agent-as-an-mlflow-chatmodel-with-tracing" class="hash-link" aria-label="Direct link to Implementing Bedrock Agent as an MLflow ChatModel with Tracing" title="Direct link to Implementing Bedrock Agent as an MLflow ChatModel with Tracing">​</a></h3>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> copy</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> uuid</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> typing </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> List</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> Optional</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> boto3</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> mlflow</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> botocore</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">config </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> Config</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">entities </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> SpanType</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">pyfunc </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> ChatModel</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">types</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">llm </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> ChatResponse</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> ChatMessage</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> ChatParams</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> ChatChoice</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">BedrockModel</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ChatModel</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">__init__</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Initializes the BedrockModel instance with placeholder values.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Note:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            The `load_context` method cannot create new instance variables; it can only modify existing ones.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            Therefore, all instance variables should be defined in the `__init__` method with placeholder values.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">brt </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_main_bedrock_agent </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_bedrock_agent_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_bedrock_agent_alias_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_inference_configuration </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_agent_instruction </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_model </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_aws_region </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">__getstate__</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Prepares the instance state for pickling.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        This method is needed because the `boto3` client (`self.brt`) cannot be pickled.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        By excluding `self.brt` from the state, we ensure that the model can be serialized and deserialized properly.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Create a dictionary of the instance&#x27;s state, excluding the boto3 client</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        state </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">__dict__</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">copy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">del</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;brt&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> state</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">__setstate__</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Restores the instance state during unpickling.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        This method is needed to reinitialize the `boto3` client (`self.brt`) after the instance is unpickled,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        because the client was excluded during pickling.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">__dict__</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">update</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">brt </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">load_context</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Initializes the Bedrock client with AWS credentials.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Args:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            context: The MLflow context containing model configuration.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Note:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            Dependent secret variables must be in the execution environment prior to loading the model;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            else they will not be available during model initialization.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_main_bedrock_agent </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> context</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">model_config</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;agents&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;main&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_bedrock_agent_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_main_bedrock_agent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;bedrock_agent_id&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_bedrock_agent_alias_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_main_bedrock_agent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;bedrock_agent_alias_id&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_inference_configuration </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_main_bedrock_agent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;inference_configuration&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_agent_instruction </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_main_bedrock_agent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;instruction&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_model </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_main_bedrock_agent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;model&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_aws_region </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_main_bedrock_agent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;aws_region&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Initialize the Bedrock client</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">brt </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> boto3</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            service_name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;bedrock-agent-runtime&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            config</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">Config</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">region_name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_aws_region</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            aws_access_key_id</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;AWS_ACCESS_KEY&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            aws_secret_access_key</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;AWS_SECRET_ACCESS_KEY&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            aws_session_token</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;AWS_SESSION_TOKEN&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            region_name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_aws_region</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">@staticmethod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">_extract_trace_groups</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">events</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Extracts trace groups from a list of events based on their trace IDs.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Args:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            events (list): A list of event dictionaries.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Returns:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            dict: A dictionary where keys are trace IDs and values are lists of trace items.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> collections </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> defaultdict</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        trace_groups </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> defaultdict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">find_trace_ids</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> original_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> depth</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> parent_key</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> depth </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Stop recursion after 5 levels if no traceId has been found</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">isinstance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                trace_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> obj</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;traceId&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Include the parent key as the &#x27;type&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    item </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;type&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> parent_key</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;data&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> obj</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;event_order&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> original_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;trace&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;event_order&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    trace_groups</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">item</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> key</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> value </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> obj</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">items</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        find_trace_ids</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                            value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> original_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> depth</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">depth </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> parent_key</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">key</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">elif</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">isinstance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> item </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> obj</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    find_trace_ids</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">item</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> item</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> depth</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">depth </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> parent_key</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">parent_key</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        find_trace_ids</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">events</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">trace_groups</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">@staticmethod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">_get_final_response_with_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">trace_id_groups</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token builtin" style="color:rgb(86, 156, 214)">dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Processes trace groups to extract the final response and create relevant MLflow spans.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Args:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            trace_id_groups (dict): A dictionary of trace groups keyed by trace IDs.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Returns:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            str: The final response text extracted from the trace groups.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        trace_id_groups_copy </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> copy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">deepcopy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">trace_id_groups</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        model_invocation_input_key </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;modelInvocationInput&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">_create_trace_by_type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            trace_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> _trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> context_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> optional_rationale_subtrace</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">@mlflow</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">trace_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                attributes</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;trace_attributes&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> trace_id_groups</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">_trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">_trace_agent_pre_context</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">inner_input_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> optional_rationale_subtrace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;data&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;text&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            trace_id_groups_copy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">_trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">remove</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">context_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            _trace_agent_pre_context</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">context_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;data&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;text&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">_extract_action_group_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            _trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> action_group_invocation_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">dict</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">@mlflow</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;action-group-invocation&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                attributes</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;trace_attributes&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> trace_id_groups</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">_trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">_action_group_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">inner_trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> _trace </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    action_group_invocation_output </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> _trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;data&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;actionGroupInvocationOutput&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> action_group_invocation_output </span><span class="token keyword" style="color:rgb(86, 156, 214)">is</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">not</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        action_group_response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;action_group_name&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> action_group_invocation_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;actionGroupName&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;api_path&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> action_group_invocation_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;apiPath&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;execution_type&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> action_group_invocation_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;executionType&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;execution_output&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> action_group_invocation_output</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;text&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">remove</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> action_group_response</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            _action_group_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">action_group_invocation_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">_extract_knowledge_base_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            _trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> knowledge_base_lookup_input</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">@mlflow</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;knowledge-base-lookup&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                attributes</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;trace_attributes&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> trace_id_groups</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">_trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">_knowledge_base_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">inner_trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> _trace </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    knowledge_base_lookup_output </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> _trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;data&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;knowledgeBaseLookupOutput&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> knowledge_base_lookup_output </span><span class="token keyword" style="color:rgb(86, 156, 214)">is</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">not</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        knowledge_base_response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;knowledge_base_id&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> knowledge_base_lookup_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;knowledgeBaseId&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;text&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> knowledge_base_lookup_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;text&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;retrieved_references&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> knowledge_base_lookup_output</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;retrievedReferences&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">remove</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> knowledge_base_response</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            _knowledge_base_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">_trace_group_type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            _trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> _trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> optional_rationale_subtrace</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            trace_name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;observation&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            pre_processing_trace_id_suffix </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;-pre&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> pre_processing_trace_id_suffix </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> _trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                trace_name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;agent-initial-context&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> _inner_trace </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    action_group_invocation_input </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> _inner_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;data&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;actionGroupInvocationInput&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> action_group_invocation_input </span><span class="token keyword" style="color:rgb(86, 156, 214)">is</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">not</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        action_group_name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> action_group_invocation_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;actionGroupName&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        trace_name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f&quot;ACTION-GROUP-</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">action_group_name</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        _create_trace_by_type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                            trace_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> _trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> _trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> optional_rationale_subtrace</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        _extract_action_group_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                            _trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> action_group_invocation_input</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">remove</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    knowledge_base_lookup_input </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> _inner_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;data&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;knowledgeBaseLookupInput&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> knowledge_base_lookup_input </span><span class="token keyword" style="color:rgb(86, 156, 214)">is</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">not</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        knowledge_base_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> knowledge_base_lookup_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;knowledgeBaseId&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        trace_name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f&quot;KNOWLEDGE_BASE_</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">knowledge_base_id</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        _create_trace_by_type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                            trace_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> _trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> _trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> optional_rationale_subtrace</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        _extract_knowledge_base_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                            _trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> knowledge_base_lookup_input</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">remove</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> trace_name</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> _trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> _trace_group </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> trace_id_groups_copy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">items</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            trace_group </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">sorted</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">_trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> key</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token keyword" style="color:rgb(86, 156, 214)">lambda</span><span class="token plain"> tg</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> tg</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;event_order&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            model_invocation_input_subtrace </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            optional_rationale_subtrace </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> _trace </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> _trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> model_invocation_input_key </span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token plain"> _trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;type&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    model_invocation_input_subtrace </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> _trace</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">elif</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;rationale&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token plain"> _trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;type&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    optional_rationale_subtrace </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> _trace</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            _trace_group_type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                _trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                model_invocation_input_subtrace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                optional_rationale_subtrace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        final_response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">trace_id_groups_copy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">values</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;data&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;finalResponse&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;text&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> final_response</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">@mlflow</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Bedrock Input Prompt&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">_get_agent_prompt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> raw_input_question</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Constructs the agent prompt by combining the input question and the agent instruction.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Args:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            raw_input_question (str): The user&#x27;s input question.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Returns:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            str: The formatted agent prompt.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">        Answer the following question and pay strong attention to the prompt:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">        &lt;question&gt;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">        </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">raw_input_question</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">        &lt;/question&gt;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">        &lt;instruction&gt;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">        </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">self</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-interpolation interpolation">_agent_instruction</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">        &lt;/instruction&gt;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">        &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">@mlflow</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;bedrock-agent&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> span_type</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">SpanType</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">CHAT_MODEL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">predict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> List</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ChatMessage</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> params</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Optional</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ChatParams</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> ChatResponse</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Makes a prediction using the Bedrock agent and processes the response.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Args:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            context: The MLflow context.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            messages (List[ChatMessage]): A list of chat messages.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            params (Optional[ChatParams]): Optional parameters for the chat.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Returns:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            ChatResponse: The response from the Bedrock agent.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        formatted_input </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">content</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        session_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> uuid</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">uuid4</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token builtin" style="color:rgb(86, 156, 214)">hex</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">brt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">invoke_agent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            agentId</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_bedrock_agent_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            agentAliasId</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_bedrock_agent_alias_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            inputText</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_get_agent_prompt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">formatted_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            enableTrace</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            sessionId</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">session_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            endSession</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">False</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Since this provider&#x27;s output doesn&#x27;t match the OpenAI specification,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># we need to go through the returned trace data and map it appropriately</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># to create the MLflow span object.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        events </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> event </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">enumerate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;completion&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;trace&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;trace&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;event_order&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> index</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            events</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        trace_id_groups </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_extract_trace_groups</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">events</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        final_response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_get_final_response_with_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">trace_id_groups</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">with</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">start_span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;retrieved-response&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> span_type</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">SpanType</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">AGENT</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_inputs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_attributes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            output </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ChatResponse</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                choices</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    ChatChoice</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        index</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                        message</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">ChatMessage</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">role</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;user&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> content</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">final_response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                usage</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_outputs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">output</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> output</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here are some important remarks about this <code>BedrockModel</code> implementation:</p>
<ul>
<li>AWS access key ID, secret key and the session token are externalized here. These need to be present in the environment before we can run inference.
You will need to generate it for your IAM user and set them as environment variables.</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">aws sts get-session-token --duration-seconds 3600</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And then set the following:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;AWS_ACCESS_KEY&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;&lt;AccessKeyId&gt;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;AWS_SECRET_ACCESS_KEY&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;&lt;SecretAccessKey&gt;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;AWS_SESSION_TOKEN&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;&lt;SessionToken&gt;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As noticed in the code above, these do not get logged with the model and are only set inside <code>load_context</code>.
This method is called when ChatModel is constructed. Further details are <a href="https://mlflow.org/docs/latest/python_api/mlflow.pyfunc.html#mlflow.pyfunc.PythonModel.load_context" target="_blank" rel="noopener noreferrer">here</a></p>
<ul>
<li>
<p>Bedrock agent ID and agent alias ID are passed via <code>model_config</code> that we will use below.</p>
</li>
<li>
<p>boto3 module has been excluded from getting pickled. This is done via <code>__getstate__</code> and <code>__setstate__</code> where we exclude it and reset it respectively</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="log-and-load-the-bedrockmodel">Log and load the BedrockModel<a href="#log-and-load-the-bedrockmodel" class="hash-link" aria-label="Direct link to Log and load the BedrockModel" title="Direct link to Log and load the BedrockModel">​</a></h3>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> mlflow</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">models </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> infer_signature</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">input_example </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;messages&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;role&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;user&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;When is the next launch window for Mars?&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">output_example </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;choices&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;index&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;finish_reason&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;stop&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;message&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;role&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;assistant&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;test content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">signature </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> infer_signature</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">input_example</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> output_example</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">with</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">start_run</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    model_config </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;agents&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;main&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;model&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;anthropic.claude-v2&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;aws_region&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;us-east-1&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;bedrock_agent_id&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;O9KQSEVEFF&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;bedrock_agent_alias_id&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;3WHEEJKNUT&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;instruction&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;You have functions available at your disposal to use when anwering any questions about orbital mechanics.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;if you can&#x27;t find a function to answer a question about orbital mechanics, simply reply &quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;&#x27;I do not know&#x27;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;inference_configuration&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;temperature&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0.5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;maximumLength&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">2000</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Input example for the model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    input_example </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;messages&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;role&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;user&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;When is the next launch window for Mars? My spacecraft&#x27;s total mass is 50000, dry mass is 10000 and specific impulse is 2500. Mass in Kg.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Log and load the model using MLflow</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    logged_chain_info </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">pyfunc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">log_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        python_model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">BedrockModel</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        model_config</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">model_config</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        artifact_path</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;chain&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># This string is used as the path inside the MLflow model where artifacts are stored</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        input_example</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">input_example</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Must be a valid input to your chain</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">loaded </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">pyfunc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">load_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">logged_chain_info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">model_uri</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Predict using the loaded model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> loaded</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">predict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;messages&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;role&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;user&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;When is the next launch window for Mars? My spacecraft&#x27;s total mass is 50000, dry mass is 10000 and specific impulse is 2500. Mass in Kg.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<code class="language-text"></code>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="mapping-bedrock-agent-trace-data-to-mlflow-span-objects">Mapping Bedrock Agent Trace Data to MLflow Span Objects<a href="#mapping-bedrock-agent-trace-data-to-mlflow-span-objects" class="hash-link" aria-label="Direct link to Mapping Bedrock Agent Trace Data to MLflow Span Objects" title="Direct link to Mapping Bedrock Agent Trace Data to MLflow Span Objects">​</a></h3>
<p>In this step, we need to iterate over the data that is returned within the bedrock agent&#x27;s response trace
to provide relevant mappings to create the MLflow span object.
AWS Bedrock agent&#x27;s response is a flat list with trace events connected by <code>traceId</code>.
Here is the raw trace sent in the bedrock agent&#x27;s response:</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Expand to see AWS Bedrock agent&#x27;s raw trace</summary><div><div class="collapsibleContent_i85q"><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">[</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    &#x27;trace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentAliasId&#x27;: &#x27;3WHEEJKNUT&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentId&#x27;: &#x27;O9KQSEVEFF&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentVersion&#x27;: &#x27;1&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;event_order&#x27;: 0,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;sessionId&#x27;: &#x27;9566a6d78551434fb0409578ffed63c1&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;trace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;preProcessingTrace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;modelInvocationInput&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;inferenceConfiguration&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">              ...</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;text&#x27;: &#x27;\n\nHuman: You are a classifying agent that filters user inputs into categories. Your job is to sort these inputs before they...&lt;thinking&gt; XML tags before providing only the category letter to sort the input into within &lt;category&gt; XML tags.\n\nAssistant:&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;traceId&#x27;: &#x27;ca9880a2-dae7-46ac-a480-f38ca7e2d99f-pre-0&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;type&#x27;: &#x27;PRE_PROCESSING&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    &#x27;trace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentAliasId&#x27;: &#x27;3WHEEJKNUT&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentId&#x27;: &#x27;O9KQSEVEFF&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentVersion&#x27;: &#x27;1&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;event_order&#x27;: 1,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;sessionId&#x27;: &#x27;9566a6d78551434fb0409578ffed63c1&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;trace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;preProcessingTrace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;modelInvocationOutput&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;parsedResponse&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">              ...</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;traceId&#x27;: &#x27;ca9880a2-dae7-46ac-a480-f38ca7e2d99f-pre-0&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    &#x27;trace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentAliasId&#x27;: &#x27;3WHEEJKNUT&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentId&#x27;: &#x27;O9KQSEVEFF&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentVersion&#x27;: &#x27;1&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;event_order&#x27;: 2,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;sessionId&#x27;: &#x27;9566a6d78551434fb0409578ffed63c1&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;trace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;orchestrationTrace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;modelInvocationInput&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;inferenceConfiguration&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">              ...</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;text&#x27;: &#x27;\n\nHuman:\nYou are a research assistant AI that has been equipped with one or more functions to help you answer a &lt;question&gt;...\n\nAssistant: &lt;scratchpad&gt; I understand I cannot use functions that have not been provided to me to answer this question.\n\n&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;traceId&#x27;: &#x27;ca9880a2-dae7-46ac-a480-f38ca7e2d99f-0&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;type&#x27;: &#x27;ORCHESTRATION&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    &#x27;trace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentAliasId&#x27;: &#x27;3WHEEJKNUT&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentId&#x27;: &#x27;O9KQSEVEFF&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentVersion&#x27;: &#x27;1&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;event_order&#x27;: 3,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;sessionId&#x27;: &#x27;9566a6d78551434fb0409578ffed63c1&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;trace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;orchestrationTrace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;modelInvocationOutput&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;metadata&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">              ...</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;rawResponse&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">              ...</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;traceId&#x27;: &#x27;ca9880a2-dae7-46ac-a480-f38ca7e2d99f-0&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    &#x27;trace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentAliasId&#x27;: &#x27;3WHEEJKNUT&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentId&#x27;: &#x27;O9KQSEVEFF&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentVersion&#x27;: &#x27;1&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;event_order&#x27;: 4,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;sessionId&#x27;: &#x27;9566a6d78551434fb0409578ffed63c1&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;trace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;orchestrationTrace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;rationale&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;text&#x27;: &#x27;To answer this question about the next Mars launch window, I will:\n\n1. Call the GET::optimal_departure_window_mars::getNext...lse values.\n\nI have verified that I have access to the GET::optimal_departure_window_mars::getNextMarsLaunchWindow function.&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;traceId&#x27;: &#x27;ca9880a2-dae7-46ac-a480-f38ca7e2d99f-0&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    &#x27;trace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentAliasId&#x27;: &#x27;3WHEEJKNUT&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentId&#x27;: &#x27;O9KQSEVEFF&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentVersion&#x27;: &#x27;1&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;event_order&#x27;: 5,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;sessionId&#x27;: &#x27;9566a6d78551434fb0409578ffed63c1&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;trace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;orchestrationTrace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;invocationInput&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;actionGroupInvocationInput&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">              ...</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;invocationType&#x27;: &#x27;ACTION_GROUP&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;traceId&#x27;: &#x27;ca9880a2-dae7-46ac-a480-f38ca7e2d99f-0&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    &#x27;trace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentAliasId&#x27;: &#x27;3WHEEJKNUT&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentId&#x27;: &#x27;O9KQSEVEFF&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentVersion&#x27;: &#x27;1&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;event_order&#x27;: 6,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;sessionId&#x27;: &#x27;9566a6d78551434fb0409578ffed63c1&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;trace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;orchestrationTrace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;observation&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;actionGroupInvocationOutput&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">              ...</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;traceId&#x27;: &#x27;ca9880a2-dae7-46ac-a480-f38ca7e2d99f-0&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;type&#x27;: &#x27;ACTION_GROUP&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    &#x27;trace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentAliasId&#x27;: &#x27;3WHEEJKNUT&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentId&#x27;: &#x27;O9KQSEVEFF&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentVersion&#x27;: &#x27;1&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;event_order&#x27;: 7,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;sessionId&#x27;: &#x27;9566a6d78551434fb0409578ffed63c1&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;trace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;orchestrationTrace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;modelInvocationInput&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;inferenceConfiguration&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">              ...</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;text&#x27;: &#x27;\n\nHuman:\nYou are a research assistant AI that has been equipped with one or more functions to help you answer a &lt;question&gt;...lta_v_available_m_s&quot;: 39457.985759929674, &quot;delta_v_required_m_s&quot;: 5595.997417810693, &quot;is_feasible&quot;: true}}&lt;/function_result&gt;\n&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;traceId&#x27;: &#x27;ca9880a2-dae7-46ac-a480-f38ca7e2d99f-1&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;type&#x27;: &#x27;ORCHESTRATION&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    &#x27;trace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentAliasId&#x27;: &#x27;3WHEEJKNUT&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentId&#x27;: &#x27;O9KQSEVEFF&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentVersion&#x27;: &#x27;1&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;event_order&#x27;: 8,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;sessionId&#x27;: &#x27;9566a6d78551434fb0409578ffed63c1&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;trace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;orchestrationTrace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;modelInvocationOutput&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;metadata&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">              ...</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;rawResponse&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">              ...</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;traceId&#x27;: &#x27;ca9880a2-dae7-46ac-a480-f38ca7e2d99f-1&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    &#x27;trace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentAliasId&#x27;: &#x27;3WHEEJKNUT&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentId&#x27;: &#x27;O9KQSEVEFF&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;agentVersion&#x27;: &#x27;1&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;event_order&#x27;: 9,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;sessionId&#x27;: &#x27;9566a6d78551434fb0409578ffed63c1&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;trace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;orchestrationTrace&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;observation&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;finalResponse&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">              ...</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;traceId&#x27;: &#x27;ca9880a2-dae7-46ac-a480-f38ca7e2d99f-1&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;type&#x27;: &#x27;FINISH&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    &#x27;chunk&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;bytes&#x27;: b</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;Based on the provided spacecraft dry mass of 10000 kg, total mass of 50000 kg, and specific impulse of 2500 s, the next optimal launch window for a Hohmann transfer from Earth to Mars is on November 26, 2026 UTC. The transfer will take 259 days.&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details>
<p>To fit this structure into MLflow&#x27;s span, we first need to go through the raw response trace and group events by their <code>traceId</code>.
After grouping the trace events by <em><code>traceId</code></em>, the structure looks like this:</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Expand to see trace grouped by <em><code>traceId</code></em></summary><div><div class="collapsibleContent_i85q"><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">{</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  &#x27;ca9880a2-dae7-46ac-a480-f38ca7e2d99f-0&#x27;: [</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;data&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;inferenceConfiguration&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;maximumLength&#x27;: 2048,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;stopSequences&#x27;: [</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;&lt;/function_call&gt;&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;&lt;/answer&gt;&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;&lt;/error&gt;&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          ],</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;temperature&#x27;: 0.0,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;topK&#x27;: 250,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;topP&#x27;: 1.0</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;text&#x27;: &#x27;\n\nHuman:\nYou are a research assistant AI that has been equipped with one or more functions to help you answer a &lt;question&gt;...\n\nAssistant: &lt;scratchpad&gt; I understand I cannot use functions that have not been provided to me to answer this question.\n\n&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;traceId&#x27;: &#x27;ca9880a2-dae7-46ac-a480-f38ca7e2d99f-0&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;type&#x27;: &#x27;ORCHESTRATION&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;event_order&#x27;: 2,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;type&#x27;: &#x27;modelInvocationInput&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;data&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;metadata&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;usage&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;inputTokens&#x27;: 5160,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;outputTokens&#x27;: 135</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;rawResponse&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;content&#x27;: &#x27;To answer this question about the next Mars launch window, I will:\n\n1. Call the GET::optimal_departure_window_mars::getNext...l&gt;\nGET::optimal_departure_window_mars::getNextMarsLaunchWindow(specific_impulse=&quot;2500&quot;, dry_mass=&quot;10000&quot;, total_mass=&quot;50000&quot;)&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;traceId&#x27;: &#x27;ca9880a2-dae7-46ac-a480-f38ca7e2d99f-0&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;event_order&#x27;: 3,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;type&#x27;: &#x27;modelInvocationOutput&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;data&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;text&#x27;: &#x27;To answer this question about the next Mars launch window, I will:\n\n1. Call the GET::optimal_departure_window_mars::getNext...lse values.\n\nI have verified that I have access to the GET::optimal_departure_window_mars::getNextMarsLaunchWindow function.&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;traceId&#x27;: &#x27;ca9880a2-dae7-46ac-a480-f38ca7e2d99f-0&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;event_order&#x27;: 4,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;type&#x27;: &#x27;rationale&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;data&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;actionGroupInvocationInput&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;actionGroupName&#x27;: &#x27;optimal_departure_window_mars&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;apiPath&#x27;: &#x27;/get-next-mars-launch-window&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;executionType&#x27;: &#x27;LAMBDA&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;parameters&#x27;: [</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">              ...</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">              ...</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">              ...</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          ],</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;verb&#x27;: &#x27;get&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;invocationType&#x27;: &#x27;ACTION_GROUP&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;traceId&#x27;: &#x27;ca9880a2-dae7-46ac-a480-f38ca7e2d99f-0&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;event_order&#x27;: 5,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;type&#x27;: &#x27;invocationInput&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;data&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;actionGroupInvocationOutput&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;text&#x27;: &#x27;{&quot;next_launch_window&quot;: {&quot;next_launch_date&quot;: &quot;2026-11-26 00:00:00&quot;, &quot;synodic_period_days&quot;: 779.9068939794238, &quot;transfer_time_days&quot;: 259, &quot;delta_v_available_m_s&quot;: 39457.985759929674, &quot;delta_v_required_m_s&quot;: 5595.997417810693, &quot;is_feasible&quot;: true}}&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;traceId&#x27;: &#x27;ca9880a2-dae7-46ac-a480-f38ca7e2d99f-0&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;type&#x27;: &#x27;ACTION_GROUP&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;event_order&#x27;: 6,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;type&#x27;: &#x27;observation&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ],</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  &#x27;ca9880a2-dae7-46ac-a480-f38ca7e2d99f-1&#x27;: [</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;data&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;inferenceConfiguration&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;maximumLength&#x27;: 2048,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;stopSequences&#x27;: [</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;&lt;/function_call&gt;&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;&lt;/answer&gt;&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;&lt;/error&gt;&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          ],</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;temperature&#x27;: 0.0,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;topK&#x27;: 250,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;topP&#x27;: 1.0</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;text&#x27;: &#x27;\n\nHuman:\nYou are a research assistant AI that has been equipped with one or more functions to help you answer a &lt;question&gt;...lta_v_available_m_s&quot;: 39457.985759929674, &quot;delta_v_required_m_s&quot;: 5595.997417810693, &quot;is_feasible&quot;: true}}&lt;/function_result&gt;\n&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;traceId&#x27;: &#x27;ca9880a2-dae7-46ac-a480-f38ca7e2d99f-1&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;type&#x27;: &#x27;ORCHESTRATION&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;event_order&#x27;: 7,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;type&#x27;: &#x27;modelInvocationInput&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;data&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;metadata&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;usage&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;inputTokens&#x27;: 5405,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;outputTokens&#x27;: 64</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;rawResponse&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;content&#x27;: &#x27;&lt;answer&gt;\nBased on the provided spacecraft dry mass of 10000 kg, total mass of 50000 kg, and specific impulse of 2500 s, the ... optimal launch window for a Hohmann transfer from Earth to Mars is on November 26, 2026 UTC. The transfer will take 259 days.&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;traceId&#x27;: &#x27;ca9880a2-dae7-46ac-a480-f38ca7e2d99f-1&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;event_order&#x27;: 8,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;type&#x27;: &#x27;modelInvocationOutput&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;data&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;finalResponse&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;text&#x27;: &#x27;Based on the provided spacecraft dry mass of 10000 kg, total mass of 50000 kg, and specific impulse of 2500 s, the next optimal launch window for a Hohmann transfer from Earth to Mars is on November 26, 2026 UTC. The transfer will take 259 days.&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;traceId&#x27;: &#x27;ca9880a2-dae7-46ac-a480-f38ca7e2d99f-1&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;type&#x27;: &#x27;FINISH&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;event_order&#x27;: 9,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;type&#x27;: &#x27;observation&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ],</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  &#x27;ca9880a2-dae7-46ac-a480-f38ca7e2d99f-pre-0&#x27;: [</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;data&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;inferenceConfiguration&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;maximumLength&#x27;: 2048,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;stopSequences&#x27;: [</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            &#x27;\n\nHuman:&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          ],</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;temperature&#x27;: 0.0,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;topK&#x27;: 250,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;topP&#x27;: 1.0</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;text&#x27;: &#x27;\n\nHuman: You are a classifying agent that filters user inputs into categories. Your job is to sort these inputs before they...&lt;thinking&gt; XML tags before providing only the category letter to sort the input into within &lt;category&gt; XML tags.\n\nAssistant:&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;traceId&#x27;: &#x27;ca9880a2-dae7-46ac-a480-f38ca7e2d99f-pre-0&#x27;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;type&#x27;: &#x27;PRE_PROCESSING&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;event_order&#x27;: 0,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;type&#x27;: &#x27;modelInvocationInput&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;data&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;parsedResponse&#x27;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;isValid&#x27;: True,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          &#x27;rationale&#x27;: &#x27;Based on the provided instructions, this input appears to be a question about orbital mechanics that can be answered using th...equired arguments for that function - specific impulse, dry mass, and total mass. Therefore, this input should be sorted into:&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &#x27;traceId&#x27;: &#x27;ca9880a2-dae7-46ac-a480-f38ca7e2d99f-pre-0&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;event_order&#x27;: 1,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &#x27;type&#x27;: &#x27;modelInvocationOutput&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details>
<p>Each group of events with the same <em><code>traceId</code></em> will contain at least two events: one of type <em><code>modelInvocationInput</code></em> and
one of type <em><code>modelInvocationOutput</code></em>. Groups that involve action group traces will also include events of type
<em><code>actionGroupInvocationInput</code></em> and <em><code>actionGroupInvocationOutput</code></em>. Similarly, groups that use knowledge bases will have
additional events of type <em><code>knowledgeBaseLookupInput</code></em> and <em><code>knowledgeBaseLookupOutput</code></em>.
In the <em><code>BedrockModel</code></em> mentioned above, it implements an approach to parse these event groups into trace nodes.
This method allows the trace to display the reasoning behind selecting action groups/knowledge bases to answer queries and invoking
the corresponding Lambda function calls, as defined in our example OpenAPI spec above.
This structure helps to clearly show the flow of information and decision-making process that bedrock agent follows.</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Here is the final mlflow trace</summary><div><div class="collapsibleContent_i85q"><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">{</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  &quot;spans&quot;: [</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;name&quot;: &quot;Bedrock Agent Runtime&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;context&quot;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;span_id&quot;: &quot;0xb802165d133a33aa&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;trace_id&quot;: &quot;0x9b8bd0b2e018d77f936e48a09e54fd44&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;parent_id&quot;: null,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;start_time&quot;: 1731388531754725000,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;end_time&quot;: 1731388550226771000,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;status_code&quot;: &quot;OK&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;status_message&quot;: &quot;&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;attributes&quot;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;mlflow.traceRequestId&quot;: &quot;\&quot;1e036cc3a7f946ec995f7763b8dde51c\&quot;&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;mlflow.spanType&quot;: &quot;\&quot;CHAT_MODEL\&quot;&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;mlflow.spanFunctionName&quot;: &quot;\&quot;predict\&quot;&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;mlflow.spanInputs&quot;: &quot;{\&quot;context\&quot;: \&quot;&lt;mlflow.pyfunc.model.PythonModelContext object at 0x13397c530&gt;\&quot;, \&quot;messages\&quot;: [{\&quot;role\&quot;: \&quot;user\&quot;, \&quot;content\&quot;: \&quot;When is the next launch window for Mars? My spacecraft&#x27;s total mass is 50000, dry mass is 10000 and specific impulse is 2500. Mass in Kg.\&quot;, \&quot;name\&quot;: null}], \&quot;params\&quot;: {\&quot;temperature\&quot;: 1.0, \&quot;max_tokens\&quot;: null, \&quot;stop\&quot;: null, \&quot;n\&quot;: 1, \&quot;stream\&quot;: false, \&quot;top_p\&quot;: null, \&quot;top_k\&quot;: null, \&quot;frequency_penalty\&quot;: null, \&quot;presence_penalty\&quot;: null}}&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;mlflow.spanOutputs&quot;: &quot;{\&quot;choices\&quot;: [{\&quot;index\&quot;: 0, \&quot;message\&quot;: {\&quot;role\&quot;: \&quot;user\&quot;, \&quot;content\&quot;: \&quot;Based on the provided spacecraft dry mass of 10000 kg, total mass of 50000 kg, and specific impulse of 2500 s, the next optimal launch window for a Hohmann transfer from Earth to Mars is on November 26, 2026 UTC. The transfer will take 259 days.\&quot;, \&quot;name\&quot;: null}, \&quot;finish_reason\&quot;: \&quot;stop\&quot;, \&quot;logprobs\&quot;: null}], \&quot;usage\&quot;: {\&quot;prompt_tokens\&quot;: null, \&quot;completion_tokens\&quot;: null, \&quot;total_tokens\&quot;: null}, \&quot;id\&quot;: null, \&quot;model\&quot;: \&quot;anthropic.claude-v2\&quot;, \&quot;object\&quot;: \&quot;chat.completion\&quot;, \&quot;created\&quot;: 1731388550}&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;events&quot;: []</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;name&quot;: &quot;Bedrock Input Prompt&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;context&quot;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;span_id&quot;: &quot;0x2e7cd730be70865b&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;trace_id&quot;: &quot;0x9b8bd0b2e018d77f936e48a09e54fd44&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;parent_id&quot;: &quot;0xb802165d133a33aa&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;start_time&quot;: 1731388531755172000,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;end_time&quot;: 1731388531755252000,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;status_code&quot;: &quot;OK&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;status_message&quot;: &quot;&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;attributes&quot;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;mlflow.traceRequestId&quot;: &quot;\&quot;1e036cc3a7f946ec995f7763b8dde51c\&quot;&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;mlflow.spanType&quot;: &quot;\&quot;UNKNOWN\&quot;&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;mlflow.spanFunctionName&quot;: &quot;\&quot;_get_agent_prompt\&quot;&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;mlflow.spanInputs&quot;: &quot;{\&quot;raw_input_question\&quot;: \&quot;When is the next launch window for Mars? My spacecraft&#x27;s total mass is 50000, dry mass is 10000 and specific impulse is 2500. Mass in Kg.\&quot;}&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;mlflow.spanOutputs&quot;: &quot;\&quot;\\n        Answer the following question and pay strong attention to the prompt:\\n        &lt;question&gt;\\n        When is the next launch window for Mars? My spacecraft&#x27;s total mass is 50000, dry mass is 10000 and specific impulse is 2500. Mass in Kg.\\n        &lt;/question&gt;\\n        &lt;instruction&gt;\\n        You have functions available at your disposal to use when anwering any questions about orbital mechanics.if you can&#x27;t find a function to answer a question about orbital mechanics, simply reply &#x27;I do not know&#x27;\\n        &lt;/instruction&gt;\\n        \&quot;&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;events&quot;: []</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;name&quot;: &quot;ACTION GROUP DECISION -optimal_departure_window_mars&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;context&quot;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;span_id&quot;: &quot;0x131e4e08cd5e95d9&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;trace_id&quot;: &quot;0x9b8bd0b2e018d77f936e48a09e54fd44&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;parent_id&quot;: &quot;0xb802165d133a33aa&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;start_time&quot;: 1731388550223219000,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;end_time&quot;: 1731388550224592000,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;status_code&quot;: &quot;OK&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;status_message&quot;: &quot;&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;attributes&quot;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;mlflow.traceRequestId&quot;: &quot;\&quot;1e036cc3a7f946ec995f7763b8dde51c\&quot;&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;mlflow.spanType&quot;: &quot;\&quot;UNKNOWN\&quot;&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;trace_attributes&quot;: &quot;[{\&quot;type\&quot;: \&quot;modelInvocationInput\&quot;, \&quot;data\&quot;: {\&quot;inferenceConfiguration\&quot;: {\&quot;maximumLength\&quot;: 2048, \&quot;stopSequences\&quot;: [\&quot;&lt;/function_call&gt;\&quot;, \&quot;&lt;/answer&gt;\&quot;, \&quot;&lt;/error&gt;\&quot;], \&quot;temperature\&quot;: 0.0, \&quot;topK\&quot;: 250, \&quot;topP\&quot;: 1.0}, \&quot;text\&quot;: \&quot;\\n\\nHuman:\\nYou are a research assistant AI that has been equipped with one or more functions to help you answer a &lt;question&gt;. Your goal is to answer the user&#x27;s question to the best of your ability, using the function(s) to gather more information if necessary to better answer the question. If you choose to call a function, the result of the function call will be added to the conversation history in &lt;function_results&gt; tags (if the call succeeded) or &lt;error&gt; tags (if the function failed). \\nYou were created with these instructions to consider as well:\\n&lt;auxiliary_instructions&gt;\\n            You are a friendly chat bot. You have access to a function called that returns\\n            information about the Mars launch window. When responding with Mars launch window,\\n            please make sure to add the timezone UTC.\\n            &lt;/auxiliary_instructions&gt;\\n\\nHere are some examples of correct action by other, different agents with access to functions that may or may not be similar to ones you are provided.\\n\\n&lt;examples&gt;\\n    &lt;example_docstring&gt; Here is an example of how you would correctly answer a question using a &lt;function_call&gt; and the corresponding &lt;function_result&gt;. Notice that you are free to think before deciding to make a &lt;function_call&gt; in the &lt;scratchpad&gt;.&lt;/example_docstring&gt;\\n    &lt;example&gt;\\n        &lt;functions&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::policyengineactions::getpolicyviolations&lt;/function_name&gt;\\n                &lt;function_description&gt;Returns a list of policy engine violations for the specified alias within the specified date range.&lt;/function_description&gt;\\n                &lt;required_argument&gt;alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument&gt;\\n                &lt;required_argument&gt;startDate (string): The start date of the range to filter violations. The format for startDate is MM/DD/YYYY.&lt;/required_argument&gt;\\n                &lt;required_argument&gt;endDate (string): The end date of the range to filter violations&lt;/required_argument&gt;\\n                &lt;returns&gt;array: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;post::policyengineactions::acknowledgeviolations&lt;/function_name&gt;\\n                &lt;function_description&gt;Acknowledge policy engine violation. Generally used to acknowledge violation, once user notices a violation under their alias or their managers alias.&lt;/function_description&gt;\\n                &lt;required_argument&gt;policyId (string): The ID of the policy violation&lt;/required_argument&gt;\\n                &lt;required_argument&gt;expectedDateOfResolution (string): The date by when the violation will be addressed/resolved&lt;/required_argument&gt;\\n                &lt;returns&gt;object: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::activedirectoryactions::getmanager&lt;/function_name&gt;\\n                &lt;function_description&gt;This API is used to identify the manager hierarchy above a given person. Every person could have a manager and the manager could have another manager to which they report to&lt;/function_description&gt;\\n                &lt;required_argument&gt;alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument&gt;\\n                &lt;returns&gt;object: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            \\n        &lt;/functions&gt;\\n\\n        &lt;question&gt;Can you show me my policy engine violation from 1st january 2023 to 1st february 2023? My alias is jsmith.&lt;/question&gt;\\n        &lt;scratchpad&gt;\\n            To answer this question, I will need to:\\n            1. I do not have knowledge to policy engine violations, so I should see if I can use any of the available functions to help. I have been equipped with get::policyengineactions::getpolicyviolations that gets the policy engine violations for a given alias, start date and end date. I will use this function to gather more information.\\n        &lt;/scratchpad&gt;\\n        &lt;function_call&gt;get::policyengineactions::getpolicyviolations(alias=\\\&quot;jsmith\\\&quot;, startDate=\\\&quot;1st January 2023\\\&quot;, endDate=\\\&quot;1st February 2023\\\&quot;)&lt;/function_call&gt;\\n        &lt;function_result&gt;{response: [{creationDate: \\\&quot;2023-06-01T09:30:00Z\\\&quot;, riskLevel: \\\&quot;High\\\&quot;, policyId: \\\&quot;POL-001\\\&quot;, policyUrl: \\\&quot;https://example.com/policies/POL-001\\\&quot;, referenceUrl: \\\&quot;https://example.com/violations/POL-001\\\&quot;}, {creationDate: \\\&quot;2023-06-02T14:45:00Z\\\&quot;, riskLevel: \\\&quot;Medium\\\&quot;, policyId: \\\&quot;POL-002\\\&quot;, policyUrl: \\\&quot;https://example.com/policies/POL-002\\\&quot;, referenceUrl: \\\&quot;https://example.com/violations/POL-002\\\&quot;}]}&lt;/function_result&gt;\\n        &lt;answer&gt;The policy engine violations between 1st january 2023 to 1st february 2023 for alias jsmith are - Policy ID: POL-001, Policy ID: POL-002&lt;/answer&gt;\\n    &lt;/example&gt;\\n\\n    &lt;example_docstring&gt;Here is another example that utilizes multiple function calls.&lt;/example_docstring&gt;\\n    &lt;example&gt;\\n        &lt;functions&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::policyengineactions::getpolicyviolations&lt;/function_name&gt;\\n                &lt;function_description&gt;Returns a list of policy engine violations for the specified alias within the specified date range.&lt;/function_description&gt;\\n                &lt;required_argument&gt;alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument&gt;\\n                &lt;required_argument&gt;startDate (string): The start date of the range to filter violations. The format for startDate is MM/DD/YYYY.&lt;/required_argument&gt;\\n                &lt;required_argument&gt;endDate (string): The end date of the range to filter violations&lt;/required_argument&gt;\\n                &lt;returns&gt;array: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;post::policyengineactions::acknowledgeviolations&lt;/function_name&gt;\\n                &lt;function_description&gt;Acknowledge policy engine violation. Generally used to acknowledge violation, once user notices a violation under their alias or their managers alias.&lt;/function_description&gt;\\n                &lt;required_argument&gt;policyId (string): The ID of the policy violation&lt;/required_argument&gt;\\n                &lt;required_argument&gt;expectedDateOfResolution (string): The date by when the violation will be addressed/resolved&lt;/required_argument&gt;\\n                &lt;returns&gt;object: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::activedirectoryactions::getmanager&lt;/function_name&gt;\\n                &lt;function_description&gt;This API is used to identify the manager hierarchy above a given person. Every person could have a manager and the manager could have another manager to which they report to&lt;/function_description&gt;\\n                &lt;required_argument&gt;alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument&gt;\\n                &lt;returns&gt;object: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            \\n        &lt;/functions&gt;\\n        &lt;question&gt;Can you check the policy engine violations under my manager between 2nd May to 5th May? My alias is john.&lt;/question&gt;\\n        &lt;scratchpad&gt;\\n            To answer this question, I will need to:\\n            1. Get the manager alias of the user using get::activedirectoryactions::getmanager function.\\n            2. Use the returned manager alias to get the policy engine violations using the get::policyengineactions::getpolicyviolations function.\\n\\n            I have double checked and made sure that I have been provided the get::activedirectoryactions::getmanager and the get::policyengineactions::getpolicyviolations functions.\\n        &lt;/scratchpad&gt;\\n        &lt;function_call&gt;get::activedirectoryactions::getmanager(alias=\\\&quot;john\\\&quot;)&lt;/function_call&gt;\\n        &lt;function_result&gt;{response: {managerAlias: \\\&quot;mark\\\&quot;, managerLevel: \\\&quot;6\\\&quot;, teamName: \\\&quot;Builder\\\&quot;, managerName: \\\&quot;Mark Hunter\\\&quot;}}}}&lt;/function_result&gt;\\n        &lt;scratchpad&gt;\\n            1. I have the managerAlias from the function results as mark and I have the start and end date from the user input. I can use the function result to call get::policyengineactions::getpolicyviolations function.\\n            2. I will then return the get::policyengineactions::getpolicyviolations function result to the user.\\n\\n            I have double checked and made sure that I have been provided the get::policyengineactions::getpolicyviolations functions.\\n        &lt;/scratchpad&gt;\\n        &lt;function_call&gt;get::policyengineactions::getpolicyviolations(alias=\\\&quot;mark\\\&quot;, startDate=\\\&quot;2nd May 2023\\\&quot;, endDate=\\\&quot;5th May 2023\\\&quot;)&lt;/function_call&gt;\\n        &lt;function_result&gt;{response: [{creationDate: \\\&quot;2023-05-02T09:30:00Z\\\&quot;, riskLevel: \\\&quot;High\\\&quot;, policyId: \\\&quot;POL-001\\\&quot;, policyUrl: \\\&quot;https://example.com/policies/POL-001\\\&quot;, referenceUrl: \\\&quot;https://example.com/violations/POL-001\\\&quot;}, {creationDate: \\\&quot;2023-05-04T14:45:00Z\\\&quot;, riskLevel: \\\&quot;Low\\\&quot;, policyId: \\\&quot;POL-002\\\&quot;, policyUrl: \\\&quot;https://example.com/policies/POL-002\\\&quot;, referenceUrl: \\\&quot;https://example.com/violations/POL-002\\\&quot;}]}&lt;/function_result&gt;\\n        &lt;answer&gt;\\n            The policy engine violations between 2nd May 2023 to 5th May 2023 for your manager&#x27;s alias mark are - Policy ID: POL-001, Policy ID: POL-002\\n        &lt;/answer&gt;\\n    &lt;/example&gt;\\n\\n    &lt;example_docstring&gt;Functions can also be search engine API&#x27;s that issue a query to a knowledge base. Here is an example that utilizes regular function calls in combination with function calls to a search engine API. Please make sure to extract the source for the information within the final answer when using information returned from the search engine.&lt;/example_docstring&gt;\\n    &lt;example&gt;\\n        &lt;functions&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::benefitsaction::getbenefitplanname&lt;/function_name&gt;\\n                &lt;function_description&gt;Get&#x27;s the benefit plan name for a user. The API takes in a userName and a benefit type and returns the benefit name to the user (i.e. Aetna, Premera, Fidelity, etc.).&lt;/function_description&gt;\\n                &lt;optional_argument&gt;userName (string): None&lt;/optional_argument&gt;\\n                &lt;optional_argument&gt;benefitType (string): None&lt;/optional_argument&gt;\\n                &lt;returns&gt;object: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;post::benefitsaction::increase401klimit&lt;/function_name&gt;\\n                &lt;function_description&gt;Increases the 401k limit for a generic user. The API takes in only the current 401k limit and returns the new limit.&lt;/function_description&gt;\\n                &lt;optional_argument&gt;currentLimit (string): None&lt;/optional_argument&gt;\\n                &lt;returns&gt;object: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::x_amz_knowledgebase_dentalinsurance::search&lt;/function_name&gt;\\n                &lt;function_description&gt;This is a search tool that provides information about Delta Dental benefits. It has information about covered dental benefits and other relevant information&lt;/function_description&gt;\\n                &lt;required_argument&gt;query(string): A full sentence query that is fed to the search tool&lt;/required_argument&gt;\\n                &lt;returns&gt;Returns string  related to the user query asked.&lt;/returns&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::x_amz_knowledgebase_401kplan::search&lt;/function_name&gt;\\n                &lt;function_description&gt;This is a search tool that provides information about Amazon 401k plan benefits. It can determine what a person&#x27;s yearly 401k contribution limit is, based on their age.&lt;/function_description&gt;\\n                &lt;required_argument&gt;query(string): A full sentence query that is fed to the search tool&lt;/required_argument&gt;\\n                &lt;returns&gt;Returns string  related to the user query asked.&lt;/returns&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::x_amz_knowledgebase_healthinsurance::search&lt;/function_name&gt;\\n                &lt;function_description&gt;This is a search tool that provides information about Aetna and Premera health benefits. It has information about the savings plan and shared deductible plan, as well as others.&lt;/function_description&gt;\\n                &lt;required_argument&gt;query(string): A full sentence query that is fed to the search tool&lt;/required_argument&gt;\\n                &lt;returns&gt;Returns string  related to the user query asked.&lt;/returns&gt;\\n            &lt;/function&gt;\\n            \\n        &lt;/functions&gt;\\n\\n        &lt;question&gt;What is my deductible? My username is Bob and my benefitType is Dental. Also, what is the 401k yearly contribution limit?&lt;/question&gt;\\n        &lt;scratchpad&gt; I understand I cannot use functions that have not been provided to me to answer this question.\\n            To answer this question, I will:\\n            1. Call the get::benefitsaction::getbenefitplanname function to get the benefit plan name for the user Bob with benefit type Dental.\\n            2. Call the get::x_amz_knowledgebase_dentalinsurance::search function to search for information about deductibles for the plan name returned from step 1.\\n            3. Call the get::x_amz_knowledgebase_401k::search function to search for information about 401k yearly contribution limits.\\n            4. Return the deductible information from the search results to the user.\\n            I have checked that I have access to the get::benefitsaction::getbenefitplanname, x_amz_knowledgebase_dentalinsurance::search, and x_amz_knowledgebase_401k::search functions.\\n        &lt;/scratchpad&gt;\\n        &lt;function_call&gt;get::benefitsaction::getbenefitplanname(userName=\\\&quot;Bob\\\&quot;, benefitType=\\\&quot;Dental\\\&quot;)&lt;/function_call&gt;\\n        &lt;function_result&gt;{{&#x27;response&#x27;: {{&#x27;planName&#x27;: &#x27;Delta Dental&#x27;}}}}&lt;/function_result&gt;\\n        &lt;scratchpad&gt;\\n            I have received the plan name Delta Dental for the user Bob with Dental benefits. I will now call the x_amz_knowledgebase_dentalinsurance::search function to find deductible information for Delta Dental.\\n        &lt;/scratchpad&gt;\\n        &lt;function_call&gt;get::x_amz_knowledgebase_dentalinsurance::search(searchQuery=\\\&quot;What is the deductible for Delta Dental?\\\&quot;)&lt;/function_call&gt;\\n        &lt;function_result&gt;{{&#x27;response&#x27;: {{&#x27;responseCode&#x27;: &#x27;200&#x27;, &#x27;responseBody&#x27;: \\\&quot;\\\&quot;&lt;answer&gt;\\\\n&lt;answer_part&gt;\\\\n&lt;text&gt;The user&#x27;s individual deductible is $50 per benefit period&lt;/text&gt;\\\\n&lt;source&gt;dfe040f8-46ed-4a65-b3ea-529fa55f6b9e&lt;/source&gt;\\\\n&lt;/answer_part&gt;\\\\n&lt;answer_part&gt;\\\\n&lt;text&gt;If they are enrolled with dependents, the maximum family deductible is $150 per benefit period.&lt;/text&gt;\\\\n&lt;source&gt;0e666064-31d8-4223-b7ba-8eecf40b7b47&lt;/source&gt;\\\\n&lt;/answer_part&gt;\\\\n&lt;/answer&gt;\\\&quot;}}}}&lt;/function_result&gt; &lt;scratchpad&gt;\\n            I have found the deductible information for Dental benefits. I will now call the x_amz_knowledgebase_401k::search function to find yearly 401k contribution limits.\\n        &lt;/scratchpad&gt;\\n        &lt;function_call&gt;get::x_amz_knowledgebase_401k::search(searchQuery=\\\&quot;What is the yearly 401k contribution limit?\\\&quot;)&lt;/function_call&gt;\\n        &lt;function_result&gt;{{&#x27;response&#x27;: {{&#x27;responseCode&#x27;: &#x27;200&#x27;, &#x27;responseBody&#x27;: \\\&quot;&lt;answer&gt;\\\\n&lt;answer_part&gt;\\\\n&lt;text&gt;The yearly 401k contribution limit is $20,500.&lt;/text&gt;\\\\n&lt;source&gt;c546cbe8-07f6-45d1-90ca-74d87ab2885a&lt;/source&gt;\\\\n&lt;/answer_part&gt;\\\\n&lt;/answer&gt;\\\&quot;}}}}&lt;/function_result&gt;\\n        &lt;answer&gt;\\n            &lt;answer_part&gt;\\n                &lt;text&gt;The deductible for your Delta Dental plan is $50 per benefit period.&lt;/text&gt;\\n                &lt;source&gt;dfe040f8-46ed-4a65-b3ea-529fa55f6b9e&lt;/source&gt;\\n            &lt;/answer_part&gt;\\n            &lt;answer_part&gt;\\n                &lt;text&gt;If you have dependents enrolled, the maximum family deductible is $150 per benefit period.&lt;/text&gt;\\n                &lt;source&gt;0e666064-31d8-4223-b7ba-8eecf40b7b47&lt;/source&gt;\\n            &lt;/answer_part&gt;\\n            &lt;answer_part&gt;\\n                &lt;text&gt;The yearly 401k contribution limit is $20,500.&lt;/text&gt;\\n                &lt;source&gt;c546cbe8-07f6-45d1-90ca-74d87ab2885a&lt;/source&gt;\\n            &lt;/answer_part&gt;\\n        &lt;/answer&gt;\\n    &lt;/example&gt;\\n\\n    \\n\\n    &lt;example_docstring&gt;Here&#x27;s a final example where the question asked could not be answered with information gathered from calling the provided functions. In this example, notice how you respond by telling the user you cannot answer, without using a function that was not provided to you.&lt;/example_docstring&gt;\\n    &lt;example&gt;\\n        &lt;functions&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::policyengineactions::getpolicyviolations&lt;/function_name&gt;\\n                &lt;function_description&gt;Returns a list of policy engine violations for the specified alias within the specified date range.&lt;/function_description&gt;\\n                &lt;required_argument&gt;alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument&gt;\\n                &lt;required_argument&gt;startDate (string): The start date of the range to filter violations. The format for startDate is MM/DD/YYYY.&lt;/required_argument&gt;\\n                &lt;required_argument&gt;endDate (string): The end date of the range to filter violations&lt;/required_argument&gt;\\n                &lt;returns&gt;array: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;post::policyengineactions::acknowledgeviolations&lt;/function_name&gt;\\n                &lt;function_description&gt;Acknowledge policy engine violation. Generally used to acknowledge violation, once user notices a violation under their alias or their managers alias.&lt;/function_description&gt;\\n                &lt;required_argument&gt;policyId (string): The ID of the policy violation&lt;/required_argument&gt;\\n                &lt;required_argument&gt;expectedDateOfResolution (string): The date by when the violation will be addressed/resolved&lt;/required_argument&gt;\\n                &lt;returns&gt;object: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::activedirectoryactions::getmanager&lt;/function_name&gt;\\n                &lt;function_description&gt;This API is used to identify the manager hierarchy above a given person. Every person could have a manager and the manager could have another manager to which they report to&lt;/function_description&gt;\\n                &lt;required_argument&gt;alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument&gt;\\n                &lt;returns&gt;object: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            \\n        &lt;/functions&gt;\\n        &lt;question&gt;Who are the reportees of David?&lt;/question&gt;\\n        &lt;scratchpad&gt;\\n            After reviewing the functions I was equipped with, I realize I am not able to accurately answer this question since I can&#x27;t access reportees of David. Therefore, I should explain to the user I cannot answer this question.\\n        &lt;/scratchpad&gt;\\n        &lt;answer&gt;\\n            Sorry, I am unable to assist you with this request.\\n        &lt;/answer&gt;\\n    &lt;/example&gt;\\n&lt;/examples&gt;\\n\\nThe above examples have been provided to you to illustrate general guidelines and format for use of function calling for information retrieval, and how to use your scratchpad to plan your approach. IMPORTANT: the functions provided within the examples should not be assumed to have been provided to you to use UNLESS they are also explicitly given to you within &lt;functions&gt;&lt;/functions&gt; tags below. All of the values and information within the examples (the questions, function results, and answers) are strictly part of the examples and have not been provided to you.\\n\\nNow that you have read and understood the examples, I will define the functions that you have available to you to use. Here is a comprehensive list.\\n\\n&lt;functions&gt;\\n&lt;function&gt;\\n&lt;function_name&gt;GET::optimal_departure_window_mars::getNextMarsLaunchWindow&lt;/function_name&gt;\\n&lt;function_description&gt;Gets the next optimal launch window to Mars.&lt;/function_description&gt;\\n&lt;required_argument&gt;specific_impulse (string): Specific impulse of the propulsion system (s).&lt;/required_argument&gt;\\n&lt;required_argument&gt;dry_mass (string): Mass of the spacecraft without fuel (kg).&lt;/required_argument&gt;\\n&lt;required_argument&gt;total_mass (string): Total mass of the spacecraft including fuel (kg)&lt;/required_argument&gt;\\n&lt;returns&gt;object: The next optimal departure date for a Hohmann transfer from Earth to Mars, based on the spacecraft&#x27;s mass and specific impulse.&lt;/returns&gt;\\n&lt;/function&gt;\\n\\n\\n&lt;/functions&gt;\\n\\nNote that the function arguments have been listed in the order that they should be passed into the function.\\n\\n\\n\\nDo not modify or extend the provided functions under any circumstances. For example, GET::optimal_departure_window_mars::getNextMarsLaunchWindow with additional parameters would be considered modifying the function which is not allowed. Please use the functions only as defined.\\n\\nDO NOT use any functions that I have not equipped you with.\\n\\n Do not make assumptions about inputs; instead, make sure you know the exact function and input to use before you call a function.\\n\\nTo call a function, output the name of the function in between &lt;function_call&gt; and &lt;/function_call&gt; tags. You will receive a &lt;function_result&gt; in response to your call that contains information that you can use to better answer the question. Or, if the function call produced an error, you will receive an &lt;error&gt; in response.\\n\\n\\n\\nThe format for all other &lt;function_call&gt; MUST be: &lt;function_call&gt;$FUNCTION_NAME($FUNCTION_PARAMETER_NAME=$FUNCTION_PARAMETER_VALUE)&lt;/function_call&gt;\\n\\nRemember, your goal is to answer the user&#x27;s question to the best of your ability, using only the function(s) provided within the &lt;functions&gt;&lt;/functions&gt; tags to gather more information if necessary to better answer the question.\\n\\nDo not modify or extend the provided functions under any circumstances. For example, calling GET::optimal_departure_window_mars::getNextMarsLaunchWindow with additional parameters would be modifying the function which is not allowed. Please use the functions only as defined.\\n\\nBefore calling any functions, create a plan for performing actions to answer this question within the &lt;scratchpad&gt;. Double check your plan to make sure you don&#x27;t call any functions that you haven&#x27;t been provided with. Always return your final answer within &lt;answer&gt;&lt;/answer&gt; tags.\\n\\n\\n\\nThe user input is &lt;question&gt;Answer the following question and pay strong attention to the prompt:\\n        &lt;question&gt;\\n        When is the next launch window for Mars? My spacecraft&#x27;s total mass is 50000, dry mass is 10000 and specific impulse is 2500. Mass in Kg.\\n        &lt;/question&gt;\\n        &lt;instruction&gt;\\n        You have functions available at your disposal to use when anwering any questions about orbital mechanics.if you can&#x27;t find a function to answer a question about orbital mechanics, simply reply &#x27;I do not know&#x27;\\n        &lt;/instruction&gt;&lt;/question&gt;\\n\\n\\nAssistant: &lt;scratchpad&gt; I understand I cannot use functions that have not been provided to me to answer this question.\\n\\n\&quot;, \&quot;traceId\&quot;: \&quot;e0b2b2c2-fb7c-4e17-8a1f-a3781100face-0\&quot;, \&quot;type\&quot;: \&quot;ORCHESTRATION\&quot;}, \&quot;event_order\&quot;: 2}, {\&quot;type\&quot;: \&quot;modelInvocationOutput\&quot;, \&quot;data\&quot;: {\&quot;metadata\&quot;: {\&quot;usage\&quot;: {\&quot;inputTokens\&quot;: 5160, \&quot;outputTokens\&quot;: 135}}, \&quot;rawResponse\&quot;: {\&quot;content\&quot;: \&quot;To answer this question about the next Mars launch window, I will:\\n\\n1. Call the GET::optimal_departure_window_mars::getNextMarsLaunchWindow function to get the next optimal launch window, passing in the provided spacecraft mass and specific impulse values.\\n\\nI have verified that I have access to the GET::optimal_departure_window_mars::getNextMarsLaunchWindow function.\\n\\n&lt;/scratchpad&gt;\\n\\n&lt;function_call&gt;\\nGET::optimal_departure_window_mars::getNextMarsLaunchWindow(specific_impulse=\\\&quot;2500\\\&quot;, dry_mass=\\\&quot;10000\\\&quot;, total_mass=\\\&quot;50000\\\&quot;)\&quot;}, \&quot;traceId\&quot;: \&quot;e0b2b2c2-fb7c-4e17-8a1f-a3781100face-0\&quot;}, \&quot;event_order\&quot;: 3}, {\&quot;type\&quot;: \&quot;rationale\&quot;, \&quot;data\&quot;: {\&quot;text\&quot;: \&quot;To answer this question about the next Mars launch window, I will:\\n\\n1. Call the GET::optimal_departure_window_mars::getNextMarsLaunchWindow function to get the next optimal launch window, passing in the provided spacecraft mass and specific impulse values.\\n\\nI have verified that I have access to the GET::optimal_departure_window_mars::getNextMarsLaunchWindow function.\&quot;, \&quot;traceId\&quot;: \&quot;e0b2b2c2-fb7c-4e17-8a1f-a3781100face-0\&quot;}, \&quot;event_order\&quot;: 4}, {\&quot;type\&quot;: \&quot;invocationInput\&quot;, \&quot;data\&quot;: {\&quot;actionGroupInvocationInput\&quot;: {\&quot;actionGroupName\&quot;: \&quot;optimal_departure_window_mars\&quot;, \&quot;apiPath\&quot;: \&quot;/get-next-mars-launch-window\&quot;, \&quot;executionType\&quot;: \&quot;LAMBDA\&quot;, \&quot;parameters\&quot;: [{\&quot;name\&quot;: \&quot;total_mass\&quot;, \&quot;type\&quot;: \&quot;string\&quot;, \&quot;value\&quot;: \&quot;50000\&quot;}, {\&quot;name\&quot;: \&quot;dry_mass\&quot;, \&quot;type\&quot;: \&quot;string\&quot;, \&quot;value\&quot;: \&quot;10000\&quot;}, {\&quot;name\&quot;: \&quot;specific_impulse\&quot;, \&quot;type\&quot;: \&quot;string\&quot;, \&quot;value\&quot;: \&quot;2500\&quot;}], \&quot;verb\&quot;: \&quot;get\&quot;}, \&quot;invocationType\&quot;: \&quot;ACTION_GROUP\&quot;, \&quot;traceId\&quot;: \&quot;e0b2b2c2-fb7c-4e17-8a1f-a3781100face-0\&quot;}, \&quot;event_order\&quot;: 5}, {\&quot;type\&quot;: \&quot;observation\&quot;, \&quot;data\&quot;: {\&quot;actionGroupInvocationOutput\&quot;: {\&quot;text\&quot;: \&quot;{\\\&quot;next_launch_window\\\&quot;: {\\\&quot;next_launch_date\\\&quot;: \\\&quot;2026-11-26 00:00:00\\\&quot;, \\\&quot;synodic_period_days\\\&quot;: 779.9068939794238, \\\&quot;transfer_time_days\\\&quot;: 259, \\\&quot;delta_v_available_m_s\\\&quot;: 39457.985759929674, \\\&quot;delta_v_required_m_s\\\&quot;: 5595.997417810693, \\\&quot;is_feasible\\\&quot;: true}}\&quot;}, \&quot;traceId\&quot;: \&quot;e0b2b2c2-fb7c-4e17-8a1f-a3781100face-0\&quot;, \&quot;type\&quot;: \&quot;ACTION_GROUP\&quot;}, \&quot;event_order\&quot;: 6}]&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;mlflow.spanFunctionName&quot;: &quot;\&quot;_trace_agent_pre_context\&quot;&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;mlflow.spanInputs&quot;: &quot;{\&quot;inner_input_trace\&quot;: \&quot;\\n\\nHuman:\\nYou are a research assistant AI that has been equipped with one or more functions to help you answer a &lt;question&gt;. Your goal is to answer the user&#x27;s question to the best of your ability, using the function(s) to gather more information if necessary to better answer the question. If you choose to call a function, the result of the function call will be added to the conversation history in &lt;function_results&gt; tags (if the call succeeded) or &lt;error&gt; tags (if the function failed). \\nYou were created with these instructions to consider as well:\\n&lt;auxiliary_instructions&gt;\\n            You are a friendly chat bot. You have access to a function called that returns\\n            information about the Mars launch window. When responding with Mars launch window,\\n            please make sure to add the timezone UTC.\\n            &lt;/auxiliary_instructions&gt;\\n\\nHere are some examples of correct action by other, different agents with access to functions that may or may not be similar to ones you are provided.\\n\\n&lt;examples&gt;\\n    &lt;example_docstring&gt; Here is an example of how you would correctly answer a question using a &lt;function_call&gt; and the corresponding &lt;function_result&gt;. Notice that you are free to think before deciding to make a &lt;function_call&gt; in the &lt;scratchpad&gt;.&lt;/example_docstring&gt;\\n    &lt;example&gt;\\n        &lt;functions&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::policyengineactions::getpolicyviolations&lt;/function_name&gt;\\n                &lt;function_description&gt;Returns a list of policy engine violations for the specified alias within the specified date range.&lt;/function_description&gt;\\n                &lt;required_argument&gt;alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument&gt;\\n                &lt;required_argument&gt;startDate (string): The start date of the range to filter violations. The format for startDate is MM/DD/YYYY.&lt;/required_argument&gt;\\n                &lt;required_argument&gt;endDate (string): The end date of the range to filter violations&lt;/required_argument&gt;\\n                &lt;returns&gt;array: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;post::policyengineactions::acknowledgeviolations&lt;/function_name&gt;\\n                &lt;function_description&gt;Acknowledge policy engine violation. Generally used to acknowledge violation, once user notices a violation under their alias or their managers alias.&lt;/function_description&gt;\\n                &lt;required_argument&gt;policyId (string): The ID of the policy violation&lt;/required_argument&gt;\\n                &lt;required_argument&gt;expectedDateOfResolution (string): The date by when the violation will be addressed/resolved&lt;/required_argument&gt;\\n                &lt;returns&gt;object: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::activedirectoryactions::getmanager&lt;/function_name&gt;\\n                &lt;function_description&gt;This API is used to identify the manager hierarchy above a given person. Every person could have a manager and the manager could have another manager to which they report to&lt;/function_description&gt;\\n                &lt;required_argument&gt;alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument&gt;\\n                &lt;returns&gt;object: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            \\n        &lt;/functions&gt;\\n\\n        &lt;question&gt;Can you show me my policy engine violation from 1st january 2023 to 1st february 2023? My alias is jsmith.&lt;/question&gt;\\n        &lt;scratchpad&gt;\\n            To answer this question, I will need to:\\n            1. I do not have knowledge to policy engine violations, so I should see if I can use any of the available functions to help. I have been equipped with get::policyengineactions::getpolicyviolations that gets the policy engine violations for a given alias, start date and end date. I will use this function to gather more information.\\n        &lt;/scratchpad&gt;\\n        &lt;function_call&gt;get::policyengineactions::getpolicyviolations(alias=\\\&quot;jsmith\\\&quot;, startDate=\\\&quot;1st January 2023\\\&quot;, endDate=\\\&quot;1st February 2023\\\&quot;)&lt;/function_call&gt;\\n        &lt;function_result&gt;{response: [{creationDate: \\\&quot;2023-06-01T09:30:00Z\\\&quot;, riskLevel: \\\&quot;High\\\&quot;, policyId: \\\&quot;POL-001\\\&quot;, policyUrl: \\\&quot;https://example.com/policies/POL-001\\\&quot;, referenceUrl: \\\&quot;https://example.com/violations/POL-001\\\&quot;}, {creationDate: \\\&quot;2023-06-02T14:45:00Z\\\&quot;, riskLevel: \\\&quot;Medium\\\&quot;, policyId: \\\&quot;POL-002\\\&quot;, policyUrl: \\\&quot;https://example.com/policies/POL-002\\\&quot;, referenceUrl: \\\&quot;https://example.com/violations/POL-002\\\&quot;}]}&lt;/function_result&gt;\\n        &lt;answer&gt;The policy engine violations between 1st january 2023 to 1st february 2023 for alias jsmith are - Policy ID: POL-001, Policy ID: POL-002&lt;/answer&gt;\\n    &lt;/example&gt;\\n\\n    &lt;example_docstring&gt;Here is another example that utilizes multiple function calls.&lt;/example_docstring&gt;\\n    &lt;example&gt;\\n        &lt;functions&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::policyengineactions::getpolicyviolations&lt;/function_name&gt;\\n                &lt;function_description&gt;Returns a list of policy engine violations for the specified alias within the specified date range.&lt;/function_description&gt;\\n                &lt;required_argument&gt;alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument&gt;\\n                &lt;required_argument&gt;startDate (string): The start date of the range to filter violations. The format for startDate is MM/DD/YYYY.&lt;/required_argument&gt;\\n                &lt;required_argument&gt;endDate (string): The end date of the range to filter violations&lt;/required_argument&gt;\\n                &lt;returns&gt;array: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;post::policyengineactions::acknowledgeviolations&lt;/function_name&gt;\\n                &lt;function_description&gt;Acknowledge policy engine violation. Generally used to acknowledge violation, once user notices a violation under their alias or their managers alias.&lt;/function_description&gt;\\n                &lt;required_argument&gt;policyId (string): The ID of the policy violation&lt;/required_argument&gt;\\n                &lt;required_argument&gt;expectedDateOfResolution (string): The date by when the violation will be addressed/resolved&lt;/required_argument&gt;\\n                &lt;returns&gt;object: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::activedirectoryactions::getmanager&lt;/function_name&gt;\\n                &lt;function_description&gt;This API is used to identify the manager hierarchy above a given person. Every person could have a manager and the manager could have another manager to which they report to&lt;/function_description&gt;\\n                &lt;required_argument&gt;alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument&gt;\\n                &lt;returns&gt;object: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            \\n        &lt;/functions&gt;\\n        &lt;question&gt;Can you check the policy engine violations under my manager between 2nd May to 5th May? My alias is john.&lt;/question&gt;\\n        &lt;scratchpad&gt;\\n            To answer this question, I will need to:\\n            1. Get the manager alias of the user using get::activedirectoryactions::getmanager function.\\n            2. Use the returned manager alias to get the policy engine violations using the get::policyengineactions::getpolicyviolations function.\\n\\n            I have double checked and made sure that I have been provided the get::activedirectoryactions::getmanager and the get::policyengineactions::getpolicyviolations functions.\\n        &lt;/scratchpad&gt;\\n        &lt;function_call&gt;get::activedirectoryactions::getmanager(alias=\\\&quot;john\\\&quot;)&lt;/function_call&gt;\\n        &lt;function_result&gt;{response: {managerAlias: \\\&quot;mark\\\&quot;, managerLevel: \\\&quot;6\\\&quot;, teamName: \\\&quot;Builder\\\&quot;, managerName: \\\&quot;Mark Hunter\\\&quot;}}}}&lt;/function_result&gt;\\n        &lt;scratchpad&gt;\\n            1. I have the managerAlias from the function results as mark and I have the start and end date from the user input. I can use the function result to call get::policyengineactions::getpolicyviolations function.\\n            2. I will then return the get::policyengineactions::getpolicyviolations function result to the user.\\n\\n            I have double checked and made sure that I have been provided the get::policyengineactions::getpolicyviolations functions.\\n        &lt;/scratchpad&gt;\\n        &lt;function_call&gt;get::policyengineactions::getpolicyviolations(alias=\\\&quot;mark\\\&quot;, startDate=\\\&quot;2nd May 2023\\\&quot;, endDate=\\\&quot;5th May 2023\\\&quot;)&lt;/function_call&gt;\\n        &lt;function_result&gt;{response: [{creationDate: \\\&quot;2023-05-02T09:30:00Z\\\&quot;, riskLevel: \\\&quot;High\\\&quot;, policyId: \\\&quot;POL-001\\\&quot;, policyUrl: \\\&quot;https://example.com/policies/POL-001\\\&quot;, referenceUrl: \\\&quot;https://example.com/violations/POL-001\\\&quot;}, {creationDate: \\\&quot;2023-05-04T14:45:00Z\\\&quot;, riskLevel: \\\&quot;Low\\\&quot;, policyId: \\\&quot;POL-002\\\&quot;, policyUrl: \\\&quot;https://example.com/policies/POL-002\\\&quot;, referenceUrl: \\\&quot;https://example.com/violations/POL-002\\\&quot;}]}&lt;/function_result&gt;\\n        &lt;answer&gt;\\n            The policy engine violations between 2nd May 2023 to 5th May 2023 for your manager&#x27;s alias mark are - Policy ID: POL-001, Policy ID: POL-002\\n        &lt;/answer&gt;\\n    &lt;/example&gt;\\n\\n    &lt;example_docstring&gt;Functions can also be search engine API&#x27;s that issue a query to a knowledge base. Here is an example that utilizes regular function calls in combination with function calls to a search engine API. Please make sure to extract the source for the information within the final answer when using information returned from the search engine.&lt;/example_docstring&gt;\\n    &lt;example&gt;\\n        &lt;functions&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::benefitsaction::getbenefitplanname&lt;/function_name&gt;\\n                &lt;function_description&gt;Get&#x27;s the benefit plan name for a user. The API takes in a userName and a benefit type and returns the benefit name to the user (i.e. Aetna, Premera, Fidelity, etc.).&lt;/function_description&gt;\\n                &lt;optional_argument&gt;userName (string): None&lt;/optional_argument&gt;\\n                &lt;optional_argument&gt;benefitType (string): None&lt;/optional_argument&gt;\\n                &lt;returns&gt;object: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;post::benefitsaction::increase401klimit&lt;/function_name&gt;\\n                &lt;function_description&gt;Increases the 401k limit for a generic user. The API takes in only the current 401k limit and returns the new limit.&lt;/function_description&gt;\\n                &lt;optional_argument&gt;currentLimit (string): None&lt;/optional_argument&gt;\\n                &lt;returns&gt;object: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::x_amz_knowledgebase_dentalinsurance::search&lt;/function_name&gt;\\n                &lt;function_description&gt;This is a search tool that provides information about Delta Dental benefits. It has information about covered dental benefits and other relevant information&lt;/function_description&gt;\\n                &lt;required_argument&gt;query(string): A full sentence query that is fed to the search tool&lt;/required_argument&gt;\\n                &lt;returns&gt;Returns string  related to the user query asked.&lt;/returns&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::x_amz_knowledgebase_401kplan::search&lt;/function_name&gt;\\n                &lt;function_description&gt;This is a search tool that provides information about Amazon 401k plan benefits. It can determine what a person&#x27;s yearly 401k contribution limit is, based on their age.&lt;/function_description&gt;\\n                &lt;required_argument&gt;query(string): A full sentence query that is fed to the search tool&lt;/required_argument&gt;\\n                &lt;returns&gt;Returns string  related to the user query asked.&lt;/returns&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::x_amz_knowledgebase_healthinsurance::search&lt;/function_name&gt;\\n                &lt;function_description&gt;This is a search tool that provides information about Aetna and Premera health benefits. It has information about the savings plan and shared deductible plan, as well as others.&lt;/function_description&gt;\\n                &lt;required_argument&gt;query(string): A full sentence query that is fed to the search tool&lt;/required_argument&gt;\\n                &lt;returns&gt;Returns string  related to the user query asked.&lt;/returns&gt;\\n            &lt;/function&gt;\\n            \\n        &lt;/functions&gt;\\n\\n        &lt;question&gt;What is my deductible? My username is Bob and my benefitType is Dental. Also, what is the 401k yearly contribution limit?&lt;/question&gt;\\n        &lt;scratchpad&gt; I understand I cannot use functions that have not been provided to me to answer this question.\\n            To answer this question, I will:\\n            1. Call the get::benefitsaction::getbenefitplanname function to get the benefit plan name for the user Bob with benefit type Dental.\\n            2. Call the get::x_amz_knowledgebase_dentalinsurance::search function to search for information about deductibles for the plan name returned from step 1.\\n            3. Call the get::x_amz_knowledgebase_401k::search function to search for information about 401k yearly contribution limits.\\n            4. Return the deductible information from the search results to the user.\\n            I have checked that I have access to the get::benefitsaction::getbenefitplanname, x_amz_knowledgebase_dentalinsurance::search, and x_amz_knowledgebase_401k::search functions.\\n        &lt;/scratchpad&gt;\\n        &lt;function_call&gt;get::benefitsaction::getbenefitplanname(userName=\\\&quot;Bob\\\&quot;, benefitType=\\\&quot;Dental\\\&quot;)&lt;/function_call&gt;\\n        &lt;function_result&gt;{{&#x27;response&#x27;: {{&#x27;planName&#x27;: &#x27;Delta Dental&#x27;}}}}&lt;/function_result&gt;\\n        &lt;scratchpad&gt;\\n            I have received the plan name Delta Dental for the user Bob with Dental benefits. I will now call the x_amz_knowledgebase_dentalinsurance::search function to find deductible information for Delta Dental.\\n        &lt;/scratchpad&gt;\\n        &lt;function_call&gt;get::x_amz_knowledgebase_dentalinsurance::search(searchQuery=\\\&quot;What is the deductible for Delta Dental?\\\&quot;)&lt;/function_call&gt;\\n        &lt;function_result&gt;{{&#x27;response&#x27;: {{&#x27;responseCode&#x27;: &#x27;200&#x27;, &#x27;responseBody&#x27;: \\\&quot;\\\&quot;&lt;answer&gt;\\\\n&lt;answer_part&gt;\\\\n&lt;text&gt;The user&#x27;s individual deductible is $50 per benefit period&lt;/text&gt;\\\\n&lt;source&gt;dfe040f8-46ed-4a65-b3ea-529fa55f6b9e&lt;/source&gt;\\\\n&lt;/answer_part&gt;\\\\n&lt;answer_part&gt;\\\\n&lt;text&gt;If they are enrolled with dependents, the maximum family deductible is $150 per benefit period.&lt;/text&gt;\\\\n&lt;source&gt;0e666064-31d8-4223-b7ba-8eecf40b7b47&lt;/source&gt;\\\\n&lt;/answer_part&gt;\\\\n&lt;/answer&gt;\\\&quot;}}}}&lt;/function_result&gt; &lt;scratchpad&gt;\\n            I have found the deductible information for Dental benefits. I will now call the x_amz_knowledgebase_401k::search function to find yearly 401k contribution limits.\\n        &lt;/scratchpad&gt;\\n        &lt;function_call&gt;get::x_amz_knowledgebase_401k::search(searchQuery=\\\&quot;What is the yearly 401k contribution limit?\\\&quot;)&lt;/function_call&gt;\\n        &lt;function_result&gt;{{&#x27;response&#x27;: {{&#x27;responseCode&#x27;: &#x27;200&#x27;, &#x27;responseBody&#x27;: \\\&quot;&lt;answer&gt;\\\\n&lt;answer_part&gt;\\\\n&lt;text&gt;The yearly 401k contribution limit is $20,500.&lt;/text&gt;\\\\n&lt;source&gt;c546cbe8-07f6-45d1-90ca-74d87ab2885a&lt;/source&gt;\\\\n&lt;/answer_part&gt;\\\\n&lt;/answer&gt;\\\&quot;}}}}&lt;/function_result&gt;\\n        &lt;answer&gt;\\n            &lt;answer_part&gt;\\n                &lt;text&gt;The deductible for your Delta Dental plan is $50 per benefit period.&lt;/text&gt;\\n                &lt;source&gt;dfe040f8-46ed-4a65-b3ea-529fa55f6b9e&lt;/source&gt;\\n            &lt;/answer_part&gt;\\n            &lt;answer_part&gt;\\n                &lt;text&gt;If you have dependents enrolled, the maximum family deductible is $150 per benefit period.&lt;/text&gt;\\n                &lt;source&gt;0e666064-31d8-4223-b7ba-8eecf40b7b47&lt;/source&gt;\\n            &lt;/answer_part&gt;\\n            &lt;answer_part&gt;\\n                &lt;text&gt;The yearly 401k contribution limit is $20,500.&lt;/text&gt;\\n                &lt;source&gt;c546cbe8-07f6-45d1-90ca-74d87ab2885a&lt;/source&gt;\\n            &lt;/answer_part&gt;\\n        &lt;/answer&gt;\\n    &lt;/example&gt;\\n\\n    \\n\\n    &lt;example_docstring&gt;Here&#x27;s a final example where the question asked could not be answered with information gathered from calling the provided functions. In this example, notice how you respond by telling the user you cannot answer, without using a function that was not provided to you.&lt;/example_docstring&gt;\\n    &lt;example&gt;\\n        &lt;functions&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::policyengineactions::getpolicyviolations&lt;/function_name&gt;\\n                &lt;function_description&gt;Returns a list of policy engine violations for the specified alias within the specified date range.&lt;/function_description&gt;\\n                &lt;required_argument&gt;alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument&gt;\\n                &lt;required_argument&gt;startDate (string): The start date of the range to filter violations. The format for startDate is MM/DD/YYYY.&lt;/required_argument&gt;\\n                &lt;required_argument&gt;endDate (string): The end date of the range to filter violations&lt;/required_argument&gt;\\n                &lt;returns&gt;array: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;post::policyengineactions::acknowledgeviolations&lt;/function_name&gt;\\n                &lt;function_description&gt;Acknowledge policy engine violation. Generally used to acknowledge violation, once user notices a violation under their alias or their managers alias.&lt;/function_description&gt;\\n                &lt;required_argument&gt;policyId (string): The ID of the policy violation&lt;/required_argument&gt;\\n                &lt;required_argument&gt;expectedDateOfResolution (string): The date by when the violation will be addressed/resolved&lt;/required_argument&gt;\\n                &lt;returns&gt;object: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::activedirectoryactions::getmanager&lt;/function_name&gt;\\n                &lt;function_description&gt;This API is used to identify the manager hierarchy above a given person. Every person could have a manager and the manager could have another manager to which they report to&lt;/function_description&gt;\\n                &lt;required_argument&gt;alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument&gt;\\n                &lt;returns&gt;object: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            \\n        &lt;/functions&gt;\\n        &lt;question&gt;Who are the reportees of David?&lt;/question&gt;\\n        &lt;scratchpad&gt;\\n            After reviewing the functions I was equipped with, I realize I am not able to accurately answer this question since I can&#x27;t access reportees of David. Therefore, I should explain to the user I cannot answer this question.\\n        &lt;/scratchpad&gt;\\n        &lt;answer&gt;\\n            Sorry, I am unable to assist you with this request.\\n        &lt;/answer&gt;\\n    &lt;/example&gt;\\n&lt;/examples&gt;\\n\\nThe above examples have been provided to you to illustrate general guidelines and format for use of function calling for information retrieval, and how to use your scratchpad to plan your approach. IMPORTANT: the functions provided within the examples should not be assumed to have been provided to you to use UNLESS they are also explicitly given to you within &lt;functions&gt;&lt;/functions&gt; tags below. All of the values and information within the examples (the questions, function results, and answers) are strictly part of the examples and have not been provided to you.\\n\\nNow that you have read and understood the examples, I will define the functions that you have available to you to use. Here is a comprehensive list.\\n\\n&lt;functions&gt;\\n&lt;function&gt;\\n&lt;function_name&gt;GET::optimal_departure_window_mars::getNextMarsLaunchWindow&lt;/function_name&gt;\\n&lt;function_description&gt;Gets the next optimal launch window to Mars.&lt;/function_description&gt;\\n&lt;required_argument&gt;specific_impulse (string): Specific impulse of the propulsion system (s).&lt;/required_argument&gt;\\n&lt;required_argument&gt;dry_mass (string): Mass of the spacecraft without fuel (kg).&lt;/required_argument&gt;\\n&lt;required_argument&gt;total_mass (string): Total mass of the spacecraft including fuel (kg)&lt;/required_argument&gt;\\n&lt;returns&gt;object: The next optimal departure date for a Hohmann transfer from Earth to Mars, based on the spacecraft&#x27;s mass and specific impulse.&lt;/returns&gt;\\n&lt;/function&gt;\\n\\n\\n&lt;/functions&gt;\\n\\nNote that the function arguments have been listed in the order that they should be passed into the function.\\n\\n\\n\\nDo not modify or extend the provided functions under any circumstances. For example, GET::optimal_departure_window_mars::getNextMarsLaunchWindow with additional parameters would be considered modifying the function which is not allowed. Please use the functions only as defined.\\n\\nDO NOT use any functions that I have not equipped you with.\\n\\n Do not make assumptions about inputs; instead, make sure you know the exact function and input to use before you call a function.\\n\\nTo call a function, output the name of the function in between &lt;function_call&gt; and &lt;/function_call&gt; tags. You will receive a &lt;function_result&gt; in response to your call that contains information that you can use to better answer the question. Or, if the function call produced an error, you will receive an &lt;error&gt; in response.\\n\\n\\n\\nThe format for all other &lt;function_call&gt; MUST be: &lt;function_call&gt;$FUNCTION_NAME($FUNCTION_PARAMETER_NAME=$FUNCTION_PARAMETER_VALUE)&lt;/function_call&gt;\\n\\nRemember, your goal is to answer the user&#x27;s question to the best of your ability, using only the function(s) provided within the &lt;functions&gt;&lt;/functions&gt; tags to gather more information if necessary to better answer the question.\\n\\nDo not modify or extend the provided functions under any circumstances. For example, calling GET::optimal_departure_window_mars::getNextMarsLaunchWindow with additional parameters would be modifying the function which is not allowed. Please use the functions only as defined.\\n\\nBefore calling any functions, create a plan for performing actions to answer this question within the &lt;scratchpad&gt;. Double check your plan to make sure you don&#x27;t call any functions that you haven&#x27;t been provided with. Always return your final answer within &lt;answer&gt;&lt;/answer&gt; tags.\\n\\n\\n\\nThe user input is &lt;question&gt;Answer the following question and pay strong attention to the prompt:\\n        &lt;question&gt;\\n        When is the next launch window for Mars? My spacecraft&#x27;s total mass is 50000, dry mass is 10000 and specific impulse is 2500. Mass in Kg.\\n        &lt;/question&gt;\\n        &lt;instruction&gt;\\n        You have functions available at your disposal to use when anwering any questions about orbital mechanics.if you can&#x27;t find a function to answer a question about orbital mechanics, simply reply &#x27;I do not know&#x27;\\n        &lt;/instruction&gt;&lt;/question&gt;\\n\\n\\nAssistant: &lt;scratchpad&gt; I understand I cannot use functions that have not been provided to me to answer this question.\\n\\n\&quot;}&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;mlflow.spanOutputs&quot;: &quot;\&quot;To answer this question about the next Mars launch window, I will:\\n\\n1. Call the GET::optimal_departure_window_mars::getNextMarsLaunchWindow function to get the next optimal launch window, passing in the provided spacecraft mass and specific impulse values.\\n\\nI have verified that I have access to the GET::optimal_departure_window_mars::getNextMarsLaunchWindow function.\&quot;&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;events&quot;: []</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;name&quot;: &quot;Invoking Action Group&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;context&quot;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;span_id&quot;: &quot;0x692bd6457647dc76&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;trace_id&quot;: &quot;0x9b8bd0b2e018d77f936e48a09e54fd44&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;parent_id&quot;: &quot;0xb802165d133a33aa&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;start_time&quot;: 1731388550224851000,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;end_time&quot;: 1731388550225218000,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;status_code&quot;: &quot;OK&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;status_message&quot;: &quot;&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;attributes&quot;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;mlflow.traceRequestId&quot;: &quot;\&quot;1e036cc3a7f946ec995f7763b8dde51c\&quot;&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;mlflow.spanType&quot;: &quot;\&quot;UNKNOWN\&quot;&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;trace_attributes&quot;: &quot;[{\&quot;type\&quot;: \&quot;modelInvocationInput\&quot;, \&quot;data\&quot;: {\&quot;inferenceConfiguration\&quot;: {\&quot;maximumLength\&quot;: 2048, \&quot;stopSequences\&quot;: [\&quot;&lt;/function_call&gt;\&quot;, \&quot;&lt;/answer&gt;\&quot;, \&quot;&lt;/error&gt;\&quot;], \&quot;temperature\&quot;: 0.0, \&quot;topK\&quot;: 250, \&quot;topP\&quot;: 1.0}, \&quot;text\&quot;: \&quot;\\n\\nHuman:\\nYou are a research assistant AI that has been equipped with one or more functions to help you answer a &lt;question&gt;. Your goal is to answer the user&#x27;s question to the best of your ability, using the function(s) to gather more information if necessary to better answer the question. If you choose to call a function, the result of the function call will be added to the conversation history in &lt;function_results&gt; tags (if the call succeeded) or &lt;error&gt; tags (if the function failed). \\nYou were created with these instructions to consider as well:\\n&lt;auxiliary_instructions&gt;\\n            You are a friendly chat bot. You have access to a function called that returns\\n            information about the Mars launch window. When responding with Mars launch window,\\n            please make sure to add the timezone UTC.\\n            &lt;/auxiliary_instructions&gt;\\n\\nHere are some examples of correct action by other, different agents with access to functions that may or may not be similar to ones you are provided.\\n\\n&lt;examples&gt;\\n    &lt;example_docstring&gt; Here is an example of how you would correctly answer a question using a &lt;function_call&gt; and the corresponding &lt;function_result&gt;. Notice that you are free to think before deciding to make a &lt;function_call&gt; in the &lt;scratchpad&gt;.&lt;/example_docstring&gt;\\n    &lt;example&gt;\\n        &lt;functions&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::policyengineactions::getpolicyviolations&lt;/function_name&gt;\\n                &lt;function_description&gt;Returns a list of policy engine violations for the specified alias within the specified date range.&lt;/function_description&gt;\\n                &lt;required_argument&gt;alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument&gt;\\n                &lt;required_argument&gt;startDate (string): The start date of the range to filter violations. The format for startDate is MM/DD/YYYY.&lt;/required_argument&gt;\\n                &lt;required_argument&gt;endDate (string): The end date of the range to filter violations&lt;/required_argument&gt;\\n                &lt;returns&gt;array: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;post::policyengineactions::acknowledgeviolations&lt;/function_name&gt;\\n                &lt;function_description&gt;Acknowledge policy engine violation. Generally used to acknowledge violation, once user notices a violation under their alias or their managers alias.&lt;/function_description&gt;\\n                &lt;required_argument&gt;policyId (string): The ID of the policy violation&lt;/required_argument&gt;\\n                &lt;required_argument&gt;expectedDateOfResolution (string): The date by when the violation will be addressed/resolved&lt;/required_argument&gt;\\n                &lt;returns&gt;object: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::activedirectoryactions::getmanager&lt;/function_name&gt;\\n                &lt;function_description&gt;This API is used to identify the manager hierarchy above a given person. Every person could have a manager and the manager could have another manager to which they report to&lt;/function_description&gt;\\n                &lt;required_argument&gt;alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument&gt;\\n                &lt;returns&gt;object: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            \\n        &lt;/functions&gt;\\n\\n        &lt;question&gt;Can you show me my policy engine violation from 1st january 2023 to 1st february 2023? My alias is jsmith.&lt;/question&gt;\\n        &lt;scratchpad&gt;\\n            To answer this question, I will need to:\\n            1. I do not have knowledge to policy engine violations, so I should see if I can use any of the available functions to help. I have been equipped with get::policyengineactions::getpolicyviolations that gets the policy engine violations for a given alias, start date and end date. I will use this function to gather more information.\\n        &lt;/scratchpad&gt;\\n        &lt;function_call&gt;get::policyengineactions::getpolicyviolations(alias=\\\&quot;jsmith\\\&quot;, startDate=\\\&quot;1st January 2023\\\&quot;, endDate=\\\&quot;1st February 2023\\\&quot;)&lt;/function_call&gt;\\n        &lt;function_result&gt;{response: [{creationDate: \\\&quot;2023-06-01T09:30:00Z\\\&quot;, riskLevel: \\\&quot;High\\\&quot;, policyId: \\\&quot;POL-001\\\&quot;, policyUrl: \\\&quot;https://example.com/policies/POL-001\\\&quot;, referenceUrl: \\\&quot;https://example.com/violations/POL-001\\\&quot;}, {creationDate: \\\&quot;2023-06-02T14:45:00Z\\\&quot;, riskLevel: \\\&quot;Medium\\\&quot;, policyId: \\\&quot;POL-002\\\&quot;, policyUrl: \\\&quot;https://example.com/policies/POL-002\\\&quot;, referenceUrl: \\\&quot;https://example.com/violations/POL-002\\\&quot;}]}&lt;/function_result&gt;\\n        &lt;answer&gt;The policy engine violations between 1st january 2023 to 1st february 2023 for alias jsmith are - Policy ID: POL-001, Policy ID: POL-002&lt;/answer&gt;\\n    &lt;/example&gt;\\n\\n    &lt;example_docstring&gt;Here is another example that utilizes multiple function calls.&lt;/example_docstring&gt;\\n    &lt;example&gt;\\n        &lt;functions&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::policyengineactions::getpolicyviolations&lt;/function_name&gt;\\n                &lt;function_description&gt;Returns a list of policy engine violations for the specified alias within the specified date range.&lt;/function_description&gt;\\n                &lt;required_argument&gt;alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument&gt;\\n                &lt;required_argument&gt;startDate (string): The start date of the range to filter violations. The format for startDate is MM/DD/YYYY.&lt;/required_argument&gt;\\n                &lt;required_argument&gt;endDate (string): The end date of the range to filter violations&lt;/required_argument&gt;\\n                &lt;returns&gt;array: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;post::policyengineactions::acknowledgeviolations&lt;/function_name&gt;\\n                &lt;function_description&gt;Acknowledge policy engine violation. Generally used to acknowledge violation, once user notices a violation under their alias or their managers alias.&lt;/function_description&gt;\\n                &lt;required_argument&gt;policyId (string): The ID of the policy violation&lt;/required_argument&gt;\\n                &lt;required_argument&gt;expectedDateOfResolution (string): The date by when the violation will be addressed/resolved&lt;/required_argument&gt;\\n                &lt;returns&gt;object: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::activedirectoryactions::getmanager&lt;/function_name&gt;\\n                &lt;function_description&gt;This API is used to identify the manager hierarchy above a given person. Every person could have a manager and the manager could have another manager to which they report to&lt;/function_description&gt;\\n                &lt;required_argument&gt;alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument&gt;\\n                &lt;returns&gt;object: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            \\n        &lt;/functions&gt;\\n        &lt;question&gt;Can you check the policy engine violations under my manager between 2nd May to 5th May? My alias is john.&lt;/question&gt;\\n        &lt;scratchpad&gt;\\n            To answer this question, I will need to:\\n            1. Get the manager alias of the user using get::activedirectoryactions::getmanager function.\\n            2. Use the returned manager alias to get the policy engine violations using the get::policyengineactions::getpolicyviolations function.\\n\\n            I have double checked and made sure that I have been provided the get::activedirectoryactions::getmanager and the get::policyengineactions::getpolicyviolations functions.\\n        &lt;/scratchpad&gt;\\n        &lt;function_call&gt;get::activedirectoryactions::getmanager(alias=\\\&quot;john\\\&quot;)&lt;/function_call&gt;\\n        &lt;function_result&gt;{response: {managerAlias: \\\&quot;mark\\\&quot;, managerLevel: \\\&quot;6\\\&quot;, teamName: \\\&quot;Builder\\\&quot;, managerName: \\\&quot;Mark Hunter\\\&quot;}}}}&lt;/function_result&gt;\\n        &lt;scratchpad&gt;\\n            1. I have the managerAlias from the function results as mark and I have the start and end date from the user input. I can use the function result to call get::policyengineactions::getpolicyviolations function.\\n            2. I will then return the get::policyengineactions::getpolicyviolations function result to the user.\\n\\n            I have double checked and made sure that I have been provided the get::policyengineactions::getpolicyviolations functions.\\n        &lt;/scratchpad&gt;\\n        &lt;function_call&gt;get::policyengineactions::getpolicyviolations(alias=\\\&quot;mark\\\&quot;, startDate=\\\&quot;2nd May 2023\\\&quot;, endDate=\\\&quot;5th May 2023\\\&quot;)&lt;/function_call&gt;\\n        &lt;function_result&gt;{response: [{creationDate: \\\&quot;2023-05-02T09:30:00Z\\\&quot;, riskLevel: \\\&quot;High\\\&quot;, policyId: \\\&quot;POL-001\\\&quot;, policyUrl: \\\&quot;https://example.com/policies/POL-001\\\&quot;, referenceUrl: \\\&quot;https://example.com/violations/POL-001\\\&quot;}, {creationDate: \\\&quot;2023-05-04T14:45:00Z\\\&quot;, riskLevel: \\\&quot;Low\\\&quot;, policyId: \\\&quot;POL-002\\\&quot;, policyUrl: \\\&quot;https://example.com/policies/POL-002\\\&quot;, referenceUrl: \\\&quot;https://example.com/violations/POL-002\\\&quot;}]}&lt;/function_result&gt;\\n        &lt;answer&gt;\\n            The policy engine violations between 2nd May 2023 to 5th May 2023 for your manager&#x27;s alias mark are - Policy ID: POL-001, Policy ID: POL-002\\n        &lt;/answer&gt;\\n    &lt;/example&gt;\\n\\n    &lt;example_docstring&gt;Functions can also be search engine API&#x27;s that issue a query to a knowledge base. Here is an example that utilizes regular function calls in combination with function calls to a search engine API. Please make sure to extract the source for the information within the final answer when using information returned from the search engine.&lt;/example_docstring&gt;\\n    &lt;example&gt;\\n        &lt;functions&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::benefitsaction::getbenefitplanname&lt;/function_name&gt;\\n                &lt;function_description&gt;Get&#x27;s the benefit plan name for a user. The API takes in a userName and a benefit type and returns the benefit name to the user (i.e. Aetna, Premera, Fidelity, etc.).&lt;/function_description&gt;\\n                &lt;optional_argument&gt;userName (string): None&lt;/optional_argument&gt;\\n                &lt;optional_argument&gt;benefitType (string): None&lt;/optional_argument&gt;\\n                &lt;returns&gt;object: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;post::benefitsaction::increase401klimit&lt;/function_name&gt;\\n                &lt;function_description&gt;Increases the 401k limit for a generic user. The API takes in only the current 401k limit and returns the new limit.&lt;/function_description&gt;\\n                &lt;optional_argument&gt;currentLimit (string): None&lt;/optional_argument&gt;\\n                &lt;returns&gt;object: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::x_amz_knowledgebase_dentalinsurance::search&lt;/function_name&gt;\\n                &lt;function_description&gt;This is a search tool that provides information about Delta Dental benefits. It has information about covered dental benefits and other relevant information&lt;/function_description&gt;\\n                &lt;required_argument&gt;query(string): A full sentence query that is fed to the search tool&lt;/required_argument&gt;\\n                &lt;returns&gt;Returns string  related to the user query asked.&lt;/returns&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::x_amz_knowledgebase_401kplan::search&lt;/function_name&gt;\\n                &lt;function_description&gt;This is a search tool that provides information about Amazon 401k plan benefits. It can determine what a person&#x27;s yearly 401k contribution limit is, based on their age.&lt;/function_description&gt;\\n                &lt;required_argument&gt;query(string): A full sentence query that is fed to the search tool&lt;/required_argument&gt;\\n                &lt;returns&gt;Returns string  related to the user query asked.&lt;/returns&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::x_amz_knowledgebase_healthinsurance::search&lt;/function_name&gt;\\n                &lt;function_description&gt;This is a search tool that provides information about Aetna and Premera health benefits. It has information about the savings plan and shared deductible plan, as well as others.&lt;/function_description&gt;\\n                &lt;required_argument&gt;query(string): A full sentence query that is fed to the search tool&lt;/required_argument&gt;\\n                &lt;returns&gt;Returns string  related to the user query asked.&lt;/returns&gt;\\n            &lt;/function&gt;\\n            \\n        &lt;/functions&gt;\\n\\n        &lt;question&gt;What is my deductible? My username is Bob and my benefitType is Dental. Also, what is the 401k yearly contribution limit?&lt;/question&gt;\\n        &lt;scratchpad&gt; I understand I cannot use functions that have not been provided to me to answer this question.\\n            To answer this question, I will:\\n            1. Call the get::benefitsaction::getbenefitplanname function to get the benefit plan name for the user Bob with benefit type Dental.\\n            2. Call the get::x_amz_knowledgebase_dentalinsurance::search function to search for information about deductibles for the plan name returned from step 1.\\n            3. Call the get::x_amz_knowledgebase_401k::search function to search for information about 401k yearly contribution limits.\\n            4. Return the deductible information from the search results to the user.\\n            I have checked that I have access to the get::benefitsaction::getbenefitplanname, x_amz_knowledgebase_dentalinsurance::search, and x_amz_knowledgebase_401k::search functions.\\n        &lt;/scratchpad&gt;\\n        &lt;function_call&gt;get::benefitsaction::getbenefitplanname(userName=\\\&quot;Bob\\\&quot;, benefitType=\\\&quot;Dental\\\&quot;)&lt;/function_call&gt;\\n        &lt;function_result&gt;{{&#x27;response&#x27;: {{&#x27;planName&#x27;: &#x27;Delta Dental&#x27;}}}}&lt;/function_result&gt;\\n        &lt;scratchpad&gt;\\n            I have received the plan name Delta Dental for the user Bob with Dental benefits. I will now call the x_amz_knowledgebase_dentalinsurance::search function to find deductible information for Delta Dental.\\n        &lt;/scratchpad&gt;\\n        &lt;function_call&gt;get::x_amz_knowledgebase_dentalinsurance::search(searchQuery=\\\&quot;What is the deductible for Delta Dental?\\\&quot;)&lt;/function_call&gt;\\n        &lt;function_result&gt;{{&#x27;response&#x27;: {{&#x27;responseCode&#x27;: &#x27;200&#x27;, &#x27;responseBody&#x27;: \\\&quot;\\\&quot;&lt;answer&gt;\\\\n&lt;answer_part&gt;\\\\n&lt;text&gt;The user&#x27;s individual deductible is $50 per benefit period&lt;/text&gt;\\\\n&lt;source&gt;dfe040f8-46ed-4a65-b3ea-529fa55f6b9e&lt;/source&gt;\\\\n&lt;/answer_part&gt;\\\\n&lt;answer_part&gt;\\\\n&lt;text&gt;If they are enrolled with dependents, the maximum family deductible is $150 per benefit period.&lt;/text&gt;\\\\n&lt;source&gt;0e666064-31d8-4223-b7ba-8eecf40b7b47&lt;/source&gt;\\\\n&lt;/answer_part&gt;\\\\n&lt;/answer&gt;\\\&quot;}}}}&lt;/function_result&gt; &lt;scratchpad&gt;\\n            I have found the deductible information for Dental benefits. I will now call the x_amz_knowledgebase_401k::search function to find yearly 401k contribution limits.\\n        &lt;/scratchpad&gt;\\n        &lt;function_call&gt;get::x_amz_knowledgebase_401k::search(searchQuery=\\\&quot;What is the yearly 401k contribution limit?\\\&quot;)&lt;/function_call&gt;\\n        &lt;function_result&gt;{{&#x27;response&#x27;: {{&#x27;responseCode&#x27;: &#x27;200&#x27;, &#x27;responseBody&#x27;: \\\&quot;&lt;answer&gt;\\\\n&lt;answer_part&gt;\\\\n&lt;text&gt;The yearly 401k contribution limit is $20,500.&lt;/text&gt;\\\\n&lt;source&gt;c546cbe8-07f6-45d1-90ca-74d87ab2885a&lt;/source&gt;\\\\n&lt;/answer_part&gt;\\\\n&lt;/answer&gt;\\\&quot;}}}}&lt;/function_result&gt;\\n        &lt;answer&gt;\\n            &lt;answer_part&gt;\\n                &lt;text&gt;The deductible for your Delta Dental plan is $50 per benefit period.&lt;/text&gt;\\n                &lt;source&gt;dfe040f8-46ed-4a65-b3ea-529fa55f6b9e&lt;/source&gt;\\n            &lt;/answer_part&gt;\\n            &lt;answer_part&gt;\\n                &lt;text&gt;If you have dependents enrolled, the maximum family deductible is $150 per benefit period.&lt;/text&gt;\\n                &lt;source&gt;0e666064-31d8-4223-b7ba-8eecf40b7b47&lt;/source&gt;\\n            &lt;/answer_part&gt;\\n            &lt;answer_part&gt;\\n                &lt;text&gt;The yearly 401k contribution limit is $20,500.&lt;/text&gt;\\n                &lt;source&gt;c546cbe8-07f6-45d1-90ca-74d87ab2885a&lt;/source&gt;\\n            &lt;/answer_part&gt;\\n        &lt;/answer&gt;\\n    &lt;/example&gt;\\n\\n    \\n\\n    &lt;example_docstring&gt;Here&#x27;s a final example where the question asked could not be answered with information gathered from calling the provided functions. In this example, notice how you respond by telling the user you cannot answer, without using a function that was not provided to you.&lt;/example_docstring&gt;\\n    &lt;example&gt;\\n        &lt;functions&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::policyengineactions::getpolicyviolations&lt;/function_name&gt;\\n                &lt;function_description&gt;Returns a list of policy engine violations for the specified alias within the specified date range.&lt;/function_description&gt;\\n                &lt;required_argument&gt;alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument&gt;\\n                &lt;required_argument&gt;startDate (string): The start date of the range to filter violations. The format for startDate is MM/DD/YYYY.&lt;/required_argument&gt;\\n                &lt;required_argument&gt;endDate (string): The end date of the range to filter violations&lt;/required_argument&gt;\\n                &lt;returns&gt;array: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;post::policyengineactions::acknowledgeviolations&lt;/function_name&gt;\\n                &lt;function_description&gt;Acknowledge policy engine violation. Generally used to acknowledge violation, once user notices a violation under their alias or their managers alias.&lt;/function_description&gt;\\n                &lt;required_argument&gt;policyId (string): The ID of the policy violation&lt;/required_argument&gt;\\n                &lt;required_argument&gt;expectedDateOfResolution (string): The date by when the violation will be addressed/resolved&lt;/required_argument&gt;\\n                &lt;returns&gt;object: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            &lt;function&gt;\\n                &lt;function_name&gt;get::activedirectoryactions::getmanager&lt;/function_name&gt;\\n                &lt;function_description&gt;This API is used to identify the manager hierarchy above a given person. Every person could have a manager and the manager could have another manager to which they report to&lt;/function_description&gt;\\n                &lt;required_argument&gt;alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument&gt;\\n                &lt;returns&gt;object: Successful response&lt;/returns&gt;\\n                &lt;raises&gt;object: Invalid request&lt;/raises&gt;\\n            &lt;/function&gt;\\n            \\n        &lt;/functions&gt;\\n        &lt;question&gt;Who are the reportees of David?&lt;/question&gt;\\n        &lt;scratchpad&gt;\\n            After reviewing the functions I was equipped with, I realize I am not able to accurately answer this question since I can&#x27;t access reportees of David. Therefore, I should explain to the user I cannot answer this question.\\n        &lt;/scratchpad&gt;\\n        &lt;answer&gt;\\n            Sorry, I am unable to assist you with this request.\\n        &lt;/answer&gt;\\n    &lt;/example&gt;\\n&lt;/examples&gt;\\n\\nThe above examples have been provided to you to illustrate general guidelines and format for use of function calling for information retrieval, and how to use your scratchpad to plan your approach. IMPORTANT: the functions provided within the examples should not be assumed to have been provided to you to use UNLESS they are also explicitly given to you within &lt;functions&gt;&lt;/functions&gt; tags below. All of the values and information within the examples (the questions, function results, and answers) are strictly part of the examples and have not been provided to you.\\n\\nNow that you have read and understood the examples, I will define the functions that you have available to you to use. Here is a comprehensive list.\\n\\n&lt;functions&gt;\\n&lt;function&gt;\\n&lt;function_name&gt;GET::optimal_departure_window_mars::getNextMarsLaunchWindow&lt;/function_name&gt;\\n&lt;function_description&gt;Gets the next optimal launch window to Mars.&lt;/function_description&gt;\\n&lt;required_argument&gt;specific_impulse (string): Specific impulse of the propulsion system (s).&lt;/required_argument&gt;\\n&lt;required_argument&gt;dry_mass (string): Mass of the spacecraft without fuel (kg).&lt;/required_argument&gt;\\n&lt;required_argument&gt;total_mass (string): Total mass of the spacecraft including fuel (kg)&lt;/required_argument&gt;\\n&lt;returns&gt;object: The next optimal departure date for a Hohmann transfer from Earth to Mars, based on the spacecraft&#x27;s mass and specific impulse.&lt;/returns&gt;\\n&lt;/function&gt;\\n\\n\\n&lt;/functions&gt;\\n\\nNote that the function arguments have been listed in the order that they should be passed into the function.\\n\\n\\n\\nDo not modify or extend the provided functions under any circumstances. For example, GET::optimal_departure_window_mars::getNextMarsLaunchWindow with additional parameters would be considered modifying the function which is not allowed. Please use the functions only as defined.\\n\\nDO NOT use any functions that I have not equipped you with.\\n\\n Do not make assumptions about inputs; instead, make sure you know the exact function and input to use before you call a function.\\n\\nTo call a function, output the name of the function in between &lt;function_call&gt; and &lt;/function_call&gt; tags. You will receive a &lt;function_result&gt; in response to your call that contains information that you can use to better answer the question. Or, if the function call produced an error, you will receive an &lt;error&gt; in response.\\n\\n\\n\\nThe format for all other &lt;function_call&gt; MUST be: &lt;function_call&gt;$FUNCTION_NAME($FUNCTION_PARAMETER_NAME=$FUNCTION_PARAMETER_VALUE)&lt;/function_call&gt;\\n\\nRemember, your goal is to answer the user&#x27;s question to the best of your ability, using only the function(s) provided within the &lt;functions&gt;&lt;/functions&gt; tags to gather more information if necessary to better answer the question.\\n\\nDo not modify or extend the provided functions under any circumstances. For example, calling GET::optimal_departure_window_mars::getNextMarsLaunchWindow with additional parameters would be modifying the function which is not allowed. Please use the functions only as defined.\\n\\nBefore calling any functions, create a plan for performing actions to answer this question within the &lt;scratchpad&gt;. Double check your plan to make sure you don&#x27;t call any functions that you haven&#x27;t been provided with. Always return your final answer within &lt;answer&gt;&lt;/answer&gt; tags.\\n\\n\\n\\nThe user input is &lt;question&gt;Answer the following question and pay strong attention to the prompt:\\n        &lt;question&gt;\\n        When is the next launch window for Mars? My spacecraft&#x27;s total mass is 50000, dry mass is 10000 and specific impulse is 2500. Mass in Kg.\\n        &lt;/question&gt;\\n        &lt;instruction&gt;\\n        You have functions available at your disposal to use when anwering any questions about orbital mechanics.if you can&#x27;t find a function to answer a question about orbital mechanics, simply reply &#x27;I do not know&#x27;\\n        &lt;/instruction&gt;&lt;/question&gt;\\n\\n\\nAssistant: &lt;scratchpad&gt; I understand I cannot use functions that have not been provided to me to answer this question.\\n\\n\&quot;, \&quot;traceId\&quot;: \&quot;e0b2b2c2-fb7c-4e17-8a1f-a3781100face-0\&quot;, \&quot;type\&quot;: \&quot;ORCHESTRATION\&quot;}, \&quot;event_order\&quot;: 2}, {\&quot;type\&quot;: \&quot;modelInvocationOutput\&quot;, \&quot;data\&quot;: {\&quot;metadata\&quot;: {\&quot;usage\&quot;: {\&quot;inputTokens\&quot;: 5160, \&quot;outputTokens\&quot;: 135}}, \&quot;rawResponse\&quot;: {\&quot;content\&quot;: \&quot;To answer this question about the next Mars launch window, I will:\\n\\n1. Call the GET::optimal_departure_window_mars::getNextMarsLaunchWindow function to get the next optimal launch window, passing in the provided spacecraft mass and specific impulse values.\\n\\nI have verified that I have access to the GET::optimal_departure_window_mars::getNextMarsLaunchWindow function.\\n\\n&lt;/scratchpad&gt;\\n\\n&lt;function_call&gt;\\nGET::optimal_departure_window_mars::getNextMarsLaunchWindow(specific_impulse=\\\&quot;2500\\\&quot;, dry_mass=\\\&quot;10000\\\&quot;, total_mass=\\\&quot;50000\\\&quot;)\&quot;}, \&quot;traceId\&quot;: \&quot;e0b2b2c2-fb7c-4e17-8a1f-a3781100face-0\&quot;}, \&quot;event_order\&quot;: 3}, {\&quot;type\&quot;: \&quot;rationale\&quot;, \&quot;data\&quot;: {\&quot;text\&quot;: \&quot;To answer this question about the next Mars launch window, I will:\\n\\n1. Call the GET::optimal_departure_window_mars::getNextMarsLaunchWindow function to get the next optimal launch window, passing in the provided spacecraft mass and specific impulse values.\\n\\nI have verified that I have access to the GET::optimal_departure_window_mars::getNextMarsLaunchWindow function.\&quot;, \&quot;traceId\&quot;: \&quot;e0b2b2c2-fb7c-4e17-8a1f-a3781100face-0\&quot;}, \&quot;event_order\&quot;: 4}, {\&quot;type\&quot;: \&quot;invocationInput\&quot;, \&quot;data\&quot;: {\&quot;actionGroupInvocationInput\&quot;: {\&quot;actionGroupName\&quot;: \&quot;optimal_departure_window_mars\&quot;, \&quot;apiPath\&quot;: \&quot;/get-next-mars-launch-window\&quot;, \&quot;executionType\&quot;: \&quot;LAMBDA\&quot;, \&quot;parameters\&quot;: [{\&quot;name\&quot;: \&quot;total_mass\&quot;, \&quot;type\&quot;: \&quot;string\&quot;, \&quot;value\&quot;: \&quot;50000\&quot;}, {\&quot;name\&quot;: \&quot;dry_mass\&quot;, \&quot;type\&quot;: \&quot;string\&quot;, \&quot;value\&quot;: \&quot;10000\&quot;}, {\&quot;name\&quot;: \&quot;specific_impulse\&quot;, \&quot;type\&quot;: \&quot;string\&quot;, \&quot;value\&quot;: \&quot;2500\&quot;}], \&quot;verb\&quot;: \&quot;get\&quot;}, \&quot;invocationType\&quot;: \&quot;ACTION_GROUP\&quot;, \&quot;traceId\&quot;: \&quot;e0b2b2c2-fb7c-4e17-8a1f-a3781100face-0\&quot;}, \&quot;event_order\&quot;: 5}, {\&quot;type\&quot;: \&quot;observation\&quot;, \&quot;data\&quot;: {\&quot;actionGroupInvocationOutput\&quot;: {\&quot;text\&quot;: \&quot;{\\\&quot;next_launch_window\\\&quot;: {\\\&quot;next_launch_date\\\&quot;: \\\&quot;2026-11-26 00:00:00\\\&quot;, \\\&quot;synodic_period_days\\\&quot;: 779.9068939794238, \\\&quot;transfer_time_days\\\&quot;: 259, \\\&quot;delta_v_available_m_s\\\&quot;: 39457.985759929674, \\\&quot;delta_v_required_m_s\\\&quot;: 5595.997417810693, \\\&quot;is_feasible\\\&quot;: true}}\&quot;}, \&quot;traceId\&quot;: \&quot;e0b2b2c2-fb7c-4e17-8a1f-a3781100face-0\&quot;, \&quot;type\&quot;: \&quot;ACTION_GROUP\&quot;}, \&quot;event_order\&quot;: 6}]&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;mlflow.spanFunctionName&quot;: &quot;\&quot;_action_group_trace\&quot;&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;mlflow.spanInputs&quot;: &quot;{\&quot;inner_trace_group\&quot;: \&quot;{&#x27;actionGroupName&#x27;: &#x27;optimal_departure_window_mars&#x27;, &#x27;apiPath&#x27;: &#x27;/get-next-mars-launch-window&#x27;, &#x27;executionType&#x27;: &#x27;LAMBDA&#x27;, &#x27;parameters&#x27;: [{&#x27;name&#x27;: &#x27;total_mass&#x27;, &#x27;type&#x27;: &#x27;string&#x27;, &#x27;value&#x27;: &#x27;50000&#x27;}, {&#x27;name&#x27;: &#x27;dry_mass&#x27;, &#x27;type&#x27;: &#x27;string&#x27;, &#x27;value&#x27;: &#x27;10000&#x27;}, {&#x27;name&#x27;: &#x27;specific_impulse&#x27;, &#x27;type&#x27;: &#x27;string&#x27;, &#x27;value&#x27;: &#x27;2500&#x27;}], &#x27;verb&#x27;: &#x27;get&#x27;}\&quot;}&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;mlflow.spanOutputs&quot;: &quot;\&quot;{&#x27;action_group_name&#x27;: &#x27;optimal_departure_window_mars&#x27;, &#x27;api_path&#x27;: &#x27;/get-next-mars-launch-window&#x27;, &#x27;execution_type&#x27;: &#x27;LAMBDA&#x27;, &#x27;execution_output&#x27;: &#x27;{\\\&quot;next_launch_window\\\&quot;: {\\\&quot;next_launch_date\\\&quot;: \\\&quot;2026-11-26 00:00:00\\\&quot;, \\\&quot;synodic_period_days\\\&quot;: 779.9068939794238, \\\&quot;transfer_time_days\\\&quot;: 259, \\\&quot;delta_v_available_m_s\\\&quot;: 39457.985759929674, \\\&quot;delta_v_required_m_s\\\&quot;: 5595.997417810693, \\\&quot;is_feasible\\\&quot;: true}}&#x27;}\&quot;&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;events&quot;: []</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;name&quot;: &quot;Retrieved Response&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;context&quot;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;span_id&quot;: &quot;0xfe0b5f9149c39d7d&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;trace_id&quot;: &quot;0x9b8bd0b2e018d77f936e48a09e54fd44&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;parent_id&quot;: &quot;0xb802165d133a33aa&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;start_time&quot;: 1731388550225320000,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;end_time&quot;: 1731388550226466000,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;status_code&quot;: &quot;OK&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;status_message&quot;: &quot;&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;attributes&quot;: {</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;mlflow.traceRequestId&quot;: &quot;\&quot;1e036cc3a7f946ec995f7763b8dde51c\&quot;&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;mlflow.spanType&quot;: &quot;\&quot;AGENT\&quot;&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;mlflow.spanInputs&quot;: &quot;[{\&quot;role\&quot;: \&quot;user\&quot;, \&quot;content\&quot;: \&quot;When is the next launch window for Mars? My spacecraft&#x27;s total mass is 50000, dry mass is 10000 and specific impulse is 2500. Mass in Kg.\&quot;, \&quot;name\&quot;: null}]&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        &quot;mlflow.spanOutputs&quot;: &quot;{\&quot;choices\&quot;: [{\&quot;index\&quot;: 0, \&quot;message\&quot;: {\&quot;role\&quot;: \&quot;user\&quot;, \&quot;content\&quot;: \&quot;Based on the provided spacecraft dry mass of 10000 kg, total mass of 50000 kg, and specific impulse of 2500 s, the next optimal launch window for a Hohmann transfer from Earth to Mars is on November 26, 2026 UTC. The transfer will take 259 days.\&quot;, \&quot;name\&quot;: null}, \&quot;finish_reason\&quot;: \&quot;stop\&quot;, \&quot;logprobs\&quot;: null}], \&quot;usage\&quot;: {\&quot;prompt_tokens\&quot;: null, \&quot;completion_tokens\&quot;: null, \&quot;total_tokens\&quot;: null}, \&quot;id\&quot;: null, \&quot;model\&quot;: \&quot;anthropic.claude-v2\&quot;, \&quot;object\&quot;: \&quot;chat.completion\&quot;, \&quot;created\&quot;: 1731388550}&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      &quot;events&quot;: []</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  ],</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  &quot;request&quot;: &quot;{\&quot;context\&quot;: \&quot;&lt;mlflow.pyfunc.model.PythonModelContext object at 0x13397c530&gt;\&quot;, \&quot;messages\&quot;: [{\&quot;role\&quot;: \&quot;user\&quot;, \&quot;content\&quot;: \&quot;When is the next launch window for Mars? My spacecraft&#x27;s total mass is 50000, dry mass is 10000 and specific impulse is 2500. Mass in Kg.\&quot;, \&quot;name\&quot;: null}], \&quot;params\&quot;: {\&quot;temperature\&quot;: 1.0, \&quot;max_tokens\&quot;: null, \&quot;stop\&quot;: null, \&quot;n\&quot;: 1, \&quot;stream\&quot;: false, \&quot;top_p\&quot;: null, \&quot;top_k\&quot;: null, \&quot;frequency_penalty\&quot;: null, \&quot;presence_penalty\&quot;: null}}&quot;,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  &quot;response&quot;: &quot;{\&quot;choices\&quot;: [{\&quot;index\&quot;: 0, \&quot;message\&quot;: {\&quot;role\&quot;: \&quot;user\&quot;, \&quot;content\&quot;: \&quot;Based on the provided spacecraft dry mass of 10000 kg, total mass of 50000 kg, and specific impulse of 2500 s, the next optimal launch window for a Hohmann transfer from Earth to Mars is on November 26, 2026 UTC. The transfer will take 259 days.\&quot;, \&quot;name\&quot;: null}, \&quot;finish_reason\&quot;: \&quot;stop\&quot;, \&quot;logprobs\&quot;: null}], \&quot;usage\&quot;: {\&quot;prompt_tokens\&quot;: null, \&quot;completion_tokens\&quot;: null, \&quot;total_tokens\&quot;: null}, \&quot;id\&quot;: null, \&quot;model\&quot;: \&quot;anthropic.claude-v2\&quot;, \&quot;object\&quot;: \&quot;chat.completion\&quot;, \&quot;created\&quot;: 1731388550}&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="visualizing-trace-breakdown-in-the-mlflow-ui">Visualizing Trace Breakdown in the MLflow UI<a href="#visualizing-trace-breakdown-in-the-mlflow-ui" class="hash-link" aria-label="Direct link to Visualizing Trace Breakdown in the MLflow UI" title="Direct link to Visualizing Trace Breakdown in the MLflow UI">​</a></h3>
<ol>
<li>
<p><b>Initial Prompt Submitted to the Bedrock Agent.</b>
<img loading="lazy" alt="Thumbnail" src="/mlflow-website/assets/images/bedrock_input_prompt-7841e074dccf4a33f259a45f613147c5.png" width="2898" height="1310" class="img_ev3q"></p>
</li>
<li>
<p><b>In this trace, we can observe how the Bedrock Agent evaluates and selects the most suitable Action Group for the task at hand.</b>
<img loading="lazy" alt="Thumbnail" src="/mlflow-website/assets/images/action_group_decision-221f4cd596874f14b2521595c03f6b60.png" width="2902" height="1364" class="img_ev3q"></p>
</li>
<li>
<p><b>Once an Action Group is selected, its invocation is traced, displaying the input and output interactions with the underlying Lambda function as outlined by the OpenAPI Spec above.</b>
<img loading="lazy" alt="Thumbnail" src="/mlflow-website/assets/images/invoking_action_group-a94489c23d1626bcd67c5d2ce8136621.png" width="2918" height="1264" class="img_ev3q"></p>
</li>
<li>
<p><b>Furthermore, Bedrock&#x27;s supplementary trace is included under the Attributes section,
along with additional metadata as shown below</b>
<img loading="lazy" alt="Thumbnail" src="/mlflow-website/assets/images/traces_attributes-320b4b8b8a9c52bc9dbf4f27248c11ca.png" width="2936" height="1788" class="img_ev3q"></p>
</li>
<li>
<p><b>Subsequently, the final response from the agent is traced, as depicted below.</b>
<img loading="lazy" alt="Thumbnail" src="/mlflow-website/assets/images/retrieved_response-e72339291104fb6659f04c1cedfcbef2.png" width="2914" height="1038" class="img_ev3q"></p>
</li>
</ol>
<p><strong>Note</strong>: We cannot break down the span&#x27;s duration into individual trace durations
because the Bedrock Agent&#x27;s trace response does not include timestamps for each trace step.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>In this blog, we explored how to integrate the AWS Bedrock Agent as an MLflow ChatModel, focusing on Action Groups,
Knowledge Bases, and Tracing. We demonstrated how to easily build a custom ChatModel using MLflow&#x27;s flexible and
powerful APIs. This approach enables you to leverage MLflow&#x27;s tracing and logging capabilities, even for models or
flavors that are not natively supported by MLflow.</p>
<p>Key Takeaways from This Blog:</p>
<ul>
<li>Deploying a Bedrock Agent with Action Groups as AWS Lambda Functions:<!-- -->
<ul>
<li>We covered how to set up a Bedrock Agent and implement custom actions using AWS Lambda functions within Action Groups.</li>
</ul>
</li>
<li>Mapping the AWS Bedrock Agent&#x27;s Custom Tracing to MLflow span/trace objects:<!-- -->
<ul>
<li>We demonstrated how to convert the agent&#x27;s custom tracing data into MLflow span objects for better observability.</li>
</ul>
</li>
<li>Logging and Loading the Bedrock Agent as an MLflow ChatModel:<!-- -->
<ul>
<li>We showed how to log the Bedrock Agent into MLflow as a <em><code>ChatModel</code></em> and how to load it for future use.</li>
</ul>
</li>
<li>Externalizing AWS Client and Bedrock Configurations:<!-- -->
<ul>
<li>We explained how to externalize AWS client and Bedrock configurations to safeguard secrets and make it easy to adjust model settings without the need to re-log the model.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="further-reading-and-references">Further Reading and References<a href="#further-reading-and-references" class="hash-link" aria-label="Direct link to Further Reading and References" title="Direct link to Further Reading and References">​</a></h2>
<ul>
<li><a href="https://docs.aws.amazon.com/bedrock/latest/userguide/agents-how.html" target="_blank" rel="noopener noreferrer">How Amazon Bedrock Agents work</a></li>
<li><a href="https://docs.aws.amazon.com/bedrock/latest/userguide/trace-events.html" target="_blank" rel="noopener noreferrer">Amazon Bedrock Tracing</a></li>
<li><a href="https://mlflow.org/docs/latest/llms/chat-model-guide/index.html" target="_blank" rel="noopener noreferrer">Creating a Custom GenAI chat agent</a></li>
<li><a href="https://github.com/awsdocs/aws-doc-sdk-examples" target="_blank" rel="noopener noreferrer">AWS Code Examples Repository</a></li>
</ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mlflow-website/blog/tags/genai">genai</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mlflow-website/blog/tags/pyfunc">pyfunc</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mlflow-website/blog/tags/bedrock">bedrock</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mlflow-website/blog/tags/tracing">tracing</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="A guide for using LlamaIndex Workflow with MLflow for building advanced QA application."><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/mlflow-website/blog/mlflow-llama-index-workflow">Building Advanced RAG with MLflow and LlamaIndex Workflow</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-10-25T00:00:00.000Z" itemprop="datePublished">October 25, 2024</time> · <!-- -->16 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/yuki-watanabe-a04528164/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="/img/authors/yuki_watanabe.png" alt="Yuki Watanabe" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/yuki-watanabe-a04528164/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Yuki Watanabe</span></a></div><small class="avatar__subtitle" itemprop="description">Software Engineer at Databricks</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><img loading="lazy" alt="Thumbnail" src="/mlflow-website/assets/images/llama_index_workflow_title-c9f3f1bcce4659b5392213c0a2cb25e1.png" width="3338" height="1498" class="img_ev3q"></p>
<p>Augmenting LLMs with various data sources is a strong strategy to build LLM applications. However, as the system grows more complex, it becomes challenging to prototype and iteratively build improvements to these more complex systems.</p>
<p>LlamaIndex Workflow is a great framework to build such compound systems. Combined with MLflow, the Workflow API brings efficiency and robustness in the development cycle, enabling easy debugging, experiment tracking, and evaluation for continuous improvement.</p>
<p>In this blog, we will go through the journey of building a sophisticated chatbot with LlamaIndex&#x27;s Workflow API and MLflow.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-llamaindex-workflow">What is LlamaIndex Workflow?<a href="#what-is-llamaindex-workflow" class="hash-link" aria-label="Direct link to What is LlamaIndex Workflow?" title="Direct link to What is LlamaIndex Workflow?">​</a></h2>
<p><a href="https://docs.llamaindex.ai/en/stable/module_guides/workflow/" target="_blank" rel="noopener noreferrer">LlamaIndex Workflow</a> is an event-driven orchestration framework for designing dynamic AI applications. The core of LlamaIndex Workflow consists of:</p>
<ul>
<li>
<p><code>Steps</code> are units of execution, representing distinct actions in the workflow.</p>
</li>
<li>
<p><code>Events</code> trigger these steps, acting as signals that control the workflow’s flow.</p>
</li>
<li>
<p><code>Workflow</code> connects these two as a Python class. Each step is implemented as a method of the workflow class, defined with input and output events.</p>
</li>
</ul>
<p>This simple yet powerful abstraction allows you to break down complex tasks into manageable steps, enabling greater flexibility and scalability. As a framework embodying event-driven design, using the <code>Workflow</code> APIs makes it intuitive to design parallel and asynchronous execution flows, significantly enhancing the efficiency of long-running tasks and aids in providing production-ready scalability.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="why-use-mlflow-with-llamaindex-workflow">Why Use MLflow with LlamaIndex Workflow?<a href="#why-use-mlflow-with-llamaindex-workflow" class="hash-link" aria-label="Direct link to Why Use MLflow with LlamaIndex Workflow?" title="Direct link to Why Use MLflow with LlamaIndex Workflow?">​</a></h2>
<p>Workflow provides great flexibility to design nearly arbitrary execution flows. However, with this great power comes a great responsibility. Without managing your changes properly, it can become a chaotic mess of indeterminate states and confusing configurations. After a few dozen changes, you may be asking yourself, &quot;how did my workflow even work?&quot;.</p>
<p><strong>MLflow</strong> brings a powerful MLOps harness to LlamaIndex Workflows throughout the end-to-end development cycle.</p>
<ul>
<li>
<p><strong>Experiment Tracking</strong>: MLflow allows you to record various components like steps, prompts, LLMs, and tools, making it easy to improve the system iteratively.</p>
</li>
<li>
<p><strong>Reproducibility</strong>: MLflow packages environment information such as global configurations (<code>Settings</code>), library versions, and metadata to ensure consistent deployment across different stages of the ML lifecycle.</p>
</li>
<li>
<p><strong>Tracing</strong>: Debugging issues in a complex event-driven workflow is cumbersome. MLflow Tracing is a production-ready observability solution that natively integrates with LlamaIndex, giving you observability into each internal stage within your Workflow.</p>
</li>
<li>
<p><strong>Evaluation</strong>: Measuring is a crucial task for improving your model. MLflow Evaluation is great tool to evaluate the quality, speed, and cost of your LLM application. It is tightly integrated with MLflow&#x27;s experiment tracking capabilities, streamlining the process of making iterative improvements.</p>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="lets-build️">Let&#x27;s Build!🛠️<a href="#lets-build️" class="hash-link" aria-label="Direct link to Let&#x27;s Build!🛠️" title="Direct link to Let&#x27;s Build!🛠️">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="strategy-hybrid-approach-using-multiple-retrieval-methods">Strategy: Hybrid Approach Using Multiple Retrieval Methods<a href="#strategy-hybrid-approach-using-multiple-retrieval-methods" class="hash-link" aria-label="Direct link to Strategy: Hybrid Approach Using Multiple Retrieval Methods" title="Direct link to Strategy: Hybrid Approach Using Multiple Retrieval Methods">​</a></h3>
<p>Retrieval-Augmented Generation (RAG) is a powerful framework, but the retrieval step can often become a bottleneck, because embedding-based retrieval may not always capture the most relevant context. While many techniques exist to improve retrieval quality, no single solution works universally. Therefore, an effective strategy is to combine multiple retrieval approaches.</p>
<p>The concept we will explore here is to run several retrieval methods in parallel: (1) standard vector search, (2) keyword-based search (BM25), and (3) web search. The retrieved contexts are then merged, with irrelevant data filtered out to enhance the overall quality.</p>
<p><img loading="lazy" alt="Hybrid RAG Concept" src="/mlflow-website/assets/images/llama_index_workflow_hybrid_rag_concept-91f220154cd696bc022e0d3448b6de15.png" width="1949" height="929" class="img_ev3q"></p>
<p>How do we bring this concept to life? Let’s dive in and build this hybrid RAG using LlamaIndex Workflow and MLflow.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-set-up-repository">1. Set Up Repository<a href="#1-set-up-repository" class="hash-link" aria-label="Direct link to 1. Set Up Repository" title="Direct link to 1. Set Up Repository">​</a></h2>
<p>The sample code, including the environment setup script, is available in the <a href="https://github.com/mlflow/mlflow/tree/master/examples/llama_index/workflow" target="_blank" rel="noopener noreferrer">GitHub repository</a>. It contains a complete workflow definition, a hands-on notebook, and a sample dataset for running experiments. To clone it to your working environment, use the following command:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">git clone https://github.com/mlflow/mlflow.git</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After cloning the repository, set up the virtual environment by running:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">cd mlflow/examples/llama_index/workflow</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">chmod +x install.sh</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">./install.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once the installation is complete, start Jupyter Notebook within the Poetry environment using:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">poetry run jupyter notebook</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Next, open the <code>Tutorial.ipynb</code> notebook located in the root directory. Throughout this blog, we will walk through this notebook to guide you through the development process.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-start-an-mlflow-experiment">2. Start an MLflow Experiment<a href="#2-start-an-mlflow-experiment" class="hash-link" aria-label="Direct link to 2. Start an MLflow Experiment" title="Direct link to 2. Start an MLflow Experiment">​</a></h2>
<p>An <strong>MLflow Experiment</strong> is where you track all aspects of model development, including model definitions, configurations, parameters, dependency versions, and more. Let’s start by creating a new MLflow experiment called &quot;LlamaIndex Workflow RAG&quot;:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> mlflow</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_experiment</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;LlamaIndex Workflow RAG&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>At this point, the experiment doesn&#x27;t have any recorded data yet. To view the experiment in the MLflow UI, open a new terminal and run the <code>mlflow ui</code> command, then navigate to the provided URL in your browser:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">poetry run mlflow ui</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img loading="lazy" alt="Empty MLflow Experiment" src="/mlflow-website/assets/images/llama_index_workflow_empty_experiment-a51068dbf3d59a443672da5aa589c812.png" width="1926" height="418" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-choose-your-llm-and-embeddings">3. Choose your LLM and Embeddings<a href="#3-choose-your-llm-and-embeddings" class="hash-link" aria-label="Direct link to 3. Choose your LLM and Embeddings" title="Direct link to 3. Choose your LLM and Embeddings">​</a></h2>
<p>Now, set up your preferred LLM and embeddings models to LlamaIndex&#x27;s Settings object. These models will be used throughout the LlamaIndex components.</p>
<p>For this demonstration, we’ll use OpenAI models, but you can easily switch to different LLM providers or local models by following the instructions in the notebook.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> getpass</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;OPENAI_API_KEY&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> getpass</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">getpass</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Enter OpenAI API Key&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> llama_index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">core </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> Settings</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> llama_index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">embeddings</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">openai </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> OpenAIEmbedding</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> llama_index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">llms</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">openai </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> OpenAI</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># LlamaIndex by default uses OpenAI APIs for LLMs and embeddings models. You can use the default</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># model (`gpt-3.5-turbo` and `text-embeddings-ada-002` as of Oct 2024), but we recommend using the</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># latest efficient models instead for getting better results with lower cost.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Settings</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">embed_model </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> OpenAIEmbedding</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;text-embedding-3-large&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Settings</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">llm </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> OpenAI</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;gpt-4o-mini&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>💡 <em>MLflow will automatically log the <code>Settings</code> configuration into your MLflow Experiment when logging models, ensuring reproducibility and reducing the risk of discrepancies between environments.</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-set-up-web-search-api">4. Set Up Web Search API<a href="#4-set-up-web-search-api" class="hash-link" aria-label="Direct link to 4. Set Up Web Search API" title="Direct link to 4. Set Up Web Search API">​</a></h2>
<p>Later in this blog, we will add a web search capability to the QA bot. We will use Tavily AI, a search API
optimized for LLM application and natively integrated with LlamaIndex. Visit <a href="https://tavily.com/" target="_blank" rel="noopener noreferrer">their website</a> to
get an API key for free-tier use, or use different search engine integrated with LlamaIndex, e.g. <a href="https://docs.llamaindex.ai/en/stable/api_reference/tools/google/#llama_index.tools.google.GoogleSearchToolSpec" target="_blank" rel="noopener noreferrer">GoogleSearchToolSpec</a>.</p>
<p>Once you get the API key, set it to the environment variable:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;TAVILY_AI_API_KEY&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> getpass</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">getpass</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Enter Tavily AI API Key&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-set-up-document-indices-for-retrieval">5. Set Up Document Indices for Retrieval<a href="#5-set-up-document-indices-for-retrieval" class="hash-link" aria-label="Direct link to 5. Set Up Document Indices for Retrieval" title="Direct link to 5. Set Up Document Indices for Retrieval">​</a></h2>
<p>The next step is to build a document index for retrieval from MLflow documentation. The <code>urls.txt</code> file in the <code>data</code> directory contains a list of MLflow documentation pages. These pages can be loaded as document objects using the web page reader utility.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> llama_index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">readers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">web </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> SimpleWebPageReader</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">with</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;data/urls.txt&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;r&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    urls </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">line</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">strip</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> line </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">file</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> line</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">strip</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">documents </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> SimpleWebPageReader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">html_to_text</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">load_data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">urls</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Next, ingest these documents into a vector database. In this tutorial, we’ll use the <a href="https://qdrant.tech/" target="_blank" rel="noopener noreferrer">Qdrant</a> vector store, which is free if self-hosted. If Docker is installed on your machine, you can start the Qdrant database by running the official Docker container:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ docker pull qdrant/qdrant</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">$ docker run -p 6333:6333 -p 6334:6334 \</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    -v $(pwd)/.qdrant_storage:/qdrant/storage:z \</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    qdrant/qdrant</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once the container is running, you can create an index object that connects to the Qdrant database:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> qdrant_client</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> llama_index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">vector_stores</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">qdrant </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> QdrantVectorStore</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">client </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> qdrant_client</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">QdrantClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">host</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;localhost&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> port</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">6333</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">vector_store </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> QdrantVectorStore</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">client</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">client</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> collection_name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;mlflow_doc&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> llama_index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">core </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> StorageContext</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> VectorStoreIndex</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">storage_context </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> StorageContext</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">from_defaults</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">vector_store</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">vector_store</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">index </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> VectorStoreIndex</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">from_documents</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    documents</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">documents</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    storage_context</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">storage_context</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Of course, you can use your preferred vector store here. LlamaIndex supports a variety of vector databases, such as <a href="https://docs.llamaindex.ai/en/stable/examples/vector_stores/FaissIndexDemo/" target="_blank" rel="noopener noreferrer">FAISS</a>, <a href="https://docs.llamaindex.ai/en/stable/examples/vector_stores/ChromaIndexDemo/" target="_blank" rel="noopener noreferrer">Chroma</a>, and <a href="https://docs.llamaindex.ai/en/stable/examples/vector_stores/DatabricksVectorSearchDemo/" target="_blank" rel="noopener noreferrer">Databricks Vector Search</a>. If you choose an alternative, follow the relevant LlamaIndex documentation and update the <code>workflow/workflow.py</code> file accordingly.</p>
<p>In addition to evaluating the vector search retrieval, we will assess the keyword-based retriever (BM25) later. Let&#x27;s set up local document storage to enable BM25 retrieval in the workflow.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> llama_index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">core</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">node_parser </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> SentenceSplitter</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> llama_index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">retrievers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">bm25 </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> BM25Retriever</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">splitter </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> SentenceSplitter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">chunk_size</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">512</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">nodes </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> splitter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get_nodes_from_documents</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">documents</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">bm25_retriever </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> BM25Retriever</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">from_defaults</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">nodes</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">nodes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">bm25_retriever</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">persist</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;.bm25_retriever&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="6-define-a-workflow">6. Define a Workflow<a href="#6-define-a-workflow" class="hash-link" aria-label="Direct link to 6. Define a Workflow" title="Direct link to 6. Define a Workflow">​</a></h2>
<p>Now that the environment and data sources are ready, we can build the workflow and experiment with it. The complete workflow code is defined in the <code>workflow</code> directory. Let&#x27;s explore some key components of the implementation.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="events">Events<a href="#events" class="hash-link" aria-label="Direct link to Events" title="Direct link to Events">​</a></h3>
<p>The <code>workflow/events.py</code> file defines all the events used within the workflow. These are simple Pydantic models that carry information between workflow steps. For example, the <code>VectorSearchRetrieveEvent</code> triggers the vector search step by passing the user&#x27;s query.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">VectorSearchRetrieveEvent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&quot;&quot;&quot;Event for triggering VectorStore index retrieval step.&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    query</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="prompts">Prompts<a href="#prompts" class="hash-link" aria-label="Direct link to Prompts" title="Direct link to Prompts">​</a></h3>
<p>Throughout the workflow execution, we call LLMs multiple times. The prompt templates for these LLM calls are defined in the <code>workflow/prompts.py</code> file.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="workflow-class">Workflow Class<a href="#workflow-class" class="hash-link" aria-label="Direct link to Workflow Class" title="Direct link to Workflow Class">​</a></h3>
<p>The main workflow class is defined in <code>workflow/workflow.py</code>. Let&#x27;s break down how it works.</p>
<p>The constructor accepts a retrievers argument, which specifies the retrieval methods to be used in the workflow. For instance, if <code>[&quot;vector_search&quot;, &quot;bm25&quot;]</code> is passed, the workflow performs vector search and keyword-based search, skipping web search.</p>
<p>💡 Deciding which retrievers to utilize dynamically allows us to experiment with different retrieval strategies without needing to replicate nearly identical model code.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">HybridRAGWorkflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Workflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    VALID_RETRIEVERS </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;vector_search&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;bm25&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;web_search&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">__init__</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> retrievers</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token plain">kwargs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token builtin" style="color:rgb(86, 156, 214)">super</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">__init__</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token plain">kwargs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">llm </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> Settings</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">llm</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">retrievers </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> retrievers </span><span class="token keyword" style="color:rgb(86, 156, 214)">or</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> invalid_retrievers </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">set</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">retrievers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">VALID_RETRIEVERS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">raise</span><span class="token plain"> ValueError</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f&quot;Invalid retrievers specified: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">invalid_retrievers</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_use_vs_retriever </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;vector_search&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">retrievers</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_use_bm25_retriever </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;bm25&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">retrievers</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_use_web_search </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;web_search&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">retrievers</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_use_vs_retriever</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            qd_client </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> qdrant_client</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">QdrantClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">host</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">_QDRANT_HOST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> port</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">_QDRANT_PORT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            vector_store </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> QdrantVectorStore</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">client</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">qd_client</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> collection_name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">_QDRANT_COLLECTION_NAME</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            index </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> VectorStoreIndex</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">from_vector_store</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">vector_store</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">vector_store</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">vs_retriever </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">as_retriever</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_use_bm25_retriever</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">bm25_retriever </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> BM25Retriever</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">from_persist_dir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">_BM25_PERSIST_DIR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_use_web_search</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tavily_tool </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> TavilyToolSpec</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">api_key</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;TAVILY_AI_API_KEY&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The workflow begins by executing a step that takes the <code>StartEvent</code> as input, which is the <code>route_retrieval</code> step in this case. This step inspects the retrievers parameter and triggers the necessary retrieval steps. By using the <code>send_event()</code> method of the context object, multiple events can be dispatched in parallel from this single step.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># If no retriever is specified, proceed directly to the final query step with an empty context</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">len</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">retrievers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> QueryEvent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">context</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Trigger the retrieval steps based on the configuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_use_vs_retriever</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        ctx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">send_event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">VectorSearchRetrieveEvent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">query</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">query</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_use_bm25_retriever</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        ctx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">send_event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">BM25RetrieveEvent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">query</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">query</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_use_web_search</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        ctx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">send_event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">TransformQueryEvent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">query</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">query</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The retrieval steps are straightforward. However, the web search step is more advanced as it includes an additional step to transform the user&#x27;s question into a search-friendly query using an LLM.</p>
<p>The results from all the retrieval steps are aggregated in the <code>gather_retrieval_results</code> step. Here, the <code>ctx.collect_events()</code> method is used to poll for the results of the asynchronously executed steps.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">    results </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">collect_events</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ev</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">RetrievalResultEvent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">len</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">retrievers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Passing all results from multiple retrievers often leads to a large context with unrelated or duplicate content. To address this, we need to filter and select the most relevant results. While a score-based approach is common, web search results do not return similarity scores. Therefore, we use an LLM to sort and filter out irrelevant results. The rerank step achieves this by leveraging the built-in reranker integration with <a href="https://github.com/sunnweiwei/RankGPT" target="_blank" rel="noopener noreferrer">RankGPT</a>.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">    reranker </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> RankGPTRerank</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">llm</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">llm</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> top_n</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    reranked_nodes </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> reranker</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">postprocess_nodes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ev</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">nodes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> query_str</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">query</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    reranked_context </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;\n&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">join</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">text </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> node </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> reranked_nodes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Finally, the reranked context is passed to the LLM along with the user query to generate the final answer. The result is returned as a <code>StopEvent</code> with the <code>result</code> key.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">@step</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">async</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">query_result</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Context</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> ev</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> QueryEvent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> StopEvent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&quot;&quot;&quot;Get result with relevant text.&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        query </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">await</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;query&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        prompt </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> FINAL_QUERY_TEMPLATE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token builtin" style="color:rgb(86, 156, 214)">format</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">context</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">ev</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">context</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> query</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">query</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">llm</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">complete</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">prompt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">text</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> StopEvent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">result</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now, let&#x27;s instantiate the workflow and run it.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># Workflow with VS + BM25 retrieval</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> workflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">workflow </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> HybridRAGWorkflow</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">workflow </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> HybridRAGWorkflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">retrievers</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;vector_search&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;bm25&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> timeout</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">60</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">await</span><span class="token plain"> workflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">run</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">query</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Why use MLflow with LlamaIndex?&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="7-log-the-workflow-in-an-mlflow-experiment">7. Log the Workflow in an MLflow Experiment<a href="#7-log-the-workflow-in-an-mlflow-experiment" class="hash-link" aria-label="Direct link to 7. Log the Workflow in an MLflow Experiment" title="Direct link to 7. Log the Workflow in an MLflow Experiment">​</a></h2>
<p>Now we want to run the workflow with various different retrieval strategies and evaluate the performance of each. However, before running the evaluation, we&#x27;ll log the model in MLflow to track both the model and its performance within an <strong>MLflow Experiment</strong>.</p>
<p>For the LlamaIndex Workflow, we use the new <a href="https://mlflow.org/docs/latest/models.html#models-from-code" target="_blank" rel="noopener noreferrer">Model-from-code</a> method, which logs models as standalone Python scripts. This approach avoids the risks and instability associated with serialization methods like pickle, relying instead on code as the single source of truth for the model definition. When combined with MLflow&#x27;s environment-freezing capability, it provides a reliable way to persist models. For more details, refer to the <a href="https://mlflow.org/docs/latest/models.html#models-from-code" target="_blank" rel="noopener noreferrer">MLflow documentation</a>.</p>
<p>💡 In the <code>workflow</code> directory, there&#x27;s a <code>model.py</code> script that imports the <code>HybridRAGWorkflow</code> and instantiates it with dynamic configurations passed via the <code>model_config</code> parameter during logging. This design allows you to track models with different configurations without duplicating the model definition.</p>
<p>We&#x27;ll start an MLflow Run and log the model script <code>model.py</code> with different configurations using the <a href="https://mlflow.org/docs/latest/python_api/mlflow.llama_index.html#mlflow.llama_index.log_model" target="_blank" rel="noopener noreferrer">mlflow.llama_index.log_model()</a> API.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># Different configurations we will evaluate. We don&#x27;t run evaluation for all permutation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># for demonstration purpose, but you can add as many patterns as you want.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">run_name_to_retrievers </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># 1. No retrievers (prior knowledge in LLM).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;none&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># 2. Vector search retrieval only.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;vs&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;vector_search&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># 3. Vector search and keyword search (BM25)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;vs + bm25&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;vector_search&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;bm25&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># 4. All retrieval methods including web search.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;vs + bm25 + web&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;vector_search&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;bm25&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;web_search&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Create an MLflow Run and log model with each configuration.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">models </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> run_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> retrievers </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> run_name_to_retrievers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">items</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">with</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">start_run</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">run_name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">run_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        model_info </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">llama_index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">log_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Specify the model Python script.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            llama_index_model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;workflow/model.py&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Specify retrievers to use.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            model_config</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;retrievers&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> retrievers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Define dependency files to save along with the model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            code_paths</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;workflow&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Subdirectory to save artifacts (not important)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            artifact_path</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;model&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        models</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">model_info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now open the MLflow UI again, and this time it should show 4 MLflow Runs are recorded with different <code>retrievers</code> parameter values. By clicking each Run name and navigate to the &quot;Artifacts&quot; tab, you can see MLflow records the model and various metadata, such as dependency versions and settings.</p>
<p><img loading="lazy" alt="MLflow Runs" src="/mlflow-website/assets/images/llama_index_workflow_runs-c68e66f1a2d4b77801bf88bea021d142.png" width="1073" height="352" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="8-enable-mlflow-tracing">8. Enable MLflow Tracing<a href="#8-enable-mlflow-tracing" class="hash-link" aria-label="Direct link to 8. Enable MLflow Tracing" title="Direct link to 8. Enable MLflow Tracing">​</a></h2>
<p>Before running the evaluation, there’s one final step: enabling <strong>MLflow Tracing</strong>. We&#x27;ll dive into this feature and why we do this here later, but for now, you can enable it with a simple one-line command. MLflow will automatically trace every LlamaIndex execution.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">llama_index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">autolog</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="9-evaluate-the-workflow-with-different-retriever-strategies">9. Evaluate the Workflow with Different Retriever Strategies<a href="#9-evaluate-the-workflow-with-different-retriever-strategies" class="hash-link" aria-label="Direct link to 9. Evaluate the Workflow with Different Retriever Strategies" title="Direct link to 9. Evaluate the Workflow with Different Retriever Strategies">​</a></h2>
<p>The example repository includes a sample evaluation dataset, <code>mlflow_qa_dataset.csv</code>, containing 30 question-answer pairs related to MLflow.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> pandas </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> pd</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">eval_df </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">read_csv</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;data/mlflow_qa_dataset.csv&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">display</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">eval_df</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">head</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">3</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To evaluate the workflow, use the <a href="https://mlflow.org/docs/latest/python_api/mlflow.html#mlflow.evaluate" target="_blank" rel="noopener noreferrer">mlflow.evaluate()</a> API, which requires (1) your dataset, (2) the logged model, and (3) the metrics you want to compute.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">metrics </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> latency</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">metrics</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">genai </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> answer_correctness</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> model_info </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> models</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">with</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">start_run</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">run_id</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">model_info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">run_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        result </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">evaluate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Pass the URI of the logged model above</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">model_info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">model_uri</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            data</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">eval_df</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Specify the column for ground truth answers.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            targets</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;ground_truth&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Define the metrics to compute.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            extra_metrics</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                latency</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                answer_correctness</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;openai:/gpt-4o-mini&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># The answer_correctness metric requires &quot;inputs&quot; column to be</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># present in the dataset. We have &quot;query&quot; instead so need to</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># specify the mapping in `evaluator_config` parameter.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            evaluator_config</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;col_mapping&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;inputs&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;query&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this example, we evaluate the model with two metrics:</p>
<ol>
<li><strong>Latency</strong>: Measures the time taken to execute a workflow for a single query.</li>
<li><strong>Answer Correctness</strong>: Evaluates the accuracy of answers based on the ground truth, scored by the OpenAI GPT-4o model on a 1–5 scale.</li>
</ol>
<p>These metrics are just for demonstration purposes—you can add additional metrics like toxicity or faithfulness, or even create your own. See the MLflow documentation for the full set of <a href="https://mlflow.org/docs/latest/llms/llm-evaluate/index.html#llm-evaluation-metrics" target="_blank" rel="noopener noreferrer">built-in metrics</a>
and how to define <a href="https://mlflow.org/docs/latest/llms/llm-evaluate/index.html#creating-custom-llm-evaluation-metrics" target="_blank" rel="noopener noreferrer">custom metrics</a>.</p>
<p>The evaluation process will take a few minutes. Once completed, you can view the results in the MLflow UI. Open the Experiment page and click on the chart icon 📈 above the Run list.</p>
<p><img loading="lazy" alt="Evaluation Result" src="/mlflow-website/assets/images/llama_index_workflow_result_chart-f72c0b1c2b196cc540674020e201c6f4.png" width="2327" height="945" class="img_ev3q"></p>
<p>*💡 The evaluation results can be different depending on model set up and some randomness.</p>
<p>The first row shows bar charts for the answer correctness metrics, while the second row displays latency results. The best-performing combination is &quot;Vector Search + BM25&quot;. Interestingly, adding web search not only increases latency significantly but also decreases answer correctness.</p>
<p>Why does this happen? It appears some answers from the web-search-enabled model are off-topic. For example, in response to a question about starting the Model Registry, the web-search model provides an unrelated answer about model deployment, while the &quot;vs + bm25&quot; model offers a correct response.</p>
<p><img loading="lazy" alt="Answer Comparison" src="/mlflow-website/assets/images/llama_index_workflow_answer_comparison-bad74ed92a791dae40c2bdce61763db4.png" width="1092" height="359" class="img_ev3q"></p>
<p>Where did this incorrect answer come from? This seems to be a retriever issue, as we only changed the retrieval strategy. However, it&#x27;s difficult to see what each retriever returned from the final result. To gain deeper insights into what&#x27;s happening behind the scenes, MLflow Tracing is the perfect solution.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="10-inspecting-quality-issues-with-mlflow-trace">10. Inspecting Quality Issues with MLflow Trace<a href="#10-inspecting-quality-issues-with-mlflow-trace" class="hash-link" aria-label="Direct link to 10. Inspecting Quality Issues with MLflow Trace" title="Direct link to 10. Inspecting Quality Issues with MLflow Trace">​</a></h2>
<p><a href="https://mlflow.org/docs/latest/llms/tracing/index.html" target="_blank" rel="noopener noreferrer">MLflow Tracing</a> is a new feature that brings observability to LLM applications. It integrates seamlessly with LlamaIndex, recording all inputs, outputs, and metadata about intermediate steps during workflow execution. Since we called <code>mlflow.llama_index.autolog()</code> at the start, every LlamaIndex operation has been traced and recorded in the MLflow Experiment.</p>
<p>To inspect the trace for a specific question from the evaluation, navigate to the &quot;Traces&quot; tab on the experiment page. Look for the row with the particular question in the request column and the run name &quot;vs + bm25 + web.&quot; Clicking the request ID link opens the Trace UI, where you can view detailed information about each step in the execution, including inputs, outputs, metadata, and latency.</p>
<p><img loading="lazy" alt="Trace" src="/mlflow-website/assets/images/llama_index_workflow_trace-1783d50c5a0624d8fc1a943806152559.png" width="2990" height="938" class="img_ev3q"></p>
<p>In this case, we identified the issue by examining the reranker step. The web search retriever returned irrelevant context related to model serving, and the reranker incorrectly ranked it as the most relevant. With this insight, we can determine potential improvements, such as refining the reranker to better understand MLflow topics, improving web search precision, or even removing the web search retriever altogether.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>In this blog, we explored how the combination of LlamaIndex and MLflow can elevate the development of Retrieval-Augmented Generation (RAG) workflows, bringing together powerful model management and observability capabilities. By integrating multiple retrieval strategies (such as vector search, BM25, and web search) we demonstrated how flexible retrieval can enhance the performance of LLM-driven applications.</p>
<ul>
<li><strong>Experiment Tracking</strong> allowed us to organize and log different workflow configurations, ensuring reproducibility and enabling us to track model performance across multiple runs.</li>
<li><strong>MLflow Evaluate</strong> enabled us to easily log and evaluate the workflow with different retriever strategies, using key metrics like latency and answer correctness to compare performance.</li>
<li><strong>MLflow UI</strong> gave us a clear visualization of how various retrieval strategies impacted both accuracy and latency, helping us identify the most effective configurations.</li>
<li><strong>MLflow Tracing</strong>, integrated with LlamaIndex, provided detailed observability into each step of the workflow for diagnosing quality issues, such as incorrect reranking of search results.</li>
</ul>
<p>With these tools, you have a complete framework for building, logging, and optimizing RAG workflows. As LLM technology continues to evolve, the ability to track, evaluate, and fine-tune every aspect of model performance will be essential. We highly encourage you to experiment further and see how these tools can be tailored to your own applications.</p>
<p>To continue learning, explore the following resources:</p>
<ul>
<li>Learn more about the <a href="https://mlflow.org/docs/latest/llms/llama-index/index.html" target="_blank" rel="noopener noreferrer">MLflow LlamaIndex integration</a>.</li>
<li>Discover additional MLflow LLM features at <a href="https://mlflow.org/docs/latest/llms/index.html" target="_blank" rel="noopener noreferrer">LLMs in MLflow</a>.</li>
<li>Deploy your workflow to a serving endpoint with <a href="https://mlflow.org/docs/latest/deployment/index.html" target="_blank" rel="noopener noreferrer">MLflow Deployment</a>.</li>
<li>Check out more <a href="https://docs.llamaindex.ai/en/stable/module_guides/workflow/#examples" target="_blank" rel="noopener noreferrer">Workflow examples</a> from LlamaIndex.</li>
</ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mlflow-website/blog/tags/genai">genai</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mlflow-website/blog/tags/mlops">mlops</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mlflow-website/blog/tags/mlflow-evaluate">mlflow-evaluate</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="Perform LLM Evaluations with custom metrics"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/mlflow-website/blog/llm-as-judge">LLM as judge</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-10-03T00:00:00.000Z" itemprop="datePublished">October 3, 2024</time> · <!-- -->17 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/pedro-azevedo-/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="/img/authors/pedro.png" alt="Pedro Azevedo" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/pedro-azevedo-/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Pedro Azevedo</span></a></div><small class="avatar__subtitle" itemprop="description">Machine Learning Analyst at Adidas</small></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/rahulpandey1901/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="/img/ambassadors/Rahul_Pandey.png" alt="Rahul Pandey" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/rahulpandey1901/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Rahul Pandey</span></a></div><small class="avatar__subtitle" itemprop="description">Sr. Solutions Architect at adidas</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>In this blog post, we&#x27;ll dive on a journey to revolutionize how we evaluate language models. We&#x27;ll explore the power of MLflow Evaluate and harness the capabilities of Large Language Models (LLMs) as judges. By the end, you&#x27;ll learn how to create custom metrics, implement LLM-based evaluation, and apply these techniques to real-world scenarios. Get ready to transform your model assessment process and gain deeper insights into your AI&#x27;s performance!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-challenge-of-evaluating-language-models">The Challenge of Evaluating Language Models<a href="#the-challenge-of-evaluating-language-models" class="hash-link" aria-label="Direct link to The Challenge of Evaluating Language Models" title="Direct link to The Challenge of Evaluating Language Models">​</a></h2>
<p>Evaluating large language models (LLMs) and natural language processing (NLP) systems presents several challenges, primarily due to their complexity and the diversity of tasks they can perform.</p>
<p>One major difficulty is creating metrics that comprehensively measure performance across varied applications, from generating coherent text to understanding nuanced human emotions. Traditional benchmarks often fail to capture these subtleties, leading to incomplete assessments.</p>
<p>An LLM acting as a judge can address these issues by leveraging its extensive training data to provide a more nuanced evaluation, offering insights into model behavior and areas needing improvement. For instance, an LLM can analyze whether a model generates text that is not only grammatically correct but also contextually appropriate and engaging, something more static metrics might miss.</p>
<p>However, to move forward effectively, we need more than just better evaluation methods. Standardized experimentation setups are essential to ensure that comparisons between models are both fair and replicable. A uniform framework for testing and evaluation would enable researchers to build on each other&#x27;s work, leading to more consistent progress and the development of more robust models.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introducing-mlflow-llm-evaluate">Introducing MLflow LLM Evaluate<a href="#introducing-mlflow-llm-evaluate" class="hash-link" aria-label="Direct link to Introducing MLflow LLM Evaluate" title="Direct link to Introducing MLflow LLM Evaluate">​</a></h2>
<p><a href="https://mlflow.org/docs/latest/llms/llm-evaluate/index.html" target="_blank" rel="noopener noreferrer">MLflow LLM Evaluate</a> is a powerful function within the MLflow ecosystem that allows for comprehensive model assessment by providing a standardized experiment setup. It supports both built-in metrics and custom (LLM) metrics, making it an ideal tool for evaluating complex language tasks. With <a href="https://mlflow.org/docs/latest/python_api/mlflow.html#mlflow.evaluate" target="_blank" rel="noopener noreferrer">MLflow LLM Evaluate</a>, you can:</p>
<ul>
<li>Evaluate models against multiple metrics simultaneously</li>
<li>Use pre-defined metrics for specific model types (e.g., question-answering, text-summarization and pure text)</li>
<li>Create custom metrics, including those that use LLMs as judges using <a href="https://mlflow.org/docs/latest/python_api/mlflow.metrics.html#mlflow.metrics.genai.make_genai_metric" target="_blank" rel="noopener noreferrer">mlflow.metrics.genai.make_genai_metric()</a>
and
<a href="https://mlflow.org/docs/latest/python_api/mlflow.metrics.html#mlflow.metrics.genai.make_genai_metric_from_prompt" target="_blank" rel="noopener noreferrer">mlflow.metrics.genai.make_genai_metric_from_prompt()</a></li>
</ul>
<p><img loading="lazy" alt="MLflow Evaluate" src="/mlflow-website/assets/images/mlflow_evaluate.drawio-630de00051316c6b28dab80e5626f630.svg" width="700" height="300" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conquering-new-markets-with-an-llm-as-a-judge">Conquering new markets with an LLM as a judge<a href="#conquering-new-markets-with-an-llm-as-a-judge" class="hash-link" aria-label="Direct link to Conquering new markets with an LLM as a judge" title="Direct link to Conquering new markets with an LLM as a judge">​</a></h2>
<p>Imagine you&#x27;re part of a global travel agency, &quot;WorldWide Wandercorp,&quot; that&#x27;s expanding its reach to Spanish-speaking countries.</p>
<p>Your team has developed an AI-powered translation system to help create culturally appropriate marketing materials and customer communications. However, as you begin to use this system, you realize that traditional evaluation metrics, such as BLEU (Bilingual Evaluation Understudy), fall short in capturing the nuances of language translation, especially when it comes to preserving cultural context and idiomatic expressions.</p>
<p>For instance, consider the phrase &quot;kick the bucket.&quot; A direct translation might focus on the literal words, but the idiom actually means &quot;to die.&quot; A traditional metric like BLEU may incorrectly evaluate the translation as adequate if the translated words match a reference translation, even if the cultural meaning is lost. In such cases, the metric might score the translation highly despite it being completely inappropriate in context. This could lead to embarrassing or culturally insensitive marketing content, which is something your team wants to avoid.</p>
<p>You need a way to evaluate whether the translation not only is accurate but also preserves the intended meaning, tone, and cultural context. This is where <a href="https://mlflow.org/docs/latest/python_api/mlflow.html#mlflow.evaluate" target="_blank" rel="noopener noreferrer">MLflow Evaluate</a> and LLMs (Large Language Models) as judges come into play. These tools can assess translations more holistically by considering context, idiomatic expressions, and cultural relevance, providing a more reliable evaluation of the AI’s output.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="custom-metrics-tailoring-evaluation-to-your-needs">Custom Metrics: Tailoring Evaluation to Your Needs<a href="#custom-metrics-tailoring-evaluation-to-your-needs" class="hash-link" aria-label="Direct link to Custom Metrics: Tailoring Evaluation to Your Needs" title="Direct link to Custom Metrics: Tailoring Evaluation to Your Needs">​</a></h2>
<p>In the following section, we’ll implement three metrics:</p>
<ul>
<li>The <code>&quot;cultural_sensitivity&quot;</code> metric ensures translations maintain cultural context and appropriateness.</li>
<li>The <code>&quot;faithfulness&quot;</code> metric checks that chatbot responses align accurately with company policies and retrieved content.</li>
<li>The <code>&quot;toxicity&quot;</code> metric evaluates responses for harmful or inappropriate content, ensuring respectful customer interactions.</li>
</ul>
<p>These metrics will help Worldwide WanderAgency ensure their AI-driven translations and interactions meet their specific needs.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="evaluating-worldwide-wanderagencys-ai-systems">Evaluating Worldwide WanderAgency&#x27;s AI Systems<a href="#evaluating-worldwide-wanderagencys-ai-systems" class="hash-link" aria-label="Direct link to Evaluating Worldwide WanderAgency&#x27;s AI Systems" title="Direct link to Evaluating Worldwide WanderAgency&#x27;s AI Systems">​</a></h2>
<p>Now that we understand WanderAgency&#x27;s challenges, let&#x27;s dive into a code walkthrough to address them. We&#x27;ll implement custom metrics to measure AI performance and build a gauge visualization chart for sharing results with stakeholders.</p>
<p>We&#x27;ll start by evaluating a language translation model, focusing on the &quot;cultural_sensitivity&quot; metric to ensure it preserves cultural nuances. This will help WanderAgency maintain high standards in global communication.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cultural-sensitivity-metric">Cultural Sensitivity Metric<a href="#cultural-sensitivity-metric" class="hash-link" aria-label="Direct link to Cultural Sensitivity Metric" title="Direct link to Cultural Sensitivity Metric">​</a></h3>
<p>The travel agency wants to ensure their translations are not only accurate but also culturally appropriate.
To achieve this they are considering creating a custom metric that allows Worldwide WanderAgency to quantify how well their translations maintain cultural context and idiomatic expressions.</p>
<p>For instance, a phrase that is polite in one culture might be inappropriate in another.
In English, addressing someone as &quot;Dear&quot; in a professional email might be seen as polite. However, in Spanish, using &quot;Querido&quot; in a professional context can be too personal and inappropriate.</p>
<p>How can we evaluate such an abstract concept in a systematic way? Traditional Metrics would fall short so we need a better way of doing it. In this case LLM as a judge would be a great fit!
For this use case let&#x27;s create a &quot;cultural_sensitivity&quot; metric.</p>
<p>Here&#x27;s a brief overview of the process:
Start by installing all the necessary libraries for this demo to work.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">pip install mlflow&gt;=2.14.1 openai  transformers torch torchvision evaluate datasets tiktoken fastapi rouge_score textstat tenacity plotly ipykernel nbformat&gt;=5.10.4</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We will be using gpt3.5 and gpt4 during this example for that let&#x27;s start by making sure our <a href="https://mlflow.org/docs/latest/llms/openai/notebooks/openai-quickstart.html#API-Key-Security-Overview" target="_blank" rel="noopener noreferrer">OpenAI key is setup</a>.</p>
<p>Import the necessary libraries.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> mlflow</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Run a quick validation that we have an entry for the OPEN_API_KEY within environment variables</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">assert</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;OPENAI_API_KEY&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;OPENAI_API_KEY environment variable must be set&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> openai</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> pandas </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> pd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When using the <a href="https://mlflow.org/docs/latest/python_api/mlflow.html#mlflow.evaluate" target="_blank" rel="noopener noreferrer"><code>mlflow.evaluate()</code></a> function, your large language model (LLM) can take one of the following forms:</p>
<ol>
<li>A <code>mlflow.pyfunc.PyFuncModel()</code> — typically an MLflow model.</li>
<li>A Python function that accepts strings as inputs and returns a single string as output.</li>
<li>An <code>MLflow Deployments</code> endpoint URI.</li>
<li><code>model=None</code> if the data you are providing has already been scored by a model, and you do not need to specify one.</li>
</ol>
<p>For this example, we will use an MLflow model.</p>
<p>We’ll begin by logging a translation model in MLflow. For this tutorial, we&#x27;ll use GPT-3.5 with a defined system prompt.</p>
<p>In a production environment, you would typically experiment with different prompts and models to determine the most suitable configuration for your use case. For more details, refer to MLflow’s <a href="https://mlflow.org/docs/latest/llms/prompt-engineering/index.html" target="_blank" rel="noopener noreferrer">Prompt Engineering UI</a>.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">system_prompt </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Translate the following sentences into Spanish&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Let&#x27;s set up an experiment to make it easier to track our results</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_experiment</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;/Path/to/your/experiment&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">basic_translation_model </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">openai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">log_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;gpt-3.5-turbo&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    task</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">openai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">chat</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">completions</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    artifact_path</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;model&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    messages</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;role&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;system&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> system_prompt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;role&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;user&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;{user_input}&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Let&#x27;s test the model to make sure it works.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">model </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">pyfunc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">load_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">basic_translation_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">model_uri</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">predict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Hello, how are you?&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Output = [&#x27;¡Hola, ¿cómo estás?&#x27;]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To use <a href="https://mlflow.org/docs/latest/python_api/mlflow.html#mlflow.evaluate" target="_blank" rel="noopener noreferrer"><code>mlflow.evaluate()</code></a>, we first need to prepare sample data that will serve as input to our LLM. In this scenario, the input would consist of the content the company is aiming to translate.</p>
<p>For demonstration purposes, we will define a set of common English expressions that we want the model to translate.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># Prepare evaluation data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">eval_data </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">DataFrame</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;llm_inputs&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;I&#x27;m over the moon about the news!&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Spill the beans.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Bite the bullet.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Better late than never.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To meet the objectives of the travel agency, we will define custom metrics that evaluate the quality of translations. In particular, we need to assess how faithfully the translations capture not only the literal meaning but also cultural nuances.</p>
<p>By default, <a href="https://mlflow.org/docs/latest/python_api/mlflow.html#mlflow.evaluate" target="_blank" rel="noopener noreferrer"><code>mlflow.evaluate()</code></a> uses <code>openai:/gpt-4</code> as the evaluation model. However, you also have the option to use a <a href="https://mlflow.org/docs/latest/llms/llm-evaluate/index.html#selecting-the-llm-as-judge-model" target="_blank" rel="noopener noreferrer">local model for evaluation</a>, such as a model wrapped in a PyFunc (e.g., Ollama).</p>
<p>For this example, we will use GPT-4 as the evaluation model.</p>
<p>To begin, provide a few examples that illustrate good and poor translation scores.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># Define the custom metric</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">cultural_sensitivity </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">metrics</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">genai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">make_genai_metric</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;cultural_sensitivity&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    definition</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Assesses how well the translation preserves cultural nuances and idioms.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    grading_prompt</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Score from 1-5, where 1 is culturally insensitive and 5 is highly culturally aware.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    examples</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">metrics</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">genai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">EvaluationExample</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token builtin" style="color:rgb(86, 156, 214)">input</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Break a leg!&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            output</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;¡Rómpete una pierna!&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            score</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            justification</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;This is a literal translation that doesn&#x27;t capture the idiomatic meaning.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">metrics</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">genai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">EvaluationExample</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token builtin" style="color:rgb(86, 156, 214)">input</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Break a leg!&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            output</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;¡Mucha mierda!&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            score</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            justification</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;This translation uses the equivalent Spanish theater idiom, showing high cultural awareness.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">metrics</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">genai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">EvaluationExample</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token builtin" style="color:rgb(86, 156, 214)">input</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;It&#x27;s raining cats and dogs.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            output</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Está lloviendo gatos y perros.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            score</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            justification</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;This literal translation does not convey the idiomatic meaning of heavy rain.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">metrics</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">genai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">EvaluationExample</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token builtin" style="color:rgb(86, 156, 214)">input</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;It&#x27;s raining cats and dogs.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            output</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Está lloviendo a cántaros.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            score</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            justification</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;This translation uses a Spanish idiom that accurately conveys the meaning of heavy rain.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">metrics</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">genai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">EvaluationExample</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token builtin" style="color:rgb(86, 156, 214)">input</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Kick the bucket.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            output</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Patear el balde.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            score</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            justification</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;This literal translation fails to convey the idiomatic meaning of dying.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">metrics</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">genai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">EvaluationExample</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token builtin" style="color:rgb(86, 156, 214)">input</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Kick the bucket.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            output</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Estirar la pata.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            score</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            justification</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;This translation uses the equivalent Spanish idiom for dying, showing high cultural awareness.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">metrics</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">genai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">EvaluationExample</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token builtin" style="color:rgb(86, 156, 214)">input</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Once in a blue moon.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            output</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Una vez en una luna azul.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            score</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            justification</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;This literal translation does not capture the rarity implied by the idiom.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">metrics</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">genai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">EvaluationExample</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token builtin" style="color:rgb(86, 156, 214)">input</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Once in a blue moon.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            output</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;De vez en cuando.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            score</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">4</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            justification</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;This translation captures the infrequency but lacks the idiomatic color of the original.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">metrics</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">genai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">EvaluationExample</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token builtin" style="color:rgb(86, 156, 214)">input</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;The ball is in your court.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            output</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;La pelota está en tu cancha.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            score</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">3</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            justification</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;This translation is understandable but somewhat lacks the idiomatic nuance of making a decision.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">metrics</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">genai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">EvaluationExample</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token builtin" style="color:rgb(86, 156, 214)">input</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;The ball is in your court.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            output</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Te toca a ti.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            score</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            justification</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;This translation accurately conveys the idiomatic meaning of it being someone else&#x27;s turn to act.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;openai:/gpt-4&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    parameters</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;temperature&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0.0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-toxicity-metric">The Toxicity Metric<a href="#the-toxicity-metric" class="hash-link" aria-label="Direct link to The Toxicity Metric" title="Direct link to The Toxicity Metric">​</a></h3>
<p>In addition to this custom metric let&#x27;s use MLflow built-in metrics for the evaluators. In this case MLflow wll use roberta-hate-speech model to detect the <a href="https://huggingface.co/spaces/evaluate-measurement/toxicity" target="_blank" rel="noopener noreferrer">toxicity</a>. This metric evaluates responses for any harmful or inappropriate content, reinforcing the company&#x27;s commitment to a positive customer experience.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># Log and evaluate the model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">with</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">start_run</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> run</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    results </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">evaluate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        basic_translation_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">model_uri</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        data</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">eval_data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        model_type</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;text&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        evaluators</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;default&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        extra_metrics</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">cultural_sensitivity</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        evaluator_config</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;col_mapping&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;inputs&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;llm_inputs&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">           </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">   </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">end_run</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can retrieve the final results as such:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">results</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tables</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;eval_results_table&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<table><thead><tr><th></th><th>llm_inputs</th><th>outputs</th><th>token_count</th><th>toxicity/v1/score</th><th>flesch_kincaid_grade_level/v1/score</th><th>ari_grade_level/v1/score</th><th>cultural_sensitivity/v1/score</th><th>cultural_sensitivity/v1/justification</th></tr></thead><tbody><tr><td>0</td><td>I&#x27;m over the moon about the news!</td><td>¡Estoy feliz por la noticia!</td><td>9</td><td>0.000258</td><td>5.2</td><td>3.7</td><td>4</td><td>The translation captures the general sentiment...</td></tr><tr><td>1</td><td>Spill the beans.</td><td>Revela el secreto.</td><td>7</td><td>0.001017</td><td>9.2</td><td>5.2</td><td>5</td><td>The translation accurately captures the idioma...</td></tr><tr><td>2</td><td>Bite the bullet.</td><td>Morder la bala.</td><td>7</td><td>0.001586</td><td>0.9</td><td>3.6</td><td>2</td><td>The translation &quot;Morder la bala&quot; is a litera...</td></tr><tr><td>3</td><td>Better late than never.</td><td>Más vale tarde que nunca.</td><td>7</td><td>0.004947</td><td>0.5</td><td>0.9</td><td>5</td><td>The translation accurately captures the idioma...</td></tr></tbody></table>
<p>Let&#x27;s analyze the final metrics...</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">cultural_sensitivity_score </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> results</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">metrics</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;cultural_sensitivity/v1/mean&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f&quot;Cultural Sensitivity Score: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">cultural_sensitivity_score</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">toxicity_score </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> results</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">metrics</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;toxicity/v1/mean&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Calculate non-toxicity score</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">non_toxicity_score </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;{:.2f}&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token builtin" style="color:rgb(86, 156, 214)">format</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> toxicity_score</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">100</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f&quot;Non-Toxicity Score: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">non_toxicity_score</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">%&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Output:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">Cultural Sensitivity Score: 3.75</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Pureness Score: 99.80</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It is often the case we want to monitor and track these metrics on a dashboard so both data scientists and stakeholders have an understanding of the performance and reliability of these solutions.</p>
<p>For this example let&#x27;s create a gauge to display the final metric.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> plotly</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">graph_objects </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> go</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> plotly</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">subplots </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> make_subplots</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">create_gauge_chart</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">value1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> title1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> value2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> title2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Create a subplot figure with two columns</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    fig </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> make_subplots</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">rows</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> cols</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> specs</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;type&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;indicator&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;type&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;indicator&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Add the first gauge chart</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    fig</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">add_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">go</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Indicator</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        mode </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;gauge+number&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        value </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> value1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        title </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;text&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> title1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        gauge </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;axis&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;range&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> row</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> col</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Add the second gauge chart</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    fig</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">add_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">go</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Indicator</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        mode </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;gauge+number&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        value </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> value2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        title </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;text&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> title2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        gauge </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;axis&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;range&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">100</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> row</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> col</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Update layout</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    fig</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">update_layout</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">height</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">400</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> width</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">800</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Show figure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    fig</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">show</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">create_gauge_chart</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">cultural_sensitive_score</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Cultural Sensitivity Score&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">float</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">non_toxicity_score</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Non Toxicity Score&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img loading="lazy" alt="Gauge Chart" src="/mlflow-website/assets/images/gauge-c21a7facbde6cfee6d102ac805057db2.png" width="800" height="400" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-faithfulness-metric">The Faithfulness Metric<a href="#the-faithfulness-metric" class="hash-link" aria-label="Direct link to The Faithfulness Metric" title="Direct link to The Faithfulness Metric">​</a></h3>
<p>As Worldwide WanderAgency&#x27;s AI grows, they add a customer service chatbot that handles questions in multiple languages. This chatbot uses a RAG (Retrieval-Augmented Generation) system, which means it retrieves information from a database or documents and then generates an answer based on that information.</p>
<p>It&#x27;s important that the answers provided by the chatbot stay true to the information it retrieves. To make sure of this, we create a &quot;faithfulness&quot; metric. This metric checks how well the chatbot&#x27;s responses match the materials it’s supposed to be based on, ensuring the information given to customers is accurate.</p>
<p>For example, If the retrieved document says &quot;Returns are accepted within 30 days,&quot; and the chatbot replies with &quot;Our return policy is flexible and varies by region,&quot; it is not aligning well with the retrieved material. This inaccurate response (bad faithfulness) could mislead customers and create confusion.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="using-mlflow-to-evaluate-rag---faithfulness">Using MLflow to Evaluate RAG - Faithfulness<a href="#using-mlflow-to-evaluate-rag---faithfulness" class="hash-link" aria-label="Direct link to Using MLflow to Evaluate RAG - Faithfulness" title="Direct link to Using MLflow to Evaluate RAG - Faithfulness">​</a></h3>
<p>Let&#x27;s evaluate how well our chatbot is doing in sticking to the retrieved information. Instead of using an MLflow model this time, we’ll use a custom function to define the faithfulness metric and see how aligned the chatbot&#x27;s answers are with the data it pulls from.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># Prepare evaluation data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">eval_data </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">DataFrame</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;llm_inputs&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&quot;&quot;&quot;Question: What is the company&#x27;s policy on employee training?</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">context: &quot;Our company offers various training programs to support employee development. Employees are required to complete at least one training course per year related to their role. Additional training opportunities are available based on performance reviews.&quot; &quot;&quot;&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&quot;&quot;&quot;Question: What is the company&#x27;s policy on sick leave?</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">context: &quot;Employees are entitled to 10 days of paid sick leave per year. Sick leave can be used for personal illness or to care for an immediate family member. A doctor&#x27;s note is required for sick leave exceeding three consecutive days.&quot; &quot;&quot;&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&quot;&quot;&quot;Question: How does the company handle performance reviews?</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">context: &quot;Performance reviews are conducted annually. Employees are evaluated based on their job performance, goal achievement, and overall contribution to the team. Feedback is provided, and development plans are created to support employee growth.&quot; &quot;&quot;&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now let&#x27;s define some examples for this faithfulness metric.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">examples </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">metrics</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">genai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">EvaluationExample</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token builtin" style="color:rgb(86, 156, 214)">input</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&quot;&quot;&quot;Question: What is the company&#x27;s policy on remote work?</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">context: &quot;Our company supports a flexible working environment. Employees can work remotely up to three days a week, provided they maintain productivity and attend all mandatory meetings.&quot; &quot;&quot;&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            output</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Employees can work remotely up to three days a week if they maintain productivity and attend mandatory meetings.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            score</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            justification</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;The answer is accurate and directly related to the question and context provided.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">metrics</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">genai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">EvaluationExample</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token builtin" style="color:rgb(86, 156, 214)">input</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&quot;&quot;&quot;Question: What is the company&#x27;s policy on remote work?</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">context: &quot;Our company supports a flexible working environment. Employees can work remotely up to three days a week, provided they maintain productivity and attend all mandatory meetings.&quot; &quot;&quot;&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            output</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Employees are allowed to work remotely as long as they want.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            score</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            justification</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;The answer is somewhat related but incorrect because it does not mention the three-day limit.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">metrics</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">genai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">EvaluationExample</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token builtin" style="color:rgb(86, 156, 214)">input</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&quot;&quot;&quot;Question: What is the company&#x27;s policy on remote work?</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">context: &quot;Our company supports a flexible working environment. Employees can work remotely up to three days a week, provided they maintain productivity and attend all mandatory meetings.&quot; &quot;&quot;&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            output</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Our company supports flexible work arrangements.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            score</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">3</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            justification</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;The answer is related to the context but does not specifically answer the question about the remote work policy.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">metrics</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">genai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">EvaluationExample</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token builtin" style="color:rgb(86, 156, 214)">input</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&quot;&quot;&quot;Question: What is the company&#x27;s annual leave policy?</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">context: &quot;Employees are entitled to 20 days of paid annual leave per year. Leave must be approved by the employee&#x27;s direct supervisor and should be planned in advance to ensure minimal disruption to work.&quot; &quot;&quot;&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            output</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Employees are entitled to 20 days of paid annual leave per year, which must be approved by their supervisor.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            score</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            justification</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;The answer is accurate and directly related to the question and context provided.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">#  Define the custom metric</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">faithfulness </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">metrics</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">genai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">make_genai_metric</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;faithfulness&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    definition</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Assesses how well the answer relates to the question and provided context.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    grading_prompt</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Score from 1-5, where 1 is not related at all and 5 is highly relevant and accurate.&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    examples</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">examples</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Define out LLM function (in this case it can be any function that follows certain input/output formats that <a href="https://mlflow.org/docs/latest/python_api/mlflow.html#mlflow.evaluate" target="_blank" rel="noopener noreferrer"><code>mlflow.evaluate()</code></a>).</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># Using custom function</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">my_llm</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">inputs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    answers </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    system_prompt </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Please answer the following question in formal language based on the context provided.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> row </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> inputs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">iterrows</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;INPUTS:&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> row</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        completion </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> openai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">chat</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">completions</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">create</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;gpt-3.5-turbo&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            messages</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;role&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;system&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> system_prompt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;role&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;user&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">row</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        answers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">completion</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">choices</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">content</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> answers</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Resulting in a code that is similar to what we did before...</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">with</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">start_run</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> run</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    results </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">evaluate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        my_llm</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        eval_data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        model_type</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;text&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        evaluators</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;default&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        extra_metrics</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">faithfulness</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        evaluator_config</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;col_mapping&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;inputs&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;llm_inputs&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">           </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">end_run</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="genai-metrics">GenAI Metrics<a href="#genai-metrics" class="hash-link" aria-label="Direct link to GenAI Metrics" title="Direct link to GenAI Metrics">​</a></h3>
<p>Alternatively, we can leverage MLflow&#x27;s built-in metrics for generative AI, using the same examples.</p>
<p>MLflow provides several <a href="https://mlflow.org/docs/latest/python_api/mlflow.metrics.html?highlight=genai%20answer#generative-ai-metrics" target="_blank" rel="noopener noreferrer">built-in metrics</a> that use an LLM as a judge. Despite differences in implementation, these metrics are used in the same way. Simply include them in the <code>extra_metrics</code> argument of the <a href="https://mlflow.org/docs/latest/python_api/mlflow.html#mlflow.evaluate" target="_blank" rel="noopener noreferrer"><code>mlflow.evaluate()</code></a> function.</p>
<p>In this case, we will use MLflow’s built-in <a href="https://mlflow.org/docs/latest/python_api/mlflow.metrics.html?highlight=genai%20answer#mlflow.metrics.genai.faithfulness" target="_blank" rel="noopener noreferrer">faithfulness metric</a>.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">metrics</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">genai </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> EvaluationExample</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> faithfulness</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">faithfulness_metric </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> faithfulness</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;openai:/gpt-4&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">faithfulness_metric</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><a href="https://mlflow.org/docs/latest/python_api/mlflow.html#mlflow.evaluate" target="_blank" rel="noopener noreferrer"><code>mlflow.evaluate()</code></a> simplifies the process of providing grading context, such as the documents retrieved by our system, directly into the evaluation. This feature integrates seamlessly with <a href="https://python.langchain.com/docs/concepts/#retrievers" target="_blank" rel="noopener noreferrer">LangChain&#x27;s retrievers</a>, allowing you to supply the context for evaluation as a dedicated column. For more details, refer to <a href="https://mlflow.org/docs/latest/llms/llm-evaluate/notebooks/rag-evaluation-llama2.html" target="_blank" rel="noopener noreferrer">this example</a>.</p>
<p>In this case, since our retrieved documents are already included within the final prompt and we are not leveraging LangChain for this tutorial, we will simply map the <code>llm_input</code> column as our grading context.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">with</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">start_run</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> run</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    results </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">evaluate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        my_llm</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        eval_data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        model_type</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;text&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        evaluators</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;default&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        extra_metrics</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">faithfulness_metric</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        evaluator_config</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;col_mapping&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;inputs&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;llm_inputs&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;context&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;llm_inputs&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">           </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">end_run</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After the evaluation we get the following results:
<img loading="lazy" alt="Gauge faithfulness Chart" src="/mlflow-website/assets/images/faithfulness-246906b0fa032bfe3bed8cdee648d7bf.png" width="800" height="400" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>By combining the Cultural Sensitivity score with our other calculated metrics, our travel agency can further refine its model to ensure the delivery of high-quality content across all languages. Moving forward, we can revisit and adjust the prompts used to boost our Cultural Sensitivity score. Alternatively, we could fine-tune a smaller model to maintain the same high level of cultural sensitivity while reducing costs. These steps will help us provide even better service to the agency&#x27;s diverse customer base.</p>
<p><a href="https://mlflow.org/docs/latest/python_api/mlflow.html#mlflow.evaluate" target="_blank" rel="noopener noreferrer"><code>mlflow.evaluate()</code></a>, combined with LLMs as judges, opens up new possibilities for nuanced and context-aware model evaluation. By creating custom metrics tailored to specific aspects of model performance, data scientists can gain deeper insights into their models&#x27; strengths and weaknesses.</p>
<p>The flexibility offered by <code>make_genai_metric()</code> allows you to create evaluation criteria that are perfectly suited to your specific use case. Whether you need structured guidance for your LLM judge or want full control over the prompting process, MLflow provides the tools you need.</p>
<p>As you explore MLflow evaluate and LLM-based metrics, remember that the key lies in designing thoughtful evaluation criteria and providing clear instructions to your LLM judge. With these tools at your disposal, you&#x27;re well-equipped to take your model evaluation to the next level, ensuring that your language models not only perform well on traditional metrics but also meet the nuanced requirements of real-world applications.</p>
<p>The built-in metrics, such as toxicity, offer standardized assessments that are crucial for ensuring the safety and accessibility of model outputs.</p>
<p>As a final challenge, re-run all the tests performed but this time with &quot;gpt-4o-mini&quot; and see how the performance is affected.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mlflow-website/blog/tags/genai">genai</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mlflow-website/blog/tags/mlflow-evalaute">mlflow-evalaute</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="We all (well, most of us) remember November 2022 when the public release of ChatGPT by OpenAI marked a significant turning point in the world of AI. While generative artificial intelligence (GenAI) had been evolving for some time, ChatGPT, built on OpenAI&#x27;s GPT-3.5 architecture, quickly captured the public’s imagination. This led to an explosion of interest in GenAI, both within the tech industry and among the general public."><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/mlflow-website/blog/models_from_code">Models from Code Logging in MLflow - What, Why, and How</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-09-13T00:00:00.000Z" itemprop="datePublished">September 13, 2024</time> · <!-- -->12 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/awadelrahman/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="/img/authors/awadelrahman_ahmed.png" alt="Awadelrahman M. A. Ahmed" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/awadelrahman/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Awadelrahman M. A. Ahmed</span></a></div><small class="avatar__subtitle" itemprop="description">MLflow Ambassador | Cloud Data &amp; Analytics Architect at REMA 1000</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>We all (well, most of us) remember November 2022 when the public release of ChatGPT by OpenAI marked a significant turning point in the world of AI. While generative artificial intelligence (GenAI) had been evolving for some time, ChatGPT, built on OpenAI&#x27;s GPT-3.5 architecture, quickly captured the public’s imagination. This led to an explosion of interest in GenAI, both within the tech industry and among the general public.</p>
<p>On the tools side, MLflow continues to solidify its position as the favorite tool for (machine learning operations) MLOps among the ML community. However, the rise of GenAI has introduced new needs in how we use MLflow. One of these new challenges is how we log models in MLflow. If you’ve used MLflow before (and I bet you have), you’re probably familiar with the <code>mlflow.log_model()</code> function and how it efficiently <a href="https://github.com/cloudpipe/cloudpickle" target="_blank" rel="noopener noreferrer">pickles</a> model artifacts.</p>
<p>Particularly with GenAI, there’s a new requirement: logging the models &quot;from code&quot;, instead of serializing it into a pickle file! And guess what? This need isn’t limited to GenAI models! So, in this post I will explore this concept and how MLflow has adapted to meet this new requirement.</p>
<p>You will notice that this feature is implemented at a very abstract level, allowing you to log any model &quot;as code&quot;, whether it’s GenAI or not! I like to think of it as a generic approach, with GenAI models being just one of its use cases. So, in this post, I’ll explore this new feature, <a href="https://mlflow.org/docs/latest/models.html#models-from-code" target="_blank" rel="noopener noreferrer">&quot;Models from Code logging&quot;</a>.</p>
<p>By the end of this post, you should be able to answer the three main questions: &#x27;What,&#x27; &#x27;Why,&#x27; and &#x27;How&#x27; to use Models from Code logging.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-models-from-code-logging">What Is Models from Code Logging?<a href="#what-is-models-from-code-logging" class="hash-link" aria-label="Direct link to What Is Models from Code Logging?" title="Direct link to What Is Models from Code Logging?">​</a></h2>
<p>In fact, when MLflow announced this feature, it got me thinking in a more abstract way about the concept of a &quot;model&quot;! You might find it interesting as well, if you zoom out and consider a model as a mathematical representation or function that describes the relationship between input and output variables. At this level of abstraction, a model can be many things!</p>
<p>One might even recognize that a model, as an object or artifact, represents just one form of what a model can be, even if it’s the most popular in the ML community. If you think about it, a model can also be as simple as a piece of code for a mapping function or a code that sends API requests to external services such as OpenAI&#x27;s APIs.</p>
<p>I&#x27;ll explain the detailed workflow of how to log models from code later in the post, but for now, let&#x27;s consider it at a high level with two main steps: first, writing your model code, and second, logging your model from code. This will look like the following figure:</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="high-level-models-from-code-logging-workflow"><em>High Level Models from Code Logging Workflow</em>:<a href="#high-level-models-from-code-logging-workflow" class="hash-link" aria-label="Direct link to high-level-models-from-code-logging-workflow" title="Direct link to high-level-models-from-code-logging-workflow">​</a></h4>
<p><img loading="lazy" alt="High Level Models-from-Code Logging Workflow" src="/mlflow-website/assets/images/models-from-code1-5f8830b7ddd337699499b466a530057d.png" width="2629" height="379" class="img_ev3q"></p>
<p>🔴 It&#x27;s important to note that when we refer to &quot;model code,&quot; we&#x27;re talking about code that can be treated as a model itself. This means it&#x27;s <strong>not</strong> your training code that generates a trained model object, but rather the step-by-step code that is executed as a model itself.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-models-from-code-differs-from-object-based-logging">How Models from Code Differs from Object-Based Logging?<a href="#how-models-from-code-differs-from-object-based-logging" class="hash-link" aria-label="Direct link to How Models from Code Differs from Object-Based Logging?" title="Direct link to How Models from Code Differs from Object-Based Logging?">​</a></h2>
<p>In the previous section, we discussed the concept of Models from Code logging. However, concepts often become clearer when contrasted with their alternatives; a technique known as <em>contrast learning</em>. In our case, the alternative is Object-Based logging, which is the commonly used approach for logging models in MLflow.</p>
<p>Object-Based logging treats a trained model as an <em>object</em> that can be stored and reused. After training, the model is saved as an object and can be easily loaded for deployment. For example, this process can be initiated by calling <code>mlflow.log_model()</code>, where MLflow handles the serialization, often using <a href="https://github.com/cloudpipe/cloudpickle" target="_blank" rel="noopener noreferrer">Pickle</a> or similar methods.</p>
<p>Object-Based logging can be broken down into three high-level steps as in the following figure: first, creating the model object (whether by training it or acquiring it), second, serializing it (usually with Pickle or a similar tool), and third, logging it as an object.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="high-level-object-based-logging-workflow"><em>High Level Object-Based Logging Workflow</em>:<a href="#high-level-object-based-logging-workflow" class="hash-link" aria-label="Direct link to high-level-object-based-logging-workflow" title="Direct link to high-level-object-based-logging-workflow">​</a></h4>
<p><img loading="lazy" alt="High Level Object-Based Logging Workflow" src="/mlflow-website/assets/images/models-from-code2-732b1bd2a33af059779d03ca39902f78.png" width="2629" height="525" class="img_ev3q"></p>
<p>💡The main distinction between the popular Object-Based logging and Models from Code logging is that in the former, we log the model object itself, whether it&#x27;s a model you&#x27;ve trained or a pre-trained model you&#x27;ve acquired. In the latter, however, we log the code that <em>represents</em> your model.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="when-do-you-need-models-from-code-logging">When Do You Need Models from Code Logging?<a href="#when-do-you-need-models-from-code-logging" class="hash-link" aria-label="Direct link to When Do You Need Models from Code Logging?" title="Direct link to When Do You Need Models from Code Logging?">​</a></h2>
<p>By now, I hope you have a clear understanding of <em>what</em> Models from Code logging is! You might still be wondering, though, about the specific use cases where this feature can be applied. This section will cover exactly that—the why!</p>
<p>While we mentioned GenAI as a motivational use case in the introduction, we also highlighted that MLflow has approached Models from Code logging in a more generic way and we will see that in the next section. This means you can leverage the generalizability of the Models from Code feature for a wide range of scenarios. I’ve identified three key usage patterns that I believe are particularly relevant:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1️⃣-when-your-model-relies-on-external-services">1️⃣ When Your Model Relies on External Services:<a href="#1️⃣-when-your-model-relies-on-external-services" class="hash-link" aria-label="Direct link to 1️⃣ When Your Model Relies on External Services:" title="Direct link to 1️⃣ When Your Model Relies on External Services:">​</a></h3>
<p>This is one of the obvious and common use cases, especially with the rise of modern AI applications. It’s becoming increasingly clear that we are shifting from building AI at the &quot;model&quot; granularity to the &quot;system&quot; granularity.</p>
<p>In other words, AI is no longer just about individual models; it’s about how those models interact within a broader ecosystem. As we become more dependent on external AI services and APIs, the need for Models from Code logging becomes more pronounced.</p>
<p>For instance, frameworks like <a href="https://github.com/langchain-ai/langchain/" target="_blank" rel="noopener noreferrer">LangChain</a> allow developers to build applications that chain together various AI models and services to perform complex tasks, such as language understanding and information retrieval. In such scenarios, the &quot;model&quot; is not just a set of trained parameters that can be <em>pickled</em> but a &quot;system&quot; of interconnected services, often orchestrated by code that makes API calls to external platforms.</p>
<p>Models from Code logging in these situations ensures that the entire workflow, including the logic and dependencies, is preserved. It offers is the ability to maintain the same model-like experience by capturing the code making it possible to faithfully recreate the model’s behavior, even when the actual computational work is performed outside your domain.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2️⃣-when-youre-combining-multiple-models-to-calculate-a-complex-metric">2️⃣ When You’re Combining Multiple Models to Calculate a Complex Metric:<a href="#2️⃣-when-youre-combining-multiple-models-to-calculate-a-complex-metric" class="hash-link" aria-label="Direct link to 2️⃣ When You’re Combining Multiple Models to Calculate a Complex Metric:" title="Direct link to 2️⃣ When You’re Combining Multiple Models to Calculate a Complex Metric:">​</a></h3>
<p>Apart from GenAI, you can still benefit from the Models from Code feature in various other domains. There are many situations where multiple specialized models are combined to produce a comprehensive output. Note that we are not just referring to traditional ensemble modeling (predicting the same variable); often, you need to combine multiple models to predict different components of a complex inferential task.</p>
<p>One concrete example could be <a href="https://en.wikipedia.org/wiki/Customer_lifetime_value" target="_blank" rel="noopener noreferrer">Customer Lifetime Value (CLV)</a> in customer analytics. In the context of CLV, you might have separate models for:</p>
<ul>
<li>Customer Retention: Forecasting how long a customer will continue to engage with the business.</li>
<li>Purchase Frequency: Predicting how often a customer will make a purchase.</li>
<li>Average Order Value: Estimating the typical value of each transaction.</li>
</ul>
<p>Each of these models might already be logged and tracked properly using MLflow. Now, you need to &quot;combine&quot; these models into a single &quot;system&quot; that calculates CLV. We refer to it as a &quot;system&quot; because it contains multiple components.</p>
<p>The beauty of MLflow&#x27;s Models from Code logging is that it allows you to treat this &quot;CLV system&quot; as a &quot;CLV model&quot;. It enables you to leverage MLflow&#x27;s capabilities, maintaining the MLflow-like model structure with all the advantages of tracking, versioning, and deploying your CLV model as a cohesive unit, even though it&#x27;s built on top of other models. While such a complex model system is able to be built using a custom MLflow PythonModel, utilizing the Models from Code feature dramatically simplifies the serialization process, reducing the friction to building your solution.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3️⃣-when-you-dont-have-serialization-at-all">3️⃣ When You Don’t Have Serialization at All:<a href="#3️⃣-when-you-dont-have-serialization-at-all" class="hash-link" aria-label="Direct link to 3️⃣ When You Don’t Have Serialization at All:" title="Direct link to 3️⃣ When You Don’t Have Serialization at All:">​</a></h3>
<p>Despite the rise of deep learning, industries still rely on rule-based algorithms that don’t produce serialized models. In these cases, Models from Code logging can be beneficial for integrating these processes into the MLflow ecosystem.</p>
<p>One example is in industrial quality control, where the <a href="https://en.wikipedia.org/wiki/Canny_edge_detector" target="_blank" rel="noopener noreferrer">Canny edge detection algorithm</a> is often used to identify defects. This rule-based algorithm doesn’t involve serialization but is defined by specific steps.</p>
<p>Another example, which is gaining attention nowadays, is <a href="https://en.wikipedia.org/wiki/Causal_AI" target="_blank" rel="noopener noreferrer">Causal AI</a>. Constraint-based causal discovery algorithms like the <a href="https://causal-learn.readthedocs.io/en/latest/search_methods_index/Constraint-based%20causal%20discovery%20methods/PC.html" target="_blank" rel="noopener noreferrer">PC (Peter-Clark)</a> algorithm that discover causal relationships in data but are implemented as code rather than as model objects.</p>
<p>In either case, with the Models from Code feature, you can log the entire process as a &quot;model&quot; in MLflow, preserving the logic and parameters while benefiting from MLflow’s tracking and versioning features.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-implement-models-from-code-logging">How To Implement Models from Code Logging?<a href="#how-to-implement-models-from-code-logging" class="hash-link" aria-label="Direct link to How To Implement Models from Code Logging?" title="Direct link to How To Implement Models from Code Logging?">​</a></h2>
<p>I hope that by this point, you have a clear understanding of the &quot;What&quot; and &quot;Why&quot; of Models from Code, and now you might be eager to get hands-on and focus on the <em>How</em>!</p>
<p>In this section, I&#x27;ll provide a generic workflow for implementing MLflow&#x27;s Models from Code logging, followed by a basic yet broadly applicable example. I hope the workflow provides a broad understanding that allows you to address a wide range of scenarios. I will also include links at the end to resources that cover more specific use cases (e.g., AI models).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="models-from-code-workflow">Models from Code Workflow:<a href="#models-from-code-workflow" class="hash-link" aria-label="Direct link to Models from Code Workflow:" title="Direct link to Models from Code Workflow:">​</a></h3>
<p>A key &quot;ingredient&quot; of the implementation is MLflow&#x27;s component <a href="https://mlflow.org/docs/latest/python_api/mlflow.pyfunc.html" target="_blank" rel="noopener noreferrer"><code>pyfunc</code></a>. If you&#x27;re not familiar with it, think of <code>pyfunc</code> as a universal interface in MLflow that lets you turn any model, from any framework, into an MLflow model by defining a <em>custom</em> Python function. You can also refer to <a href="https://mlflow.org/blog/custom-pyfunc" target="_blank" rel="noopener noreferrer">this earlier post</a> if you wish to gain a deeper understanding.</p>
<p>For our Models from Code logging, we’ll particularly use the <a href="https://mlflow.org/docs/latest/_modules/mlflow/pyfunc/model.html#PythonModel" target="_blank" rel="noopener noreferrer"><code>PythonModel</code></a> class within <code>pyfunc</code>. This class in the MLflow Python client library allows us to create and manage Python functions as MLflow models. It enables us to define a custom function that processes input data and returns predictions or results. This model can then be deployed, tracked, and shared using MLflow&#x27;s features.</p>
<p>It seems to be exactly what we&#x27;re looking for—we have some code that serves as our model, and we want to log it! That&#x27;s why you&#x27;ll soon see <code>mlflow.pyfunc.PythonModel</code> in our code example!</p>
<p>Now, each time we need to implement Models from Code, we create <em>two</em> separate Python files:</p>
<ol>
<li>
<p>The first contains our model code (let&#x27;s call it <code>model_code.py</code>). This file contains a class that inherits from the <code>mlflow.pyfunc.PythonModel</code> class.
The class we&#x27;re defining contains our model logic. It could be our calls to OpenAI APIs, CLV (Customer Lifetime Value) model, or our causal discovery code. We&#x27;ll see a very simple 101 example soon.</p>
<p>📌 But wait! IMPORTANT:</p>
<ul>
<li>Our <code>model_code.py</code> script needs to call (i,e; include) <a href="https://mlflow.org/docs/latest/python_api/mlflow.models.html#mlflow.models.set_model" target="_blank" rel="noopener noreferrer"><code>mlflow.models.set_model()</code></a> to set the model, which is crucial for loading the model back using <code>load_model()</code> for inference. You will notice this in the example.</li>
</ul>
</li>
<li>
<p>The second file logs our class (that we defined in <code>model_code.py</code>). Think of it as the driver code; it can be either a notebook or a Python script (let&#x27;s call it <code>driver.py</code>).
In this file, we&#x27;ll include the code that is responsible for logging our model code (essentially, providing the path to <code>model_code.py</code>) .</p>
</li>
</ol>
<p>Then we can deploy our model. Later, when the serving environment is loaded, <code>model_code.py</code> is executed, and when a serving request comes in, <code>PyFuncClass.predict()</code> is called.</p>
<p>This figure gives a generic template of these two files.</p>
<p><img loading="lazy" alt="Models from Code files" src="/mlflow-website/assets/images/models-from-code3-16100bbac4ffc50ceab80d52ecce642e.png" width="4242" height="1395" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="a-101-example-of-model-from-code-logging-">A 101 Example of Model from Code Logging :<a href="#a-101-example-of-model-from-code-logging-" class="hash-link" aria-label="Direct link to A 101 Example of Model from Code Logging :" title="Direct link to A 101 Example of Model from Code Logging :">​</a></h3>
<p>Let’s consider a straightforward example: a simple function to calculate the area of a circle based on its diameter. With Models from Code, we can log this calculation as a model! I like to think of it as framing the calculation as a prediction problem, allowing us to write our model code with a <code>predict</code> method.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-our-model_codepy-file-">1. Our <code>model_code.py</code> file :<a href="#1-our-model_codepy-file-" class="hash-link" aria-label="Direct link to 1-our-model_codepy-file-" title="Direct link to 1-our-model_codepy-file-">​</a></h4>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> mlflow</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> math</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">CircleAreaModel</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">pyfunc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">PythonModel</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">predict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> model_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> params</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">math</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">pi </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">r </span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> r </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> model_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># It&#x27;s important to call set_model() so it can be loaded for inference</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Also, note that it is set to an instance of the class, not the class itself.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">models</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">CircleAreaModel</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-our-driverpy-file-">2. Our <code>driver.py</code> file :<a href="#2-our-driverpy-file-" class="hash-link" aria-label="Direct link to 2-our-driverpy-file-" title="Direct link to 2-our-driverpy-file-">​</a></h4>
<p>This can be defined within a notebook as well. Here are its essential contents:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> mlflow</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">code_path </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;model_code.py&quot;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)"># make sure that you put the correct path</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">with</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">start_run</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  logged_model_info </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">pyfunc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">log_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                            python_model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">code_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                            artifact_path</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;test_code_logging&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">#We can proint some info about the logged model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f&quot;MLflow Run: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">logged_model_info</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-interpolation interpolation">run_id</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f&quot;Model URI: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">logged_model_info</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-interpolation interpolation">model_uri</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="how-that-looks-like-on-mlflow">How that looks like on MLflow:<a href="#how-that-looks-like-on-mlflow" class="hash-link" aria-label="Direct link to How that looks like on MLflow:" title="Direct link to How that looks like on MLflow:">​</a></h4>
<p>Executing the <code>driver.py</code> will start an MLflow run and log our model as code. The files can been as demonstrated below:</p>
<p><img loading="lazy" alt="Models from Code files" src="/mlflow-website/assets/images/models-from-code4-26c1a4d1a36f0a6e510124e13abd38d6.png" width="3413" height="4259" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion-and-further-learning">Conclusion and Further Learning<a href="#conclusion-and-further-learning" class="hash-link" aria-label="Direct link to Conclusion and Further Learning" title="Direct link to Conclusion and Further Learning">​</a></h2>
<p>I hope that by this point, I have fulfilled the promises I made earlier! You should now have a clearer understanding of <em>What</em> Models from Code is and how it differs from the popular Object-Based approach which logs models as serialized objects. You should also have a solid foundation of <em>Why</em> and when to use it, as well as an understanding of <em>How</em> to implement it through our general example.</p>
<p>As we mentioned in the introduction and throughout the post, there are various use cases where Models from Code can be beneficial. Our 101 example is just the beginning—there is much more to explore. Below is a list of code examples that you may find helpful:</p>
<ol>
<li>Logging models from code using <strong>Pyfunc</strong> log model API ( <a href="https://github.com/mlflow/mlflow/blob/a3454610285e3729266e5e94041d06bd2bc55ff6/examples/pyfunc/model_as_code.py" target="_blank" rel="noopener noreferrer">model code</a> | <a href="https://github.com/mlflow/mlflow/blob/a3454610285e3729266e5e94041d06bd2bc55ff6/examples/pyfunc/model_as_code_driver.py" target="_blank" rel="noopener noreferrer">driver code</a> )</li>
<li>Logging model from code using <strong>Langchain</strong> log model API ( <a href="https://github.com/mlflow/mlflow/blob/a3454610285e3729266e5e94041d06bd2bc55ff6/examples/langchain/chain_as_code.py" target="_blank" rel="noopener noreferrer">model code</a> | <a href="https://github.com/mlflow/mlflow/blob/a3454610285e3729266e5e94041d06bd2bc55ff6/examples/langchain/chain_as_code_driver.py" target="_blank" rel="noopener noreferrer">driver code</a> )</li>
</ol></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mlflow-website/blog/tags/genai">genai</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mlflow-website/blog/tags/pyfunc">pyfunc</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mlflow-website/blog/tags/mlops">mlops</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="A guide for building an autonomous image generation agent"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/mlflow-website/blog/autogen-image-agent">AutoGen with Custom PyFunc</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-08-29T00:00:00.000Z" itemprop="datePublished">August 29, 2024</time> · <!-- -->22 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/-michael-berk/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="/img/authors/michael_berk.png" alt="Michael Berk" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/-michael-berk/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Michael Berk</span></a></div><small class="avatar__subtitle" itemprop="description">Sr. Resident Solutions Architect at Databricks</small></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/mlflow/mlflow.git" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/mlflow-automation.png" alt="MLflow maintainers" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/mlflow/mlflow.git" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">MLflow maintainers</span></a></div><small class="avatar__subtitle" itemprop="description">MLflow maintainers</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>In this blog, we&#x27;ll guide you through creating an <a href="https://microsoft.github.io/autogen/" target="_blank" rel="noopener noreferrer">AutoGen</a> agent framework within an MLflow custom PyFunc. By combining MLflow with AutoGen&#x27;s ability to create multi-agent frameworks, we are able to create scalable and stable GenAI applications.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="agent-frameworks">Agent Frameworks<a href="#agent-frameworks" class="hash-link" aria-label="Direct link to Agent Frameworks" title="Direct link to Agent Frameworks">​</a></h2>
<p>Agent frameworks enable autonomous agents to handle complex, multi-turn tasks by integrating discrete logic at each step. These frameworks are crucial for LLM-driven workflows, where agents manage dynamic interactions across multiple stages. Each agent operates based on specific logic, enabling precise task automation, decision-making, and coordination. This is ideal for applications like workflow orchestration, customer support, and multi-agent systems, where LLMs must interpret evolving context and respond accordingly.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mlflow-website/blog/tags/genai">genai</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mlflow-website/blog/tags/mlops">mlops</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about AutoGen with Custom PyFunc" href="/mlflow-website/blog/autogen-image-agent"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="In this blog, we&#x27;ll guide you through creating a LangGraph chatbot using MLflow. By combining MLflow with LangGraph&#x27;s ability to create and manage cyclical graphs, you can create powerful stateful, multi-actor applications in a scalable fashion."><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/mlflow-website/blog/langgraph-model-from-code">LangGraph with Model From Code</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-08-06T00:00:00.000Z" itemprop="datePublished">August 6, 2024</time> · <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/-michael-berk/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="/img/authors/michael_berk.png" alt="Michael Berk" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/-michael-berk/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Michael Berk</span></a></div><small class="avatar__subtitle" itemprop="description">Sr. Resident Solutions Architect at Databricks</small></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/mlflow/mlflow.git" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/mlflow-automation.png" alt="MLflow maintainers" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/mlflow/mlflow.git" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">MLflow maintainers</span></a></div><small class="avatar__subtitle" itemprop="description">MLflow maintainers</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>In this blog, we&#x27;ll guide you through creating a LangGraph chatbot using MLflow. By combining MLflow with LangGraph&#x27;s ability to create and manage cyclical graphs, you can create powerful stateful, multi-actor applications in a scalable fashion.</p>
<p>Throughout this post we will demonstrate how to leverage MLflow&#x27;s capabilities to create a serializable and servable MLflow model which can easily be tracked, versioned, and deployed on a variety of servers. We&#x27;ll be using the <a href="https://mlflow.org/docs/latest/llms/langchain/index.html" target="_blank" rel="noopener noreferrer">langchain flavor</a> combined with MLflow&#x27;s <a href="https://mlflow.org/docs/latest/models.html#models-from-code" target="_blank" rel="noopener noreferrer">model from code</a> feature.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-langgraph">What is LangGraph?<a href="#what-is-langgraph" class="hash-link" aria-label="Direct link to What is LangGraph?" title="Direct link to What is LangGraph?">​</a></h3>
<p><a href="https://langchain-ai.github.io/langgraph/" target="_blank" rel="noopener noreferrer">LangGraph</a> is a library for building stateful, multi-actor applications with LLMs, used to create agent and multi-agent workflows. Compared to other LLM frameworks, it offers these core benefits:</p>
<ul>
<li><strong>Cycles and Branching</strong>: Implement loops and conditionals in your apps.</li>
<li><strong>Persistence</strong>: Automatically save state after each step in the graph. Pause and resume the graph execution at any point to support error recovery, human-in-the-loop workflows, time travel and more.</li>
<li><strong>Human-in-the-Loop</strong>: Interrupt graph execution to approve or edit next action planned by the agent.</li>
<li><strong>Streaming Support</strong>: Stream outputs as they are produced by each node (including token streaming).</li>
<li><strong>Integration with LangChain</strong>: LangGraph integrates seamlessly with LangChain.</li>
</ul>
<p>LangGraph allows you to define flows that involve cycles, essential for most agentic architectures, differentiating it from DAG-based solutions. As a very low-level framework, it provides fine-grained control over both the flow and state of your application, crucial for creating reliable agents. Additionally, LangGraph includes built-in persistence, enabling advanced human-in-the-loop and memory features.</p>
<p>LangGraph is inspired by Pregel and Apache Beam. The public interface draws inspiration from NetworkX. LangGraph is built by LangChain Inc, the creators of LangChain, but can be used without LangChain.</p>
<p>For a full walkthrough, check out the <a href="https://langchain-ai.github.io/langgraph/tutorials/introduction/" target="_blank" rel="noopener noreferrer">LangGraph Quickstart</a> and for more on the fundamentals of design with LangGraph, check out the <a href="https://langchain-ai.github.io/langgraph/concepts/#human-in-the-loop" target="_blank" rel="noopener noreferrer">conceptual guides</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1---setup">1 - Setup<a href="#1---setup" class="hash-link" aria-label="Direct link to 1 - Setup" title="Direct link to 1 - Setup">​</a></h2>
<p>First, we must install the required dependencies. We will use OpenAI for our LLM in this example, but using LangChain with LangGraph makes it easy to substitute any alternative supported LLM or LLM provider.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token operator" style="color:rgb(212, 212, 212)">%</span><span class="token operator" style="color:rgb(212, 212, 212)">%</span><span class="token plain">capture</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token operator" style="color:rgb(212, 212, 212)">%</span><span class="token plain">pip install langchain_openai</span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token number" style="color:rgb(181, 206, 168)">0.2</span><span class="token number" style="color:rgb(181, 206, 168)">.0</span><span class="token plain"> langchain</span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token number" style="color:rgb(181, 206, 168)">0.3</span><span class="token number" style="color:rgb(181, 206, 168)">.0</span><span class="token plain"> langgraph</span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token number" style="color:rgb(181, 206, 168)">0.2</span><span class="token number" style="color:rgb(181, 206, 168)">.27</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token operator" style="color:rgb(212, 212, 212)">%</span><span class="token plain">pip install </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">U mlflow</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Next, let&#x27;s get our relevant secrets. <code>getpass</code>, as demonstrated in the <a href="https://langchain-ai.github.io/langgraph/tutorials/introduction/#setup" target="_blank" rel="noopener noreferrer">LangGraph quickstart</a> is a great way to insert your keys into an interactive jupyter environment.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Set required environment variables for authenticating to OpenAI</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Check additional MLflow tutorials for examples of authentication if needed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># https://mlflow.org/docs/latest/llms/openai/guide/index.html#direct-openai-service-usage</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">assert</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;OPENAI_API_KEY&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Please set the OPENAI_API_KEY environment variable.&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2---custom-utilities">2 - Custom Utilities<a href="#2---custom-utilities" class="hash-link" aria-label="Direct link to 2 - Custom Utilities" title="Direct link to 2 - Custom Utilities">​</a></h2>
<p>While this is a demo, it&#x27;s good practice to separate reusable utilities into a separate file/directory. Below we create three general utilities that theoretically would valuable when building additional MLflow + LangGraph implementations.</p>
<p>Note that we use the magic <code>%%writefile</code> command to create a new file in a jupyter notebook context. If you&#x27;re running this outside of an interactive notebook, simply create the file below, omitting the <code>%%writefile {FILE_NAME}.py</code> line.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token operator" style="color:rgb(212, 212, 212)">%</span><span class="token operator" style="color:rgb(212, 212, 212)">%</span><span class="token plain">writefile langgraph_utils</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">py</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># omit this line if directly creating this file; this command is purely for running within Jupyter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> typing </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> Union</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> langgraph</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">pregel</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">io </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> AddableValuesDict</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">_langgraph_message_to_mlflow_message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    langgraph_message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> AddableValuesDict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    langgraph_type_to_mlflow_role </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;human&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;user&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;ai&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;assistant&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;system&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;system&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> type_clean </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> langgraph_type_to_mlflow_role</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">langgraph_message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token builtin" style="color:rgb(86, 156, 214)">type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;role&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> type_clean</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> langgraph_message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">content</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">raise</span><span class="token plain"> ValueError</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f&quot;Incorrect role specified: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">langgraph_message</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-interpolation interpolation builtin" style="color:rgb(86, 156, 214)">type</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">get_most_recent_message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> AddableValuesDict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    most_recent_message </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;messages&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> _langgraph_message_to_mlflow_message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">most_recent_message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">increment_message_history</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> AddableValuesDict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> new_message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Union</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token builtin" style="color:rgb(86, 156, 214)">dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> AddableValuesDict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token builtin" style="color:rgb(86, 156, 214)">dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">isinstance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">new_message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> AddableValuesDict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        new_message </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> _langgraph_message_to_mlflow_message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">new_message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    message_history </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        _langgraph_message_to_mlflow_message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> message </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;messages&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> message_history </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">new_message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>By the end of this step, you should see a new file in your current directory with the name <code>langgraph_utils.py</code>.</p>
<p>Note that it&#x27;s best practice to add unit tests and properly organize your project into logically structured directories.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3---log-the-langgraph-model">3 - Log the LangGraph Model<a href="#3---log-the-langgraph-model" class="hash-link" aria-label="Direct link to 3 - Log the LangGraph Model" title="Direct link to 3 - Log the LangGraph Model">​</a></h2>
<p>Great! Now that we have some reusable utilities located in <code>./langgraph_utils.py</code>, we are ready to log the model with MLflow&#x27;s official LangGraph flavor.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="31---create-our-model-from-code-file">3.1 - Create our Model-From-Code File<a href="#31---create-our-model-from-code-file" class="hash-link" aria-label="Direct link to 3.1 - Create our Model-From-Code File" title="Direct link to 3.1 - Create our Model-From-Code File">​</a></h3>
<p>Quickly, some background. MLflow looks to serialize model artifacts to the MLflow tracking server. Many popular ML packages don&#x27;t have robust serialization and deserialization support, so MLflow looks to augment this functionality via the <a href="https://mlflow.org/docs/latest/models.html#models-from-code" target="_blank" rel="noopener noreferrer">models from code</a> feature. With models from code, we&#x27;re able to leverage Python as the serialization format, instead of popular alternatives such as JSON or pkl. This opens up tons of flexibility and stability.</p>
<p>To create a Python file with models from code, we must perform the following steps:</p>
<ol>
<li>Create a new python file. Let&#x27;s call it <code>graph.py</code>.</li>
<li>Define our langgraph graph.</li>
<li>Leverage <a href="https://mlflow.org/docs/latest/python_api/mlflow.models.html#mlflow.models.set_model" target="_blank" rel="noopener noreferrer">mlflow.models.set_model</a> to indicate to MLflow which object in the Python script is our model of interest.</li>
</ol>
<p>That&#x27;s it!</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token operator" style="color:rgb(212, 212, 212)">%</span><span class="token operator" style="color:rgb(212, 212, 212)">%</span><span class="token plain">writefile graph</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">py</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># omit this line if directly creating this file; this command is purely for running within Jupyter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> langchain_openai </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> ChatOpenAI</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> langgraph</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">graph </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> StateGraph</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> START</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> END</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> langgraph</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">graph</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">message </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> add_messages</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> langgraph</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">graph</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">state </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> CompiledStateGraph</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> mlflow</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> typing </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> TypedDict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> Annotated</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">load_graph</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> CompiledStateGraph</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">&quot;&quot;&quot;Create example chatbot from LangGraph Quickstart.&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">assert</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;OPENAI_API_KEY&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Please set the OPENAI_API_KEY environment variable.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">State</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">TypedDict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Annotated</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> add_messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    graph_builder </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> StateGraph</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">State</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    llm </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ChatOpenAI</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">chatbot</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;messages&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">llm</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">invoke</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;messages&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    graph_builder</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">add_node</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;chatbot&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> chatbot</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    graph_builder</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">add_edge</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">START</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;chatbot&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    graph_builder</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">add_edge</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;chatbot&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> END</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    graph </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> graph_builder</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token builtin" style="color:rgb(86, 156, 214)">compile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> graph</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Set are model to be leveraged via model from code</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">models</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">load_graph</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="32---log-with-model-from-code">3.2 - Log with &quot;Model from Code&quot;<a href="#32---log-with-model-from-code" class="hash-link" aria-label="Direct link to 3.2 - Log with &quot;Model from Code&quot;" title="Direct link to 3.2 - Log with &quot;Model from Code&quot;">​</a></h3>
<p>After creating this implementation, we can leverage the standard MLflow APIs to log the model.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> mlflow</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">with</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">start_run</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> run_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    model_info </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">langchain</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">log_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        lc_model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;graph.py&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)"># Path to our model Python file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        artifact_path</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;langgraph&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    model_uri </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> model_info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">model_uri</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4---use-the-logged-model">4 - Use the Logged Model<a href="#4---use-the-logged-model" class="hash-link" aria-label="Direct link to 4 - Use the Logged Model" title="Direct link to 4 - Use the Logged Model">​</a></h2>
<p>Now that we have successfully logged a model, we can load it and leverage it for inference.</p>
<p>In the code below, we demonstrate that our chain has chatbot functionality!</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> mlflow</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Custom utilities for handling chat history</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> langgraph_utils </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    increment_message_history</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    get_most_recent_message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Enable tracing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_experiment</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Tracing example&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)"># In Databricks, use an absolute path. Visit Databricks docs for more.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">langchain</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">autolog</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Load the model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">loaded_model </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">langchain</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">load_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">model_uri</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Show inference and message history functionality</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;-------- Message 1 -----------&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">message </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;What&#x27;s my name?&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">payload </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;messages&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;role&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;user&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> loaded_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">invoke</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">payload</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f&quot;User: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">message</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f&quot;Agent: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">get_most_recent_message</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation interpolation">response</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;\n-------- Message 2 -----------&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">message </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;My name is Morpheus.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">new_messages </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> increment_message_history</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;role&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;user&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">payload </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;messages&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> new_messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> loaded_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">invoke</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">payload</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f&quot;User: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">message</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f&quot;Agent: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">get_most_recent_message</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation interpolation">response</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;\n-------- Message 3 -----------&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">message </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;What is my name?&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">new_messages </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> increment_message_history</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;role&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;user&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;content&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">payload </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;messages&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> new_messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> loaded_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">invoke</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">payload</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f&quot;User: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">message</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f&quot;Agent: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">get_most_recent_message</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation interpolation">response</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Ouput:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">-------- Message 1 -----------</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">User: What&#x27;s my name?</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Agent: I&#x27;m sorry, I cannot guess your name as I do not have access to that information. If you would like to share your name with me, feel free to do so.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">-------- Message 2 -----------</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">User: My name is Morpheus.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Agent: Nice to meet you, Morpheus! How can I assist you today?</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">-------- Message 3 -----------</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">User: What is my name?</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">Agent: Your name is Morpheus.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="41---mlflow-tracing">4.1 - MLflow Tracing<a href="#41---mlflow-tracing" class="hash-link" aria-label="Direct link to 4.1 - MLflow Tracing" title="Direct link to 4.1 - MLflow Tracing">​</a></h3>
<p>Before concluding, let&#x27;s demonstrate <a href="https://mlflow.org/docs/latest/llms/tracing/index.html" target="_blank" rel="noopener noreferrer">MLflow tracing</a>.</p>
<p>MLflow Tracing is a feature that enhances LLM observability in your Generative AI (GenAI) applications by capturing detailed information about the execution of your application’s services. Tracing provides a way to record the inputs, outputs, and metadata associated with each intermediate step of a request, enabling you to easily pinpoint the source of bugs and unexpected behaviors.</p>
<p>Start the MLflow server as outlined in the <a href="https://mlflow.org/docs/latest/tracking/server.html" target="_blank" rel="noopener noreferrer">tracking server docs</a>. After entering the MLflow UI, we can see our experiment and corresponding traces.</p>
<p><img loading="lazy" alt="MLflow UI Experiment Traces" src="/mlflow-website/assets/images/mlflow_ui_experiment_traces-ef274042459cdbbfece8fd37aa3f0ba9.png" width="2352" height="1280" class="img_ev3q"></p>
<p>As you can see, we&#x27;ve logged our traces and can easily see them by clicking our experiment of interest and the then the &quot;Tracing&quot; tab.</p>
<p><img loading="lazy" alt="MLflow UI Trace" src="/mlflow-website/assets/images/mlflow_ui_trace-00b0839204bb937ac3cc7d6dfd9f7d54.png" width="2926" height="1896" class="img_ev3q"></p>
<p>After clicking on one of the traces, we can now see run execution for a single query. Notice that we log inputs, outputs, and lots of great metadata such as usage and invocation parameters. As we scale our application both from a usage and complexity perspective, this thread-safe and highly-performant tracking system will ensure robust monitoring of the app.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5---summary">5 - Summary<a href="#5---summary" class="hash-link" aria-label="Direct link to 5 - Summary" title="Direct link to 5 - Summary">​</a></h2>
<p>There are many logical extensions of the this tutorial, however the MLflow components can remain largely unchanged. Some examples include persisting chat history to a database, implementing a more complex langgraph object, productionizing this solution, and much more!</p>
<p>To summarize, here&#x27;s what was covered in this tutorial:</p>
<ul>
<li>Creating a simple LangGraph chain.</li>
<li>Leveraging MLflow <a href="https://mlflow.org/docs/latest/models.html#models-from-code" target="_blank" rel="noopener noreferrer">model from code</a> functionality to log our graph.</li>
<li>Loading the model via the standard MLflow APIs.</li>
<li>Leveraging <a href="https://mlflow.org/docs/latest/llms/tracing/index.html" target="_blank" rel="noopener noreferrer">MLflow tracing</a> to view graph execution.</li>
</ul>
<p>Happy coding!</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mlflow-website/blog/tags/genai">genai</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mlflow-website/blog/tags/mlops">mlops</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/mlflow-website/blog/tags/genai/page/2"><div class="pagination-nav__label">Older Entries</div></a></nav></div></main><footer class="pb-150 flex flex-col pt-37 from-[#0E1416] to-[#0E1416] bg-bottom bg-no-repeat w-full bg-[url(&#x27;/img/footer-red-bg.png&#x27;)] bg-size-[100%_340px]"><div class="flex flex-row justify-between items-start md:items-center px-20 gap-10 xs:gap-0"><svg width="109" height="40" viewBox="0 0 109 40" fill="none" xmlns="http://www.w3.org/2000/svg" class="h-[36px]"><path d="M0 31.032v-15.53h3.543v1.968c.893-1.594 2.84-2.425 4.593-2.425 2.042 0 3.828.926 4.658 2.745 1.216-2.043 3.034-2.745 5.043-2.745 2.81 0 5.49 1.787 5.49 5.904v10.083h-3.574v-9.478c0-1.818-.926-3.19-3-3.19-1.947 0-3.224 1.53-3.224 3.445v9.22H9.893v-9.475c0-1.786-.898-3.18-3.003-3.18-1.977 0-3.223 1.467-3.223 3.444v9.221ZM27.855 31.032V7.929h3.703v23.103ZM30.07 39.487c.833.232 1.582.383 3.17.383 2.953 0 6.436-1.665 7.353-6.339l3.786-18.739h5.629l.687-3.117h-5.686l.765-3.725c.586-2.892 2.186-4.358 4.754-4.358.668 0 .48.058 1.076.17L52.427.57c-.793-.237-1.503-.379-3.049-.379a7.319 7.319 0 0 0-4.528 1.484c-1.441 1.114-2.393 2.75-2.827 4.863l-1.066 5.137h-5.034l-.411 3.12h4.823L36.859 32.12c-.383 1.965-1.5 4.315-4.708 4.315-.727 0-.463-.055-1.121-.162ZM53.342 30.905H49.64l5.074-23.309h3.701ZM71.807 16.477A7.962 7.962 0 0 0 60.97 27.904l2.425-1.78a5.005 5.005 0 0 1 3.845-8.145v1.895ZM62.618 29.472a7.962 7.962 0 0 0 10.836-11.428l-2.425 1.78a5.005 5.005 0 0 1-3.845 8.145v-1.894ZM78.092 15.493h4.044l.823 10.612 5.759-10.612 3.839.055 1.508 10.557 5.074-10.612 3.701.055-7.678 15.493H91.46l-1.783-11.106-5.895 11.106h-3.84ZM105.072 15.768h-.766v-.266h1.845v.272h-.765v2.243h-.314ZM106.614 15.502h.383l.482 1.34c.062.172.119.348.178.524h.018c.059-.176.113-.352.172-.524l.478-1.34h.383v2.515h-.298V16.63c0-.22.024-.523.04-.747h-.016l-.191.574-.475 1.304h-.208l-.481-1.302-.191-.574h-.015c.017.224.042.527.042.747v1.387h-.291Z" fill="#fff"></path></svg><div class="flex flex-col md:flex-row gap-10"><div class="min-w-[120px]"><a href="/">Product</a></div><div class="min-w-[120px]"><a href="/releases">Releases</a></div><div class="min-w-[120px]"><a href="/blog">Blog</a></div><div class="min-w-[120px]"><a href="/docs/latest">Docs</a></div></div></div></footer></div></div></div>
</body>
</html>