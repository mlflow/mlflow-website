<!doctype html><html lang=en dir=ltr class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated=false><head><meta charset=UTF-8><meta name=generator content="Docusaurus v3.9.2"><title data-rh=true>Building Advanced RAG with MLflow and LlamaIndex Workflow | MLflow</title><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"/><meta data-rh=true name=twitter:card content=summary_large_image /><meta data-rh=true property=og:url content=http://mlflow.org/mlflow-website/blog/mlflow-llama-index-workflow /><meta data-rh=true property=og:locale content=en /><meta data-rh=true name=docusaurus_locale content=en /><meta data-rh=true name=docusaurus_tag content=default /><meta data-rh=true name=docsearch:language content=en /><meta data-rh=true name=docsearch:docusaurus_tag content=default /><meta data-rh=true property=og:title content="Building Advanced RAG with MLflow and LlamaIndex Workflow | MLflow"/><meta data-rh=true name=description content="A guide for using LlamaIndex Workflow with MLflow for building advanced QA application."/><meta data-rh=true property=og:description content="A guide for using LlamaIndex Workflow with MLflow for building advanced QA application."/><meta data-rh=true property=og:image content=http://mlflow.org/mlflow-website/img/blog/llama-index-thumbnail.png /><meta data-rh=true name=twitter:image content=http://mlflow.org/mlflow-website/img/blog/llama-index-thumbnail.png /><meta data-rh=true property=og:type content=article /><meta data-rh=true property=article:published_time content=2024-10-25T00:00:00.000Z /><meta data-rh=true property=article:author content=https://www.linkedin.com/in/yuki-watanabe-a04528164/ /><meta data-rh=true property=article:tag content=genai,mlops,mlflow-evaluate /><link data-rh=true rel=icon href=/mlflow-website/img/mlflow-favicon.ico /><link data-rh=true rel=canonical href=http://mlflow.org/mlflow-website/blog/mlflow-llama-index-workflow /><link data-rh=true rel=alternate href=http://mlflow.org/mlflow-website/blog/mlflow-llama-index-workflow hreflang=en /><link data-rh=true rel=alternate href=http://mlflow.org/mlflow-website/blog/mlflow-llama-index-workflow hreflang=x-default /><script data-rh=true type=application/ld+json>{"@context":"https://schema.org","@id":"http://mlflow.org/mlflow-website/blog/mlflow-llama-index-workflow","@type":"BlogPosting","author":{"@type":"Person","description":"Software Engineer at Databricks","image":"/mlflow-website/img/authors/yuki_watanabe.png","name":"Yuki Watanabe","url":"https://www.linkedin.com/in/yuki-watanabe-a04528164/"},"datePublished":"2024-10-25T00:00:00.000Z","description":"A guide for using LlamaIndex Workflow with MLflow for building advanced QA application.","headline":"Building Advanced RAG with MLflow and LlamaIndex Workflow","image":{"@id":"http://mlflow.org/mlflow-website/img/blog/llama-index-thumbnail.png","@type":"ImageObject","caption":"title image for the blog post: Building Advanced RAG with MLflow and LlamaIndex Workflow","contentUrl":"http://mlflow.org/mlflow-website/img/blog/llama-index-thumbnail.png","url":"http://mlflow.org/mlflow-website/img/blog/llama-index-thumbnail.png"},"isPartOf":{"@id":"http://mlflow.org/mlflow-website/blog","@type":"Blog","name":"Blog"},"keywords":[],"mainEntityOfPage":"http://mlflow.org/mlflow-website/blog/mlflow-llama-index-workflow","name":"Building Advanced RAG with MLflow and LlamaIndex Workflow","url":"http://mlflow.org/mlflow-website/blog/mlflow-llama-index-workflow"}</script><link rel=preconnect href=https://www.google-analytics.com><link rel=preconnect href=https://www.googletagmanager.com><script async src="https://www.googletagmanager.com/gtag/js?id=AW-16857946923"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","AW-16857946923",{anonymize_ip:!0})</script><link rel=preconnect href=https://www.googletagmanager.com><script>window.dataLayer=window.dataLayer||[],function(e,t,a,n,r){e[n]=e[n]||[],e[n].push({"gtm.start":new Date().getTime(),event:"gtm.js"});var d=t.getElementsByTagName(a)[0],g=t.createElement(a);g.async=!0,g.src="https://www.googletagmanager.com/gtm.js?id="+r+("dataLayer"!=n?"&l="+n:""),d.parentNode.insertBefore(g,d)}(window,document,"script","dataLayer","GTM-N6WMTTJ")</script><link rel=alternate type=application/rss+xml href=/mlflow-website/blog/rss.xml title="MLflow RSS Feed"><link rel=alternate type=application/atom+xml href=/mlflow-website/blog/atom.xml title="MLflow Atom Feed"><link rel=alternate type=application/rss+xml href=/mlflow-website/releases/rss.xml title="MLflow RSS Feed"><link rel=alternate type=application/atom+xml href=/mlflow-website/releases/atom.xml title="MLflow Atom Feed"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin=anonymous><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" display=swap><link rel=stylesheet href=/mlflow-website/assets/css/styles.d55e5617.css /><script src=/mlflow-website/assets/js/runtime~main.47729d3f.js defer></script><script src=/mlflow-website/assets/js/main.0626b5cd.js defer></script></head><body class=navigation-with-keyboard><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-N6WMTTJ" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript>


<svg style="display: none;"><defs>
<symbol id=theme-svg-external-link viewBox="0 0 24 24"><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"light"),document.documentElement.setAttribute("data-theme-choice",t||"light")}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="theme-layout-navbar navbar navbar--fixed-top"><div class=navbar__inner><div class="theme-layout-navbar-left navbar__items"><a class=navbar__brand href=/mlflow-website/></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type=button disabled title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill=currentColor d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"/></svg></button></div><div class=navbarSearchContainer_Bca1></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="flex flex-col min-h-screen w-full bg-[#0E1416]"><nav class="fixed w-full z-20 top-0 start-0 bg-black/20 border-b border-[#F7F8F8]/8 backdrop-blur-[20px] overflow-y-auto"><div class="flex flex-wrap items-center mx-auto px-6 lg:px-20 py-2 max-w-container"><div class="md:contents flex flex-row justify-between w-full sticky top-[8px]"><a class="flex items-center space-x-3 rtl:space-x-reverse grow basis-0" href=/mlflow-website/><svg xmlns=http://www.w3.org/2000/svg width=109 height=40 fill=none viewBox="0 0 109 40" class=h-[36px]><path fill=#fff d="M0 31.032v-15.53h3.543v1.968c.893-1.594 2.84-2.425 4.593-2.425 2.042 0 3.828.926 4.658 2.745 1.216-2.043 3.034-2.745 5.043-2.745 2.81 0 5.49 1.787 5.49 5.904v10.083h-3.574v-9.478c0-1.818-.926-3.19-3-3.19-1.947 0-3.224 1.53-3.224 3.445v9.22H9.893v-9.475c0-1.786-.898-3.18-3.003-3.18-1.977 0-3.223 1.467-3.223 3.444v9.221ZM27.855 31.032V7.929h3.703v23.103ZM30.07 39.487c.833.232 1.582.383 3.17.383 2.953 0 6.436-1.665 7.353-6.339l3.786-18.739h5.629l.687-3.117h-5.686l.765-3.725c.586-2.892 2.186-4.358 4.754-4.358.668 0 .48.058 1.076.17L52.427.57c-.793-.237-1.503-.379-3.049-.379a7.32 7.32 0 0 0-4.528 1.484c-1.441 1.114-2.393 2.75-2.827 4.863l-1.066 5.137h-5.034l-.411 3.12h4.823L36.859 32.12c-.383 1.965-1.5 4.315-4.708 4.315-.727 0-.463-.055-1.121-.162ZM53.342 30.905H49.64l5.074-23.309h3.701ZM71.807 16.477A7.962 7.962 0 0 0 60.97 27.904l2.425-1.78a5.005 5.005 0 0 1 3.845-8.145v1.895ZM62.618 29.472a7.962 7.962 0 0 0 10.836-11.428l-2.425 1.78a5.005 5.005 0 0 1-3.845 8.145v-1.894ZM78.092 15.493h4.044l.823 10.612 5.759-10.612 3.839.055 1.508 10.557 5.074-10.612 3.701.055-7.678 15.493H91.46l-1.783-11.106-5.895 11.106h-3.84ZM105.072 15.768h-.766v-.266h1.845v.272h-.765v2.243h-.314ZM106.614 15.502h.383l.482 1.34q.091.259.178.524h.018c.059-.176.113-.352.172-.524l.478-1.34h.383v2.515h-.298V16.63c0-.22.024-.523.04-.747h-.016l-.191.574-.475 1.304h-.208l-.481-1.302-.191-.574h-.015c.017.224.042.527.042.747v1.387h-.291Z"/></svg></a><div class="flex flex-row items-center gap-6 md:order-2 space-x-3 md:space-x-0 rtl:space-x-reverse grow justify-end basis-0"><a class="hidden md:block" href=/mlflow-website/#get-started><button class="rounded-xl inline-flex items-center justify-center whitespace-nowrap font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 hover:cursor-pointer bg-white text-black hover:bg-gray-900 text-[15px] px-4 py-2 w-fit">Get started</button></a><button data-collapse-toggle=navbar-sticky type=button class="inline-flex items-center p-2 w-10 h-10 justify-center text-sm text-white md:hidden focus:outline-none cursor-pointer"><span class=sr-only>Open main menu</span><svg class="w-5 h-5" aria-hidden=true xmlns=http://www.w3.org/2000/svg fill=none viewBox="0 0 17 14"><path stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M1 1h15M1 7h15M1 13h15"/></svg></button></div></div><div class="items-center justify-between w-full md:w-auto md:order-1 mt-4 md:mt-0 hidden md:flex"><ul class="flex flex-col font-medium md:flex-row gap-y-6 gap-x-4 lg:gap-x-10 w-full md:w-auto"><li class="w-full md:w-auto md:hidden"><button type=button aria-expanded=false aria-controls=mobile-components-submenu class="flex items-center justify-between gap-2 py-2 text-white text-lg w-full cursor-pointer transition-colors duration-200 hover:text-white/60">Components<svg xmlns=http://www.w3.org/2000/svg width=16 height=17 fill=none viewBox="0 0 16 17" class="w-6 h-6 transition-transform duration-300"><path fill=#F7F8F8 fill-rule=evenodd d="m8 10.776 3.61-3.61-.943-.942L8 8.89 5.333 6.224l-.942.943z" clip-rule=evenodd /></svg></button><div id=mobile-components-submenu class="transition-all duration-300 ease-in-out overflow-hidden max-h-0 opacity-0"><div class="flex flex-col md:flex-row md:max-w-4xl mx-auto gap-6 md:gap-8 lg:gap-10 px-1 md:px-4 lg:pl-0 products-submenu overflow-x-hidden"><div class="flex flex-col gap-4"><div class="flex flex-col gap-1 md:gap-4 border-b border-[#F7F8F8]/8 pb-4 group"><a href=/mlflow-website/genai><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">GenAI Apps & Agents</h3><p class="text-[#F7F8F8]/60 m-0">Ship high-quality GenAI, fast</p></a></div><div class="flex flex-col gap-3"><span class="text-[#F7F8F8]/60 text-sm">Features</span><div class="flex flex-row gap-6 xxs:gap-8"><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/observability>Observability</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/evaluations>Evaluations</a></div><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/prompt-registry>Prompt Registry</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/ai-gateway>AI Gateway</a></div></div></div></div><div class="flex flex-col gap-4"><div class="flex flex-col gap-1 md:gap-4 border-b border-[#F7F8F8]/8 pb-4 group"><a href=/mlflow-website/classical-ml><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">Model Training</h3><p class="text-[#F7F8F8]/60 m-0">Mastering the ML lifecycle</p></a></div><div class="flex flex-col gap-3"><span class="text-[#F7F8F8]/60 text-sm">Features</span><div class="flex flex-row gap-6 xxs:gap-8"><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/experiment-tracking>Experiment tracking</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/model-evaluation>Model evaluation</a></div><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/models>MLflow models</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/model-registry>Model Registry & deployment</a></div></div></div></div></div></div><li class="w-full md:w-auto hidden md:block"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60">Components<svg xmlns=http://www.w3.org/2000/svg width=16 height=17 fill=none viewBox="0 0 16 17" class="w-6 h-6"><path fill=#F7F8F8 fill-rule=evenodd d="m8 10.776 3.61-3.61-.943-.942L8 8.89 5.333 6.224l-.942.943z" clip-rule=evenodd /></svg></a><li class="w-full md:w-auto"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/releases>Releases</a><li class="w-full md:w-auto"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/blog>Blog</a><li class="w-full md:w-auto md:hidden"><button type=button aria-expanded=false aria-controls=mobile-docs-submenu class="flex items-center justify-between gap-2 py-2 text-white text-lg w-full cursor-pointer transition-colors duration-200 hover:text-white/60">Docs<svg xmlns=http://www.w3.org/2000/svg width=16 height=17 fill=none viewBox="0 0 16 17" class="w-6 h-6 transition-transform duration-300"><path fill=#F7F8F8 fill-rule=evenodd d="m8 10.776 3.61-3.61-.943-.942L8 8.89 5.333 6.224l-.942.943z" clip-rule=evenodd /></svg></button><div id=mobile-docs-submenu class="transition-all duration-300 ease-in-out overflow-hidden max-h-0 opacity-0"><div class="flex flex-col md:flex-row md:max-w-2xl mx-auto gap-6 md:gap-8 lg:gap-10 px-1 md:px-4 lg:pl-0 docs-submenu overflow-x-hidden"><div class="flex flex-col gap-1 md:gap-2 pb-4 flex-1 group"><a href=https://mlflow.org/docs/latest/genai/ target=_blank rel="noopener noreferrer"><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">GenAI Apps & Agents</h3><p class="text-[#F7F8F8]/60 m-0">Learn how to track, evaluate, and optimize your GenAI applications and agent workflows.</p></a></div><div class="flex flex-col gap-1 md:gap-2 pb-4 flex-1 group"><a href=https://mlflow.org/docs/latest/ml/ target=_blank rel="noopener noreferrer"><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">Model Training</h3><p class="text-[#F7F8F8]/60 m-0">Get started with the core functionality for traditional machine learning workflows, hyperparameter tuning, and model lifecycle management.</p></a></div></div></div><li class="w-full md:w-auto hidden md:block"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60">Docs<svg xmlns=http://www.w3.org/2000/svg width=16 height=17 fill=none viewBox="0 0 16 17" class="w-6 h-6"><path fill=#F7F8F8 fill-rule=evenodd d="m8 10.776 3.61-3.61-.943-.942L8 8.89 5.333 6.224l-.942.943z" clip-rule=evenodd /></svg></a><li class="w-full md:w-auto"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/ambassadors>Ambassador Program</a><li class="w-full md:w-auto md:hidden"><a href=/mlflow-website/#get-started><button class="rounded-xl inline-flex items-center justify-center whitespace-nowrap font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 hover:cursor-pointer bg-white text-black hover:bg-gray-900 text-[15px] px-4 py-2 w-full">Get started</button></a></ul></div></div><div class="flex-col w-full py-6 hidden"><div class="flex flex-col md:flex-row md:max-w-4xl mx-auto gap-6 md:gap-8 lg:gap-10 px-1 md:px-4 lg:pl-0 products-submenu overflow-x-hidden"><div class="flex flex-col gap-4"><div class="flex flex-col gap-1 md:gap-4 border-b border-[#F7F8F8]/8 pb-4 group"><a href=/mlflow-website/genai><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">GenAI Apps & Agents</h3><p class="text-[#F7F8F8]/60 m-0">Ship high-quality GenAI, fast</p></a></div><div class="flex flex-col gap-3"><span class="text-[#F7F8F8]/60 text-sm">Features</span><div class="flex flex-row gap-6 xxs:gap-8"><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/observability>Observability</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/evaluations>Evaluations</a></div><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/prompt-registry>Prompt Registry</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/ai-gateway>AI Gateway</a></div></div></div></div><div class="flex flex-col gap-4"><div class="flex flex-col gap-1 md:gap-4 border-b border-[#F7F8F8]/8 pb-4 group"><a href=/mlflow-website/classical-ml><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">Model Training</h3><p class="text-[#F7F8F8]/60 m-0">Mastering the ML lifecycle</p></a></div><div class="flex flex-col gap-3"><span class="text-[#F7F8F8]/60 text-sm">Features</span><div class="flex flex-row gap-6 xxs:gap-8"><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/experiment-tracking>Experiment tracking</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/model-evaluation>Model evaluation</a></div><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/models>MLflow models</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/model-registry>Model Registry & deployment</a></div></div></div></div></div></div><div class="flex-col w-full py-6 hidden"><div class="flex flex-col md:flex-row md:max-w-2xl mx-auto gap-6 md:gap-8 lg:gap-10 px-1 md:px-4 lg:pl-0 docs-submenu overflow-x-hidden"><div class="flex flex-col gap-1 md:gap-2 pb-4 flex-1 group"><a href=https://mlflow.org/docs/latest/genai/ target=_blank rel="noopener noreferrer"><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">GenAI Apps & Agents</h3><p class="text-[#F7F8F8]/60 m-0">Learn how to track, evaluate, and optimize your GenAI applications and agent workflows.</p></a></div><div class="flex flex-col gap-1 md:gap-2 pb-4 flex-1 group"><a href=https://mlflow.org/docs/latest/ml/ target=_blank rel="noopener noreferrer"><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">Model Training</h3><p class="text-[#F7F8F8]/60 m-0">Get started with the core functionality for traditional machine learning workflows, hyperparameter tuning, and model lifecycle management.</p></a></div></div></div></nav><main class="flex flex-col"><div class="relative flex flex-col gap-20 bg-no-repeat w-full py-32"><div style="position:absolute;width:100%;top:0;pointer-events:none;mask-composite:intersect;height:820px;background-image:repeating-linear-gradient(
        to right,
        rgba(0, 0, 0, 0.05),
        rgba(0, 0, 0, 0.25) 24px,
        transparent 2px,
        transparent 10px
      ),
      radial-gradient(
        circle at top center,
        var(--color-brand-red) 0%,
        transparent 60%
      ),
      linear-gradient(to right, color-mix(in srgb, var(--color-brand-red), oklch(0.33 0.15 328.37) 80%), color-mix(in srgb, var(--color-brand-red), oklch(0.66 0.17 248.82) 100%));mask-image:linear-gradient(to bottom, black 40%, transparent 90%)"></div><div class=z-1><div class="flex flex-col gap-24 w-full px-6 md:px-20 max-w-container"><div class="flex flex-col max-w-7xl mx-auto w-full"><article class=""><header><h1 class=title_f1Hy>Building Advanced RAG with MLflow and LlamaIndex Workflow</h1><div class="container_mt6G margin-vert--md"><time datetime=2024-10-25T00:00:00.000Z>October 25, 2024</time> ¬∑ <!-- -->17 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href=https://www.linkedin.com/in/yuki-watanabe-a04528164/ target=_blank rel="noopener noreferrer" class=avatar__photo-link><img class="avatar__photo authorImage_XqGP" src=/mlflow-website/img/authors/yuki_watanabe.png alt="Yuki Watanabe"/></a><div class="avatar__intro authorDetails_lV9A"><div class=avatar__name><a href=https://www.linkedin.com/in/yuki-watanabe-a04528164/ target=_blank rel="noopener noreferrer"><span class=authorName_yefp translate=no>Yuki Watanabe</span></a></div><small class=authorTitle_nd0D title="Software Engineer at Databricks">Software Engineer at Databricks</small><div class=authorSocials_rSDt></div></div></div></div></div></header><div id=__blog-post-container class=markdown><p><img decoding=async loading=lazy alt=Thumbnail src=/mlflow-website/assets/images/llama_index_workflow_title-c9f3f1bcce4659b5392213c0a2cb25e1.png width=3338 height=1498 class=img_ev3q /></p>
<p>Augmenting LLMs with various data sources is a strong strategy to build LLM applications. However, as the system grows more complex, it becomes challenging to prototype and iteratively build improvements to these more complex systems.</p>
<p>LlamaIndex Workflow is a great framework to build such compound systems. Combined with MLflow, the Workflow API brings efficiency and robustness in the development cycle, enabling easy debugging, experiment tracking, and evaluation for continuous improvement.</p>
<p>In this blog, we will go through the journey of building a sophisticated chatbot with LlamaIndex's Workflow API and MLflow.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=what-is-llamaindex-workflow>What is LlamaIndex Workflow?<a href=#what-is-llamaindex-workflow class=hash-link aria-label="Direct link to What is LlamaIndex Workflow?" title="Direct link to What is LlamaIndex Workflow?" translate=no>‚Äã</a></h2>
<p><a href=https://docs.llamaindex.ai/en/stable/module_guides/workflow/ target=_blank rel="noopener noreferrer" class="">LlamaIndex Workflow</a> is an event-driven orchestration framework for designing dynamic AI applications. The core of LlamaIndex Workflow consists of:</p>
<ul>
<li class="">
<p><code>Steps</code> are units of execution, representing distinct actions in the workflow.</p>
</li>
<li class="">
<p><code>Events</code> trigger these steps, acting as signals that control the workflow‚Äôs flow.</p>
</li>
<li class="">
<p><code>Workflow</code> connects these two as a Python class. Each step is implemented as a method of the workflow class, defined with input and output events.</p>
</li>
</ul>
<p>This simple yet powerful abstraction allows you to break down complex tasks into manageable steps, enabling greater flexibility and scalability. As a framework embodying event-driven design, using the <code>Workflow</code> APIs makes it intuitive to design parallel and asynchronous execution flows, significantly enhancing the efficiency of long-running tasks and aids in providing production-ready scalability.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=why-use-mlflow-with-llamaindex-workflow>Why Use MLflow with LlamaIndex Workflow?<a href=#why-use-mlflow-with-llamaindex-workflow class=hash-link aria-label="Direct link to Why Use MLflow with LlamaIndex Workflow?" title="Direct link to Why Use MLflow with LlamaIndex Workflow?" translate=no>‚Äã</a></h2>
<p>Workflow provides great flexibility to design nearly arbitrary execution flows. However, with this great power comes a great responsibility. Without managing your changes properly, it can become a chaotic mess of indeterminate states and confusing configurations. After a few dozen changes, you may be asking yourself, "how did my workflow even work?".</p>
<p><strong>MLflow</strong> brings a powerful MLOps harness to LlamaIndex Workflows throughout the end-to-end development cycle.</p>
<ul>
<li class="">
<p><strong>Experiment Tracking</strong>: MLflow allows you to record various components like steps, prompts, LLMs, and tools, making it easy to improve the system iteratively.</p>
</li>
<li class="">
<p><strong>Reproducibility</strong>: MLflow packages environment information such as global configurations (<code>Settings</code>), library versions, and metadata to ensure consistent deployment across different stages of the ML lifecycle.</p>
</li>
<li class="">
<p><strong>Tracing</strong>: Debugging issues in a complex event-driven workflow is cumbersome. MLflow Tracing is a production-ready observability solution that natively integrates with LlamaIndex, giving you observability into each internal stage within your Workflow.</p>
</li>
<li class="">
<p><strong>Evaluation</strong>: Measuring is a crucial task for improving your model. MLflow Evaluation is great tool to evaluate the quality, speed, and cost of your LLM application. It is tightly integrated with MLflow's experiment tracking capabilities, streamlining the process of making iterative improvements.</p>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=lets-buildÔ∏è>Let's Build!üõ†Ô∏è<a href=#lets-buildÔ∏è class=hash-link aria-label="Direct link to Let's Build!üõ†Ô∏è" title="Direct link to Let's Build!üõ†Ô∏è" translate=no>‚Äã</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id=strategy-hybrid-approach-using-multiple-retrieval-methods>Strategy: Hybrid Approach Using Multiple Retrieval Methods<a href=#strategy-hybrid-approach-using-multiple-retrieval-methods class=hash-link aria-label="Direct link to Strategy: Hybrid Approach Using Multiple Retrieval Methods" title="Direct link to Strategy: Hybrid Approach Using Multiple Retrieval Methods" translate=no>‚Äã</a></h3>
<p>Retrieval-Augmented Generation (RAG) is a powerful framework, but the retrieval step can often become a bottleneck, because embedding-based retrieval may not always capture the most relevant context. While many techniques exist to improve retrieval quality, no single solution works universally. Therefore, an effective strategy is to combine multiple retrieval approaches.</p>
<p>The concept we will explore here is to run several retrieval methods in parallel: (1) standard vector search, (2) keyword-based search (BM25), and (3) web search. The retrieved contexts are then merged, with irrelevant data filtered out to enhance the overall quality.</p>
<p><img decoding=async loading=lazy alt="Hybrid RAG Concept" src=/mlflow-website/assets/images/llama_index_workflow_hybrid_rag_concept-91f220154cd696bc022e0d3448b6de15.png width=1949 height=929 class=img_ev3q /></p>
<p>How do we bring this concept to life? Let‚Äôs dive in and build this hybrid RAG using LlamaIndex Workflow and MLflow.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=1-set-up-repository>1. Set Up Repository<a href=#1-set-up-repository class=hash-link aria-label="Direct link to 1. Set Up Repository" title="Direct link to 1. Set Up Repository" translate=no>‚Äã</a></h2>
<p>The sample code, including the environment setup script, is available in the <a href=https://github.com/mlflow/mlflow/tree/master/examples/llama_index/workflow target=_blank rel="noopener noreferrer" class="">GitHub repository</a>. It contains a complete workflow definition, a hands-on notebook, and a sample dataset for running experiments. To clone it to your working environment, use the following command:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token plain">git clone https://github.com/mlflow/mlflow.git</span><br/></span></code></pre></div></div>
<p>After cloning the repository, set up the virtual environment by running:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token plain">cd mlflow/examples/llama_index/workflow</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">chmod +x install.sh</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">./install.sh</span><br/></span></code></pre></div></div>
<p>Once the installation is complete, start Jupyter Notebook within the Poetry environment using:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token plain">poetry run jupyter notebook</span><br/></span></code></pre></div></div>
<p>Next, open the <code>Tutorial.ipynb</code> notebook located in the root directory. Throughout this blog, we will walk through this notebook to guide you through the development process.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=2-start-an-mlflow-experiment>2. Start an MLflow Experiment<a href=#2-start-an-mlflow-experiment class=hash-link aria-label="Direct link to 2. Start an MLflow Experiment" title="Direct link to 2. Start an MLflow Experiment" translate=no>‚Äã</a></h2>
<p>An <strong>MLflow Experiment</strong> is where you track all aspects of model development, including model definitions, configurations, parameters, dependency versions, and more. Let‚Äôs start by creating a new MLflow experiment called "LlamaIndex Workflow RAG":</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> mlflow</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_experiment</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"LlamaIndex Workflow RAG"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br/></span></code></pre></div></div>
<p>At this point, the experiment doesn't have any recorded data yet. To view the experiment in the MLflow UI, open a new terminal and run the <code>mlflow ui</code> command, then navigate to the provided URL in your browser:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token plain">poetry run mlflow ui</span><br/></span></code></pre></div></div>
<p><img decoding=async loading=lazy alt="Empty MLflow Experiment" src=/mlflow-website/assets/images/llama_index_workflow_empty_experiment-a51068dbf3d59a443672da5aa589c812.png width=1926 height=418 class=img_ev3q /></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=3-choose-your-llm-and-embeddings>3. Choose your LLM and Embeddings<a href=#3-choose-your-llm-and-embeddings class=hash-link aria-label="Direct link to 3. Choose your LLM and Embeddings" title="Direct link to 3. Choose your LLM and Embeddings" translate=no>‚Äã</a></h2>
<p>Now, set up your preferred LLM and embeddings models to LlamaIndex's Settings object. These models will be used throughout the LlamaIndex components.</p>
<p>For this demonstration, we‚Äôll use OpenAI models, but you can easily switch to different LLM providers or local models by following the instructions in the notebook.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> getpass</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> os</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"OPENAI_API_KEY"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> getpass</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">getpass</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Enter OpenAI API Key"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> llama_index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">core </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> Settings</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> llama_index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">embeddings</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">openai </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> OpenAIEmbedding</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> llama_index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">llms</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">openai </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> OpenAI</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># LlamaIndex by default uses OpenAI APIs for LLMs and embeddings models. You can use the default</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># model (`gpt-3.5-turbo` and `text-embeddings-ada-002` as of Oct 2024), but we recommend using the</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># latest efficient models instead for getting better results with lower cost.</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">Settings</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">embed_model </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> OpenAIEmbedding</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"text-embedding-3-large"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">Settings</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">llm </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> OpenAI</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"gpt-4o-mini"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br/></span></code></pre></div></div>
<p>üí° <em>MLflow will automatically log the <code>Settings</code> configuration into your MLflow Experiment when logging models, ensuring reproducibility and reducing the risk of discrepancies between environments.</em></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=4-set-up-web-search-api>4. Set Up Web Search API<a href=#4-set-up-web-search-api class=hash-link aria-label="Direct link to 4. Set Up Web Search API" title="Direct link to 4. Set Up Web Search API" translate=no>‚Äã</a></h2>
<p>Later in this blog, we will add a web search capability to the QA bot. We will use Tavily AI, a search API
optimized for LLM application and natively integrated with LlamaIndex. Visit <a href=https://tavily.com/ target=_blank rel="noopener noreferrer" class="">their website</a> to
get an API key for free-tier use, or use different search engine integrated with LlamaIndex, e.g. <a href=https://docs.llamaindex.ai/en/stable/api_reference/tools/google/#llama_index.tools.google.GoogleSearchToolSpec target=_blank rel="noopener noreferrer" class="">GoogleSearchToolSpec</a>.</p>
<p>Once you get the API key, set it to the environment variable:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token plain">os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"TAVILY_AI_API_KEY"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> getpass</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">getpass</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Enter Tavily AI API Key"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br/></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=5-set-up-document-indices-for-retrieval>5. Set Up Document Indices for Retrieval<a href=#5-set-up-document-indices-for-retrieval class=hash-link aria-label="Direct link to 5. Set Up Document Indices for Retrieval" title="Direct link to 5. Set Up Document Indices for Retrieval" translate=no>‚Äã</a></h2>
<p>The next step is to build a document index for retrieval from MLflow documentation. The <code>urls.txt</code> file in the <code>data</code> directory contains a list of MLflow documentation pages. These pages can be loaded as document objects using the web page reader utility.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> llama_index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">readers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">web </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> SimpleWebPageReader</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">with</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"data/urls.txt"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"r"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    urls </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">line</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">strip</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> line </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">file</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> line</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">strip</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">documents </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> SimpleWebPageReader</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">html_to_text</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">load_data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">urls</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br/></span></code></pre></div></div>
<p>Next, ingest these documents into a vector database. In this tutorial, we‚Äôll use the <a href=https://qdrant.tech/ target=_blank rel="noopener noreferrer" class="">Qdrant</a> vector store, which is free if self-hosted. If Docker is installed on your machine, you can start the Qdrant database by running the official Docker container:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token plain">$ docker pull qdrant/qdrant</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">$ docker run -p 6333:6333 -p 6334:6334 \</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    -v $(pwd)/.qdrant_storage:/qdrant/storage:z \</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    qdrant/qdrant</span><br/></span></code></pre></div></div>
<p>Once the container is running, you can create an index object that connects to the Qdrant database:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> qdrant_client</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> llama_index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">vector_stores</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">qdrant </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> QdrantVectorStore</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">client </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> qdrant_client</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">QdrantClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">host</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"localhost"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> port</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">6333</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">vector_store </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> QdrantVectorStore</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">client</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">client</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> collection_name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"mlflow_doc"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> llama_index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">core </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> StorageContext</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> VectorStoreIndex</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">storage_context </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> StorageContext</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">from_defaults</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">vector_store</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">vector_store</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">index </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> VectorStoreIndex</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">from_documents</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    documents</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">documents</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    storage_context</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">storage_context</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br/></span></code></pre></div></div>
<p>Of course, you can use your preferred vector store here. LlamaIndex supports a variety of vector databases, such as <a href=https://docs.llamaindex.ai/en/stable/examples/vector_stores/FaissIndexDemo/ target=_blank rel="noopener noreferrer" class="">FAISS</a>, <a href=https://docs.llamaindex.ai/en/stable/examples/vector_stores/ChromaIndexDemo/ target=_blank rel="noopener noreferrer" class="">Chroma</a>, and <a href=https://docs.llamaindex.ai/en/stable/examples/vector_stores/DatabricksVectorSearchDemo/ target=_blank rel="noopener noreferrer" class="">Databricks Vector Search</a>. If you choose an alternative, follow the relevant LlamaIndex documentation and update the <code>workflow/workflow.py</code> file accordingly.</p>
<p>In addition to evaluating the vector search retrieval, we will assess the keyword-based retriever (BM25) later. Let's set up local document storage to enable BM25 retrieval in the workflow.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> llama_index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">core</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">node_parser </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> SentenceSplitter</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> llama_index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">retrievers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">bm25 </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> BM25Retriever</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">splitter </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> SentenceSplitter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">chunk_size</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">512</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">nodes </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> splitter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get_nodes_from_documents</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">documents</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">bm25_retriever </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> BM25Retriever</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">from_defaults</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">nodes</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">nodes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">bm25_retriever</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">persist</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">".bm25_retriever"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br/></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=6-define-a-workflow>6. Define a Workflow<a href=#6-define-a-workflow class=hash-link aria-label="Direct link to 6. Define a Workflow" title="Direct link to 6. Define a Workflow" translate=no>‚Äã</a></h2>
<p>Now that the environment and data sources are ready, we can build the workflow and experiment with it. The complete workflow code is defined in the <code>workflow</code> directory. Let's explore some key components of the implementation.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id=events>Events<a href=#events class=hash-link aria-label="Direct link to Events" title="Direct link to Events" translate=no>‚Äã</a></h3>
<p>The <code>workflow/events.py</code> file defines all the events used within the workflow. These are simple Pydantic models that carry information between workflow steps. For example, the <code>VectorSearchRetrieveEvent</code> triggers the vector search step by passing the user's query.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">VectorSearchRetrieveEvent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""Event for triggering VectorStore index retrieval step."""</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    query</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><br/></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id=prompts>Prompts<a href=#prompts class=hash-link aria-label="Direct link to Prompts" title="Direct link to Prompts" translate=no>‚Äã</a></h3>
<p>Throughout the workflow execution, we call LLMs multiple times. The prompt templates for these LLM calls are defined in the <code>workflow/prompts.py</code> file.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id=workflow-class>Workflow Class<a href=#workflow-class class=hash-link aria-label="Direct link to Workflow Class" title="Direct link to Workflow Class" translate=no>‚Äã</a></h3>
<p>The main workflow class is defined in <code>workflow/workflow.py</code>. Let's break down how it works.</p>
<p>The constructor accepts a retrievers argument, which specifies the retrieval methods to be used in the workflow. For instance, if <code>["vector_search", "bm25"]</code> is passed, the workflow performs vector search and keyword-based search, skipping web search.</p>
<p>üí° Deciding which retrievers to utilize dynamically allows us to experiment with different retrieval strategies without needing to replicate nearly identical model code.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">HybridRAGWorkflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Workflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    VALID_RETRIEVERS </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">"vector_search"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"bm25"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"web_search"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">__init__</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> retrievers</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token plain">kwargs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token builtin" style="color:rgb(86, 156, 214)">super</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">__init__</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token plain">kwargs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">llm </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> Settings</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">llm</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">retrievers </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> retrievers </span><span class="token keyword" style="color:rgb(86, 156, 214)">or</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> invalid_retrievers </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">set</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">retrievers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">VALID_RETRIEVERS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">raise</span><span class="token plain"> ValueError</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f"Invalid retrievers specified: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">invalid_retrievers</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_use_vs_retriever </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"vector_search"</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">retrievers</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_use_bm25_retriever </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"bm25"</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">retrievers</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_use_web_search </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"web_search"</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">retrievers</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_use_vs_retriever</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            qd_client </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> qdrant_client</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">QdrantClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">host</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">_QDRANT_HOST</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> port</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">_QDRANT_PORT</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            vector_store </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> QdrantVectorStore</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">client</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">qd_client</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> collection_name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">_QDRANT_COLLECTION_NAME</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            index </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> VectorStoreIndex</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">from_vector_store</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">vector_store</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">vector_store</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">vs_retriever </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">as_retriever</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_use_bm25_retriever</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">bm25_retriever </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> BM25Retriever</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">from_persist_dir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">_BM25_PERSIST_DIR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_use_web_search</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tavily_tool </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> TavilyToolSpec</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">api_key</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"TAVILY_AI_API_KEY"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br/></span></code></pre></div></div>
<p>The workflow begins by executing a step that takes the <code>StartEvent</code> as input, which is the <code>route_retrieval</code> step in this case. This step inspects the retrievers parameter and triggers the necessary retrieval steps. By using the <code>send_event()</code> method of the context object, multiple events can be dispatched in parallel from this single step.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># If no retriever is specified, proceed directly to the final query step with an empty context</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">len</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">retrievers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> QueryEvent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">context</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">""</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Trigger the retrieval steps based on the configuration</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_use_vs_retriever</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        ctx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">send_event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">VectorSearchRetrieveEvent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">query</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">query</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_use_bm25_retriever</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        ctx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">send_event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">BM25RetrieveEvent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">query</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">query</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_use_web_search</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        ctx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">send_event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">TransformQueryEvent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">query</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">query</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br/></span></code></pre></div></div>
<p>The retrieval steps are straightforward. However, the web search step is more advanced as it includes an additional step to transform the user's question into a search-friendly query using an LLM.</p>
<p>The results from all the retrieval steps are aggregated in the <code>gather_retrieval_results</code> step. Here, the <code>ctx.collect_events()</code> method is used to poll for the results of the asynchronously executed steps.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token plain">    results </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">collect_events</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ev</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">RetrievalResultEvent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">len</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">retrievers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br/></span></code></pre></div></div>
<p>Passing all results from multiple retrievers often leads to a large context with unrelated or duplicate content. To address this, we need to filter and select the most relevant results. While a score-based approach is common, web search results do not return similarity scores. Therefore, we use an LLM to sort and filter out irrelevant results. The rerank step achieves this by leveraging the built-in reranker integration with <a href=https://github.com/sunnweiwei/RankGPT target=_blank rel="noopener noreferrer" class="">RankGPT</a>.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token plain">    reranker </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> RankGPTRerank</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">llm</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">llm</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> top_n</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    reranked_nodes </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> reranker</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">postprocess_nodes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ev</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">nodes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> query_str</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">query</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    reranked_context </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"\n"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">join</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">node</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">text </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> node </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> reranked_nodes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br/></span></code></pre></div></div>
<p>Finally, the reranked context is passed to the LLM along with the user query to generate the final answer. The result is returned as a <code>StopEvent</code> with the <code>result</code> key.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">@step</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">async</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">query_result</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Context</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> ev</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> QueryEvent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> StopEvent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""Get result with relevant text."""</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        query </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">await</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"query"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        prompt </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> FINAL_QUERY_TEMPLATE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token builtin" style="color:rgb(86, 156, 214)">format</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">context</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">ev</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">context</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> query</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">query</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">llm</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">complete</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">prompt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">text</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> StopEvent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">result</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br/></span></code></pre></div></div>
<p>Now, let's instantiate the workflow and run it.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token comment" style="color:rgb(106, 153, 85)"># Workflow with VS + BM25 retrieval</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> workflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">workflow </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> HybridRAGWorkflow</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">workflow </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> HybridRAGWorkflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">retrievers</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"vector_search"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"bm25"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> timeout</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">60</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">await</span><span class="token plain"> workflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">run</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">query</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"Why use MLflow with LlamaIndex?"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br/></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=7-log-the-workflow-in-an-mlflow-experiment>7. Log the Workflow in an MLflow Experiment<a href=#7-log-the-workflow-in-an-mlflow-experiment class=hash-link aria-label="Direct link to 7. Log the Workflow in an MLflow Experiment" title="Direct link to 7. Log the Workflow in an MLflow Experiment" translate=no>‚Äã</a></h2>
<p>Now we want to run the workflow with various different retrieval strategies and evaluate the performance of each. However, before running the evaluation, we'll log the model in MLflow to track both the model and its performance within an <strong>MLflow Experiment</strong>.</p>
<p>For the LlamaIndex Workflow, we use the new <a href=https://mlflow.org/docs/latest/models.html#models-from-code target=_blank rel="noopener noreferrer" class="">Model-from-code</a> method, which logs models as standalone Python scripts. This approach avoids the risks and instability associated with serialization methods like pickle, relying instead on code as the single source of truth for the model definition. When combined with MLflow's environment-freezing capability, it provides a reliable way to persist models. For more details, refer to the <a href=https://mlflow.org/docs/latest/models.html#models-from-code target=_blank rel="noopener noreferrer" class="">MLflow documentation</a>.</p>
<p>üí° In the <code>workflow</code> directory, there's a <code>model.py</code> script that imports the <code>HybridRAGWorkflow</code> and instantiates it with dynamic configurations passed via the <code>model_config</code> parameter during logging. This design allows you to track models with different configurations without duplicating the model definition.</p>
<p>We'll start an MLflow Run and log the model script <code>model.py</code> with different configurations using the <a href=https://mlflow.org/docs/latest/python_api/mlflow.llama_index.html#mlflow.llama_index.log_model target=_blank rel="noopener noreferrer" class="">mlflow.llama_index.log_model()</a> API.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token comment" style="color:rgb(106, 153, 85)"># Different configurations we will evaluate. We don't run evaluation for all permutation</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># for demonstration purpose, but you can add as many patterns as you want.</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">run_name_to_retrievers </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># 1. No retrievers (prior knowledge in LLM).</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">"none"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># 2. Vector search retrieval only.</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">"vs"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"vector_search"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># 3. Vector search and keyword search (BM25)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">"vs + bm25"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"vector_search"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"bm25"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># 4. All retrieval methods including web search.</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">"vs + bm25 + web"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"vector_search"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"bm25"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"web_search"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Create an MLflow Run and log model with each configuration.</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">models </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> run_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> retrievers </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> run_name_to_retrievers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">items</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">with</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">start_run</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">run_name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">run_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        model_info </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">llama_index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">log_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Specify the model Python script.</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            llama_index_model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"workflow/model.py"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Specify retrievers to use.</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            model_config</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">"retrievers"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> retrievers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Define dependency files to save along with the model</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            code_paths</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"workflow"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Subdirectory to save artifacts (not important)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            artifact_path</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"model"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        models</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">model_info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br/></span></code></pre></div></div>
<p>Now open the MLflow UI again, and this time it should show 4 MLflow Runs are recorded with different <code>retrievers</code> parameter values. By clicking each Run name and navigate to the "Artifacts" tab, you can see MLflow records the model and various metadata, such as dependency versions and settings.</p>
<p><img decoding=async loading=lazy alt="MLflow Runs" src=/mlflow-website/assets/images/llama_index_workflow_runs-c68e66f1a2d4b77801bf88bea021d142.png width=1073 height=352 class=img_ev3q /></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=8-enable-mlflow-tracing>8. Enable MLflow Tracing<a href=#8-enable-mlflow-tracing class=hash-link aria-label="Direct link to 8. Enable MLflow Tracing" title="Direct link to 8. Enable MLflow Tracing" translate=no>‚Äã</a></h2>
<p>Before running the evaluation, there‚Äôs one final step: enabling <strong>MLflow Tracing</strong>. We'll dive into this feature and why we do this here later, but for now, you can enable it with a simple one-line command. MLflow will automatically trace every LlamaIndex execution.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">llama_index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">autolog</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br/></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=9-evaluate-the-workflow-with-different-retriever-strategies>9. Evaluate the Workflow with Different Retriever Strategies<a href=#9-evaluate-the-workflow-with-different-retriever-strategies class=hash-link aria-label="Direct link to 9. Evaluate the Workflow with Different Retriever Strategies" title="Direct link to 9. Evaluate the Workflow with Different Retriever Strategies" translate=no>‚Äã</a></h2>
<p>The example repository includes a sample evaluation dataset, <code>mlflow_qa_dataset.csv</code>, containing 30 question-answer pairs related to MLflow.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> pandas </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> pd</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">eval_df </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> pd</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">read_csv</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"data/mlflow_qa_dataset.csv"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">display</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">eval_df</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">head</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">3</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br/></span></code></pre></div></div>
<p>To evaluate the workflow, use the <a href=https://mlflow.org/docs/latest/python_api/mlflow.html#mlflow.evaluate target=_blank rel="noopener noreferrer" class="">mlflow.evaluate()</a> API, which requires (1) your dataset, (2) the logged model, and (3) the metrics you want to compute.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">metrics </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> latency</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">metrics</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">genai </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> answer_correctness</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> model_info </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> models</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">with</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">start_run</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">run_id</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">model_info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">run_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        result </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">evaluate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Pass the URI of the logged model above</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">model_info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">model_uri</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            data</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">eval_df</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Specify the column for ground truth answers.</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            targets</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"ground_truth"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Define the metrics to compute.</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            extra_metrics</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                latency</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                answer_correctness</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"openai:/gpt-4o-mini"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># The answer_correctness metric requires "inputs" column to be</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># present in the dataset. We have "query" instead so need to</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># specify the mapping in `evaluator_config` parameter.</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            evaluator_config</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">"col_mapping"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">"inputs"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"query"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br/></span></code></pre></div></div>
<p>In this example, we evaluate the model with two metrics:</p>
<ol>
<li class=""><strong>Latency</strong>: Measures the time taken to execute a workflow for a single query.</li>
<li class=""><strong>Answer Correctness</strong>: Evaluates the accuracy of answers based on the ground truth, scored by the OpenAI GPT-4o model on a 1‚Äì5 scale.</li>
</ol>
<p>These metrics are just for demonstration purposes‚Äîyou can add additional metrics like toxicity or faithfulness, or even create your own. See the MLflow documentation for the full set of <a href=https://mlflow.org/docs/latest/llms/llm-evaluate/index.html#llm-evaluation-metrics target=_blank rel="noopener noreferrer" class="">built-in metrics</a>
and how to define <a href=https://mlflow.org/docs/latest/llms/llm-evaluate/index.html#creating-custom-llm-evaluation-metrics target=_blank rel="noopener noreferrer" class="">custom metrics</a>.</p>
<p>The evaluation process will take a few minutes. Once completed, you can view the results in the MLflow UI. Open the Experiment page and click on the chart icon üìà above the Run list.</p>
<p><img decoding=async loading=lazy alt="Evaluation Result" src=/mlflow-website/assets/images/llama_index_workflow_result_chart-f72c0b1c2b196cc540674020e201c6f4.png width=2327 height=945 class=img_ev3q /></p>
<p>*üí° The evaluation results can be different depending on model set up and some randomness.</p>
<p>The first row shows bar charts for the answer correctness metrics, while the second row displays latency results. The best-performing combination is "Vector Search + BM25". Interestingly, adding web search not only increases latency significantly but also decreases answer correctness.</p>
<p>Why does this happen? It appears some answers from the web-search-enabled model are off-topic. For example, in response to a question about starting the Model Registry, the web-search model provides an unrelated answer about model deployment, while the "vs + bm25" model offers a correct response.</p>
<p><img decoding=async loading=lazy alt="Answer Comparison" src=/mlflow-website/assets/images/llama_index_workflow_answer_comparison-bad74ed92a791dae40c2bdce61763db4.png width=1092 height=359 class=img_ev3q /></p>
<p>Where did this incorrect answer come from? This seems to be a retriever issue, as we only changed the retrieval strategy. However, it's difficult to see what each retriever returned from the final result. To gain deeper insights into what's happening behind the scenes, MLflow Tracing is the perfect solution.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=10-inspecting-quality-issues-with-mlflow-trace>10. Inspecting Quality Issues with MLflow Trace<a href=#10-inspecting-quality-issues-with-mlflow-trace class=hash-link aria-label="Direct link to 10. Inspecting Quality Issues with MLflow Trace" title="Direct link to 10. Inspecting Quality Issues with MLflow Trace" translate=no>‚Äã</a></h2>
<p><a href=https://mlflow.org/docs/latest/llms/tracing/index.html target=_blank rel="noopener noreferrer" class="">MLflow Tracing</a> is a new feature that brings observability to LLM applications. It integrates seamlessly with LlamaIndex, recording all inputs, outputs, and metadata about intermediate steps during workflow execution. Since we called <code>mlflow.llama_index.autolog()</code> at the start, every LlamaIndex operation has been traced and recorded in the MLflow Experiment.</p>
<p>To inspect the trace for a specific question from the evaluation, navigate to the "Traces" tab on the experiment page. Look for the row with the particular question in the request column and the run name "vs + bm25 + web." Clicking the request ID link opens the Trace UI, where you can view detailed information about each step in the execution, including inputs, outputs, metadata, and latency.</p>
<p><img decoding=async loading=lazy alt=Trace src=/mlflow-website/assets/images/llama_index_workflow_trace-1783d50c5a0624d8fc1a943806152559.png width=2990 height=938 class=img_ev3q /></p>
<p>In this case, we identified the issue by examining the reranker step. The web search retriever returned irrelevant context related to model serving, and the reranker incorrectly ranked it as the most relevant. With this insight, we can determine potential improvements, such as refining the reranker to better understand MLflow topics, improving web search precision, or even removing the web search retriever altogether.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=conclusion>Conclusion<a href=#conclusion class=hash-link aria-label="Direct link to Conclusion" title="Direct link to Conclusion" translate=no>‚Äã</a></h2>
<p>In this blog, we explored how the combination of LlamaIndex and MLflow can elevate the development of Retrieval-Augmented Generation (RAG) workflows, bringing together powerful model management and observability capabilities. By integrating multiple retrieval strategies (such as vector search, BM25, and web search) we demonstrated how flexible retrieval can enhance the performance of LLM-driven applications.</p>
<ul>
<li class=""><strong>Experiment Tracking</strong> allowed us to organize and log different workflow configurations, ensuring reproducibility and enabling us to track model performance across multiple runs.</li>
<li class=""><strong>MLflow Evaluate</strong> enabled us to easily log and evaluate the workflow with different retriever strategies, using key metrics like latency and answer correctness to compare performance.</li>
<li class=""><strong>MLflow UI</strong> gave us a clear visualization of how various retrieval strategies impacted both accuracy and latency, helping us identify the most effective configurations.</li>
<li class=""><strong>MLflow Tracing</strong>, integrated with LlamaIndex, provided detailed observability into each step of the workflow for diagnosing quality issues, such as incorrect reranking of search results.</li>
</ul>
<p>With these tools, you have a complete framework for building, logging, and optimizing RAG workflows. As LLM technology continues to evolve, the ability to track, evaluate, and fine-tune every aspect of model performance will be essential. We highly encourage you to experiment further and see how these tools can be tailored to your own applications.</p>
<p>To continue learning, explore the following resources:</p>
<ul>
<li class="">Learn more about the <a href=https://mlflow.org/docs/latest/llms/llama-index/index.html target=_blank rel="noopener noreferrer" class="">MLflow LlamaIndex integration</a>.</li>
<li class="">Discover additional MLflow LLM features at <a href=https://mlflow.org/docs/latest/llms/index.html target=_blank rel="noopener noreferrer" class="">LLMs in MLflow</a>.</li>
<li class="">Deploy your workflow to a serving endpoint with <a href=https://mlflow.org/docs/latest/deployment/index.html target=_blank rel="noopener noreferrer" class="">MLflow Deployment</a>.</li>
<li class="">Check out more <a href=https://docs.llamaindex.ai/en/stable/module_guides/workflow/#examples target=_blank rel="noopener noreferrer" class="">Workflow examples</a> from LlamaIndex.</li>
</ul></div><footer class=docusaurus-mt-lg><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class=col><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class=tag_QGVx><a rel=tag class="tag_zVej tagRegular_sFm0" href=/mlflow-website/blog/tags/genai>genai</a><li class=tag_QGVx><a rel=tag class="tag_zVej tagRegular_sFm0" href=/mlflow-website/blog/tags/mlops>mlops</a><li class=tag_QGVx><a rel=tag class="tag_zVej tagRegular_sFm0" href=/mlflow-website/blog/tags/mlflow-evaluate>mlflow-evaluate</a></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href=/mlflow-website/blog/bedrock-chat-model-part-1><div class=pagination-nav__sublabel>Newer post</div><div class=pagination-nav__label>Using Bedrock Agent as an MLflow ChatModel with Tracing</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/mlflow-website/blog/llm-as-judge><div class=pagination-nav__sublabel>Older post</div><div class=pagination-nav__label>LLM as judge</div></a></nav></div></div></div></div></main><footer class="relative pb-30 flex flex-col pt-30"><div style="position:absolute;width:100%;bottom:0;pointer-events:none;mask-composite:intersect;height:360px;background-image:repeating-linear-gradient(
        to right,
        rgba(0, 0, 0, 0.05),
        rgba(0, 0, 0, 0.25) 18px,
        transparent 2px,
        transparent 10px
      ),
      radial-gradient(
        circle at bottom center,
        var(--color-brand-red) 0%,
        transparent 60%
      ),
      linear-gradient(to right, color-mix(in srgb, var(--color-brand-red), oklch(0.33 0.15 328.37) 80%), color-mix(in srgb, var(--color-brand-red), oklch(0.66 0.17 248.82) 100%));mask-image:radial-gradient(ellipse at center bottom, black 60%, transparent 80%),
      linear-gradient(to top, black 10%, transparent 40%)"></div><div class=z-1><div class="flex flex-row justify-between items-start px-6 lg:px-20 gap-10 xs:gap-0 max-w-container"><div class="flex flex-col gap-8"><svg xmlns=http://www.w3.org/2000/svg width=109 height=40 fill=none viewBox="0 0 109 40" class="h-[36px] shrink-0"><path fill=#fff d="M0 31.032v-15.53h3.543v1.968c.893-1.594 2.84-2.425 4.593-2.425 2.042 0 3.828.926 4.658 2.745 1.216-2.043 3.034-2.745 5.043-2.745 2.81 0 5.49 1.787 5.49 5.904v10.083h-3.574v-9.478c0-1.818-.926-3.19-3-3.19-1.947 0-3.224 1.53-3.224 3.445v9.22H9.893v-9.475c0-1.786-.898-3.18-3.003-3.18-1.977 0-3.223 1.467-3.223 3.444v9.221ZM27.855 31.032V7.929h3.703v23.103ZM30.07 39.487c.833.232 1.582.383 3.17.383 2.953 0 6.436-1.665 7.353-6.339l3.786-18.739h5.629l.687-3.117h-5.686l.765-3.725c.586-2.892 2.186-4.358 4.754-4.358.668 0 .48.058 1.076.17L52.427.57c-.793-.237-1.503-.379-3.049-.379a7.32 7.32 0 0 0-4.528 1.484c-1.441 1.114-2.393 2.75-2.827 4.863l-1.066 5.137h-5.034l-.411 3.12h4.823L36.859 32.12c-.383 1.965-1.5 4.315-4.708 4.315-.727 0-.463-.055-1.121-.162ZM53.342 30.905H49.64l5.074-23.309h3.701ZM71.807 16.477A7.962 7.962 0 0 0 60.97 27.904l2.425-1.78a5.005 5.005 0 0 1 3.845-8.145v1.895ZM62.618 29.472a7.962 7.962 0 0 0 10.836-11.428l-2.425 1.78a5.005 5.005 0 0 1-3.845 8.145v-1.894ZM78.092 15.493h4.044l.823 10.612 5.759-10.612 3.839.055 1.508 10.557 5.074-10.612 3.701.055-7.678 15.493H91.46l-1.783-11.106-5.895 11.106h-3.84ZM105.072 15.768h-.766v-.266h1.845v.272h-.765v2.243h-.314ZM106.614 15.502h.383l.482 1.34q.091.259.178.524h.018c.059-.176.113-.352.172-.524l.478-1.34h.383v2.515h-.298V16.63c0-.22.024-.523.04-.747h-.016l-.191.574-.475 1.304h-.208l-.481-1.302-.191-.574h-.015c.017.224.042.527.042.747v1.387h-.291Z"/></svg><div class="text-xs text-gray-800 text-left md:text-nowrap md:w-0">¬© 2025 MLflow Project, a Series of LF Projects, LLC.</div></div><div class="flex flex-col flex-wrap justify-end md:text-right md:flex-row gap-x-10 lg:gap-x-20 gap-y-5 w-2/5 md:w-auto md:pt-2 max-w-fit"><div><a href=/mlflow-website/>Components</a></div><div><a href=/mlflow-website/releases>Releases</a></div><div><a href=/mlflow-website/blog>Blog</a></div><div><a href=https://mlflow.org/docs/latest/ target=_blank rel="noopener noreferrer">Docs</a></div><div><a href=/mlflow-website/ambassadors>Ambassador Program</a></div></div></div></div></footer></div></div></div></body>