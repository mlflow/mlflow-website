<!doctype html><html lang=en dir=ltr class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated=false><head><meta charset=UTF-8><meta name=generator content="Docusaurus v3.9.2"><title data-rh=true>Using Bedrock Agent as an MLflow ChatModel with Tracing | MLflow</title><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"/><meta data-rh=true name=twitter:card content=summary_large_image /><meta data-rh=true property=og:url content=http://mlflow.org/mlflow-website/blog/bedrock-chat-model-part-1 /><meta data-rh=true property=og:locale content=en /><meta data-rh=true name=docusaurus_locale content=en /><meta data-rh=true name=docusaurus_tag content=default /><meta data-rh=true name=docsearch:language content=en /><meta data-rh=true name=docsearch:docusaurus_tag content=default /><meta data-rh=true property=og:title content="Using Bedrock Agent as an MLflow ChatModel with Tracing | MLflow"/><meta data-rh=true name=description content="A guide for using BedRock Runtime Agent with ChatModel and custom trace handling."/><meta data-rh=true property=og:description content="A guide for using BedRock Runtime Agent with ChatModel and custom trace handling."/><meta data-rh=true property=og:image content=http://mlflow.org/mlflow-website/img/blog/bedrock-chatmodel.png /><meta data-rh=true name=twitter:image content=http://mlflow.org/mlflow-website/img/blog/bedrock-chatmodel.png /><meta data-rh=true property=og:type content=article /><meta data-rh=true property=article:published_time content=2024-11-07T00:00:00.000Z /><meta data-rh=true property=article:author content=https://www.linkedin.com/in/jas-bali-195ba410a/ /><meta data-rh=true property=article:tag content=genai,pyfunc,bedrock,tracing /><link data-rh=true rel=icon href=/mlflow-website/img/mlflow-favicon.ico /><link data-rh=true rel=canonical href=http://mlflow.org/mlflow-website/blog/bedrock-chat-model-part-1 /><link data-rh=true rel=alternate href=http://mlflow.org/mlflow-website/blog/bedrock-chat-model-part-1 hreflang=en /><link data-rh=true rel=alternate href=http://mlflow.org/mlflow-website/blog/bedrock-chat-model-part-1 hreflang=x-default /><script data-rh=true type=application/ld+json>{"@context":"https://schema.org","@id":"http://mlflow.org/mlflow-website/blog/bedrock-chat-model-part-1","@type":"BlogPosting","author":{"@type":"Person","description":"Lead Specialist Solutions Architect at Databricks","image":"/mlflow-website/img/authors/jas_bali.png","name":"Jas Bali","url":"https://www.linkedin.com/in/jas-bali-195ba410a/"},"datePublished":"2024-11-07T00:00:00.000Z","description":"A guide for using BedRock Runtime Agent with ChatModel and custom trace handling.","headline":"Using Bedrock Agent as an MLflow ChatModel with Tracing","image":{"@id":"http://mlflow.org/mlflow-website/img/blog/bedrock-chatmodel.png","@type":"ImageObject","caption":"title image for the blog post: Using Bedrock Agent as an MLflow ChatModel with Tracing","contentUrl":"http://mlflow.org/mlflow-website/img/blog/bedrock-chatmodel.png","url":"http://mlflow.org/mlflow-website/img/blog/bedrock-chatmodel.png"},"isPartOf":{"@id":"http://mlflow.org/mlflow-website/blog","@type":"Blog","name":"Blog"},"keywords":[],"mainEntityOfPage":"http://mlflow.org/mlflow-website/blog/bedrock-chat-model-part-1","name":"Using Bedrock Agent as an MLflow ChatModel with Tracing","url":"http://mlflow.org/mlflow-website/blog/bedrock-chat-model-part-1"}</script><link rel=preconnect href=https://www.google-analytics.com><link rel=preconnect href=https://www.googletagmanager.com><script async src="https://www.googletagmanager.com/gtag/js?id=AW-16857946923"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","AW-16857946923",{anonymize_ip:!0})</script><link rel=preconnect href=https://www.googletagmanager.com><script>window.dataLayer=window.dataLayer||[],function(e,t,a,n,r){e[n]=e[n]||[],e[n].push({"gtm.start":new Date().getTime(),event:"gtm.js"});var d=t.getElementsByTagName(a)[0],g=t.createElement(a);g.async=!0,g.src="https://www.googletagmanager.com/gtm.js?id="+r+("dataLayer"!=n?"&l="+n:""),d.parentNode.insertBefore(g,d)}(window,document,"script","dataLayer","GTM-N6WMTTJ")</script><link rel=alternate type=application/rss+xml href=/mlflow-website/blog/rss.xml title="MLflow RSS Feed"><link rel=alternate type=application/atom+xml href=/mlflow-website/blog/atom.xml title="MLflow Atom Feed"><link rel=alternate type=application/rss+xml href=/mlflow-website/releases/rss.xml title="MLflow RSS Feed"><link rel=alternate type=application/atom+xml href=/mlflow-website/releases/atom.xml title="MLflow Atom Feed"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin=anonymous><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" display=swap><link rel=stylesheet href=/mlflow-website/assets/css/styles.d55e5617.css /><script src=/mlflow-website/assets/js/runtime~main.89e1452c.js defer></script><script src=/mlflow-website/assets/js/main.e4060ac2.js defer></script></head><body class=navigation-with-keyboard><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-N6WMTTJ" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript>


<svg style="display: none;"><defs>
<symbol id=theme-svg-external-link viewBox="0 0 24 24"><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"light"),document.documentElement.setAttribute("data-theme-choice",t||"light")}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="theme-layout-navbar navbar navbar--fixed-top"><div class=navbar__inner><div class="theme-layout-navbar-left navbar__items"><a class=navbar__brand href=/mlflow-website/></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type=button disabled title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill=currentColor d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"/></svg></button></div><div class=navbarSearchContainer_Bca1></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="flex flex-col min-h-screen w-full bg-[#0E1416]"><nav class="fixed w-full z-20 top-0 start-0 bg-black/20 border-b border-[#F7F8F8]/8 backdrop-blur-[20px] overflow-y-auto"><div class="flex flex-wrap items-center mx-auto px-6 lg:px-20 py-2 max-w-container"><div class="md:contents flex flex-row justify-between w-full sticky top-[8px]"><a class="flex items-center space-x-3 rtl:space-x-reverse grow basis-0" href=/mlflow-website/><svg xmlns=http://www.w3.org/2000/svg width=109 height=40 fill=none viewBox="0 0 109 40" class=h-[36px]><path fill=#fff d="M0 31.032v-15.53h3.543v1.968c.893-1.594 2.84-2.425 4.593-2.425 2.042 0 3.828.926 4.658 2.745 1.216-2.043 3.034-2.745 5.043-2.745 2.81 0 5.49 1.787 5.49 5.904v10.083h-3.574v-9.478c0-1.818-.926-3.19-3-3.19-1.947 0-3.224 1.53-3.224 3.445v9.22H9.893v-9.475c0-1.786-.898-3.18-3.003-3.18-1.977 0-3.223 1.467-3.223 3.444v9.221ZM27.855 31.032V7.929h3.703v23.103ZM30.07 39.487c.833.232 1.582.383 3.17.383 2.953 0 6.436-1.665 7.353-6.339l3.786-18.739h5.629l.687-3.117h-5.686l.765-3.725c.586-2.892 2.186-4.358 4.754-4.358.668 0 .48.058 1.076.17L52.427.57c-.793-.237-1.503-.379-3.049-.379a7.32 7.32 0 0 0-4.528 1.484c-1.441 1.114-2.393 2.75-2.827 4.863l-1.066 5.137h-5.034l-.411 3.12h4.823L36.859 32.12c-.383 1.965-1.5 4.315-4.708 4.315-.727 0-.463-.055-1.121-.162ZM53.342 30.905H49.64l5.074-23.309h3.701ZM71.807 16.477A7.962 7.962 0 0 0 60.97 27.904l2.425-1.78a5.005 5.005 0 0 1 3.845-8.145v1.895ZM62.618 29.472a7.962 7.962 0 0 0 10.836-11.428l-2.425 1.78a5.005 5.005 0 0 1-3.845 8.145v-1.894ZM78.092 15.493h4.044l.823 10.612 5.759-10.612 3.839.055 1.508 10.557 5.074-10.612 3.701.055-7.678 15.493H91.46l-1.783-11.106-5.895 11.106h-3.84ZM105.072 15.768h-.766v-.266h1.845v.272h-.765v2.243h-.314ZM106.614 15.502h.383l.482 1.34q.091.259.178.524h.018c.059-.176.113-.352.172-.524l.478-1.34h.383v2.515h-.298V16.63c0-.22.024-.523.04-.747h-.016l-.191.574-.475 1.304h-.208l-.481-1.302-.191-.574h-.015c.017.224.042.527.042.747v1.387h-.291Z"/></svg></a><div class="flex flex-row items-center gap-6 md:order-2 space-x-3 md:space-x-0 rtl:space-x-reverse grow justify-end basis-0"><a class="hidden md:block" href=/mlflow-website/#get-started><button class="rounded-xl inline-flex items-center justify-center whitespace-nowrap font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 hover:cursor-pointer bg-white text-black hover:bg-gray-900 text-[15px] px-4 py-2 w-fit">Get started</button></a><button data-collapse-toggle=navbar-sticky type=button class="inline-flex items-center p-2 w-10 h-10 justify-center text-sm text-white md:hidden focus:outline-none cursor-pointer"><span class=sr-only>Open main menu</span><svg class="w-5 h-5" aria-hidden=true xmlns=http://www.w3.org/2000/svg fill=none viewBox="0 0 17 14"><path stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M1 1h15M1 7h15M1 13h15"/></svg></button></div></div><div class="items-center justify-between w-full md:w-auto md:order-1 mt-4 md:mt-0 hidden md:flex"><ul class="flex flex-col font-medium md:flex-row gap-y-6 gap-x-4 lg:gap-x-10 w-full md:w-auto"><li class="w-full md:w-auto md:hidden"><button type=button aria-expanded=false aria-controls=mobile-components-submenu class="flex items-center justify-between gap-2 py-2 text-white text-lg w-full cursor-pointer transition-colors duration-200 hover:text-white/60">Components<svg xmlns=http://www.w3.org/2000/svg width=16 height=17 fill=none viewBox="0 0 16 17" class="w-6 h-6 transition-transform duration-300"><path fill=#F7F8F8 fill-rule=evenodd d="m8 10.776 3.61-3.61-.943-.942L8 8.89 5.333 6.224l-.942.943z" clip-rule=evenodd /></svg></button><div id=mobile-components-submenu class="transition-all duration-300 ease-in-out overflow-hidden max-h-0 opacity-0"><div class="flex flex-col md:flex-row md:max-w-4xl mx-auto gap-6 md:gap-8 lg:gap-10 px-1 md:px-4 lg:pl-0 products-submenu overflow-x-hidden"><div class="flex flex-col gap-4"><div class="flex flex-col gap-1 md:gap-4 border-b border-[#F7F8F8]/8 pb-4 group"><a href=/mlflow-website/genai><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">GenAI Apps & Agents</h3><p class="text-[#F7F8F8]/60 m-0">Ship high-quality GenAI, fast</p></a></div><div class="flex flex-col gap-3"><span class="text-[#F7F8F8]/60 text-sm">Features</span><div class="flex flex-row gap-6 xxs:gap-8"><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/observability>Observability</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/evaluations>Evaluations</a></div><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/prompt-registry>Prompt Registry</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/ai-gateway>AI Gateway</a></div></div></div></div><div class="flex flex-col gap-4"><div class="flex flex-col gap-1 md:gap-4 border-b border-[#F7F8F8]/8 pb-4 group"><a href=/mlflow-website/classical-ml><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">Model Training</h3><p class="text-[#F7F8F8]/60 m-0">Mastering the ML lifecycle</p></a></div><div class="flex flex-col gap-3"><span class="text-[#F7F8F8]/60 text-sm">Features</span><div class="flex flex-row gap-6 xxs:gap-8"><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/experiment-tracking>Experiment tracking</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/model-evaluation>Model evaluation</a></div><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/models>MLflow models</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/model-registry>Model Registry & deployment</a></div></div></div></div></div></div><li class="w-full md:w-auto hidden md:block"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60">Components<svg xmlns=http://www.w3.org/2000/svg width=16 height=17 fill=none viewBox="0 0 16 17" class="w-6 h-6"><path fill=#F7F8F8 fill-rule=evenodd d="m8 10.776 3.61-3.61-.943-.942L8 8.89 5.333 6.224l-.942.943z" clip-rule=evenodd /></svg></a><li class="w-full md:w-auto"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/releases>Releases</a><li class="w-full md:w-auto"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/blog>Blog</a><li class="w-full md:w-auto md:hidden"><button type=button aria-expanded=false aria-controls=mobile-docs-submenu class="flex items-center justify-between gap-2 py-2 text-white text-lg w-full cursor-pointer transition-colors duration-200 hover:text-white/60">Docs<svg xmlns=http://www.w3.org/2000/svg width=16 height=17 fill=none viewBox="0 0 16 17" class="w-6 h-6 transition-transform duration-300"><path fill=#F7F8F8 fill-rule=evenodd d="m8 10.776 3.61-3.61-.943-.942L8 8.89 5.333 6.224l-.942.943z" clip-rule=evenodd /></svg></button><div id=mobile-docs-submenu class="transition-all duration-300 ease-in-out overflow-hidden max-h-0 opacity-0"><div class="flex flex-col md:flex-row md:max-w-2xl mx-auto gap-6 md:gap-8 lg:gap-10 px-1 md:px-4 lg:pl-0 docs-submenu overflow-x-hidden"><div class="flex flex-col gap-1 md:gap-2 pb-4 flex-1 group"><a href=https://mlflow.org/docs/latest/genai/ target=_blank rel="noopener noreferrer"><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">GenAI Apps & Agents</h3><p class="text-[#F7F8F8]/60 m-0">Learn how to track, evaluate, and optimize your GenAI applications and agent workflows.</p></a></div><div class="flex flex-col gap-1 md:gap-2 pb-4 flex-1 group"><a href=https://mlflow.org/docs/latest/ml/ target=_blank rel="noopener noreferrer"><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">Model Training</h3><p class="text-[#F7F8F8]/60 m-0">Get started with the core functionality for traditional machine learning workflows, hyperparameter tuning, and model lifecycle management.</p></a></div></div></div><li class="w-full md:w-auto hidden md:block"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60">Docs<svg xmlns=http://www.w3.org/2000/svg width=16 height=17 fill=none viewBox="0 0 16 17" class="w-6 h-6"><path fill=#F7F8F8 fill-rule=evenodd d="m8 10.776 3.61-3.61-.943-.942L8 8.89 5.333 6.224l-.942.943z" clip-rule=evenodd /></svg></a><li class="w-full md:w-auto"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/ambassadors>Ambassador Program</a><li class="w-full md:w-auto md:hidden"><a href=/mlflow-website/#get-started><button class="rounded-xl inline-flex items-center justify-center whitespace-nowrap font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 hover:cursor-pointer bg-white text-black hover:bg-gray-900 text-[15px] px-4 py-2 w-full">Get started</button></a></ul></div></div><div class="flex-col w-full py-6 hidden"><div class="flex flex-col md:flex-row md:max-w-4xl mx-auto gap-6 md:gap-8 lg:gap-10 px-1 md:px-4 lg:pl-0 products-submenu overflow-x-hidden"><div class="flex flex-col gap-4"><div class="flex flex-col gap-1 md:gap-4 border-b border-[#F7F8F8]/8 pb-4 group"><a href=/mlflow-website/genai><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">GenAI Apps & Agents</h3><p class="text-[#F7F8F8]/60 m-0">Ship high-quality GenAI, fast</p></a></div><div class="flex flex-col gap-3"><span class="text-[#F7F8F8]/60 text-sm">Features</span><div class="flex flex-row gap-6 xxs:gap-8"><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/observability>Observability</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/evaluations>Evaluations</a></div><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/prompt-registry>Prompt Registry</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/ai-gateway>AI Gateway</a></div></div></div></div><div class="flex flex-col gap-4"><div class="flex flex-col gap-1 md:gap-4 border-b border-[#F7F8F8]/8 pb-4 group"><a href=/mlflow-website/classical-ml><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">Model Training</h3><p class="text-[#F7F8F8]/60 m-0">Mastering the ML lifecycle</p></a></div><div class="flex flex-col gap-3"><span class="text-[#F7F8F8]/60 text-sm">Features</span><div class="flex flex-row gap-6 xxs:gap-8"><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/experiment-tracking>Experiment tracking</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/model-evaluation>Model evaluation</a></div><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/models>MLflow models</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/model-registry>Model Registry & deployment</a></div></div></div></div></div></div><div class="flex-col w-full py-6 hidden"><div class="flex flex-col md:flex-row md:max-w-2xl mx-auto gap-6 md:gap-8 lg:gap-10 px-1 md:px-4 lg:pl-0 docs-submenu overflow-x-hidden"><div class="flex flex-col gap-1 md:gap-2 pb-4 flex-1 group"><a href=https://mlflow.org/docs/latest/genai/ target=_blank rel="noopener noreferrer"><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">GenAI Apps & Agents</h3><p class="text-[#F7F8F8]/60 m-0">Learn how to track, evaluate, and optimize your GenAI applications and agent workflows.</p></a></div><div class="flex flex-col gap-1 md:gap-2 pb-4 flex-1 group"><a href=https://mlflow.org/docs/latest/ml/ target=_blank rel="noopener noreferrer"><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">Model Training</h3><p class="text-[#F7F8F8]/60 m-0">Get started with the core functionality for traditional machine learning workflows, hyperparameter tuning, and model lifecycle management.</p></a></div></div></div></nav><main class="flex flex-col"><div class="relative flex flex-col gap-20 bg-no-repeat w-full py-32"><div style="position:absolute;width:100%;top:0;pointer-events:none;mask-composite:intersect;height:820px;background-image:repeating-linear-gradient(
        to right,
        rgba(0, 0, 0, 0.05),
        rgba(0, 0, 0, 0.25) 24px,
        transparent 2px,
        transparent 10px
      ),
      radial-gradient(
        circle at top center,
        var(--color-brand-red) 0%,
        transparent 60%
      ),
      linear-gradient(to right, color-mix(in srgb, var(--color-brand-red), oklch(0.33 0.15 328.37) 80%), color-mix(in srgb, var(--color-brand-red), oklch(0.66 0.17 248.82) 100%));mask-image:linear-gradient(to bottom, black 40%, transparent 90%)"></div><div class=z-1><div class="flex flex-col gap-24 w-full px-6 md:px-20 max-w-container"><div class="flex flex-col max-w-7xl mx-auto w-full"><article class=""><header><h1 class=title_f1Hy>Using Bedrock Agent as an MLflow ChatModel with Tracing</h1><div class="container_mt6G margin-vert--md"><time datetime=2024-11-07T00:00:00.000Z>November 7, 2024</time> · <!-- -->74 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href=https://www.linkedin.com/in/jas-bali-195ba410a/ target=_blank rel="noopener noreferrer" class=avatar__photo-link><img class="avatar__photo authorImage_XqGP" src=/mlflow-website/img/authors/jas_bali.png alt="Jas Bali"/></a><div class="avatar__intro authorDetails_lV9A"><div class=avatar__name><a href=https://www.linkedin.com/in/jas-bali-195ba410a/ target=_blank rel="noopener noreferrer"><span class=authorName_yefp translate=no>Jas Bali</span></a></div><small class=authorTitle_nd0D title="Lead Specialist Solutions Architect at Databricks">Lead Specialist Solutions Architect at Databricks</small><div class=authorSocials_rSDt></div></div></div></div></div></header><div id=__blog-post-container class=markdown><p><img decoding=async loading=lazy alt=Thumbnail src=/mlflow-website/assets/images/bedrock_chatmodel-d0f0e66cc93ae5d58f3fcaafbb5e79b1.png width=2282 height=1280 class=img_ev3q /></p>
<p><strong>In this blog post, we delve into the integration of AWS Bedrock Agent as a ChatModel within MLflow, focusing on
how to leverage Bedrock's <a href=https://docs.aws.amazon.com/bedrock/latest/userguide/agents-action-create.html target=_blank rel="noopener noreferrer" class="">Action Groups</a>
and <a href=https://docs.aws.amazon.com/bedrock/latest/userguide/agents-kb-add.html target=_blank rel="noopener noreferrer" class="">Knowledge Bases</a> to build a
conversational AI application. The blog will guide you through setting up the Bedrock Agent, configuring
Action Groups to enable custom actions with Lambda, and utilizing knowledge bases for context-aware interactions.
A special emphasis is placed on implementing tracing within MLflow.By the end of this article, you'll have a good
understanding of how to combine AWS Bedrock's advanced features with MLflow's capabilities such as agent request
tracing, model tracking and consistent signatures for input examples.</strong></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=what-is-aws-bedrock>What is AWS Bedrock?<a href=#what-is-aws-bedrock class=hash-link aria-label="Direct link to What is AWS Bedrock?" title="Direct link to What is AWS Bedrock?" translate=no>​</a></h2>
<p>Amazon Bedrock is a managed service by AWS that simplifies the development of generative AI applications. It provides access to a variety of foundation models (FMs) from leading AI providers through a single API, enabling developers to build and scale AI solutions securely and efficiently.</p>
<p>Key Components Relevant to This Integration:</p>
<p><strong>Bedrock Agent</strong>: At a high level, a bedrock agent is an abstraction within bedrock that consists of a foundation model,
action groups and knowledge bases.</p>
<p><strong>Action Groups</strong>: These are customizable sets of actions that define what tasks the Bedrock Agent can perform.
Action Groups consist of an OpenAPI Schema and the corresponding Lambda functions that will be used to execute tool calls.
The OpenAPI Schema is used to define APIs available for the agent to invoke and complete tasks.</p>
<p><strong>Knowledge Bases</strong>: Amazon Bedrock supports the creation of Knowledge Bases to implement
Retrieval Augmented Generation workflows. It consists of data sources (on S3 or webpages)
and a vector store that contains the embedded references to this data.</p>
<p>Bedrock's Agent execution process and the corresponding tracing for Agent instrumentation is grouped as follows:</p>
<p><strong>Pre-processing</strong>
This step validates, contextualizes and categorizes user input.</p>
<p><strong>Orchestration</strong>
This step handles the interpretation of user inputs, deciding when to and which tasks to perform,
and iteratively refines responses</p>
<p><strong>Post-processing (Optional)</strong>
This step formats the final response before returning to the user.</p>
<p><strong>Traces</strong>
Each step above has an execution trace, which consists of rationale, actions, queries and observations at each step
of the agent's response. This includes both the inputs and outputs of action groups and knowledge base queries.</p>
<p>We will look at these traces in detail below.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=what-is-a-chatmodel-in-mlflow>What is a ChatModel in MLflow?<a href=#what-is-a-chatmodel-in-mlflow class=hash-link aria-label="Direct link to What is a ChatModel in MLflow?" title="Direct link to What is a ChatModel in MLflow?" translate=no>​</a></h2>
<p>The <a href=https://mlflow.org/docs/latest/llms/chat-model-guide/index.html target=_blank rel="noopener noreferrer" class="">ChatModel class</a> is specifically
designed to make it easier to implement models that are compatible with
popular large language model (LLM) chat APIs. It enables you to seamlessly bring in your own models or agents and
leverage MLflow's functionality, even if those models aren't natively supported as a flavor in MLflow. Additionally,
It provides default signatures, which are static for ChatModel, unlike PythonModel.</p>
<p>In the following sections, we will use ChatModel to wrap the Bedrock Agent.</p>
<p>For more detailed information about ChatModel, you can read the MLflow documentation
<a href=https://mlflow.org/docs/latest/llms/chat-model-guide/index.html target=_blank rel="noopener noreferrer" class="">here</a> and
<a href=https://mlflow.org/docs/latest/python_api/mlflow.pyfunc.html#mlflow.pyfunc.ChatModel target=_blank rel="noopener noreferrer" class="">here</a></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=setting-up-aws-bedrock-agent-with-an-action-group>Setting up AWS Bedrock Agent with an Action group<a href=#setting-up-aws-bedrock-agent-with-an-action-group class=hash-link aria-label="Direct link to Setting up AWS Bedrock Agent with an Action group" title="Direct link to Setting up AWS Bedrock Agent with an Action group" translate=no>​</a></h2>
<p>In this section, we will deploy all components of a bedrock agent so that we can invoke it as a <code>ChatModel</code> in MLflow.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id=prerequisites>Prerequisites<a href=#prerequisites class=hash-link aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites" translate=no>​</a></h3>
<p>You will need to setup following items (either via the AWS console or SDKs):</p>
<ul>
<li class="">Setting up role for the agent and Lambda function. <a href=https://github.com/awsdocs/aws-doc-sdk-examples/blob/main/python/example_code/bedrock-agent/scenario_get_started_with_agents.py#L148 target=_blank rel="noopener noreferrer" class="">Example</a></li>
<li class="">Create/deploy the agent. <a href=https://github.com/awsdocs/aws-doc-sdk-examples/blob/main/python/example_code/bedrock-agent/scenario_get_started_with_agents.py#L191 target=_blank rel="noopener noreferrer" class="">Example</a>
<ul>
<li class=""><strong>Important</strong>: Save the agent ID here as we will need this below.</li>
</ul>
</li>
<li class="">Creating a Lambda function. <a href=https://github.com/awsdocs/aws-doc-sdk-examples/blob/main/python/example_code/bedrock-agent/scenario_get_started_with_agents.py#L218 target=_blank rel="noopener noreferrer" class="">Example</a></li>
<li class="">Configuring IAM permissions for agent-Lambda interaction. <a href=https://github.com/awsdocs/aws-doc-sdk-examples/blob/main/python/example_code/bedrock-agent/scenario_get_started_with_agents.py#L283 target=_blank rel="noopener noreferrer" class="">Example</a> and <a href=https://github.com/awsdocs/aws-doc-sdk-examples/blob/main/python/example_code/bedrock-agent/scenario_get_started_with_agents.py#L297 target=_blank rel="noopener noreferrer" class="">Example</a></li>
<li class="">Creating an action group to link the agent and Lambda. <a href=https://github.com/awsdocs/aws-doc-sdk-examples/blob/main/python/example_code/bedrock-agent/scenario_get_started_with_agents.py#L312 target=_blank rel="noopener noreferrer" class="">Example</a>
<ul>
<li class=""><strong>Important</strong>:Save<!-- --> the agent alias ID here as we will need this below.</li>
</ul>
</li>
<li class="">Deploy Bedrock agent with an alias. <a href=https://github.com/awsdocs/aws-doc-sdk-examples/blob/main/python/example_code/bedrock-agent/scenario_get_started_with_agents.py#L342 target=_blank rel="noopener noreferrer" class="">Example</a></li>
</ul>
<b>In our case, we are going to deploy the following example action group, which calculates the next optimal departure
date for a Hohmann transfer from Earth to Mars, based on the spacecraft's mass and specific impulse.</b>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id=openapi-schema-for-action-groups>OpenAPI schema for Action Groups<a href=#openapi-schema-for-action-groups class=hash-link aria-label="Direct link to OpenAPI schema for Action Groups" title="Direct link to OpenAPI schema for Action Groups" translate=no>​</a></h3>
<p>As described above, here is the OpenAPI Schema for our example action group:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token key atrule">openapi</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> 3.0.0</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token key atrule">info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  </span><span class="token key atrule">title</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Time API</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  </span><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> 1.0.0</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  </span><span class="token key atrule">description</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> API to get the next optimal departure date for a Hohmann transfer from Earth to Mars.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token key atrule">paths</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  </span><span class="token key atrule">/get-next-mars-launch-window</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token key atrule">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      </span><span class="token key atrule">summary</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Gets the next optimal launch window to Mars.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      </span><span class="token key atrule">description</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Gets the next optimal launch window to Mars.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      </span><span class="token key atrule">operationId</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> getNextMarsLaunchWindow</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      </span><span class="token key atrule">parameters</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> total_mass</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          </span><span class="token key atrule">in</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> query</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          </span><span class="token key atrule">description</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Total mass of the spacecraft including fuel (kg)</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          </span><span class="token key atrule">required</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          </span><span class="token key atrule">schema</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> string</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> dry_mass</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          </span><span class="token key atrule">in</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> query</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          </span><span class="token key atrule">description</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Mass of the spacecraft without fuel (kg).</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          </span><span class="token key atrule">required</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          </span><span class="token key atrule">schema</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> string</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> specific_impulse</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          </span><span class="token key atrule">in</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> query</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          </span><span class="token key atrule">description</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Specific impulse of the propulsion system (s).</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          </span><span class="token key atrule">required</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          </span><span class="token key atrule">schema</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> string</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      </span><span class="token key atrule">responses</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token key atrule">"200"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          </span><span class="token key atrule">description</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> The next optimal departure date for a Hohmann transfer from Earth to Mars</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> based on the spacecraft's mass and specific impulse.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          </span><span class="token key atrule">content</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token key atrule">"application/json"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">              </span><span class="token key atrule">schema</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> object</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                  </span><span class="token key atrule">next_launch_window</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> string</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token key atrule">description</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Next Mars Launch Window</span><br/></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id=action-groups---lamda-function>Action groups - Lamda function<a href=#action-groups---lamda-function class=hash-link aria-label="Direct link to Action groups - Lamda function" title="Direct link to Action groups - Lamda function" translate=no>​</a></h3>
<p>Here is the code deployment for action group's example Lambda:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> json</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> math</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> datetime </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> datetime</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> timedelta</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">lambda_handler</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">_calculate_optimal_departure_window</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        total_mass</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> dry_mass</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> specific_impulse</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Calculate the next optimal departure date for a Hohmann transfer from Earth to Mars,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        based on the spacecraft's mass and specific impulse.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Parameters:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        - total_mass (float): Total mass of the spacecraft including fuel (kg).</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        - dry_mass (float): Mass of the spacecraft without fuel (kg).</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        - specific_impulse (float): Specific impulse of the propulsion system (s).</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Returns:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        - dict: {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            'next_launch_date': datetime,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            'synodic_period_days': float,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            'transfer_time_days': float,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            'delta_v_available_m_s': float,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            'delta_v_required_m_s': float,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            'is_feasible': bool</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">          }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        current_date </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Constants</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        G0 </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">9.80665</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># m/s^2, standard gravity</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        MU_SUN </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token number" style="color:rgb(181, 206, 168)">1.32712440018e20</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># m^3/s^2, standard gravitational parameter for the Sun</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        AU </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1.496e11</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># meters, astronomical unit</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        EARTH_ORBITAL_PERIOD </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">365.25</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># days</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        MARS_ORBITAL_PERIOD </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">686.98</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># days</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        SYNODIC_PERIOD </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">abs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> EARTH_ORBITAL_PERIOD</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> MARS_ORBITAL_PERIOD</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        TRANSFER_TIME </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">259</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># days, approximate duration of Hohmann transfer</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        BASE_LAUNCH_DATE </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> datetime</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">2020</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">7</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># A reference past launch window date</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Orbital Radii (assuming circular orbits for simplicity)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        r1 </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> AU  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Earth's orbital radius in meters</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        r2 </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1.524</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> AU  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Mars' orbital radius in meters</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Calculate Required Delta-V for Hohmann Transfer</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Using vis-viva equation for Hohmann transfer</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">calculate_hohmann_delta_v</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">mu</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> r_start</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> r_end</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Velocity of departure orbit (Earth)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            v_start </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> math</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sqrt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">mu </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> r_start</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Velocity of transfer orbit at departure</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            a_transfer </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">r_start </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> r_end</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            v_transfer_start </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> math</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sqrt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">mu </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> r_start </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> a_transfer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            delta_v1 </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> v_transfer_start </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> v_start</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Velocity of arrival orbit (Mars)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            v_end </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> math</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sqrt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">mu </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> r_end</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Velocity of transfer orbit at arrival</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            v_transfer_end </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> math</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sqrt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">mu </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> r_end </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> a_transfer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            delta_v2 </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> v_end </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> v_transfer_end</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> delta_v1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> delta_v2</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        delta_v1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> delta_v2 </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> calculate_hohmann_delta_v</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">MU_SUN</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> r1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> r2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        delta_v_required </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">abs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">delta_v1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">abs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">delta_v2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Total delta-v in m/s</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Delta-V using Tsiolkovsky Rocket Equation</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> dry_mass </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">or</span><span class="token plain"> total_mass </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;=</span><span class="token plain"> dry_mass</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">raise</span><span class="token plain"> ValueError</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Total mass must be greater than dry mass."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        delta_v_available </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            specific_impulse </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> G0 </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> math</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">log</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">total_mass </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> dry_mass</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># m/s</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        is_feasible </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> delta_v_available </span><span class="token operator" style="color:rgb(212, 212, 212)">>=</span><span class="token plain"> delta_v_required</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> current_date </span><span class="token keyword" style="color:rgb(86, 156, 214)">is</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            current_date </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> datetime</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">now</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        days_since_base </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">current_date </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> BASE_LAUNCH_DATE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">days</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> days_since_base </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># Current date is before the base launch date</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            next_launch_date </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> BASE_LAUNCH_DATE</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            synodic_periods_passed </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> days_since_base </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> SYNODIC_PERIOD</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            synodic_periods_passed_int </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> math</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">floor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">synodic_periods_passed</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            next_launch_date </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> BASE_LAUNCH_DATE </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> timedelta</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                days</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">synodic_periods_passed_int </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> SYNODIC_PERIOD</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        next_launch_date </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> next_launch_date</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">replace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            hour</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> minute</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> second</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> microsecond</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"next_launch_date"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> next_launch_date</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"synodic_period_days"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> SYNODIC_PERIOD</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"transfer_time_days"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> TRANSFER_TIME</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"delta_v_available_m_s"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> delta_v_available</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"delta_v_required_m_s"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> delta_v_required</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"is_feasible"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> is_feasible</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    query_params </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"name"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"value"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> event </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"parameters"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    total_mass </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">float</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">query_params</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"total_mass"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    dry_mass </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">float</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">query_params</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"dry_mass"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    specific_impulse </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">float</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">query_params</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"specific_impulse"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">"next_launch_window"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> _calculate_optimal_departure_window</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            total_mass</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> dry_mass</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> specific_impulse</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    response_body </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">"application/json"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">"body"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> json</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">dumps</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    action_response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">"actionGroup"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"actionGroup"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">"apiPath"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"apiPath"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">"httpMethod"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"httpMethod"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">"httpStatusCode"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">200</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">"responseBody"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> response_body</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    session_attributes </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"sessionAttributes"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    prompt_session_attributes </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"promptSessionAttributes"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">"messageVersion"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"1.0"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">"response"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> action_response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">"sessionAttributes"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> session_attributes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">"promptSessionAttributes"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> prompt_session_attributes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br/></span></code></pre></div></div>
<p>Next, we are going to wrap Bedrock agent as a ChatModel so that we can register and load it for inference.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=writing-chatmodel-for-bedrock-agent>Writing ChatModel for Bedrock agent<a href=#writing-chatmodel-for-bedrock-agent class=hash-link aria-label="Direct link to Writing ChatModel for Bedrock agent" title="Direct link to Writing ChatModel for Bedrock agent" translate=no>​</a></h2>
<p>Here are the top-level packages used for running the following example locally in <strong>Python 3.12.7</strong>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token plain">boto3==1.35.31</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">mlflow==2.16.2</span><br/></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id=implementing-bedrock-agent-as-an-mlflow-chatmodel-with-tracing>Implementing Bedrock Agent as an MLflow ChatModel with Tracing<a href=#implementing-bedrock-agent-as-an-mlflow-chatmodel-with-tracing class=hash-link aria-label="Direct link to Implementing Bedrock Agent as an MLflow ChatModel with Tracing" title="Direct link to Implementing Bedrock Agent as an MLflow ChatModel with Tracing" translate=no>​</a></h3>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> copy</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> os</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> uuid</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> typing </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> List</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> Optional</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> boto3</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> mlflow</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> botocore</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">config </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> Config</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">entities </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> SpanType</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">pyfunc </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> ChatModel</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">types</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">llm </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> ChatResponse</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> ChatMessage</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> ChatParams</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> ChatChoice</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">BedrockModel</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ChatModel</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">__init__</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Initializes the BedrockModel instance with placeholder values.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Note:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            The `load_context` method cannot create new instance variables; it can only modify existing ones.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            Therefore, all instance variables should be defined in the `__init__` method with placeholder values.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">brt </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_main_bedrock_agent </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_bedrock_agent_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_bedrock_agent_alias_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_inference_configuration </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_agent_instruction </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_model </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_aws_region </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">__getstate__</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Prepares the instance state for pickling.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        This method is needed because the `boto3` client (`self.brt`) cannot be pickled.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        By excluding `self.brt` from the state, we ensure that the model can be serialized and deserialized properly.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Create a dictionary of the instance's state, excluding the boto3 client</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        state </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">__dict__</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">copy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">del</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"brt"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> state</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">__setstate__</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Restores the instance state during unpickling.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        This method is needed to reinitialize the `boto3` client (`self.brt`) after the instance is unpickled,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        because the client was excluded during pickling.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">__dict__</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">update</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">state</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">brt </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">load_context</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Initializes the Bedrock client with AWS credentials.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Args:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            context: The MLflow context containing model configuration.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Note:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            Dependent secret variables must be in the execution environment prior to loading the model;</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            else they will not be available during model initialization.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_main_bedrock_agent </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> context</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">model_config</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"agents"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"main"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_bedrock_agent_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_main_bedrock_agent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"bedrock_agent_id"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_bedrock_agent_alias_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_main_bedrock_agent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"bedrock_agent_alias_id"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_inference_configuration </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_main_bedrock_agent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"inference_configuration"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_agent_instruction </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_main_bedrock_agent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"instruction"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_model </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_main_bedrock_agent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"model"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_aws_region </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_main_bedrock_agent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"aws_region"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Initialize the Bedrock client</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">brt </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> boto3</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">client</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            service_name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"bedrock-agent-runtime"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            config</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">Config</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">region_name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_aws_region</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            aws_access_key_id</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"AWS_ACCESS_KEY"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            aws_secret_access_key</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"AWS_SECRET_ACCESS_KEY"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            aws_session_token</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"AWS_SESSION_TOKEN"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            region_name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_aws_region</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">@staticmethod</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">_extract_trace_groups</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">events</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Extracts trace groups from a list of events based on their trace IDs.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Args:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            events (list): A list of event dictionaries.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Returns:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            dict: A dictionary where keys are trace IDs and values are lists of trace items.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> collections </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> defaultdict</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        trace_groups </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> defaultdict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">find_trace_ids</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> original_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> depth</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> parent_key</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> depth </span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Stop recursion after 5 levels if no traceId has been found</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">isinstance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                trace_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> obj</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"traceId"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Include the parent key as the 'type'</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    item </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">"type"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> parent_key</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">"data"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> obj</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">"event_order"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> original_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"trace"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                            </span><span class="token string" style="color:rgb(206, 145, 120)">"event_order"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    trace_groups</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">item</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> key</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> value </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> obj</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">items</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        find_trace_ids</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                            value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> original_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> depth</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">depth </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> parent_key</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">key</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">elif</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">isinstance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> item </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> obj</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    find_trace_ids</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">item</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> item</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> depth</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">depth </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> parent_key</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">parent_key</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        find_trace_ids</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">events</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">trace_groups</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">@staticmethod</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">_get_final_response_with_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">trace_id_groups</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token builtin" style="color:rgb(86, 156, 214)">dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Processes trace groups to extract the final response and create relevant MLflow spans.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Args:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            trace_id_groups (dict): A dictionary of trace groups keyed by trace IDs.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Returns:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            str: The final response text extracted from the trace groups.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        trace_id_groups_copy </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> copy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">deepcopy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">trace_id_groups</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        model_invocation_input_key </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"modelInvocationInput"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">_create_trace_by_type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            trace_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> _trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> context_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> optional_rationale_subtrace</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">@mlflow</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">trace_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                attributes</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">"trace_attributes"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> trace_id_groups</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">_trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">_trace_agent_pre_context</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">inner_input_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> optional_rationale_subtrace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"data"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"text"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            trace_id_groups_copy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">_trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">remove</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">context_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            _trace_agent_pre_context</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">context_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"data"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"text"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">_extract_action_group_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            _trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> action_group_invocation_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">dict</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">@mlflow</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"action-group-invocation"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                attributes</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">"trace_attributes"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> trace_id_groups</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">_trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">_action_group_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">inner_trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> _trace </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    action_group_invocation_output </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> _trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"data"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">"actionGroupInvocationOutput"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> action_group_invocation_output </span><span class="token keyword" style="color:rgb(86, 156, 214)">is</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">not</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        action_group_response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                                </span><span class="token string" style="color:rgb(206, 145, 120)">"action_group_name"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> action_group_invocation_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                                    </span><span class="token string" style="color:rgb(206, 145, 120)">"actionGroupName"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                                </span><span class="token string" style="color:rgb(206, 145, 120)">"api_path"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> action_group_invocation_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                                    </span><span class="token string" style="color:rgb(206, 145, 120)">"apiPath"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                                </span><span class="token string" style="color:rgb(206, 145, 120)">"execution_type"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> action_group_invocation_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                                    </span><span class="token string" style="color:rgb(206, 145, 120)">"executionType"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                                </span><span class="token string" style="color:rgb(206, 145, 120)">"execution_output"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> action_group_invocation_output</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                                    </span><span class="token string" style="color:rgb(206, 145, 120)">"text"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">remove</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> action_group_response</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            _action_group_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">action_group_invocation_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">_extract_knowledge_base_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            _trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> knowledge_base_lookup_input</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">@mlflow</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"knowledge-base-lookup"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                attributes</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">"trace_attributes"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> trace_id_groups</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">_trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">_knowledge_base_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">inner_trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> _trace </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    knowledge_base_lookup_output </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> _trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"data"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">"knowledgeBaseLookupOutput"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> knowledge_base_lookup_output </span><span class="token keyword" style="color:rgb(86, 156, 214)">is</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">not</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        knowledge_base_response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                                </span><span class="token string" style="color:rgb(206, 145, 120)">"knowledge_base_id"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> knowledge_base_lookup_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                                    </span><span class="token string" style="color:rgb(206, 145, 120)">"knowledgeBaseId"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                                </span><span class="token string" style="color:rgb(206, 145, 120)">"text"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> knowledge_base_lookup_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"text"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                                </span><span class="token string" style="color:rgb(206, 145, 120)">"retrieved_references"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> knowledge_base_lookup_output</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                                    </span><span class="token string" style="color:rgb(206, 145, 120)">"retrievedReferences"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">remove</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> knowledge_base_response</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            _knowledge_base_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">_trace_group_type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            _trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> _trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> optional_rationale_subtrace</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            trace_name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"observation"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            pre_processing_trace_id_suffix </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"-pre"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> pre_processing_trace_id_suffix </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> _trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                trace_name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"agent-initial-context"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> _inner_trace </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    action_group_invocation_input </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> _inner_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"data"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">"actionGroupInvocationInput"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> action_group_invocation_input </span><span class="token keyword" style="color:rgb(86, 156, 214)">is</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">not</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        action_group_name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> action_group_invocation_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                            </span><span class="token string" style="color:rgb(206, 145, 120)">"actionGroupName"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        trace_name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f"ACTION-GROUP-</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">action_group_name</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        _create_trace_by_type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                            trace_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> _trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> _trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> optional_rationale_subtrace</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        _extract_action_group_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                            _trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> action_group_invocation_input</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">remove</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    knowledge_base_lookup_input </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> _inner_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"data"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">"knowledgeBaseLookupInput"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> knowledge_base_lookup_input </span><span class="token keyword" style="color:rgb(86, 156, 214)">is</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">not</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        knowledge_base_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> knowledge_base_lookup_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                            </span><span class="token string" style="color:rgb(206, 145, 120)">"knowledgeBaseId"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        trace_name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f"KNOWLEDGE_BASE_</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">knowledge_base_id</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        _create_trace_by_type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                            trace_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> _trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> _trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> optional_rationale_subtrace</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        _extract_knowledge_base_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                            _trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> knowledge_base_lookup_input</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">remove</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> trace_name</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> _trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> _trace_group </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> trace_id_groups_copy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">items</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            trace_group </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">sorted</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">_trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> key</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token keyword" style="color:rgb(86, 156, 214)">lambda</span><span class="token plain"> tg</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> tg</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"event_order"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            model_invocation_input_subtrace </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            optional_rationale_subtrace </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> _trace </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> _trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> model_invocation_input_key </span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token plain"> _trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"type"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">""</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    model_invocation_input_subtrace </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> _trace</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">elif</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"rationale"</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token plain"> _trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"type"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">""</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    optional_rationale_subtrace </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> _trace</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            _trace_group_type</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                _trace_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                trace_group</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                model_invocation_input_subtrace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                optional_rationale_subtrace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        final_response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">trace_id_groups_copy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">values</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"data"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"finalResponse"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"text"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> final_response</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">@mlflow</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"Bedrock Input Prompt"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">_get_agent_prompt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> raw_input_question</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Constructs the agent prompt by combining the input question and the agent instruction.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Args:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            raw_input_question (str): The user's input question.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Returns:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            str: The formatted agent prompt.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">        Answer the following question and pay strong attention to the prompt:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">        &lt;question></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">        </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">raw_input_question</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">        &lt;/question></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">        &lt;instruction></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">        </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">self</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-interpolation interpolation">_agent_instruction</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">        &lt;/instruction></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">        """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">@mlflow</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"bedrock-agent"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> span_type</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">SpanType</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">CHAT_MODEL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">predict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> List</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ChatMessage</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> params</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Optional</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">ChatParams</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> ChatResponse</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Makes a prediction using the Bedrock agent and processes the response.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Args:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            context: The MLflow context.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            messages (List[ChatMessage]): A list of chat messages.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            params (Optional[ChatParams]): Optional parameters for the chat.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        Returns:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">            ChatResponse: The response from the Bedrock agent.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">        """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        formatted_input </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">content</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        session_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> uuid</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">uuid4</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token builtin" style="color:rgb(86, 156, 214)">hex</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">brt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">invoke_agent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            agentId</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_bedrock_agent_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            agentAliasId</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_bedrock_agent_alias_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            inputText</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_get_agent_prompt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">formatted_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            enableTrace</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            sessionId</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">session_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            endSession</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">False</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># Since this provider's output doesn't match the OpenAI specification,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># we need to go through the returned trace data and map it appropriately</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># to create the MLflow span object.</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        events </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> event </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">enumerate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"completion"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"trace"</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"trace"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"event_order"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> index</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            events</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">event</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        trace_id_groups </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_extract_trace_groups</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">events</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        final_response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_get_final_response_with_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">trace_id_groups</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">with</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">start_span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"retrieved-response"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> span_type</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">SpanType</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">AGENT</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_inputs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">messages</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_attributes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            output </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ChatResponse</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                choices</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    ChatChoice</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        index</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        message</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">ChatMessage</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">role</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"user"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> content</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">final_response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                usage</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            span</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_outputs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">output</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> output</span><br/></span></code></pre></div></div>
<p>Here are some important remarks about this <code>BedrockModel</code> implementation:</p>
<ul>
<li class="">AWS access key ID, secret key and the session token are externalized here. These need to be present in the environment before we can run inference.
You will need to generate it for your IAM user and set them as environment variables.</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token plain">aws sts get-session-token --duration-seconds 3600</span><br/></span></code></pre></div></div>
<p>And then set the following:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> os</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">'AWS_ACCESS_KEY'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"&lt;AccessKeyId>"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">'AWS_SECRET_ACCESS_KEY'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"&lt;SecretAccessKey>"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">'AWS_SESSION_TOKEN'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"&lt;SessionToken>"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span></code></pre></div></div>
<p>As noticed in the code above, these do not get logged with the model and are only set inside <code>load_context</code>.
This method is called when ChatModel is constructed. Further details are <a href=https://mlflow.org/docs/latest/python_api/mlflow.pyfunc.html#mlflow.pyfunc.PythonModel.load_context target=_blank rel="noopener noreferrer" class="">here</a></p>
<ul>
<li class="">
<p>Bedrock agent ID and agent alias ID are passed via <code>model_config</code> that we will use below.</p>
</li>
<li class="">
<p>boto3 module has been excluded from getting pickled. This is done via <code>__getstate__</code> and <code>__setstate__</code> where we exclude it and reset it respectively</p>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id=log-and-load-the-bedrockmodel>Log and load the BedrockModel<a href=#log-and-load-the-bedrockmodel class=hash-link aria-label="Direct link to Log and load the BedrockModel" title="Direct link to Log and load the BedrockModel" translate=no>​</a></h3>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> mlflow</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">models </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> infer_signature</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">input_example </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">"messages"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">"role"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"user"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">"content"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"When is the next launch window for Mars?"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">output_example </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">"choices"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"index"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"finish_reason"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"stop"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"message"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">"role"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"assistant"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"content"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"test content"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">signature </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> infer_signature</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">input_example</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> output_example</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">with</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">start_run</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    model_config </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">"agents"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"main"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">"model"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"anthropic.claude-v2"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">"aws_region"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"us-east-1"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">"bedrock_agent_id"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"O9KQSEVEFF"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">"bedrock_agent_alias_id"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"3WHEEJKNUT"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">"instruction"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token string" style="color:rgb(206, 145, 120)">"You have functions available at your disposal to use when anwering any questions about orbital mechanics."</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token string" style="color:rgb(206, 145, 120)">"if you can't find a function to answer a question about orbital mechanics, simply reply "</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token string" style="color:rgb(206, 145, 120)">"'I do not know'"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">"inference_configuration"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token string" style="color:rgb(206, 145, 120)">"temperature"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0.5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token string" style="color:rgb(206, 145, 120)">"maximumLength"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">2000</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Input example for the model</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    input_example </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">"messages"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">"role"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"user"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">"content"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"When is the next launch window for Mars? My spacecraft's total mass is 50000, dry mass is 10000 and specific impulse is 2500. Mass in Kg."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Log and load the model using MLflow</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    logged_chain_info </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">pyfunc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">log_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        python_model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">BedrockModel</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        model_config</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">model_config</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        artifact_path</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"chain"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># This string is used as the path inside the MLflow model where artifacts are stored</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        input_example</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">input_example</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># Must be a valid input to your chain</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">loaded </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">pyfunc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">load_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">logged_chain_info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">model_uri</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Predict using the loaded model</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> loaded</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">predict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">"messages"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">"role"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"user"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">"content"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"When is the next launch window for Mars? My spacecraft's total mass is 50000, dry mass is 10000 and specific impulse is 2500. Mass in Kg."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br/></span></code></pre></div></div>
<pre tabindex=0 class="codeBlockStandalone_MEMb thin-scrollbar language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><code class=codeBlockLines_e6Vv></code></pre>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id=mapping-bedrock-agent-trace-data-to-mlflow-span-objects>Mapping Bedrock Agent Trace Data to MLflow Span Objects<a href=#mapping-bedrock-agent-trace-data-to-mlflow-span-objects class=hash-link aria-label="Direct link to Mapping Bedrock Agent Trace Data to MLflow Span Objects" title="Direct link to Mapping Bedrock Agent Trace Data to MLflow Span Objects" translate=no>​</a></h3>
<p>In this step, we need to iterate over the data that is returned within the bedrock agent's response trace
to provide relevant mappings to create the MLflow span object.
AWS Bedrock agent's response is a flat list with trace events connected by <code>traceId</code>.
Here is the raw trace sent in the bedrock agent's response:</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed=true><summary>Expand to see AWS Bedrock agent's raw trace</summary><div><div class=collapsibleContent_i85q><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token plain">[</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    'trace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentAliasId': '3WHEEJKNUT',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentId': 'O9KQSEVEFF',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentVersion': '1',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'event_order': 0,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'sessionId': '9566a6d78551434fb0409578ffed63c1',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'trace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'preProcessingTrace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'modelInvocationInput': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'inferenceConfiguration': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">              ...</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'text': '\n\nHuman: You are a classifying agent that filters user inputs into categories. Your job is to sort these inputs before they...&lt;thinking> XML tags before providing only the category letter to sort the input into within &lt;category> XML tags.\n\nAssistant:',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'traceId': 'ca9880a2-dae7-46ac-a480-f38ca7e2d99f-pre-0',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'type': 'PRE_PROCESSING'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    'trace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentAliasId': '3WHEEJKNUT',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentId': 'O9KQSEVEFF',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentVersion': '1',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'event_order': 1,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'sessionId': '9566a6d78551434fb0409578ffed63c1',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'trace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'preProcessingTrace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'modelInvocationOutput': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'parsedResponse': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">              ...</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'traceId': 'ca9880a2-dae7-46ac-a480-f38ca7e2d99f-pre-0'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    'trace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentAliasId': '3WHEEJKNUT',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentId': 'O9KQSEVEFF',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentVersion': '1',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'event_order': 2,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'sessionId': '9566a6d78551434fb0409578ffed63c1',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'trace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'orchestrationTrace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'modelInvocationInput': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'inferenceConfiguration': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">              ...</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'text': '\n\nHuman:\nYou are a research assistant AI that has been equipped with one or more functions to help you answer a &lt;question>...\n\nAssistant: &lt;scratchpad> I understand I cannot use functions that have not been provided to me to answer this question.\n\n',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'traceId': 'ca9880a2-dae7-46ac-a480-f38ca7e2d99f-0',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'type': 'ORCHESTRATION'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    'trace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentAliasId': '3WHEEJKNUT',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentId': 'O9KQSEVEFF',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentVersion': '1',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'event_order': 3,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'sessionId': '9566a6d78551434fb0409578ffed63c1',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'trace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'orchestrationTrace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'modelInvocationOutput': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'metadata': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">              ...</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'rawResponse': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">              ...</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'traceId': 'ca9880a2-dae7-46ac-a480-f38ca7e2d99f-0'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    'trace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentAliasId': '3WHEEJKNUT',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentId': 'O9KQSEVEFF',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentVersion': '1',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'event_order': 4,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'sessionId': '9566a6d78551434fb0409578ffed63c1',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'trace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'orchestrationTrace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'rationale': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'text': 'To answer this question about the next Mars launch window, I will:\n\n1. Call the GET::optimal_departure_window_mars::getNext...lse values.\n\nI have verified that I have access to the GET::optimal_departure_window_mars::getNextMarsLaunchWindow function.',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'traceId': 'ca9880a2-dae7-46ac-a480-f38ca7e2d99f-0'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    'trace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentAliasId': '3WHEEJKNUT',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentId': 'O9KQSEVEFF',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentVersion': '1',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'event_order': 5,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'sessionId': '9566a6d78551434fb0409578ffed63c1',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'trace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'orchestrationTrace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'invocationInput': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'actionGroupInvocationInput': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">              ...</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'invocationType': 'ACTION_GROUP',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'traceId': 'ca9880a2-dae7-46ac-a480-f38ca7e2d99f-0'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    'trace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentAliasId': '3WHEEJKNUT',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentId': 'O9KQSEVEFF',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentVersion': '1',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'event_order': 6,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'sessionId': '9566a6d78551434fb0409578ffed63c1',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'trace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'orchestrationTrace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'observation': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'actionGroupInvocationOutput': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">              ...</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'traceId': 'ca9880a2-dae7-46ac-a480-f38ca7e2d99f-0',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'type': 'ACTION_GROUP'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    'trace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentAliasId': '3WHEEJKNUT',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentId': 'O9KQSEVEFF',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentVersion': '1',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'event_order': 7,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'sessionId': '9566a6d78551434fb0409578ffed63c1',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'trace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'orchestrationTrace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'modelInvocationInput': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'inferenceConfiguration': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">              ...</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'text': '\n\nHuman:\nYou are a research assistant AI that has been equipped with one or more functions to help you answer a &lt;question>...lta_v_available_m_s": 39457.985759929674, "delta_v_required_m_s": 5595.997417810693, "is_feasible": true}}&lt;/function_result>\n',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'traceId': 'ca9880a2-dae7-46ac-a480-f38ca7e2d99f-1',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'type': 'ORCHESTRATION'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    'trace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentAliasId': '3WHEEJKNUT',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentId': 'O9KQSEVEFF',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentVersion': '1',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'event_order': 8,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'sessionId': '9566a6d78551434fb0409578ffed63c1',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'trace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'orchestrationTrace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'modelInvocationOutput': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'metadata': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">              ...</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'rawResponse': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">              ...</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'traceId': 'ca9880a2-dae7-46ac-a480-f38ca7e2d99f-1'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    'trace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentAliasId': '3WHEEJKNUT',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentId': 'O9KQSEVEFF',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'agentVersion': '1',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'event_order': 9,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'sessionId': '9566a6d78551434fb0409578ffed63c1',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'trace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'orchestrationTrace': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'observation': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'finalResponse': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">              ...</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'traceId': 'ca9880a2-dae7-46ac-a480-f38ca7e2d99f-1',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'type': 'FINISH'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    'chunk': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'bytes': b</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'Based on the provided spacecraft dry mass of 10000 kg, total mass of 50000 kg, and specific impulse of 2500 s, the next optimal launch window for a Hohmann transfer from Earth to Mars is on November 26, 2026 UTC. The transfer will take 259 days.'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">]</span><br/></span></code></pre></div></div></div></div></details>
<p>To fit this structure into MLflow's span, we first need to go through the raw response trace and group events by their <code>traceId</code>.
After grouping the trace events by <em><code>traceId</code></em>, the structure looks like this:</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed=true><summary>Expand to see trace grouped by <em><code>traceId</code></em></summary><div><div class=collapsibleContent_i85q><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token plain">{</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  'ca9880a2-dae7-46ac-a480-f38ca7e2d99f-0': [</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'data': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'inferenceConfiguration': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'maximumLength': 2048,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'stopSequences': [</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            '&lt;/function_call>',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            '&lt;/answer>',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            '&lt;/error>'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          ],</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'temperature': 0.0,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'topK': 250,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'topP': 1.0</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'text': '\n\nHuman:\nYou are a research assistant AI that has been equipped with one or more functions to help you answer a &lt;question>...\n\nAssistant: &lt;scratchpad> I understand I cannot use functions that have not been provided to me to answer this question.\n\n',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'traceId': 'ca9880a2-dae7-46ac-a480-f38ca7e2d99f-0',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'type': 'ORCHESTRATION'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'event_order': 2,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'type': 'modelInvocationInput'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'data': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'metadata': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'usage': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'inputTokens': 5160,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'outputTokens': 135</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'rawResponse': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'content': 'To answer this question about the next Mars launch window, I will:\n\n1. Call the GET::optimal_departure_window_mars::getNext...l>\nGET::optimal_departure_window_mars::getNextMarsLaunchWindow(specific_impulse="2500", dry_mass="10000", total_mass="50000")'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'traceId': 'ca9880a2-dae7-46ac-a480-f38ca7e2d99f-0'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'event_order': 3,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'type': 'modelInvocationOutput'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'data': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'text': 'To answer this question about the next Mars launch window, I will:\n\n1. Call the GET::optimal_departure_window_mars::getNext...lse values.\n\nI have verified that I have access to the GET::optimal_departure_window_mars::getNextMarsLaunchWindow function.',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'traceId': 'ca9880a2-dae7-46ac-a480-f38ca7e2d99f-0'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'event_order': 4,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'type': 'rationale'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'data': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'actionGroupInvocationInput': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'actionGroupName': 'optimal_departure_window_mars',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'apiPath': '/get-next-mars-launch-window',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'executionType': 'LAMBDA',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'parameters': [</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">              ...</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">              ...</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">              ...</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          ],</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'verb': 'get'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'invocationType': 'ACTION_GROUP',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'traceId': 'ca9880a2-dae7-46ac-a480-f38ca7e2d99f-0'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'event_order': 5,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'type': 'invocationInput'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'data': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'actionGroupInvocationOutput': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'text': '{"next_launch_window": {"next_launch_date": "2026-11-26 00:00:00", "synodic_period_days": 779.9068939794238, "transfer_time_days": 259, "delta_v_available_m_s": 39457.985759929674, "delta_v_required_m_s": 5595.997417810693, "is_feasible": true}}'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'traceId': 'ca9880a2-dae7-46ac-a480-f38ca7e2d99f-0',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'type': 'ACTION_GROUP'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'event_order': 6,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'type': 'observation'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  ],</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  'ca9880a2-dae7-46ac-a480-f38ca7e2d99f-1': [</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'data': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'inferenceConfiguration': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'maximumLength': 2048,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'stopSequences': [</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            '&lt;/function_call>',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            '&lt;/answer>',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            '&lt;/error>'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          ],</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'temperature': 0.0,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'topK': 250,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'topP': 1.0</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'text': '\n\nHuman:\nYou are a research assistant AI that has been equipped with one or more functions to help you answer a &lt;question>...lta_v_available_m_s": 39457.985759929674, "delta_v_required_m_s": 5595.997417810693, "is_feasible": true}}&lt;/function_result>\n',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'traceId': 'ca9880a2-dae7-46ac-a480-f38ca7e2d99f-1',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'type': 'ORCHESTRATION'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'event_order': 7,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'type': 'modelInvocationInput'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'data': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'metadata': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'usage': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'inputTokens': 5405,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            'outputTokens': 64</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'rawResponse': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'content': '&lt;answer>\nBased on the provided spacecraft dry mass of 10000 kg, total mass of 50000 kg, and specific impulse of 2500 s, the ... optimal launch window for a Hohmann transfer from Earth to Mars is on November 26, 2026 UTC. The transfer will take 259 days.'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'traceId': 'ca9880a2-dae7-46ac-a480-f38ca7e2d99f-1'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'event_order': 8,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'type': 'modelInvocationOutput'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'data': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'finalResponse': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'text': 'Based on the provided spacecraft dry mass of 10000 kg, total mass of 50000 kg, and specific impulse of 2500 s, the next optimal launch window for a Hohmann transfer from Earth to Mars is on November 26, 2026 UTC. The transfer will take 259 days.'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'traceId': 'ca9880a2-dae7-46ac-a480-f38ca7e2d99f-1',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'type': 'FINISH'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'event_order': 9,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'type': 'observation'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  ],</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  'ca9880a2-dae7-46ac-a480-f38ca7e2d99f-pre-0': [</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'data': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'inferenceConfiguration': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'maximumLength': 2048,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'stopSequences': [</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            '\n\nHuman:'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          ],</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'temperature': 0.0,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'topK': 250,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'topP': 1.0</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'text': '\n\nHuman: You are a classifying agent that filters user inputs into categories. Your job is to sort these inputs before they...&lt;thinking> XML tags before providing only the category letter to sort the input into within &lt;category> XML tags.\n\nAssistant:',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'traceId': 'ca9880a2-dae7-46ac-a480-f38ca7e2d99f-pre-0',</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'type': 'PRE_PROCESSING'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'event_order': 0,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'type': 'modelInvocationInput'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'data': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'parsedResponse': {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'isValid': True,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">          'rationale': 'Based on the provided instructions, this input appears to be a question about orbital mechanics that can be answered using th...equired arguments for that function - specific impulse, dry mass, and total mass. Therefore, this input should be sorted into:'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        'traceId': 'ca9880a2-dae7-46ac-a480-f38ca7e2d99f-pre-0'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'event_order': 1,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      'type': 'modelInvocationOutput'</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  ]</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">}</span><br/></span></code></pre></div></div></div></div></details>
<p>Each group of events with the same <em><code>traceId</code></em> will contain at least two events: one of type <em><code>modelInvocationInput</code></em> and
one of type <em><code>modelInvocationOutput</code></em>. Groups that involve action group traces will also include events of type
<em><code>actionGroupInvocationInput</code></em> and <em><code>actionGroupInvocationOutput</code></em>. Similarly, groups that use knowledge bases will have
additional events of type <em><code>knowledgeBaseLookupInput</code></em> and <em><code>knowledgeBaseLookupOutput</code></em>.
In the <em><code>BedrockModel</code></em> mentioned above, it implements an approach to parse these event groups into trace nodes.
This method allows the trace to display the reasoning behind selecting action groups/knowledge bases to answer queries and invoking
the corresponding Lambda function calls, as defined in our example OpenAPI spec above.
This structure helps to clearly show the flow of information and decision-making process that bedrock agent follows.</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed=true><summary>Here is the final mlflow trace</summary><div><div class=collapsibleContent_i85q><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token plain">{</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  "spans": [</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "name": "Bedrock Agent Runtime",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "context": {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "span_id": "0xb802165d133a33aa",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "trace_id": "0x9b8bd0b2e018d77f936e48a09e54fd44"</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "parent_id": null,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "start_time": 1731388531754725000,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "end_time": 1731388550226771000,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "status_code": "OK",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "status_message": "",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "attributes": {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "mlflow.traceRequestId": "\"1e036cc3a7f946ec995f7763b8dde51c\"",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "mlflow.spanType": "\"CHAT_MODEL\"",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "mlflow.spanFunctionName": "\"predict\"",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "mlflow.spanInputs": "{\"context\": \"&lt;mlflow.pyfunc.model.PythonModelContext object at 0x13397c530>\", \"messages\": [{\"role\": \"user\", \"content\": \"When is the next launch window for Mars? My spacecraft's total mass is 50000, dry mass is 10000 and specific impulse is 2500. Mass in Kg.\", \"name\": null}], \"params\": {\"temperature\": 1.0, \"max_tokens\": null, \"stop\": null, \"n\": 1, \"stream\": false, \"top_p\": null, \"top_k\": null, \"frequency_penalty\": null, \"presence_penalty\": null}}",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "mlflow.spanOutputs": "{\"choices\": [{\"index\": 0, \"message\": {\"role\": \"user\", \"content\": \"Based on the provided spacecraft dry mass of 10000 kg, total mass of 50000 kg, and specific impulse of 2500 s, the next optimal launch window for a Hohmann transfer from Earth to Mars is on November 26, 2026 UTC. The transfer will take 259 days.\", \"name\": null}, \"finish_reason\": \"stop\", \"logprobs\": null}], \"usage\": {\"prompt_tokens\": null, \"completion_tokens\": null, \"total_tokens\": null}, \"id\": null, \"model\": \"anthropic.claude-v2\", \"object\": \"chat.completion\", \"created\": 1731388550}"</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "events": []</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "name": "Bedrock Input Prompt",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "context": {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "span_id": "0x2e7cd730be70865b",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "trace_id": "0x9b8bd0b2e018d77f936e48a09e54fd44"</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "parent_id": "0xb802165d133a33aa",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "start_time": 1731388531755172000,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "end_time": 1731388531755252000,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "status_code": "OK",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "status_message": "",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "attributes": {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "mlflow.traceRequestId": "\"1e036cc3a7f946ec995f7763b8dde51c\"",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "mlflow.spanType": "\"UNKNOWN\"",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "mlflow.spanFunctionName": "\"_get_agent_prompt\"",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "mlflow.spanInputs": "{\"raw_input_question\": \"When is the next launch window for Mars? My spacecraft's total mass is 50000, dry mass is 10000 and specific impulse is 2500. Mass in Kg.\"}",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "mlflow.spanOutputs": "\"\\n        Answer the following question and pay strong attention to the prompt:\\n        &lt;question>\\n        When is the next launch window for Mars? My spacecraft's total mass is 50000, dry mass is 10000 and specific impulse is 2500. Mass in Kg.\\n        &lt;/question>\\n        &lt;instruction>\\n        You have functions available at your disposal to use when anwering any questions about orbital mechanics.if you can't find a function to answer a question about orbital mechanics, simply reply 'I do not know'\\n        &lt;/instruction>\\n        \""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "events": []</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "name": "ACTION GROUP DECISION -optimal_departure_window_mars",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "context": {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "span_id": "0x131e4e08cd5e95d9",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "trace_id": "0x9b8bd0b2e018d77f936e48a09e54fd44"</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "parent_id": "0xb802165d133a33aa",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "start_time": 1731388550223219000,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "end_time": 1731388550224592000,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "status_code": "OK",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "status_message": "",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "attributes": {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "mlflow.traceRequestId": "\"1e036cc3a7f946ec995f7763b8dde51c\"",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "mlflow.spanType": "\"UNKNOWN\"",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "trace_attributes": "[{\"type\": \"modelInvocationInput\", \"data\": {\"inferenceConfiguration\": {\"maximumLength\": 2048, \"stopSequences\": [\"&lt;/function_call>\", \"&lt;/answer>\", \"&lt;/error>\"], \"temperature\": 0.0, \"topK\": 250, \"topP\": 1.0}, \"text\": \"\\n\\nHuman:\\nYou are a research assistant AI that has been equipped with one or more functions to help you answer a &lt;question>. Your goal is to answer the user's question to the best of your ability, using the function(s) to gather more information if necessary to better answer the question. If you choose to call a function, the result of the function call will be added to the conversation history in &lt;function_results> tags (if the call succeeded) or &lt;error> tags (if the function failed). \\nYou were created with these instructions to consider as well:\\n&lt;auxiliary_instructions>\\n            You are a friendly chat bot. You have access to a function called that returns\\n            information about the Mars launch window. When responding with Mars launch window,\\n            please make sure to add the timezone UTC.\\n            &lt;/auxiliary_instructions>\\n\\nHere are some examples of correct action by other, different agents with access to functions that may or may not be similar to ones you are provided.\\n\\n&lt;examples>\\n    &lt;example_docstring> Here is an example of how you would correctly answer a question using a &lt;function_call> and the corresponding &lt;function_result>. Notice that you are free to think before deciding to make a &lt;function_call> in the &lt;scratchpad>.&lt;/example_docstring>\\n    &lt;example>\\n        &lt;functions>\\n            &lt;function>\\n                &lt;function_name>get::policyengineactions::getpolicyviolations&lt;/function_name>\\n                &lt;function_description>Returns a list of policy engine violations for the specified alias within the specified date range.&lt;/function_description>\\n                &lt;required_argument>alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument>\\n                &lt;required_argument>startDate (string): The start date of the range to filter violations. The format for startDate is MM/DD/YYYY.&lt;/required_argument>\\n                &lt;required_argument>endDate (string): The end date of the range to filter violations&lt;/required_argument>\\n                &lt;returns>array: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>post::policyengineactions::acknowledgeviolations&lt;/function_name>\\n                &lt;function_description>Acknowledge policy engine violation. Generally used to acknowledge violation, once user notices a violation under their alias or their managers alias.&lt;/function_description>\\n                &lt;required_argument>policyId (string): The ID of the policy violation&lt;/required_argument>\\n                &lt;required_argument>expectedDateOfResolution (string): The date by when the violation will be addressed/resolved&lt;/required_argument>\\n                &lt;returns>object: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>get::activedirectoryactions::getmanager&lt;/function_name>\\n                &lt;function_description>This API is used to identify the manager hierarchy above a given person. Every person could have a manager and the manager could have another manager to which they report to&lt;/function_description>\\n                &lt;required_argument>alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument>\\n                &lt;returns>object: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            \\n        &lt;/functions>\\n\\n        &lt;question>Can you show me my policy engine violation from 1st january 2023 to 1st february 2023? My alias is jsmith.&lt;/question>\\n        &lt;scratchpad>\\n            To answer this question, I will need to:\\n            1. I do not have knowledge to policy engine violations, so I should see if I can use any of the available functions to help. I have been equipped with get::policyengineactions::getpolicyviolations that gets the policy engine violations for a given alias, start date and end date. I will use this function to gather more information.\\n        &lt;/scratchpad>\\n        &lt;function_call>get::policyengineactions::getpolicyviolations(alias=\\\"jsmith\\\", startDate=\\\"1st January 2023\\\", endDate=\\\"1st February 2023\\\")&lt;/function_call>\\n        &lt;function_result>{response: [{creationDate: \\\"2023-06-01T09:30:00Z\\\", riskLevel: \\\"High\\\", policyId: \\\"POL-001\\\", policyUrl: \\\"https://example.com/policies/POL-001\\\", referenceUrl: \\\"https://example.com/violations/POL-001\\\"}, {creationDate: \\\"2023-06-02T14:45:00Z\\\", riskLevel: \\\"Medium\\\", policyId: \\\"POL-002\\\", policyUrl: \\\"https://example.com/policies/POL-002\\\", referenceUrl: \\\"https://example.com/violations/POL-002\\\"}]}&lt;/function_result>\\n        &lt;answer>The policy engine violations between 1st january 2023 to 1st february 2023 for alias jsmith are - Policy ID: POL-001, Policy ID: POL-002&lt;/answer>\\n    &lt;/example>\\n\\n    &lt;example_docstring>Here is another example that utilizes multiple function calls.&lt;/example_docstring>\\n    &lt;example>\\n        &lt;functions>\\n            &lt;function>\\n                &lt;function_name>get::policyengineactions::getpolicyviolations&lt;/function_name>\\n                &lt;function_description>Returns a list of policy engine violations for the specified alias within the specified date range.&lt;/function_description>\\n                &lt;required_argument>alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument>\\n                &lt;required_argument>startDate (string): The start date of the range to filter violations. The format for startDate is MM/DD/YYYY.&lt;/required_argument>\\n                &lt;required_argument>endDate (string): The end date of the range to filter violations&lt;/required_argument>\\n                &lt;returns>array: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>post::policyengineactions::acknowledgeviolations&lt;/function_name>\\n                &lt;function_description>Acknowledge policy engine violation. Generally used to acknowledge violation, once user notices a violation under their alias or their managers alias.&lt;/function_description>\\n                &lt;required_argument>policyId (string): The ID of the policy violation&lt;/required_argument>\\n                &lt;required_argument>expectedDateOfResolution (string): The date by when the violation will be addressed/resolved&lt;/required_argument>\\n                &lt;returns>object: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>get::activedirectoryactions::getmanager&lt;/function_name>\\n                &lt;function_description>This API is used to identify the manager hierarchy above a given person. Every person could have a manager and the manager could have another manager to which they report to&lt;/function_description>\\n                &lt;required_argument>alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument>\\n                &lt;returns>object: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            \\n        &lt;/functions>\\n        &lt;question>Can you check the policy engine violations under my manager between 2nd May to 5th May? My alias is john.&lt;/question>\\n        &lt;scratchpad>\\n            To answer this question, I will need to:\\n            1. Get the manager alias of the user using get::activedirectoryactions::getmanager function.\\n            2. Use the returned manager alias to get the policy engine violations using the get::policyengineactions::getpolicyviolations function.\\n\\n            I have double checked and made sure that I have been provided the get::activedirectoryactions::getmanager and the get::policyengineactions::getpolicyviolations functions.\\n        &lt;/scratchpad>\\n        &lt;function_call>get::activedirectoryactions::getmanager(alias=\\\"john\\\")&lt;/function_call>\\n        &lt;function_result>{response: {managerAlias: \\\"mark\\\", managerLevel: \\\"6\\\", teamName: \\\"Builder\\\", managerName: \\\"Mark Hunter\\\"}}}}&lt;/function_result>\\n        &lt;scratchpad>\\n            1. I have the managerAlias from the function results as mark and I have the start and end date from the user input. I can use the function result to call get::policyengineactions::getpolicyviolations function.\\n            2. I will then return the get::policyengineactions::getpolicyviolations function result to the user.\\n\\n            I have double checked and made sure that I have been provided the get::policyengineactions::getpolicyviolations functions.\\n        &lt;/scratchpad>\\n        &lt;function_call>get::policyengineactions::getpolicyviolations(alias=\\\"mark\\\", startDate=\\\"2nd May 2023\\\", endDate=\\\"5th May 2023\\\")&lt;/function_call>\\n        &lt;function_result>{response: [{creationDate: \\\"2023-05-02T09:30:00Z\\\", riskLevel: \\\"High\\\", policyId: \\\"POL-001\\\", policyUrl: \\\"https://example.com/policies/POL-001\\\", referenceUrl: \\\"https://example.com/violations/POL-001\\\"}, {creationDate: \\\"2023-05-04T14:45:00Z\\\", riskLevel: \\\"Low\\\", policyId: \\\"POL-002\\\", policyUrl: \\\"https://example.com/policies/POL-002\\\", referenceUrl: \\\"https://example.com/violations/POL-002\\\"}]}&lt;/function_result>\\n        &lt;answer>\\n            The policy engine violations between 2nd May 2023 to 5th May 2023 for your manager's alias mark are - Policy ID: POL-001, Policy ID: POL-002\\n        &lt;/answer>\\n    &lt;/example>\\n\\n    &lt;example_docstring>Functions can also be search engine API's that issue a query to a knowledge base. Here is an example that utilizes regular function calls in combination with function calls to a search engine API. Please make sure to extract the source for the information within the final answer when using information returned from the search engine.&lt;/example_docstring>\\n    &lt;example>\\n        &lt;functions>\\n            &lt;function>\\n                &lt;function_name>get::benefitsaction::getbenefitplanname&lt;/function_name>\\n                &lt;function_description>Get's the benefit plan name for a user. The API takes in a userName and a benefit type and returns the benefit name to the user (i.e. Aetna, Premera, Fidelity, etc.).&lt;/function_description>\\n                &lt;optional_argument>userName (string): None&lt;/optional_argument>\\n                &lt;optional_argument>benefitType (string): None&lt;/optional_argument>\\n                &lt;returns>object: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>post::benefitsaction::increase401klimit&lt;/function_name>\\n                &lt;function_description>Increases the 401k limit for a generic user. The API takes in only the current 401k limit and returns the new limit.&lt;/function_description>\\n                &lt;optional_argument>currentLimit (string): None&lt;/optional_argument>\\n                &lt;returns>object: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>get::x_amz_knowledgebase_dentalinsurance::search&lt;/function_name>\\n                &lt;function_description>This is a search tool that provides information about Delta Dental benefits. It has information about covered dental benefits and other relevant information&lt;/function_description>\\n                &lt;required_argument>query(string): A full sentence query that is fed to the search tool&lt;/required_argument>\\n                &lt;returns>Returns string  related to the user query asked.&lt;/returns>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>get::x_amz_knowledgebase_401kplan::search&lt;/function_name>\\n                &lt;function_description>This is a search tool that provides information about Amazon 401k plan benefits. It can determine what a person's yearly 401k contribution limit is, based on their age.&lt;/function_description>\\n                &lt;required_argument>query(string): A full sentence query that is fed to the search tool&lt;/required_argument>\\n                &lt;returns>Returns string  related to the user query asked.&lt;/returns>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>get::x_amz_knowledgebase_healthinsurance::search&lt;/function_name>\\n                &lt;function_description>This is a search tool that provides information about Aetna and Premera health benefits. It has information about the savings plan and shared deductible plan, as well as others.&lt;/function_description>\\n                &lt;required_argument>query(string): A full sentence query that is fed to the search tool&lt;/required_argument>\\n                &lt;returns>Returns string  related to the user query asked.&lt;/returns>\\n            &lt;/function>\\n            \\n        &lt;/functions>\\n\\n        &lt;question>What is my deductible? My username is Bob and my benefitType is Dental. Also, what is the 401k yearly contribution limit?&lt;/question>\\n        &lt;scratchpad> I understand I cannot use functions that have not been provided to me to answer this question.\\n            To answer this question, I will:\\n            1. Call the get::benefitsaction::getbenefitplanname function to get the benefit plan name for the user Bob with benefit type Dental.\\n            2. Call the get::x_amz_knowledgebase_dentalinsurance::search function to search for information about deductibles for the plan name returned from step 1.\\n            3. Call the get::x_amz_knowledgebase_401k::search function to search for information about 401k yearly contribution limits.\\n            4. Return the deductible information from the search results to the user.\\n            I have checked that I have access to the get::benefitsaction::getbenefitplanname, x_amz_knowledgebase_dentalinsurance::search, and x_amz_knowledgebase_401k::search functions.\\n        &lt;/scratchpad>\\n        &lt;function_call>get::benefitsaction::getbenefitplanname(userName=\\\"Bob\\\", benefitType=\\\"Dental\\\")&lt;/function_call>\\n        &lt;function_result>{{'response': {{'planName': 'Delta Dental'}}}}&lt;/function_result>\\n        &lt;scratchpad>\\n            I have received the plan name Delta Dental for the user Bob with Dental benefits. I will now call the x_amz_knowledgebase_dentalinsurance::search function to find deductible information for Delta Dental.\\n        &lt;/scratchpad>\\n        &lt;function_call>get::x_amz_knowledgebase_dentalinsurance::search(searchQuery=\\\"What is the deductible for Delta Dental?\\\")&lt;/function_call>\\n        &lt;function_result>{{'response': {{'responseCode': '200', 'responseBody': \\\"\\\"&lt;answer>\\\\n&lt;answer_part>\\\\n&lt;text>The user's individual deductible is $50 per benefit period&lt;/text>\\\\n&lt;source>dfe040f8-46ed-4a65-b3ea-529fa55f6b9e&lt;/source>\\\\n&lt;/answer_part>\\\\n&lt;answer_part>\\\\n&lt;text>If they are enrolled with dependents, the maximum family deductible is $150 per benefit period.&lt;/text>\\\\n&lt;source>0e666064-31d8-4223-b7ba-8eecf40b7b47&lt;/source>\\\\n&lt;/answer_part>\\\\n&lt;/answer>\\\"}}}}&lt;/function_result> &lt;scratchpad>\\n            I have found the deductible information for Dental benefits. I will now call the x_amz_knowledgebase_401k::search function to find yearly 401k contribution limits.\\n        &lt;/scratchpad>\\n        &lt;function_call>get::x_amz_knowledgebase_401k::search(searchQuery=\\\"What is the yearly 401k contribution limit?\\\")&lt;/function_call>\\n        &lt;function_result>{{'response': {{'responseCode': '200', 'responseBody': \\\"&lt;answer>\\\\n&lt;answer_part>\\\\n&lt;text>The yearly 401k contribution limit is $20,500.&lt;/text>\\\\n&lt;source>c546cbe8-07f6-45d1-90ca-74d87ab2885a&lt;/source>\\\\n&lt;/answer_part>\\\\n&lt;/answer>\\\"}}}}&lt;/function_result>\\n        &lt;answer>\\n            &lt;answer_part>\\n                &lt;text>The deductible for your Delta Dental plan is $50 per benefit period.&lt;/text>\\n                &lt;source>dfe040f8-46ed-4a65-b3ea-529fa55f6b9e&lt;/source>\\n            &lt;/answer_part>\\n            &lt;answer_part>\\n                &lt;text>If you have dependents enrolled, the maximum family deductible is $150 per benefit period.&lt;/text>\\n                &lt;source>0e666064-31d8-4223-b7ba-8eecf40b7b47&lt;/source>\\n            &lt;/answer_part>\\n            &lt;answer_part>\\n                &lt;text>The yearly 401k contribution limit is $20,500.&lt;/text>\\n                &lt;source>c546cbe8-07f6-45d1-90ca-74d87ab2885a&lt;/source>\\n            &lt;/answer_part>\\n        &lt;/answer>\\n    &lt;/example>\\n\\n    \\n\\n    &lt;example_docstring>Here's a final example where the question asked could not be answered with information gathered from calling the provided functions. In this example, notice how you respond by telling the user you cannot answer, without using a function that was not provided to you.&lt;/example_docstring>\\n    &lt;example>\\n        &lt;functions>\\n            &lt;function>\\n                &lt;function_name>get::policyengineactions::getpolicyviolations&lt;/function_name>\\n                &lt;function_description>Returns a list of policy engine violations for the specified alias within the specified date range.&lt;/function_description>\\n                &lt;required_argument>alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument>\\n                &lt;required_argument>startDate (string): The start date of the range to filter violations. The format for startDate is MM/DD/YYYY.&lt;/required_argument>\\n                &lt;required_argument>endDate (string): The end date of the range to filter violations&lt;/required_argument>\\n                &lt;returns>array: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>post::policyengineactions::acknowledgeviolations&lt;/function_name>\\n                &lt;function_description>Acknowledge policy engine violation. Generally used to acknowledge violation, once user notices a violation under their alias or their managers alias.&lt;/function_description>\\n                &lt;required_argument>policyId (string): The ID of the policy violation&lt;/required_argument>\\n                &lt;required_argument>expectedDateOfResolution (string): The date by when the violation will be addressed/resolved&lt;/required_argument>\\n                &lt;returns>object: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>get::activedirectoryactions::getmanager&lt;/function_name>\\n                &lt;function_description>This API is used to identify the manager hierarchy above a given person. Every person could have a manager and the manager could have another manager to which they report to&lt;/function_description>\\n                &lt;required_argument>alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument>\\n                &lt;returns>object: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            \\n        &lt;/functions>\\n        &lt;question>Who are the reportees of David?&lt;/question>\\n        &lt;scratchpad>\\n            After reviewing the functions I was equipped with, I realize I am not able to accurately answer this question since I can't access reportees of David. Therefore, I should explain to the user I cannot answer this question.\\n        &lt;/scratchpad>\\n        &lt;answer>\\n            Sorry, I am unable to assist you with this request.\\n        &lt;/answer>\\n    &lt;/example>\\n&lt;/examples>\\n\\nThe above examples have been provided to you to illustrate general guidelines and format for use of function calling for information retrieval, and how to use your scratchpad to plan your approach. IMPORTANT: the functions provided within the examples should not be assumed to have been provided to you to use UNLESS they are also explicitly given to you within &lt;functions>&lt;/functions> tags below. All of the values and information within the examples (the questions, function results, and answers) are strictly part of the examples and have not been provided to you.\\n\\nNow that you have read and understood the examples, I will define the functions that you have available to you to use. Here is a comprehensive list.\\n\\n&lt;functions>\\n&lt;function>\\n&lt;function_name>GET::optimal_departure_window_mars::getNextMarsLaunchWindow&lt;/function_name>\\n&lt;function_description>Gets the next optimal launch window to Mars.&lt;/function_description>\\n&lt;required_argument>specific_impulse (string): Specific impulse of the propulsion system (s).&lt;/required_argument>\\n&lt;required_argument>dry_mass (string): Mass of the spacecraft without fuel (kg).&lt;/required_argument>\\n&lt;required_argument>total_mass (string): Total mass of the spacecraft including fuel (kg)&lt;/required_argument>\\n&lt;returns>object: The next optimal departure date for a Hohmann transfer from Earth to Mars, based on the spacecraft's mass and specific impulse.&lt;/returns>\\n&lt;/function>\\n\\n\\n&lt;/functions>\\n\\nNote that the function arguments have been listed in the order that they should be passed into the function.\\n\\n\\n\\nDo not modify or extend the provided functions under any circumstances. For example, GET::optimal_departure_window_mars::getNextMarsLaunchWindow with additional parameters would be considered modifying the function which is not allowed. Please use the functions only as defined.\\n\\nDO NOT use any functions that I have not equipped you with.\\n\\n Do not make assumptions about inputs; instead, make sure you know the exact function and input to use before you call a function.\\n\\nTo call a function, output the name of the function in between &lt;function_call> and &lt;/function_call> tags. You will receive a &lt;function_result> in response to your call that contains information that you can use to better answer the question. Or, if the function call produced an error, you will receive an &lt;error> in response.\\n\\n\\n\\nThe format for all other &lt;function_call> MUST be: &lt;function_call>$FUNCTION_NAME($FUNCTION_PARAMETER_NAME=$FUNCTION_PARAMETER_VALUE)&lt;/function_call>\\n\\nRemember, your goal is to answer the user's question to the best of your ability, using only the function(s) provided within the &lt;functions>&lt;/functions> tags to gather more information if necessary to better answer the question.\\n\\nDo not modify or extend the provided functions under any circumstances. For example, calling GET::optimal_departure_window_mars::getNextMarsLaunchWindow with additional parameters would be modifying the function which is not allowed. Please use the functions only as defined.\\n\\nBefore calling any functions, create a plan for performing actions to answer this question within the &lt;scratchpad>. Double check your plan to make sure you don't call any functions that you haven't been provided with. Always return your final answer within &lt;answer>&lt;/answer> tags.\\n\\n\\n\\nThe user input is &lt;question>Answer the following question and pay strong attention to the prompt:\\n        &lt;question>\\n        When is the next launch window for Mars? My spacecraft's total mass is 50000, dry mass is 10000 and specific impulse is 2500. Mass in Kg.\\n        &lt;/question>\\n        &lt;instruction>\\n        You have functions available at your disposal to use when anwering any questions about orbital mechanics.if you can't find a function to answer a question about orbital mechanics, simply reply 'I do not know'\\n        &lt;/instruction>&lt;/question>\\n\\n\\nAssistant: &lt;scratchpad> I understand I cannot use functions that have not been provided to me to answer this question.\\n\\n\", \"traceId\": \"e0b2b2c2-fb7c-4e17-8a1f-a3781100face-0\", \"type\": \"ORCHESTRATION\"}, \"event_order\": 2}, {\"type\": \"modelInvocationOutput\", \"data\": {\"metadata\": {\"usage\": {\"inputTokens\": 5160, \"outputTokens\": 135}}, \"rawResponse\": {\"content\": \"To answer this question about the next Mars launch window, I will:\\n\\n1. Call the GET::optimal_departure_window_mars::getNextMarsLaunchWindow function to get the next optimal launch window, passing in the provided spacecraft mass and specific impulse values.\\n\\nI have verified that I have access to the GET::optimal_departure_window_mars::getNextMarsLaunchWindow function.\\n\\n&lt;/scratchpad>\\n\\n&lt;function_call>\\nGET::optimal_departure_window_mars::getNextMarsLaunchWindow(specific_impulse=\\\"2500\\\", dry_mass=\\\"10000\\\", total_mass=\\\"50000\\\")\"}, \"traceId\": \"e0b2b2c2-fb7c-4e17-8a1f-a3781100face-0\"}, \"event_order\": 3}, {\"type\": \"rationale\", \"data\": {\"text\": \"To answer this question about the next Mars launch window, I will:\\n\\n1. Call the GET::optimal_departure_window_mars::getNextMarsLaunchWindow function to get the next optimal launch window, passing in the provided spacecraft mass and specific impulse values.\\n\\nI have verified that I have access to the GET::optimal_departure_window_mars::getNextMarsLaunchWindow function.\", \"traceId\": \"e0b2b2c2-fb7c-4e17-8a1f-a3781100face-0\"}, \"event_order\": 4}, {\"type\": \"invocationInput\", \"data\": {\"actionGroupInvocationInput\": {\"actionGroupName\": \"optimal_departure_window_mars\", \"apiPath\": \"/get-next-mars-launch-window\", \"executionType\": \"LAMBDA\", \"parameters\": [{\"name\": \"total_mass\", \"type\": \"string\", \"value\": \"50000\"}, {\"name\": \"dry_mass\", \"type\": \"string\", \"value\": \"10000\"}, {\"name\": \"specific_impulse\", \"type\": \"string\", \"value\": \"2500\"}], \"verb\": \"get\"}, \"invocationType\": \"ACTION_GROUP\", \"traceId\": \"e0b2b2c2-fb7c-4e17-8a1f-a3781100face-0\"}, \"event_order\": 5}, {\"type\": \"observation\", \"data\": {\"actionGroupInvocationOutput\": {\"text\": \"{\\\"next_launch_window\\\": {\\\"next_launch_date\\\": \\\"2026-11-26 00:00:00\\\", \\\"synodic_period_days\\\": 779.9068939794238, \\\"transfer_time_days\\\": 259, \\\"delta_v_available_m_s\\\": 39457.985759929674, \\\"delta_v_required_m_s\\\": 5595.997417810693, \\\"is_feasible\\\": true}}\"}, \"traceId\": \"e0b2b2c2-fb7c-4e17-8a1f-a3781100face-0\", \"type\": \"ACTION_GROUP\"}, \"event_order\": 6}]",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "mlflow.spanFunctionName": "\"_trace_agent_pre_context\"",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "mlflow.spanInputs": "{\"inner_input_trace\": \"\\n\\nHuman:\\nYou are a research assistant AI that has been equipped with one or more functions to help you answer a &lt;question>. Your goal is to answer the user's question to the best of your ability, using the function(s) to gather more information if necessary to better answer the question. If you choose to call a function, the result of the function call will be added to the conversation history in &lt;function_results> tags (if the call succeeded) or &lt;error> tags (if the function failed). \\nYou were created with these instructions to consider as well:\\n&lt;auxiliary_instructions>\\n            You are a friendly chat bot. You have access to a function called that returns\\n            information about the Mars launch window. When responding with Mars launch window,\\n            please make sure to add the timezone UTC.\\n            &lt;/auxiliary_instructions>\\n\\nHere are some examples of correct action by other, different agents with access to functions that may or may not be similar to ones you are provided.\\n\\n&lt;examples>\\n    &lt;example_docstring> Here is an example of how you would correctly answer a question using a &lt;function_call> and the corresponding &lt;function_result>. Notice that you are free to think before deciding to make a &lt;function_call> in the &lt;scratchpad>.&lt;/example_docstring>\\n    &lt;example>\\n        &lt;functions>\\n            &lt;function>\\n                &lt;function_name>get::policyengineactions::getpolicyviolations&lt;/function_name>\\n                &lt;function_description>Returns a list of policy engine violations for the specified alias within the specified date range.&lt;/function_description>\\n                &lt;required_argument>alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument>\\n                &lt;required_argument>startDate (string): The start date of the range to filter violations. The format for startDate is MM/DD/YYYY.&lt;/required_argument>\\n                &lt;required_argument>endDate (string): The end date of the range to filter violations&lt;/required_argument>\\n                &lt;returns>array: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>post::policyengineactions::acknowledgeviolations&lt;/function_name>\\n                &lt;function_description>Acknowledge policy engine violation. Generally used to acknowledge violation, once user notices a violation under their alias or their managers alias.&lt;/function_description>\\n                &lt;required_argument>policyId (string): The ID of the policy violation&lt;/required_argument>\\n                &lt;required_argument>expectedDateOfResolution (string): The date by when the violation will be addressed/resolved&lt;/required_argument>\\n                &lt;returns>object: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>get::activedirectoryactions::getmanager&lt;/function_name>\\n                &lt;function_description>This API is used to identify the manager hierarchy above a given person. Every person could have a manager and the manager could have another manager to which they report to&lt;/function_description>\\n                &lt;required_argument>alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument>\\n                &lt;returns>object: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            \\n        &lt;/functions>\\n\\n        &lt;question>Can you show me my policy engine violation from 1st january 2023 to 1st february 2023? My alias is jsmith.&lt;/question>\\n        &lt;scratchpad>\\n            To answer this question, I will need to:\\n            1. I do not have knowledge to policy engine violations, so I should see if I can use any of the available functions to help. I have been equipped with get::policyengineactions::getpolicyviolations that gets the policy engine violations for a given alias, start date and end date. I will use this function to gather more information.\\n        &lt;/scratchpad>\\n        &lt;function_call>get::policyengineactions::getpolicyviolations(alias=\\\"jsmith\\\", startDate=\\\"1st January 2023\\\", endDate=\\\"1st February 2023\\\")&lt;/function_call>\\n        &lt;function_result>{response: [{creationDate: \\\"2023-06-01T09:30:00Z\\\", riskLevel: \\\"High\\\", policyId: \\\"POL-001\\\", policyUrl: \\\"https://example.com/policies/POL-001\\\", referenceUrl: \\\"https://example.com/violations/POL-001\\\"}, {creationDate: \\\"2023-06-02T14:45:00Z\\\", riskLevel: \\\"Medium\\\", policyId: \\\"POL-002\\\", policyUrl: \\\"https://example.com/policies/POL-002\\\", referenceUrl: \\\"https://example.com/violations/POL-002\\\"}]}&lt;/function_result>\\n        &lt;answer>The policy engine violations between 1st january 2023 to 1st february 2023 for alias jsmith are - Policy ID: POL-001, Policy ID: POL-002&lt;/answer>\\n    &lt;/example>\\n\\n    &lt;example_docstring>Here is another example that utilizes multiple function calls.&lt;/example_docstring>\\n    &lt;example>\\n        &lt;functions>\\n            &lt;function>\\n                &lt;function_name>get::policyengineactions::getpolicyviolations&lt;/function_name>\\n                &lt;function_description>Returns a list of policy engine violations for the specified alias within the specified date range.&lt;/function_description>\\n                &lt;required_argument>alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument>\\n                &lt;required_argument>startDate (string): The start date of the range to filter violations. The format for startDate is MM/DD/YYYY.&lt;/required_argument>\\n                &lt;required_argument>endDate (string): The end date of the range to filter violations&lt;/required_argument>\\n                &lt;returns>array: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>post::policyengineactions::acknowledgeviolations&lt;/function_name>\\n                &lt;function_description>Acknowledge policy engine violation. Generally used to acknowledge violation, once user notices a violation under their alias or their managers alias.&lt;/function_description>\\n                &lt;required_argument>policyId (string): The ID of the policy violation&lt;/required_argument>\\n                &lt;required_argument>expectedDateOfResolution (string): The date by when the violation will be addressed/resolved&lt;/required_argument>\\n                &lt;returns>object: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>get::activedirectoryactions::getmanager&lt;/function_name>\\n                &lt;function_description>This API is used to identify the manager hierarchy above a given person. Every person could have a manager and the manager could have another manager to which they report to&lt;/function_description>\\n                &lt;required_argument>alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument>\\n                &lt;returns>object: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            \\n        &lt;/functions>\\n        &lt;question>Can you check the policy engine violations under my manager between 2nd May to 5th May? My alias is john.&lt;/question>\\n        &lt;scratchpad>\\n            To answer this question, I will need to:\\n            1. Get the manager alias of the user using get::activedirectoryactions::getmanager function.\\n            2. Use the returned manager alias to get the policy engine violations using the get::policyengineactions::getpolicyviolations function.\\n\\n            I have double checked and made sure that I have been provided the get::activedirectoryactions::getmanager and the get::policyengineactions::getpolicyviolations functions.\\n        &lt;/scratchpad>\\n        &lt;function_call>get::activedirectoryactions::getmanager(alias=\\\"john\\\")&lt;/function_call>\\n        &lt;function_result>{response: {managerAlias: \\\"mark\\\", managerLevel: \\\"6\\\", teamName: \\\"Builder\\\", managerName: \\\"Mark Hunter\\\"}}}}&lt;/function_result>\\n        &lt;scratchpad>\\n            1. I have the managerAlias from the function results as mark and I have the start and end date from the user input. I can use the function result to call get::policyengineactions::getpolicyviolations function.\\n            2. I will then return the get::policyengineactions::getpolicyviolations function result to the user.\\n\\n            I have double checked and made sure that I have been provided the get::policyengineactions::getpolicyviolations functions.\\n        &lt;/scratchpad>\\n        &lt;function_call>get::policyengineactions::getpolicyviolations(alias=\\\"mark\\\", startDate=\\\"2nd May 2023\\\", endDate=\\\"5th May 2023\\\")&lt;/function_call>\\n        &lt;function_result>{response: [{creationDate: \\\"2023-05-02T09:30:00Z\\\", riskLevel: \\\"High\\\", policyId: \\\"POL-001\\\", policyUrl: \\\"https://example.com/policies/POL-001\\\", referenceUrl: \\\"https://example.com/violations/POL-001\\\"}, {creationDate: \\\"2023-05-04T14:45:00Z\\\", riskLevel: \\\"Low\\\", policyId: \\\"POL-002\\\", policyUrl: \\\"https://example.com/policies/POL-002\\\", referenceUrl: \\\"https://example.com/violations/POL-002\\\"}]}&lt;/function_result>\\n        &lt;answer>\\n            The policy engine violations between 2nd May 2023 to 5th May 2023 for your manager's alias mark are - Policy ID: POL-001, Policy ID: POL-002\\n        &lt;/answer>\\n    &lt;/example>\\n\\n    &lt;example_docstring>Functions can also be search engine API's that issue a query to a knowledge base. Here is an example that utilizes regular function calls in combination with function calls to a search engine API. Please make sure to extract the source for the information within the final answer when using information returned from the search engine.&lt;/example_docstring>\\n    &lt;example>\\n        &lt;functions>\\n            &lt;function>\\n                &lt;function_name>get::benefitsaction::getbenefitplanname&lt;/function_name>\\n                &lt;function_description>Get's the benefit plan name for a user. The API takes in a userName and a benefit type and returns the benefit name to the user (i.e. Aetna, Premera, Fidelity, etc.).&lt;/function_description>\\n                &lt;optional_argument>userName (string): None&lt;/optional_argument>\\n                &lt;optional_argument>benefitType (string): None&lt;/optional_argument>\\n                &lt;returns>object: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>post::benefitsaction::increase401klimit&lt;/function_name>\\n                &lt;function_description>Increases the 401k limit for a generic user. The API takes in only the current 401k limit and returns the new limit.&lt;/function_description>\\n                &lt;optional_argument>currentLimit (string): None&lt;/optional_argument>\\n                &lt;returns>object: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>get::x_amz_knowledgebase_dentalinsurance::search&lt;/function_name>\\n                &lt;function_description>This is a search tool that provides information about Delta Dental benefits. It has information about covered dental benefits and other relevant information&lt;/function_description>\\n                &lt;required_argument>query(string): A full sentence query that is fed to the search tool&lt;/required_argument>\\n                &lt;returns>Returns string  related to the user query asked.&lt;/returns>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>get::x_amz_knowledgebase_401kplan::search&lt;/function_name>\\n                &lt;function_description>This is a search tool that provides information about Amazon 401k plan benefits. It can determine what a person's yearly 401k contribution limit is, based on their age.&lt;/function_description>\\n                &lt;required_argument>query(string): A full sentence query that is fed to the search tool&lt;/required_argument>\\n                &lt;returns>Returns string  related to the user query asked.&lt;/returns>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>get::x_amz_knowledgebase_healthinsurance::search&lt;/function_name>\\n                &lt;function_description>This is a search tool that provides information about Aetna and Premera health benefits. It has information about the savings plan and shared deductible plan, as well as others.&lt;/function_description>\\n                &lt;required_argument>query(string): A full sentence query that is fed to the search tool&lt;/required_argument>\\n                &lt;returns>Returns string  related to the user query asked.&lt;/returns>\\n            &lt;/function>\\n            \\n        &lt;/functions>\\n\\n        &lt;question>What is my deductible? My username is Bob and my benefitType is Dental. Also, what is the 401k yearly contribution limit?&lt;/question>\\n        &lt;scratchpad> I understand I cannot use functions that have not been provided to me to answer this question.\\n            To answer this question, I will:\\n            1. Call the get::benefitsaction::getbenefitplanname function to get the benefit plan name for the user Bob with benefit type Dental.\\n            2. Call the get::x_amz_knowledgebase_dentalinsurance::search function to search for information about deductibles for the plan name returned from step 1.\\n            3. Call the get::x_amz_knowledgebase_401k::search function to search for information about 401k yearly contribution limits.\\n            4. Return the deductible information from the search results to the user.\\n            I have checked that I have access to the get::benefitsaction::getbenefitplanname, x_amz_knowledgebase_dentalinsurance::search, and x_amz_knowledgebase_401k::search functions.\\n        &lt;/scratchpad>\\n        &lt;function_call>get::benefitsaction::getbenefitplanname(userName=\\\"Bob\\\", benefitType=\\\"Dental\\\")&lt;/function_call>\\n        &lt;function_result>{{'response': {{'planName': 'Delta Dental'}}}}&lt;/function_result>\\n        &lt;scratchpad>\\n            I have received the plan name Delta Dental for the user Bob with Dental benefits. I will now call the x_amz_knowledgebase_dentalinsurance::search function to find deductible information for Delta Dental.\\n        &lt;/scratchpad>\\n        &lt;function_call>get::x_amz_knowledgebase_dentalinsurance::search(searchQuery=\\\"What is the deductible for Delta Dental?\\\")&lt;/function_call>\\n        &lt;function_result>{{'response': {{'responseCode': '200', 'responseBody': \\\"\\\"&lt;answer>\\\\n&lt;answer_part>\\\\n&lt;text>The user's individual deductible is $50 per benefit period&lt;/text>\\\\n&lt;source>dfe040f8-46ed-4a65-b3ea-529fa55f6b9e&lt;/source>\\\\n&lt;/answer_part>\\\\n&lt;answer_part>\\\\n&lt;text>If they are enrolled with dependents, the maximum family deductible is $150 per benefit period.&lt;/text>\\\\n&lt;source>0e666064-31d8-4223-b7ba-8eecf40b7b47&lt;/source>\\\\n&lt;/answer_part>\\\\n&lt;/answer>\\\"}}}}&lt;/function_result> &lt;scratchpad>\\n            I have found the deductible information for Dental benefits. I will now call the x_amz_knowledgebase_401k::search function to find yearly 401k contribution limits.\\n        &lt;/scratchpad>\\n        &lt;function_call>get::x_amz_knowledgebase_401k::search(searchQuery=\\\"What is the yearly 401k contribution limit?\\\")&lt;/function_call>\\n        &lt;function_result>{{'response': {{'responseCode': '200', 'responseBody': \\\"&lt;answer>\\\\n&lt;answer_part>\\\\n&lt;text>The yearly 401k contribution limit is $20,500.&lt;/text>\\\\n&lt;source>c546cbe8-07f6-45d1-90ca-74d87ab2885a&lt;/source>\\\\n&lt;/answer_part>\\\\n&lt;/answer>\\\"}}}}&lt;/function_result>\\n        &lt;answer>\\n            &lt;answer_part>\\n                &lt;text>The deductible for your Delta Dental plan is $50 per benefit period.&lt;/text>\\n                &lt;source>dfe040f8-46ed-4a65-b3ea-529fa55f6b9e&lt;/source>\\n            &lt;/answer_part>\\n            &lt;answer_part>\\n                &lt;text>If you have dependents enrolled, the maximum family deductible is $150 per benefit period.&lt;/text>\\n                &lt;source>0e666064-31d8-4223-b7ba-8eecf40b7b47&lt;/source>\\n            &lt;/answer_part>\\n            &lt;answer_part>\\n                &lt;text>The yearly 401k contribution limit is $20,500.&lt;/text>\\n                &lt;source>c546cbe8-07f6-45d1-90ca-74d87ab2885a&lt;/source>\\n            &lt;/answer_part>\\n        &lt;/answer>\\n    &lt;/example>\\n\\n    \\n\\n    &lt;example_docstring>Here's a final example where the question asked could not be answered with information gathered from calling the provided functions. In this example, notice how you respond by telling the user you cannot answer, without using a function that was not provided to you.&lt;/example_docstring>\\n    &lt;example>\\n        &lt;functions>\\n            &lt;function>\\n                &lt;function_name>get::policyengineactions::getpolicyviolations&lt;/function_name>\\n                &lt;function_description>Returns a list of policy engine violations for the specified alias within the specified date range.&lt;/function_description>\\n                &lt;required_argument>alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument>\\n                &lt;required_argument>startDate (string): The start date of the range to filter violations. The format for startDate is MM/DD/YYYY.&lt;/required_argument>\\n                &lt;required_argument>endDate (string): The end date of the range to filter violations&lt;/required_argument>\\n                &lt;returns>array: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>post::policyengineactions::acknowledgeviolations&lt;/function_name>\\n                &lt;function_description>Acknowledge policy engine violation. Generally used to acknowledge violation, once user notices a violation under their alias or their managers alias.&lt;/function_description>\\n                &lt;required_argument>policyId (string): The ID of the policy violation&lt;/required_argument>\\n                &lt;required_argument>expectedDateOfResolution (string): The date by when the violation will be addressed/resolved&lt;/required_argument>\\n                &lt;returns>object: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>get::activedirectoryactions::getmanager&lt;/function_name>\\n                &lt;function_description>This API is used to identify the manager hierarchy above a given person. Every person could have a manager and the manager could have another manager to which they report to&lt;/function_description>\\n                &lt;required_argument>alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument>\\n                &lt;returns>object: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            \\n        &lt;/functions>\\n        &lt;question>Who are the reportees of David?&lt;/question>\\n        &lt;scratchpad>\\n            After reviewing the functions I was equipped with, I realize I am not able to accurately answer this question since I can't access reportees of David. Therefore, I should explain to the user I cannot answer this question.\\n        &lt;/scratchpad>\\n        &lt;answer>\\n            Sorry, I am unable to assist you with this request.\\n        &lt;/answer>\\n    &lt;/example>\\n&lt;/examples>\\n\\nThe above examples have been provided to you to illustrate general guidelines and format for use of function calling for information retrieval, and how to use your scratchpad to plan your approach. IMPORTANT: the functions provided within the examples should not be assumed to have been provided to you to use UNLESS they are also explicitly given to you within &lt;functions>&lt;/functions> tags below. All of the values and information within the examples (the questions, function results, and answers) are strictly part of the examples and have not been provided to you.\\n\\nNow that you have read and understood the examples, I will define the functions that you have available to you to use. Here is a comprehensive list.\\n\\n&lt;functions>\\n&lt;function>\\n&lt;function_name>GET::optimal_departure_window_mars::getNextMarsLaunchWindow&lt;/function_name>\\n&lt;function_description>Gets the next optimal launch window to Mars.&lt;/function_description>\\n&lt;required_argument>specific_impulse (string): Specific impulse of the propulsion system (s).&lt;/required_argument>\\n&lt;required_argument>dry_mass (string): Mass of the spacecraft without fuel (kg).&lt;/required_argument>\\n&lt;required_argument>total_mass (string): Total mass of the spacecraft including fuel (kg)&lt;/required_argument>\\n&lt;returns>object: The next optimal departure date for a Hohmann transfer from Earth to Mars, based on the spacecraft's mass and specific impulse.&lt;/returns>\\n&lt;/function>\\n\\n\\n&lt;/functions>\\n\\nNote that the function arguments have been listed in the order that they should be passed into the function.\\n\\n\\n\\nDo not modify or extend the provided functions under any circumstances. For example, GET::optimal_departure_window_mars::getNextMarsLaunchWindow with additional parameters would be considered modifying the function which is not allowed. Please use the functions only as defined.\\n\\nDO NOT use any functions that I have not equipped you with.\\n\\n Do not make assumptions about inputs; instead, make sure you know the exact function and input to use before you call a function.\\n\\nTo call a function, output the name of the function in between &lt;function_call> and &lt;/function_call> tags. You will receive a &lt;function_result> in response to your call that contains information that you can use to better answer the question. Or, if the function call produced an error, you will receive an &lt;error> in response.\\n\\n\\n\\nThe format for all other &lt;function_call> MUST be: &lt;function_call>$FUNCTION_NAME($FUNCTION_PARAMETER_NAME=$FUNCTION_PARAMETER_VALUE)&lt;/function_call>\\n\\nRemember, your goal is to answer the user's question to the best of your ability, using only the function(s) provided within the &lt;functions>&lt;/functions> tags to gather more information if necessary to better answer the question.\\n\\nDo not modify or extend the provided functions under any circumstances. For example, calling GET::optimal_departure_window_mars::getNextMarsLaunchWindow with additional parameters would be modifying the function which is not allowed. Please use the functions only as defined.\\n\\nBefore calling any functions, create a plan for performing actions to answer this question within the &lt;scratchpad>. Double check your plan to make sure you don't call any functions that you haven't been provided with. Always return your final answer within &lt;answer>&lt;/answer> tags.\\n\\n\\n\\nThe user input is &lt;question>Answer the following question and pay strong attention to the prompt:\\n        &lt;question>\\n        When is the next launch window for Mars? My spacecraft's total mass is 50000, dry mass is 10000 and specific impulse is 2500. Mass in Kg.\\n        &lt;/question>\\n        &lt;instruction>\\n        You have functions available at your disposal to use when anwering any questions about orbital mechanics.if you can't find a function to answer a question about orbital mechanics, simply reply 'I do not know'\\n        &lt;/instruction>&lt;/question>\\n\\n\\nAssistant: &lt;scratchpad> I understand I cannot use functions that have not been provided to me to answer this question.\\n\\n\"}",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "mlflow.spanOutputs": "\"To answer this question about the next Mars launch window, I will:\\n\\n1. Call the GET::optimal_departure_window_mars::getNextMarsLaunchWindow function to get the next optimal launch window, passing in the provided spacecraft mass and specific impulse values.\\n\\nI have verified that I have access to the GET::optimal_departure_window_mars::getNextMarsLaunchWindow function.\""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "events": []</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "name": "Invoking Action Group",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "context": {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "span_id": "0x692bd6457647dc76",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "trace_id": "0x9b8bd0b2e018d77f936e48a09e54fd44"</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "parent_id": "0xb802165d133a33aa",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "start_time": 1731388550224851000,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "end_time": 1731388550225218000,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "status_code": "OK",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "status_message": "",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "attributes": {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "mlflow.traceRequestId": "\"1e036cc3a7f946ec995f7763b8dde51c\"",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "mlflow.spanType": "\"UNKNOWN\"",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "trace_attributes": "[{\"type\": \"modelInvocationInput\", \"data\": {\"inferenceConfiguration\": {\"maximumLength\": 2048, \"stopSequences\": [\"&lt;/function_call>\", \"&lt;/answer>\", \"&lt;/error>\"], \"temperature\": 0.0, \"topK\": 250, \"topP\": 1.0}, \"text\": \"\\n\\nHuman:\\nYou are a research assistant AI that has been equipped with one or more functions to help you answer a &lt;question>. Your goal is to answer the user's question to the best of your ability, using the function(s) to gather more information if necessary to better answer the question. If you choose to call a function, the result of the function call will be added to the conversation history in &lt;function_results> tags (if the call succeeded) or &lt;error> tags (if the function failed). \\nYou were created with these instructions to consider as well:\\n&lt;auxiliary_instructions>\\n            You are a friendly chat bot. You have access to a function called that returns\\n            information about the Mars launch window. When responding with Mars launch window,\\n            please make sure to add the timezone UTC.\\n            &lt;/auxiliary_instructions>\\n\\nHere are some examples of correct action by other, different agents with access to functions that may or may not be similar to ones you are provided.\\n\\n&lt;examples>\\n    &lt;example_docstring> Here is an example of how you would correctly answer a question using a &lt;function_call> and the corresponding &lt;function_result>. Notice that you are free to think before deciding to make a &lt;function_call> in the &lt;scratchpad>.&lt;/example_docstring>\\n    &lt;example>\\n        &lt;functions>\\n            &lt;function>\\n                &lt;function_name>get::policyengineactions::getpolicyviolations&lt;/function_name>\\n                &lt;function_description>Returns a list of policy engine violations for the specified alias within the specified date range.&lt;/function_description>\\n                &lt;required_argument>alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument>\\n                &lt;required_argument>startDate (string): The start date of the range to filter violations. The format for startDate is MM/DD/YYYY.&lt;/required_argument>\\n                &lt;required_argument>endDate (string): The end date of the range to filter violations&lt;/required_argument>\\n                &lt;returns>array: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>post::policyengineactions::acknowledgeviolations&lt;/function_name>\\n                &lt;function_description>Acknowledge policy engine violation. Generally used to acknowledge violation, once user notices a violation under their alias or their managers alias.&lt;/function_description>\\n                &lt;required_argument>policyId (string): The ID of the policy violation&lt;/required_argument>\\n                &lt;required_argument>expectedDateOfResolution (string): The date by when the violation will be addressed/resolved&lt;/required_argument>\\n                &lt;returns>object: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>get::activedirectoryactions::getmanager&lt;/function_name>\\n                &lt;function_description>This API is used to identify the manager hierarchy above a given person. Every person could have a manager and the manager could have another manager to which they report to&lt;/function_description>\\n                &lt;required_argument>alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument>\\n                &lt;returns>object: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            \\n        &lt;/functions>\\n\\n        &lt;question>Can you show me my policy engine violation from 1st january 2023 to 1st february 2023? My alias is jsmith.&lt;/question>\\n        &lt;scratchpad>\\n            To answer this question, I will need to:\\n            1. I do not have knowledge to policy engine violations, so I should see if I can use any of the available functions to help. I have been equipped with get::policyengineactions::getpolicyviolations that gets the policy engine violations for a given alias, start date and end date. I will use this function to gather more information.\\n        &lt;/scratchpad>\\n        &lt;function_call>get::policyengineactions::getpolicyviolations(alias=\\\"jsmith\\\", startDate=\\\"1st January 2023\\\", endDate=\\\"1st February 2023\\\")&lt;/function_call>\\n        &lt;function_result>{response: [{creationDate: \\\"2023-06-01T09:30:00Z\\\", riskLevel: \\\"High\\\", policyId: \\\"POL-001\\\", policyUrl: \\\"https://example.com/policies/POL-001\\\", referenceUrl: \\\"https://example.com/violations/POL-001\\\"}, {creationDate: \\\"2023-06-02T14:45:00Z\\\", riskLevel: \\\"Medium\\\", policyId: \\\"POL-002\\\", policyUrl: \\\"https://example.com/policies/POL-002\\\", referenceUrl: \\\"https://example.com/violations/POL-002\\\"}]}&lt;/function_result>\\n        &lt;answer>The policy engine violations between 1st january 2023 to 1st february 2023 for alias jsmith are - Policy ID: POL-001, Policy ID: POL-002&lt;/answer>\\n    &lt;/example>\\n\\n    &lt;example_docstring>Here is another example that utilizes multiple function calls.&lt;/example_docstring>\\n    &lt;example>\\n        &lt;functions>\\n            &lt;function>\\n                &lt;function_name>get::policyengineactions::getpolicyviolations&lt;/function_name>\\n                &lt;function_description>Returns a list of policy engine violations for the specified alias within the specified date range.&lt;/function_description>\\n                &lt;required_argument>alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument>\\n                &lt;required_argument>startDate (string): The start date of the range to filter violations. The format for startDate is MM/DD/YYYY.&lt;/required_argument>\\n                &lt;required_argument>endDate (string): The end date of the range to filter violations&lt;/required_argument>\\n                &lt;returns>array: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>post::policyengineactions::acknowledgeviolations&lt;/function_name>\\n                &lt;function_description>Acknowledge policy engine violation. Generally used to acknowledge violation, once user notices a violation under their alias or their managers alias.&lt;/function_description>\\n                &lt;required_argument>policyId (string): The ID of the policy violation&lt;/required_argument>\\n                &lt;required_argument>expectedDateOfResolution (string): The date by when the violation will be addressed/resolved&lt;/required_argument>\\n                &lt;returns>object: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>get::activedirectoryactions::getmanager&lt;/function_name>\\n                &lt;function_description>This API is used to identify the manager hierarchy above a given person. Every person could have a manager and the manager could have another manager to which they report to&lt;/function_description>\\n                &lt;required_argument>alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument>\\n                &lt;returns>object: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            \\n        &lt;/functions>\\n        &lt;question>Can you check the policy engine violations under my manager between 2nd May to 5th May? My alias is john.&lt;/question>\\n        &lt;scratchpad>\\n            To answer this question, I will need to:\\n            1. Get the manager alias of the user using get::activedirectoryactions::getmanager function.\\n            2. Use the returned manager alias to get the policy engine violations using the get::policyengineactions::getpolicyviolations function.\\n\\n            I have double checked and made sure that I have been provided the get::activedirectoryactions::getmanager and the get::policyengineactions::getpolicyviolations functions.\\n        &lt;/scratchpad>\\n        &lt;function_call>get::activedirectoryactions::getmanager(alias=\\\"john\\\")&lt;/function_call>\\n        &lt;function_result>{response: {managerAlias: \\\"mark\\\", managerLevel: \\\"6\\\", teamName: \\\"Builder\\\", managerName: \\\"Mark Hunter\\\"}}}}&lt;/function_result>\\n        &lt;scratchpad>\\n            1. I have the managerAlias from the function results as mark and I have the start and end date from the user input. I can use the function result to call get::policyengineactions::getpolicyviolations function.\\n            2. I will then return the get::policyengineactions::getpolicyviolations function result to the user.\\n\\n            I have double checked and made sure that I have been provided the get::policyengineactions::getpolicyviolations functions.\\n        &lt;/scratchpad>\\n        &lt;function_call>get::policyengineactions::getpolicyviolations(alias=\\\"mark\\\", startDate=\\\"2nd May 2023\\\", endDate=\\\"5th May 2023\\\")&lt;/function_call>\\n        &lt;function_result>{response: [{creationDate: \\\"2023-05-02T09:30:00Z\\\", riskLevel: \\\"High\\\", policyId: \\\"POL-001\\\", policyUrl: \\\"https://example.com/policies/POL-001\\\", referenceUrl: \\\"https://example.com/violations/POL-001\\\"}, {creationDate: \\\"2023-05-04T14:45:00Z\\\", riskLevel: \\\"Low\\\", policyId: \\\"POL-002\\\", policyUrl: \\\"https://example.com/policies/POL-002\\\", referenceUrl: \\\"https://example.com/violations/POL-002\\\"}]}&lt;/function_result>\\n        &lt;answer>\\n            The policy engine violations between 2nd May 2023 to 5th May 2023 for your manager's alias mark are - Policy ID: POL-001, Policy ID: POL-002\\n        &lt;/answer>\\n    &lt;/example>\\n\\n    &lt;example_docstring>Functions can also be search engine API's that issue a query to a knowledge base. Here is an example that utilizes regular function calls in combination with function calls to a search engine API. Please make sure to extract the source for the information within the final answer when using information returned from the search engine.&lt;/example_docstring>\\n    &lt;example>\\n        &lt;functions>\\n            &lt;function>\\n                &lt;function_name>get::benefitsaction::getbenefitplanname&lt;/function_name>\\n                &lt;function_description>Get's the benefit plan name for a user. The API takes in a userName and a benefit type and returns the benefit name to the user (i.e. Aetna, Premera, Fidelity, etc.).&lt;/function_description>\\n                &lt;optional_argument>userName (string): None&lt;/optional_argument>\\n                &lt;optional_argument>benefitType (string): None&lt;/optional_argument>\\n                &lt;returns>object: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>post::benefitsaction::increase401klimit&lt;/function_name>\\n                &lt;function_description>Increases the 401k limit for a generic user. The API takes in only the current 401k limit and returns the new limit.&lt;/function_description>\\n                &lt;optional_argument>currentLimit (string): None&lt;/optional_argument>\\n                &lt;returns>object: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>get::x_amz_knowledgebase_dentalinsurance::search&lt;/function_name>\\n                &lt;function_description>This is a search tool that provides information about Delta Dental benefits. It has information about covered dental benefits and other relevant information&lt;/function_description>\\n                &lt;required_argument>query(string): A full sentence query that is fed to the search tool&lt;/required_argument>\\n                &lt;returns>Returns string  related to the user query asked.&lt;/returns>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>get::x_amz_knowledgebase_401kplan::search&lt;/function_name>\\n                &lt;function_description>This is a search tool that provides information about Amazon 401k plan benefits. It can determine what a person's yearly 401k contribution limit is, based on their age.&lt;/function_description>\\n                &lt;required_argument>query(string): A full sentence query that is fed to the search tool&lt;/required_argument>\\n                &lt;returns>Returns string  related to the user query asked.&lt;/returns>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>get::x_amz_knowledgebase_healthinsurance::search&lt;/function_name>\\n                &lt;function_description>This is a search tool that provides information about Aetna and Premera health benefits. It has information about the savings plan and shared deductible plan, as well as others.&lt;/function_description>\\n                &lt;required_argument>query(string): A full sentence query that is fed to the search tool&lt;/required_argument>\\n                &lt;returns>Returns string  related to the user query asked.&lt;/returns>\\n            &lt;/function>\\n            \\n        &lt;/functions>\\n\\n        &lt;question>What is my deductible? My username is Bob and my benefitType is Dental. Also, what is the 401k yearly contribution limit?&lt;/question>\\n        &lt;scratchpad> I understand I cannot use functions that have not been provided to me to answer this question.\\n            To answer this question, I will:\\n            1. Call the get::benefitsaction::getbenefitplanname function to get the benefit plan name for the user Bob with benefit type Dental.\\n            2. Call the get::x_amz_knowledgebase_dentalinsurance::search function to search for information about deductibles for the plan name returned from step 1.\\n            3. Call the get::x_amz_knowledgebase_401k::search function to search for information about 401k yearly contribution limits.\\n            4. Return the deductible information from the search results to the user.\\n            I have checked that I have access to the get::benefitsaction::getbenefitplanname, x_amz_knowledgebase_dentalinsurance::search, and x_amz_knowledgebase_401k::search functions.\\n        &lt;/scratchpad>\\n        &lt;function_call>get::benefitsaction::getbenefitplanname(userName=\\\"Bob\\\", benefitType=\\\"Dental\\\")&lt;/function_call>\\n        &lt;function_result>{{'response': {{'planName': 'Delta Dental'}}}}&lt;/function_result>\\n        &lt;scratchpad>\\n            I have received the plan name Delta Dental for the user Bob with Dental benefits. I will now call the x_amz_knowledgebase_dentalinsurance::search function to find deductible information for Delta Dental.\\n        &lt;/scratchpad>\\n        &lt;function_call>get::x_amz_knowledgebase_dentalinsurance::search(searchQuery=\\\"What is the deductible for Delta Dental?\\\")&lt;/function_call>\\n        &lt;function_result>{{'response': {{'responseCode': '200', 'responseBody': \\\"\\\"&lt;answer>\\\\n&lt;answer_part>\\\\n&lt;text>The user's individual deductible is $50 per benefit period&lt;/text>\\\\n&lt;source>dfe040f8-46ed-4a65-b3ea-529fa55f6b9e&lt;/source>\\\\n&lt;/answer_part>\\\\n&lt;answer_part>\\\\n&lt;text>If they are enrolled with dependents, the maximum family deductible is $150 per benefit period.&lt;/text>\\\\n&lt;source>0e666064-31d8-4223-b7ba-8eecf40b7b47&lt;/source>\\\\n&lt;/answer_part>\\\\n&lt;/answer>\\\"}}}}&lt;/function_result> &lt;scratchpad>\\n            I have found the deductible information for Dental benefits. I will now call the x_amz_knowledgebase_401k::search function to find yearly 401k contribution limits.\\n        &lt;/scratchpad>\\n        &lt;function_call>get::x_amz_knowledgebase_401k::search(searchQuery=\\\"What is the yearly 401k contribution limit?\\\")&lt;/function_call>\\n        &lt;function_result>{{'response': {{'responseCode': '200', 'responseBody': \\\"&lt;answer>\\\\n&lt;answer_part>\\\\n&lt;text>The yearly 401k contribution limit is $20,500.&lt;/text>\\\\n&lt;source>c546cbe8-07f6-45d1-90ca-74d87ab2885a&lt;/source>\\\\n&lt;/answer_part>\\\\n&lt;/answer>\\\"}}}}&lt;/function_result>\\n        &lt;answer>\\n            &lt;answer_part>\\n                &lt;text>The deductible for your Delta Dental plan is $50 per benefit period.&lt;/text>\\n                &lt;source>dfe040f8-46ed-4a65-b3ea-529fa55f6b9e&lt;/source>\\n            &lt;/answer_part>\\n            &lt;answer_part>\\n                &lt;text>If you have dependents enrolled, the maximum family deductible is $150 per benefit period.&lt;/text>\\n                &lt;source>0e666064-31d8-4223-b7ba-8eecf40b7b47&lt;/source>\\n            &lt;/answer_part>\\n            &lt;answer_part>\\n                &lt;text>The yearly 401k contribution limit is $20,500.&lt;/text>\\n                &lt;source>c546cbe8-07f6-45d1-90ca-74d87ab2885a&lt;/source>\\n            &lt;/answer_part>\\n        &lt;/answer>\\n    &lt;/example>\\n\\n    \\n\\n    &lt;example_docstring>Here's a final example where the question asked could not be answered with information gathered from calling the provided functions. In this example, notice how you respond by telling the user you cannot answer, without using a function that was not provided to you.&lt;/example_docstring>\\n    &lt;example>\\n        &lt;functions>\\n            &lt;function>\\n                &lt;function_name>get::policyengineactions::getpolicyviolations&lt;/function_name>\\n                &lt;function_description>Returns a list of policy engine violations for the specified alias within the specified date range.&lt;/function_description>\\n                &lt;required_argument>alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument>\\n                &lt;required_argument>startDate (string): The start date of the range to filter violations. The format for startDate is MM/DD/YYYY.&lt;/required_argument>\\n                &lt;required_argument>endDate (string): The end date of the range to filter violations&lt;/required_argument>\\n                &lt;returns>array: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>post::policyengineactions::acknowledgeviolations&lt;/function_name>\\n                &lt;function_description>Acknowledge policy engine violation. Generally used to acknowledge violation, once user notices a violation under their alias or their managers alias.&lt;/function_description>\\n                &lt;required_argument>policyId (string): The ID of the policy violation&lt;/required_argument>\\n                &lt;required_argument>expectedDateOfResolution (string): The date by when the violation will be addressed/resolved&lt;/required_argument>\\n                &lt;returns>object: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            &lt;function>\\n                &lt;function_name>get::activedirectoryactions::getmanager&lt;/function_name>\\n                &lt;function_description>This API is used to identify the manager hierarchy above a given person. Every person could have a manager and the manager could have another manager to which they report to&lt;/function_description>\\n                &lt;required_argument>alias (string): The alias of the employee under whose name current violations needs to be listed&lt;/required_argument>\\n                &lt;returns>object: Successful response&lt;/returns>\\n                &lt;raises>object: Invalid request&lt;/raises>\\n            &lt;/function>\\n            \\n        &lt;/functions>\\n        &lt;question>Who are the reportees of David?&lt;/question>\\n        &lt;scratchpad>\\n            After reviewing the functions I was equipped with, I realize I am not able to accurately answer this question since I can't access reportees of David. Therefore, I should explain to the user I cannot answer this question.\\n        &lt;/scratchpad>\\n        &lt;answer>\\n            Sorry, I am unable to assist you with this request.\\n        &lt;/answer>\\n    &lt;/example>\\n&lt;/examples>\\n\\nThe above examples have been provided to you to illustrate general guidelines and format for use of function calling for information retrieval, and how to use your scratchpad to plan your approach. IMPORTANT: the functions provided within the examples should not be assumed to have been provided to you to use UNLESS they are also explicitly given to you within &lt;functions>&lt;/functions> tags below. All of the values and information within the examples (the questions, function results, and answers) are strictly part of the examples and have not been provided to you.\\n\\nNow that you have read and understood the examples, I will define the functions that you have available to you to use. Here is a comprehensive list.\\n\\n&lt;functions>\\n&lt;function>\\n&lt;function_name>GET::optimal_departure_window_mars::getNextMarsLaunchWindow&lt;/function_name>\\n&lt;function_description>Gets the next optimal launch window to Mars.&lt;/function_description>\\n&lt;required_argument>specific_impulse (string): Specific impulse of the propulsion system (s).&lt;/required_argument>\\n&lt;required_argument>dry_mass (string): Mass of the spacecraft without fuel (kg).&lt;/required_argument>\\n&lt;required_argument>total_mass (string): Total mass of the spacecraft including fuel (kg)&lt;/required_argument>\\n&lt;returns>object: The next optimal departure date for a Hohmann transfer from Earth to Mars, based on the spacecraft's mass and specific impulse.&lt;/returns>\\n&lt;/function>\\n\\n\\n&lt;/functions>\\n\\nNote that the function arguments have been listed in the order that they should be passed into the function.\\n\\n\\n\\nDo not modify or extend the provided functions under any circumstances. For example, GET::optimal_departure_window_mars::getNextMarsLaunchWindow with additional parameters would be considered modifying the function which is not allowed. Please use the functions only as defined.\\n\\nDO NOT use any functions that I have not equipped you with.\\n\\n Do not make assumptions about inputs; instead, make sure you know the exact function and input to use before you call a function.\\n\\nTo call a function, output the name of the function in between &lt;function_call> and &lt;/function_call> tags. You will receive a &lt;function_result> in response to your call that contains information that you can use to better answer the question. Or, if the function call produced an error, you will receive an &lt;error> in response.\\n\\n\\n\\nThe format for all other &lt;function_call> MUST be: &lt;function_call>$FUNCTION_NAME($FUNCTION_PARAMETER_NAME=$FUNCTION_PARAMETER_VALUE)&lt;/function_call>\\n\\nRemember, your goal is to answer the user's question to the best of your ability, using only the function(s) provided within the &lt;functions>&lt;/functions> tags to gather more information if necessary to better answer the question.\\n\\nDo not modify or extend the provided functions under any circumstances. For example, calling GET::optimal_departure_window_mars::getNextMarsLaunchWindow with additional parameters would be modifying the function which is not allowed. Please use the functions only as defined.\\n\\nBefore calling any functions, create a plan for performing actions to answer this question within the &lt;scratchpad>. Double check your plan to make sure you don't call any functions that you haven't been provided with. Always return your final answer within &lt;answer>&lt;/answer> tags.\\n\\n\\n\\nThe user input is &lt;question>Answer the following question and pay strong attention to the prompt:\\n        &lt;question>\\n        When is the next launch window for Mars? My spacecraft's total mass is 50000, dry mass is 10000 and specific impulse is 2500. Mass in Kg.\\n        &lt;/question>\\n        &lt;instruction>\\n        You have functions available at your disposal to use when anwering any questions about orbital mechanics.if you can't find a function to answer a question about orbital mechanics, simply reply 'I do not know'\\n        &lt;/instruction>&lt;/question>\\n\\n\\nAssistant: &lt;scratchpad> I understand I cannot use functions that have not been provided to me to answer this question.\\n\\n\", \"traceId\": \"e0b2b2c2-fb7c-4e17-8a1f-a3781100face-0\", \"type\": \"ORCHESTRATION\"}, \"event_order\": 2}, {\"type\": \"modelInvocationOutput\", \"data\": {\"metadata\": {\"usage\": {\"inputTokens\": 5160, \"outputTokens\": 135}}, \"rawResponse\": {\"content\": \"To answer this question about the next Mars launch window, I will:\\n\\n1. Call the GET::optimal_departure_window_mars::getNextMarsLaunchWindow function to get the next optimal launch window, passing in the provided spacecraft mass and specific impulse values.\\n\\nI have verified that I have access to the GET::optimal_departure_window_mars::getNextMarsLaunchWindow function.\\n\\n&lt;/scratchpad>\\n\\n&lt;function_call>\\nGET::optimal_departure_window_mars::getNextMarsLaunchWindow(specific_impulse=\\\"2500\\\", dry_mass=\\\"10000\\\", total_mass=\\\"50000\\\")\"}, \"traceId\": \"e0b2b2c2-fb7c-4e17-8a1f-a3781100face-0\"}, \"event_order\": 3}, {\"type\": \"rationale\", \"data\": {\"text\": \"To answer this question about the next Mars launch window, I will:\\n\\n1. Call the GET::optimal_departure_window_mars::getNextMarsLaunchWindow function to get the next optimal launch window, passing in the provided spacecraft mass and specific impulse values.\\n\\nI have verified that I have access to the GET::optimal_departure_window_mars::getNextMarsLaunchWindow function.\", \"traceId\": \"e0b2b2c2-fb7c-4e17-8a1f-a3781100face-0\"}, \"event_order\": 4}, {\"type\": \"invocationInput\", \"data\": {\"actionGroupInvocationInput\": {\"actionGroupName\": \"optimal_departure_window_mars\", \"apiPath\": \"/get-next-mars-launch-window\", \"executionType\": \"LAMBDA\", \"parameters\": [{\"name\": \"total_mass\", \"type\": \"string\", \"value\": \"50000\"}, {\"name\": \"dry_mass\", \"type\": \"string\", \"value\": \"10000\"}, {\"name\": \"specific_impulse\", \"type\": \"string\", \"value\": \"2500\"}], \"verb\": \"get\"}, \"invocationType\": \"ACTION_GROUP\", \"traceId\": \"e0b2b2c2-fb7c-4e17-8a1f-a3781100face-0\"}, \"event_order\": 5}, {\"type\": \"observation\", \"data\": {\"actionGroupInvocationOutput\": {\"text\": \"{\\\"next_launch_window\\\": {\\\"next_launch_date\\\": \\\"2026-11-26 00:00:00\\\", \\\"synodic_period_days\\\": 779.9068939794238, \\\"transfer_time_days\\\": 259, \\\"delta_v_available_m_s\\\": 39457.985759929674, \\\"delta_v_required_m_s\\\": 5595.997417810693, \\\"is_feasible\\\": true}}\"}, \"traceId\": \"e0b2b2c2-fb7c-4e17-8a1f-a3781100face-0\", \"type\": \"ACTION_GROUP\"}, \"event_order\": 6}]",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "mlflow.spanFunctionName": "\"_action_group_trace\"",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "mlflow.spanInputs": "{\"inner_trace_group\": \"{'actionGroupName': 'optimal_departure_window_mars', 'apiPath': '/get-next-mars-launch-window', 'executionType': 'LAMBDA', 'parameters': [{'name': 'total_mass', 'type': 'string', 'value': '50000'}, {'name': 'dry_mass', 'type': 'string', 'value': '10000'}, {'name': 'specific_impulse', 'type': 'string', 'value': '2500'}], 'verb': 'get'}\"}",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "mlflow.spanOutputs": "\"{'action_group_name': 'optimal_departure_window_mars', 'api_path': '/get-next-mars-launch-window', 'execution_type': 'LAMBDA', 'execution_output': '{\\\"next_launch_window\\\": {\\\"next_launch_date\\\": \\\"2026-11-26 00:00:00\\\", \\\"synodic_period_days\\\": 779.9068939794238, \\\"transfer_time_days\\\": 259, \\\"delta_v_available_m_s\\\": 39457.985759929674, \\\"delta_v_required_m_s\\\": 5595.997417810693, \\\"is_feasible\\\": true}}'}\""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "events": []</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "name": "Retrieved Response",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "context": {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "span_id": "0xfe0b5f9149c39d7d",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "trace_id": "0x9b8bd0b2e018d77f936e48a09e54fd44"</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "parent_id": "0xb802165d133a33aa",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "start_time": 1731388550225320000,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "end_time": 1731388550226466000,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "status_code": "OK",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "status_message": "",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "attributes": {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "mlflow.traceRequestId": "\"1e036cc3a7f946ec995f7763b8dde51c\"",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "mlflow.spanType": "\"AGENT\"",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "mlflow.spanInputs": "[{\"role\": \"user\", \"content\": \"When is the next launch window for Mars? My spacecraft's total mass is 50000, dry mass is 10000 and specific impulse is 2500. Mass in Kg.\", \"name\": null}]",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "mlflow.spanOutputs": "{\"choices\": [{\"index\": 0, \"message\": {\"role\": \"user\", \"content\": \"Based on the provided spacecraft dry mass of 10000 kg, total mass of 50000 kg, and specific impulse of 2500 s, the next optimal launch window for a Hohmann transfer from Earth to Mars is on November 26, 2026 UTC. The transfer will take 259 days.\", \"name\": null}, \"finish_reason\": \"stop\", \"logprobs\": null}], \"usage\": {\"prompt_tokens\": null, \"completion_tokens\": null, \"total_tokens\": null}, \"id\": null, \"model\": \"anthropic.claude-v2\", \"object\": \"chat.completion\", \"created\": 1731388550}"</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">      "events": []</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  ],</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  "request": "{\"context\": \"&lt;mlflow.pyfunc.model.PythonModelContext object at 0x13397c530>\", \"messages\": [{\"role\": \"user\", \"content\": \"When is the next launch window for Mars? My spacecraft's total mass is 50000, dry mass is 10000 and specific impulse is 2500. Mass in Kg.\", \"name\": null}], \"params\": {\"temperature\": 1.0, \"max_tokens\": null, \"stop\": null, \"n\": 1, \"stream\": false, \"top_p\": null, \"top_k\": null, \"frequency_penalty\": null, \"presence_penalty\": null}}",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">  "response": "{\"choices\": [{\"index\": 0, \"message\": {\"role\": \"user\", \"content\": \"Based on the provided spacecraft dry mass of 10000 kg, total mass of 50000 kg, and specific impulse of 2500 s, the next optimal launch window for a Hohmann transfer from Earth to Mars is on November 26, 2026 UTC. The transfer will take 259 days.\", \"name\": null}, \"finish_reason\": \"stop\", \"logprobs\": null}], \"usage\": {\"prompt_tokens\": null, \"completion_tokens\": null, \"total_tokens\": null}, \"id\": null, \"model\": \"anthropic.claude-v2\", \"object\": \"chat.completion\", \"created\": 1731388550}"</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">}</span><br/></span></code></pre></div></div></div></div></details>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id=visualizing-trace-breakdown-in-the-mlflow-ui>Visualizing Trace Breakdown in the MLflow UI<a href=#visualizing-trace-breakdown-in-the-mlflow-ui class=hash-link aria-label="Direct link to Visualizing Trace Breakdown in the MLflow UI" title="Direct link to Visualizing Trace Breakdown in the MLflow UI" translate=no>​</a></h3>
<ol>
<li class="">
<p><b>Initial Prompt Submitted to the Bedrock Agent.</b>
<img decoding=async loading=lazy alt=Thumbnail src=/mlflow-website/assets/images/bedrock_input_prompt-7841e074dccf4a33f259a45f613147c5.png width=2898 height=1310 class=img_ev3q /></p>
</li>
<li class="">
<p><b>In this trace, we can observe how the Bedrock Agent evaluates and selects the most suitable Action Group for the task at hand.</b>
<img decoding=async loading=lazy alt=Thumbnail src=/mlflow-website/assets/images/action_group_decision-221f4cd596874f14b2521595c03f6b60.png width=2902 height=1364 class=img_ev3q /></p>
</li>
<li class="">
<p><b>Once an Action Group is selected, its invocation is traced, displaying the input and output interactions with the underlying Lambda function as outlined by the OpenAPI Spec above.</b>
<img decoding=async loading=lazy alt=Thumbnail src=/mlflow-website/assets/images/invoking_action_group-a94489c23d1626bcd67c5d2ce8136621.png width=2918 height=1264 class=img_ev3q /></p>
</li>
<li class="">
<p><b>Furthermore, Bedrock's supplementary trace is included under the Attributes section,
along with additional metadata as shown below</b>
<img decoding=async loading=lazy alt=Thumbnail src=/mlflow-website/assets/images/traces_attributes-320b4b8b8a9c52bc9dbf4f27248c11ca.png width=2936 height=1788 class=img_ev3q /></p>
</li>
<li class="">
<p><b>Subsequently, the final response from the agent is traced, as depicted below.</b>
<img decoding=async loading=lazy alt=Thumbnail src=/mlflow-website/assets/images/retrieved_response-e72339291104fb6659f04c1cedfcbef2.png width=2914 height=1038 class=img_ev3q /></p>
</li>
</ol>
<p><strong>Note</strong>: We cannot break down the span's duration into individual trace durations
because the Bedrock Agent's trace response does not include timestamps for each trace step.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=conclusion>Conclusion<a href=#conclusion class=hash-link aria-label="Direct link to Conclusion" title="Direct link to Conclusion" translate=no>​</a></h2>
<p>In this blog, we explored how to integrate the AWS Bedrock Agent as an MLflow ChatModel, focusing on Action Groups,
Knowledge Bases, and Tracing. We demonstrated how to easily build a custom ChatModel using MLflow's flexible and
powerful APIs. This approach enables you to leverage MLflow's tracing and logging capabilities, even for models or
flavors that are not natively supported by MLflow.</p>
<p>Key Takeaways from This Blog:</p>
<ul>
<li class="">Deploying a Bedrock Agent with Action Groups as AWS Lambda Functions:<!-- -->
<ul>
<li class="">We covered how to set up a Bedrock Agent and implement custom actions using AWS Lambda functions within Action Groups.</li>
</ul>
</li>
<li class="">Mapping the AWS Bedrock Agent's Custom Tracing to MLflow span/trace objects:<!-- -->
<ul>
<li class="">We demonstrated how to convert the agent's custom tracing data into MLflow span objects for better observability.</li>
</ul>
</li>
<li class="">Logging and Loading the Bedrock Agent as an MLflow ChatModel:<!-- -->
<ul>
<li class="">We showed how to log the Bedrock Agent into MLflow as a <em><code>ChatModel</code></em> and how to load it for future use.</li>
</ul>
</li>
<li class="">Externalizing AWS Client and Bedrock Configurations:<!-- -->
<ul>
<li class="">We explained how to externalize AWS client and Bedrock configurations to safeguard secrets and make it easy to adjust model settings without the need to re-log the model.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=further-reading-and-references>Further Reading and References<a href=#further-reading-and-references class=hash-link aria-label="Direct link to Further Reading and References" title="Direct link to Further Reading and References" translate=no>​</a></h2>
<ul>
<li class=""><a href=https://docs.aws.amazon.com/bedrock/latest/userguide/agents-how.html target=_blank rel="noopener noreferrer" class="">How Amazon Bedrock Agents work</a></li>
<li class=""><a href=https://docs.aws.amazon.com/bedrock/latest/userguide/trace-events.html target=_blank rel="noopener noreferrer" class="">Amazon Bedrock Tracing</a></li>
<li class=""><a href=https://mlflow.org/docs/latest/llms/chat-model-guide/index.html target=_blank rel="noopener noreferrer" class="">Creating a Custom GenAI chat agent</a></li>
<li class=""><a href=https://github.com/awsdocs/aws-doc-sdk-examples target=_blank rel="noopener noreferrer" class="">AWS Code Examples Repository</a></li>
</ul></div><footer class=docusaurus-mt-lg><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class=col><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class=tag_QGVx><a rel=tag class="tag_zVej tagRegular_sFm0" href=/mlflow-website/blog/tags/genai>genai</a><li class=tag_QGVx><a rel=tag class="tag_zVej tagRegular_sFm0" href=/mlflow-website/blog/tags/pyfunc>pyfunc</a><li class=tag_QGVx><a rel=tag class="tag_zVej tagRegular_sFm0" href=/mlflow-website/blog/tags/bedrock>bedrock</a><li class=tag_QGVx><a rel=tag class="tag_zVej tagRegular_sFm0" href=/mlflow-website/blog/tags/tracing>tracing</a></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href=/mlflow-website/blog/mlflow-tracing-in-jupyter><div class=pagination-nav__sublabel>Newer post</div><div class=pagination-nav__label>MLflow Tracing in Jupyter Notebooks</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/mlflow-website/blog/mlflow-llama-index-workflow><div class=pagination-nav__sublabel>Older post</div><div class=pagination-nav__label>Building Advanced RAG with MLflow and LlamaIndex Workflow</div></a></nav></div></div></div></div></main><footer class="relative pb-30 flex flex-col pt-30"><div style="position:absolute;width:100%;bottom:0;pointer-events:none;mask-composite:intersect;height:360px;background-image:repeating-linear-gradient(
        to right,
        rgba(0, 0, 0, 0.05),
        rgba(0, 0, 0, 0.25) 18px,
        transparent 2px,
        transparent 10px
      ),
      radial-gradient(
        circle at bottom center,
        var(--color-brand-red) 0%,
        transparent 60%
      ),
      linear-gradient(to right, color-mix(in srgb, var(--color-brand-red), oklch(0.33 0.15 328.37) 80%), color-mix(in srgb, var(--color-brand-red), oklch(0.66 0.17 248.82) 100%));mask-image:radial-gradient(ellipse at center bottom, black 60%, transparent 80%),
      linear-gradient(to top, black 10%, transparent 40%)"></div><div class=z-1><div class="flex flex-row justify-between items-start px-6 lg:px-20 gap-10 xs:gap-0 max-w-container"><div class="flex flex-col gap-8"><svg xmlns=http://www.w3.org/2000/svg width=109 height=40 fill=none viewBox="0 0 109 40" class="h-[36px] shrink-0"><path fill=#fff d="M0 31.032v-15.53h3.543v1.968c.893-1.594 2.84-2.425 4.593-2.425 2.042 0 3.828.926 4.658 2.745 1.216-2.043 3.034-2.745 5.043-2.745 2.81 0 5.49 1.787 5.49 5.904v10.083h-3.574v-9.478c0-1.818-.926-3.19-3-3.19-1.947 0-3.224 1.53-3.224 3.445v9.22H9.893v-9.475c0-1.786-.898-3.18-3.003-3.18-1.977 0-3.223 1.467-3.223 3.444v9.221ZM27.855 31.032V7.929h3.703v23.103ZM30.07 39.487c.833.232 1.582.383 3.17.383 2.953 0 6.436-1.665 7.353-6.339l3.786-18.739h5.629l.687-3.117h-5.686l.765-3.725c.586-2.892 2.186-4.358 4.754-4.358.668 0 .48.058 1.076.17L52.427.57c-.793-.237-1.503-.379-3.049-.379a7.32 7.32 0 0 0-4.528 1.484c-1.441 1.114-2.393 2.75-2.827 4.863l-1.066 5.137h-5.034l-.411 3.12h4.823L36.859 32.12c-.383 1.965-1.5 4.315-4.708 4.315-.727 0-.463-.055-1.121-.162ZM53.342 30.905H49.64l5.074-23.309h3.701ZM71.807 16.477A7.962 7.962 0 0 0 60.97 27.904l2.425-1.78a5.005 5.005 0 0 1 3.845-8.145v1.895ZM62.618 29.472a7.962 7.962 0 0 0 10.836-11.428l-2.425 1.78a5.005 5.005 0 0 1-3.845 8.145v-1.894ZM78.092 15.493h4.044l.823 10.612 5.759-10.612 3.839.055 1.508 10.557 5.074-10.612 3.701.055-7.678 15.493H91.46l-1.783-11.106-5.895 11.106h-3.84ZM105.072 15.768h-.766v-.266h1.845v.272h-.765v2.243h-.314ZM106.614 15.502h.383l.482 1.34q.091.259.178.524h.018c.059-.176.113-.352.172-.524l.478-1.34h.383v2.515h-.298V16.63c0-.22.024-.523.04-.747h-.016l-.191.574-.475 1.304h-.208l-.481-1.302-.191-.574h-.015c.017.224.042.527.042.747v1.387h-.291Z"/></svg><div class="text-xs text-gray-800 text-left md:text-nowrap md:w-0">© 2025 MLflow Project, a Series of LF Projects, LLC.</div></div><div class="flex flex-col flex-wrap justify-end md:text-right md:flex-row gap-x-10 lg:gap-x-20 gap-y-5 w-2/5 md:w-auto md:pt-2 max-w-fit"><div><a href=/mlflow-website/>Components</a></div><div><a href=/mlflow-website/releases>Releases</a></div><div><a href=/mlflow-website/blog>Blog</a></div><div><a href=https://mlflow.org/docs/latest/ target=_blank rel="noopener noreferrer">Docs</a></div><div><a href=/mlflow-website/ambassadors>Ambassador Program</a></div></div></div></div></footer></div></div></div></body>