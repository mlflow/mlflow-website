<!doctype html><html lang=en dir=ltr class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated=false><head><meta charset=UTF-8><meta name=generator content="Docusaurus v3.9.2"><title data-rh=true>Building and Managing an LLM-based OCR System with MLflow | MLflow</title><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"/><meta data-rh=true name=twitter:card content=summary_large_image /><meta data-rh=true property=og:url content=http://mlflow.org/mlflow-website/blog/mlflow-prompt-evaluate /><meta data-rh=true property=og:locale content=en /><meta data-rh=true name=docusaurus_locale content=en /><meta data-rh=true name=docusaurus_tag content=default /><meta data-rh=true name=docsearch:language content=en /><meta data-rh=true name=docsearch:docusaurus_tag content=default /><meta data-rh=true property=og:title content="Building and Managing an LLM-based OCR System with MLflow | MLflow"/><meta data-rh=true name=description content="Building GenAI tools presents a unique set of challenges. As we evaluate accuracy, iterate on prompts, and enable collaboration, we often encounter bottlenecks that slow down our progress toward production."/><meta data-rh=true property=og:description content="Building GenAI tools presents a unique set of challenges. As we evaluate accuracy, iterate on prompts, and enable collaboration, we often encounter bottlenecks that slow down our progress toward production."/><meta data-rh=true property=og:type content=article /><meta data-rh=true property=article:published_time content=2025-08-30T00:00:00.000Z /><meta data-rh=true property=article:author content=https://www.linkedin.com/in/allison-b-ba269889/,https://www.linkedin.com/in/shyampr16/,https://www.linkedin.com/in/-michael-berk/,https://github.com/mlflow/mlflow.git /><meta data-rh=true property=article:tag content=mlflow,genai,evaluation,prompt-registry,tracing /><link data-rh=true rel=icon href=/mlflow-website/img/mlflow-favicon.ico /><link data-rh=true rel=canonical href=http://mlflow.org/mlflow-website/blog/mlflow-prompt-evaluate /><link data-rh=true rel=alternate href=http://mlflow.org/mlflow-website/blog/mlflow-prompt-evaluate hreflang=en /><link data-rh=true rel=alternate href=http://mlflow.org/mlflow-website/blog/mlflow-prompt-evaluate hreflang=x-default /><script data-rh=true type=application/ld+json>{"@context":"https://schema.org","@id":"http://mlflow.org/mlflow-website/blog/mlflow-prompt-evaluate","@type":"BlogPosting","author":[{"@type":"Person","description":"Sr. Solutions Engineer at Databricks","image":"/mlflow-website/img/authors/allison_bennett.png","name":"Allison Bennett","url":"https://www.linkedin.com/in/allison-b-ba269889/"},{"@type":"Person","description":"Specialist Solutions Architect at Databricks","image":"/mlflow-website/img/authors/shyam_sankararaman.png","name":"Shyam Sankararaman","url":"https://www.linkedin.com/in/shyampr16/"},{"@type":"Person","description":"Sr. Resident Solutions Architect at Databricks","image":"/mlflow-website/img/authors/michael_berk.png","name":"Michael Berk","url":"https://www.linkedin.com/in/-michael-berk/"},{"@type":"Person","description":"MLflow maintainers","image":"https://github.com/mlflow-automation.png","name":"MLflow maintainers","url":"https://github.com/mlflow/mlflow.git"}],"datePublished":"2025-08-30T00:00:00.000Z","description":"Building GenAI tools presents a unique set of challenges. As we evaluate accuracy, iterate on prompts, and enable collaboration, we often encounter bottlenecks that slow down our progress toward production.","headline":"Building and Managing an LLM-based OCR System with MLflow","isPartOf":{"@id":"http://mlflow.org/mlflow-website/blog","@type":"Blog","name":"Blog"},"keywords":[],"mainEntityOfPage":"http://mlflow.org/mlflow-website/blog/mlflow-prompt-evaluate","name":"Building and Managing an LLM-based OCR System with MLflow","url":"http://mlflow.org/mlflow-website/blog/mlflow-prompt-evaluate"}</script><link rel=preconnect href=https://www.google-analytics.com><link rel=preconnect href=https://www.googletagmanager.com><script async src="https://www.googletagmanager.com/gtag/js?id=AW-16857946923"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","AW-16857946923",{anonymize_ip:!0})</script><link rel=preconnect href=https://www.googletagmanager.com><script>window.dataLayer=window.dataLayer||[],function(e,t,a,n,r){e[n]=e[n]||[],e[n].push({"gtm.start":new Date().getTime(),event:"gtm.js"});var d=t.getElementsByTagName(a)[0],g=t.createElement(a);g.async=!0,g.src="https://www.googletagmanager.com/gtm.js?id="+r+("dataLayer"!=n?"&l="+n:""),d.parentNode.insertBefore(g,d)}(window,document,"script","dataLayer","GTM-N6WMTTJ")</script><link rel=alternate type=application/rss+xml href=/mlflow-website/blog/rss.xml title="MLflow RSS Feed"><link rel=alternate type=application/atom+xml href=/mlflow-website/blog/atom.xml title="MLflow Atom Feed"><link rel=alternate type=application/rss+xml href=/mlflow-website/releases/rss.xml title="MLflow RSS Feed"><link rel=alternate type=application/atom+xml href=/mlflow-website/releases/atom.xml title="MLflow Atom Feed"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin=anonymous><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" display=swap><link rel=stylesheet href=/mlflow-website/assets/css/styles.d55e5617.css /><script src=/mlflow-website/assets/js/runtime~main.37a0f7dc.js defer></script><script src=/mlflow-website/assets/js/main.e4060ac2.js defer></script></head><body class=navigation-with-keyboard><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-N6WMTTJ" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript>


<svg style="display: none;"><defs>
<symbol id=theme-svg-external-link viewBox="0 0 24 24"><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"light"),document.documentElement.setAttribute("data-theme-choice",t||"light")}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="theme-layout-navbar navbar navbar--fixed-top"><div class=navbar__inner><div class="theme-layout-navbar-left navbar__items"><a class=navbar__brand href=/mlflow-website/></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type=button disabled title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill=currentColor d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"/></svg></button></div><div class=navbarSearchContainer_Bca1></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="flex flex-col min-h-screen w-full bg-[#0E1416]"><nav class="fixed w-full z-20 top-0 start-0 bg-black/20 border-b border-[#F7F8F8]/8 backdrop-blur-[20px] overflow-y-auto"><div class="flex flex-wrap items-center mx-auto px-6 lg:px-20 py-2 max-w-container"><div class="md:contents flex flex-row justify-between w-full sticky top-[8px]"><a class="flex items-center space-x-3 rtl:space-x-reverse grow basis-0" aria-label="MLflow Home" href=/mlflow-website/><svg xmlns=http://www.w3.org/2000/svg width=109 height=40 fill=none viewBox="0 0 109 40" class=h-[36px] aria-hidden=true><path fill=#fff d="M0 31.032v-15.53h3.543v1.968c.893-1.594 2.84-2.425 4.593-2.425 2.042 0 3.828.926 4.658 2.745 1.216-2.043 3.034-2.745 5.043-2.745 2.81 0 5.49 1.787 5.49 5.904v10.083h-3.574v-9.478c0-1.818-.926-3.19-3-3.19-1.947 0-3.224 1.53-3.224 3.445v9.22H9.893v-9.475c0-1.786-.898-3.18-3.003-3.18-1.977 0-3.223 1.467-3.223 3.444v9.221ZM27.855 31.032V7.929h3.703v23.103ZM30.07 39.487c.833.232 1.582.383 3.17.383 2.953 0 6.436-1.665 7.353-6.339l3.786-18.739h5.629l.687-3.117h-5.686l.765-3.725c.586-2.892 2.186-4.358 4.754-4.358.668 0 .48.058 1.076.17L52.427.57c-.793-.237-1.503-.379-3.049-.379a7.32 7.32 0 0 0-4.528 1.484c-1.441 1.114-2.393 2.75-2.827 4.863l-1.066 5.137h-5.034l-.411 3.12h4.823L36.859 32.12c-.383 1.965-1.5 4.315-4.708 4.315-.727 0-.463-.055-1.121-.162ZM53.342 30.905H49.64l5.074-23.309h3.701ZM71.807 16.477A7.962 7.962 0 0 0 60.97 27.904l2.425-1.78a5.005 5.005 0 0 1 3.845-8.145v1.895ZM62.618 29.472a7.962 7.962 0 0 0 10.836-11.428l-2.425 1.78a5.005 5.005 0 0 1-3.845 8.145v-1.894ZM78.092 15.493h4.044l.823 10.612 5.759-10.612 3.839.055 1.508 10.557 5.074-10.612 3.701.055-7.678 15.493H91.46l-1.783-11.106-5.895 11.106h-3.84ZM105.072 15.768h-.766v-.266h1.845v.272h-.765v2.243h-.314ZM106.614 15.502h.383l.482 1.34q.091.259.178.524h.018c.059-.176.113-.352.172-.524l.478-1.34h.383v2.515h-.298V16.63c0-.22.024-.523.04-.747h-.016l-.191.574-.475 1.304h-.208l-.481-1.302-.191-.574h-.015c.017.224.042.527.042.747v1.387h-.291Z"/></svg></a><div class="flex flex-row items-center gap-6 md:order-2 space-x-3 md:space-x-0 rtl:space-x-reverse grow justify-end basis-0"><a class="hidden md:block" href=/mlflow-website/#get-started><button class="rounded-xl inline-flex items-center justify-center whitespace-nowrap font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 hover:cursor-pointer bg-white text-black hover:bg-gray-900 text-[15px] px-4 py-2 w-fit">Get started</button></a><button data-collapse-toggle=navbar-sticky type=button class="inline-flex items-center p-2 w-10 h-10 justify-center text-sm text-white md:hidden focus:outline-none cursor-pointer"><span class=sr-only>Open main menu</span><svg class="w-5 h-5" aria-hidden=true xmlns=http://www.w3.org/2000/svg fill=none viewBox="0 0 17 14"><path stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M1 1h15M1 7h15M1 13h15"/></svg></button></div></div><div class="items-center justify-between w-full md:w-auto md:order-1 mt-4 md:mt-0 hidden md:flex"><ul class="flex flex-col font-medium md:flex-row gap-y-6 gap-x-4 lg:gap-x-10 w-full md:w-auto"><li class="w-full md:w-auto md:hidden"><button type=button aria-expanded=false aria-controls=mobile-components-submenu class="flex items-center justify-between gap-2 py-2 text-white text-lg w-full cursor-pointer transition-colors duration-200 hover:text-white/60">Components<svg xmlns=http://www.w3.org/2000/svg width=16 height=17 fill=none viewBox="0 0 16 17" class="w-6 h-6 transition-transform duration-300"><path fill=#F7F8F8 fill-rule=evenodd d="m8 10.776 3.61-3.61-.943-.942L8 8.89 5.333 6.224l-.942.943z" clip-rule=evenodd /></svg></button><div id=mobile-components-submenu class="transition-all duration-300 ease-in-out overflow-hidden max-h-0 opacity-0"><div class="flex flex-col md:flex-row md:max-w-4xl mx-auto gap-6 md:gap-8 lg:gap-10 px-1 md:px-4 lg:pl-0 products-submenu overflow-x-hidden"><div class="flex flex-col gap-4"><div class="flex flex-col gap-1 md:gap-4 border-b border-[#F7F8F8]/8 pb-4 group"><a href=/mlflow-website/genai><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">GenAI Apps & Agents</h3><p class="text-[#F7F8F8]/60 m-0">Ship high-quality GenAI, fast</p></a></div><div class="flex flex-col gap-3"><span class="text-[#F7F8F8]/60 text-sm">Features</span><div class="flex flex-row gap-6 xxs:gap-8"><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/observability>Observability</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/evaluations>Evaluations</a></div><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/prompt-registry>Prompt Registry</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/ai-gateway>AI Gateway</a></div></div></div></div><div class="flex flex-col gap-4"><div class="flex flex-col gap-1 md:gap-4 border-b border-[#F7F8F8]/8 pb-4 group"><a href=/mlflow-website/classical-ml><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">Model Training</h3><p class="text-[#F7F8F8]/60 m-0">Mastering the ML lifecycle</p></a></div><div class="flex flex-col gap-3"><span class="text-[#F7F8F8]/60 text-sm">Features</span><div class="flex flex-row gap-6 xxs:gap-8"><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/experiment-tracking>Experiment tracking</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/model-evaluation>Model evaluation</a></div><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/models>MLflow models</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/model-registry>Model Registry & deployment</a></div></div></div></div></div></div><li class="w-full md:w-auto hidden md:block"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60">Components<svg xmlns=http://www.w3.org/2000/svg width=16 height=17 fill=none viewBox="0 0 16 17" class="w-6 h-6"><path fill=#F7F8F8 fill-rule=evenodd d="m8 10.776 3.61-3.61-.943-.942L8 8.89 5.333 6.224l-.942.943z" clip-rule=evenodd /></svg></a><li class="w-full md:w-auto"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/releases>Releases</a><li class="w-full md:w-auto"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/blog>Blog</a><li class="w-full md:w-auto md:hidden"><button type=button aria-expanded=false aria-controls=mobile-docs-submenu class="flex items-center justify-between gap-2 py-2 text-white text-lg w-full cursor-pointer transition-colors duration-200 hover:text-white/60">Docs<svg xmlns=http://www.w3.org/2000/svg width=16 height=17 fill=none viewBox="0 0 16 17" class="w-6 h-6 transition-transform duration-300"><path fill=#F7F8F8 fill-rule=evenodd d="m8 10.776 3.61-3.61-.943-.942L8 8.89 5.333 6.224l-.942.943z" clip-rule=evenodd /></svg></button><div id=mobile-docs-submenu class="transition-all duration-300 ease-in-out overflow-hidden max-h-0 opacity-0"><div class="flex flex-col md:flex-row md:max-w-2xl mx-auto gap-6 md:gap-8 lg:gap-10 px-1 md:px-4 lg:pl-0 docs-submenu overflow-x-hidden"><div class="flex flex-col gap-1 md:gap-2 pb-4 flex-1 group"><a href=https://mlflow.org/docs/latest/genai/ target=_blank rel="noopener noreferrer"><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">GenAI Apps & Agents</h3><p class="text-[#F7F8F8]/60 m-0">Learn how to track, evaluate, and optimize your GenAI applications and agent workflows.</p></a></div><div class="flex flex-col gap-1 md:gap-2 pb-4 flex-1 group"><a href=https://mlflow.org/docs/latest/ml/ target=_blank rel="noopener noreferrer"><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">Model Training</h3><p class="text-[#F7F8F8]/60 m-0">Get started with the core functionality for traditional machine learning workflows, hyperparameter tuning, and model lifecycle management.</p></a></div></div></div><li class="w-full md:w-auto hidden md:block"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60">Docs<svg xmlns=http://www.w3.org/2000/svg width=16 height=17 fill=none viewBox="0 0 16 17" class="w-6 h-6"><path fill=#F7F8F8 fill-rule=evenodd d="m8 10.776 3.61-3.61-.943-.942L8 8.89 5.333 6.224l-.942.943z" clip-rule=evenodd /></svg></a><li class="w-full md:w-auto"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/ambassadors>Ambassador Program</a><li class="w-full md:w-auto md:hidden"><a href=/mlflow-website/#get-started><button class="rounded-xl inline-flex items-center justify-center whitespace-nowrap font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 hover:cursor-pointer bg-white text-black hover:bg-gray-900 text-[15px] px-4 py-2 w-full">Get started</button></a></ul></div></div><div class="flex-col w-full py-6 hidden"><div class="flex flex-col md:flex-row md:max-w-4xl mx-auto gap-6 md:gap-8 lg:gap-10 px-1 md:px-4 lg:pl-0 products-submenu overflow-x-hidden"><div class="flex flex-col gap-4"><div class="flex flex-col gap-1 md:gap-4 border-b border-[#F7F8F8]/8 pb-4 group"><a href=/mlflow-website/genai><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">GenAI Apps & Agents</h3><p class="text-[#F7F8F8]/60 m-0">Ship high-quality GenAI, fast</p></a></div><div class="flex flex-col gap-3"><span class="text-[#F7F8F8]/60 text-sm">Features</span><div class="flex flex-row gap-6 xxs:gap-8"><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/observability>Observability</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/evaluations>Evaluations</a></div><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/prompt-registry>Prompt Registry</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/genai/ai-gateway>AI Gateway</a></div></div></div></div><div class="flex flex-col gap-4"><div class="flex flex-col gap-1 md:gap-4 border-b border-[#F7F8F8]/8 pb-4 group"><a href=/mlflow-website/classical-ml><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">Model Training</h3><p class="text-[#F7F8F8]/60 m-0">Mastering the ML lifecycle</p></a></div><div class="flex flex-col gap-3"><span class="text-[#F7F8F8]/60 text-sm">Features</span><div class="flex flex-row gap-6 xxs:gap-8"><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/experiment-tracking>Experiment tracking</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/model-evaluation>Model evaluation</a></div><div class="min-w-30 xxs:min-w-40 flex flex-col md:gap-1"><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/models>MLflow models</a><a class="flex items-center gap-2 py-2 text-white text-lg w-full md:w-auto cursor-pointer transition-colors duration-200 hover:!text-white/60" href=/mlflow-website/classical-ml/model-registry>Model Registry & deployment</a></div></div></div></div></div></div><div class="flex-col w-full py-6 hidden"><div class="flex flex-col md:flex-row md:max-w-2xl mx-auto gap-6 md:gap-8 lg:gap-10 px-1 md:px-4 lg:pl-0 docs-submenu overflow-x-hidden"><div class="flex flex-col gap-1 md:gap-2 pb-4 flex-1 group"><a href=https://mlflow.org/docs/latest/genai/ target=_blank rel="noopener noreferrer"><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">GenAI Apps & Agents</h3><p class="text-[#F7F8F8]/60 m-0">Learn how to track, evaluate, and optimize your GenAI applications and agent workflows.</p></a></div><div class="flex flex-col gap-1 md:gap-2 pb-4 flex-1 group"><a href=https://mlflow.org/docs/latest/ml/ target=_blank rel="noopener noreferrer"><h3 class="text-white transition-colors duration-200 group-hover:!text-white/60">Model Training</h3><p class="text-[#F7F8F8]/60 m-0">Get started with the core functionality for traditional machine learning workflows, hyperparameter tuning, and model lifecycle management.</p></a></div></div></div></nav><main class="flex flex-col"><div class="relative flex flex-col gap-20 bg-no-repeat w-full py-32"><div style="position:absolute;width:100%;top:0;pointer-events:none;mask-composite:intersect;height:820px;background-image:repeating-linear-gradient(
        to right,
        rgba(0, 0, 0, 0.05),
        rgba(0, 0, 0, 0.25) 24px,
        transparent 2px,
        transparent 10px
      ),
      radial-gradient(
        circle at top center,
        var(--color-brand-red) 0%,
        transparent 60%
      ),
      linear-gradient(to right, color-mix(in srgb, var(--color-brand-red), oklch(0.33 0.15 328.37) 80%), color-mix(in srgb, var(--color-brand-red), oklch(0.66 0.17 248.82) 100%));mask-image:linear-gradient(to bottom, black 40%, transparent 90%)"></div><div class=z-1><div class="flex flex-col gap-24 w-full px-6 md:px-20 max-w-container"><div class="flex flex-col max-w-7xl mx-auto w-full"><article class=""><header><h1 class=title_f1Hy>Building and Managing an LLM-based OCR System with MLflow</h1><div class="container_mt6G margin-vert--md"><time datetime=2025-08-30T00:00:00.000Z>August 30, 2025</time> · <!-- -->18 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href=https://www.linkedin.com/in/allison-b-ba269889/ target=_blank rel="noopener noreferrer" class=avatar__photo-link><img class="avatar__photo authorImage_XqGP" src=/mlflow-website/img/authors/allison_bennett.png alt="Allison Bennett"/></a><div class="avatar__intro authorDetails_lV9A"><div class=avatar__name><a href=https://www.linkedin.com/in/allison-b-ba269889/ target=_blank rel="noopener noreferrer"><span class=authorName_yefp translate=no>Allison Bennett</span></a></div><small class=authorTitle_nd0D title="Sr. Solutions Engineer at Databricks">Sr. Solutions Engineer at Databricks</small><div class=authorSocials_rSDt></div></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href=https://www.linkedin.com/in/shyampr16/ target=_blank rel="noopener noreferrer" class=avatar__photo-link><img class="avatar__photo authorImage_XqGP" src=/mlflow-website/img/authors/shyam_sankararaman.png alt="Shyam Sankararaman"/></a><div class="avatar__intro authorDetails_lV9A"><div class=avatar__name><a href=https://www.linkedin.com/in/shyampr16/ target=_blank rel="noopener noreferrer"><span class=authorName_yefp translate=no>Shyam Sankararaman</span></a></div><small class=authorTitle_nd0D title="Specialist Solutions Architect at Databricks">Specialist Solutions Architect at Databricks</small><div class=authorSocials_rSDt></div></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href=https://www.linkedin.com/in/-michael-berk/ target=_blank rel="noopener noreferrer" class=avatar__photo-link><img class="avatar__photo authorImage_XqGP" src=/mlflow-website/img/authors/michael_berk.png alt="Michael Berk"/></a><div class="avatar__intro authorDetails_lV9A"><div class=avatar__name><a href=https://www.linkedin.com/in/-michael-berk/ target=_blank rel="noopener noreferrer"><span class=authorName_yefp translate=no>Michael Berk</span></a></div><small class=authorTitle_nd0D title="Sr. Resident Solutions Architect at Databricks">Sr. Resident Solutions Architect at Databricks</small><div class=authorSocials_rSDt></div></div></div></div><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href=https://github.com/mlflow/mlflow.git target=_blank rel="noopener noreferrer" class=avatar__photo-link><img class="avatar__photo authorImage_XqGP" src=https://github.com/mlflow-automation.png alt="MLflow maintainers"/></a><div class="avatar__intro authorDetails_lV9A"><div class=avatar__name><a href=https://github.com/mlflow/mlflow.git target=_blank rel="noopener noreferrer"><span class=authorName_yefp translate=no>MLflow maintainers</span></a></div><small class=authorTitle_nd0D title="MLflow maintainers">MLflow maintainers</small><div class=authorSocials_rSDt></div></div></div></div></div></header><div id=__blog-post-container class=markdown><p>Building GenAI tools presents a unique set of challenges. As we evaluate accuracy, iterate on prompts, and enable collaboration, we often encounter bottlenecks that slow down our progress toward production.</p>
<p>In this blog, we explore how MLflow's GenAI capabilities help us streamline development and unlock value for both technical and non-technical contributors when building an LLM-based Optical Character Recognition (OCR) tool.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=what-is-ocr>What is OCR?<a href=#what-is-ocr class=hash-link aria-label="Direct link to What is OCR?" title="Direct link to What is OCR?" translate=no>​</a></h2>
<p>Optical Character Recognition, or OCR, is the process of extracting text from scanned documents and images. The resulting text is machine-encoded, editable, and searchable, unlocking a wide range of downstream use cases.</p>
<p>Here, we leverage multi-modal LLMs to extract formatted text from scanned documents. Unlike traditional OCR tools such as PyTesseract, LLM-based methods offer greater flexibility for complex layouts, handwritten content, and context-aware extraction. While these methods may require more computational resources and careful prompt engineering, they provide significant advantages for advanced use cases.</p>
<p>Fun fact: The earliest form of OCR, the Optophone, was introduced in 1914 to help blind individuals read printed text without Braille.
<img decoding=async loading=lazy alt=Optophone src=/mlflow-website/assets/images/margaret-hogan-used-the-black-sounding-optophone-to-read-a-book-b2a7ff0a74da291404563de637f5e43c.jpg width=360 height=254 class=img_ev3q /></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=the-challenge>The Challenge<a href=#the-challenge class=hash-link aria-label="Direct link to The Challenge" title="Direct link to The Challenge" translate=no>​</a></h2>
<p>We face several recurring challenges when building an LLM-based OCR application.</p>
<p><strong>Prompt Iteration and Versioning:</strong> Prompts need to be updated and tweaked to improve extraction quality. A new prompt can introduce performance regression, but we do not save the old version. Without rigorous versioning, it's hard to roll back or compare.</p>
<p><strong>Debugging Unexpected Results:</strong> Unexpected results may show up periodically in our OCR attempts. We need a way to understand why. Without detailed traceability, it is difficult to diagnose whether the issue is with the prompt, the model, or the data (e.g., a new document strucutre).</p>
<p><strong>Evaluating and Comparing Models:</strong> Accuracy in OCR can mean many things. We may want to measure correct field extraction, formatting, or even business logic compliance. In order to compare different model or prompt strategies, we need a way to define and track what matters.</p>
<p>MLflow addresses these directly in our workflow.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=ocr-use-case>OCR Use Case:<a href=#ocr-use-case class=hash-link aria-label="Direct link to OCR Use Case:" title="Direct link to OCR Use Case:" translate=no>​</a></h2>
<p>Our task is to create a document parsing tool for text extraction (OCR) using LLMs, using MLflow features to address our challenges. The data consists of scanned documents and their corresponding text extracted as JSON.</p>
<p>We use the <a href=https://guillaumejaume.github.io/FUNSD/ target=_blank rel="noopener noreferrer" class="">FUNSD dataset</a>, which contains around 200 fully annotated forms, structured as semantic entity labels and word groupings.</p>
<p>Example:</p>
<p><img decoding=async loading=lazy alt="Annotated form example" src=/mlflow-website/assets/images/word_grouping_semantic_entity_labeling-76ffcbf4ade5af5360a63e6415bc08b0.png width=1196 height=752 class=img_ev3q /></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token plain">{</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        "form": [</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            "id": 0,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            "text": "Registration No.",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            "box": [94,169,191,186],</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            "linking": [</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                [0,1]</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            ],</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            "label": "question",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            "words": [</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    "text": "Registration",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    "box": [94,169,168,186]</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    "text": "No.",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    "box": [170,169,191,183]</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            ]</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        },</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            "id": 1,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            "text": "533",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            "box": [209,169,236,182],</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            "label": "answer",</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            "words": [</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                {</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    "box": [209,169,236,182</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    ],</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    "text": "533"</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            ],</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            "linking": [</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                [0,1]</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            ]</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        }</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    ]</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    }</span><br/></span></code></pre></div></div>
<p>For a detailed description of each entry, refer to the <a href=https://arxiv.org/pdf/1905.13538.pdf target=_blank rel="noopener noreferrer" class="">original paper</a>.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id=1-set-up>1. Set Up<a href=#1-set-up class=hash-link aria-label="Direct link to 1. Set Up" title="Direct link to 1. Set Up" translate=no>​</a></h3>
<p>Install the required packages:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token plain">pip install openai mlflow tiktoken aiohttp -qU</span><br/></span></code></pre></div></div>
<p><strong>openai:</strong> For interacting with OpenAI models and APIs<br/>
<strong>mlflow:</strong> For experiment tracking, model management, and GenAI workflow tools<br/>
<strong>tiktoken:</strong> For efficient tokenization, especially useful with OpenAI models<br/>
<strong>aiohttp:</strong> For asynchronous HTTP requests, enabling efficient API calls</p>
<p>For this tutorial we use OpenAI, but the approach extends to other LLM providers.
We can prompt the user to type the OpenAI API key without echoing using getpass():</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> os</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> getpass </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> getpass</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">os</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"OPENAI_API_KEY"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> getpass</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Your OpenAI API Key: "</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br/></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id=2-observe-the-data>2. Observe the Data<a href=#2-observe-the-data class=hash-link aria-label="Direct link to 2. Observe the Data" title="Direct link to 2. Observe the Data" translate=no>​</a></h3>
<p>Let's read a randomly selected image and its corresponding annotation JSON file. The following utils functions faciliate this task.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> __future__ </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> annotations</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> dataclasses </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> dataclass</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> io </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> BytesIO</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> pathlib </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> Path</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> typing </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> Any</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> Mapping</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> Sequence</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> TypedDict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> Literal</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> pandas </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> pd</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> base64</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> json</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> random</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> re</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> PIL </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> Image </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> PILImage</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">DATA_DIRECTORY </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> Path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"./data"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">ANNOTATIONS_DIRECTORY </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> DATA_DIRECTORY </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"annotations"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">IMAGES_DIRECTORY </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> DATA_DIRECTORY </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"images"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">Word</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">TypedDict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    text</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">Item</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">TypedDict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> total</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">False</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token builtin" style="color:rgb(86, 156, 214)">id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">int</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    label</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Literal</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"question"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"answer"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"other"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    words</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">Word</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    linking</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token builtin" style="color:rgb(86, 156, 214)">tuple</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">int</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">int</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">@dataclass</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">frozen</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">QAPair</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    question</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    answer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">_flatten_form</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">form</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Any</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">Item</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Flattens the 'form' section into a simple list of items.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Accepts list[Item], list[list[Item]], or a single list-like page.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">isinstance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">form</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> form </span><span class="token keyword" style="color:rgb(86, 156, 214)">and</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">all</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token builtin" style="color:rgb(86, 156, 214)">isinstance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">page</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> page </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> form</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">item </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> page </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> form </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> item </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> page</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># 2D -> 1D</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> form</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">raise</span><span class="token plain"> TypeError</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Expected 'form' to be a list or list of lists."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">extract_qa_pairs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">items</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Sequence</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">Mapping</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> Any</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">QAPair</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Robustly extract Q&A pairs. Supports multiple answers per question.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Does not assume unique question text; uses ids to match.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    by_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">Any</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> Mapping</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> Any</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> it </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> items</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"id"</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> it</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            by_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">it</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"id"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> it</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    pairs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">QAPair</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> it </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> items</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> it</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"label"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">!=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"question"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">continue</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        links </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> it</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"linking"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">or</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        q_words </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> it</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"words"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">or</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        q_text </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">" "</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">join</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">w</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"text"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">""</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> w </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> q_words</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">strip</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> link </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> links</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">not</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">isinstance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">link</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">tuple</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">or</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">len</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">link</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">!=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">continue</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            q_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> a_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> link</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> q_id </span><span class="token operator" style="color:rgb(212, 212, 212)">!=</span><span class="token plain"> it</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"id"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token comment" style="color:rgb(106, 153, 85)"># Skip foreign link edges</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">continue</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            ans </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> by_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">a_id</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">not</span><span class="token plain"> ans </span><span class="token keyword" style="color:rgb(86, 156, 214)">or</span><span class="token plain"> ans</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"label"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">!=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"answer"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">continue</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            a_words </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ans</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"words"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">or</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            a_text </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">" "</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">join</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">w</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"text"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">""</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> w </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> a_words</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">strip</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> q_text </span><span class="token keyword" style="color:rgb(86, 156, 214)">and</span><span class="token plain"> a_text</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                pairs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    QAPair</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        question</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">q_text</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        answer</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">a_text</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> pairs</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">load_annotation_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">file_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"> Path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> directory</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Path </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ANNOTATIONS_DIRECTORY</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">QAPair</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Load one annotation JSON and return extracted Q&A pairs.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Always returns a list; empty if none found.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    file_path </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">directory </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> file_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">isinstance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">file_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token plain"> file_name</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> file_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">suffix</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">lower</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">!=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">".json"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        file_path </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> file_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">with_suffix</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">".json"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">with</span><span class="token plain"> file_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token builtin" style="color:rgb(86, 156, 214)">open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"r"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> encoding</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"utf-8"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> f</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        data </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> json</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">load</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    form </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"form"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    items </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> _flatten_form</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">form</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> extract_qa_pairs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">items</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">choose_random_annotation_names</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    directory</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Path </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ANNOTATIONS_DIRECTORY</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    n</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    suffix</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">".json"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    seed</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Returns a list of basenames (without extension). Raises if directory missing or empty.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Deterministic when seed is provided.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">not</span><span class="token plain"> directory</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">exists</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">raise</span><span class="token plain"> FileNotFoundError</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f"Directory </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">directory</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)"> does not exist."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    files </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">sorted</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">p </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> p </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> directory</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">iterdir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">is_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">and</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">suffix</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">lower</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token plain"> suffix</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">not</span><span class="token plain"> files</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">raise</span><span class="token plain"> FileNotFoundError</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f"No </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">suffix</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)"> files found in </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">directory</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> seed </span><span class="token keyword" style="color:rgb(86, 156, 214)">is</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">not</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        rnd </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> random</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Random</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">seed</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        selected </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> rnd</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sample</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">files</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> k</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token builtin" style="color:rgb(86, 156, 214)">min</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">n</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">len</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">files</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        selected </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> random</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sample</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">files</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> k</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token builtin" style="color:rgb(86, 156, 214)">min</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">n</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">len</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">files</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">p</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">stem </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> p </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> selected</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">compress_image</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    file_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"> Path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    quality</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">40</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    max_size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">tuple</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token builtin" style="color:rgb(86, 156, 214)">int</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">int</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1000</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1000</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">bytes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Resize and convert to JPEG with the given quality. Returns JPEG bytes.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    file_path </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> Path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">file_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">with</span><span class="token plain"> PILImage</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token builtin" style="color:rgb(86, 156, 214)">open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">file_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> img</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        img </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> img</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">convert</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"RGB"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        img</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">thumbnail</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">max_size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        buf </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> BytesIO</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        img</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">save</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">format</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"JPEG"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> quality</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">quality</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> optimize</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> buf</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">getvalue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">get_image_bytes_or_b64</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    file_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"> Path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    directory</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Path </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> IMAGES_DIRECTORY</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    as_base64</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">bool</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean">False</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    quality</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">40</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    max_size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">tuple</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token builtin" style="color:rgb(86, 156, 214)">int</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">int</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">1000</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1000</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">bytes</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Returns compressed JPEG bytes or a base64 string. File extension is coerced to .png on input,</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    but compression always outputs JPEG bytes/base64.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    path </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">directory </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> file_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">isinstance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">file_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token plain"> file_name</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">suffix</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">lower</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">!=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">".png"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        path </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">with_suffix</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">".png"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    jpeg_bytes </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> compress_image</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> quality</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">quality</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> max_size</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">max_size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> as_base64</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> base64</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">b64encode</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">jpeg_bytes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">decode</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"utf-8"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> jpeg_bytes</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">_key_chars_re </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> re</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token builtin" style="color:rgb(86, 156, 214)">compile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">r"[^\w\s\-_]"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># keep word chars, space, dash, underscore</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">_ws_re </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> re</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token builtin" style="color:rgb(86, 156, 214)">compile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">r"\s+"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">clean_key</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">key</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""Remove unwanted characters, collapse whitespace, trim, and convert to UPPER_SNAKE-ish."""</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    key </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> _key_chars_re</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sub</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">""</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> key</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    key </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> _ws_re</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sub</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">" "</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> key</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">strip</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># If you prefer underscores: key = key.replace(" ", "_")</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> key</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">upper</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">normalize_dict_keys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Any</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> Any</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Recursively normalize mapping keys; preserves lists/tuples;</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> collections</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">abc </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> Mapping </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> ABMapping</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> Sequence </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> ABSequence</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">isinstance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> ABMapping</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain">clean_key</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> normalize_dict_keys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">v</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> v </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> obj</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">items</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">isinstance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">tuple</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> obj</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">__class__</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">normalize_dict_keys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">v</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> v </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> obj</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> obj</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span></code></pre></div></div>
<p>Let’s take a moment to break down the <code>_extract_qa_pairs</code> function:</p>
<ol>
<li class="">We create an ID lookup dictionary to find items by their ID</li>
<li class="">We identify "question" items that have linked answer pair(s) in the form of (q_id, a_id)</li>
<li class="">We construct structured QAPair objects by extracting text from both question and answer words</li>
</ol>
<p>We can then call <code>load_annotation_file</code> to load an annotation JSON file and return question-answer pair (structured QAPair object).</p>
<p>For LLM inputs, we favor small, predictable payloads over lossless fidelity. We use <code>get_image_bytes_or_b64</code> to read PNG images from a directory and convert to either compressed JPEG bytes using <code>_compress_image</code> or base64 depending depending on the boolean as_base64.</p>
<p><strong>Bandwidth & Cost:</strong> PNG scans of forms are often 5–10× larger than a JPEG of the same resolution. Since we send images as base64 (with ≈33% overhead), shrinking bytes directly reduces request size, latency, and API cost—especially when batch-evaluating many pages.</p>
<p><strong>Normalization:</strong> Converting to 8-bit RGB and flattening transparency removes PNG quirks (alpha, indexed palettes, 16-bit depth, etc.), so every image reaches the model in a consistent form. This eliminates "works on my machine" ingestion issues across providers.</p>
<p><strong>Throughput Over Perfection:</strong> Our pages are high-contrast forms, so modest JPEG compression keeps text legible while dramatically shrinking files. For this tutorial, we also downscale to a max side of 1000 px, which is typically sufficient for field labels while speeding up end-to-end runs and evals.</p>
<p><strong>Trade-offs & Not Converting:</strong>
With tiny type, low-contrast scans, or while using classical OCR (e.g., Tesseract), we prefer lossless formats (PNG/TIFF) or use higher JPEG quality. Compression artifacts can blur thin strokes and hurt accuracy.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token plain">random_files </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> choose_random_annotation_names</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">n</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> seed</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">42</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">image_bytes </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> get_image_bytes_or_b64</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">random_files</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> as_base64</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">load_annotation_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">random_files</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id=3-mlflow-tracking-autolog-and-tracing>3. MLflow Tracking, Autolog and Tracing<a href=#3-mlflow-tracking-autolog-and-tracing class=hash-link aria-label="Direct link to 3. MLflow Tracking, Autolog and Tracing" title="Direct link to 3. MLflow Tracking, Autolog and Tracing" translate=no>​</a></h3>
<p>Before we make a call to OpenAI, we need to set up <a href=https://mlflow.org/docs/latest/ml/tracking target=_blank rel="noopener noreferrer" class="">MLflow Tracking</a> to ensure every experiment, prompt, and result is recorded and traceable.</p>
<p>We will also enable <a href=https://mlflow.org/docs/latest/ml/tracking/autolog target=_blank rel="noopener noreferrer" class="">MLflow Autolog</a> to simplify the tracking process by reducing the need for manual log statements. Below, we point MLflow to a local SQLite database as the backend store, where metrics, parameters, artifacts, and other useful information are logged automatically.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> mlflow</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_tracking_uri</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"sqlite:///mlflow_runs.db"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_experiment</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"ocr-initial-experiment"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">openai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">autolog</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br/></span></code></pre></div></div>
<p><a href=https://mlflow.org/docs/latest/genai/tracing/ target=_blank rel="noopener noreferrer" class="">MLflow Tracing</a> provides us with end-to-end observability. We gain a comprehensive view of each step from prompt construction and model inference to tool calls and final outputs. If we notice various failed attemped in our OCR tool, we can use the MLflow UI to inspect traces, compare inputs and outputs, and identify whether the issue is with the prompt, the model, or the data structure</p>
<p>In order to access the MLflow UI, we need to run the following. The UI will start on <code>http://localhost:5000</code> by default:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token plain">mlflow ui --backend-store-uri sqlite:///mlflow_runs.db</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span></code></pre></div></div>
<p><img decoding=async loading=lazy alt="MLflow UI showing the tracing for each LLM execution" src=/mlflow-website/assets/images/eval_traces-ca5f936f5ad94243b92c3ecdd55ee36a.png width=3446 height=1736 class=img_ev3q /></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id=4-loading-inputs-and-prompting>4. Loading inputs and Prompting<a href=#4-loading-inputs-and-prompting class=hash-link aria-label="Direct link to 4. Loading inputs and Prompting" title="Direct link to 4. Loading inputs and Prompting" translate=no>​</a></h3>
<p>We start by defining a system prompt for extracting the contents of the images into lists of "questions" and "answers" using an LLM. We will use a "first pass" prompt, deliberately made short and minimally descriptive so that subsequent improvements can be made later on. These are tracked under the MLflow experiment runs when the LLM completion calls are invoked for each image file. We convert the QAPair object into a dictionary for easier comparison with the LLM response during evaluation.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> collections </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> defaultdict</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">_files </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> choose_random_annotation_names</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">n</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> seed</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">42</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">#Store multiple answers per question as list</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">annotation_items </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> file_name </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> _files</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    file_dict </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> defaultdict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> pair </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> load_annotation_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">file_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        file_dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">pair</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">question</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">pair</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">answer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    annotation_items</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token builtin" style="color:rgb(86, 156, 214)">dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">file_dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">annotation_normalized </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> normalize_dict_keys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">annotation_items</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">images </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">get_image_bytes_or_b64</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token builtin" style="color:rgb(86, 156, 214)">file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> as_base64</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">file</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> _files</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">system_prompt </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""You are an expert at Optical Character Recognition (OCR). Extract the questions and answers from the image."""</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id=5-setting-up-the-llm>5. Setting up the LLM<a href=#5-setting-up-the-llm class=hash-link aria-label="Direct link to 5. Setting up the LLM" title="Direct link to 5. Setting up the LLM" translate=no>​</a></h3>
<p>On the OpenAI side, we initialize the client and send a prompt to the LLM, instructing it to act as an OCR expert. The expected output is a Structured Output containing a list of key-value pairs. To enforce this structure, we can define Pydantic models that validate the response format. Let's try to invoke the LLM and log the execution and see what the response looks like.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> pydantic </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> BaseModel</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> openai </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> OpenAI</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Define Pydantic models for structured output in the form of key-value pair accounting for duplicate questions</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">KeyValueModel</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">BaseModel</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    key</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">KeyValueList</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">BaseModel</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    pairs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">KeyValueModel</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">client </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> OpenAI</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">get_completion</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">inputs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    completion </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">chat</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">completions</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">parse</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"gpt-4o-mini"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        response_format</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">KeyValueList</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        messages</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">"role"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"system"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"content"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> system_prompt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">"role"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"user"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token string" style="color:rgb(206, 145, 120)">"content"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"type"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"text"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"text"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"what's in this image?"</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">"type"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"image_url"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        </span><span class="token string" style="color:rgb(206, 145, 120)">"image_url"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                            </span><span class="token string" style="color:rgb(206, 145, 120)">"url"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f"data:image/jpeg;base64,</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">inputs</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    generated_response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain">pair</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">key</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> pair</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">value </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> pair </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> completion</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">choices</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">message</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">parsed</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">pairs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> normalize_dict_keys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">generated_response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">with</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">start_run</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> run</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    predicted </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> get_completion</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">images</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">predicted</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span></code></pre></div></div>
<p>The following screenshot represents the extracted questions and answers for this specific image.</p>
<p><img decoding=async loading=lazy alt="Screenshot of LLM completion response" src=/mlflow-website/assets/images/llm_output-7501cf263168fd1dc13da1ba36499f4f.png width=2796 height=548 class=img_ev3q /></p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id=prompt-registry>Prompt Registry<a href=#prompt-registry class=hash-link aria-label="Direct link to Prompt Registry" title="Direct link to Prompt Registry" translate=no>​</a></h4>
<p>Prompt engineering is central to LLM-based OCR, but creating an initial prompt is often not sufficient. In order to track which prompt version produced which results as we iterate, we will use <a href=https://mlflow.org/docs/latest/genai/prompt-version-mgmt/prompt-registry target=_blank rel="noopener noreferrer" class="">MLflow Prompt Registry</a>. This allows us to register, version, and add tags to prompts.</p>
<p>Here's an example of a prompt template, specifically instructing the LLM to generate results in our expected format.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token plain">new_template </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""You are an expert at Optical Character Recognition (OCR). Extract the questions and answers from the image as a JSON object, where the keys are questions and the values are answers. If there are no questions or answers, return an empty JSON object {}.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span></code></pre></div></div>
<p>This initial prompt can be registered along with a prompt name, commit message, and relevant tags. Once registered, it can later be retrieved using <code>mlflow.genai.load_prompt()</code> for reuse or further improvements.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Register a new prompt for OCR question-answer extraction</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">new_prompt </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">genai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">register_prompt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"ocr-question-answer"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    template</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">new_template</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    commit_message</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"Initial commit"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    tags</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">"author"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"author@example.com"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">"task"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"ocr"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">"language"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"en"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">prompt </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">genai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">load_prompt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">name_or_uri</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"ocr-question-answer"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> version</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">new_prompt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">version</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">system_prompt </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> prompt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">template</span><br/></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id=6-defining-and-evaluating-performance>6. Defining and Evaluating Performance<a href=#6-defining-and-evaluating-performance class=hash-link aria-label="Direct link to 6. Defining and Evaluating Performance" title="Direct link to 6. Defining and Evaluating Performance" translate=no>​</a></h3>
<p>As ML engineers, we ensure that the OCR application using the LLM is robustly evaluated against ground truth. When evaluating an OCR system, we care about more than just accuracy. We may look at format compliance, business logic, or field extraction results. <a href=https://mlflow.org/docs/latest/genai/eval-monitor/ target=_blank rel="noopener noreferrer" class="">MLflow Evaluate</a> allows us to define <a href=https://mlflow.org/docs/latest/api_reference/python_api/mlflow.metrics.html target=_blank rel="noopener noreferrer" class="">built-in and custom metrics</a> that align with our use case.</p>
<p>While MLflow supports LLM-as-a-judge metrics, for this OCR example it's better and cheaper to use deterministic metrics. For example, we can define a custom metric <code>key_value_accuracy</code> to check if key-value pair of the generated output correctly matches that of the ground truth.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">metrics</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">base </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> MetricValue</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">models </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> make_metric</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">batch_completion</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">df</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> pd</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">DataFrame</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> pd</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Series</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    result </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">get_completion</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">image</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> image </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> df</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"inputs"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> pd</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Series</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">result</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">key_value_accuracy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">predictions</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> pd</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Series</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> truth</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> pd</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Series</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> MetricValue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Calculate accuracy scores by comparing predicted dictionaries with ground truth dictionaries.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    Both predictions and truth are expected to be dict[str, list[str]] format.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">    """</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    scores </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> pred_dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> truth_dict </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">zip</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">predictions</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> truth</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">not</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">isinstance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">pred_dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">or</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">not</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">isinstance</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">truth_dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            scores</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0.0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">continue</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        correct </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        total_answers </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> question</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> truth_answers </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> truth_dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">items</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            total_answers </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">len</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">truth_answers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> question </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> pred_dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                pred_answers </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> pred_dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">question</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token comment" style="color:rgb(106, 153, 85)"># Count how many truth answers are correctly predicted</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> truth_ans </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> truth_answers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> truth_ans </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"> pred_answers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">                        correct </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        scores</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">correct </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> total_answers </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> total_answers </span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0.0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> MetricValue</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        scores</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">scores</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        aggregate_results</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"mean"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">sum</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">scores</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">len</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">scores</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> scores </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0.0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">"p90"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">sorted</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">scores</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token builtin" style="color:rgb(86, 156, 214)">int</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token builtin" style="color:rgb(86, 156, 214)">len</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">scores</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0.9</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> scores </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0.0</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">custom_key_value_accuracy </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> make_metric</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    eval_fn</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">key_value_accuracy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    greater_is_better</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"key_value_accuracy"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br/></span></code></pre></div></div>
<p>After defining this custom metric, we can evaluate it over a dataframe, which includes a subset of base64-encoded images and their corresponding ground truth dictionaries. Using the <code>batch_completion</code> function, we run a batch completion request on this subset, retrieving outputs in the predefined Structured Output format.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token plain">results </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">models</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">evaluate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">batch_completion</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    data</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">pd</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">DataFrame</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">"inputs"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> images</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"truth"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> annotation_normalized</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    targets</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"truth"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    model_type</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"text"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    predictions</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"predictions"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    extra_metrics</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">custom_key_value_accuracy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Custom metric results:"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> results</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">metrics</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">eval_table </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> results</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tables</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"eval_results_table"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"\n Per-row scores:"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">eval_table</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">'key_value_accuracy/score'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br/></span></code></pre></div></div>
<p><img decoding=async loading=lazy alt="MLflow UI showing the metric key_value_accuracy computed for a single run" src=/mlflow-website/assets/images/new_eval_metrics-f4f9d78ac0ec4f4cdd219609148ba487.png width=3406 height=1336 class=img_ev3q /></p>
<p>This metric requires an exact match between the key-value pairs in the ground truth and the LLM-generated output. Upon reviewing the individual scores for each image, we observe that the model performs the worst on the last image. Specifically, one of the keys is incorrectly generated as <code>CHAINS - ACCEPTANCEMERCHANDISING</code> instead of <code>CHAINS ACCEPTANCE/ MERCHANDISING</code>. A similar pattern can be observed in other keys where different topics are improperly separated or unnecessarily paraphrased.</p>
<p>To address this, we can refine the prompt template by explicitly instructing the model to separate distinct topics using the <code>/</code> separator. Additionally, we can instruct the LLM to avoid paraphrasing the topics in the keys and instead focus on maintaining exactness to the image text.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token plain">updated_template </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""\</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">You are an expert at key information extraction and OCR. Extract the questions and answers from the image, where the keys are questions and the values are answers.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">Question refers to a field in the form that takes in information. Answer refers to the information</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">that is filled in the field.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="display:inline-block;color:rgb(206, 145, 120)"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">Follow these rules:</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">- Only use the information present in the text and do not paraphrase.</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">- If the keys have multiple topics, separate them with a slash (/)</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">{{ additional_rules }}</span><br/></span><span class=token-line style=color:#9CDCFE><span class="token triple-quoted-string string" style="color:rgb(206, 145, 120)">"""</span><br/></span></code></pre></div></div>
<p>The next step is to register the updated prompt template, load it back later and format it with any additional rule before rerunning the evaluation.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#9CDCFE;--prism-background-color:#1E1E1E><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#9CDCFE;background-color:#1E1E1E><code class=codeBlockLines_e6Vv><span class=token-line style=color:#9CDCFE><span class="token plain">updated_prompt </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">genai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">register_prompt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    name</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"ocr-question-answer"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    template</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">updated_template</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    commit_message</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"Update commit"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    tags</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">"author"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"author@example.com"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">"task"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"ocr"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">"language"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"en"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Load the updated prompt and format it with additional rules</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">prompt </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">genai</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">load_prompt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">name_or_uri</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"ocr-question-answer"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> version</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">updated_prompt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">version</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">system_prompt </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> prompt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token builtin" style="color:rgb(86, 156, 214)">format</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">additional_rules</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"Use exact formatting you see in the form."</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">results_updated </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">models</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">evaluate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    model</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">batch_completion</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    data</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">pd</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">DataFrame</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">"inputs"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> images</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">"truth"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> annotation_normalized</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    targets</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"truth"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    model_type</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"text"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    predictions</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">"predictions"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">    extra_metrics</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">custom_key_value_accuracy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"Custom metric results:"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> results_updated</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">metrics</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain">eval_table_updated </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> results_updated</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tables</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">"eval_results_table"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">"\n Per-row scores:"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#9CDCFE><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">eval_table_updated</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">'key_value_accuracy/score'</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br/></span></code></pre></div></div>
<p>This updated prompt may lead to a marginal improvement in the metric for each image. However, there are still mismatches in values between the ground truth and the LLM response. As showcased above using Prompt Registry, iteratively refining the prompt can address these issues, leading to better alignment with the expected output.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=conclusion-and-next-steps>Conclusion and Next Steps<a href=#conclusion-and-next-steps class=hash-link aria-label="Direct link to Conclusion and Next Steps" title="Direct link to Conclusion and Next Steps" translate=no>​</a></h2>
<p>By leveraging MLflow GenAI capabilities, we efficiently manage prompts and evaluate models for our OCR tool. With all runs, prompts, and metrics logged, we can compare different models or prompt strategies side-by-side in the MLflow UI. This enables data-driven decisions, justifies model selection, and enables both technical and non-technical contributors to collaborate, iterate, and deploy AI solutions confidently.</p>
<p>We can take several directions to further enhance our workflow and outcomes:</p>
<p><strong>Expand Your Custom Metrics:</strong> Scale out your custom evaluation metrics to more accurately capture the requirements of our specific OCR problem. This allows us to measure what truly matters for the use case, such as domain-specific accuracy, formatting compliance, or business logic adherence.</p>
<p><strong>Experiment with Multiple LLMs:</strong> Take advantage of MLflow’s ability to track and compare experiments by iterating with different LLMs. We can view and analyze results side-by-side in the MLflow UI, making it easier to identify which model best fits our needs and to justify model selection with clear, data-driven evidence.</p>
<p><strong>Utilize Tracing and Model Logging:</strong> Leverage MLflow’s tracing and model logging features to gain end-to-end visibility into our GenAI workflows. By capturing detailed traces and logs, we can iteratively refine our models and prompts, diagnose issues, and ensure reproducibility—all within the context of our custom metrics.</p>
<p><strong>Expand Governance and Access Control</strong>: Implement robust governance practices to ensure secure, compliant, and auditable management of our GenAI assets and workflows. This is especially important for scaling in enterprise or regulated environments.</p>
<p>These are just a few of the many ways we can build on this solution. Whether we are aiming to improve model performance, streamline collaboration, or scale our solution to new domains, these MLflow capabilities support us in our GenAI development.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=further-reading>Further Reading<a href=#further-reading class=hash-link aria-label="Direct link to Further Reading" title="Direct link to Further Reading" translate=no>​</a></h2>
<p><a href=https://mlflow.org/blog/ai-observability-mlflow-tracing target=_blank rel="noopener noreferrer" class="">Practical AI Observability: Getting Started with MLflow Tracing</a><br/>
<a href=https://mlflow.org/blog/custom-tracing target=_blank rel="noopener noreferrer" class="">Beyond Autolog: Add MLflow Tracing to a New LLM Provider</a><br/>
<a href=https://mlflow.org/blog/llm-as-judge target=_blank rel="noopener noreferrer" class="">LLM as Judge</a></div><footer class=docusaurus-mt-lg><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class=col><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class=tag_QGVx><a rel=tag class="tag_zVej tagRegular_sFm0" href=/mlflow-website/blog/tags/mlflow>mlflow</a><li class=tag_QGVx><a rel=tag class="tag_zVej tagRegular_sFm0" href=/mlflow-website/blog/tags/genai>genai</a><li class=tag_QGVx><a rel=tag class="tag_zVej tagRegular_sFm0" href=/mlflow-website/blog/tags/evaluation>evaluation</a><li class=tag_QGVx><a rel=tag class="tag_zVej tagRegular_sFm0" href=/mlflow-website/blog/tags/prompt-registry>prompt-registry</a><li class=tag_QGVx><a rel=tag class="tag_zVej tagRegular_sFm0" href=/mlflow-website/blog/tags/tracing>tracing</a></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href=/mlflow-website/blog/custom-llm-judges-make-judge><div class=pagination-nav__sublabel>Newer post</div><div class=pagination-nav__label>Beyond Manually Crafted LLM Judges: Automate Building Domain-Specific Evaluators with MLflow</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/mlflow-website/blog/mlflow-assessment-ui><div class=pagination-nav__sublabel>Older post</div><div class=pagination-nav__label>Assessment-focused UIs in MLflow</div></a></nav></div></div></div></div></main><footer class="relative pb-30 flex flex-col pt-30"><div style="position:absolute;width:100%;bottom:0;pointer-events:none;mask-composite:intersect;height:360px;background-image:repeating-linear-gradient(
        to right,
        rgba(0, 0, 0, 0.05),
        rgba(0, 0, 0, 0.25) 18px,
        transparent 2px,
        transparent 10px
      ),
      radial-gradient(
        circle at bottom center,
        var(--color-brand-red) 0%,
        transparent 60%
      ),
      linear-gradient(to right, color-mix(in srgb, var(--color-brand-red), oklch(0.33 0.15 328.37) 80%), color-mix(in srgb, var(--color-brand-red), oklch(0.66 0.17 248.82) 100%));mask-image:radial-gradient(ellipse at center bottom, black 60%, transparent 80%),
      linear-gradient(to top, black 10%, transparent 40%)"></div><div class=z-1><div class="flex flex-row justify-between items-start px-6 lg:px-20 gap-10 xs:gap-0 max-w-container"><div class="flex flex-col gap-8"><svg xmlns=http://www.w3.org/2000/svg width=109 height=40 fill=none viewBox="0 0 109 40" class="h-[36px] shrink-0"><path fill=#fff d="M0 31.032v-15.53h3.543v1.968c.893-1.594 2.84-2.425 4.593-2.425 2.042 0 3.828.926 4.658 2.745 1.216-2.043 3.034-2.745 5.043-2.745 2.81 0 5.49 1.787 5.49 5.904v10.083h-3.574v-9.478c0-1.818-.926-3.19-3-3.19-1.947 0-3.224 1.53-3.224 3.445v9.22H9.893v-9.475c0-1.786-.898-3.18-3.003-3.18-1.977 0-3.223 1.467-3.223 3.444v9.221ZM27.855 31.032V7.929h3.703v23.103ZM30.07 39.487c.833.232 1.582.383 3.17.383 2.953 0 6.436-1.665 7.353-6.339l3.786-18.739h5.629l.687-3.117h-5.686l.765-3.725c.586-2.892 2.186-4.358 4.754-4.358.668 0 .48.058 1.076.17L52.427.57c-.793-.237-1.503-.379-3.049-.379a7.32 7.32 0 0 0-4.528 1.484c-1.441 1.114-2.393 2.75-2.827 4.863l-1.066 5.137h-5.034l-.411 3.12h4.823L36.859 32.12c-.383 1.965-1.5 4.315-4.708 4.315-.727 0-.463-.055-1.121-.162ZM53.342 30.905H49.64l5.074-23.309h3.701ZM71.807 16.477A7.962 7.962 0 0 0 60.97 27.904l2.425-1.78a5.005 5.005 0 0 1 3.845-8.145v1.895ZM62.618 29.472a7.962 7.962 0 0 0 10.836-11.428l-2.425 1.78a5.005 5.005 0 0 1-3.845 8.145v-1.894ZM78.092 15.493h4.044l.823 10.612 5.759-10.612 3.839.055 1.508 10.557 5.074-10.612 3.701.055-7.678 15.493H91.46l-1.783-11.106-5.895 11.106h-3.84ZM105.072 15.768h-.766v-.266h1.845v.272h-.765v2.243h-.314ZM106.614 15.502h.383l.482 1.34q.091.259.178.524h.018c.059-.176.113-.352.172-.524l.478-1.34h.383v2.515h-.298V16.63c0-.22.024-.523.04-.747h-.016l-.191.574-.475 1.304h-.208l-.481-1.302-.191-.574h-.015c.017.224.042.527.042.747v1.387h-.291Z"/></svg><div class="text-xs text-gray-800 text-left md:text-nowrap md:w-0">© 2025 MLflow Project, a Series of LF Projects, LLC.</div></div><div class="flex flex-col flex-wrap justify-end md:text-right md:flex-row gap-x-10 lg:gap-x-20 gap-y-5 w-2/5 md:w-auto md:pt-2 max-w-fit"><div><a href=/mlflow-website/>Components</a></div><div><a href=/mlflow-website/releases>Releases</a></div><div><a href=/mlflow-website/blog>Blog</a></div><div><a href=https://mlflow.org/docs/latest/ target=_blank rel="noopener noreferrer">Docs</a></div><div><a href=/mlflow-website/ambassadors>Ambassador Program</a></div></div></div></div></footer></div></div></div></body>