"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[6088],{16581:(e,n,s)=>{s.d(n,{p:()=>i});var a=s(74848);const i=({children:e,isStderr:n})=>(0,a.jsx)("pre",{style:{margin:0,borderRadius:0,background:"none",fontSize:"0.85rem",flexGrow:1,padding:"var(--padding-sm)"},children:e})},23049:(e,n,s)=>{s.d(n,{A:()=>a});const a=s.p+"assets/images/dspy-trace-bd339ce15bda9cbb5f88a48a24c2bbf4.png"},27594:(e,n,s)=>{s.d(n,{O:()=>o});var a=s(96540),i=s(74848);function o({children:e,href:n}){const s=(0,a.useCallback)(async e=>{if(e.preventDefault(),window.gtag)try{window.gtag("event","notebook-download",{href:n})}catch{}const s=await fetch(n),a=await s.blob(),i=window.URL.createObjectURL(a),o=document.createElement("a");o.style.display="none",o.href=i;const t=n.split("/").pop();o.download=t,document.body.appendChild(o),o.click(),window.URL.revokeObjectURL(i),document.body.removeChild(o)},[n]);return(0,i.jsx)("a",{className:"button button--primary",style:{marginBottom:"1rem",display:"block",width:"min-content"},href:n,download:!0,onClick:s,children:e})}},34083:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>p,default:()=>u,frontMatter:()=>d,metadata:()=>a,toc:()=>m});const a=JSON.parse('{"id":"flavors/dspy/notebooks/dspy_quickstart-ipynb","title":"DSPy Quickstart","description":"Download this notebook","source":"@site/docs/genai/flavors/dspy/notebooks/dspy_quickstart-ipynb.mdx","sourceDirName":"flavors/dspy/notebooks","slug":"/flavors/dspy/notebooks/dspy_quickstart","permalink":"/mlflow-website/docs/latest/genai/flavors/dspy/notebooks/dspy_quickstart","draft":false,"unlisted":false,"editUrl":"https://github.com/mlflow/mlflow/edit/master/docs/docs/genai/flavors/dspy/notebooks/dspy_quickstart.ipynb","tags":[],"version":"current","frontMatter":{"custom_edit_url":"https://github.com/mlflow/mlflow/edit/master/docs/docs/genai/flavors/dspy/notebooks/dspy_quickstart.ipynb","slug":"dspy_quickstart"},"sidebar":"genAISidebar","previous":{"title":"MLflow DSPy Flavor","permalink":"/mlflow-website/docs/latest/genai/flavors/dspy/"},"next":{"title":"Using DSPy Optimizers","permalink":"/mlflow-website/docs/latest/genai/flavors/dspy/optimizer"}}');var i=s(74848),o=s(28453),t=s(75983),r=s(16581),l=(s(81226),s(27594));const d={custom_edit_url:"https://github.com/mlflow/mlflow/edit/master/docs/docs/genai/flavors/dspy/notebooks/dspy_quickstart.ipynb",slug:"dspy_quickstart"},p="DSPy Quickstart",c={},m=[{value:"How does it work?",id:"how-does-it-work",level:2},{value:"This Demo",id:"this-demo",level:2},{value:"Setup",id:"setup",level:2},{value:"Set Up LLM",id:"set-up-llm",level:3},{value:"Create MLflow Experiment",id:"create-mlflow-experiment",level:3},{value:"Turn on Auto Tracing with MLflow",id:"turn-on-auto-tracing-with-mlflow",level:3},{value:"Set Up Data",id:"set-up-data",level:3},{value:"Set up DSPy Signature and Module",id:"set-up-dspy-signature-and-module",level:3},{value:"Run it!",id:"run-it",level:2},{value:"Hello World",id:"hello-world",level:3},{value:"Review Traces",id:"review-traces",level:3},{value:"Compilation",id:"compilation",level:2},{value:"Training",id:"training",level:3},{value:"Compare Pre/Post Compiled Accuracy",id:"compare-prepost-compiled-accuracy",level:3},{value:"Log and Load the Model with MLflow",id:"log-and-load-the-model-with-mlflow",level:2},{value:"Next Steps",id:"next-steps",level:2},{value:"DSPy",id:"dspy",level:3},{value:"MLflow",id:"mlflow",level:3}];function f(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"dspy-quickstart",children:"DSPy Quickstart"})}),"\n",(0,i.jsx)(l.O,{href:"https://raw.githubusercontent.com/mlflow/mlflow/master/docs/docs/genai/flavors/dspy/notebooks/dspy_quickstart.ipynb",children:"Download this notebook"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://dspy-docs.vercel.app/",children:"DSPy"}),' simplifies building language model (LM) pipelines by replacing manual prompt engineering with structured "text transformation graphs." These graphs use flexible, learning modules that automate and optimize LM tasks like reasoning, retrieval, and answering complex questions.']}),"\n",(0,i.jsx)(n.h2,{id:"how-does-it-work",children:"How does it work?"}),"\n",(0,i.jsx)(n.p,{children:"At a high level, DSPy optimizes prompts, selects the best language model, and can even fine-tune the model using training data."}),"\n",(0,i.jsxs)(n.p,{children:["The process follows these three steps, common to most DSPy ",(0,i.jsx)(n.a,{href:"https://dspy.ai/learn/optimization/optimizers/",children:"optimizers"}),":"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Candidate Generation"}),": DSPy finds all ",(0,i.jsx)(n.code,{children:"Predict"})," modules in the program and generates variations of instructions and demonstrations (e.g., examples for prompts). This step creates a set of possible candidates for the next stage."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Parameter Optimization"}),": DSPy then uses methods like random search, TPE, or Optuna to select the best candidate. Fine-tuning models can also be done at this stage."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"this-demo",children:"This Demo"}),"\n",(0,i.jsx)(n.p,{children:"Below we create a simple program that demonstrates the power of DSPy. We will build a text classifier leveraging OpenAI. By the end of this tutorial, we will..."}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Define a ",(0,i.jsx)(n.a,{href:"https://dspy.ai/learn/programming/signatures/",children:"dspy.Signature"})," and ",(0,i.jsx)(n.a,{href:"https://dspy.ai/learn/programming/modules/",children:"dspy.Module"})," to perform text classification."]}),"\n",(0,i.jsxs)(n.li,{children:["Leverage ",(0,i.jsx)(n.a,{href:"https://dspy-docs.vercel.app/api/optimizers/BootstrapFewShotWithRandomSearch",children:"dspy.teleprompt.BootstrapFewShotWithRandomSearch"})," to compile our module so it's better at classifying our text."]}),"\n",(0,i.jsx)(n.li,{children:"Analyze internal steps with MLflow Tracing."}),"\n",(0,i.jsx)(n.li,{children:"Log the compiled model with MLflow."}),"\n",(0,i.jsx)(n.li,{children:"Load the logged model and perform inference."}),"\n"]}),"\n",(0,i.jsx)(t.d,{executionCount:5,children:'%pip install -U openai "dspy>=2.5.17" "mlflow>=2.18.0"'}),"\n",(0,i.jsx)(r.p,{children:"Requirement already satisfied: openai in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (1.102.0)\nRequirement already satisfied: dspy>=2.5.17 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (3.0.2)\nRequirement already satisfied: mlflow>=2.18.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (3.3.2)\nRequirement already satisfied: tqdm>4 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from openai) (4.67.1)\nRequirement already satisfied: distro<2,>=1.7.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from openai) (1.9.0)\nRequirement already satisfied: pydantic<3,>=1.9.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from openai) (2.11.7)\nRequirement already satisfied: sniffio in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from openai) (1.3.1)\nRequirement already satisfied: typing-extensions<5,>=4.11 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from openai) (4.15.0)\nRequirement already satisfied: anyio<5,>=3.5.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from openai) (4.10.0)\nRequirement already satisfied: jiter<1,>=0.4.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from openai) (0.10.0)\nRequirement already satisfied: httpx<1,>=0.23.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from openai) (0.28.1)\nRequirement already satisfied: xxhash>=3.5.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from dspy>=2.5.17) (3.5.0)\nRequirement already satisfied: backoff>=2.2 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from dspy>=2.5.17) (2.2.1)\nRequirement already satisfied: gepa[dspy]==0.0.4 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from dspy>=2.5.17) (0.0.4)\nRequirement already satisfied: joblib~=1.3 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from dspy>=2.5.17) (1.5.2)\nRequirement already satisfied: regex>=2023.10.3 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from dspy>=2.5.17) (2025.7.34)\nRequirement already satisfied: requests>=2.31.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from dspy>=2.5.17) (2.32.5)\nRequirement already satisfied: rich>=13.7.1 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from dspy>=2.5.17) (14.1.0)\nRequirement already satisfied: asyncer==0.0.8 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from dspy>=2.5.17) (0.0.8)\nRequirement already satisfied: ujson>=5.8.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from dspy>=2.5.17) (5.11.0)\nRequirement already satisfied: optuna>=3.4.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from dspy>=2.5.17) (4.5.0)\nRequirement already satisfied: cachetools>=5.5.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from dspy>=2.5.17) (5.5.2)\nRequirement already satisfied: numpy>=1.26.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from dspy>=2.5.17) (2.2.6)\nRequirement already satisfied: diskcache>=5.6.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from dspy>=2.5.17) (5.6.3)\nRequirement already satisfied: litellm>=1.64.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from dspy>=2.5.17) (1.76.0)\nRequirement already satisfied: json-repair>=0.30.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from dspy>=2.5.17) (0.50.0)\nRequirement already satisfied: cloudpickle>=3.0.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from dspy>=2.5.17) (3.1.1)\nRequirement already satisfied: tenacity>=8.2.3 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from dspy>=2.5.17) (9.1.2)\nRequirement already satisfied: magicattr>=0.1.6 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from dspy>=2.5.17) (0.1.6)\nIgnoring litellm: markers 'extra != \"dspy\"' don't match your environment\nIgnoring datasets: markers 'extra != \"dspy\"' don't match your environment\nRequirement already satisfied: gunicorn<24 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from mlflow>=2.18.0) (23.0.0)\nRequirement already satisfied: scipy<2 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from mlflow>=2.18.0) (1.15.3)\nRequirement already satisfied: sqlalchemy<3,>=1.4.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from mlflow>=2.18.0) (2.0.43)\nRequirement already satisfied: pandas<3 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from mlflow>=2.18.0) (2.3.2)\nRequirement already satisfied: mlflow-tracing==3.3.2 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from mlflow>=2.18.0) (3.3.2)\nRequirement already satisfied: pyarrow<22,>=4.0.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from mlflow>=2.18.0) (21.0.0)\nRequirement already satisfied: Flask<4 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from mlflow>=2.18.0) (3.1.2)\nRequirement already satisfied: cryptography<46,>=43.0.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from mlflow>=2.18.0) (45.0.6)\nRequirement already satisfied: alembic!=1.10.0,<2 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from mlflow>=2.18.0) (1.16.5)\nRequirement already satisfied: scikit-learn<2 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from mlflow>=2.18.0) (1.7.1)\nRequirement already satisfied: docker<8,>=4.0.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from mlflow>=2.18.0) (7.1.0)\nRequirement already satisfied: matplotlib<4 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from mlflow>=2.18.0) (3.10.5)\nRequirement already satisfied: graphene<4 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from mlflow>=2.18.0) (3.4.3)\nRequirement already satisfied: mlflow-skinny==3.3.2 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from mlflow>=2.18.0) (3.3.2)\nRequirement already satisfied: pyyaml<7,>=5.1 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from mlflow-skinny==3.3.2->mlflow>=2.18.0) (6.0.2)\nRequirement already satisfied: protobuf<7,>=3.12.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from mlflow-skinny==3.3.2->mlflow>=2.18.0) (6.32.0)\nRequirement already satisfied: databricks-sdk<1,>=0.20.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from mlflow-skinny==3.3.2->mlflow>=2.18.0) (0.64.0)\nRequirement already satisfied: packaging<26 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from mlflow-skinny==3.3.2->mlflow>=2.18.0) (25.0)\nRequirement already satisfied: sqlparse<1,>=0.4.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from mlflow-skinny==3.3.2->mlflow>=2.18.0) (0.5.3)\nRequirement already satisfied: click<9,>=7.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from mlflow-skinny==3.3.2->mlflow>=2.18.0) (8.2.1)\nRequirement already satisfied: importlib_metadata!=4.7.0,<9,>=3.7.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from mlflow-skinny==3.3.2->mlflow>=2.18.0) (8.7.0)\nRequirement already satisfied: uvicorn<1 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from mlflow-skinny==3.3.2->mlflow>=2.18.0) (0.35.0)\nRequirement already satisfied: opentelemetry-api<3,>=1.9.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from mlflow-skinny==3.3.2->mlflow>=2.18.0) (1.36.0)\nRequirement already satisfied: opentelemetry-sdk<3,>=1.9.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from mlflow-skinny==3.3.2->mlflow>=2.18.0) (1.36.0)\nRequirement already satisfied: gitpython<4,>=3.1.9 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from mlflow-skinny==3.3.2->mlflow>=2.18.0) (3.1.45)\nRequirement already satisfied: fastapi<1 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from mlflow-skinny==3.3.2->mlflow>=2.18.0) (0.116.1)\nRequirement already satisfied: Mako in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from alembic!=1.10.0,<2->mlflow>=2.18.0) (1.3.10)\nRequirement already satisfied: tomli in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from alembic!=1.10.0,<2->mlflow>=2.18.0) (2.2.1)\nRequirement already satisfied: exceptiongroup>=1.0.2 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from anyio<5,>=3.5.0->openai) (1.3.0)\nRequirement already satisfied: idna>=2.8 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from anyio<5,>=3.5.0->openai) (3.10)\nRequirement already satisfied: cffi>=1.14 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from cryptography<46,>=43.0.0->mlflow>=2.18.0) (1.17.1)\nRequirement already satisfied: urllib3>=1.26.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from docker<8,>=4.0.0->mlflow>=2.18.0) (2.5.0)\nRequirement already satisfied: jinja2>=3.1.2 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from Flask<4->mlflow>=2.18.0) (3.1.6)\nRequirement already satisfied: blinker>=1.9.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from Flask<4->mlflow>=2.18.0) (1.9.0)\nRequirement already satisfied: markupsafe>=2.1.1 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from Flask<4->mlflow>=2.18.0) (3.0.2)\nRequirement already satisfied: werkzeug>=3.1.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from Flask<4->mlflow>=2.18.0) (3.1.3)\nRequirement already satisfied: itsdangerous>=2.2.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from Flask<4->mlflow>=2.18.0) (2.2.0)\nRequirement already satisfied: python-dateutil<3,>=2.7.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from graphene<4->mlflow>=2.18.0) (2.9.0.post0)\nRequirement already satisfied: graphql-core<3.3,>=3.1 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from graphene<4->mlflow>=2.18.0) (3.2.6)\nRequirement already satisfied: graphql-relay<3.3,>=3.1 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from graphene<4->mlflow>=2.18.0) (3.2.0)\nRequirement already satisfied: certifi in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from httpx<1,>=0.23.0->openai) (2025.8.3)\nRequirement already satisfied: httpcore==1.* in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from httpx<1,>=0.23.0->openai) (1.0.9)\nRequirement already satisfied: h11>=0.16 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from httpcore==1.*->httpx<1,>=0.23.0->openai) (0.16.0)\nRequirement already satisfied: aiohttp>=3.10 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from litellm>=1.64.0->dspy>=2.5.17) (3.12.15)\nRequirement already satisfied: python-dotenv>=0.2.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from litellm>=1.64.0->dspy>=2.5.17) (1.1.1)\nRequirement already satisfied: tokenizers in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from litellm>=1.64.0->dspy>=2.5.17) (0.21.4)\nRequirement already satisfied: jsonschema<5.0.0,>=4.22.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from litellm>=1.64.0->dspy>=2.5.17) (4.25.1)\nRequirement already satisfied: tiktoken>=0.7.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from litellm>=1.64.0->dspy>=2.5.17) (0.11.0)\nRequirement already satisfied: kiwisolver>=1.3.1 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from matplotlib<4->mlflow>=2.18.0) (1.4.9)\nRequirement already satisfied: pillow>=8 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from matplotlib<4->mlflow>=2.18.0) (11.3.0)\nRequirement already satisfied: cycler>=0.10 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from matplotlib<4->mlflow>=2.18.0) (0.12.1)\nRequirement already satisfied: fonttools>=4.22.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from matplotlib<4->mlflow>=2.18.0) (4.59.2)\nRequirement already satisfied: contourpy>=1.0.1 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from matplotlib<4->mlflow>=2.18.0) (1.3.2)\nRequirement already satisfied: pyparsing>=2.3.1 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from matplotlib<4->mlflow>=2.18.0) (3.2.3)\nRequirement already satisfied: colorlog in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from optuna>=3.4.0->dspy>=2.5.17) (6.9.0)\nRequirement already satisfied: pytz>=2020.1 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from pandas<3->mlflow>=2.18.0) (2025.2)\nRequirement already satisfied: tzdata>=2022.7 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from pandas<3->mlflow>=2.18.0) (2025.2)\nRequirement already satisfied: pydantic-core==2.33.2 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from pydantic<3,>=1.9.0->openai) (2.33.2)\nRequirement already satisfied: typing-inspection>=0.4.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from pydantic<3,>=1.9.0->openai) (0.4.1)\nRequirement already satisfied: annotated-types>=0.6.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from pydantic<3,>=1.9.0->openai) (0.7.0)\nRequirement already satisfied: charset_normalizer<4,>=2 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from requests>=2.31.0->dspy>=2.5.17) (3.4.3)\nRequirement already satisfied: pygments<3.0.0,>=2.13.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from rich>=13.7.1->dspy>=2.5.17) (2.19.2)\nRequirement already satisfied: markdown-it-py>=2.2.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from rich>=13.7.1->dspy>=2.5.17) (4.0.0)\nRequirement already satisfied: threadpoolctl>=3.1.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from scikit-learn<2->mlflow>=2.18.0) (3.6.0)\nRequirement already satisfied: propcache>=0.2.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from aiohttp>=3.10->litellm>=1.64.0->dspy>=2.5.17) (0.3.2)\nRequirement already satisfied: aiosignal>=1.4.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from aiohttp>=3.10->litellm>=1.64.0->dspy>=2.5.17) (1.4.0)\nRequirement already satisfied: attrs>=17.3.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from aiohttp>=3.10->litellm>=1.64.0->dspy>=2.5.17) (25.3.0)\nRequirement already satisfied: yarl<2.0,>=1.17.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from aiohttp>=3.10->litellm>=1.64.0->dspy>=2.5.17) (1.20.1)\nRequirement already satisfied: async-timeout<6.0,>=4.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from aiohttp>=3.10->litellm>=1.64.0->dspy>=2.5.17) (5.0.1)\nRequirement already satisfied: multidict<7.0,>=4.5 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from aiohttp>=3.10->litellm>=1.64.0->dspy>=2.5.17) (6.6.4)\nRequirement already satisfied: frozenlist>=1.1.1 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from aiohttp>=3.10->litellm>=1.64.0->dspy>=2.5.17) (1.7.0)\nRequirement already satisfied: aiohappyeyeballs>=2.5.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from aiohttp>=3.10->litellm>=1.64.0->dspy>=2.5.17) (2.6.1)\nRequirement already satisfied: pycparser in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from cffi>=1.14->cryptography<46,>=43.0.0->mlflow>=2.18.0) (2.22)\nRequirement already satisfied: google-auth~=2.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from databricks-sdk<1,>=0.20.0->mlflow-skinny==3.3.2->mlflow>=2.18.0) (2.40.3)\nRequirement already satisfied: starlette<0.48.0,>=0.40.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from fastapi<1->mlflow-skinny==3.3.2->mlflow>=2.18.0) (0.47.3)\nRequirement already satisfied: gitdb<5,>=4.0.1 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from gitpython<4,>=3.1.9->mlflow-skinny==3.3.2->mlflow>=2.18.0) (4.0.12)\nRequirement already satisfied: zipp>=3.20 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from importlib_metadata!=4.7.0,<9,>=3.7.0->mlflow-skinny==3.3.2->mlflow>=2.18.0) (3.23.0)\nRequirement already satisfied: rpds-py>=0.7.1 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from jsonschema<5.0.0,>=4.22.0->litellm>=1.64.0->dspy>=2.5.17) (0.27.1)\nRequirement already satisfied: jsonschema-specifications>=2023.03.6 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from jsonschema<5.0.0,>=4.22.0->litellm>=1.64.0->dspy>=2.5.17) (2025.4.1)\nRequirement already satisfied: referencing>=0.28.4 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from jsonschema<5.0.0,>=4.22.0->litellm>=1.64.0->dspy>=2.5.17) (0.36.2)\nRequirement already satisfied: mdurl~=0.1 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from markdown-it-py>=2.2.0->rich>=13.7.1->dspy>=2.5.17) (0.1.2)\nRequirement already satisfied: opentelemetry-semantic-conventions==0.57b0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from opentelemetry-sdk<3,>=1.9.0->mlflow-skinny==3.3.2->mlflow>=2.18.0) (0.57b0)\nRequirement already satisfied: six>=1.5 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from python-dateutil<3,>=2.7.0->graphene<4->mlflow>=2.18.0) (1.17.0)\nRequirement already satisfied: datasets>=2.14.6 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from gepa[dspy]==0.0.4->dspy>=2.5.17) (4.0.0)\nRequirement already satisfied: huggingface-hub<1.0,>=0.16.4 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from tokenizers->litellm>=1.64.0->dspy>=2.5.17) (0.34.4)\nRequirement already satisfied: fsspec[http]<=2025.3.0,>=2023.1.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from datasets>=2.14.6->gepa[dspy]==0.0.4->dspy>=2.5.17) (2025.3.0)\nRequirement already satisfied: multiprocess<0.70.17 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from datasets>=2.14.6->gepa[dspy]==0.0.4->dspy>=2.5.17) (0.70.16)\nRequirement already satisfied: filelock in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from datasets>=2.14.6->gepa[dspy]==0.0.4->dspy>=2.5.17) (3.19.1)\nRequirement already satisfied: dill<0.3.9,>=0.3.0 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from datasets>=2.14.6->gepa[dspy]==0.0.4->dspy>=2.5.17) (0.3.8)\nRequirement already satisfied: smmap<6,>=3.0.1 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from gitdb<5,>=4.0.1->gitpython<4,>=3.1.9->mlflow-skinny==3.3.2->mlflow>=2.18.0) (5.0.2)\nRequirement already satisfied: pyasn1-modules>=0.2.1 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from google-auth~=2.0->databricks-sdk<1,>=0.20.0->mlflow-skinny==3.3.2->mlflow>=2.18.0) (0.4.2)\nRequirement already satisfied: rsa<5,>=3.1.4 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from google-auth~=2.0->databricks-sdk<1,>=0.20.0->mlflow-skinny==3.3.2->mlflow>=2.18.0) (4.9.1)\nRequirement already satisfied: hf-xet<2.0.0,>=1.1.3 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from huggingface-hub<1.0,>=0.16.4->tokenizers->litellm>=1.64.0->dspy>=2.5.17) (1.1.9)\nRequirement already satisfied: pyasn1<0.7.0,>=0.6.1 in /Users/jacobdanner/Repos/open-source/mlflow/venv/lib/python3.10/site-packages (from pyasn1-modules>=0.2.1->google-auth~=2.0->databricks-sdk<1,>=0.20.0->mlflow-skinny==3.3.2->mlflow>=2.18.0) (0.6.1)\n\n\x1b[1m[\x1b[0m\x1b[34;49mnotice\x1b[0m\x1b[1;39;49m]\x1b[0m\x1b[39;49m A new release of pip is available: \x1b[0m\x1b[31;49m23.0.1\x1b[0m\x1b[39;49m -> \x1b[0m\x1b[32;49m25.2\x1b[0m\n\x1b[1m[\x1b[0m\x1b[34;49mnotice\x1b[0m\x1b[1;39;49m]\x1b[0m\x1b[39;49m To update, run: \x1b[0m\x1b[32;49mpip install --upgrade pip\x1b[0m\nNote: you may need to restart the kernel to use updated packages."}),"\n",(0,i.jsx)(n.h2,{id:"setup",children:"Setup"}),"\n",(0,i.jsx)(n.h3,{id:"set-up-llm",children:"Set Up LLM"}),"\n",(0,i.jsxs)(n.p,{children:["After installing the relevant dependencies, let's set up access to an OpenAI LLM. Here, will leverage OpenAI's ",(0,i.jsx)(n.code,{children:"gpt-4o-mini"})," model."]}),"\n",(0,i.jsx)(t.d,{executionCount:" ",children:'# Set OpenAI API Key to the environment variable. You can also pass the token to dspy.LM()\nimport getpass\nimport os\n\nos.environ["OPENAI_API_KEY"] = getpass.getpass("Enter your OpenAI Key:")'}),"\n",(0,i.jsx)(t.d,{executionCount:8,children:'import dspy\n\n# Define your model. We will use OpenAI for simplicity\nmodel_name = "gpt-4o-mini"\n\n# Note that an OPENAI_API_KEY environment must be present. You can also pass the token to dspy.LM()\nlm = dspy.LM(\n  model=f"openai/{model_name}",\n  max_tokens=500,\n  temperature=0.1,\n)\ndspy.settings.configure(lm=lm)'}),"\n",(0,i.jsx)(n.h3,{id:"create-mlflow-experiment",children:"Create MLflow Experiment"}),"\n",(0,i.jsx)(n.p,{children:'Create a new MLflow Experiment to track your DSPy models, metrics, parameters, and traces in one place. Although there is already a "default" experiment created in your workspace, it is highly recommended to create one for different tasks to organize experiment artifacts.'}),"\n",(0,i.jsx)(t.d,{executionCount:" ",children:'import mlflow\n\nmlflow.set_experiment("DSPy Quickstart")'}),"\n",(0,i.jsx)(n.h3,{id:"turn-on-auto-tracing-with-mlflow",children:"Turn on Auto Tracing with MLflow"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://mlflow.org/docs/latest/llms/tracing/index.html",children:"MLflow Tracing"})," is a powerful observability tool for monitoring and debugging what happens inside your DSPy modules, helping you identify potential bottlenecks or issues quickly. To enable DSPy tracing, you just need to call ",(0,i.jsx)(n.code,{children:"mlflow.dspy.autolog"})," and that's it!"]}),"\n",(0,i.jsx)(t.d,{executionCount:" ",children:"mlflow.dspy.autolog()"}),"\n",(0,i.jsx)(n.h3,{id:"set-up-data",children:"Set Up Data"}),"\n",(0,i.jsxs)(n.p,{children:["Next, we will download the ",(0,i.jsx)(n.a,{href:"https://huggingface.co/datasets/yangwang825/reuters-21578",children:"Reuters 21578"})," dataset from Huggingface. We also write a utility to ensure that our train/test split has the same labels."]}),"\n",(0,i.jsx)(t.d,{executionCount:" ",children:'import numpy as np\nimport pandas as pd\nfrom datasets import load_dataset\nfrom dspy.datasets.dataset import Dataset\n\n\ndef read_data_and_subset_to_categories() -> tuple[pd.DataFrame]:\n  """\n  Read the reuters-21578 dataset. Docs can be found in the url below:\n  https://huggingface.co/datasets/yangwang825/reuters-21578\n  """\n\n  # Read train/test split\n  dataset = load_dataset("yangwang825/reuters-21578")\n  train = pd.DataFrame(dataset["train"])\n  test = pd.DataFrame(dataset["test"])\n\n  # Clean the labels\n  label_map = {\n      0: "acq",\n      1: "crude",\n      2: "earn",\n      3: "grain",\n      4: "interest",\n      5: "money-fx",\n      6: "ship",\n      7: "trade",\n  }\n\n  train["label"] = train["label"].map(label_map)\n  test["label"] = test["label"].map(label_map)\n\n  return train, test\n\n\nclass CSVDataset(Dataset):\n  def __init__(\n      self, n_train_per_label: int = 20, n_test_per_label: int = 10, *args, **kwargs\n  ) -> None:\n      super().__init__(*args, **kwargs)\n      self.n_train_per_label = n_train_per_label\n      self.n_test_per_label = n_test_per_label\n\n      self._create_train_test_split_and_ensure_labels()\n\n  def _create_train_test_split_and_ensure_labels(self) -> None:\n      """Perform a train/test split that ensure labels in `dev` are also in `train`."""\n      # Read the data\n      train_df, test_df = read_data_and_subset_to_categories()\n\n      # Sample for each label\n      train_samples_df = pd.concat(\n          [group.sample(n=self.n_train_per_label) for _, group in train_df.groupby("label")]\n      )\n      test_samples_df = pd.concat(\n          [group.sample(n=self.n_test_per_label) for _, group in test_df.groupby("label")]\n      )\n\n      # Set DSPy class variables\n      self._train = train_samples_df.to_dict(orient="records")\n      self._dev = test_samples_df.to_dict(orient="records")\n\n\n# Limit to a small dataset to showcase the value of bootstrapping\ndataset = CSVDataset(n_train_per_label=3, n_test_per_label=1)\n\n# Create train and test sets containing DSPy\n# Note that we must specify the expected input value name\ntrain_dataset = [example.with_inputs("text") for example in dataset.train]\ntest_dataset = [example.with_inputs("text") for example in dataset.dev]\nunique_train_labels = {example.label for example in dataset.train}\n\nprint(len(train_dataset), len(test_dataset))\nprint(f"Train labels: {unique_train_labels}")\nprint(train_dataset[0])'}),"\n",(0,i.jsx)(r.p,{children:"24 8\nTrain labels: {'ship', 'earn', 'crude', 'trade', 'acq', 'grain', 'money-fx', 'interest'}\nExample({'text': 'manufacturers hanover mhc raises prime rate manufacturers hanover trust co became the third major u s bank to increase its prime rate to pct from matching a move initiated yesterday by citibank and chase manhattan the bank the main subsidiary of manufacturers hanover corp said the new rate is effective today reuter', 'label': 'interest'}) (input_keys={'text'})"}),"\n",(0,i.jsx)(n.h3,{id:"set-up-dspy-signature-and-module",children:"Set up DSPy Signature and Module"}),"\n",(0,i.jsx)(n.p,{children:"Finally, we will define our task: text classification."}),"\n",(0,i.jsx)(n.p,{children:"There are a variety of ways you can provide guidelines to DSPy signature behavior. Currently, DSPy allows users to specify:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"A high-level goal via the class docstring."}),"\n",(0,i.jsx)(n.li,{children:"A set of input fields, with optional metadata."}),"\n",(0,i.jsx)(n.li,{children:"A set of output fields with optional metadata."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"DSPy will then leverage this information to inform optimization."}),"\n",(0,i.jsxs)(n.p,{children:["In the below example, note that we simply provide the expected labels to ",(0,i.jsx)(n.code,{children:"output"})," field in the ",(0,i.jsx)(n.code,{children:"TextClassificationSignature"})," class. From this initial state, we'll look to use DSPy to learn to improve our classifier accuracy."]}),"\n",(0,i.jsx)(t.d,{executionCount:15,children:'class TextClassificationSignature(dspy.Signature):\n  text = dspy.InputField()\n  label = dspy.OutputField(\n      desc=f"Label of predicted class. Possible labels are {unique_train_labels}"\n  )\n\n\nclass TextClassifier(dspy.Module):\n  def __init__(self):\n      super().__init__()\n      self.generate_classification = dspy.Predict(TextClassificationSignature)\n\n  def forward(self, text: str):\n      return self.generate_classification(text=text)'}),"\n",(0,i.jsx)(n.h2,{id:"run-it",children:"Run it!"}),"\n",(0,i.jsx)(n.h3,{id:"hello-world",children:"Hello World"}),"\n",(0,i.jsxs)(n.p,{children:["Let's demonstrate predicting via the DSPy module and associated signature. The program has correctly learned our labels from the signature ",(0,i.jsx)(n.code,{children:"desc"})," field and generates reasonable predictions."]}),"\n",(0,i.jsx)(t.d,{executionCount:16,children:'from copy import copy\n\n# Initilize our impact_improvement class\ntext_classifier = copy(TextClassifier())\n\nmessage = "I am interested in space"\nprint(text_classifier(text=message))\n\nmessage = "I enjoy ice skating"\nprint(text_classifier(text=message))'}),"\n",(0,i.jsx)(r.p,{children:"Prediction(\n  label='interest'\n)\nPrediction(\n  label='interest'\n)"}),"\n",(0,i.jsx)(n.h3,{id:"review-traces",children:"Review Traces"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Open the MLflow UI and select the ",(0,i.jsx)(n.code,{children:'"DSPy Quickstart"'})," experiment."]}),"\n",(0,i.jsxs)(n.li,{children:["Go to the ",(0,i.jsx)(n.code,{children:'"Traces"'})," tab to view the generated traces."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Now, you can observe how DSPy translates your query and interacts with the LLM. This feature is extremely valuable for debugging, iteratively refining components within your system, and monitoring models in production. While the module in this tutorial is relatively simple, the tracing feature becomes even more powerful as your model grows in complexity."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"MLflow DSPy Trace",src:s(23049).A+"",width:"3104",height:"1710"})}),"\n",(0,i.jsx)(n.h2,{id:"compilation",children:"Compilation"}),"\n",(0,i.jsx)(n.h3,{id:"training",children:"Training"}),"\n",(0,i.jsxs)(n.p,{children:["To train, we will leverage ",(0,i.jsx)(n.a,{href:"https://dspy-docs.vercel.app/api/optimizers/BootstrapFewShotWithRandomSearch",children:"BootstrapFewShotWithRandomSearch"}),", an optimizer that will take bootstrap samples from our training set and leverage a random search strategy to optimize our predictive accuracy."]}),"\n",(0,i.jsxs)(n.p,{children:["Note that in the below example, we leverage a simple metric definition of exact match, as defined in ",(0,i.jsx)(n.code,{children:"validate_classification"}),", but ",(0,i.jsx)(n.a,{href:"https://dspy.ai/learn/evaluation/metrics/",children:"dspy.Metrics"})," can contain complex and LM-based logic to properly evaluate our accuracy."]}),"\n",(0,i.jsx)(t.d,{executionCount:17,children:"from dspy.teleprompt import BootstrapFewShotWithRandomSearch\n\n\ndef validate_classification(example, prediction, trace=None) -> bool:\n  return example.label == prediction.label\n\n\noptimizer = BootstrapFewShotWithRandomSearch(\n  metric=validate_classification,\n  num_candidate_programs=5,\n  max_bootstrapped_demos=2,\n  num_threads=1,\n)\n\ncompiled_pe = optimizer.compile(copy(TextClassifier()), trainset=train_dataset)"}),"\n",(0,i.jsx)(r.p,{children:"Going to sample between 1 and 2 traces per predictor.\nWill attempt to bootstrap 5 candidate sets.\nAverage Metric: 19 / 24  (79.2): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 24/24 [00:19<00:00,  1.26it/s]\nNew best score: 79.17 for seed -3\nScores so far: [79.17]\nBest score so far: 79.17\nAverage Metric: 22 / 24  (91.7): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 24/24 [00:20<00:00,  1.17it/s]\nNew best score: 91.67 for seed -2\nScores so far: [79.17, 91.67]\nBest score so far: 91.67"}),"\n",(0,i.jsx)(r.p,{isStderr:!0,children:" 17%|\u2588\u258b        | 4/24 [00:02<00:13,  1.50it/s]"}),"\n",(0,i.jsx)(r.p,{children:"Bootstrapped 2 full traces after 5 examples in round 0.\nAverage Metric: 21 / 24  (87.5): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 24/24 [00:19<00:00,  1.21it/s]\nScores so far: [79.17, 91.67, 87.5]\nBest score so far: 91.67"}),"\n",(0,i.jsx)(r.p,{isStderr:!0,children:" 12%|\u2588\u258e        | 3/24 [00:02<00:18,  1.13it/s]"}),"\n",(0,i.jsx)(r.p,{children:"Bootstrapped 2 full traces after 4 examples in round 0.\nAverage Metric: 22 / 24  (91.7): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 24/24 [00:29<00:00,  1.23s/it]\nScores so far: [79.17, 91.67, 87.5, 91.67]\nBest score so far: 91.67"}),"\n",(0,i.jsx)(r.p,{isStderr:!0,children:"  4%|\u258d         | 1/24 [00:00<00:18,  1.27it/s]"}),"\n",(0,i.jsx)(r.p,{children:"Bootstrapped 1 full traces after 2 examples in round 0.\nAverage Metric: 22 / 24  (91.7): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 24/24 [00:20<00:00,  1.18it/s]\nScores so far: [79.17, 91.67, 87.5, 91.67, 91.67]\nBest score so far: 91.67"}),"\n",(0,i.jsx)(r.p,{isStderr:!0,children:"  8%|\u258a         | 2/24 [00:01<00:20,  1.10it/s]"}),"\n",(0,i.jsx)(r.p,{children:"Bootstrapped 1 full traces after 3 examples in round 0.\nAverage Metric: 22 / 24  (91.7): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 24/24 [00:22<00:00,  1.06it/s]\nScores so far: [79.17, 91.67, 87.5, 91.67, 91.67, 91.67]\nBest score so far: 91.67"}),"\n",(0,i.jsx)(r.p,{isStderr:!0,children:"  4%|\u258d         | 1/24 [00:01<00:30,  1.31s/it]"}),"\n",(0,i.jsx)(r.p,{children:"Bootstrapped 1 full traces after 2 examples in round 0.\nAverage Metric: 23 / 24  (95.8): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 24/24 [00:25<00:00,  1.04s/it]\nNew best score: 95.83 for seed 3\nScores so far: [79.17, 91.67, 87.5, 91.67, 91.67, 91.67, 95.83]\nBest score so far: 95.83"}),"\n",(0,i.jsx)(r.p,{isStderr:!0,children:"  4%|\u258d         | 1/24 [00:00<00:20,  1.12it/s]"}),"\n",(0,i.jsx)(r.p,{children:"Bootstrapped 1 full traces after 2 examples in round 0.\nAverage Metric: 22 / 24  (91.7): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 24/24 [00:24<00:00,  1.03s/it]\nScores so far: [79.17, 91.67, 87.5, 91.67, 91.67, 91.67, 95.83, 91.67]\nBest score so far: 95.83\n8 candidate programs found."}),"\n",(0,i.jsx)(n.h3,{id:"compare-prepost-compiled-accuracy",children:"Compare Pre/Post Compiled Accuracy"}),"\n",(0,i.jsx)(n.p,{children:"Finally, let's explore how well our trained model can predict on unseen test data."}),"\n",(0,i.jsx)(t.d,{executionCount:18,children:'def check_accuracy(classifier, test_data: pd.DataFrame = test_dataset) -> float:\n  residuals = []\n  predictions = []\n  for example in test_data:\n      prediction = classifier(text=example["text"])\n      residuals.append(int(validate_classification(example, prediction)))\n      predictions.append(prediction)\n  return residuals, predictions\n\n\nuncompiled_residuals, uncompiled_predictions = check_accuracy(copy(TextClassifier()))\nprint(f"Uncompiled accuracy: {np.mean(uncompiled_residuals)}")\n\ncompiled_residuals, compiled_predictions = check_accuracy(compiled_pe)\nprint(f"Compiled accuracy: {np.mean(compiled_residuals)}")'}),"\n",(0,i.jsx)(r.p,{children:"Uncompiled accuracy: 0.625\nCompiled accuracy: 0.875"}),"\n",(0,i.jsx)(n.p,{children:"As shown above, our compiled accuracy is non-zero - our base LLM inferred meaning of the classification labels simply via our initial prompt. However, with DSPy training, the prompts, demonstrations, and input/output signatures have been updated to give our model to 88% accuracy on unseen data. That's a gain of 25 percentage points!"}),"\n",(0,i.jsx)(n.p,{children:"Let's take a look at each prediction in our test set."}),"\n",(0,i.jsx)(t.d,{executionCount:19,children:'for uncompiled_residual, uncompiled_prediction in zip(uncompiled_residuals, uncompiled_predictions):\n  is_correct = "Correct" if bool(uncompiled_residual) else "Incorrect"\n  prediction = uncompiled_prediction.label\n  print(f"{is_correct} prediction: {\' \' * (12 - len(is_correct))}{prediction}")'}),"\n",(0,i.jsx)(r.p,{children:"Incorrect prediction:    money-fx\nCorrect prediction:      crude\nCorrect prediction:      money-fx\nCorrect prediction:      earn\nIncorrect prediction:    interest\nCorrect prediction:      grain\nCorrect prediction:      trade\nIncorrect prediction:    trade"}),"\n",(0,i.jsx)(t.d,{executionCount:20,children:'for compiled_residual, compiled_prediction in zip(compiled_residuals, compiled_predictions):\n  is_correct = "Correct" if bool(compiled_residual) else "Incorrect"\n  prediction = compiled_prediction.label\n  print(f"{is_correct} prediction: {\' \' * (12 - len(is_correct))}{prediction}")'}),"\n",(0,i.jsx)(r.p,{children:"Correct prediction:      interest\nCorrect prediction:      crude\nCorrect prediction:      money-fx\nCorrect prediction:      earn\nCorrect prediction:      acq\nCorrect prediction:      grain\nCorrect prediction:      trade\nIncorrect prediction:    crude"}),"\n",(0,i.jsx)(n.h2,{id:"log-and-load-the-model-with-mlflow",children:"Log and Load the Model with MLflow"}),"\n",(0,i.jsx)(n.p,{children:"Now that we have a compiled model with higher classification accuracy, let's leverage MLflow to log this model and load it for inference."}),"\n",(0,i.jsx)(t.d,{executionCount:21,children:'import mlflow\n\nwith mlflow.start_run():\n  model_info = mlflow.dspy.log_model(\n      compiled_pe,\n      name="model",\n      input_example="what is 2 + 2?",\n  )'}),"\n",(0,i.jsx)(r.p,{children:"Downloading artifacts:   0%|          | 0/7 [00:00<?, ?it/s]"}),"\n",(0,i.jsxs)(n.p,{children:["Open the MLflow UI again and check the complied model is recorded to a new MLflow Run. Now you can load the model back for inference using ",(0,i.jsx)(n.code,{children:"mlflow.dspy.load_model"})," or ",(0,i.jsx)(n.code,{children:"mlflow.pyfunc.load_model"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["\ud83d\udca1 MLflow will remember the environment configuration stored in ",(0,i.jsx)(n.code,{children:"dspy.settings"}),", such as the language model (LM) used during the experiment. This ensures excellent reproducibility for your experiment."]}),"\n",(0,i.jsx)(t.d,{executionCount:22,children:'# Define input text\nprint("\n==============Input Text============")\ntext = test_dataset[0]["text"]\nprint(f"Text: {text}")\n\n# Inference with original DSPy object\nprint("\n--------------Original DSPy Prediction------------")\nprint(compiled_pe(text=text).label)\n\n# Inference with loaded DSPy object\nprint("\n--------------Loaded DSPy Prediction------------")\nloaded_model_dspy = mlflow.dspy.load_model(model_info.model_uri)\nprint(loaded_model_dspy(text=text).label)\n\n# Inference with MLflow PyFunc API\nloaded_model_pyfunc = mlflow.pyfunc.load_model(model_info.model_uri)\nprint("\n--------------PyFunc Prediction------------")\nprint(loaded_model_pyfunc.predict(text)["label"])'}),"\n",(0,i.jsx)(r.p,{children:"\n==============Input Text============\nText: top discount rate at u k bill tender rises to pct\n\n--------------Original DSPy Prediction------------\ninterest\n\n--------------Loaded DSPy Prediction------------\ninterest\n\n--------------PyFunc Prediction------------\ninterest"}),"\n",(0,i.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,i.jsx)(n.p,{children:"This example demonstrates how DSPy works. Below are some potential extensions for improving this project, both with DSPy and MLflow."}),"\n",(0,i.jsx)(n.h3,{id:"dspy",children:"DSPy"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Use real-world data for the classifier."}),"\n",(0,i.jsx)(n.li,{children:"Experiment with different optimizers."}),"\n",(0,i.jsxs)(n.li,{children:["For more in-depth examples, check out the ",(0,i.jsx)(n.a,{href:"https://dspy.ai/tutorials/",children:"tutorials"})," and ",(0,i.jsx)(n.a,{href:"https://dspy.ai/learn/",children:"documentation"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"mlflow",children:"MLflow"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Deploy the model using MLflow serving."}),"\n",(0,i.jsx)(n.li,{children:"Use MLflow to experiment with various optimization strategies."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Happy coding!"})]})}function u(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(f,{...e})}):f(e)}},75983:(e,n,s)=>{s.d(n,{d:()=>t});var a=s(73748);const i="codeBlock_oJcR";var o=s(74848);const t=({children:e,executionCount:n})=>(0,o.jsx)("div",{style:{flexGrow:1,minWidth:0,marginTop:"var(--padding-md)",width:"100%"},children:(0,o.jsx)(a.A,{className:i,language:"python",children:e})})},81226:(e,n,s)=>{s.d(n,{Q:()=>i});var a=s(74848);const i=({children:e})=>(0,a.jsx)("div",{style:{flexGrow:1,minWidth:0,fontSize:"0.8rem",width:"100%"},children:e})}}]);