"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[6661],{28453:(e,t,l)=>{l.d(t,{R:()=>a,x:()=>i});var r=l(96540);const o={},n=r.createContext(o);function a(e){const t=r.useContext(n);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),r.createElement(n.Provider,{value:t},e.children)}},40620:(e,t,l)=>{l.r(t),l.d(t,{assets:()=>p,contentTitle:()=>m,default:()=>d,frontMatter:()=>s,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"flavors/dspy/optimizer","title":"DSPy Optimizer Autologging","description":"A DSPy optimizer is an algorithm that tunes the parameters of a DSPy program (i.e., the prompts and/or the LM weights) to maximize the metrics you specify.","source":"@site/docs/genai/flavors/dspy/optimizer.mdx","sourceDirName":"flavors/dspy","slug":"/flavors/dspy/optimizer","permalink":"/docs/latest/genai/flavors/dspy/optimizer","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"genAISidebar","previous":{"title":"DSPy Quickstart","permalink":"/docs/latest/genai/flavors/dspy/notebooks/dspy_quickstart"},"next":{"title":"MLflow LangChain Flavor","permalink":"/docs/latest/genai/flavors/langchain/"}}');var o=l(74848),n=l(28453),a=l(49374),i=l(72839);const s={},m="DSPy Optimizer Autologging",p={},c=[{value:"Enable Autologging",id:"enable-autologging",level:2},{value:"Example Code of DSPy Optimizer Autologging",id:"example-code-of-dspy-optimizer-autologging",level:2},{value:"What Gets Logged?",id:"what-gets-logged",level:2},{value:"FAQ",id:"faq",level:2},{value:"How to log my optimization and evaluation into a same run?",id:"how-to-log-my-optimization-and-evaluation-into-a-same-run",level:3}];function h(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,n.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.header,{children:(0,o.jsx)(t.h1,{id:"dspy-optimizer-autologging",children:"DSPy Optimizer Autologging"})}),"\n",(0,o.jsxs)(t.p,{children:["A ",(0,o.jsx)(t.a,{href:"https://dspy.ai/learn/optimization/optimizers/",children:"DSPy optimizer"})," is an algorithm that tunes the parameters of a DSPy program (i.e., the prompts and/or the LM weights) to maximize the metrics you specify.\nHowever, optimizers have the following challenges due to its black box nature:"]}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.strong,{children:"Parameters and Score of individual trial"}),": Program parameters (e.g. proposed instructions and selected demonstrations) and performance of each trial during optimization are not saved."]}),"\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.strong,{children:"Intermediate Artifacts"}),": Prompts and model responses for the intermediate programs are not available. While some of them are printed out, there is no easy way to store the information in a structured manner."]}),"\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.strong,{children:"Optimization Trajectory"}),": It is hard to understand the overview of the optimization trajectory from log texts (e.g. score progress over time)."]}),"\n"]}),"\n",(0,o.jsx)(t.p,{children:"The MLflow DSPy flavor provides a convenient way to automatically track the optimization process and results. This allows you to analyze the optimization process and results more efficiently."}),"\n",(0,o.jsx)(t.h2,{id:"enable-autologging",children:"Enable Autologging"}),"\n",(0,o.jsxs)(t.p,{children:["To enable autologging for DSPy optimization, call ",(0,o.jsx)(a.B,{fn:"mlflow.dspy.autolog"})," at the beginning of your script or notebook with the following parameters. This will automatically log traces for your program execution as well as other metrics and artifacts such as program states, train datasets, and evaluation results depending on the configuration.\nNote that the optimizer autologging feature is available since MLflow ",(0,o.jsx)(t.code,{children:"2.21.1"}),"."]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-python",children:"import mlflow\n\nmlflow.dspy.autolog(log_compiles=True, log_evals=True, log_traces_from_compile=True)\n\n# Your DSPy code here\n...\n"})}),"\n",(0,o.jsxs)(i.X,{children:[(0,o.jsx)("thead",{children:(0,o.jsxs)("tr",{children:[(0,o.jsx)("th",{children:"Target"}),(0,o.jsx)("th",{children:"Default"}),(0,o.jsx)("th",{children:"Parameter"}),(0,o.jsx)("th",{children:"Description"})]})}),(0,o.jsxs)("tbody",{children:[(0,o.jsxs)("tr",{children:[(0,o.jsx)("td",{children:"Traces"}),(0,o.jsx)("td",{children:(0,o.jsx)(t.code,{children:"true"})}),(0,o.jsx)("td",{children:(0,o.jsx)(t.code,{children:"log_traces"})}),(0,o.jsxs)("td",{children:["Whether to generate and log traces for the program. See ",(0,o.jsx)(t.a,{href:"/genai/tracing",children:"MLflow Tracing"})," for more details about tracing feature."]})]}),(0,o.jsxs)("tr",{children:[(0,o.jsx)("td",{children:"Traces during Optimization"}),(0,o.jsx)("td",{children:(0,o.jsx)(t.code,{children:"false"})}),(0,o.jsx)("td",{children:(0,o.jsx)(t.code,{children:"log_traces_from_compile"})}),(0,o.jsxs)("td",{children:["MLflow does not generate traces for program calls during optimization by default. Set ",(0,o.jsx)(t.code,{children:"True"})," to see traces for programs calls during optimization."]})]}),(0,o.jsxs)("tr",{children:[(0,o.jsx)("td",{children:"Traces during Evaluation"}),(0,o.jsx)("td",{children:(0,o.jsx)(t.code,{children:"True"})}),(0,o.jsx)("td",{children:(0,o.jsx)(t.code,{children:"log_traces_from_eval"})}),(0,o.jsxs)("td",{children:["If set ",(0,o.jsx)(t.code,{children:"True"}),", MLflow generates traces for program calls during evaluation."]})]}),(0,o.jsxs)("tr",{children:[(0,o.jsx)("td",{children:"Optimization"}),(0,o.jsx)("td",{children:(0,o.jsx)(t.code,{children:"false"})}),(0,o.jsx)("td",{children:(0,o.jsx)(t.code,{children:"log_compiles"})}),(0,o.jsxs)("td",{children:["If set to ",(0,o.jsx)(t.code,{children:"True"}),", a MLflow run is created for each ",(0,o.jsx)(t.code,{children:"Teleprompter.compile"})," call, and metrics and artifacts for the optimization are logged."]})]}),(0,o.jsxs)("tr",{children:[(0,o.jsx)("td",{children:"Evaluation"}),(0,o.jsx)("td",{children:(0,o.jsx)(t.code,{children:"false"})}),(0,o.jsx)("td",{children:(0,o.jsx)(t.code,{children:"log_evals"})}),(0,o.jsxs)("td",{children:["If set to ",(0,o.jsx)(t.code,{children:"True"}),", a MLflow run is created for each ",(0,o.jsx)(t.code,{children:"Evaluate.__call__"})," call, and metrics and artifacts for the evaluation are logged."]})]})]})]}),"\n",(0,o.jsx)(t.h2,{id:"example-code-of-dspy-optimizer-autologging",children:"Example Code of DSPy Optimizer Autologging"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-python",children:'import dspy\nfrom dspy.datasets.gsm8k import GSM8K, gsm8k_metric\nimport mlflow\n\n# Enabling tracing for DSPy\nmlflow.dspy.autolog(log_compiles=True, log_evals=True, log_traces_from_compile=True)\n\n# Optional: Set a tracking URI and an experiment\nmlflow.set_tracking_uri("http://localhost:5000")\nmlflow.set_experiment("DSPy")\n\nlm = dspy.LM(model="openai/gpt-3.5-turbo", max_tokens=250)\ndspy.configure(lm=lm)\n\ngsm8k = GSM8K()\n\ntrainset, devset = gsm8k.train, gsm8k.dev[:50]\n\nprogram = dspy.ChainOfThought("question -> answer")\n\n# define a teleprompter\nteleprompter = dspy.teleprompt.MIPROv2(\n    metric=gsm8k_metric,\n    auto="light",\n)\n# run the optimizer\noptimized_program = teleprompter.compile(\n    program,\n    trainset=trainset,\n    max_bootstrapped_demos=3,\n    max_labeled_demos=4,\n    requires_permission_to_run=False,\n)\n'})}),"\n",(0,o.jsx)(t.h2,{id:"what-gets-logged",children:"What Gets Logged?"}),"\n",(0,o.jsx)(t.p,{children:"MLflow optimizer autologging logs the following information:"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.strong,{children:"Optimizer Parameters"}),": The hyper parameters of the optimizer (e.g. number of demonstrates)."]}),"\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.strong,{children:"Optimized Program"}),": MLflow automatically saves the states of the optimized program as a json artifact."]}),"\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.strong,{children:"Datasets"}),": The train and evaluation datasets used in the optimization."]}),"\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.strong,{children:"Overall Progression of Metric"}),": The progression of the metric over time is captured as step-wise metrics of a compile run."]}),"\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.strong,{children:"Intermediate Program States and Metric"}),": The states of the program and the performance metric at each evaluation are captured in an evaluation run."]}),"\n",(0,o.jsxs)(t.li,{children:[(0,o.jsx)(t.strong,{children:"Traces"}),": The traces of each intermediate program are captured in an evaluation run."]}),"\n"]}),"\n",(0,o.jsxs)(t.p,{children:["When both ",(0,o.jsx)(t.code,{children:"log_compiles"})," and ",(0,o.jsx)(t.code,{children:"log_evals"})," are set to ",(0,o.jsx)(t.code,{children:"True"}),", MLflow creates a run for ",(0,o.jsx)(t.code,{children:"Teleprompter.compile"})," with child runs for ",(0,o.jsx)(t.code,{children:"Evaluate.__call__"})," calls.\nIn the MLflow UI, they are displayed hierarchically as shown below:"]}),"\n",(0,o.jsx)("img",{src:"https://i.imgur.com/eD0lA6V.png",alt:"Experiment Page",width:"700px"}),"\n",(0,o.jsx)(t.p,{children:"In the run page for the parent run (compile call), the optimizer parameters are displayed as run parameters. The progression of program performance is displayed as model metrics and the datasets used in the optimization are displayed as artifacts.\nWhen there are multiple type of evaluation calls (e.g. full dataset evaluation and mini-batch evaluation), the evaluation results are logged separately."}),"\n",(0,o.jsx)("img",{src:"https://i.imgur.com/lXKINPQ.png",alt:"Parent Run",width:"1000px"}),"\n",(0,o.jsx)(t.p,{children:"In the run page for the child run (evaluation call), the intermediate program states are displayed as run parameters, the performance metric are displayed as model metrics and the traces of the program are available in the trace tab."}),"\n",(0,o.jsx)("img",{src:"https://i.imgur.com/XAC9hND.png",alt:"Child Run",width:"800px"}),"\n",(0,o.jsx)(t.h2,{id:"faq",children:"FAQ"}),"\n",(0,o.jsx)(t.h3,{id:"how-to-log-my-optimization-and-evaluation-into-a-same-run",children:"How to log my optimization and evaluation into a same run?"}),"\n",(0,o.jsxs)(t.p,{children:["To log both optimization and evaluation into a same run, you can manually create a parent run using ",(0,o.jsx)(t.code,{children:"mlflow.start_run"})," and run your optimization and evaluation within the run."]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-python",children:'with mlflow.start_run(run_name="My Optimization Run") as run:\n    optimized_program = teleprompter.compile(\n        program,\n        trainset=trainset,\n    )\n    evaluation = dspy.Evaluate(devset=devset, metric=metric)\n    evaluation(optimized_program)\n'})})]})}function d(e={}){const{wrapper:t}={...(0,n.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(h,{...e})}):h(e)}},49374:(e,t,l)=>{l.d(t,{B:()=>s});l(96540);const r=JSON.parse('{"mlflow.anthropic":"api_reference/python_api/mlflow.anthropic.html","mlflow.artifacts":"api_reference/python_api/mlflow.artifacts.html","mlflow.ag2":"api_reference/python_api/mlflow.ag2.html","mlflow.autogen":"api_reference/python_api/mlflow.autogen.html","mlflow.bedrock":"api_reference/python_api/mlflow.bedrock.html","mlflow.catboost":"api_reference/python_api/mlflow.catboost.html","mlflow.client":"api_reference/python_api/mlflow.client.html","mlflow.config":"api_reference/python_api/mlflow.config.html","mlflow.crewai":"api_reference/python_api/mlflow.crewai.html","mlflow.data":"api_reference/python_api/mlflow.data.html","mlflow.deployments":"api_reference/python_api/mlflow.deployments.html","mlflow.diviner":"api_reference/python_api/mlflow.diviner.html","mlflow.dspy":"api_reference/python_api/mlflow.dspy.html","mlflow.entities":"api_reference/python_api/mlflow.entities.html","mlflow.environment_variables":"api_reference/python_api/mlflow.environment_variables.html","mlflow.gateway":"api_reference/python_api/mlflow.gateway.html","mlflow.gemini":"api_reference/python_api/mlflow.gemini.html","mlflow.groq":"api_reference/python_api/mlflow.groq.html","mlflow.h2o":"api_reference/python_api/mlflow.h2o.html","mlflow.johnsnowlabs":"api_reference/python_api/mlflow.johnsnowlabs.html","mlflow.keras":"api_reference/python_api/mlflow.keras.html","mlflow.langchain":"api_reference/python_api/mlflow.langchain.html","mlflow.lightgbm":"api_reference/python_api/mlflow.lightgbm.html","mlflow.litellm":"api_reference/python_api/mlflow.litellm.html","mlflow.llama_index":"api_reference/python_api/mlflow.llama_index.html","mlflow.metrics":"api_reference/python_api/mlflow.metrics.html","mlflow.mistral":"api_reference/python_api/mlflow.mistral.html","mlflow.models":"api_reference/python_api/mlflow.models.html","mlflow.onnx":"api_reference/python_api/mlflow.onnx.html","mlflow.openai":"api_reference/python_api/mlflow.openai.html","mlflow.paddle":"api_reference/python_api/mlflow.paddle.html","mlflow.pmdarima":"api_reference/python_api/mlflow.pmdarima.html","mlflow.projects":"api_reference/python_api/mlflow.projects.html","mlflow.promptflow":"api_reference/python_api/mlflow.promptflow.html","mlflow.prophet":"api_reference/python_api/mlflow.prophet.html","mlflow.pyfunc":"api_reference/python_api/mlflow.pyfunc.html","mlflow.pyspark.ml":"api_reference/python_api/mlflow.pyspark.ml.html","mlflow.pytorch":"api_reference/python_api/mlflow.pytorch.html","mlflow":"api_reference/python_api/mlflow.html","mlflow.sagemaker":"api_reference/python_api/mlflow.sagemaker.html","mlflow.sentence_transformers":"api_reference/python_api/mlflow.sentence_transformers.html","mlflow.server":"api_reference/python_api/mlflow.server.html","mlflow.shap":"api_reference/python_api/mlflow.shap.html","mlflow.sklearn":"api_reference/python_api/mlflow.sklearn.html","mlflow.spacy":"api_reference/python_api/mlflow.spacy.html","mlflow.spark":"api_reference/python_api/mlflow.spark.html","mlflow.statsmodels":"api_reference/python_api/mlflow.statsmodels.html","mlflow.system_metrics":"api_reference/python_api/mlflow.system_metrics.html","mlflow.tensorflow":"api_reference/python_api/mlflow.tensorflow.html","mlflow.tracing":"api_reference/python_api/mlflow.tracing.html","mlflow.transformers":"api_reference/python_api/mlflow.transformers.html","mlflow.types":"api_reference/python_api/mlflow.types.html","mlflow.utils":"api_reference/python_api/mlflow.utils.html","mlflow.xgboost":"api_reference/python_api/mlflow.xgboost.html","mlflow.server.auth":"api_reference/auth/python-api.html"}');var o=l(86025),n=l(28774),a=l(74848);const i=e=>{const t=e.split(".");for(let l=t.length;l>0;l--){const e=t.slice(0,l).join(".");if(r[e])return e}return null};function s({fn:e,children:t}){const l=i(e);if(!l)return(0,a.jsx)(a.Fragment,{children:t});const s=(0,o.Ay)(`/${r[l]}#${e}`);return(0,a.jsx)(n.A,{to:s,target:"_blank",children:t??(0,a.jsxs)("code",{children:[e,"()"]})})}},72839:(e,t,l)=>{l.d(t,{X:()=>o});var r=l(74848);function o({children:e}){return(0,r.jsx)("div",{className:"w-full overflow-x-auto",children:(0,r.jsx)("table",{children:e})})}}}]);