"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([["411"],{56945(e,t,n){n.r(t),n.d(t,{metadata:()=>o,default:()=>m,frontMatter:()=>i,contentTitle:()=>s,toc:()=>p,assets:()=>l});var o=JSON.parse('{"id":"prompt-registry/log-with-model","title":"Log Prompts with Models","description":"Prompts are often used as a part of GenAI applications. Managing the association between prompts and models is crucial for tracking the evolution of models and ensuring consistency across different environments. MLflow Prompt Registry is integrated with MLflow\'s model tracking capability, allowing you to track which prompts (and versions) are used by your models and applications.","source":"@site/docs/genai/prompt-registry/log-with-model.mdx","sourceDirName":"prompt-registry","slug":"/prompt-registry/log-with-model","permalink":"/mlflow-website/docs/latest/genai/prompt-registry/log-with-model","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"genAISidebar","previous":{"title":"Use Prompts in Apps","permalink":"/mlflow-website/docs/latest/genai/prompt-registry/use-prompts-in-apps"},"next":{"title":"Structured Output","permalink":"/mlflow-website/docs/latest/genai/prompt-registry/structured-output"}}'),a=n(74848),r=n(28453);let i={},s="Log Prompts with Models",l={},p=[{value:"Basic Usage",id:"basic-usage",level:2},{value:"Example 1: Logging Prompts with LangChain",id:"example-1-logging-prompts-with-langchain",level:2},{value:"1. Create a prompt",id:"1-create-a-prompt",level:3},{value:"2. Define a Chain using the registered prompts",id:"2-define-a-chain-using-the-registered-prompts",level:3},{value:"3. Log the Chain to MLflow",id:"3-log-the-chain-to-mlflow",level:3},{value:"Example 2: Automatic Prompt Logging with Models-from-Code",id:"example-2-automatic-prompt-logging-with-models-from-code",level:2},{value:"1. Create a prompt",id:"1-create-a-prompt-1",level:3},{value:"2. Define a Graph using the registered prompt",id:"2-define-a-graph-using-the-registered-prompt",level:3},{value:"3. Log the Graph to MLflow",id:"3-log-the-graph-to-mlflow",level:3},{value:"4. Load the graph back and invoke",id:"4-load-the-graph-back-and-invoke",level:3}];function d(e){let t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",p:"p",pre:"pre",strong:"strong",...(0,r.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(t.header,{children:(0,a.jsx)(t.h1,{id:"log-prompts-with-models",children:"Log Prompts with Models"})}),"\n",(0,a.jsx)(t.p,{children:"Prompts are often used as a part of GenAI applications. Managing the association between prompts and models is crucial for tracking the evolution of models and ensuring consistency across different environments. MLflow Prompt Registry is integrated with MLflow's model tracking capability, allowing you to track which prompts (and versions) are used by your models and applications."}),"\n",(0,a.jsx)(t.h2,{id:"basic-usage",children:"Basic Usage"}),"\n",(0,a.jsxs)(t.p,{children:["To log a model with associated prompts, use the ",(0,a.jsx)(t.code,{children:"prompts"})," parameter in the ",(0,a.jsx)(t.code,{children:"log_model"})," method. The ",(0,a.jsx)(t.code,{children:"prompts"})," parameter accepts a list of prompt URLs or prompt objects that are associated with the model. The associated prompts are displayed in the MLflow UI for the model run."]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{children:'import mlflow\n\nwith mlflow.start_run():\n    mlflow.<flavor>.log_model(\n        model,\n        ...\n        # Specify a list of prompt URLs or prompt objects.\n        prompts=["prompts:/summarization-prompt/2"]\n    )\n'})}),"\n",(0,a.jsx)(t.admonition,{type:"warning",children:(0,a.jsxs)(t.p,{children:["The ",(0,a.jsx)(t.code,{children:"prompts"})," parameter for associating prompts with models is only supported for GenAI flavors such as OpenAI, LangChain, LlamaIndex, DSPy, etc. Please refer to the ",(0,a.jsx)(t.a,{href:"/genai/flavors",children:"GenAI flavors"})," for the full list of supported flavors."]})}),"\n",(0,a.jsx)(t.h2,{id:"example-1-logging-prompts-with-langchain",children:"Example 1: Logging Prompts with LangChain"}),"\n",(0,a.jsx)(t.h3,{id:"1-create-a-prompt",children:"1. Create a prompt"}),"\n",(0,a.jsxs)(t.p,{children:["If you haven't already created a prompt, follow ",(0,a.jsx)(t.a,{href:"/genai/prompt-registry/create-and-edit-prompts",children:"the instructions in this page"})," to create a new prompt."]}),"\n",(0,a.jsx)(t.h3,{id:"2-define-a-chain-using-the-registered-prompts",children:"2. Define a Chain using the registered prompts"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:'from langchain_core.prompts import ChatPromptTemplate\nfrom langchain_openai import ChatOpenAI\n\n# Load registered prompt\nprompt = mlflow.genai.load_prompt("prompts:/summarization-prompt/2")\n\n# Create LangChain prompt object\nlangchain_prompt = ChatPromptTemplate.from_messages(\n    [\n        (\n            # IMPORTANT: Convert prompt template from double to single curly braces format\n            "system",\n            prompt.to_single_brace_format(),\n        ),\n        ("placeholder", "{messages}"),\n    ]\n)\n\n# Define the LangChain chain\nllm = ChatOpenAI()\nchain = langchain_prompt | llm\n\n# Invoke the chain\nresponse = chain.invoke({"num_sentences": 1, "sentences": "This is a test sentence."})\nprint(response)\n'})}),"\n",(0,a.jsx)(t.h3,{id:"3-log-the-chain-to-mlflow",children:"3. Log the Chain to MLflow"}),"\n",(0,a.jsxs)(t.p,{children:["Then log the chain to MLflow and specify the prompt URL in the ",(0,a.jsx)(t.code,{children:"prompts"})," parameter:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:'with mlflow.start_run(run_name="summarizer-model"):\n    mlflow.langchain.log_model(\n        chain, name="model", prompts=["prompts:/summarization-prompt/2"]\n    )\n'})}),"\n",(0,a.jsx)(t.p,{children:"Now you can view the associated prompts to the model in MLflow UI:"}),"\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.img,{alt:"Associated Prompts",src:n(54548).A+"",width:"888",height:"382"})}),"\n",(0,a.jsx)(t.p,{children:"Moreover, you can view the list of models (runs) that use a specific prompt in the prompt details page:"}),"\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.img,{alt:"Associated Prompts",src:n(45576).A+"",width:"3364",height:"1244"})}),"\n",(0,a.jsx)(t.h2,{id:"example-2-automatic-prompt-logging-with-models-from-code",children:"Example 2: Automatic Prompt Logging with Models-from-Code"}),"\n",(0,a.jsxs)(t.p,{children:[(0,a.jsx)(t.a,{href:"/ml/model/models-from-code",children:"Models-from-Code"})," is a feature that allows you to define and log models in code.\nLogging a model with code brings several benefits, such as portability, readability, avoiding serialization, and more."]}),"\n",(0,a.jsxs)(t.p,{children:["Combining with MLflow Prompt Registry, the feature unlocks even more flexibility to manage prompt versions. Notably,\nif your model code uses a prompt from MLflow Prompt Registry, MLflow ",(0,a.jsx)(t.strong,{children:"automatically"})," logs it with the model for you."]}),"\n",(0,a.jsx)(t.p,{children:"In the following example, we use LangGraph to define a very simple chat bot using the registered prompt."}),"\n",(0,a.jsx)(t.h3,{id:"1-create-a-prompt-1",children:"1. Create a prompt"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{children:'import mlflow\n\n# Register a new prompt\nprompt = mlflow.genai.register_prompt(\n    name="chat-prompt",\n    template="You are an expert in programming. Please answer the user\'s question about programming.",\n)\n'})}),"\n",(0,a.jsx)(t.h3,{id:"2-define-a-graph-using-the-registered-prompt",children:"2. Define a Graph using the registered prompt"}),"\n",(0,a.jsxs)(t.p,{children:["Create a Python script ",(0,a.jsx)(t.code,{children:"chatbot.py"})," with the following content."]}),"\n",(0,a.jsx)(t.admonition,{type:"tip",children:(0,a.jsxs)(t.p,{children:["If you are using Jupyter notebook, you can uncomment the ",(0,a.jsx)(t.code,{children:"%writefile"})," magic\ncommand and run the following code in a cell to generate the script."]})}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:'# %%writefile chatbot.py\n\nimport mlflow\nfrom typing import Annotated\nfrom typing_extensions import TypedDict\n\nfrom langchain_openai import ChatOpenAI\nfrom langgraph.graph import StateGraph, START, END\nfrom langgraph.graph.message import add_messages\n\n\nclass State(TypedDict):\n    messages: list\n\n\nllm = ChatOpenAI(model="gpt-4o-mini", temperature=0.1)\nsystem_prompt = mlflow.genai.load_prompt("prompts:/chat-prompt/1")\n\n\ndef add_system_message(state: State):\n    return {\n        "messages": [\n            {\n                "role": "system",\n                "content": system_prompt.to_single_brace_format(),\n            },\n            *state["messages"],\n        ]\n    }\n\n\ndef chatbot(state: State):\n    return {"messages": [llm.invoke(state["messages"])]}\n\n\ngraph_builder = StateGraph(State)\ngraph_builder.add_node("add_system_message", add_system_message)\ngraph_builder.add_node("chatbot", chatbot)\ngraph_builder.add_edge(START, "add_system_message")\ngraph_builder.add_edge("add_system_message", "chatbot")\ngraph_builder.add_edge("chatbot", END)\n\ngraph = graph_builder.compile()\n\nmlflow.models.set_model(graph)\n'})}),"\n",(0,a.jsx)(t.h3,{id:"3-log-the-graph-to-mlflow",children:"3. Log the Graph to MLflow"}),"\n",(0,a.jsxs)(t.p,{children:["Specify the file path to the script in the ",(0,a.jsx)(t.code,{children:"model"})," parameter:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:'with mlflow.start_run():\n    model_info = mlflow.langchain.log_model(\n        lc_model="./chatbot.py",\n        name="graph",\n    )\n'})}),"\n",(0,a.jsxs)(t.p,{children:["We didn't specify the ",(0,a.jsx)(t.code,{children:"prompts"})," parameter this time, but MLflow automatically logs the prompt loaded within the script to the logged model. Now you can view the associated prompt in MLflow UI:"]}),"\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.img,{alt:"Associated Prompts",src:n(54255).A+"",width:"878",height:"413"})}),"\n",(0,a.jsx)(t.h3,{id:"4-load-the-graph-back-and-invoke",children:"4. Load the graph back and invoke"}),"\n",(0,a.jsx)(t.p,{children:"Finally, let's load the graph back and invoke it to see the chatbot in action."}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:'# Enable MLflow tracing for LangChain to view the prompt passed to LLM.\nmlflow.langchain.autolog()\n\n# Load the graph\ngraph = mlflow.langchain.load_model(model_info.model_uri)\n\ngraph.invoke(\n    {\n        "messages": [\n            {\n                "role": "user",\n                "content": "What is the difference between multi-threading and multi-processing?",\n            }\n        ]\n    }\n)\n'})}),"\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.img,{alt:"Chatbot",src:n(25800).A+"",width:"1751",height:"797"})})]})}function m(e={}){let{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},54255(e,t,n){n.d(t,{A:()=>o});let o=n.p+"assets/images/prompt-logged-graph-0b4cd4a6c6e28f2afeffea5a9bcee188.png"},45576(e,t,n){n.d(t,{A:()=>o});let o=n.p+"assets/images/prompt-logged-model-links-b4c073f2c15e203ec34d7ef35c840112.png"},54548(e,t,n){n.d(t,{A:()=>o});let o=n.p+"assets/images/prompt-logged-model-5db16e3e39f3bbd4ca3138c96dff045e.png"},25800(e,t,n){n.d(t,{A:()=>o});let o=n.p+"assets/images/prompt-logged-trace-f531e466499e24d2b8541d655237ea91.png"},28453(e,t,n){n.d(t,{R:()=>i,x:()=>s});var o=n(96540);let a={},r=o.createContext(a);function i(e){let t=o.useContext(r);return o.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),o.createElement(r.Provider,{value:t},e.children)}}}]);