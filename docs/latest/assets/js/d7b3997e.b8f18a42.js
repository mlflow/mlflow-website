"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[1539],{16734:(e,n,t)=>{t.d(n,{d:()=>a});var i=t(58069);const l="codeBlock_oJcR";var o=t(74848);const a=e=>{let{children:n,executionCount:t}=e;return(0,o.jsx)("div",{style:{flexGrow:1,minWidth:0,marginTop:"var(--padding-md)",width:"100%"},children:(0,o.jsx)(i.A,{className:l,language:"python",children:n})})}},20723:(e,n,t)=>{t.d(n,{O:()=>o});var i=t(96540),l=t(74848);function o(e){let{children:n,href:t}=e;const o=(0,i.useCallback)((async e=>{if(e.preventDefault(),window.gtag)try{window.gtag("event","notebook-download",{href:t})}catch{}const n=await fetch(t),i=await n.blob(),l=window.URL.createObjectURL(i),o=document.createElement("a");o.style.display="none",o.href=l;const a=t.split("/").pop();o.download=a,document.body.appendChild(o),o.click(),window.URL.revokeObjectURL(l),document.body.removeChild(o)}),[t]);return(0,l.jsx)("a",{className:"button button--primary",style:{marginBottom:"1rem",display:"block",width:"min-content"},href:t,download:!0,onClick:o,children:n})}},61536:(e,n,t)=>{t.d(n,{p:()=>l});var i=t(74848);const l=e=>{let{children:n,isStderr:t}=e;return(0,i.jsx)("pre",{style:{margin:0,borderRadius:0,background:"none",fontSize:"0.85rem",flexGrow:1,padding:"var(--padding-sm)"},children:n})}},70954:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>p,frontMatter:()=>s,metadata:()=>i,toc:()=>h});const i=JSON.parse('{"id":"tracing/tutorials/jupyter-trace-demo-ipynb","title":"MLflow Trace UI in Jupyter Notebook Demo","description":"Download this notebook","source":"@site/docs/tracing/tutorials/jupyter-trace-demo-ipynb.mdx","sourceDirName":"tracing/tutorials","slug":"/tracing/tutorials/jupyter-trace-demo","permalink":"/docs/latest/tracing/tutorials/jupyter-trace-demo","draft":false,"unlisted":false,"editUrl":"https://github.com/mlflow/mlflow/edit/master/docs/docs/tracing/tutorials/jupyter-trace-demo.ipynb","tags":[],"version":"current","frontMatter":{"custom_edit_url":"https://github.com/mlflow/mlflow/edit/master/docs/docs/tracing/tutorials/jupyter-trace-demo.ipynb","slug":"jupyter-trace-demo"},"sidebar":"docsSidebar","previous":{"title":"Tracing 101","permalink":"/docs/latest/tracing/tutorials/concept"},"next":{"title":"MLflow Tracing UI","permalink":"/docs/latest/tracing/ui"}}');var l=t(74848),o=t(28453),a=t(16734),r=(t(61536),t(86563),t(20723));const s={custom_edit_url:"https://github.com/mlflow/mlflow/edit/master/docs/docs/tracing/tutorials/jupyter-trace-demo.ipynb",slug:"jupyter-trace-demo"},c="MLflow Trace UI in Jupyter Notebook Demo",d={},h=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"When is the MLflow Trace UI displayed?",id:"when-is-the-mlflow-trace-ui-displayed",level:2},{value:"Example 1: Generating a trace within a cell",id:"example-1-generating-a-trace-within-a-cell",level:3},{value:"Example 2: Displaying a Trace object",id:"example-2-displaying-a-trace-object",level:3},{value:"Example 3: Calling <code>mlflow.search_traces()</code>",id:"example-3-calling-mlflowsearch_traces",level:3},{value:"Disabling the UI",id:"disabling-the-ui",level:2},{value:"Conclusion",id:"conclusion",level:2}];function u(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",ul:"ul",...(0,o.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"mlflow-trace-ui-in-jupyter-notebook-demo",children:"MLflow Trace UI in Jupyter Notebook Demo"})}),"\n",(0,l.jsx)(r.O,{href:"https://raw.githubusercontent.com/mlflow/mlflow/master/docs/docs/tracing/tutorials/jupyter-trace-demo.ipynb",children:"Download this notebook"}),"\n",(0,l.jsx)(n.p,{children:"This notebook is a quick showcase of the MLflow Trace UI within Jupyter Notebooks."}),"\n",(0,l.jsx)(n.p,{children:"We begin with some toy examples to explain the display functionality, and end\nby building a simple RAG demo to showcase more of the UI features."}),"\n",(0,l.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,l.jsx)(n.p,{children:"Please make sure you have the following packages installed for this demo."}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"mlflow >= 2.20"}),"\n",(0,l.jsx)(n.li,{children:"openai"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Optionally, for the RAG demo at the end, you'll need:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"langchain"}),"\n",(0,l.jsx)(n.li,{children:"langchain-community"}),"\n",(0,l.jsx)(n.li,{children:"beautifulsoup4"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"You can run the cell below to install all these packages (make sure to restart the kernel afterwards)"}),"\n",(0,l.jsx)(a.d,{executionCount:" ",children:"%pip install mlflow>=2.20 openai langchain langchain-community beautifulsoup4"}),"\n",(0,l.jsx)(n.h2,{id:"when-is-the-mlflow-trace-ui-displayed",children:"When is the MLflow Trace UI displayed?"}),"\n",(0,l.jsxs)(n.p,{children:["The UI is only displayed when the MLflow Tracking URI is set to an HTTP tracking server, as this is where the UI assets are served from. If you don't use a remote tracking server, you can always start one locally by running the ",(0,l.jsx)(n.code,{children:"mlflow server"})," CLI command. By default, the tracking server will be running at ",(0,l.jsx)(n.code,{children:"http://localhost:5000"}),"."]}),"\n",(0,l.jsx)(n.p,{children:"For this tutorial, please make sure your tracking URI is set correctly!"}),"\n",(0,l.jsx)(a.d,{executionCount:" ",children:'import mlflow\n\n# replace with your own URI\ntracking_uri = "http://localhost:5000"\nmlflow.set_tracking_uri(tracking_uri)\n\n# set a new experiment to avoid\n# cluttering the default experiment\nexperiment = mlflow.set_experiment("mlflow-trace-ui-demo")'}),"\n",(0,l.jsx)(n.p,{children:"Once that's set up, the trace UI should automatically show up for the following events. Examples of each will be provided below:"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsx)(n.li,{children:"When the cell code generates a trace"}),"\n",(0,l.jsxs)(n.li,{children:["When a ",(0,l.jsx)(n.code,{children:"mlflow.entities.Trace"})," object is displayed (e.g. via IPython's ",(0,l.jsx)(n.code,{children:"display"})," function, or when it is the last value returned in a cell)"]}),"\n",(0,l.jsxs)(n.li,{children:["When ",(0,l.jsx)(n.code,{children:"mlflow.search_traces()"})," is called"]}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"example-1-generating-a-trace-within-a-cell",children:"Example 1: Generating a trace within a cell"}),"\n",(0,l.jsxs)(n.p,{children:["Traces can be generated by automatic tracing integrations (e.g. with ",(0,l.jsx)(n.code,{children:"mlflow.openai.autolog()"}),"), or when you run a manually traced function. For example:"]}),"\n",(0,l.jsx)(a.d,{executionCount:" ",children:"# Simple manual tracing example\nimport mlflow\n\n\n@mlflow.trace\ndef foo(input):\n  return input + 1\n\n\n# running foo() generates a trace\nfoo(1)"}),"\n",(0,l.jsx)(a.d,{executionCount:" ",children:'# Automatic tracing with OpenAI\nimport os\nfrom getpass import getpass\n\nif "OPENAI_API_KEY" not in os.environ:\n  os.environ["OPENAI_API_KEY"] = getpass("Enter your OpenAI API key: ")'}),"\n",(0,l.jsx)(a.d,{executionCount:" ",children:'from openai import OpenAI\n\nimport mlflow\n\nmlflow.openai.autolog()\n\nclient = OpenAI()\n\n# creating a chat completion will generate a trace\nclient.chat.completions.create(\n  model="gpt-4o-mini",\n  messages=[{"role": "user", "content": "hello!"}],\n)'}),"\n",(0,l.jsx)(n.h3,{id:"example-2-displaying-a-trace-object",children:"Example 2: Displaying a Trace object"}),"\n",(0,l.jsx)(n.p,{children:"The trace UI will also show up when an MLflow Trace entity is displayed. This can happen in two ways:"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:["Explicitly displaying a trace object with IPython's ",(0,l.jsx)(n.code,{children:"display()"})]}),"\n",(0,l.jsx)(n.li,{children:"When a trace object happens to be the last evaluated expression in a cell"}),"\n"]}),"\n",(0,l.jsx)(a.d,{executionCount:" ",children:'# Explicitly calling `display()`\ntrace_id = mlflow.get_last_active_trace_id()\ntrace = mlflow.get_trace(trace_id)\ndisplay(trace)\n\n# Even if the last expression does not result in a trace,\n# display(trace) will still trigger the UI display\nprint("Test")'}),"\n",(0,l.jsx)(a.d,{executionCount:" ",children:"# Displaying as a result of the trace being the last expression\ntrace"}),"\n",(0,l.jsxs)(n.h3,{id:"example-3-calling-mlflowsearch_traces",children:["Example 3: Calling ",(0,l.jsx)(n.code,{children:"mlflow.search_traces()"})]}),"\n",(0,l.jsxs)(n.p,{children:["MLflow provides the ",(0,l.jsx)(n.code,{children:"mlflow.search_traces()"})," API to conveniently search through all traces in an experiment. When this API is called in a Jupyter notebook, the trace UI will render all the traces in a paginated view. There is a limit to how many traces can be rendered in a single cell output. By default the maximum is 10, but this can be configured by setting the ",(0,l.jsx)(n.code,{children:"MLFLOW_MAX_TRACES_TO_DISPLAY_IN_NOTEBOOK"})," environment variable."]}),"\n",(0,l.jsx)(a.d,{executionCount:" ",children:"mlflow.search_traces(experiment_ids=[experiment.experiment_id])"}),"\n",(0,l.jsx)(n.h2,{id:"disabling-the-ui",children:"Disabling the UI"}),"\n",(0,l.jsxs)(n.p,{children:["The display is enabled by default, but if you'd prefer for it not to be shown, you can run ",(0,l.jsx)(n.code,{children:"mlflow.tracing.disable_notebook_display()"})," disable it. You will have to rerun the cells (or simply clear the cell outputs) in order to remove the displays that have already rendered."]}),"\n",(0,l.jsxs)(n.p,{children:["If you'd like to re-enable the auto-display functionality, simply call ",(0,l.jsx)(n.code,{children:"mlflow.tracing.enable_notebook_display()"}),"."]}),"\n",(0,l.jsx)(a.d,{executionCount:" ",children:"mlflow.tracing.disable_notebook_display()\n\n# no UI will be rendered\ntrace"}),"\n",(0,l.jsx)(a.d,{executionCount:" ",children:"mlflow.tracing.enable_notebook_display()\n\n# re-enable display\ntrace"}),"\n",(0,l.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,l.jsxs)(n.p,{children:["That's the basics! We hope you'll find the Jupyter integration useful. As always, please file an issue at ",(0,l.jsx)(n.a,{href:"https://github.com/mlflow/mlflow/issues",children:"https://github.com/mlflow/mlflow/issues"})," if you find any problems, or if you want to leave any feedback."]}),"\n",(0,l.jsx)(n.p,{children:"In the next few cells, we have a short RAG demo that will create a trace with more realistic data, so you can get a better feel of what working with this UI will be like."}),"\n",(0,l.jsx)(a.d,{executionCount:" ",children:'from langchain_core.vectorstores import InMemoryVectorStore\nfrom langchain_openai import ChatOpenAI, OpenAIEmbeddings\n\n# define necessary RAG entities\nllm = ChatOpenAI(model="gpt-4o-mini")\nembeddings = OpenAIEmbeddings(model="text-embedding-3-large")\nvector_store = InMemoryVectorStore(embeddings)'}),"\n",(0,l.jsx)(a.d,{executionCount:" ",children:'import bs4\nfrom langchain import hub\nfrom langchain_community.document_loaders import WebBaseLoader\nfrom langchain_core.runnables import RunnablePassthrough\nfrom langchain_text_splitters import RecursiveCharacterTextSplitter\n\n# generate sample doc chunks from the MLflow documentation\nloader = WebBaseLoader(\n  web_paths=("https://mlflow.org/docs/latest/llms/tracing/index.html",),\n  bs_kwargs={"parse_only": bs4.SoupStrainer(class_=("document"))},\n)\ndocs = loader.load()\n\n# add documents to the vector store\ntext_splitter = RecursiveCharacterTextSplitter(chunk_size=1000, chunk_overlap=200)\nall_splits = text_splitter.split_documents(docs)\nvector_store.add_documents(documents=all_splits)\n\nretriever = vector_store.as_retriever(\n  search_type="similarity",\n  search_kwargs={"k": 3},\n)\n\n# Define prompt for question-answering\nprompt = hub.pull("rlm/rag-prompt")'}),"\n",(0,l.jsx)(a.d,{executionCount:" ",children:'# define our chain\nchain = {"context": retriever, "question": RunnablePassthrough()} | prompt | llm'}),"\n",(0,l.jsx)(a.d,{executionCount:" ",children:'import mlflow\n\n# call the langchain autolog function so that traces will be generated\nmlflow.langchain.autolog()\n\nresponse = chain.invoke("What is MLflow Tracing?")'})]})}function p(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(u,{...e})}):u(e)}},86563:(e,n,t)=>{t.d(n,{Q:()=>l});var i=t(74848);const l=e=>{let{children:n}=e;return(0,i.jsx)("div",{style:{flexGrow:1,minWidth:0,fontSize:"0.8rem",width:"100%"},children:n})}}}]);