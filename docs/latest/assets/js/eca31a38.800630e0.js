"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([["1473"],{86299(e,t,l){l.r(t),l.d(t,{metadata:()=>n,default:()=>f,frontMatter:()=>o,contentTitle:()=>p,toc:()=>m,assets:()=>s});var n=JSON.parse('{"id":"tracing/app-instrumentation/distributed-tracing","title":"Propagate Trace Context Across Services","description":"When your application spans multiple services, you may want to connect spans from these services into a single trace for tracking the end to end execution in one place. MLflow support this via Distributed Tracing, by propagating the active trace context over HTTP so spans recorded in different services.","source":"@site/docs/genai/tracing/app-instrumentation/distributed-tracing.mdx","sourceDirName":"tracing/app-instrumentation","slug":"/tracing/app-instrumentation/distributed-tracing","permalink":"/mlflow-website/docs/latest/genai/tracing/app-instrumentation/distributed-tracing","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"genAISidebar","previous":{"title":"Tracing with OpenTelemetry","permalink":"/mlflow-website/docs/latest/genai/tracing/app-instrumentation/opentelemetry"},"next":{"title":"Track Users and Sessions","permalink":"/mlflow-website/docs/latest/genai/tracing/track-users-sessions/"}}'),r=l(74848),a=l(28453),i=l(54725);let o={},p="Propagate Trace Context Across Services",s={},m=[{value:"Client example",id:"client-example",level:2},{value:"Server handler example",id:"server-handler-example",level:2},{value:"Limitation in Databricks",id:"limitation-in-databricks",level:2}];function c(e){let t={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"propagate-trace-context-across-services",children:"Propagate Trace Context Across Services"})}),"\n",(0,r.jsxs)(t.p,{children:["When your application spans multiple services, you may want to connect spans from these services into a single trace for tracking the end to end execution in one place. MLflow support this via ",(0,r.jsx)(t.strong,{children:"Distributed Tracing"}),", by propagating the active trace context over HTTP so spans recorded in different services."]}),"\n",(0,r.jsx)(t.p,{children:"The following is a simple example of distributed tracing. There is a simple LLM application that is made up of two services: a client and a server. The client will create the trace and the parent span, while the server will add a nested span. In order to do this, the trace context (including the trace id and the parent span id) will be formatted according to the W3C TraceContext specification and passed in the headers of the request from the client to the server, MLflow provides two APIs to make it easier to fetch headers in the client and ingest them in the server:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:["Use the ",(0,r.jsx)(i.B,{fn:"mlflow.tracing.get_tracing_context_headers_for_http_request"})," API in the client to fetch headers."]}),"\n",(0,r.jsxs)(t.li,{children:["Use the ",(0,r.jsx)(i.B,{fn:"mlflow.tracing.set_tracing_context_from_http_request_headers"})," API in the server to extract the trace and span information from the request headers and set them to current trac context."]}),"\n"]}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsx)(t.img,{alt:"Tracing Decorator",src:l(77579).A+"",width:"2230",height:"1142"})}),"\n",(0,r.jsx)(t.h2,{id:"client-example",children:"Client example"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",children:'import requests\nimport mlflow\nfrom mlflow.tracing import get_tracing_context_headers_for_http_request\n\nwith mlflow.start_span("client-root"):\n    headers = get_tracing_context_headers_for_http_request()\n    requests.post(\n        "https://your.service/handle", headers=headers, json={"input": "hello"}\n    )\n'})}),"\n",(0,r.jsx)(t.h2,{id:"server-handler-example",children:"Server handler example"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",children:'import mlflow\nfrom flask import Flask, request\nfrom mlflow.tracing import set_tracing_context_from_http_request_headers\n\napp = Flask(__name__)\n\n\n@app.post("/handle")\ndef handle():\n    headers = dict(request.headers)\n    with set_tracing_context_from_http_request_headers(headers):\n        with mlflow.start_span("server-handler") as span:\n            # ... your logic ...\n            span.set_attribute("status", "ok")\n    return {"ok": True}\n'})}),"\n",(0,r.jsx)(t.h2,{id:"limitation-in-databricks",children:"Limitation in Databricks"}),"\n",(0,r.jsxs)(t.p,{children:["If you set up MLflow tracking to Databricks, to make distributed tracing work, the trace destination must be set to Unity Catalog. Please refer to ",(0,r.jsx)(t.a,{href:"https://docs.databricks.com/aws/en/mlflow3/genai/tracing/trace-unity-catalog",children:"Store MLflow traces in Unity Catalog"})," for details."]})]})}function f(e={}){let{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},77579(e,t,l){l.d(t,{A:()=>n});let n=l.p+"assets/images/distributed-tracing-fe2c7bb6f698ad0135204756a8b57a3e.png"},54725(e,t,l){l.d(t,{B:()=>i});var n=l(74848);l(96540);var r=JSON.parse('{"mlflow.ag2":"api_reference/python_api/mlflow.ag2.html","mlflow.agno":"api_reference/python_api/mlflow.agno.html","mlflow.anthropic":"api_reference/python_api/mlflow.anthropic.html","mlflow.artifacts":"api_reference/python_api/mlflow.artifacts.html","mlflow.autogen":"api_reference/python_api/mlflow.autogen.html","mlflow.bedrock":"api_reference/python_api/mlflow.bedrock.html","mlflow.catboost":"api_reference/python_api/mlflow.catboost.html","mlflow.client":"api_reference/python_api/mlflow.client.html","mlflow.config":"api_reference/python_api/mlflow.config.html","mlflow.crewai":"api_reference/python_api/mlflow.crewai.html","mlflow.data":"api_reference/python_api/mlflow.data.html","mlflow.deployments":"api_reference/python_api/mlflow.deployments.html","mlflow.diviner":"api_reference/python_api/mlflow.diviner.html","mlflow.dspy":"api_reference/python_api/mlflow.dspy.html","mlflow.entities":"api_reference/python_api/mlflow.entities.html","mlflow.environment_variables":"api_reference/python_api/mlflow.environment_variables.html","mlflow.gateway":"api_reference/python_api/mlflow.gateway.html","mlflow.gemini":"api_reference/python_api/mlflow.gemini.html","mlflow.genai":"api_reference/python_api/mlflow.genai.html","mlflow.groq":"api_reference/python_api/mlflow.groq.html","mlflow.h2o":"api_reference/python_api/mlflow.h2o.html","mlflow.johnsnowlabs":"api_reference/python_api/mlflow.johnsnowlabs.html","mlflow.keras":"api_reference/python_api/mlflow.keras.html","mlflow.langchain":"api_reference/python_api/mlflow.langchain.html","mlflow.lightgbm":"api_reference/python_api/mlflow.lightgbm.html","mlflow.litellm":"api_reference/python_api/mlflow.litellm.html","mlflow.llama_index":"api_reference/python_api/mlflow.llama_index.html","mlflow.metrics":"api_reference/python_api/mlflow.metrics.html","mlflow.mistral":"api_reference/python_api/mlflow.mistral.html","mlflow.models":"api_reference/python_api/mlflow.models.html","mlflow.onnx":"api_reference/python_api/mlflow.onnx.html","mlflow.openai":"api_reference/python_api/mlflow.openai.html","mlflow.paddle":"api_reference/python_api/mlflow.paddle.html","mlflow.pmdarima":"api_reference/python_api/mlflow.pmdarima.html","mlflow.projects":"api_reference/python_api/mlflow.projects.html","mlflow.prophet":"api_reference/python_api/mlflow.prophet.html","mlflow.pydantic_ai":"api_reference/python_api/mlflow.pydantic_ai.html","mlflow.pyfunc":"api_reference/python_api/mlflow.pyfunc.html","mlflow.pyspark.ml":"api_reference/python_api/mlflow.pyspark.ml.html","mlflow.pytorch":"api_reference/python_api/mlflow.pytorch.html","mlflow":"api_reference/python_api/mlflow.html","mlflow.sagemaker":"api_reference/python_api/mlflow.sagemaker.html","mlflow.sentence_transformers":"api_reference/python_api/mlflow.sentence_transformers.html","mlflow.server":"api_reference/python_api/mlflow.server.html","mlflow.shap":"api_reference/python_api/mlflow.shap.html","mlflow.sklearn":"api_reference/python_api/mlflow.sklearn.html","mlflow.smolagents":"api_reference/python_api/mlflow.smolagents.html","mlflow.spacy":"api_reference/python_api/mlflow.spacy.html","mlflow.spark":"api_reference/python_api/mlflow.spark.html","mlflow.statsmodels":"api_reference/python_api/mlflow.statsmodels.html","mlflow.system_metrics":"api_reference/python_api/mlflow.system_metrics.html","mlflow.tensorflow":"api_reference/python_api/mlflow.tensorflow.html","mlflow.tracing":"api_reference/python_api/mlflow.tracing.html","mlflow.transformers":"api_reference/python_api/mlflow.transformers.html","mlflow.types":"api_reference/python_api/mlflow.types.html","mlflow.utils":"api_reference/python_api/mlflow.utils.html","mlflow.webhooks":"api_reference/python_api/mlflow.webhooks.html","mlflow.xgboost":"api_reference/python_api/mlflow.xgboost.html","mlflow.server.auth":"api_reference/auth/python-api.html","mlflow.server.cli":"api_reference/cli.html","mlflow.r":"api_reference/R-api.html","mlflow.java":"api_reference/java_api/index.html","mlflow.python":"api_reference/python_api/index.html","mlflow.rest":"api_reference/rest-api.html","mlflow.typescript":"api_reference/typescript_api/index.html","mlflow.llms.deployments.api":"api_reference/llms/deployments/api.html"}'),a=l(66497);function i({fn:e,children:t,hash:l}){let i=(e=>{let t=e.split(".");for(let e=t.length;e>0;e--){let l=t.slice(0,e).join(".");if(r[l])return l}return null})(e);if(!i)return(0,n.jsx)(n.Fragment,{children:t});let o=(0,a.default)(`/${r[i]}#${l??e}`);return(0,n.jsx)("a",{href:o,target:"_blank",children:t??(0,n.jsxs)("code",{children:[e,"()"]})})}},28453(e,t,l){l.d(t,{R:()=>i,x:()=>o});var n=l(96540);let r={},a=n.createContext(r);function i(e){let t=n.useContext(a);return n.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),n.createElement(a.Provider,{value:t},e.children)}}}]);