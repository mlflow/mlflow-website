"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[1808],{14614:(e,n,t)=>{t.d(n,{A:()=>a});const a=t.p+"assets/images/pii_masking_langgraph-3aa1511ba847aa30b8de3bd2e8d8639b.png"},22014:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>p,contentTitle:()=>o,default:()=>f,frontMatter:()=>s,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"tracing/observe-with-traces/masking","title":"Redacting Sensitive Data from Traces","description":"Traces capture powerful insights for debugging and monitoring your application, however, they may contain sensitive data, such as Personal Identifiable Information (PII), that you don\'t want to share with others. MLflow provides a fully configurable way to mask sensitive data from traces before they are saved to the backend.","source":"@site/docs/genai/tracing/observe-with-traces/masking.mdx","sourceDirName":"tracing/observe-with-traces","slug":"/tracing/observe-with-traces/masking","permalink":"/mlflow-website/docs/latest/genai/tracing/observe-with-traces/masking","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"genAISidebar","previous":{"title":"Searching for Traces","permalink":"/mlflow-website/docs/latest/genai/tracing/search-traces"},"next":{"title":"Observe & Analyze Traces","permalink":"/mlflow-website/docs/latest/genai/tracing/observe-with-traces/"}}');var i=t(74848),l=t(28453),r=t(49374);const s={},o="Redacting Sensitive Data from Traces",p={},c=[{value:"How It Works",id:"how-it-works",level:2},{value:"Filtering Function",id:"filtering-function",level:2},{value:"Example 1: Redacting E-mail Address",id:"example-1-redacting-e-mail-address",level:2},{value:"Example 2: Applying a Filter to Particular Spans",id:"example-2-applying-a-filter-to-particular-spans",level:2},{value:"Example 3: Redacting PII using Microsoft Presidio",id:"example-3-redacting-pii-using-microsoft-presidio",level:2},{value:"Resetting the Filter",id:"resetting-the-filter",level:2}];function m(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,l.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"redacting-sensitive-data-from-traces",children:"Redacting Sensitive Data from Traces"})}),"\n",(0,i.jsxs)(n.p,{children:["Traces capture powerful insights for debugging and monitoring your application, however, they may contain sensitive data, such as ",(0,i.jsx)(n.strong,{children:"Personal Identifiable Information (PII)"}),", that you don't want to share with others. MLflow provides a fully configurable way to mask sensitive data from traces before they are saved to the backend."]}),"\n",(0,i.jsx)(n.h2,{id:"how-it-works",children:"How It Works"}),"\n",(0,i.jsx)(n.p,{children:"MLflow allows you to configure a list of post-processing hooks that are applied to each span in a trace. Each span processor is a function that takes a span as input and updates it in place."}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Define a custom filtering function and call ",(0,i.jsx)(r.B,{fn:"mlflow.tracing.configure",children:(0,i.jsx)(n.code,{children:"mlflow.tracing.configure"})})," to register it."]}),"\n",(0,i.jsx)(n.li,{children:"Whenever a new span is created, the registered filters are applied to it sequentially."}),"\n",(0,i.jsx)(n.li,{children:"MLflow sends the filtered span to the backend."}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Since the filters are applied at ",(0,i.jsx)(n.strong,{children:"client side"})," before sending the span to the backend, the sensitive data never goes out of your application."]}),"\n",(0,i.jsx)(n.h2,{id:"filtering-function",children:"Filtering Function"}),"\n",(0,i.jsxs)(n.p,{children:["A filtering function must take a single argument, which is a ",(0,i.jsx)(r.B,{fn:"mlflow.entities.span.Span",children:(0,i.jsx)(n.code,{children:"Span"})})," object. It can mutate the span in-place. It must not return a value."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"def filter_function(span: Span) -> None:\n    ...\n"})}),"\n",(0,i.jsx)(n.h2,{id:"example-1-redacting-e-mail-address",children:"Example 1: Redacting E-mail Address"}),"\n",(0,i.jsx)(n.p,{children:"In this example, we'll redact the e-mail address from the user inputs using a simple regex."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'import re\nimport mlflow\nfrom mlflow.entities.span import Span\n\n\n# Your application code (simplified)\n@mlflow.trace\ndef predict(text: str):\n    return "Answer"\n\n\n# Regex pattern to match e-mail addresses\nEMAIL_PATTERN = r"[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}"\n\n\n# Define a filtering function that takes a span as input and mutates it in-place.\ndef redact_email(span: Span) -> None:\n    raw_input = span.inputs.get("text")\n    redacted_input = re.sub(EMAIL_PATTERN, "[REDACTED]", raw_input)\n    span.set_inputs({"text": redacted_input})\n\n\n# Register the filter function\nmlflow.tracing.configure(span_processors=[redact_email])\n\n# Run the application\npredict("My e-mail address is test@example.com")\n'})}),"\n",(0,i.jsx)(n.p,{children:"The generated trace will have the e-mail address redacted in the inputs:"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Redacting e-mail address from trace",src:t(85214).A+"",width:"1231",height:"275"})}),"\n",(0,i.jsx)(n.h2,{id:"example-2-applying-a-filter-to-particular-spans",children:"Example 2: Applying a Filter to Particular Spans"}),"\n",(0,i.jsxs)(n.p,{children:["The filtering function registered at ",(0,i.jsx)(r.B,{fn:"mlflow.tracing.configure",children:(0,i.jsx)(n.code,{children:"mlflow.tracing.configure"})})," is applied to all spans. If your trace contains many nested spans, you may want to apply the filter only to certain spans. Also, the input/output format is typically different for different span types, so you may need to apply different filtering logic."]}),"\n",(0,i.jsx)(n.p,{children:"In the following example, we'll redact the bank account number from the trace, but using different filtering logic depending on the span type."}),"\n",(0,i.jsx)(n.p,{children:"First, let's define a simple tool calling agent."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'import mlflow\nfrom langchain_core.tools import tool\nfrom langchain_openai import ChatOpenAI\nfrom langgraph.prebuilt import create_react_agent\n\n# Enabling tracing for LangGraph\nmlflow.langchain.autolog()\n\n\n@tool\ndef get_bank_account_number(user_name: str):\n    """Return the bank account number for the given user name."""\n    return "1234567890"\n\n\nllm = ChatOpenAI(model="o4-mini")\ntools = [get_bank_account_number]\ngraph = create_react_agent(llm, tools)\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Then, let's define a filtering function. By checking the ",(0,i.jsx)(n.code,{children:"span_type"})," field, we can apply different filtering logic to different span types."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'import re\nfrom typing import Union\nfrom mlflow.entities.span import Span, SpanType\n\nACCOUNT_NUMBER_PATTERN = re.compile(r"\\d{10}")\n\n\ndef filter_bank_account_number(span: Span) -> None:\n    # Redact the output of the tool call span.\n    if span.span_type == SpanType.TOOL:\n        span.set_outputs("[REDACTED]")\n        return\n\n    # Redact the back account number from other spans.\n    if isinstance(span.inputs, dict) and (messages := span.inputs.get("messages")):\n        span.set_inputs({"messages": redact_messages(messages)})\n    if isinstance(span.outputs, dict) and (messages := span.outputs.get("messages")):\n        span.set_outputs({"messages": redact_messages(messages)})\n\n\ndef redact_messages(messages: list[dict]):\n    if isinstance(messages, dict):\n        messages = messages.get("messages")\n\n    return [\n        {**msg, "content": ACCOUNT_NUMBER_PATTERN.sub("[REDACTED]", msg["content"])}\n        for msg in messages\n    ]\n'})}),"\n",(0,i.jsx)(n.p,{children:"Now, let's register the filter function and run the application."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# Register the filter function\nmlflow.tracing.configure(span_processors=[filter_bank_account_number])\n\n# Run the application\nresult = graph.invoke(\n    {\n        "messages": [\n            {"role": "user", "content": "What is the bank account number for John Doe?"}\n        ]\n    }\n)\n'})}),"\n",(0,i.jsx)(n.p,{children:"The generated trace will have the bank account number redacted from all messages:"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Redacting bank account number from trace",src:t(14614).A+"",width:"1529",height:"729"})}),"\n",(0,i.jsx)(n.h2,{id:"example-3-redacting-pii-using-microsoft-presidio",children:"Example 3: Redacting PII using Microsoft Presidio"}),"\n",(0,i.jsxs)(n.p,{children:["To go beyond the simple Regex-based filtering, you can use a more sophisticated PII anonymizer such as ",(0,i.jsx)(n.a,{href:"https://microsoft.github.io/presidio/anonymizer/",children:"Microsoft Presidio"}),"."]}),"\n",(0,i.jsx)(n.p,{children:'In this example, we run a dummy custom support agent that takes user request such as "I want to cancel my credit card 4095-2609-9393-4932". The request contains many forms of sensitive data such as credit card number, user name, email address, and covering all of them using regex is not trivial.'}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'import mlflow\nfrom mlflow.entities.span import Span, SpanType\n\n\n# Dummy application code for custom support agent.\n@mlflow.trace(span_type=SpanType.AGENT)\ndef customer_support_agent(request: str):\n    return "Yes"\n'})}),"\n",(0,i.jsx)(n.p,{children:"With MLflow, plugging in Presidio for filtering sensitive data from traces is straightforward."}),"\n",(0,i.jsx)(n.p,{children:"First, install Presidio and download the classifier:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"pip install presidio_analyzer presidio_anonymizer\npython -m spacy download en_core_web_lg\n"})}),"\n",(0,i.jsx)(n.p,{children:"Then, define a filter function that runs Presidio's analyzer and anonymizer on the span input."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'from presidio_anonymizer import AnonymizerEngine\nfrom presidio_anonymizer.entities import RecognizerResult, OperatorConfig\n\n# Initialize the anonymizer and analyzer.\nanonymizer = AnonymizerEngine()\nanalyzer = AnalyzerEngine()\n\n\n# Define a filter function.\ndef filter_pii(span: Span) -> None:\n    """Filter PII from the span input using Microsoft Presidio."""\n    text = span.inputs.get("request")\n\n    results = analyzer.analyze(\n        text=text,\n        entities=["PERSON", "CREDIT_CARD", "EMAIL_ADDRESS", "LOCATION", "DATE_TIME"],\n        language="en",\n    )\n    anonymized_text = anonymizer.anonymize(text=text, analyzer_results=results)\n\n    span.set_inputs({"request": anonymized_text.text})\n'})}),"\n",(0,i.jsx)(n.p,{children:"Finally, let's register the filter function and run the application."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# Register the filter function\nmlflow.tracing.configure(span_processors=[filter_pii])\n\n# Run the application\ncustomer_support_agent(\n    "Please cancel my credit card effective September 19th. My name is John Doe and my credit "\n    "card number is 4095-2609-9393-4932. My email is john.doe@example.com and I live in Amsterdam."\n)\n'})}),"\n",(0,i.jsx)(n.p,{children:"The generated trace will have the PII redacted:"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Redacting PII from trace",src:t(55037).A+"",width:"1059",height:"295"})}),"\n",(0,i.jsx)(n.h2,{id:"resetting-the-filter",children:"Resetting the Filter"}),"\n",(0,i.jsxs)(n.p,{children:["To reset the filter, call ",(0,i.jsx)(r.B,{fn:"mlflow.tracing.configure",children:(0,i.jsx)(n.code,{children:"mlflow.tracing.configure"})})," with an empty list of span processors."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"mlflow.tracing.configure(span_processors=[])\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Alternatively, you can call ",(0,i.jsx)(r.B,{fn:"mlflow.tracing.reset",children:(0,i.jsx)(n.code,{children:"mlflow.tracing.reset"})})," to reset the entire tracing configuration."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"mlflow.tracing.reset()\n"})})]})}function f(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(m,{...e})}):m(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>s});var a=t(96540);const i={},l=a.createContext(i);function r(e){const n=a.useContext(l);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),a.createElement(l.Provider,{value:n},e.children)}},49374:(e,n,t)=>{t.d(n,{B:()=>s});t(96540);const a=JSON.parse('{"mlflow.ag2":"api_reference/python_api/mlflow.ag2.html","mlflow.anthropic":"api_reference/python_api/mlflow.anthropic.html","mlflow.artifacts":"api_reference/python_api/mlflow.artifacts.html","mlflow.autogen":"api_reference/python_api/mlflow.autogen.html","mlflow.bedrock":"api_reference/python_api/mlflow.bedrock.html","mlflow.catboost":"api_reference/python_api/mlflow.catboost.html","mlflow.client":"api_reference/python_api/mlflow.client.html","mlflow.config":"api_reference/python_api/mlflow.config.html","mlflow.crewai":"api_reference/python_api/mlflow.crewai.html","mlflow.data":"api_reference/python_api/mlflow.data.html","mlflow.deployments":"api_reference/python_api/mlflow.deployments.html","mlflow.diviner":"api_reference/python_api/mlflow.diviner.html","mlflow.dspy":"api_reference/python_api/mlflow.dspy.html","mlflow.entities":"api_reference/python_api/mlflow.entities.html","mlflow.environment_variables":"api_reference/python_api/mlflow.environment_variables.html","mlflow.gateway":"api_reference/python_api/mlflow.gateway.html","mlflow.gemini":"api_reference/python_api/mlflow.gemini.html","mlflow.genai":"api_reference/python_api/mlflow.genai.html","mlflow.groq":"api_reference/python_api/mlflow.groq.html","mlflow.h2o":"api_reference/python_api/mlflow.h2o.html","mlflow.johnsnowlabs":"api_reference/python_api/mlflow.johnsnowlabs.html","mlflow.keras":"api_reference/python_api/mlflow.keras.html","mlflow.langchain":"api_reference/python_api/mlflow.langchain.html","mlflow.lightgbm":"api_reference/python_api/mlflow.lightgbm.html","mlflow.litellm":"api_reference/python_api/mlflow.litellm.html","mlflow.llama_index":"api_reference/python_api/mlflow.llama_index.html","mlflow.metrics":"api_reference/python_api/mlflow.metrics.html","mlflow.mistral":"api_reference/python_api/mlflow.mistral.html","mlflow.models":"api_reference/python_api/mlflow.models.html","mlflow.onnx":"api_reference/python_api/mlflow.onnx.html","mlflow.openai":"api_reference/python_api/mlflow.openai.html","mlflow.paddle":"api_reference/python_api/mlflow.paddle.html","mlflow.pmdarima":"api_reference/python_api/mlflow.pmdarima.html","mlflow.projects":"api_reference/python_api/mlflow.projects.html","mlflow.promptflow":"api_reference/python_api/mlflow.promptflow.html","mlflow.prophet":"api_reference/python_api/mlflow.prophet.html","mlflow.pydantic_ai":"api_reference/python_api/mlflow.pydantic_ai.html","mlflow.pyfunc":"api_reference/python_api/mlflow.pyfunc.html","mlflow.pyspark.ml":"api_reference/python_api/mlflow.pyspark.ml.html","mlflow.pytorch":"api_reference/python_api/mlflow.pytorch.html","mlflow":"api_reference/python_api/mlflow.html","mlflow.sagemaker":"api_reference/python_api/mlflow.sagemaker.html","mlflow.sentence_transformers":"api_reference/python_api/mlflow.sentence_transformers.html","mlflow.server":"api_reference/python_api/mlflow.server.html","mlflow.shap":"api_reference/python_api/mlflow.shap.html","mlflow.sklearn":"api_reference/python_api/mlflow.sklearn.html","mlflow.smolagents":"api_reference/python_api/mlflow.smolagents.html","mlflow.spacy":"api_reference/python_api/mlflow.spacy.html","mlflow.spark":"api_reference/python_api/mlflow.spark.html","mlflow.statsmodels":"api_reference/python_api/mlflow.statsmodels.html","mlflow.system_metrics":"api_reference/python_api/mlflow.system_metrics.html","mlflow.tensorflow":"api_reference/python_api/mlflow.tensorflow.html","mlflow.tracing":"api_reference/python_api/mlflow.tracing.html","mlflow.transformers":"api_reference/python_api/mlflow.transformers.html","mlflow.types":"api_reference/python_api/mlflow.types.html","mlflow.utils":"api_reference/python_api/mlflow.utils.html","mlflow.xgboost":"api_reference/python_api/mlflow.xgboost.html","mlflow.server.auth":"api_reference/auth/python-api.html","mlflow.server.cli":"api_reference/cli.html","mlflow.r":"api_reference/R-api.html","mlflow.java":"api_reference/java_api/index.html","mlflow.python":"api_reference/python_api/index.html","mlflow.rest":"api_reference/rest-api.html","mlflow.llms.deployments.api":"api_reference/llms/deployments/api.html"}');var i=t(86025),l=t(74848);const r=e=>{const n=e.split(".");for(let t=n.length;t>0;t--){const e=n.slice(0,t).join(".");if(a[e])return e}return null};function s({fn:e,children:n,hash:t}){const s=r(e);if(!s)return(0,l.jsx)(l.Fragment,{children:n});const o=(0,i.Ay)(`/${a[s]}#${t??e}`);return(0,l.jsx)("a",{href:o,target:"_blank",children:n??(0,l.jsxs)("code",{children:[e,"()"]})})}},55037:(e,n,t)=>{t.d(n,{A:()=>a});const a=t.p+"assets/images/pii_masking_presidio-c94cbe4aee76f4c75dd7183f29e62858.png"},85214:(e,n,t)=>{t.d(n,{A:()=>a});const a=t.p+"assets/images/pii_masking_simple-281c75ff804afc78ac10c28e50f17db2.png"}}]);