"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[4776],{9588:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>p,contentTitle:()=>s,default:()=>f,frontMatter:()=>i,metadata:()=>l,toc:()=>m});const l=JSON.parse('{"id":"serving/agent-server","title":"MLflow Agent Server","description":"Agent Server Features","source":"@site/docs/genai/serving/agent-server.mdx","sourceDirName":"serving","slug":"/serving/agent-server","permalink":"/mlflow-website/docs/latest/genai/serving/agent-server","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"genAISidebar","previous":{"title":"MLflow Model Serving","permalink":"/mlflow-website/docs/latest/genai/serving/"},"next":{"title":"Responses Agent","permalink":"/mlflow-website/docs/latest/genai/serving/responses-agent"}}');var o=t(74848),r=t(28453),a=t(49374);const i={},s="MLflow Agent Server",p={},m=[{value:"Agent Server Features",id:"agent-server-features",level:2},{value:"Full Example",id:"full-example",level:2},{value:"Deploying and Testing Your Agent",id:"deploying-and-testing-your-agent",level:2},{value:"Evaluating Your Agent",id:"evaluating-your-agent",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"mlflow-agent-server",children:"MLflow Agent Server"})}),"\n",(0,o.jsx)(n.h2,{id:"agent-server-features",children:"Agent Server Features"}),"\n",(0,o.jsx)(n.admonition,{type:"note",children:(0,o.jsx)(n.p,{children:"The MLflow Agent Server was released with MLflow 3.6.0. It is currently under active development and is marked as Experimental. Public APIs are subject to change, and new features are being added to enhance its functionality."})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Simple FastAPI server to host agents at ",(0,o.jsx)(n.code,{children:"/invocations"})," endpoint"]}),"\n",(0,o.jsxs)(n.li,{children:["Decorator-based function registration (",(0,o.jsx)(n.code,{children:"@invoke"}),", ",(0,o.jsx)(n.code,{children:"@stream"}),") for easy agent development"]}),"\n",(0,o.jsx)(n.li,{children:"Automatic request and response validation for Responses API schema agents"}),"\n",(0,o.jsx)(n.li,{children:"Automatic MLflow tracing integration and aggregation"}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"full-example",children:"Full Example"}),"\n",(0,o.jsxs)(n.p,{children:["In this example, we'll use the openai-agents-sdk to define our Responses API compatible agent. See ",(0,o.jsx)(n.a,{href:"https://openai.github.io/openai-agents-python/quickstart/#create-your-first-agent",children:"the openai-agents-sdk quickstart"})," for more information."]}),"\n",(0,o.jsxs)(n.ol,{start:"0",children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Install the openai-agents-sdk and mlflow, and set your OpenAI API key:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"pip install -U openai-agents mlflow>=3.6.0\nexport OPENAI_API_KEY=sk-...\n"})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Define your agent in ",(0,o.jsx)(n.code,{children:"agent.py"})," and create methods to annotate with ",(0,o.jsx)(n.code,{children:"@invoke"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'from agents import Agent, Runner\nfrom mlflow.genai.agent_server import invoke, stream\nfrom mlflow.types.responses import ResponsesAgentRequest, ResponsesAgentResponse\n\nagent = Agent(\n    name="Math Tutor",\n    instructions="You provide help with math problems. Explain your reasoning and include examples",\n)\n\n\n@invoke()\nasync def non_streaming(request: ResponsesAgentRequest) -> ResponsesAgentResponse:\n    msgs = [i.model_dump() for i in request.input]\n    result = await Runner.run(agent, msgs)\n    return ResponsesAgentResponse(\n        output=[item.to_input_item() for item in result.new_items]\n    )\n\n\n# You can also optionally register a @stream function to support streaming responses\n'})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Define a ",(0,o.jsx)(n.code,{children:"start_server.py"})," file to start the ",(0,o.jsx)(n.code,{children:"AgentServer"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'# Need to import the agent to register the functions with the server\nimport agent  # noqa: F401\nfrom mlflow.genai.agent_server import (\n    AgentServer,\n    setup_mlflow_git_based_version_tracking,\n)\n\nagent_server = AgentServer("ResponsesAgent")\napp = agent_server.app\n\n# Optionally, set up MLflow git-based version tracking\n# to correspond your agent\'s traces to a specific git commit\nsetup_mlflow_git_based_version_tracking()\n\n\ndef main():\n    # To support multiple workers, pass the app as an import string\n    agent_server.run(app_import_string="start_server:app")\n\n\nif __name__ == "__main__":\n    main()\n'})}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"deploying-and-testing-your-agent",children:"Deploying and Testing Your Agent"}),"\n",(0,o.jsxs)(n.p,{children:["Run your agent server with the ",(0,o.jsx)(n.code,{children:"--reload"})," flag to automatically reload the server on code changes:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"python3 start_server.py --reload\n# Pass in a number of workers to support multiple concurrent requests\n# python3 start_server.py --workers 4\n# Pass in a port to run the server on\n# python3 start_server.py --reload --port 8000\n"})}),"\n",(0,o.jsx)(n.p,{children:"Send a request to the server to test your agent out:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'curl -X POST http://localhost:8000/invocations \\\n   -H "Content-Type: application/json" \\\n   -d \'{ "input": [{ "role": "user", "content": "What is the 14th Fibonacci number?"}]}\'\n'})}),"\n",(0,o.jsx)(n.p,{children:'After testing your agent, you can view the traces in the MLflow UI by clicking on "Traces" tab.'}),"\n",(0,o.jsxs)(n.p,{children:["If you have registered a ",(0,o.jsx)(n.code,{children:"@stream"})," function, you can send a streaming request to the server by passing in ",(0,o.jsx)(n.code,{children:'"stream": true'}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'curl -X POST http://localhost:8000/invocations \\\n   -H "Content-Type: application/json" \\\n   -d \'{\n    "input": [{ "role": "user", "content": "What is the 14th Fibonacci number?"}],\n    "stream": true\n    }\'\n'})}),"\n",(0,o.jsx)(n.h2,{id:"evaluating-your-agent",children:"Evaluating Your Agent"}),"\n",(0,o.jsxs)(n.p,{children:["You can use ",(0,o.jsx)(a.B,{fn:"mlflow.genai.evaluate"})," to evaluate your agent. See the ",(0,o.jsx)(n.a,{href:"/genai/eval-monitor/",children:"Evaluating Agents"})," guide and ",(0,o.jsx)(n.a,{href:"/genai/eval-monitor/scorers",children:"Scorer"})," documentation for more information."]}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Define a file like ",(0,o.jsx)(n.code,{children:"eval_agent.py"})," to evaluate your agent:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'import asyncio\n\nimport mlflow\n\n# need to import agent for our @invoke-registered function to be found\nfrom agent import agent  # noqa: F401\nfrom mlflow.genai.agent_server import get_invoke_function\nfrom mlflow.genai.scorers import RelevanceToQuery, Safety\nfrom mlflow.types.responses import ResponsesAgentRequest, ResponsesAgentResponse\n\neval_dataset = [\n    {\n        "inputs": {\n            "request": {\n                "input": [\n                    {"role": "user", "content": "What\'s the 15th Fibonacci number"}\n                ]\n            }\n        },\n        "expected_response": "The 15th Fibonacci number is 610.",\n    }\n]\n\n\ndef sync_invoke_fn(request: dict) -> ResponsesAgentResponse:\n    # Get the invoke function that was registered via @invoke decorator in your agent\n    invoke_fn = get_invoke_function()\n    return asyncio.run(invoke_fn(ResponsesAgentRequest(**request)))\n\n\nmlflow.genai.evaluate(\n    data=eval_dataset,\n    predict_fn=sync_invoke_fn,\n    scorers=[RelevanceToQuery(), Safety()],\n)\n'})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Run the evaluation:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"python3 eval_agent.py\n"})}),"\n",(0,o.jsx)(n.p,{children:"You should see the evaluation results and MLflow run information in the console output. In the MLflow UI, you can find the resulting runs from the evaluation on the experiment page. Click the run name to view the aggregated metrics and metadata in the overview pane."}),"\n"]}),"\n"]})]})}function f(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>i});var l=t(96540);const o={},r=l.createContext(o);function a(e){const n=l.useContext(r);return l.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),l.createElement(r.Provider,{value:n},e.children)}},49374:(e,n,t)=>{t.d(n,{B:()=>i});t(96540);const l=JSON.parse('{"mlflow.ag2":"api_reference/python_api/mlflow.ag2.html","mlflow.agno":"api_reference/python_api/mlflow.agno.html","mlflow.anthropic":"api_reference/python_api/mlflow.anthropic.html","mlflow.artifacts":"api_reference/python_api/mlflow.artifacts.html","mlflow.autogen":"api_reference/python_api/mlflow.autogen.html","mlflow.bedrock":"api_reference/python_api/mlflow.bedrock.html","mlflow.catboost":"api_reference/python_api/mlflow.catboost.html","mlflow.client":"api_reference/python_api/mlflow.client.html","mlflow.config":"api_reference/python_api/mlflow.config.html","mlflow.crewai":"api_reference/python_api/mlflow.crewai.html","mlflow.data":"api_reference/python_api/mlflow.data.html","mlflow.deployments":"api_reference/python_api/mlflow.deployments.html","mlflow.diviner":"api_reference/python_api/mlflow.diviner.html","mlflow.dspy":"api_reference/python_api/mlflow.dspy.html","mlflow.entities":"api_reference/python_api/mlflow.entities.html","mlflow.environment_variables":"api_reference/python_api/mlflow.environment_variables.html","mlflow.gateway":"api_reference/python_api/mlflow.gateway.html","mlflow.gemini":"api_reference/python_api/mlflow.gemini.html","mlflow.genai":"api_reference/python_api/mlflow.genai.html","mlflow.groq":"api_reference/python_api/mlflow.groq.html","mlflow.h2o":"api_reference/python_api/mlflow.h2o.html","mlflow.johnsnowlabs":"api_reference/python_api/mlflow.johnsnowlabs.html","mlflow.keras":"api_reference/python_api/mlflow.keras.html","mlflow.langchain":"api_reference/python_api/mlflow.langchain.html","mlflow.lightgbm":"api_reference/python_api/mlflow.lightgbm.html","mlflow.litellm":"api_reference/python_api/mlflow.litellm.html","mlflow.llama_index":"api_reference/python_api/mlflow.llama_index.html","mlflow.metrics":"api_reference/python_api/mlflow.metrics.html","mlflow.mistral":"api_reference/python_api/mlflow.mistral.html","mlflow.models":"api_reference/python_api/mlflow.models.html","mlflow.onnx":"api_reference/python_api/mlflow.onnx.html","mlflow.openai":"api_reference/python_api/mlflow.openai.html","mlflow.paddle":"api_reference/python_api/mlflow.paddle.html","mlflow.pmdarima":"api_reference/python_api/mlflow.pmdarima.html","mlflow.projects":"api_reference/python_api/mlflow.projects.html","mlflow.promptflow":"api_reference/python_api/mlflow.promptflow.html","mlflow.prophet":"api_reference/python_api/mlflow.prophet.html","mlflow.pydantic_ai":"api_reference/python_api/mlflow.pydantic_ai.html","mlflow.pyfunc":"api_reference/python_api/mlflow.pyfunc.html","mlflow.pyspark.ml":"api_reference/python_api/mlflow.pyspark.ml.html","mlflow.pytorch":"api_reference/python_api/mlflow.pytorch.html","mlflow":"api_reference/python_api/mlflow.html","mlflow.sagemaker":"api_reference/python_api/mlflow.sagemaker.html","mlflow.sentence_transformers":"api_reference/python_api/mlflow.sentence_transformers.html","mlflow.server":"api_reference/python_api/mlflow.server.html","mlflow.shap":"api_reference/python_api/mlflow.shap.html","mlflow.sklearn":"api_reference/python_api/mlflow.sklearn.html","mlflow.smolagents":"api_reference/python_api/mlflow.smolagents.html","mlflow.spacy":"api_reference/python_api/mlflow.spacy.html","mlflow.spark":"api_reference/python_api/mlflow.spark.html","mlflow.statsmodels":"api_reference/python_api/mlflow.statsmodels.html","mlflow.system_metrics":"api_reference/python_api/mlflow.system_metrics.html","mlflow.tensorflow":"api_reference/python_api/mlflow.tensorflow.html","mlflow.tracing":"api_reference/python_api/mlflow.tracing.html","mlflow.transformers":"api_reference/python_api/mlflow.transformers.html","mlflow.types":"api_reference/python_api/mlflow.types.html","mlflow.utils":"api_reference/python_api/mlflow.utils.html","mlflow.webhooks":"api_reference/python_api/mlflow.webhooks.html","mlflow.xgboost":"api_reference/python_api/mlflow.xgboost.html","mlflow.server.auth":"api_reference/auth/python-api.html","mlflow.server.cli":"api_reference/cli.html","mlflow.r":"api_reference/R-api.html","mlflow.java":"api_reference/java_api/index.html","mlflow.python":"api_reference/python_api/index.html","mlflow.rest":"api_reference/rest-api.html","mlflow.typescript":"api_reference/typescript_api/index.html","mlflow.llms.deployments.api":"api_reference/llms/deployments/api.html"}');var o=t(86025),r=t(74848);const a=e=>{const n=e.split(".");for(let t=n.length;t>0;t--){const e=n.slice(0,t).join(".");if(l[e])return e}return null};function i({fn:e,children:n,hash:t}){const i=a(e);if(!i)return(0,r.jsx)(r.Fragment,{children:n});const s=(0,o.default)(`/${l[i]}#${t??e}`);return(0,r.jsx)("a",{href:s,target:"_blank",children:n??(0,r.jsxs)("code",{children:[e,"()"]})})}}}]);