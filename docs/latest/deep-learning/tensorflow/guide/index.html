
  

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Tensorflow within MLflow &mdash; MLflow 2.9.3.dev0 documentation</title>
  
   
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="canonical" href="https://mlflow.org/docs/latest/deep-learning/tensorflow/guide/index.html">
  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    

    

  
    

  

  
  
    

  

  
  
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600" rel="stylesheet">
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/cards.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/grids.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/mobile.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/simple-cards.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/tabs.css" type="text/css" />
    
  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="MLflow 2.9.3.dev0 documentation" href="../../../index.html"/>
        <link rel="up" title="MLflow Tensorflow Integration" href="../index.html"/>
        <link rel="next" title="MLflow PyTorch Flavor" href="/../../pytorch/index.html"/>
        <link rel="prev" title="Get Started with MLflow + Tensorflow" href="/../quickstart/quickstart_tensorflow.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>
<script type="text/javascript" src="../../../_static/jquery.js"></script>
<script type="text/javascript" src="../../../_static/underscore.js"></script>
<script type="text/javascript" src="../../../_static/doctools.js"></script>
<script type="text/javascript" src="../../../_static/languagesections.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>

<body class="wy-body-for-nav" role="document">
  

  
  <nav class="wy-nav-top header" role="navigation" aria-label="top navigation">
    <ul>
  <li class="menu-toggle">
    <i data-toggle="wy-nav-top" class="wy-nav-top-menu-button db-icon db-icon-menu pull-left"></i>
    <a href="../../../index.html" class="wy-nav-top-logo"
      ><img src="../../../_static/MLflow-logo-final-black.png" alt="MLflow"
    /></a>
    <span class="version">2.9.3.dev0</span>
  </li>
</ul>
  </nav>
  <page>
    

    <nav data-toggle="wy-nav-shift" class="wy-nav-side relative">
      <div class="wy-side-scroll">
  <div class="wy-side-nav-search">
    

    

    
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
  </form>
</div>


    
  </div>

  <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
    
      <a href="../../../index.html" class="main-navigation-home"><img src="../../../_static/icons/nav-home.svg"> MLflow</a>
    

    
      

      
        <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/index.html">What is MLflow?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started/index.html">Getting Started with MLflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../new-features/index.html">New Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../llms/index.html">LLMs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../model-evaluation/index.html">Model Evaluation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Deep Learning</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../index.html#why-mlflow-for-deep-learning">Why MLflow for Deep Learning?</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../index.html#native-library-support">Native Library Support</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../keras/index.html">MLflow Keras 3.0 Integration</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">MLflow Tensorflow Integration</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../index.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="../index.html#minute-quick-start-with-the-mlflow-tensorflow-flavor">5 Minute Quick Start with the MLflow Tensorflow Flavor</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="../index.html#id1">Developer Guide of Tensorflow with MLflow</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../pytorch/index.html">MLflow PyTorch Flavor</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../traditional-ml/index.html">Traditional ML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../deployment/index.html">Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tracking.html">MLflow Tracking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../system-metrics/index.html">System Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../projects.html">MLflow Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../models.html">MLflow Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../model-registry.html">MLflow Model Registry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../recipes.html">MLflow Recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../plugins.html">MLflow Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auth/index.html">MLflow Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cli.html">Command-Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../search-runs.html">Search Runs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../search-experiments.html">Search Experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../python_api/index.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../R-api.html">R API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../java_api/index.html">Java API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rest-api.html">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docker.html">Official MLflow Docker Image</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community-model-flavors.html">Community Model Flavors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials-and-examples/index.html">Tutorials and Examples</a></li>
</ul>

      
    
  </div>

  <div role="contentinfo">
    

    <p>
      <a id='feedbacklink' href="https://github.com/mlflow/mlflow/blob/master/CONTRIBUTING.md" target="_blank">Contribute</a>
    </p>
  </div>
</div>
    </nav>

    <main class="wy-grid-for-nav">
      <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
        <div class="wy-nav-content">
          <div class="rst-content">
            










<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Documentation</a> <span class="db-icon db-icon-chevron-right"></span></li>
    
        <li><a href="../../index.html">Deep Learning</a> <span class="db-icon db-icon-chevron-right"></span></li>
    
        <li><a href="../index.html">MLflow Tensorflow Integration</a> <span class="db-icon db-icon-chevron-right"></span></li>
    
    
      <li>Tensorflow within MLflow</li>
    
    
    <!-- <li class="wy-breadcrumbs-aside">
      <a href="https://github.com/mlflow/mlflow/blob/master/docs/source/deep-learning/tensorflow/guide/index.rst" class="fa fa-github"> Edit on GitHub</a>
    </li> -->
    
  </ul>
</div>
            <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
              <div itemprop="articleBody">
                
  <div class="section" id="tensorflow-within-mlflow">
<h1>Tensorflow within MLflow<a class="headerlink" href="#tensorflow-within-mlflow" title="Permalink to this headline"> </a></h1>
<p>In this guide we will walk you through how to use Tensorflow within MLflow. We will demonstrate
how to track your Tensorflow experiments and log your Tensorflow models to MLflow.</p>
<div class="section" id="autologging-tensorflow-experiments">
<h2>Autologging Tensorflow Experiments<a class="headerlink" href="#autologging-tensorflow-experiments" title="Permalink to this headline"> </a></h2>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Autologging is only supported when you are using the <code class="docutils literal notranslate"><span class="pre">model.fit()</span></code> Keras API to train
the model. Additionally only Tensorflow &gt;= 2.3.0 is supported. If you are using an older version
of Tensorflow or Tensorflow without Keras, please use manual logging.</p>
</div>
<p>MLflow can automatically log metrics and parameters from your Tensorflow training. To enable
autologging, simply run <a class="reference internal" href="../../../python_api/mlflow.tensorflow.html#mlflow.tensorflow.autolog" title="mlflow.tensorflow.autolog"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.tensorflow.autolog()</span></code></a> or <a class="reference internal" href="../../../python_api/mlflow.html#mlflow.autolog" title="mlflow.autolog"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.autolog()</span></code></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>

<span class="n">mlflow</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">autolog</span><span class="p">()</span>

<span class="c1"># Prepare data for a 2-class classification.</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<span class="n">label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">([</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPool2D</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Softmax</span><span class="p">(),</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">SparseCategoricalCrossentropy</span><span class="p">(),</span>
    <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="mf">0.001</span><span class="p">),</span>
    <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">keras</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">SparseCategoricalAccuracy</span><span class="p">()],</span>
<span class="p">)</span>

<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">():</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="what-is-logged-by-autologging">
<h3>What is Logged by Autologging?<a class="headerlink" href="#what-is-logged-by-autologging" title="Permalink to this headline"> </a></h3>
<p>By default, autologging logs the following to MLflow:</p>
<ul class="simple">
<li><p>The model summary as returned by <code class="docutils literal notranslate"><span class="pre">model.summary()</span></code>.</p></li>
<li><p>Training hyperparamers, e.g., batch size and epochs.</p></li>
<li><p>Optimizer configs, e.g., optimizer name and learning rate.</p></li>
<li><p>Dataset information.</p></li>
<li><p>Training and validation metrics, including loss and any metrics specified in <code class="docutils literal notranslate"><span class="pre">model.compile()</span></code>.</p></li>
<li><p>Saved model after training completes in the format of TF saved model (compiled graph).</p></li>
</ul>
<p>You can customize autologging behavior by passing arguments to <a class="reference internal" href="../../../python_api/mlflow.tensorflow.html#mlflow.tensorflow.autolog" title="mlflow.tensorflow.autolog"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.tensorflow.autolog()</span></code></a>,
for example if you don’t want to log the dataset information, then you can run
<code class="docutils literal notranslate"><span class="pre">mlflow.tensorflow.autolog(log_dataset_info=False)</span></code>. Please refer to the API documentation
<a class="reference internal" href="../../../python_api/mlflow.tensorflow.html#mlflow.tensorflow.autolog" title="mlflow.tensorflow.autolog"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.tensorflow.autolog()</span></code></a> for full customization options.</p>
</div>
<div class="section" id="understanding-autologging">
<h3>Understanding Autologging<a class="headerlink" href="#understanding-autologging" title="Permalink to this headline"> </a></h3>
<p>The way we autolog Tensorflow is by registering a custom callback to the Keras model via monkey patch.
Briefly we attach a MLflow callback to the Keras model that works similarly to normal Keras callbacks.
At training start, training parameters including epochs, batch_size, learning_rate and model information
such as model summary will be logged. In addition, the callback will be triggered per <code class="docutils literal notranslate"><span class="pre">every_n_iter</span></code>
epochs to log the training metrics, and after the training finishes, the trained model will be saved to MLflow.</p>
</div>
</div>
<div class="section" id="logging-to-mlflow-with-keras-callback">
<h2>Logging to MLflow with Keras Callback<a class="headerlink" href="#logging-to-mlflow-with-keras-callback" title="Permalink to this headline"> </a></h2>
<p>As discussed in the previous section, MLflow autologging for Tensorflow is simply using a Keras
callback. If you wish to log additional information that isn’t provided by the base autologging
implementation via this default callback, you can write your own callback to log custom information.</p>
<div class="section" id="using-the-predefined-callback">
<h3>Using the Predefined Callback<a class="headerlink" href="#using-the-predefined-callback" title="Permalink to this headline"> </a></h3>
<p>MLflow offers a predefined callback <a class="reference internal" href="../../../python_api/mlflow.tensorflow.html#mlflow.tensorflow.MLflowCallback" title="mlflow.tensorflow.MLflowCallback"><code class="xref py py-class docutils literal notranslate"><span class="pre">mlflow.tensorflow.MLflowCallback</span></code></a> that you can use or
extend to log information to MLflow. The callback function provides the same functionality as autologging
and is suitable for users willing to have a better control of the experiment. Using <code class="docutils literal notranslate"><span class="pre">mlflow.tensorflow.MLflowCallback</span></code>
is the same as other Keras callbacks:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">():</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">label</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">mlflow</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">MLflowCallback</span><span class="p">()],</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>You can change the logging frequency in <a class="reference internal" href="../../../python_api/mlflow.tensorflow.html#mlflow.tensorflow.MLflowCallback" title="mlflow.tensorflow.MLflowCallback"><code class="xref py py-class docutils literal notranslate"><span class="pre">mlflow.tensorflow.MLflowCallback</span></code></a> by setting
<code class="docutils literal notranslate"><span class="pre">log_every_epoch</span></code> and <code class="docutils literal notranslate"><span class="pre">log_every_n_steps</span></code>, by default metrics are logged per epoch. Please refer to
the API documentation for more details.</p>
</div>
<div class="section" id="customizing-mlflow-logging">
<h3>Customizing MLflow Logging<a class="headerlink" href="#customizing-mlflow-logging" title="Permalink to this headline"> </a></h3>
<p>You can also write your own callback to log information to MLflow. To do that, you need to define
a class subclassing from <a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/keras/callbacks/Callback">keras.callbacks.Callback</a>,
which provides hooks at various stages of training and validation, e.g., <code class="docutils literal notranslate"><span class="pre">on_epoch_end</span></code> and
<code class="docutils literal notranslate"><span class="pre">on_train_end</span></code> are called separately at the end of each epoch and when the training is finished.
You can then use the callback in <code class="docutils literal notranslate"><span class="pre">model.fit()</span></code>. Here is a simple example for logging the training metrics
in log scale:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">mlflow</span>

<span class="k">class</span> <span class="nc">MLflowCallback</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">Callback</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">logs</span> <span class="o">=</span> <span class="n">logs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">logs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;log_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">step</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>
</pre></div>
</div>
<p>At the conclusion of each epoch, the <code class="docutils literal notranslate"><span class="pre">logs</span></code> object will contain <code class="docutils literal notranslate"><span class="pre">loss</span></code> and <code class="docutils literal notranslate"><span class="pre">metrics</span></code> as defined
in <code class="docutils literal notranslate"><span class="pre">model.compile()</span></code>. For full documentation of the Keras callback API, please
read <a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/keras/callbacks/Callback">keras.callbacks.Callback</a>.</p>
</div>
</div>
<div class="section" id="saving-your-tensorflow-model-to-mlflow">
<h2>Saving Your Tensorflow Model to MLflow<a class="headerlink" href="#saving-your-tensorflow-model-to-mlflow" title="Permalink to this headline"> </a></h2>
<p>If you have turned on the autologging, your Tensorflow model will be automatically saved after the training
is done. If you prefer to explicitly save your model, you can instead manually call
<a class="reference internal" href="../../../python_api/mlflow.tensorflow.html#mlflow.tensorflow.log_model" title="mlflow.tensorflow.log_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.tensorflow.log_model()</span></code></a>. After saving, you can load back the model using
<a class="reference internal" href="../../../python_api/mlflow.tensorflow.html#mlflow.tensorflow.load_model" title="mlflow.tensorflow.load_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.tensorflow.load_model()</span></code></a>. The loaded model can be used for inference by calling
the <code class="docutils literal notranslate"><span class="pre">predict()</span></code> method.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">([</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPool2D</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Softmax</span><span class="p">(),</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">save_path</span> <span class="o">=</span> <span class="s2">&quot;model&quot;</span>
<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">()</span> <span class="k">as</span> <span class="n">run</span><span class="p">:</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">)</span>

<span class="c1"># Load back the model.</span>
<span class="n">loaded_model</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;runs:/</span><span class="si">{</span><span class="n">run</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">run_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">loaded_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">3</span><span class="p">])))</span>
</pre></div>
</div>
<div class="section" id="diving-into-saving">
<h3>Diving into Saving<a class="headerlink" href="#diving-into-saving" title="Permalink to this headline"> </a></h3>
<p>Under the hood of saving, we are converting the Tensorflow model into a pyfunc model, which is a generic
type of model in MLflow. The pyfunc model is saved to MLflow. You don’t need to learn the basics of pyfunc
model to use Tensorflow flavor, but if you are interested, please refer to <a class="reference external" href="https://mlflow.org/docs/latest/models.html#how-to-load-and-score-python-function-models">MLflow pyfunc model</a>.</p>
<div class="section" id="saving-format">
<h4>Saving Format<a class="headerlink" href="#saving-format" title="Permalink to this headline"> </a></h4>
<p>By default, MLflow saves your Tensorflow model in the format of a TF saved model (compiled graph), which is
suitable for deployment across platforms. You can also save your model in other formats, i.e., <code class="docutils literal notranslate"><span class="pre">h5</span></code> and
<code class="docutils literal notranslate"><span class="pre">keras</span></code> by setting the <code class="docutils literal notranslate"><span class="pre">keras_model_kwargs</span></code> parameter in <a class="reference internal" href="../../../python_api/mlflow.tensorflow.html#mlflow.tensorflow.log_model" title="mlflow.tensorflow.log_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.tensorflow.log_model()</span></code></a>. For
example, if you want to save your model in <code class="docutils literal notranslate"><span class="pre">h5</span></code> format (which only saves model weights instead of the
compiled graph) you can run:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">([</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPool2D</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
        <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Softmax</span><span class="p">(),</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">save_path</span> <span class="o">=</span> <span class="s2">&quot;model&quot;</span>
<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">()</span> <span class="k">as</span> <span class="n">run</span><span class="p">:</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">keras_model_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;save_format&quot;</span><span class="p">:</span> <span class="s2">&quot;h5&quot;</span><span class="p">}</span>
    <span class="p">)</span>

<span class="c1"># Load back the model.</span>
<span class="n">loaded_model</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;runs:/</span><span class="si">{</span><span class="n">run</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">run_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">loaded_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">3</span><span class="p">])))</span>
</pre></div>
</div>
<p>For difference between the formats, please refer to <a class="reference external" href="https://www.tensorflow.org/guide/keras/save_and_serialize">Tensorflow Save and Load Guide</a>.
Please note that if you want to deploy your model, you will need to save your model in the TF saved model format.</p>
</div>
<div class="section" id="model-signature">
<h4>Model Signature<a class="headerlink" href="#model-signature" title="Permalink to this headline"> </a></h4>
<p>A model signature is a description of a model’s input and output. If you have enabled autologging and provided
a dataset, then the signature will be automatically inferred from the dataset. Otherwise, you need to provide
a signature in order to have the signature information viewable within the MLflow UI. A model signature will be
shown in the MLflow UI as follows:</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../../_images/tensorflow-model-signature.png"><img alt="Tensorflow Model Signature" src="../../../_images/tensorflow-model-signature.png" style="width: 90%;" /></a>
</div>
<p>To manually set the signature for your model, you can pass a <code class="docutils literal notranslate"><span class="pre">signature</span></code> parameter to
<a class="reference internal" href="../../../python_api/mlflow.tensorflow.html#mlflow.tensorflow.log_model" title="mlflow.tensorflow.log_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.tensorflow.log_model()</span></code></a>. You will need to set the input schema by specifying the <code class="docutils literal notranslate"><span class="pre">dtype</span></code>
and <code class="docutils literal notranslate"><span class="pre">shape</span></code> of the input tensors, and wrap it with <a class="reference internal" href="../../../python_api/mlflow.types.html#mlflow.types.TensorSpec" title="mlflow.types.TensorSpec"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.types.TensorSpec()</span></code></a>. For example,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">mlflow.types</span> <span class="kn">import</span> <span class="n">Schema</span><span class="p">,</span> <span class="n">TensorSpec</span>
<span class="kn">from</span> <span class="nn">mlflow.models</span> <span class="kn">import</span> <span class="n">ModelSignature</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">([</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPool2D</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Softmax</span><span class="p">(),</span>
<span class="p">])</span>

<span class="n">input_schema</span> <span class="o">=</span> <span class="n">Schema</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">TensorSpec</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="s2">&quot;input&quot;</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">signature</span> <span class="o">=</span> <span class="n">ModelSignature</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">input_schema</span><span class="p">)</span>

<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">()</span> <span class="k">as</span> <span class="n">run</span><span class="p">:</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">signature</span><span class="o">=</span><span class="n">signature</span><span class="p">)</span>

<span class="c1"># Load back the model.</span>
<span class="n">loaded_model</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">tensorflow</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;runs:/</span><span class="si">{</span><span class="n">run</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">run_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">loaded_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">3</span><span class="p">])))</span>
</pre></div>
</div>
<p>Please note that a model signature is not necessary for loading a model. You can still load the model
and perform inferenece if you know the input format. However, it’s a good practice to include the signature
for better model understanding.</p>
</div>
</div>
</div>
</div>


              </div>
            </div>
            <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../quickstart/quickstart_tensorflow.html" class="btn btn-neutral" title="Get Started with MLflow + Tensorflow" accesskey="p"><span class="db-icon db-icon-chevron-left"></span> Previous</a>
      
      
        <a href="../../pytorch/index.html" class="btn btn-neutral" title="MLflow PyTorch Flavor" accesskey="n">Next <span class="db-icon db-icon-chevron-right"></span></a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
      <p class="copyright">
          &copy; MLflow Project, a Series of LF Projects, LLC. All rights reserved.
      </p>

  </div> 

</footer>
          </div>
        </div>
      </section>
    </main>
  </page>

  


  
  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
      URL_ROOT:'../../../',
      VERSION:'2.9.3.dev0',
      COLLAPSE_INDEX:false,
      FILE_SUFFIX:'.html',
      LINK_SUFFIX: '.html',
      HAS_SOURCE:  true
    };
  </script>

  

  <script type="text/javascript" src="../../../_static/js/clipboard.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/jquery.waypoints.min.js"></script>

  
  
  
  <script type="text/javascript">var CLIPPY_SVG_PATH = "../../../_static/clippy.svg";</script>
  <script type="text/javascript" src="../../../_static/js/custom.js"></script>
  

  
  
  <script type="text/javascript">
    jQuery(function () {
      SphinxRtdTheme.StickyNav.enable();
    });

  </script>
  

  
  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }
        // Get the code block designator class entries
        const allHighlights = document.querySelectorAll('.highlight');
        // Disable copyable links for notebook cell numbering and for cell outputs
        const highlights = Array.from(allHighlights).filter(highlight => !highlight.closest('.highlight-none') && 
            !highlight.closest('.nboutput'));
    
        highlights.forEach(function(highlight) {
            const copyIcon = document.createElement('span');
            copyIcon.classList.add('copy-icon');
            copyIcon.innerHTML = '&#xf0ea;';

            copyIcon.addEventListener('click', function() {
                const code = highlight.querySelector('pre').textContent;
                copyToClipboard(code);

                // Flash effect on click
                this.style.color = '#0194E2';
                setTimeout(() => {
                    this.style.color = ''; 
                }, 100);

                // Display "Code copied to clipboard" near the clicked icon
                const message = document.createElement('span');
                message.textContent = "Copied!";
                message.classList.add('copy-message'); 

                // Append the message to the icon
                this.appendChild(message);

                setTimeout(() => {
                    this.removeChild(message);
                }, 500);
            });

            highlight.appendChild(copyIcon);
        });
    });
  </script>


<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {
        // Force download for notebook-download-btn
        const downloadButtons = document.querySelectorAll('.notebook-download-btn');
        downloadButtons.forEach(function(button) {
            button.addEventListener('click', function(event) {
                event.preventDefault(); // Prevent default behavior

                // Fetch the raw content of the notebook from GitHub
                fetch(button.href)
                    .then(response => response.blob())
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.style.display = 'none';
                        link.href = url;
                        const filename = button.href.split('/').pop();
                        link.download = filename; 

                        document.body.appendChild(link);
                        link.click();

                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(link);
                    })
                    .catch(err => console.error('Error fetching the notebook:', err));
            });
        });
    });
</script> 
</body>
</html>