

<!DOCTYPE html>
<!-- source: docs/source/llms/tracing/index.rst -->
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta content="MLflow Tracing is a feature that enables LLM observability in your apps. MLflow automatically logs traces for LangChain, LlamaIndex, and more." name="description" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>MLflow Tracing for LLM Observability</title>
  
   
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="canonical" href="https://mlflow.org/docs/latest/llms/tracing/index.html">
  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    

    

  
    
        <!-- Google Tag Manager -->
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer',"GTM-N6WMTTJ");</script>
        <!-- End Google Tag Manager -->
    

  

  
  
    

  

  
  
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600" rel="stylesheet">
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/cards.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/grids.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/mobile.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/simple-cards.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/tabs.css" type="text/css" />
    
  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="MLflow 2.19.1.dev0 documentation" href="../../index.html"/>
        <link rel="up" title="LLMs" href="../index.html"/>
        <link rel="next" title="Tracing Concepts" href="/overview.html"/>
        <link rel="prev" title="Build a tool-calling model with mlflow.pyfunc.ChatModel" href="/../notebooks/chat-model-tool-calling.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>
<script type="text/javascript" src="../../_static/jquery.js"></script>
<script type="text/javascript" src="../../_static/underscore.js"></script>
<script type="text/javascript" src="../../_static/doctools.js"></script>
<script type="text/javascript" src="../../_static/tabs.js"></script>
<script type="text/javascript" src="../../_static/languagesections.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
<script type="text/javascript" src="../../_static/runllm.js"></script>

<body class="wy-body-for-nav" role="document">
  
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-N6WMTTJ"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
  

  
  <nav class="wy-nav-top header" role="navigation" aria-label="top navigation">
    <ul>
  <li class="menu-toggle">
    <i data-toggle="wy-nav-top" class="wy-nav-top-menu-button db-icon db-icon-menu pull-left"></i>
    <a href="../../index.html" class="wy-nav-top-logo"
      ><img src="../../_static/MLflow-logo-final-black.png" alt="MLflow"
    /></a>
    <span class="version">2.19.1.dev0</span>
  </li>
</ul>
  </nav>
  <page>
    

    <nav data-toggle="wy-nav-shift" class="wy-nav-side relative">
      <div class="wy-side-scroll">
  <div class="wy-side-nav-search">
    

    

    
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
  </form>
</div>


    
  </div>

  <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
    
      <a href="../../index.html" class="main-navigation-home"><img src="../../_static/icons/nav-home.svg"> MLflow</a>
    

    
      

      
        <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction/index.html">MLflow Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/index.html">Getting Started with MLflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../new-features/index.html">New Features</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">LLMs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#tutorials-and-use-case-guides-for-genai-applications-in-mlflow">Tutorials and Use Case Guides for GenAI applications in MLflow</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#id1">MLflow Tracing</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">MLflow Tracing for LLM Observability</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#automatic-tracing">Automatic Tracing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tracing-fluent-apis">Tracing Fluent APIs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tracing-client-apis">Tracing Client APIs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#searching-and-retrieving-traces">Searching and Retrieving Traces</a></li>
<li class="toctree-l4"><a class="reference internal" href="#deleting-traces">Deleting Traces</a></li>
<li class="toctree-l4"><a class="reference internal" href="#data-model-and-schema">Data Model and Schema</a></li>
<li class="toctree-l4"><a class="reference internal" href="#trace-tags">Trace Tags</a></li>
<li class="toctree-l4"><a class="reference internal" href="#async-logging">Async Logging</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-opentelemetry-collector-for-exporting-traces">Using OpenTelemetry Collector for Exporting Traces</a></li>
<li class="toctree-l4"><a class="reference internal" href="#faq">FAQ</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="overview.html">Tracing Concepts</a></li>
<li class="toctree-l3"><a class="reference internal" href="tracing-schema.html">MLflow Tracing Schema</a></li>
<li class="toctree-l3"><a class="reference internal" href="contribute.html">Contributing to MLflow Tracing</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#id2">MLflow AI Gateway for LLMs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#id3">LLM Evaluation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#id4">Prompt Engineering UI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#native-mlflow-flavors-for-llms">Native MLflow Flavors for LLMs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#id5">LLM Tracking in MLflow</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">MLflow Tracing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#automatic-tracing">Automatic Tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tracing-fluent-apis">Tracing Fluent APIs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#initiating-a-trace">Initiating a Trace</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#trace-decorator">Trace Decorator</a></li>
<li class="toctree-l4"><a class="reference internal" href="#what-is-captured">What is captured?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#error-handling-with-traces">Error Handling with Traces</a></li>
<li class="toctree-l4"><a class="reference internal" href="#parent-child-relationships">Parent-child relationships</a></li>
<li class="toctree-l4"><a class="reference internal" href="#span-type">Span Type</a></li>
<li class="toctree-l4"><a class="reference internal" href="#context-handler">Context Handler</a></li>
<li class="toctree-l4"><a class="reference internal" href="#function-wrapping">Function wrapping</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#tracing-client-apis">Tracing Client APIs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#starting-a-trace">Starting a Trace</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-a-child-span">Adding a Child Span</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ending-a-span">Ending a Span</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ending-a-trace">Ending a Trace</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#searching-and-retrieving-traces">Searching and Retrieving Traces</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#searching-for-traces">Searching for Traces</a></li>
<li class="toctree-l3"><a class="reference internal" href="#retrieving-a-specific-trace">Retrieving a Specific Trace</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#deleting-traces">Deleting Traces</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data-model-and-schema">Data Model and Schema</a></li>
<li class="toctree-l2"><a class="reference internal" href="#trace-tags">Trace Tags</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#setting-tags-on-an-active-trace">Setting Tags on an Active Trace</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setting-tags-on-a-finished-trace">Setting Tags on a Finished Trace</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setting-tags-via-the-mlflow-ui">Setting Tags via the MLflow UI</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#async-logging">Async Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="#using-opentelemetry-collector-for-exporting-traces">Using OpenTelemetry Collector for Exporting Traces</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#configurations">Configurations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#faq">FAQ</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#q-can-i-disable-and-re-enable-tracing-globally">Q: Can I disable and re-enable tracing globally?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#q-how-can-i-associate-a-trace-with-an-mlflow-run">Q: How can I associate a trace with an MLflow Run?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#q-can-i-use-the-fluent-api-and-the-client-api-together">Q: Can I use the fluent API and the client API together?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#q-how-can-i-add-custom-metadata-to-a-span">Q: How can I add custom metadata to a span?</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#fluent-api">Fluent API</a></li>
<li class="toctree-l4"><a class="reference internal" href="#client-api">Client API</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#q-i-cannot-open-my-trace-in-the-mlflow-ui-what-should-i-do">Q: I cannot open my trace in the MLflow UI. What should I do?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#q-how-to-group-multiple-traces-within-a-single-conversation-session">Q. How to group multiple traces within a single conversation session?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#q-how-to-find-a-particular-span-within-a-trace">Q: How to find a particular span within a trace?</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../model-evaluation/index.html">Model Evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deep-learning/index.html">Deep Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../traditional-ml/index.html">Traditional ML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deployment/index.html">Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tracking.html">MLflow Tracking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../system-metrics/index.html">System Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../projects.html">MLflow Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../models.html">MLflow Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model-registry.html">MLflow Model Registry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../recipes.html">MLflow Recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plugins.html">MLflow Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../auth/index.html">MLflow Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli.html">Command-Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../search-runs.html">Search Runs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../search-experiments.html">Search Experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python_api/index.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../R-api.html">R API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../java_api/index.html">Java API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rest-api.html">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docker.html">Official MLflow Docker Image</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community-model-flavors.html">Community Model Flavors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials-and-examples/index.html">Tutorials and Examples</a></li>
</ul>

      
    
  </div>

  <div role="contentinfo">
    

    <p>
      <a id='feedbacklink' href="https://github.com/mlflow/mlflow/blob/master/CONTRIBUTING.md" target="_blank">Contribute</a>
    </p>
  </div>
</div>
    </nav>

    <main class="wy-grid-for-nav">
      <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
        <div class="wy-nav-content">
          <div class="rst-content">
            










<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Documentation</a> <span class="db-icon db-icon-chevron-right"></span></li>
    
        <li><a href="../index.html">LLMs</a> <span class="db-icon db-icon-chevron-right"></span></li>
    
    
      <li>MLflow Tracing for LLM Observability</li>
    
    
    <!-- <li class="wy-breadcrumbs-aside">
      <a href="https://github.com/mlflow/mlflow/blob/master/docs/source/llms/tracing/index.rst" class="fa fa-github"> Edit on GitHub</a>
    </li> -->
    
  </ul>
</div>
            <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
              <div itemprop="articleBody">
                
  <div class="section" id="mlflow-tracing-for-llm-observability">
<h1>MLflow Tracing for LLM Observability<a class="headerlink" href="#mlflow-tracing-for-llm-observability" title="Permalink to this headline"> </a></h1>
<p><strong>MLflow Tracing</strong> is a feature that enhances LLM observability in your Generative AI (GenAI) applications by capturing detailed information about the execution of your application’s services.
Tracing provides a way to record the inputs, outputs, and metadata associated with each intermediate step of a request, enabling you to easily pinpoint the source of bugs and unexpected behaviors.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/tracing-top.gif"><img alt="Tracing Gateway Video" src="../../_images/tracing-top.gif" style="width: 95%;" /></a>
</div>
<section>
    <div class="logo-grid">
        <a href="../langchain/autologging.html">
            <div class="logo-card">
                <img src="../../_static/images/logos/langchain-logo.png" alt="LangChain Logo"/>
            </div>
        </a>
        <a href="../langchain/autologging.html">
            <div class="logo-card">
                <img src="../../_static/images/logos/langgraph-logo.png" alt="LangGraph Logo"/>
            </div>
        </a>
        <a href="../llama-index/index.html##enable-tracing">
            <div class="logo-card">
                <img src="../../_static/images/logos/llamaindex-logo.svg" alt="LlamaIndex Logo"/>
            </div>
        </a>
        <a href="#automatic-tracing">
            <div class="logo-card">
                <img src="../../_static/images/logos/dspy-logo.png" alt="DSPy Logo"/>
            </div>
        </a>
        <a href="../openai/autologging.html">
            <div class="logo-card">
                <img src="../../_static/images/logos/openai-logo.png" alt="OpenAI Logo"/>
            </div>
        </a>
        <a href="../openai/autologging.html#auto-tracing-for-openai-swarm">
            <div class="logo-card">
                <img src="../../_static/images/logos/openai-swarm-logo.png" alt="OpenAI Swarm Logo"/>
            </div>
        </a>
        <a href="#automatic-tracing">
            <div class="logo-card">
                <img src="../../_static/images/logos/autogen-logo.png" alt="AutoGen Logo"/>
            </div>
        </a>
        <a href="#automatic-tracing">
            <div class="logo-card">
                <img src="../../_static/images/logos/google-gemini-logo.svg" alt="Gemini Logo"/>
            </div>
        </a>
        <a href="#automatic-tracing">
            <div class="logo-card">
                <img src="../../_static/images/logos/litellm-logo.jpg" alt="LiteLLM Logo"/>
            </div>
        </a>
        <a href="#automatic-tracing">
            <div class="logo-card">
                <img src="../../_static/images/logos/anthropic-logo.svg" alt="Anthropic Logo"/>
            </div>
        </a>
        <a href="#automatic-tracing">
            <div class="logo-card">
                <img src="../../_static/images/logos/crewai-logo.png" alt="CrewAI Logo"/>
            </div>
        </a>
        <a href="#automatic-tracing">
            <div class="logo-card">
                <img src="../../_static/images/logos/ollama-logo.png" alt="Ollama Logo"/>
            </div>
        </a>
        <a href="#automatic-tracing">
            <div class="logo-card">
                <img src="../../_static/images/logos/instructor-logo.svg" alt="Instructor Logo"/>
            </div>
        </a>
</section><p>MLflow offers a number of different options to enable tracing of your GenAI applications.</p>
<ul class="simple">
<li><p><strong>Automated tracing</strong>: MLflow provides fully automated integrations with various GenAI libraries such as LangChain, OpenAI, LlamaIndex, DSPy, AutoGen, and more that can be activated by simply enabling <code class="docutils literal notranslate"><span class="pre">mlflow.&lt;library&gt;.autolog()</span></code>.</p></li>
<li><p><strong>Manual trace instrumentation with high-level fluent APIs</strong>: Decorators, function wrappers and context managers via the fluent API allow you to add tracing functionality with minor code modifications.</p></li>
<li><p><strong>Low-level client APIs for tracing</strong>: The MLflow client API provides a thread-safe way to handle trace implementations, even in aysnchronous modes of operation.</p></li>
</ul>
<p>If you are new to the tracing or observability concepts, we recommend starting with the <a class="reference external" href="./overview.html">Tracing Concepts Overview</a> guide.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>MLflow Tracing support is available with the <strong>MLflow 2.14.0</strong> release.</p>
</div>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#automatic-tracing" id="id4">Automatic Tracing</a></p></li>
<li><p><a class="reference internal" href="#tracing-fluent-apis" id="id5">Tracing Fluent APIs</a></p></li>
<li><p><a class="reference internal" href="#tracing-client-apis" id="id6">Tracing Client APIs</a></p></li>
<li><p><a class="reference internal" href="#searching-and-retrieving-traces" id="id7">Searching and Retrieving Traces</a></p></li>
<li><p><a class="reference internal" href="#deleting-traces" id="id8">Deleting Traces</a></p></li>
<li><p><a class="reference internal" href="#data-model-and-schema" id="id9">Data Model and Schema</a></p></li>
<li><p><a class="reference internal" href="#trace-tags" id="id10">Trace Tags</a></p></li>
<li><p><a class="reference internal" href="#async-logging" id="id11">Async Logging</a></p></li>
<li><p><a class="reference internal" href="#using-opentelemetry-collector-for-exporting-traces" id="id12">Using OpenTelemetry Collector for Exporting Traces</a></p></li>
<li><p><a class="reference internal" href="#faq" id="id13">FAQ</a></p></li>
</ul>
</div>
<div class="section" id="automatic-tracing">
<h2><a class="toc-backref" href="#id4">Automatic Tracing</a><a class="headerlink" href="#automatic-tracing" title="Permalink to this headline"> </a></h2>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Is your favorite library missing from the list? Consider <a class="reference external" href="contribute.html">contributing to MLflow Tracing</a> or <a class="reference external" href="https://github.com/mlflow/mlflow/issues/new?assignees=&amp;labels=enhancement&amp;projects=&amp;template=feature_request_template.yaml&amp;title=%5BFR%5D">submitting a feature request</a> to our Github repository.</p>
</div>
<p>The easiest way to get started with MLflow Tracing is to leverage the built-in capabilities with MLflow’s integrated libraries. MLflow provides automatic tracing capabilities for some of the integrated libraries such as
LangChain, OpenAI, LlamaIndex, and AutoGen. For these libraries, you can instrument your code with
just a single command <code class="docutils literal notranslate"><span class="pre">mlflow.&lt;library&gt;.autolog()</span></code> and MLflow will automatically log traces
for model/API invocations to the active MLflow Experiment.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" role="tablist"><button aria-controls="panel-0-0-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-0-0-0" name="0-0" role="tab" tabindex="0">LangChain / LangGraph</button><button aria-controls="panel-0-0-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-1" name="0-1" role="tab" tabindex="-1">OpenAI</button><button aria-controls="panel-0-0-2" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-2" name="0-2" role="tab" tabindex="-1">Swarm</button><button aria-controls="panel-0-0-3" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-3" name="0-3" role="tab" tabindex="-1">Ollama</button><button aria-controls="panel-0-0-4" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-4" name="0-4" role="tab" tabindex="-1">Instructor</button><button aria-controls="panel-0-0-5" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-5" name="0-5" role="tab" tabindex="-1">LlamaIndex</button><button aria-controls="panel-0-0-6" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-6" name="0-6" role="tab" tabindex="-1">DSPy</button><button aria-controls="panel-0-0-7" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-7" name="0-7" role="tab" tabindex="-1">AutoGen</button><button aria-controls="panel-0-0-8" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-8" name="0-8" role="tab" tabindex="-1">Gemini</button><button aria-controls="panel-0-0-9" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-9" name="0-9" role="tab" tabindex="-1">LiteLLM</button><button aria-controls="panel-0-0-10" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-10" name="0-10" role="tab" tabindex="-1">Anthropic</button><button aria-controls="panel-0-0-11" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-11" name="0-11" role="tab" tabindex="-1">CrewAI</button></div><div aria-labelledby="tab-0-0-0" class="sphinx-tabs-panel" id="panel-0-0-0" name="0-0" role="tabpanel" tabindex="0"><h3>LangChain Automatic Tracing</h3><div class="line-block">
<div class="line"><br /></div>
</div>
<p>As part of the LangChain autologging integration, traces are logged to the active MLflow Experiment when calling invocation APIs on chains. You can enable tracing
for LangChain by calling the <a class="reference internal" href="../../python_api/mlflow.langchain.html#mlflow.langchain.autolog" title="mlflow.langchain.autolog"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.langchain.autolog()</span></code></a> function.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>

<span class="n">mlflow</span><span class="o">.</span><span class="n">langchain</span><span class="o">.</span><span class="n">autolog</span><span class="p">()</span>
</pre></div>
</div>
<p>In the full example below, the model and its associated metadata will be logged as a run, while the traces are logged separately to the active experiment. To learn more, please visit <a class="reference external" href="../langchain/autologging.html">LangChain Autologging documentation</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This example has been confirmed working with the following requirement versions:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span><span class="nv">mlflow</span><span class="o">==</span><span class="m">2</span>.18.0<span class="w"> </span><span class="nv">langchain</span><span class="o">==</span><span class="m">0</span>.3.0<span class="w"> </span>langchain-openai<span class="o">==</span><span class="m">0</span>.2.9
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">langchain.prompts</span> <span class="kn">import</span> <span class="n">PromptTemplate</span>
<span class="kn">from</span> <span class="nn">langchain_core.output_parsers</span> <span class="kn">import</span> <span class="n">StrOutputParser</span>
<span class="kn">from</span> <span class="nn">langchain_openai</span> <span class="kn">import</span> <span class="n">ChatOpenAI</span>

<span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="s2">&quot;LangChain Tracing&quot;</span><span class="p">)</span>

<span class="c1"># Enabling autolog for LangChain will enable trace logging.</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">langchain</span><span class="o">.</span><span class="n">autolog</span><span class="p">()</span>

<span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenAI</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">max_tokens</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="n">prompt_template</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span>
    <span class="s2">&quot;Answer the question as if you are </span><span class="si">{person}</span><span class="s2">, fully embodying their style, wit, personality, and habits of speech. &quot;</span>
    <span class="s2">&quot;Emulate their quirks and mannerisms to the best of your ability, embracing their traits—even if they aren&#39;t entirely &quot;</span>
    <span class="s2">&quot;constructive or inoffensive. The question is: </span><span class="si">{question}</span><span class="s2">&quot;</span>
<span class="p">)</span>

<span class="n">chain</span> <span class="o">=</span> <span class="n">prompt_template</span> <span class="o">|</span> <span class="n">llm</span> <span class="o">|</span> <span class="n">StrOutputParser</span><span class="p">()</span>

<span class="c1"># Let&#39;s test another call</span>
<span class="n">chain</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;person&quot;</span><span class="p">:</span> <span class="s2">&quot;Linus Torvalds&quot;</span><span class="p">,</span>
        <span class="s2">&quot;question&quot;</span><span class="p">:</span> <span class="s2">&quot;Can I just set everyone&#39;s access to sudo to make things easier?&quot;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
<p>If we navigate to the MLflow UI, we can see not only the model that has been auto-logged, but the traces as well, as shown in the video above.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/langchain-tracing.png"><img alt="LangChain Tracing via autolog" src="../../_images/langchain-tracing.png" style="width: 100%;" /></a>
</div>
</div><div aria-labelledby="tab-0-0-1" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-1" name="0-1" role="tabpanel" tabindex="0"><h3>OpenAI Automatic Tracing</h3><div class="line-block">
<div class="line"><br /></div>
</div>
<p>The <a class="reference external" href="../openai/index.html">MLflow OpenAI flavor</a>’s autologging feature has a direct integration with MLflow tracing. When OpenAI autologging is enabled with <a class="reference internal" href="../../python_api/openai/index.html#mlflow.openai.autolog" title="mlflow.openai.autolog"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.openai.autolog()</span></code></a>,
usage of the OpenAI SDK will automatically record generated traces during interactive development.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>

<span class="n">mlflow</span><span class="o">.</span><span class="n">openai</span><span class="o">.</span><span class="n">autolog</span><span class="p">()</span>
</pre></div>
</div>
<p>For example, the code below will log traces to the currently active experiment (in this case, the activated experiment <code class="docutils literal notranslate"><span class="pre">&quot;OpenAI&quot;</span></code>, set through the use
of the <a class="reference internal" href="../../python_api/mlflow.html#mlflow.set_experiment" title="mlflow.set_experiment"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.set_experiment()</span></code></a> API).
To learn more about OpenAI autologging, you can <a class="reference external" href="../openai/autologging.html">view the documentation here</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">openai</span>
<span class="kn">import</span> <span class="nn">mlflow</span>

<span class="c1"># Calling the autolog API will enable trace logging by default.</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">openai</span><span class="o">.</span><span class="n">autolog</span><span class="p">()</span>

<span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="s2">&quot;OpenAI&quot;</span><span class="p">)</span>

<span class="n">openai_client</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">OpenAI</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">))</span>

<span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;How can I improve my resting metabolic rate most effectively?&quot;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">]</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">openai_client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span>
    <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
    <span class="n">temperature</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</pre></div>
</div>
<p>The logged trace, associated with the <code class="docutils literal notranslate"><span class="pre">OpenAI</span></code> experiment, can be seen in the MLflow UI, as shown below:</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/openai-tracing.png"><img alt="OpenAI Tracing" src="../../_images/openai-tracing.png" style="width: 100%;" /></a>
</div>
</div><div aria-labelledby="tab-0-0-2" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-2" name="0-2" role="tabpanel" tabindex="0"><h3>OpenAI Swarm Automatic Tracing</h3><div class="line-block">
<div class="line"><br /></div>
</div>
<p>The <a class="reference external" href="../openai/index.html">MLflow OpenAI flavor</a> supports automatic tracing for <a class="reference external" href="https://github.com/openai/swarm">Swarm</a>, a multi-agent orchestration
framework from OpenAI. To enable tracing for <strong>Swarm</strong>, just call <a class="reference internal" href="../../python_api/openai/index.html#mlflow.openai.autolog" title="mlflow.openai.autolog"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.openai.autolog()</span></code></a>
before running your multi-agent interactions. MLflow will trace all LLM interactions,
tool calls, and agent operations automatically.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>

<span class="n">mlflow</span><span class="o">.</span><span class="n">openai</span><span class="o">.</span><span class="n">autolog</span><span class="p">()</span>
</pre></div>
</div>
<p>For example, the code below will run the simplest example of multi-agent interaction using OpenAI Swarm.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">from</span> <span class="nn">swarm</span> <span class="kn">import</span> <span class="n">Swarm</span><span class="p">,</span> <span class="n">Agent</span>

<span class="c1"># Calling the autolog API will enable trace logging by default.</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">openai</span><span class="o">.</span><span class="n">autolog</span><span class="p">()</span>

<span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="s2">&quot;OpenAI Swarm&quot;</span><span class="p">)</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">Swarm</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">transfer_to_agent_b</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">agent_b</span>


<span class="n">agent_a</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Agent A&quot;</span><span class="p">,</span>
    <span class="n">instructions</span><span class="o">=</span><span class="s2">&quot;You are a helpful agent.&quot;</span><span class="p">,</span>
    <span class="n">functions</span><span class="o">=</span><span class="p">[</span><span class="n">transfer_to_agent_b</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">agent_b</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Agent B&quot;</span><span class="p">,</span>
    <span class="n">instructions</span><span class="o">=</span><span class="s2">&quot;Only speak in Haikus.&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="n">agent</span><span class="o">=</span><span class="n">agent_a</span><span class="p">,</span>
    <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;I want to talk to agent B.&quot;</span><span class="p">}],</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</pre></div>
</div>
<p>The logged trace, associated with the <code class="docutils literal notranslate"><span class="pre">OpenAI</span> <span class="pre">Swarm</span></code> experiment, can be seen in the MLflow UI, as shown below:</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/openai-swarm-tracing.png"><img alt="OpenAI Swarm Tracing" src="../../_images/openai-swarm-tracing.png" style="width: 100%;" /></a>
</div>
</div><div aria-labelledby="tab-0-0-3" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-3" name="0-3" role="tabpanel" tabindex="0"><h3>Ollama Automatic Tracing</h3><div class="line-block">
<div class="line"><br /></div>
</div>
<p><a class="reference external" href="https://github.com/ollama/ollama">Ollama</a> is an open-source platform that enables users to run large language models (LLMs) locally on their devices, such as Llama 3.2, Gemma 2, Mistral, Code Llama, and more.</p>
<p>Since the local LLM endpoint served by Ollama is compatible with the OpenAI API, you can query it via OpenAI SDK and enable tracing for Ollama with <a class="reference internal" href="../../python_api/openai/index.html#mlflow.openai.autolog" title="mlflow.openai.autolog"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.openai.autolog()</span></code></a>. Any LLM interactions via Ollama will be recorded to the active MLflow Experiment.</p>
<ol class="arabic simple">
<li><p>Run the Ollama server with the desired LLM model.</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ollama<span class="w"> </span>run<span class="w"> </span>llama3.2:1b
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Enable auto-tracing for OpenAI SDK.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>

<span class="n">mlflow</span><span class="o">.</span><span class="n">openai</span><span class="o">.</span><span class="n">autolog</span><span class="p">()</span>

<span class="c1"># Optional, create an experiment to store traces</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="s2">&quot;Ollama&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Query the LLM and see the traces in the MLflow UI.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">(</span>
    <span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;http://localhost:11434/v1&quot;</span><span class="p">,</span>  <span class="c1"># The local Ollama REST endpoint</span>
    <span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;dummy&quot;</span><span class="p">,</span>  <span class="c1"># Required to instantiate OpenAI client, it can be a random string</span>
<span class="p">)</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;llama3.2:1b&quot;</span><span class="p">,</span>
    <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;You are a science teacher.&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Why is the sky blue?&quot;</span><span class="p">},</span>
    <span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/ollama-tracing.png"><img alt="Ollama Tracing" src="../../_images/ollama-tracing.png" style="width: 100%;" /></a>
</div>
</div><div aria-labelledby="tab-0-0-4" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-4" name="0-4" role="tabpanel" tabindex="0"><h3>Instructor Automatic Tracing</h3><div class="line-block">
<div class="line"><br /></div>
</div>
<p><a class="reference external" href="https://python.useinstructor.com">Instructor</a> is an open-source Python library built on top of Pydantic, simplifying structured LLM outputs with validation, retries, and streaming.</p>
<p>MLflow Tracing works with Instructor by enabling auto-tracing for the underlying LLM libraries.
For example, if you use Instructor for OpenAI LLMs, you can enable tracing with <a class="reference internal" href="../../python_api/openai/index.html#mlflow.openai.autolog" title="mlflow.openai.autolog"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.openai.autolog()</span></code></a> and the generated traces will capture the structured outputs from Instructor.</p>
<p>Similarly, you can also trace Instructor with other LLM providers, such as Anthropic, Gemini, and LiteLLM, by enabling the corresponding autologging in MLflow.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">instructor</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="nn">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="c1"># Use other autologging function e.g., mlflow.anthropic.autolog() if you are using Instructor with different LLM providers</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">openai</span><span class="o">.</span><span class="n">autolog</span><span class="p">()</span>

<span class="c1"># Optional, create an experiment to store traces</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="s2">&quot;Instructor&quot;</span><span class="p">)</span>


<span class="c1"># Use Instructor as usual</span>
<span class="k">class</span> <span class="nc">ExtractUser</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">age</span><span class="p">:</span> <span class="nb">int</span>


<span class="n">client</span> <span class="o">=</span> <span class="n">instructor</span><span class="o">.</span><span class="n">from_openai</span><span class="p">(</span><span class="n">OpenAI</span><span class="p">())</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span>
    <span class="n">response_model</span><span class="o">=</span><span class="n">ExtractUser</span><span class="p">,</span>
    <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe is 30 years old.&quot;</span><span class="p">}],</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Name: </span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, Age:</span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">age</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="figure align-default">
<img alt="../../_images/instructor-tracing.png" src="../../_images/instructor-tracing.png" />
</div>
</div><div aria-labelledby="tab-0-0-5" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-5" name="0-5" role="tabpanel" tabindex="0"><h3>LlamaIndex Automatic Tracing</h3><div class="line-block">
<div class="line"><br /></div>
</div>
<p>The <a class="reference external" href="../llama-index/index.html">MLflow LlamaIndex flavor</a>’s autologging feature has a direct integration with MLflow tracing. When LlamaIndex autologging is enabled with <a class="reference internal" href="../../python_api/mlflow.llama_index.html#mlflow.llama_index.autolog" title="mlflow.llama_index.autolog"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.llama_index.autolog()</span></code></a>, invocation of components
such as LLMs, agents, and query/chat engines will automatically record generated traces during interactive development.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>

<span class="n">mlflow</span><span class="o">.</span><span class="n">llama_index</span><span class="o">.</span><span class="n">autolog</span><span class="p">()</span>
</pre></div>
</div>
<p>To see the full example of tracing LlamaIndex, please visit <a class="reference external" href="../llama-index/index.html##enable-tracing">LLamaIndex Tracing documentation</a>.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/llama-index-trace.png"><img alt="LlamaIndex Tracing" src="../../_images/llama-index-trace.png" style="width: 100%;" /></a>
</div>
</div><div aria-labelledby="tab-0-0-6" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-6" name="0-6" role="tabpanel" tabindex="0"><h3>DSPy Automatic Tracing</h3><div class="line-block">
<div class="line"><br /></div>
</div>
<p>The <a class="reference external" href="../dspy/index.html">MLflow DSPy flavor</a>’s autologging feature has a direct integration with MLflow tracing. When DSPy autologging is enabled with <a class="reference internal" href="../../python_api/mlflow.dspy.html#mlflow.dspy.autolog" title="mlflow.dspy.autolog"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.dspy.autolog()</span></code></a>, invocation of components
such as LMs, Adapters and Modules, will automatically record generated traces during interactive development.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">dspy</span>

<span class="c1"># Enable tracing for DSPy</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">dspy</span><span class="o">.</span><span class="n">autolog</span><span class="p">()</span>

<span class="c1"># Set an experiment to log the traces to</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="s2">&quot;DSPy Tracing&quot;</span><span class="p">)</span>

<span class="c1"># Define a simple ChainOfThought model and run it</span>
<span class="n">lm</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">LM</span><span class="p">(</span><span class="s2">&quot;openai/gpt-4o-mini&quot;</span><span class="p">)</span>
<span class="n">dspy</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">lm</span><span class="o">=</span><span class="n">lm</span><span class="p">)</span>


<span class="c1"># Define a simple summarizer model and run it</span>
<span class="k">class</span> <span class="nc">SummarizeSignature</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Signature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given a passage, generate a summary.&quot;&quot;&quot;</span>

    <span class="n">passage</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">InputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;a passage to summarize&quot;</span><span class="p">)</span>
    <span class="n">summary</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">OutputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;a one-line summary of the passage&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Summarize</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summarize</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">ChainOfThought</span><span class="p">(</span><span class="n">SummarizeSignature</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">passage</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">summarize</span><span class="p">(</span><span class="n">passage</span><span class="o">=</span><span class="n">passage</span><span class="p">)</span>


<span class="n">summarizer</span> <span class="o">=</span> <span class="n">Summarize</span><span class="p">()</span>
<span class="n">summarizer</span><span class="p">(</span>
    <span class="n">passage</span><span class="o">=</span><span class="p">(</span>
        <span class="s2">&quot;MLflow Tracing is a feature that enhances LLM observability in your Generative AI (GenAI) applications &quot;</span>
        <span class="s2">&quot;by capturing detailed information about the execution of your application&#39;s services. Tracing provides &quot;</span>
        <span class="s2">&quot;a way to record the inputs, outputs, and metadata associated with each intermediate step of a request, &quot;</span>
        <span class="s2">&quot;enabling you to easily pinpoint the source of bugs and unexpected behaviors.&quot;</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/dspy-tracing.png"><img alt="DSPy Tracing" src="../../_images/dspy-tracing.png" style="width: 100%;" /></a>
</div>
</div><div aria-labelledby="tab-0-0-7" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-7" name="0-7" role="tabpanel" tabindex="0"><h3>AutoGen Automatic Tracing</h3><div class="line-block">
<div class="line"><br /></div>
</div>
<p>MLflow Tracing ensures observability for your AutoGen application that involves complex multi-agent interactions. You can enable auto-tracing by calling <a class="reference internal" href="../../python_api/mlflow.autogen.html#mlflow.autogen.autolog" title="mlflow.autogen.autolog"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.autogen.autolog()</span></code></a>, then the internal steps of the agents chat session will be logged to the active MLflow Experiment.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>

<span class="n">mlflow</span><span class="o">.</span><span class="n">autogen</span><span class="o">.</span><span class="n">autolog</span><span class="p">()</span>
</pre></div>
</div>
<p>To see the full example of tracing AutoGen, please refer to the <a class="reference external" href="https://github.com/mlflow/mlflow/tree/master/examples/autogen/tracing.py">AutoGen Tracing example</a>.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/autogen-trace.png"><img alt="AutoGen Tracing" src="../../_images/autogen-trace.png" style="width: 100%;" /></a>
</div>
</div><div aria-labelledby="tab-0-0-8" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-8" name="0-8" role="tabpanel" tabindex="0"><h3>Gemini Automatic Tracing</h3><div class="line-block">
<div class="line"><br /></div>
</div>
<p>MLflow Tracing ensures observability for your interactions with Gemini AI models.
When Gemini autologging is enabled with <a class="reference internal" href="../../python_api/mlflow.gemini.html#mlflow.gemini.autolog" title="mlflow.gemini.autolog"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.gemini.autolog()</span></code></a>,
usage of the Gemini SDK will automatically record generated traces during interactive development.
Note that only synchronous calls for text interactions are supported. Asynchronous API is not traced, and full inputs cannnot be recorded for multi-modal inputs.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>

<span class="n">mlflow</span><span class="o">.</span><span class="n">gemini</span><span class="o">.</span><span class="n">autolog</span><span class="p">()</span>
</pre></div>
</div>
<p>To see the full example of tracing Gemini, please refer to the <a class="reference external" href="https://github.com/mlflow/mlflow/tree/master/examples/gemini/tracing.py">Gemini Tracing example</a>.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/gemini-tracing.png"><img alt="Gemini Tracing" src="../../_images/gemini-tracing.png" style="width: 100%;" /></a>
</div>
</div><div aria-labelledby="tab-0-0-9" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-9" name="0-9" role="tabpanel" tabindex="0"><h3>LiteLLM Automatic Tracing</h3><div class="line-block">
<div class="line"><br /></div>
</div>
<p>LiteLLM allows developers to call all LLM APIs using the OpenAI format. MLflow support auto-tracing for LiteLLM. You can enable it by calling <a class="reference internal" href="../../python_api/mlflow.litellm.html#mlflow.litellm.autolog" title="mlflow.litellm.autolog"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.litellm.autolog()</span></code></a>, then any LLM interactions via LiteLLM will be recorded to the active MLflow Experiment, including various metadata such as token usage, cost, cache hit, and more.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>

<span class="n">mlflow</span><span class="o">.</span><span class="n">litellm</span><span class="o">.</span><span class="n">autolog</span><span class="p">()</span>

<span class="c1"># Call Anthropic API via LiteLLM</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">litellm</span><span class="o">.</span><span class="n">completion</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;claude-3-opus-20240229&quot;</span><span class="p">,</span>
    <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Hey! how&#39;s it going?&quot;</span><span class="p">}],</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/litellm-tracing.png"><img alt="LiteLLM Tracing" src="../../_images/litellm-tracing.png" style="width: 100%;" /></a>
</div>
</div><div aria-labelledby="tab-0-0-10" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-10" name="0-10" role="tabpanel" tabindex="0"><h3>Anthropic Automatic Tracing</h3><div class="line-block">
<div class="line"><br /></div>
</div>
<p>MLflow Tracing ensures observability for your interactions with Anthropic AI models.
When Anthropic autologging is enabled with <a class="reference internal" href="../../python_api/mlflow.anthropic.html#mlflow.anthropic.autolog" title="mlflow.anthropic.autolog"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.anthropic.autolog()</span></code></a>,
usage of the Anthropic SDK will automatically record generated traces during interactive development.
Note that only synchronous calls for text interactions are supported.
Asynchronous API and streaming methods are not traced.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>

<span class="n">mlflow</span><span class="o">.</span><span class="n">anthropic</span><span class="o">.</span><span class="n">autolog</span><span class="p">()</span>
</pre></div>
</div>
<p>To see the full example of tracing Anthropic, please refer to the <a class="reference external" href="https://github.com/mlflow/mlflow/tree/master/examples/anthropic/tracing.py">Anthropic Tracing example</a>.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/anthropic-tracing.png"><img alt="Anthropic Tracing" src="../../_images/anthropic-tracing.png" style="width: 100%;" /></a>
</div>
</div><div aria-labelledby="tab-0-0-11" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-11" name="0-11" role="tabpanel" tabindex="0"><h3>CrewAI Automatic Tracing</h3><div class="line-block">
<div class="line"><br /></div>
</div>
<p>MLflow Tracing ensures observability for the interactions of CrewAI agents.
When CrewAI autologging is enabled with <a class="reference internal" href="../../python_api/mlflow.crewai.html#mlflow.crewai.autolog" title="mlflow.crewai.autolog"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.crewai.autolog()</span></code></a>,
traces are generated for the usage of the CrewAI framework.
Note that asynchronous task and kickoff are not supported now.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>

<span class="n">mlflow</span><span class="o">.</span><span class="n">crewai</span><span class="o">.</span><span class="n">autolog</span><span class="p">()</span>
</pre></div>
</div>
<p>To see the full example of tracing CrewAI, please refer to the <a class="reference external" href="https://github.com/mlflow/mlflow/tree/master/examples/crewai/tracing.py">CrewAI Tracing example</a>.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/crewai-trace.png"><img alt="CrewAI Tracing" src="../../_images/crewai-trace.png" style="width: 100%;" /></a>
</div>
</div></div>
</div>
<div class="section" id="tracing-fluent-apis">
<h2><a class="toc-backref" href="#id5">Tracing Fluent APIs</a><a class="headerlink" href="#tracing-fluent-apis" title="Permalink to this headline"> </a></h2>
<p>MLflow’s <a class="reference internal" href="../../python_api/mlflow.html#mlflow.start_span" title="mlflow.start_span"><code class="xref py py-func docutils literal notranslate"><span class="pre">fluent</span> <span class="pre">APIs</span></code></a> provide a straightforward way to add tracing to your functions and code blocks.
By using decorators, function wrappers, and context managers, you can easily capture detailed trace data with minimal code changes.</p>
<p>As a comparison between the fluent and the client APIs for tracing, the figure below illustrates the differences in complexity between the two APIs,
with the fluent API being more concise and the recommended approach if your tracing use case can support using the higher-level APIs.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/fluent-vs-client-tracing.png"><img alt="Fluent vs Client APIs" src="../../_images/fluent-vs-client-tracing.png" style="width: 60%;" /></a>
</div>
<p>This section will cover how to initiate traces using these fluent APIs.</p>
<div class="section" id="initiating-a-trace">
<h3>Initiating a Trace<a class="headerlink" href="#initiating-a-trace" title="Permalink to this headline"> </a></h3>
<p>In this section, we will explore different methods to initiate a trace using MLflow’s fluent APIs. These methods allow you to add tracing
functionality to your code with minimal modifications, enabling you to capture detailed information about the execution of your functions and workflows.</p>
<div class="section" id="trace-decorator">
<h4>Trace Decorator<a class="headerlink" href="#trace-decorator" title="Permalink to this headline"> </a></h4>
<p>The trace decorator allows you to automatically capture the inputs and outputs of a function by simply adding the <a class="reference internal" href="../../python_api/mlflow.html#mlflow.trace" title="mlflow.trace"><code class="xref py py-func docutils literal notranslate"><span class="pre">&#64;mlflow.trace</span></code></a> decorator
to its definition. This approach is ideal for quickly adding tracing to individual functions without significant changes to your existing code.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>

<span class="c1"># Create a new experiment to log the trace to</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="s2">&quot;Tracing Demo&quot;</span><span class="p">)</span>


<span class="c1"># Mark any function with the trace decorator to automatically capture input(s) and output(s)</span>
<span class="nd">@mlflow</span><span class="o">.</span><span class="n">trace</span>
<span class="k">def</span> <span class="nf">some_function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span>


<span class="c1"># Invoking the function will generate a trace that is logged to the active experiment</span>
<span class="n">some_function</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<p>You can add additional metadata to the tracing decorator as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@mlflow</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;My Span&quot;</span><span class="p">,</span> <span class="n">span_type</span><span class="o">=</span><span class="s2">&quot;func&quot;</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">my_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
<p>When adding additional metadata to the trace decorator constructor, these additional components will be logged along with the span entry within
the trace that is stored within the active MLflow experiment.</p>
<p>Since MLflow 2.16.0, the trace decorator also supports async functions:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">openai</span> <span class="kn">import</span> <span class="n">AsyncOpenAI</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">AsyncOpenAI</span><span class="p">()</span>


<span class="nd">@mlflow</span><span class="o">.</span><span class="n">trace</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">async_func</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completion</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}]</span>
    <span class="p">)</span>


<span class="k">await</span> <span class="n">async_func</span><span class="p">(</span><span class="s2">&quot;What is MLflow Tracing?&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="what-is-captured">
<h4>What is captured?<a class="headerlink" href="#what-is-captured" title="Permalink to this headline"> </a></h4>
<p>If we navigate to the MLflow UI, we can see that the trace decorator automatically captured the following information, in addition to the basic
metadata associated with any span (start time, end time, status, etc):</p>
<ul class="simple">
<li><p><strong>Inputs</strong>: In the case of our decorated function, this includes the state of all input arguments (including the default <cite>z</cite> value that is applied).</p></li>
<li><p><strong>Response</strong>: The output of the function is also captured, in this case the result of the addition and subtraction operations.</p></li>
<li><p><strong>Trace Name</strong>: The name of the decorated function.</p></li>
</ul>
</div>
<div class="section" id="error-handling-with-traces">
<h4>Error Handling with Traces<a class="headerlink" href="#error-handling-with-traces" title="Permalink to this headline"> </a></h4>
<p>If an <cite>Exception</cite> is raised during processing of a trace-instrumented operation, an indication will be shown within the UI that the invocation was not
successful and a partial capture of data will be available to aid in debugging. Additionally, details about the Exception that was raised will be included
within <code class="docutils literal notranslate"><span class="pre">Events</span></code> of the partially completed span, further aiding the identification of where issues are occurring within your code.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/trace-exception.gif"><img alt="Trace Error" src="../../_images/trace-exception.gif" style="width: 100%;" /></a>
</div>
</div>
<div class="section" id="parent-child-relationships">
<h4>Parent-child relationships<a class="headerlink" href="#parent-child-relationships" title="Permalink to this headline"> </a></h4>
<p>When using the trace decorator, each decorated function will be treated as a separate span within the trace. The relationship between dependent function calls
is handled directly through the native call excecution order within Python. For example, the following code will introduce two “child” spans to the main
parent span, all using decorators.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>


<span class="nd">@mlflow</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">span_type</span><span class="o">=</span><span class="s2">&quot;func&quot;</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;value&quot;</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">add_1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>


<span class="nd">@mlflow</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">span_type</span><span class="o">=</span><span class="s2">&quot;func&quot;</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;key1&quot;</span><span class="p">:</span> <span class="s2">&quot;value1&quot;</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">minus_1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span>


<span class="nd">@mlflow</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Trace Test&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">trace_test</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">step1</span> <span class="o">=</span> <span class="n">add_1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">minus_1</span><span class="p">(</span><span class="n">step1</span><span class="p">)</span>


<span class="n">trace_test</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<p>If we look at this trace from within the MLflow UI, we can see the relationship of the call order shown in the structure of the trace.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/trace-decorator.png"><img alt="Trace Decorator" src="../../_images/trace-decorator.png" style="width: 80%;" /></a>
</div>
</div>
<div class="section" id="span-type">
<h4>Span Type<a class="headerlink" href="#span-type" title="Permalink to this headline"> </a></h4>
<p>Span types are a way to categorize spans within a trace. By default, the span type is set to <code class="docutils literal notranslate"><span class="pre">&quot;UNKNOWN&quot;</span></code> when using the trace decorator. MLflow provides a set of predefined span types for common use cases, while also allowing you to setting custom span types.</p>
<p>The following span types are available:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Span Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;LLM&quot;</span></code></p></td>
<td><p>Represents a call to an LLM endpoint or a local model.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;CHAT_MODEL&quot;</span></code></p></td>
<td><p>Represents a query to a chat model. This is a special case of an LLM interaction.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;CHAIN&quot;</span></code></p></td>
<td><p>Represents a chain of operations.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;AGENT&quot;</span></code></p></td>
<td><p>Represents an autonomous agent operation.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;TOOL&quot;</span></code></p></td>
<td><p>Represents a tool execution (typically by an agent), such as querying a search engine.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;EMBEDDING&quot;</span></code></p></td>
<td><p>Represents a text embedding operation.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;RETRIEVER&quot;</span></code></p></td>
<td><p>Represents a context retrieval operation, such as querying a vector database.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;PARSER&quot;</span></code></p></td>
<td><p>Represents a parsing operation, transforming text into a structured format.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;RERANKER&quot;</span></code></p></td>
<td><p>Represents a re-ranking operation, ordering the retrieved contexts based on relevance.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">&quot;UNKNOWN&quot;</span></code></p></td>
<td><p>A default span type that is used when no other span type is specified.</p></td>
</tr>
</tbody>
</table>
<p>To set a span type, you can pass the <code class="docutils literal notranslate"><span class="pre">span_type</span></code> parameter to the <a class="reference internal" href="../../python_api/mlflow.html#mlflow.trace" title="mlflow.trace"><code class="xref py py-func docutils literal notranslate"><span class="pre">&#64;mlflow.trace</span></code></a> decorator or <a class="reference internal" href="../../python_api/mlflow.html#mlflow.start_span" title="mlflow.start_span"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.start_span</span></code></a> context manager. When you are using <a class="reference external" href="#automatic-tracing">automatic tracing</a>, the span type is automatically set by MLflow.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">from</span> <span class="nn">mlflow.entities</span> <span class="kn">import</span> <span class="n">SpanType</span>


<span class="c1"># Using a built-in span type</span>
<span class="nd">@mlflow</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">span_type</span><span class="o">=</span><span class="n">SpanType</span><span class="o">.</span><span class="n">RETRIEVER</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">retrieve_documents</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="o">...</span>


<span class="c1"># Setting a custom span type</span>
<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_span</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="n">span_type</span><span class="o">=</span><span class="s2">&quot;MATH&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">span</span><span class="p">:</span>
    <span class="n">span</span><span class="o">.</span><span class="n">set_inputs</span><span class="p">({</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">z</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">y</span><span class="p">})</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
    <span class="n">span</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">({</span><span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">z</span><span class="p">})</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">span</span><span class="o">.</span><span class="n">span_type</span><span class="p">)</span>
    <span class="c1"># Output: MATH</span>
</pre></div>
</div>
</div>
<div class="section" id="context-handler">
<h4>Context Handler<a class="headerlink" href="#context-handler" title="Permalink to this headline"> </a></h4>
<p>The context handler provides a way to create nested traces or spans, which can be useful for capturing complex interactions within your code.
By using the <a class="reference internal" href="../../python_api/mlflow.html#mlflow.start_span" title="mlflow.start_span"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.start_span()</span></code></a> context manager, you can group multiple traced functions under a single parent span, making it easier to understand
the relationships between different parts of your code.</p>
<p>The context handler is recommended when you need to refine the scope of data capture for a given span. If your code is logically constructed such that
individual calls to services or models are contained within functions or methods, on the other hand, using the decorator approach is more straight-forward
and less complex.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>


<span class="nd">@mlflow</span><span class="o">.</span><span class="n">trace</span>
<span class="k">def</span> <span class="nf">first_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>


<span class="nd">@mlflow</span><span class="o">.</span><span class="n">trace</span>
<span class="k">def</span> <span class="nf">second_func</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span>


<span class="k">def</span> <span class="nf">do_math</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;add&quot;</span><span class="p">):</span>
    <span class="c1"># Use the fluent API context handler to create a new span</span>
    <span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_span</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Math&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">span</span><span class="p">:</span>
        <span class="c1"># Specify the inputs and attributes that will be associated with the span</span>
        <span class="n">span</span><span class="o">.</span><span class="n">set_inputs</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">})</span>
        <span class="n">span</span><span class="o">.</span><span class="n">set_attributes</span><span class="p">({</span><span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="n">operation</span><span class="p">})</span>

        <span class="c1"># Both of these functions are decorated for tracing and will be associated</span>
        <span class="c1"># as &#39;children&#39; of the parent &#39;span&#39; defined with the context handler</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">first_func</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">second</span> <span class="o">=</span> <span class="n">second_func</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;add&quot;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">first</span> <span class="o">+</span> <span class="n">second</span>
        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;subtract&quot;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">first</span> <span class="o">-</span> <span class="n">second</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported Operation Mode: </span><span class="si">{</span><span class="n">operation</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Specify the output result to the span</span>
        <span class="n">span</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">({</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>When calling the <code class="docutils literal notranslate"><span class="pre">do_math</span></code> function, a trace will be generated that has the root span (parent) defined as the
context handler <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">mlflow.start_span():</span></code> call. The <code class="docutils literal notranslate"><span class="pre">first_func</span></code> and <code class="docutils literal notranslate"><span class="pre">second_func</span></code> calls will be associated as child spans
to this parent span due to the fact that they are both decorated functions (having <code class="docutils literal notranslate"><span class="pre">&#64;mlflow.trace</span></code> decorated on the function definition).</p>
<p>Running the following code will generate a trace.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">do_math</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;add&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This trace can be seen within the MLflow UI:</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/trace-view.png"><img alt="Trace within the MLflow UI" src="../../_images/trace-view.png" style="width: 100%;" /></a>
</div>
</div>
<div class="section" id="function-wrapping">
<h4>Function wrapping<a class="headerlink" href="#function-wrapping" title="Permalink to this headline"> </a></h4>
<p>Function wrapping provides a flexible way to add tracing to existing functions without modifying their definitions. This is particularly useful when
you want to add tracing to third-party functions or functions defined outside of your control. By wrapping an external function with <a class="reference internal" href="../../python_api/mlflow.html#mlflow.trace" title="mlflow.trace"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.trace()</span></code></a>, you can
capture its inputs, outputs, and execution context.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">mlflow</span>

<span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="s2">&quot;External Function Tracing&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">invocation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">exp</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="c1"># Initiate a context handler for parent logging</span>
    <span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_span</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Parent&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">span</span><span class="p">:</span>
        <span class="n">span</span><span class="o">.</span><span class="n">set_attributes</span><span class="p">({</span><span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;parent&quot;</span><span class="p">,</span> <span class="s2">&quot;override&quot;</span><span class="p">:</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">4</span><span class="p">})</span>
        <span class="n">span</span><span class="o">.</span><span class="n">set_inputs</span><span class="p">({</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span> <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">exp</span><span class="p">})</span>

        <span class="c1"># Wrap an external function instead of modifying</span>
        <span class="n">traced_pow</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">)</span>

        <span class="c1"># Call the wrapped function as you would call it directly</span>
        <span class="n">raised</span> <span class="o">=</span> <span class="n">traced_pow</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span>

        <span class="c1"># Wrap another external function</span>
        <span class="n">traced_factorial</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">factorial</span><span class="p">)</span>

        <span class="n">factorial</span> <span class="o">=</span> <span class="n">traced_factorial</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">raised</span><span class="p">))</span>

        <span class="c1"># Wrap another and call it directly</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">)(</span><span class="n">factorial</span><span class="p">)</span>

        <span class="c1"># Set the outputs to the parent span prior to returning</span>
        <span class="n">span</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">({</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">response</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
    <span class="n">invocation</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
<p>The screenshot below shows our external function wrapping runs within the MLflow UI.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/external-trace.png"><img alt="External Function tracing" src="../../_images/external-trace.png" style="width: 100%;" /></a>
</div>
</div>
</div>
</div>
<div class="section" id="tracing-client-apis">
<h2><a class="toc-backref" href="#id6">Tracing Client APIs</a><a class="headerlink" href="#tracing-client-apis" title="Permalink to this headline"> </a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Client APIs are in <strong>Experimental Status</strong> and is subject to change without deprecation warning or notification. We recommend using the client APIs only when you have specific requirements that are not met by the other APIs.</p>
</div>
<p>The MLflow client API provides a comprehensive set of thread-safe methods for manually managing traces. These APIs allow for fine-grained
control over tracing, enabling you to create, manipulate, and retrieve traces programmatically. This section will cover how to use these APIs
to manually trace a model, providing step-by-step instructions and examples.</p>
<div class="section" id="starting-a-trace">
<h3>Starting a Trace<a class="headerlink" href="#starting-a-trace" title="Permalink to this headline"> </a></h3>
<p>Unlike with the fluent API, the MLflow Trace Client API requires that you explicitly start a trace before adding child spans. This initial API call
starts the root span for the trace, providing a context request_id that is used for associating subsequent spans to the root span.</p>
<p>To start a new trace, use the <a class="reference internal" href="../../python_api/mlflow.client.html#mlflow.client.MlflowClient.start_trace" title="mlflow.client.MlflowClient.start_trace"><code class="xref py py-meth docutils literal notranslate"><span class="pre">mlflow.client.MlflowClient.start_trace()</span></code></a> method. This method creates a new trace and returns the root span object.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mlflow</span> <span class="kn">import</span> <span class="n">MlflowClient</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">MlflowClient</span><span class="p">()</span>

<span class="c1"># Start a new trace</span>
<span class="n">root_span</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">start_trace</span><span class="p">(</span><span class="s2">&quot;my_trace&quot;</span><span class="p">)</span>

<span class="c1"># The request_id is used for creating additional spans that have a hierarchical association to this root span</span>
<span class="n">request_id</span> <span class="o">=</span> <span class="n">root_span</span><span class="o">.</span><span class="n">request_id</span>
</pre></div>
</div>
</div>
<div class="section" id="adding-a-child-span">
<h3>Adding a Child Span<a class="headerlink" href="#adding-a-child-span" title="Permalink to this headline"> </a></h3>
<p>Once a trace is started, you can add child spans to it with the <a class="reference internal" href="../../python_api/mlflow.client.html#mlflow.client.MlflowClient.start_span" title="mlflow.client.MlflowClient.start_span"><code class="xref py py-meth docutils literal notranslate"><span class="pre">mlflow.client.MlflowClient.start_span()</span></code></a> API. Child spans allow you to break down the trace into smaller, more manageable segments,
each representing a specific operation or step within the overall process.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a child span</span>
<span class="n">child_span</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">start_span</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;child_span&quot;</span><span class="p">,</span>
    <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">,</span>
    <span class="n">parent_id</span><span class="o">=</span><span class="n">root_span</span><span class="o">.</span><span class="n">span_id</span><span class="p">,</span>
    <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;input_key&quot;</span><span class="p">:</span> <span class="s2">&quot;input_value&quot;</span><span class="p">},</span>
    <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;attribute_key&quot;</span><span class="p">:</span> <span class="s2">&quot;attribute_value&quot;</span><span class="p">},</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="ending-a-span">
<h3>Ending a Span<a class="headerlink" href="#ending-a-span" title="Permalink to this headline"> </a></h3>
<p>After performing the operations associated with a span, you must end the span explicitly using the <a class="reference internal" href="../../python_api/mlflow.client.html#mlflow.client.MlflowClient.end_span" title="mlflow.client.MlflowClient.end_span"><code class="xref py py-meth docutils literal notranslate"><span class="pre">mlflow.client.MlflowClient.end_span()</span></code></a> method. Make note of the two required fields
that are in the API signature:</p>
<ul class="simple">
<li><p><strong>request_id</strong>: The identifier associated with the root span</p></li>
<li><p><strong>span_id</strong>: The identifier associated with the span that is being ended</p></li>
</ul>
<p>In order to effectively end a particular span, both the root span (returned from calling <code class="docutils literal notranslate"><span class="pre">start_trace</span></code>) and the targeted span (returned from calling <code class="docutils literal notranslate"><span class="pre">start_span</span></code>)
need to be identified when calling the <code class="docutils literal notranslate"><span class="pre">end_span</span></code> API.
The initiating <code class="docutils literal notranslate"><span class="pre">request_id</span></code> can be accessed from any parent span object’s properties.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Spans created via the Client API will need to be terminated manually. Ensure that all spans that have been started with the <code class="docutils literal notranslate"><span class="pre">start_span</span></code> API
have been ended with the <code class="docutils literal notranslate"><span class="pre">end_span</span></code> API.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># End the child span</span>
<span class="n">client</span><span class="o">.</span><span class="n">end_span</span><span class="p">(</span>
    <span class="n">request_id</span><span class="o">=</span><span class="n">child_span</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
    <span class="n">span_id</span><span class="o">=</span><span class="n">child_span</span><span class="o">.</span><span class="n">span_id</span><span class="p">,</span>
    <span class="n">outputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;output_key&quot;</span><span class="p">:</span> <span class="s2">&quot;output_value&quot;</span><span class="p">},</span>
    <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;custom_attribute&quot;</span><span class="p">:</span> <span class="s2">&quot;value&quot;</span><span class="p">},</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="ending-a-trace">
<h3>Ending a Trace<a class="headerlink" href="#ending-a-trace" title="Permalink to this headline"> </a></h3>
<p>To complete the trace, end the root span using the <a class="reference internal" href="../../python_api/mlflow.client.html#mlflow.client.MlflowClient.end_trace" title="mlflow.client.MlflowClient.end_trace"><code class="xref py py-meth docutils literal notranslate"><span class="pre">mlflow.client.MlflowClient.end_trace()</span></code></a> method. This will also ensure that all associated child
spans are properly ended.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># End the root span (trace)</span>
<span class="n">client</span><span class="o">.</span><span class="n">end_trace</span><span class="p">(</span>
    <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">,</span>
    <span class="n">outputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;final_output_key&quot;</span><span class="p">:</span> <span class="s2">&quot;final_output_value&quot;</span><span class="p">},</span>
    <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;token_usage&quot;</span><span class="p">:</span> <span class="s2">&quot;1174&quot;</span><span class="p">},</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="searching-and-retrieving-traces">
<span id="search-traces"></span><h2><a class="toc-backref" href="#id7">Searching and Retrieving Traces</a><a class="headerlink" href="#searching-and-retrieving-traces" title="Permalink to this headline"> </a></h2>
<div class="section" id="searching-for-traces">
<h3>Searching for Traces<a class="headerlink" href="#searching-for-traces" title="Permalink to this headline"> </a></h3>
<p>You can search for traces based on various criteria using the <a class="reference internal" href="../../python_api/mlflow.client.html#mlflow.client.MlflowClient.search_traces" title="mlflow.client.MlflowClient.search_traces"><code class="xref py py-meth docutils literal notranslate"><span class="pre">mlflow.client.MlflowClient.search_traces()</span></code></a> method. This method allows you to filter traces by experiment IDs,
filter strings, and other parameters.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Search for traces in specific experiments</span>
<span class="n">traces</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">search_traces</span><span class="p">(</span>
    <span class="n">experiment_ids</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">],</span>
    <span class="n">filter_string</span><span class="o">=</span><span class="s2">&quot;attributes.status = &#39;OK&#39;&quot;</span><span class="p">,</span>
    <span class="n">max_results</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Alternatively, you can use fluent API <a class="reference internal" href="../../python_api/mlflow.html#mlflow.search_traces" title="mlflow.search_traces"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.search_traces()</span></code></a> to search for traces, which returns a pandas DataFrame with each row containing a trace.
This method allows you to specify fields to extract from traces using the format <code class="docutils literal notranslate"><span class="pre">&quot;span_name.[inputs|outputs]&quot;</span></code> or <code class="docutils literal notranslate"><span class="pre">&quot;span_name.[inputs|outputs].field_name&quot;</span></code>.
The extracted fields are included as extra columns in the pandas DataFrame. This feature can be used to build evaluation datasets to further improve model and agent performance.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>

<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_span</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;span1&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">span</span><span class="p">:</span>
    <span class="n">span</span><span class="o">.</span><span class="n">set_inputs</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
    <span class="n">span</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">({</span><span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">})</span>

<span class="c1"># Search for traces with specific fields extracted</span>
<span class="n">traces</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">search_traces</span><span class="p">(</span>
    <span class="n">extract_fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;span1.inputs&quot;</span><span class="p">,</span> <span class="s2">&quot;span1.outputs.c&quot;</span><span class="p">],</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">traces</span><span class="p">)</span>
</pre></div>
</div>
<p>This outputs:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>    request_id                              ...     span1.inputs        span1.outputs.c
0   tr-97c4ef97c21f4348a5698f069c1320f1     ...     {&#39;a&#39;: 1, &#39;b&#39;: 2}    3.0
1   tr-4dc3cd5567764499b5532e3af61b9f78     ...     {&#39;a&#39;: 1, &#39;b&#39;: 2}    3.0
</pre></div>
</div>
</div>
<div class="section" id="retrieving-a-specific-trace">
<h3>Retrieving a Specific Trace<a class="headerlink" href="#retrieving-a-specific-trace" title="Permalink to this headline"> </a></h3>
<p>To retrieve a specific trace by its request ID, use the <a class="reference internal" href="../../python_api/mlflow.client.html#mlflow.client.MlflowClient.get_trace" title="mlflow.client.MlflowClient.get_trace"><code class="xref py py-meth docutils literal notranslate"><span class="pre">mlflow.client.MlflowClient.get_trace()</span></code></a> method. This method returns the trace object corresponding to the given request ID.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Retrieve a trace by request ID</span>
<span class="n">trace</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_trace</span><span class="p">(</span><span class="n">request_id</span><span class="o">=</span><span class="s2">&quot;12345678&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="deleting-traces">
<h2><a class="toc-backref" href="#id8">Deleting Traces</a><a class="headerlink" href="#deleting-traces" title="Permalink to this headline"> </a></h2>
<p>You can delete traces based on specific criteria using the <a class="reference internal" href="../../python_api/mlflow.client.html#mlflow.client.MlflowClient.delete_traces" title="mlflow.client.MlflowClient.delete_traces"><code class="xref py py-meth docutils literal notranslate"><span class="pre">mlflow.client.MlflowClient.delete_traces()</span></code></a> method. This method allows you to delete traces by <strong>experiment ID</strong>,
<strong>maximum timestamp</strong>, or <strong>request IDs</strong>.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Deleting a trace is an irreversible process. Ensure that the setting provided within the <code class="docutils literal notranslate"><span class="pre">delete_traces</span></code> API meet the intended range for deletion.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># Get the current timestamp in milliseconds</span>
<span class="n">current_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>

<span class="c1"># Delete traces older than a specific timestamp</span>
<span class="n">deleted_count</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">delete_traces</span><span class="p">(</span>
    <span class="n">experiment_id</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">max_timestamp_millis</span><span class="o">=</span><span class="n">current_time</span><span class="p">,</span> <span class="n">max_traces</span><span class="o">=</span><span class="mi">10</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="data-model-and-schema">
<h2><a class="toc-backref" href="#id9">Data Model and Schema</a><a class="headerlink" href="#data-model-and-schema" title="Permalink to this headline"> </a></h2>
<p>To explore the structure and schema of MLflow Tracing, please see the <a class="reference external" href="./tracing-schema.html">Tracing Schema</a> guide.</p>
</div>
<div class="section" id="trace-tags">
<h2><a class="toc-backref" href="#id10">Trace Tags</a><a class="headerlink" href="#trace-tags" title="Permalink to this headline"> </a></h2>
<p>Tags can be added to traces to provide additional metadata at the trace level. For example, you can attach a session ID to a trace to group traces by a conversation session. MLflow provides APIs to set and delete tags on traces. Select the right API based on whether you want to set tags on an active trace or on an already finished trace.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>API / Method</p></th>
<th class="head"><p>Use Case</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a class="reference internal" href="../../python_api/mlflow.html#mlflow.update_current_trace" title="mlflow.update_current_trace"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.update_current_trace()</span></code></a> API.</p></td>
<td><p>Setting tags on an <strong>active</strong> trace during the code execution.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="../../python_api/mlflow.client.html#mlflow.client.MlflowClient.set_trace_tag" title="mlflow.client.MlflowClient.set_trace_tag"><code class="xref py py-meth docutils literal notranslate"><span class="pre">mlflow.client.MlflowClient.set_trace_tag()</span></code></a> API</p></td>
<td><p>Programmatically setting tags on a finished trace.</p></td>
</tr>
<tr class="row-even"><td><p>MLflow UI</p></td>
<td><p>Setting tags on a finished trace conveniently.</p></td>
</tr>
</tbody>
</table>
<div class="section" id="setting-tags-on-an-active-trace">
<h3>Setting Tags on an Active Trace<a class="headerlink" href="#setting-tags-on-an-active-trace" title="Permalink to this headline"> </a></h3>
<p>If you are using automatic tracing or fluent APIs to create traces and want to add tags to the trace during its execution, you can use the <a class="reference internal" href="../../python_api/mlflow.html#mlflow.update_current_trace" title="mlflow.update_current_trace"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.update_current_trace()</span></code></a> function.</p>
<p>For example, the following code example adds the <code class="docutils literal notranslate"><span class="pre">&quot;fruit&quot;:</span> <span class="pre">&quot;apple&quot;</span></code> tag to the trace created for the <code class="docutils literal notranslate"><span class="pre">my_func</span></code> function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@mlflow</span><span class="o">.</span><span class="n">trace</span>
<span class="k">def</span> <span class="nf">my_func</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">update_current_trace</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fruit&quot;</span><span class="p">:</span> <span class="s2">&quot;apple&quot;</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The :<a class="reference internal" href="../../python_api/mlflow.html#mlflow.update_current_trace" title="mlflow.update_current_trace"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.update_current_trace()</span></code></a> function adds the specified tag(s) to the current trace when the key is not already present. If the key is already present, it updates the key with the new value.</p>
</div>
</div>
<div class="section" id="setting-tags-on-a-finished-trace">
<h3>Setting Tags on a Finished Trace<a class="headerlink" href="#setting-tags-on-a-finished-trace" title="Permalink to this headline"> </a></h3>
<p>To set tags on a trace that has already been completed and logged in the backend store, use the <a class="reference internal" href="../../python_api/mlflow.client.html#mlflow.client.MlflowClient.set_trace_tag" title="mlflow.client.MlflowClient.set_trace_tag"><code class="xref py py-meth docutils literal notranslate"><span class="pre">mlflow.client.MlflowClient.set_trace_tag()</span></code></a> method to set a tag on a trace,
and the <a class="reference internal" href="../../python_api/mlflow.client.html#mlflow.client.MlflowClient.delete_trace_tag" title="mlflow.client.MlflowClient.delete_trace_tag"><code class="xref py py-meth docutils literal notranslate"><span class="pre">mlflow.client.MlflowClient.delete_trace_tag()</span></code></a> method to remove a tag from a trace.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the request ID fof the most recently created trace</span>
<span class="n">trace</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">get_last_active_trace</span><span class="p">()</span>
<span class="n">request_id</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">request_id</span>

<span class="c1"># Set a tag on a trace</span>
<span class="n">client</span><span class="o">.</span><span class="n">set_trace_tag</span><span class="p">(</span><span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;tag_key&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;tag_value&quot;</span><span class="p">)</span>

<span class="c1"># Delete a tag from a trace</span>
<span class="n">client</span><span class="o">.</span><span class="n">delete_trace_tag</span><span class="p">(</span><span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;tag_key&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="setting-tags-via-the-mlflow-ui">
<h3>Setting Tags via the MLflow UI<a class="headerlink" href="#setting-tags-via-the-mlflow-ui" title="Permalink to this headline"> </a></h3>
<p>Alternatively, you can update or delete tags on a trace from the MLflow UI. To do this, navigate to the trace tab, then click on the pencil icon next to the tag you want to update.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/trace-set-tag.gif"><img alt="Traces tag update" src="../../_images/trace-set-tag.gif" style="width: 80%;" /></a>
</div>
</div>
</div>
<div class="section" id="async-logging">
<h2><a class="toc-backref" href="#id11">Async Logging</a><a class="headerlink" href="#async-logging" title="Permalink to this headline"> </a></h2>
<p>By default, MLflow Traces are logged synchronously. This may introduce a performance overhead when logging Traces, especially when your MLflow Tracking Server is running on a remote server. If the performance overhead is a concern for you, you can enable <strong>asynchronous logging</strong> for tracing in MLflow 2.16.0 and later.</p>
<p>To enable async logging for tracing, call <a class="reference internal" href="../../python_api/mlflow.config.html#mlflow.config.enable_async_logging" title="mlflow.config.enable_async_logging"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.config.enable_async_logging()</span></code></a> in your code. This will make the trace logging operation non-blocking and reduce the performance overhead.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>

<span class="n">mlflow</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">enable_async_logging</span><span class="p">()</span>

<span class="c1"># Traces will be logged asynchronously</span>
<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_span</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">span</span><span class="p">:</span>
    <span class="n">span</span><span class="o">.</span><span class="n">set_inputs</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
    <span class="n">span</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">({</span><span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>

<span class="c1"># If you don&#39;t see the traces in the UI after waiting for a while, you can manually flush the traces</span>
<span class="c1"># mlflow.flush_trace_async_logging()</span>
</pre></div>
</div>
<p>Note that the async logging does not fully eliminate the performance overhead. Some backend calls still need to be made synchronously and there are other factors such as data serialization. However, async logging can significantly reduce the overall overhead of logging traces, empirically about ~80% for typical workloads.</p>
</div>
<div class="section" id="using-opentelemetry-collector-for-exporting-traces">
<h2><a class="toc-backref" href="#id12">Using OpenTelemetry Collector for Exporting Traces</a><a class="headerlink" href="#using-opentelemetry-collector-for-exporting-traces" title="Permalink to this headline"> </a></h2>
<p>Traces generated by MLflow are compatible with the <a class="reference external" href="https://opentelemetry.io/docs/specs/otel/trace/api/#span">OpenTelemetry trace specs</a>.
Therefore, MLflow Tracing supports exporting traces to an OpenTelemetry Collector, which can then be used to export traces to various backends such as Jaeger, Zipkin, and AWS X-Ray.</p>
<p>By default, MLflow exports traces to the MLflow Tracking Server. To enable exporting traces to an OpenTelemetry Collector, set the <code class="docutils literal notranslate"><span class="pre">OTEL_EXPORTER_OTLP_ENDPOINT</span></code> environment variable (or <code class="docutils literal notranslate"><span class="pre">OTEL_EXPORTER_OTLP_TRACES_ENDPOINT</span></code>) to the target URL of the OpenTelemetry Collector <strong>before starting any trace</strong>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># Set the endpoint of the OpenTelemetry Collector</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;OTEL_EXPORTER_OTLP_TRACES_ENDPOINT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;http://localhost:4317/v1/traces&quot;</span>
<span class="c1"># Optionally, set the service name to group traces</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;OTEL_SERVICE_NAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&lt;your-service-name&gt;&quot;</span>

<span class="c1"># Trace will be exported to the OTel collector at http://localhost:4317/v1/traces</span>
<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_span</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">span</span><span class="p">:</span>
    <span class="n">span</span><span class="o">.</span><span class="n">set_inputs</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
    <span class="n">span</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">({</span><span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>MLflow only exports traces to a single destination. When  the <code class="docutils literal notranslate"><span class="pre">OTEL_EXPORTER_OTLP_ENDPOINT</span></code> environment variable is configured, MLflow will <strong>not</strong> export traces to the MLflow Tracking Server and you will not see traces in the MLflow UI.</p>
<p>Similarly, if you deploy the model to the <a class="reference external" href="https://docs.databricks.com/en/mlflow/mlflow-tracing.html#use-mlflow-tracing-in-production">Databricks Model Serving with tracing enabled</a>, using the OpenTelemetry Collector will result in traces not being recorded in the Inference Table.</p>
</div>
<div class="section" id="configurations">
<h3>Configurations<a class="headerlink" href="#configurations" title="Permalink to this headline"> </a></h3>
<p>MLflow uses the standard OTLP Exporter for exporting traces to OpenTelemetry Collector instances. Thereby, you can use <a class="reference external" href="https://opentelemetry.io/docs/languages/sdk-configuration/otlp-exporter/">all of the configurations</a> supported by OpenTelemetry. The following example configures the OTLP Exporter to use HTTP protocol instead of the default gRPC and sets custom headers:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_EXPORTER_OTLP_TRACES_ENDPOINT</span><span class="o">=</span><span class="s2">&quot;http://localhost:4317/v1/traces&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_EXPORTER_OTLP_TRACES_PROTOCOL</span><span class="o">=</span><span class="s2">&quot;http/protobuf&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">OTEL_EXPORTER_OTLP_TRACES_HEADERS</span><span class="o">=</span><span class="s2">&quot;api_key=12345&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="faq">
<h2><a class="toc-backref" href="#id13">FAQ</a><a class="headerlink" href="#faq" title="Permalink to this headline"> </a></h2>
<div class="section" id="q-can-i-disable-and-re-enable-tracing-globally">
<h3>Q: Can I disable and re-enable tracing globally?<a class="headerlink" href="#q-can-i-disable-and-re-enable-tracing-globally" title="Permalink to this headline"> </a></h3>
<p>Yes.</p>
<p>There are two fluent APIs that are used for blanket enablement or disablement of the MLflow Tracing feature in order to support
users who may not wish to record interactions with their trace-enabled models for a brief period, or if they have concerns about long-term storage
of data that was sent along with a request payload to a model in interactive mode.</p>
<p>To <strong>disable</strong> tracing, the <a class="reference internal" href="../../python_api/mlflow.tracing.html#mlflow.tracing.disable" title="mlflow.tracing.disable"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.tracing.disable()</span></code></a> API will cease the collection of trace data from within MLflow and will not log
any data to the MLflow Tracking service regarding traces.</p>
<p>To <strong>enable</strong> tracing (if it had been temporarily disabled), the <a class="reference internal" href="../../python_api/mlflow.tracing.html#mlflow.tracing.enable" title="mlflow.tracing.enable"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.tracing.enable()</span></code></a> API will re-enable tracing functionality for instrumented models
that are invoked.</p>
</div>
<div class="section" id="q-how-can-i-associate-a-trace-with-an-mlflow-run">
<h3>Q: How can I associate a trace with an MLflow Run?<a class="headerlink" href="#q-how-can-i-associate-a-trace-with-an-mlflow-run" title="Permalink to this headline"> </a></h3>
<p>If a trace is generated within a run context, the recorded traces to an active Experiment will be associated with the active Run.</p>
<p>For example, in the following code, the traces are generated within the <code class="docutils literal notranslate"><span class="pre">start_run</span></code> context.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>

<span class="c1"># Create and activate an Experiment</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="s2">&quot;Run Associated Tracing&quot;</span><span class="p">)</span>

<span class="c1"># Start a new MLflow Run</span>
<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">()</span> <span class="k">as</span> <span class="n">run</span><span class="p">:</span>
    <span class="c1"># Initiate a trace by starting a Span context from within the Run context</span>
    <span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_span</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Run Span&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">parent_span</span><span class="p">:</span>
        <span class="n">parent_span</span><span class="o">.</span><span class="n">set_inputs</span><span class="p">({</span><span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="s2">&quot;a&quot;</span><span class="p">})</span>
        <span class="n">parent_span</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">({</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="s2">&quot;b&quot;</span><span class="p">})</span>
        <span class="n">parent_span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">)</span>
        <span class="c1"># Initiate a child span from within the parent Span&#39;s context</span>
        <span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_span</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Child Span&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">child_span</span><span class="p">:</span>
            <span class="n">child_span</span><span class="o">.</span><span class="n">set_inputs</span><span class="p">({</span><span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="s2">&quot;b&quot;</span><span class="p">})</span>
            <span class="n">child_span</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">({</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="s2">&quot;c&quot;</span><span class="p">})</span>
            <span class="n">child_span</span><span class="o">.</span><span class="n">set_attributes</span><span class="p">({</span><span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="s2">&quot;d&quot;</span><span class="p">})</span>
</pre></div>
</div>
<p>When navigating to the MLflow UI and selecting the active Experiment, the trace display view will show the run that is associated with the trace, as
well as providing a link to navigate to the run within the MLflow UI. See the below video for an example of this in action.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/run-trace.gif"><img alt="Tracing within a Run Context" src="../../_images/run-trace.gif" style="width: 100%;" /></a>
</div>
<p>You can also programmatically retrieve the traces associated to a particular Run by using the <a class="reference internal" href="../../python_api/mlflow.client.html#mlflow.client.MlflowClient.search_traces" title="mlflow.client.MlflowClient.search_traces"><code class="xref py py-meth docutils literal notranslate"><span class="pre">mlflow.client.MlflowClient.search_traces()</span></code></a> method.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mlflow</span> <span class="kn">import</span> <span class="n">MlflowClient</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">MlflowClient</span><span class="p">()</span>

<span class="c1"># Retrieve traces associated with a specific Run</span>
<span class="n">traces</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">search_traces</span><span class="p">(</span><span class="n">run_id</span><span class="o">=</span><span class="n">run</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">run_id</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">traces</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="q-can-i-use-the-fluent-api-and-the-client-api-together">
<h3>Q: Can I use the fluent API and the client API together?<a class="headerlink" href="#q-can-i-use-the-fluent-api-and-the-client-api-together" title="Permalink to this headline"> </a></h3>
<p>You definitely can. However, the Client API is much more verbose than the fluent API and is designed for more complex use cases where you need
to control asynchronous tasks for which a context manager will not have the ability to handle an appropriate closure over the context.</p>
<p>Mixing the two, while entirely possible, is not generally recommended.</p>
<p>For example, the following will work:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>

<span class="c1"># Initiate a fluent span creation context</span>
<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_span</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Testing!&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">span</span><span class="p">:</span>
    <span class="c1"># Use the client API to start a child span</span>
    <span class="n">child_span</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">start_span</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Child Span From Client&quot;</span><span class="p">,</span>
        <span class="n">request_id</span><span class="o">=</span><span class="n">span</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
        <span class="n">parent_id</span><span class="o">=</span><span class="n">span</span><span class="o">.</span><span class="n">span_id</span><span class="p">,</span>
        <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="s2">&quot;test input&quot;</span><span class="p">},</span>
        <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;attribute1&quot;</span><span class="p">:</span> <span class="s2">&quot;value1&quot;</span><span class="p">},</span>
    <span class="p">)</span>

    <span class="c1"># End the child span</span>
    <span class="n">client</span><span class="o">.</span><span class="n">end_span</span><span class="p">(</span>
        <span class="n">request_id</span><span class="o">=</span><span class="n">span</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
        <span class="n">span_id</span><span class="o">=</span><span class="n">child_span</span><span class="o">.</span><span class="n">span_id</span><span class="p">,</span>
        <span class="n">outputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="s2">&quot;test output&quot;</span><span class="p">},</span>
        <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;attribute2&quot;</span><span class="p">:</span> <span class="s2">&quot;value2&quot;</span><span class="p">},</span>
    <span class="p">)</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Using the fluent API to manage a child span of a client-initiated root span or child span is not possible.
Attempting to start a <code class="docutils literal notranslate"><span class="pre">start_span</span></code> context handler while using the client API will result in two traces being created,
one for the fluent API and one for the client API.</p>
</div>
</div>
<div class="section" id="q-how-can-i-add-custom-metadata-to-a-span">
<h3>Q: How can I add custom metadata to a span?<a class="headerlink" href="#q-how-can-i-add-custom-metadata-to-a-span" title="Permalink to this headline"> </a></h3>
<p>There are several ways.</p>
<div class="section" id="fluent-api">
<h4>Fluent API<a class="headerlink" href="#fluent-api" title="Permalink to this headline"> </a></h4>
<ol class="arabic simple">
<li><p>Within the <a class="reference internal" href="../../python_api/mlflow.html#mlflow.start_span" title="mlflow.start_span"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.start_span()</span></code></a> constructor itself.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_span</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Parent&quot;</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;attribute1&quot;</span><span class="p">:</span> <span class="s2">&quot;value1&quot;</span><span class="p">,</span> <span class="s2">&quot;attribute2&quot;</span><span class="p">:</span> <span class="s2">&quot;value2&quot;</span><span class="p">}</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">span</span><span class="p">:</span>
    <span class="n">span</span><span class="o">.</span><span class="n">set_inputs</span><span class="p">({</span><span class="s2">&quot;input1&quot;</span><span class="p">:</span> <span class="s2">&quot;value1&quot;</span><span class="p">,</span> <span class="s2">&quot;input2&quot;</span><span class="p">:</span> <span class="s2">&quot;value2&quot;</span><span class="p">})</span>
    <span class="n">span</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">({</span><span class="s2">&quot;output1&quot;</span><span class="p">:</span> <span class="s2">&quot;value1&quot;</span><span class="p">,</span> <span class="s2">&quot;output2&quot;</span><span class="p">:</span> <span class="s2">&quot;value2&quot;</span><span class="p">})</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Using the <code class="docutils literal notranslate"><span class="pre">set_attribute</span></code> or <code class="docutils literal notranslate"><span class="pre">set_attributes</span></code> methods on the <code class="docutils literal notranslate"><span class="pre">span</span></code> object returned from the <code class="docutils literal notranslate"><span class="pre">start_span</span></code> returned object.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_span</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Parent&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">span</span><span class="p">:</span>
    <span class="c1"># Set multiple attributes</span>
    <span class="n">span</span><span class="o">.</span><span class="n">set_attributes</span><span class="p">({</span><span class="s2">&quot;attribute1&quot;</span><span class="p">:</span> <span class="s2">&quot;value1&quot;</span><span class="p">,</span> <span class="s2">&quot;attribute2&quot;</span><span class="p">:</span> <span class="s2">&quot;value2&quot;</span><span class="p">})</span>
    <span class="c1"># Set a single attribute</span>
    <span class="n">span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;attribute3&quot;</span><span class="p">,</span> <span class="s2">&quot;value3&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="client-api">
<h4>Client API<a class="headerlink" href="#client-api" title="Permalink to this headline"> </a></h4>
<ol class="arabic simple">
<li><p>When starting a span, you can pass in the attributes as part of the <code class="docutils literal notranslate"><span class="pre">start_trace</span></code> and <code class="docutils literal notranslate"><span class="pre">start_span</span></code> method calls.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">parent_span</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">start_trace</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Parent Span&quot;</span><span class="p">,</span>
    <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;attribute1&quot;</span><span class="p">:</span> <span class="s2">&quot;value1&quot;</span><span class="p">,</span> <span class="s2">&quot;attribute2&quot;</span><span class="p">:</span> <span class="s2">&quot;value2&quot;</span><span class="p">}</span>
<span class="p">)</span>

<span class="n">child_span</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">start_span</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Child Span&quot;</span><span class="p">,</span>
    <span class="n">request_id</span><span class="o">=</span><span class="n">parent_span</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
    <span class="n">parent_id</span><span class="o">=</span><span class="n">parent_span</span><span class="o">.</span><span class="n">span_id</span><span class="p">,</span>
    <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;attribute1&quot;</span><span class="p">:</span> <span class="s2">&quot;value1&quot;</span><span class="p">,</span> <span class="s2">&quot;attribute2&quot;</span><span class="p">:</span> <span class="s2">&quot;value2&quot;</span><span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Utilize the <code class="docutils literal notranslate"><span class="pre">set_attribute</span></code> or <code class="docutils literal notranslate"><span class="pre">set_attributes</span></code> APIs directly on the <code class="docutils literal notranslate"><span class="pre">Span</span></code> objects.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">parent_span</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">start_trace</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Parent Span&quot;</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;attribute1&quot;</span><span class="p">:</span> <span class="s2">&quot;value1&quot;</span><span class="p">,</span> <span class="s2">&quot;attribute2&quot;</span><span class="p">:</span> <span class="s2">&quot;value2&quot;</span><span class="p">}</span>
<span class="p">)</span>

<span class="c1"># Set a single attribute</span>
<span class="n">parent_span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;attribute3&quot;</span><span class="p">,</span> <span class="s2">&quot;value3&quot;</span><span class="p">)</span>
<span class="c1"># Set multiple attributes</span>
<span class="n">parent_span</span><span class="o">.</span><span class="n">set_attributes</span><span class="p">({</span><span class="s2">&quot;attribute4&quot;</span><span class="p">:</span> <span class="s2">&quot;value4&quot;</span><span class="p">,</span> <span class="s2">&quot;attribute5&quot;</span><span class="p">:</span> <span class="s2">&quot;value5&quot;</span><span class="p">})</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Set attributes when ending a span or the entire trace.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">end_span</span><span class="p">(</span>
    <span class="n">request_id</span><span class="o">=</span><span class="n">parent_span</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
    <span class="n">span_id</span><span class="o">=</span><span class="n">child_span</span><span class="o">.</span><span class="n">span_id</span><span class="p">,</span>
    <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;attribute1&quot;</span><span class="p">:</span> <span class="s2">&quot;value1&quot;</span><span class="p">,</span> <span class="s2">&quot;attribute2&quot;</span><span class="p">:</span> <span class="s2">&quot;value2&quot;</span><span class="p">},</span>
<span class="p">)</span>

<span class="n">client</span><span class="o">.</span><span class="n">end_trace</span><span class="p">(</span>
    <span class="n">request_id</span><span class="o">=</span><span class="n">parent_span</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
    <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;attribute3&quot;</span><span class="p">:</span> <span class="s2">&quot;value3&quot;</span><span class="p">,</span> <span class="s2">&quot;attribute4&quot;</span><span class="p">:</span> <span class="s2">&quot;value4&quot;</span><span class="p">},</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="q-i-cannot-open-my-trace-in-the-mlflow-ui-what-should-i-do">
<h3>Q: I cannot open my trace in the MLflow UI. What should I do?<a class="headerlink" href="#q-i-cannot-open-my-trace-in-the-mlflow-ui-what-should-i-do" title="Permalink to this headline"> </a></h3>
<p>There are multiple possible reasons why a trace may not be viewable in the MLflow UI.</p>
<ol class="arabic simple">
<li><p><strong>The trace is not completed yet</strong>: If the trace is still being collected, MLflow cannot display spans in the UI. Ensure that all spans are properly ended with either “OK” or “ERROR” status.</p></li>
<li><p><strong>The browser cache is outdated</strong>: When you upgrade MLflow to a new version, the browser cache may contain outdated data and prevent the UI from displaying traces correctly. Clear your browser cache (Shift+F5) and refresh the page.</p></li>
</ol>
</div>
<div class="section" id="q-how-to-group-multiple-traces-within-a-single-conversation-session">
<h3>Q. How to group multiple traces within a single conversation session?<a class="headerlink" href="#q-how-to-group-multiple-traces-within-a-single-conversation-session" title="Permalink to this headline"> </a></h3>
<p>In conversational AI applications, it is common that users interact with the model multiple times within a single conversation session. Since each interaction generates a trace in the typical MLflow setup, it is useful to group these traces together to analyze the conversation as a whole. You can achieve this by attaching the session ID as a <strong>tag</strong> to each trace.</p>
<p>The following example shows how to use session ID in a chat model that has been implemented using the <a class="reference internal" href="../../python_api/mlflow.pyfunc.html#mlflow.pyfunc.ChatModel" title="mlflow.pyfunc.ChatModel"><code class="xref py py-class docutils literal notranslate"><span class="pre">mlflow.pyfunc.ChatModel</span></code></a> class. Refer to the <a class="reference external" href="#trace-tags">Trace Tags</a> section for more information on how to set tags on traces.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">from</span> <span class="nn">mlflow.entities</span> <span class="kn">import</span> <span class="n">SpanType</span>
<span class="kn">from</span> <span class="nn">mlflow.types.llm</span> <span class="kn">import</span> <span class="n">ChatMessage</span><span class="p">,</span> <span class="n">ChatParams</span><span class="p">,</span> <span class="n">ChatCompletionResponse</span>

<span class="kn">import</span> <span class="nn">openai</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="s2">&quot;Tracing Session ID Demo&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ChatModelWithSession</span><span class="p">(</span><span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">ChatModel</span><span class="p">):</span>
    <span class="nd">@mlflow</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">span_type</span><span class="o">=</span><span class="n">SpanType</span><span class="o">.</span><span class="n">CHAT_MODEL</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ChatMessage</span><span class="p">],</span> <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ChatParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChatCompletionResponse</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">session_id</span> <span class="o">:=</span> <span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">custom_inputs</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;session_id&quot;</span><span class="p">):</span>
            <span class="c1"># Set session ID tag on the current trace</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">update_current_trace</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;session_id&quot;</span><span class="p">:</span> <span class="n">session_id</span><span class="p">})</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">OpenAI</span><span class="p">()</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">messages</span><span class="o">=</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">],</span>
            <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">ChatCompletionResponse</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>


<span class="n">model</span> <span class="o">=</span> <span class="n">ChatModelWithSession</span><span class="p">()</span>

<span class="c1"># Invoke the chat model multiple times with the same session ID</span>
<span class="n">session_id</span> <span class="o">=</span> <span class="s2">&quot;123&quot;</span>
<span class="n">messages</span> <span class="o">=</span> <span class="p">[</span><span class="n">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="s2">&quot;What is MLflow Tracing?&quot;</span><span class="p">)]</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
    <span class="kc">None</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">ChatParams</span><span class="p">(</span><span class="n">custom_inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;session_id&quot;</span><span class="p">:</span> <span class="n">session_id</span><span class="p">})</span>
<span class="p">)</span>

<span class="c1"># Invoke again with the same session ID</span>
<span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
    <span class="n">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ChatMessage</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="s2">&quot;How to get started?&quot;</span><span class="p">))</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
    <span class="kc">None</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">ChatParams</span><span class="p">(</span><span class="n">custom_inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;session_id&quot;</span><span class="p">:</span> <span class="n">session_id</span><span class="p">})</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The above code creates two new traces with the same session ID tag. Within the MLflow UI, you can search for these traces that have this defined session ID using <code class="docutils literal notranslate"><span class="pre">tag.session_id</span> <span class="pre">=</span> <span class="pre">'123'</span></code>.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/trace-session-id.gif"><img alt="Traces with session IDs" src="../../_images/trace-session-id.gif" style="width: 80%;" /></a>
</div>
<p>Alternatively, you can use the <a class="reference internal" href="../../python_api/mlflow.html#mlflow.search_traces" title="mlflow.search_traces"><code class="xref py py-func docutils literal notranslate"><span class="pre">mlflow.search_traces()</span></code></a> function to get these traces programmatically.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">traces</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">search_traces</span><span class="p">(</span><span class="n">filter_string</span><span class="o">=</span><span class="s2">&quot;tag.session_id = &#39;123456&#39;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="q-how-to-find-a-particular-span-within-a-trace">
<h3>Q: How to find a particular span within a trace?<a class="headerlink" href="#q-how-to-find-a-particular-span-within-a-trace" title="Permalink to this headline"> </a></h3>
<p>When you have a large number of spans in a trace, it can be cumbersome to find a particular span. You can use the <a class="reference internal" href="../../python_api/mlflow.entities.html#mlflow.entities.Trace.search_spans" title="mlflow.entities.Trace.search_spans"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Trace.search_spans</span></code></a> method to search for spans based on several criteria.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">from</span> <span class="nn">mlflow.entities</span> <span class="kn">import</span> <span class="n">SpanType</span>


<span class="nd">@mlflow</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">span_type</span><span class="o">=</span><span class="n">SpanType</span><span class="o">.</span><span class="n">CHAIN</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">add_one</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">add_two</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">multiply_by_two</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>


<span class="nd">@mlflow</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">span_type</span><span class="o">=</span><span class="n">SpanType</span><span class="o">.</span><span class="n">TOOL</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_one</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>


<span class="nd">@mlflow</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">span_type</span><span class="o">=</span><span class="n">SpanType</span><span class="o">.</span><span class="n">TOOL</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_two</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">2</span>


<span class="nd">@mlflow</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">span_type</span><span class="o">=</span><span class="n">SpanType</span><span class="o">.</span><span class="n">TOOL</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">multiply_by_two</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">2</span>


<span class="c1"># Run the function and get the trace</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">trace</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">get_last_active_trace</span><span class="p">()</span>
</pre></div>
</div>
<p>This will create a <a class="reference internal" href="../../python_api/mlflow.entities.html#mlflow.entities.Trace" title="mlflow.entities.Trace"><code class="xref py py-class docutils literal notranslate"><span class="pre">Trace</span></code></a> object with four spans.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>run (CHAIN)
  ├── add_one (TOOL)
  ├── add_two (TOOL)
  └── multiply_by_two (TOOL)
</pre></div>
</div>
<p>Then you can use the <a class="reference internal" href="../../python_api/mlflow.entities.html#mlflow.entities.Trace.search_spans" title="mlflow.entities.Trace.search_spans"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Trace.search_spans</span></code></a> method to search for a particular spans:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. Search by span name (exact match)</span>
<span class="n">spans</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">search_spans</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;add_one&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">spans</span><span class="p">)</span>
<span class="c1"># Output: [Span(name=&#39;add_one&#39;, ...)]</span>

<span class="c1"># Search for a span with the span type &quot;TOOL&quot;</span>
<span class="n">spans</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">search_spans</span><span class="p">(</span><span class="n">span_type</span><span class="o">=</span><span class="n">SpanType</span><span class="o">.</span><span class="n">TOOL</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">spans</span><span class="p">)</span>
<span class="c1"># Output: [Span(name=&#39;add_one&#39;, ...), Span(name=&#39;add_two&#39;, ...), Span(name=&#39;multiply_by_two&#39;, ...)]</span>

<span class="c1"># Search for spans whose name starts with &quot;add&quot;</span>
<span class="n">spans</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">search_spans</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;add.*&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">spans</span><span class="p">)</span>
<span class="c1"># Output: [Span(name=&#39;add_one&#39;, ...), Span(name=&#39;add_two&#39;, ...)]</span>
</pre></div>
</div>
</div>
</div>
</div>


              </div>
            </div>
            <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../notebooks/chat-model-tool-calling.html" class="btn btn-neutral" title="Build a tool-calling model with mlflow.pyfunc.ChatModel" accesskey="p"><span class="db-icon db-icon-chevron-left"></span> Previous</a>
      
      
        <a href="overview.html" class="btn btn-neutral" title="Tracing Concepts" accesskey="n">Next <span class="db-icon db-icon-chevron-right"></span></a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
      <p class="copyright">
          &copy; MLflow Project, a Series of LF Projects, LLC. All rights reserved.
      </p>

  </div> 

</footer>
          </div>
        </div>
      </section>
    </main>
  </page>

  


  
  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
      URL_ROOT:'../../',
      VERSION:'2.19.1.dev0',
      COLLAPSE_INDEX:false,
      FILE_SUFFIX:'.html',
      LINK_SUFFIX: '.html',
      HAS_SOURCE:  true
    };
  </script>

  

  <script type="text/javascript" src="../../_static/js/clipboard.min.js"></script>
  <script type="text/javascript" src="../../_static/js/jquery.waypoints.min.js"></script>

  
  
  
  <script type="text/javascript">var CLIPPY_SVG_PATH = "../../_static/clippy.svg";</script>
  <script type="text/javascript" src="../../_static/js/custom.js"></script>
  

  
  
  <script type="text/javascript">
    jQuery(function () {
      SphinxRtdTheme.StickyNav.enable();
    });

  </script>
  

  
  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }
        // Get the code block designator class entries
        const allHighlights = document.querySelectorAll('.highlight');
        // Disable copyable links for notebook cell numbering and for cell outputs
        const highlights = Array.from(allHighlights).filter(highlight => !highlight.closest('.highlight-none') && 
            !highlight.closest('.nboutput'));
    
        highlights.forEach(function(highlight) {
            const copyIcon = document.createElement('span');
            copyIcon.classList.add('copy-icon');
            copyIcon.innerHTML = '&#xf0ea;';

            copyIcon.addEventListener('click', function() {
                const code = highlight.querySelector('pre').textContent;
                copyToClipboard(code);

                // Flash effect on click
                this.style.color = '#0194E2';
                setTimeout(() => {
                    this.style.color = ''; 
                }, 100);

                // Display "Code copied to clipboard" near the clicked icon
                const message = document.createElement('span');
                message.textContent = "Copied!";
                message.classList.add('copy-message'); 

                // Append the message to the icon
                this.appendChild(message);

                setTimeout(() => {
                    this.removeChild(message);
                }, 500);
            });

            highlight.appendChild(copyIcon);
        });
    });
  </script>


<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {
        // Force download for notebook-download-btn
        const downloadButtons = document.querySelectorAll('.notebook-download-btn');
        downloadButtons.forEach(function(button) {
            button.addEventListener('click', function(event) {
                event.preventDefault(); // Prevent default behavior

                // Fetch the raw content of the notebook from GitHub
                fetch(button.href)
                    .then(response => response.blob())
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.style.display = 'none';
                        link.href = url;
                        const filename = button.href.split('/').pop();
                        link.download = filename; 

                        document.body.appendChild(link);
                        link.click();

                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(link);
                    })
                    .catch(err => console.error('Error fetching the notebook:', err));
            });
        });
    });
</script> 
</body>
</html>