
  

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Custom PyFuncs for Advanced LLMs with MLflow - Notebooks &mdash; MLflow 2.9.3.dev0 documentation</title>
  
   
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="canonical" href="https://mlflow.org/docs/latest/llms/custom-pyfunc-for-llms/notebooks/index.html">
  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    

    

  
    

  

  
  
    

  

  
  
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600" rel="stylesheet">
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/cards.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/grids.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/mobile.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/simple-cards.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/tabs.css" type="text/css" />
    
  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="MLflow 2.9.3.dev0 documentation" href="../../../index.html"/>
        <link rel="up" title="Deploying Advanced LLMs with Custom PyFuncs in MLflow" href="../index.html"/>
        <link rel="next" title="Serving LLMs with MLflow: Leveraging Custom PyFunc" href="/custom-pyfunc-advanced-llm.html"/>
        <link rel="prev" title="Deploying Advanced LLMs with Custom PyFuncs in MLflow" href="/../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>
<script type="text/javascript" src="../../../_static/jquery.js"></script>
<script type="text/javascript" src="../../../_static/underscore.js"></script>
<script type="text/javascript" src="../../../_static/doctools.js"></script>
<script type="text/javascript" src="../../../_static/languagesections.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>

<body class="wy-body-for-nav" role="document">
  

  
  <nav class="wy-nav-top header" role="navigation" aria-label="top navigation">
    <ul>
  <li class="menu-toggle">
    <i data-toggle="wy-nav-top" class="wy-nav-top-menu-button db-icon db-icon-menu pull-left"></i>
    <a href="../../../index.html" class="wy-nav-top-logo"
      ><img src="../../../_static/MLflow-logo-final-black.png" alt="MLflow"
    /></a>
    <span class="version">2.9.3.dev0</span>
  </li>
</ul>
  </nav>
  <page>
    

    <nav data-toggle="wy-nav-shift" class="wy-nav-side relative">
      <div class="wy-side-scroll">
  <div class="wy-side-nav-search">
    

    

    
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
  </form>
</div>


    
  </div>

  <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
    
      <a href="../../../index.html" class="main-navigation-home"><img src="../../../_static/icons/nav-home.svg"> MLflow</a>
    

    
      

      
        <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/index.html">What is MLflow?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started/index.html">Getting Started with MLflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../new-features/index.html">New Features</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">LLMs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../index.html#id1">MLflow Deployments Server for LLMs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../index.html#id2">LLM Evaluation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../index.html#id3">Prompt Engineering UI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../index.html#native-mlflow-flavors-for-llms">Native MLflow Flavors for LLMs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../index.html#id4">LLM Tracking in MLflow</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../index.html#tutorials-and-use-case-guides-for-llms-in-mlflow">Tutorials and Use Case Guides for LLMs in MLflow</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../rag/index.html">Retrieval Augmented Generation (RAG)</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">Deploying Advanced LLMs with Custom PyFuncs in MLflow</a><ul class="current">
<li class="toctree-l4 current"><a class="reference internal" href="../index.html#explore-the-tutorial">Explore the Tutorial</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../llm-evaluate/notebooks/index.html">LLM Evaluation Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../gateway/index.html">MLflow AI Gateway (Experimental)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../model-evaluation/index.html">Model Evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../deep-learning/index.html">Deep Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../traditional-ml/index.html">Traditional ML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../deployment/index.html">Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tracking.html">MLflow Tracking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../system-metrics/index.html">System Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../projects.html">MLflow Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../models.html">MLflow Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../model-registry.html">MLflow Model Registry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../recipes.html">MLflow Recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../plugins.html">MLflow Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auth/index.html">MLflow Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cli.html">Command-Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../search-runs.html">Search Runs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../search-experiments.html">Search Experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../python_api/index.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../R-api.html">R API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../java_api/index.html">Java API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rest-api.html">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docker.html">Official MLflow Docker Image</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community-model-flavors.html">Community Model Flavors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials-and-examples/index.html">Tutorials and Examples</a></li>
</ul>

      
    
  </div>

  <div role="contentinfo">
    

    <p>
      <a id='feedbacklink' href="https://github.com/mlflow/mlflow/blob/master/CONTRIBUTING.md" target="_blank">Contribute</a>
    </p>
  </div>
</div>
    </nav>

    <main class="wy-grid-for-nav">
      <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
        <div class="wy-nav-content">
          <div class="rst-content">
            










<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Documentation</a> <span class="db-icon db-icon-chevron-right"></span></li>
    
        <li><a href="../../index.html">LLMs</a> <span class="db-icon db-icon-chevron-right"></span></li>
    
        <li><a href="../index.html">Deploying Advanced LLMs with Custom PyFuncs in MLflow</a> <span class="db-icon db-icon-chevron-right"></span></li>
    
    
      <li>Custom PyFuncs for Advanced LLMs with MLflow - Notebooks</li>
    
    
    <!-- <li class="wy-breadcrumbs-aside">
      <a href="https://github.com/mlflow/mlflow/blob/master/docs/source/llms/custom-pyfunc-for-llms/notebooks/index.rst" class="fa fa-github"> Edit on GitHub</a>
    </li> -->
    
  </ul>
</div>
            <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
              <div itemprop="articleBody">
                
  <div class="section" id="custom-pyfuncs-for-advanced-llms-with-mlflow-notebooks">
<h1>Custom PyFuncs for Advanced LLMs with MLflow - Notebooks<a class="headerlink" href="#custom-pyfuncs-for-advanced-llms-with-mlflow-notebooks" title="Permalink to this headline"> </a></h1>
<p>If you’d like to delve deeper into the notebooks in this guide, they can be viewed or downloaded directly below.</p>
<div class="toctree-wrapper compound">
</div>
<div class="section" id="deploying-advanced-llms-with-custom-pyfuncs">
<h2>Deploying Advanced LLMs with Custom PyFuncs<a class="headerlink" href="#deploying-advanced-llms-with-custom-pyfuncs" title="Permalink to this headline"> </a></h2>
<div class="section" id="introduction">
<h3>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline"> </a></h3>
<p>In this tutorial, we’ll explore the nuances of deploying advanced Large Language Models (LLMs) with MLflow, particularly focusing on models
that can’t be readily managed with MLflow’s built-in functionality. We’ll highlight the necessity of custom <cite>pyfunc</cite> definitions when
dealing with such complex models, emphasizing its role in managing intricate model behaviors and dependencies. By the end, you’ll understand
the intricacies of deploying an LLM model using the MPT-7B instruct transformer, wrapped efficiently using a custom <cite>pyfunc</cite>.</p>
</div>
<div class="section" id="what-you-will-learn">
<h3>What you will learn<a class="headerlink" href="#what-you-will-learn" title="Permalink to this headline"> </a></h3>
<ul class="simple">
<li><p><strong>LLM Deployment Challenges</strong>: Recognize the complexities and challenges associated with deploying advanced LLMs in MLflow.</p></li>
<li><p><strong>Custom PyFuncs for LLMs</strong>: Understand the need and process of creating a custom <cite>pyfunc</cite> to effectively manage LLMs, particularly when default flavors fall short.</p></li>
<li><p><strong>Prompt Management in Deployment</strong>: Delve into how custom <cite>pyfunc</cite> allows manipulation of interface data to generate prompts, simplifying end-user interactions in a RESTful environment.</p></li>
<li><p><strong>Leveraging Custom PyFunc for Enhanced Flexibility</strong>: Witness how custom <cite>pyfunc</cite> definitions provide the flexibility needed for advanced model behaviors and dependencies.</p></li>
</ul>
</div>
<div class="section" id="why-custom-pyfunc-for-llm-deployment">
<h3>Why Custom <cite>pyfunc</cite> for LLM Deployment?<a class="headerlink" href="#why-custom-pyfunc-for-llm-deployment" title="Permalink to this headline"> </a></h3>
<p>Deploying advanced LLMs isn’t straightforward. Models like the MPT-7B instruct transformer have specific requirements and behaviors that don’t align with traditional MLflow flavors. This section highlights the challenges faced and the importance of custom <cite>pyfunc</cite> definitions in addressing these challenges.</p>
</div>
<div class="section" id="crafting-the-custom-pyfunc">
<h3>Crafting the Custom <cite>pyfunc</cite><a class="headerlink" href="#crafting-the-custom-pyfunc" title="Permalink to this headline"> </a></h3>
<p>Venturing into the solution, we’ll craft a custom <cite>pyfunc</cite> to efficiently wrap and manage our LLM. This custom definition serves as a bridge, ensuring our LLM can be deployed seamlessly while retaining its original capabilities and adhering to MLflow’s standards.</p>
</div>
<div class="section" id="step-by-step-guide">
<h3>Step-by-step Guide<a class="headerlink" href="#step-by-step-guide" title="Permalink to this headline"> </a></h3>
<ol class="arabic simple">
<li><p><strong>LLM Introduction</strong>: Understand the MPT-7B instruct transformer, its importance, and its intricacies.</p></li>
<li><p><strong>Challenges with Traditional Deployment</strong>: Recognize the difficulties when attempting to deploy such an LLM using MLflow’s default capabilities.</p></li>
<li><p><strong>Designing the Custom `pyfunc`</strong>: Create a custom <cite>pyfunc</cite> that addresses the LLM’s requirements and behaviors.</p></li>
<li><p><strong>Deploying the LLM</strong>: Integrate with MLflow to deploy the LLM using the crafted custom <cite>pyfunc</cite>.</p></li>
<li><p><strong>Interface Simplification</strong>: Examine how the custom <cite>pyfunc</cite> simplifies user interactions, particularly in RESTful deployments.</p></li>
</ol>
</div>
<div class="section" id="wrap-up">
<h3>Wrap Up<a class="headerlink" href="#wrap-up" title="Permalink to this headline"> </a></h3>
<p>With the complexities of advanced LLM deployment unraveled, this tutorial showcases the indispensable role of custom <cite>pyfunc</cite> in MLflow. Through a detailed, hands-on approach, you’ll appreciate how custom <cite>pyfunc</cite> definitions can make seemingly insurmountable deployment challenges manageable and streamlined.</p>
<a href="custom-pyfunc-advanced-llm.html" class="download-btn">View the Notebook</a></div>
</div>
<div class="section" id="run-the-notebooks-in-your-environment">
<h2>Run the Notebooks in your Environment<a class="headerlink" href="#run-the-notebooks-in-your-environment" title="Permalink to this headline"> </a></h2>
<p>If you’d like to run a copy of the notebooks locally in your environment, you can download them by clicking the respective links:</p>
<a href="https://raw.githubusercontent.com/mlflow/mlflow/master/docs/source/llms/custom-pyfunc-for-llms/notebooks/custom-pyfunc-advanced-llm.ipynb" class="notebook-download-btn">Download the LLM Custom Pyfunc notebook</a><br/><div class="admonition note">
<p class="admonition-title">Note</p>
<p>To execute the notebooks, ensure you either have a local MLflow Tracking Server running or adjust the <code class="docutils literal notranslate"><span class="pre">mlflow.set_tracking_uri()</span></code> to point to an active MLflow Tracking Server instance.
To engage with the MLflow UI, ensure you’re either running the UI server locally or have a configured, accessible, deployed MLflow UI server.</p>
</div>
</div>
</div>


              </div>
            </div>
            <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../index.html" class="btn btn-neutral" title="Deploying Advanced LLMs with Custom PyFuncs in MLflow" accesskey="p"><span class="db-icon db-icon-chevron-left"></span> Previous</a>
      
      
        <a href="custom-pyfunc-advanced-llm.html" class="btn btn-neutral" title="Serving LLMs with MLflow: Leveraging Custom PyFunc" accesskey="n">Next <span class="db-icon db-icon-chevron-right"></span></a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
      <p class="copyright">
          &copy; MLflow Project, a Series of LF Projects, LLC. All rights reserved.
      </p>

  </div> 

</footer>
          </div>
        </div>
      </section>
    </main>
  </page>

  


  
  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
      URL_ROOT:'../../../',
      VERSION:'2.9.3.dev0',
      COLLAPSE_INDEX:false,
      FILE_SUFFIX:'.html',
      LINK_SUFFIX: '.html',
      HAS_SOURCE:  true
    };
  </script>

  

  <script type="text/javascript" src="../../../_static/js/clipboard.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/jquery.waypoints.min.js"></script>

  
  
  
  <script type="text/javascript">var CLIPPY_SVG_PATH = "../../../_static/clippy.svg";</script>
  <script type="text/javascript" src="../../../_static/js/custom.js"></script>
  

  
  
  <script type="text/javascript">
    jQuery(function () {
      SphinxRtdTheme.StickyNav.enable();
    });

  </script>
  

  
  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }
        // Get the code block designator class entries
        const allHighlights = document.querySelectorAll('.highlight');
        // Disable copyable links for notebook cell numbering and for cell outputs
        const highlights = Array.from(allHighlights).filter(highlight => !highlight.closest('.highlight-none') && 
            !highlight.closest('.nboutput'));
    
        highlights.forEach(function(highlight) {
            const copyIcon = document.createElement('span');
            copyIcon.classList.add('copy-icon');
            copyIcon.innerHTML = '&#xf0ea;';

            copyIcon.addEventListener('click', function() {
                const code = highlight.querySelector('pre').textContent;
                copyToClipboard(code);

                // Flash effect on click
                this.style.color = '#0194E2';
                setTimeout(() => {
                    this.style.color = ''; 
                }, 100);

                // Display "Code copied to clipboard" near the clicked icon
                const message = document.createElement('span');
                message.textContent = "Copied!";
                message.classList.add('copy-message'); 

                // Append the message to the icon
                this.appendChild(message);

                setTimeout(() => {
                    this.removeChild(message);
                }, 500);
            });

            highlight.appendChild(copyIcon);
        });
    });
  </script>


<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {
        // Force download for notebook-download-btn
        const downloadButtons = document.querySelectorAll('.notebook-download-btn');
        downloadButtons.forEach(function(button) {
            button.addEventListener('click', function(event) {
                event.preventDefault(); // Prevent default behavior

                // Fetch the raw content of the notebook from GitHub
                fetch(button.href)
                    .then(response => response.blob())
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.style.display = 'none';
                        link.href = url;
                        const filename = button.href.split('/').pop();
                        link.download = filename; 

                        document.body.appendChild(link);
                        link.click();

                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(link);
                    })
                    .catch(err => console.error('Error fetching the notebook:', err));
            });
        });
    });
</script> 
</body>
</html>