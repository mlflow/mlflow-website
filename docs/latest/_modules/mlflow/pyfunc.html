
  

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mlflow.pyfunc &mdash; MLflow 2.9.3.dev0 documentation</title>
  
   
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="canonical" href="https://mlflow.org/docs/latest/_modules/mlflow/pyfunc.html">
  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    

    

  
    

  

  
  
    

  

  
  
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600" rel="stylesheet">
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/cards.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/grids.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/mobile.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/simple-cards.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/tabs.css" type="text/css" />
    
  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="MLflow 2.9.3.dev0 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>
<script type="text/javascript" src="../../_static/jquery.js"></script>
<script type="text/javascript" src="../../_static/underscore.js"></script>
<script type="text/javascript" src="../../_static/doctools.js"></script>
<script type="text/javascript" src="../../_static/tabs.js"></script>
<script type="text/javascript" src="../../_static/languagesections.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>

<body class="wy-body-for-nav" role="document">
  

  
  <nav class="wy-nav-top header" role="navigation" aria-label="top navigation">
    <ul>
  <li class="menu-toggle">
    <i data-toggle="wy-nav-top" class="wy-nav-top-menu-button db-icon db-icon-menu pull-left"></i>
    <a href="../../index.html" class="wy-nav-top-logo"
      ><img src="../../_static/MLflow-logo-final-black.png" alt="MLflow"
    /></a>
    <span class="version">2.9.3.dev0</span>
  </li>
</ul>
  </nav>
  <page>
    

    <nav data-toggle="wy-nav-shift" class="wy-nav-side relative">
      <div class="wy-side-scroll">
  <div class="wy-side-nav-search">
    

    

    
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
  </form>
</div>


    
  </div>

  <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
    
      <a href="../../index.html" class="main-navigation-home"><img src="../../_static/icons/nav-home.svg"> MLflow</a>
    

    
      

      
        <ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/index.html">What is MLflow?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/index.html">Getting Started with MLflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../new-features/index.html">New Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../llms/index.html">LLMs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model-evaluation/index.html">Model Evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deep-learning/index.html">Deep Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../traditional-ml/index.html">Traditional ML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deployment/index.html">Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tracking.html">MLflow Tracking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../system-metrics/index.html">System Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../projects.html">MLflow Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../models.html">MLflow Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model-registry.html">MLflow Model Registry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../recipes.html">MLflow Recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plugins.html">MLflow Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../auth/index.html">MLflow Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli.html">Command-Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../search-runs.html">Search Runs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../search-experiments.html">Search Experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python_api/index.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../R-api.html">R API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../java_api/index.html">Java API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rest-api.html">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docker.html">Official MLflow Docker Image</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community-model-flavors.html">Community Model Flavors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials-and-examples/index.html">Tutorials and Examples</a></li>
</ul>

      
    
  </div>

  <div role="contentinfo">
    

    <p>
      <a id='feedbacklink' href="https://github.com/mlflow/mlflow/blob/master/CONTRIBUTING.md" target="_blank">Contribute</a>
    </p>
  </div>
</div>
    </nav>

    <main class="wy-grid-for-nav">
      <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
        <div class="wy-nav-content">
          <div class="rst-content">
            










<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Documentation</a> <span class="db-icon db-icon-chevron-right"></span></li>
    
        <li><a href="../index.html">Module code</a> <span class="db-icon db-icon-chevron-right"></span></li>
    
    
      <li>mlflow.pyfunc</li>
    
    
    <!-- <li class="wy-breadcrumbs-aside">
      <a href="https://github.com/mlflow/mlflow/blob/master/docs/source/_modules/mlflow/pyfunc" class="fa fa-github"> Edit on GitHub</a>
    </li> -->
    
  </ul>
</div>
            <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
              <div itemprop="articleBody">
                
  <h1>Source code for mlflow.pyfunc</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The ``python_function`` model flavor serves as a default model interface for MLflow Python models.</span>
<span class="sd">Any MLflow Python model is expected to be loadable as a ``python_function`` model.</span>

<span class="sd">In addition, the ``mlflow.pyfunc`` module defines a generic :ref:`filesystem format</span>
<span class="sd">&lt;pyfunc-filesystem-format&gt;` for Python models and provides utilities for saving to and loading from</span>
<span class="sd">this format. The format is self contained in the sense that it includes all necessary information</span>
<span class="sd">for anyone to load it and use it. Dependencies are either stored directly with the model or</span>
<span class="sd">referenced via a Conda environment.</span>

<span class="sd">The ``mlflow.pyfunc`` module also defines utilities for creating custom ``pyfunc`` models</span>
<span class="sd">using frameworks and inference logic that may not be natively included in MLflow. See</span>
<span class="sd">:ref:`pyfunc-create-custom`.</span>

<span class="sd">.. _pyfunc-inference-api:</span>

<span class="sd">*************</span>
<span class="sd">Inference API</span>
<span class="sd">*************</span>

<span class="sd">Python function models are loaded as an instance of :py:class:`PyFuncModel</span>
<span class="sd">&lt;mlflow.pyfunc.PyFuncModel&gt;`, which is an MLflow wrapper around the model implementation and model</span>
<span class="sd">metadata (MLmodel file). You can score the model by calling the :py:func:`predict()</span>
<span class="sd">&lt;mlflow.pyfunc.PyFuncModel.predict&gt;` method, which has the following signature::</span>

<span class="sd">  predict(</span>
<span class="sd">    model_input: [pandas.DataFrame, numpy.ndarray, scipy.sparse.(csc.csc_matrix | csr.csr_matrix),</span>
<span class="sd">    List[Any], Dict[str, Any]]</span>
<span class="sd">  ) -&gt; [numpy.ndarray | pandas.(Series | DataFrame) | List]</span>

<span class="sd">All PyFunc models will support `pandas.DataFrame` as input and PyFunc deep learning models will</span>
<span class="sd">also support tensor inputs in the form of Dict[str, numpy.ndarray] (named tensors) and</span>
<span class="sd">`numpy.ndarrays` (unnamed tensors).</span>


<span class="sd">.. _pyfunc-filesystem-format:</span>

<span class="sd">*****************</span>
<span class="sd">Filesystem format</span>
<span class="sd">*****************</span>

<span class="sd">The Pyfunc format is defined as a directory structure containing all required data, code, and</span>
<span class="sd">configuration::</span>

<span class="sd">    ./dst-path/</span>
<span class="sd">        ./MLmodel: configuration</span>
<span class="sd">        &lt;code&gt;: code packaged with the model (specified in the MLmodel file)</span>
<span class="sd">        &lt;data&gt;: data packaged with the model (specified in the MLmodel file)</span>
<span class="sd">        &lt;env&gt;: Conda environment definition (specified in the MLmodel file)</span>

<span class="sd">The directory structure may contain additional contents that can be referenced by the ``MLmodel``</span>
<span class="sd">configuration.</span>

<span class="sd">.. _pyfunc-model-config:</span>

<span class="sd">MLModel configuration</span>
<span class="sd">#####################</span>

<span class="sd">A Python model contains an ``MLmodel`` file in **python_function** format in its root with the</span>
<span class="sd">following parameters:</span>

<span class="sd">- loader_module [required]:</span>
<span class="sd">         Python module that can load the model. Expected as module identifier</span>
<span class="sd">         e.g. ``mlflow.sklearn``, it will be imported using ``importlib.import_module``.</span>
<span class="sd">         The imported module must contain a function with the following signature::</span>

<span class="sd">          _load_pyfunc(path: string) -&gt; &lt;pyfunc model implementation&gt;</span>

<span class="sd">         The path argument is specified by the ``data`` parameter and may refer to a file or</span>
<span class="sd">         directory. The model implementation is expected to be an object with a</span>
<span class="sd">         ``predict`` method with the following signature::</span>

<span class="sd">          predict(</span>
<span class="sd">            model_input: [pandas.DataFrame, numpy.ndarray,</span>
<span class="sd">            scipy.sparse.(csc.csc_matrix | csr.csr_matrix), List[Any], Dict[str, Any]]</span>
<span class="sd">          ) -&gt; [numpy.ndarray | pandas.(Series | DataFrame) | List]</span>

<span class="sd">- code [optional]:</span>
<span class="sd">        Relative path to a directory containing the code packaged with this model.</span>
<span class="sd">        All files and directories inside this directory are added to the Python path</span>
<span class="sd">        prior to importing the model loader.</span>

<span class="sd">- data [optional]:</span>
<span class="sd">         Relative path to a file or directory containing model data.</span>
<span class="sd">         The path is passed to the model loader.</span>

<span class="sd">- env [optional]:</span>
<span class="sd">         Relative path to an exported Conda environment. If present this environment</span>
<span class="sd">         should be activated prior to running the model.</span>

<span class="sd">- Optionally, any additional parameters necessary for interpreting the serialized model in</span>
<span class="sd">  ``pyfunc`` format.</span>

<span class="sd">.. rubric:: Example</span>

<span class="sd">::</span>

<span class="sd">    tree example/sklearn_iris/mlruns/run1/outputs/linear-lr</span>

<span class="sd">::</span>

<span class="sd">  ├── MLmodel</span>
<span class="sd">  ├── code</span>
<span class="sd">  │   ├── sklearn_iris.py</span>
<span class="sd">  │</span>
<span class="sd">  ├── data</span>
<span class="sd">  │   └── model.pkl</span>
<span class="sd">  └── mlflow_env.yml</span>

<span class="sd">::</span>

<span class="sd">    cat example/sklearn_iris/mlruns/run1/outputs/linear-lr/MLmodel</span>

<span class="sd">::</span>

<span class="sd">  python_function:</span>
<span class="sd">    code: code</span>
<span class="sd">    data: data/model.pkl</span>
<span class="sd">    loader_module: mlflow.sklearn</span>
<span class="sd">    env: mlflow_env.yml</span>
<span class="sd">    main: sklearn_iris</span>

<span class="sd">.. _pyfunc-create-custom:</span>

<span class="sd">******************************</span>
<span class="sd">Creating custom Pyfunc models</span>
<span class="sd">******************************</span>

<span class="sd">MLflow&#39;s persistence modules provide convenience functions for creating models with the</span>
<span class="sd">``pyfunc`` flavor in a variety of machine learning frameworks (scikit-learn, Keras, Pytorch, and</span>
<span class="sd">more); however, they do not cover every use case. For example, you may want to create an MLflow</span>
<span class="sd">model with the ``pyfunc`` flavor using a framework that MLflow does not natively support.</span>
<span class="sd">Alternatively, you may want to build an MLflow model that executes custom logic when evaluating</span>
<span class="sd">queries, such as preprocessing and postprocessing routines. Therefore, ``mlflow.pyfunc``</span>
<span class="sd">provides utilities for creating ``pyfunc`` models from arbitrary code and model data.</span>

<span class="sd">The :meth:`save_model()` and :meth:`log_model()` methods are designed to support multiple workflows</span>
<span class="sd">for creating custom ``pyfunc`` models that incorporate custom inference logic and artifacts</span>
<span class="sd">that the logic may require.</span>

<span class="sd">An `artifact` is a file or directory, such as a serialized model or a CSV. For example, a</span>
<span class="sd">serialized TensorFlow graph is an artifact. An MLflow model directory is also an artifact.</span>

<span class="sd">.. _pyfunc-create-custom-workflows:</span>

<span class="sd">Workflows</span>
<span class="sd">#########</span>

<span class="sd">:meth:`save_model()` and :meth:`log_model()` support the following workflows:</span>

<span class="sd">1. Programmatically defining a new MLflow model, including its attributes and artifacts.</span>

<span class="sd">   Given a set of artifact URIs, :meth:`save_model()` and :meth:`log_model()` can</span>
<span class="sd">   automatically download artifacts from their URIs and create an MLflow model directory.</span>

<span class="sd">   In this case, you must define a Python class which inherits from :class:`~PythonModel`,</span>
<span class="sd">   defining ``predict()`` and, optionally, ``load_context()``. An instance of this class is</span>
<span class="sd">   specified via the ``python_model`` parameter; it is automatically serialized and deserialized</span>
<span class="sd">   as a Python class, including all of its attributes.</span>

<span class="sd">2. Interpreting pre-existing data as an MLflow model.</span>

<span class="sd">   If you already have a directory containing model data, :meth:`save_model()` and</span>
<span class="sd">   :meth:`log_model()` can import the data as an MLflow model. The ``data_path`` parameter</span>
<span class="sd">   specifies the local filesystem path to the directory containing model data.</span>

<span class="sd">   In this case, you must provide a Python module, called a `loader module`. The</span>
<span class="sd">   loader module defines a ``_load_pyfunc()`` method that performs the following tasks:</span>

<span class="sd">   - Load data from the specified ``data_path``. For example, this process may include</span>
<span class="sd">     deserializing pickled Python objects or models or parsing CSV files.</span>

<span class="sd">   - Construct and return a pyfunc-compatible model wrapper. As in the first</span>
<span class="sd">     use case, this wrapper must define a ``predict()`` method that is used to evaluate</span>
<span class="sd">     queries. ``predict()`` must adhere to the :ref:`pyfunc-inference-api`.</span>

<span class="sd">   The ``loader_module`` parameter specifies the name of your loader module.</span>

<span class="sd">   For an example loader module implementation, refer to the `loader module</span>
<span class="sd">   implementation in mlflow.sklearn &lt;https://github.com/mlflow/mlflow/blob/</span>
<span class="sd">   74d75109aaf2975f5026104d6125bb30f4e3f744/mlflow/sklearn.py#L200-L205&gt;`_.</span>

<span class="sd">.. _pyfunc-create-custom-selecting-workflow:</span>

<span class="sd">Which workflow is right for my use case?</span>
<span class="sd">########################################</span>

<span class="sd">We consider the first workflow to be more user-friendly and generally recommend it for the</span>
<span class="sd">following reasons:</span>

<span class="sd">- It automatically resolves and collects specified model artifacts.</span>

<span class="sd">- It automatically serializes and deserializes the ``python_model`` instance and all of</span>
<span class="sd">  its attributes, reducing the amount of user logic that is required to load the model</span>

<span class="sd">- You can create Models using logic that is defined in the ``__main__`` scope. This allows</span>
<span class="sd">  custom models to be constructed in interactive environments, such as notebooks and the Python</span>
<span class="sd">  REPL.</span>

<span class="sd">You may prefer the second, lower-level workflow for the following reasons:</span>

<span class="sd">- Inference logic is always persisted as code, rather than a Python object. This makes logic</span>
<span class="sd">  easier to inspect and modify later.</span>

<span class="sd">- If you have already collected all of your model data in a single location, the second</span>
<span class="sd">  workflow allows it to be saved in MLflow format directly, without enumerating constituent</span>
<span class="sd">  artifacts.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">lru_cache</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">mlflow.pyfunc.model</span>
<span class="kn">from</span> <span class="nn">mlflow.environment_variables</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_MLFLOW_TESTING</span><span class="p">,</span>
    <span class="n">MLFLOW_OPENAI_RETRIES_ENABLED</span><span class="p">,</span>
    <span class="n">MLFLOW_SCORING_SERVER_REQUEST_TIMEOUT</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mlflow.exceptions</span> <span class="kn">import</span> <span class="n">MlflowException</span>
<span class="kn">from</span> <span class="nn">mlflow.models</span> <span class="kn">import</span> <span class="n">Model</span><span class="p">,</span> <span class="n">ModelInputExample</span><span class="p">,</span> <span class="n">ModelSignature</span>
<span class="kn">from</span> <span class="nn">mlflow.models.flavor_backend_registry</span> <span class="kn">import</span> <span class="n">get_flavor_backend</span>
<span class="kn">from</span> <span class="nn">mlflow.models.model</span> <span class="kn">import</span> <span class="n">_DATABRICKS_FS_LOADER_MODULE</span><span class="p">,</span> <span class="n">MLMODEL_FILE_NAME</span>
<span class="kn">from</span> <span class="nn">mlflow.models.signature</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_infer_signature_from_input_example</span><span class="p">,</span>
    <span class="n">_infer_signature_from_type_hints</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mlflow.models.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">PyFuncInput</span><span class="p">,</span>
    <span class="n">PyFuncOutput</span><span class="p">,</span>
    <span class="n">_enforce_params_schema</span><span class="p">,</span>
    <span class="n">_enforce_schema</span><span class="p">,</span>
    <span class="n">_save_example</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mlflow.protos.databricks_pb2</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BAD_REQUEST</span><span class="p">,</span>
    <span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
    <span class="n">RESOURCE_DOES_NOT_EXIST</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mlflow.pyfunc.model</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">PythonModel</span><span class="p">,</span>
    <span class="n">PythonModelContext</span><span class="p">,</span>  <span class="c1"># noqa: F401</span>
    <span class="n">_log_warning_if_params_not_in_predict_signature</span><span class="p">,</span>
    <span class="n">_PythonModelPyfuncWrapper</span><span class="p">,</span>
    <span class="n">get_default_conda_env</span><span class="p">,</span>  <span class="c1"># noqa: F401</span>
    <span class="n">get_default_pip_requirements</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mlflow.tracking._model_registry</span> <span class="kn">import</span> <span class="n">DEFAULT_AWAIT_MAX_SLEEP_SECONDS</span>
<span class="kn">from</span> <span class="nn">mlflow.tracking.artifact_utils</span> <span class="kn">import</span> <span class="n">_download_artifact_from_uri</span>
<span class="kn">from</span> <span class="nn">mlflow.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">PYTHON_VERSION</span><span class="p">,</span>
    <span class="n">_is_in_ipython_notebook</span><span class="p">,</span>
    <span class="n">check_port_connectivity</span><span class="p">,</span>
    <span class="n">find_free_port</span><span class="p">,</span>
    <span class="n">get_major_minor_py_version</span><span class="p">,</span>
    <span class="n">insecure_hash</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mlflow.utils</span> <span class="kn">import</span> <span class="n">env_manager</span> <span class="k">as</span> <span class="n">_EnvManager</span>
<span class="kn">from</span> <span class="nn">mlflow.utils._spark_utils</span> <span class="kn">import</span> <span class="n">modified_environ</span>
<span class="kn">from</span> <span class="nn">mlflow.utils.annotations</span> <span class="kn">import</span> <span class="n">deprecated</span><span class="p">,</span> <span class="n">experimental</span>
<span class="kn">from</span> <span class="nn">mlflow.utils.databricks_utils</span> <span class="kn">import</span> <span class="n">is_in_databricks_runtime</span>
<span class="kn">from</span> <span class="nn">mlflow.utils.docstring_utils</span> <span class="kn">import</span> <span class="n">LOG_MODEL_PARAM_DOCS</span><span class="p">,</span> <span class="n">format_docstring</span>
<span class="kn">from</span> <span class="nn">mlflow.utils.environment</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_CONDA_ENV_FILE_NAME</span><span class="p">,</span>
    <span class="n">_CONSTRAINTS_FILE_NAME</span><span class="p">,</span>
    <span class="n">_PYTHON_ENV_FILE_NAME</span><span class="p">,</span>
    <span class="n">_REQUIREMENTS_FILE_NAME</span><span class="p">,</span>
    <span class="n">_process_conda_env</span><span class="p">,</span>
    <span class="n">_process_pip_requirements</span><span class="p">,</span>
    <span class="n">_PythonEnv</span><span class="p">,</span>
    <span class="n">_validate_env_arguments</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mlflow.utils.file_utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_copy_file_or_tree</span><span class="p">,</span>
    <span class="n">get_or_create_nfs_tmp_dir</span><span class="p">,</span>
    <span class="n">get_or_create_tmp_dir</span><span class="p">,</span>
    <span class="n">get_total_file_size</span><span class="p">,</span>
    <span class="n">write_to</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mlflow.utils.model_utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_add_code_from_conf_to_system_path</span><span class="p">,</span>
    <span class="n">_get_flavor_configuration</span><span class="p">,</span>
    <span class="n">_get_flavor_configuration_from_ml_model_file</span><span class="p">,</span>
    <span class="n">_get_overridden_pyfunc_model_config</span><span class="p">,</span>
    <span class="n">_validate_and_copy_code_paths</span><span class="p">,</span>
    <span class="n">_validate_and_prepare_target_save_path</span><span class="p">,</span>
    <span class="n">_validate_pyfunc_model_config</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mlflow.utils.nfs_on_spark</span> <span class="kn">import</span> <span class="n">get_nfs_cache_root_dir</span>
<span class="kn">from</span> <span class="nn">mlflow.utils.requirements_utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_parse_requirements</span><span class="p">,</span>
    <span class="n">warn_dependency_requirement_mismatches</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">FLAVOR_NAME</span> <span class="o">=</span> <span class="s2">&quot;python_function&quot;</span>
<span class="n">MAIN</span> <span class="o">=</span> <span class="s2">&quot;loader_module&quot;</span>
<span class="n">CODE</span> <span class="o">=</span> <span class="s2">&quot;code&quot;</span>
<span class="n">DATA</span> <span class="o">=</span> <span class="s2">&quot;data&quot;</span>
<span class="n">ENV</span> <span class="o">=</span> <span class="s2">&quot;env&quot;</span>
<span class="n">MODEL_CONFIG</span> <span class="o">=</span> <span class="s2">&quot;config&quot;</span>


<div class="viewcode-block" id="EnvType"><a class="viewcode-back" href="../../python_api/mlflow.pyfunc.html#mlflow.pyfunc.EnvType">[docs]</a><span class="k">class</span> <span class="nc">EnvType</span><span class="p">:</span>
    <span class="n">CONDA</span> <span class="o">=</span> <span class="s2">&quot;conda&quot;</span>
    <span class="n">VIRTUALENV</span> <span class="o">=</span> <span class="s2">&quot;virtualenv&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This class is not meant to be instantiated.&quot;</span><span class="p">)</span></div>


<span class="n">PY_VERSION</span> <span class="o">=</span> <span class="s2">&quot;python_version&quot;</span>


<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="add_to_model"><a class="viewcode-back" href="../../python_api/mlflow.pyfunc.html#mlflow.pyfunc.add_to_model">[docs]</a><span class="k">def</span> <span class="nf">add_to_model</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">loader_module</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">code</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">conda_env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">python_env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">model_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a ``pyfunc`` spec to the model configuration.</span>

<span class="sd">    Defines ``pyfunc`` configuration schema. Caller can use this to create a valid ``pyfunc`` model</span>
<span class="sd">    flavor out of an existing directory structure. For example, other model flavors can use this to</span>
<span class="sd">    specify how to use their output as a ``pyfunc``.</span>

<span class="sd">    NOTE:</span>

<span class="sd">        All paths are relative to the exported model root directory.</span>

<span class="sd">    :param model: Existing model.</span>
<span class="sd">    :param loader_module: The module to be used to load the model.</span>
<span class="sd">    :param data: Path to the model data.</span>
<span class="sd">    :param code: Path to the code dependencies.</span>
<span class="sd">    :param conda_env: Conda environment.</span>
<span class="sd">    :param python_env: Python environment.</span>
<span class="sd">    :param req: pip requirements file.</span>
<span class="sd">    :param kwargs: Additional key-value pairs to include in the ``pyfunc`` flavor specification.</span>
<span class="sd">                   Values must be YAML-serializable.</span>
<span class="sd">    :param model_config: The model configuration to apply to the model. This configuration</span>
<span class="sd">                         is available during model loading.</span>

<span class="sd">                     .. Note:: Experimental: This parameter may change or be removed in a future</span>
<span class="sd">                                             release without warning.</span>
<span class="sd">    :return: Updated model configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">params</span><span class="p">[</span><span class="n">MAIN</span><span class="p">]</span> <span class="o">=</span> <span class="n">loader_module</span>
    <span class="n">params</span><span class="p">[</span><span class="n">PY_VERSION</span><span class="p">]</span> <span class="o">=</span> <span class="n">PYTHON_VERSION</span>
    <span class="k">if</span> <span class="n">code</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="n">CODE</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
    <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="n">DATA</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">if</span> <span class="n">conda_env</span> <span class="ow">or</span> <span class="n">python_env</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="n">ENV</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">conda_env</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="n">ENV</span><span class="p">][</span><span class="n">EnvType</span><span class="o">.</span><span class="n">CONDA</span><span class="p">]</span> <span class="o">=</span> <span class="n">conda_env</span>
        <span class="k">if</span> <span class="n">python_env</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="n">ENV</span><span class="p">][</span><span class="n">EnvType</span><span class="o">.</span><span class="n">VIRTUALENV</span><span class="p">]</span> <span class="o">=</span> <span class="n">python_env</span>
    <span class="k">if</span> <span class="n">model_config</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="n">MODEL_CONFIG</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_config</span>
    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">add_flavor</span><span class="p">(</span><span class="n">FLAVOR_NAME</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_extract_conda_env</span><span class="p">(</span><span class="n">env</span><span class="p">):</span>
    <span class="c1"># In MLflow &lt; 2.0.0, the &#39;env&#39; field in a pyfunc configuration is a string containing the path</span>
    <span class="c1"># to a conda.yaml file.</span>
    <span class="k">return</span> <span class="n">env</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">env</span><span class="p">[</span><span class="n">EnvType</span><span class="o">.</span><span class="n">CONDA</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_load_model_env</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get ENV file string from a model configuration stored in Python Function format.</span>
<span class="sd">    Returned value is a model-relative path to a Conda Environment file,</span>
<span class="sd">    or None if none was specified at model save time</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_get_flavor_configuration</span><span class="p">(</span><span class="n">model_path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">flavor_name</span><span class="o">=</span><span class="n">FLAVOR_NAME</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ENV</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_validate_params</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">model_metadata</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model_metadata</span><span class="p">,</span> <span class="s2">&quot;get_params_schema&quot;</span><span class="p">):</span>
        <span class="n">params_schema</span> <span class="o">=</span> <span class="n">model_metadata</span><span class="o">.</span><span class="n">get_params_schema</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">_enforce_params_schema</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">params_schema</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="o">.</span><span class="n">invalid_parameter_value</span><span class="p">(</span>
            <span class="s2">&quot;This model was not logged with a params schema and does not support &quot;</span>
            <span class="s2">&quot;providing the params argument.&quot;</span>
            <span class="s2">&quot;Please log the model with mlflow &gt;= 2.6.0 and specify a params schema.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span>


<div class="viewcode-block" id="PyFuncModel"><a class="viewcode-back" href="../../python_api/mlflow.pyfunc.html#mlflow.pyfunc.PyFuncModel">[docs]</a><span class="k">class</span> <span class="nc">PyFuncModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    MLflow &#39;python function&#39; model.</span>

<span class="sd">    Wrapper around model implementation and metadata. This class is not meant to be constructed</span>
<span class="sd">    directly. Instead, instances of this class are constructed and returned from</span>
<span class="sd">    :py:func:`load_model() &lt;mlflow.pyfunc.load_model&gt;`.</span>

<span class="sd">    ``model_impl`` can be any Python object that implements the `Pyfunc interface</span>
<span class="sd">    &lt;https://mlflow.org/docs/latest/python_api/mlflow.pyfunc.html#pyfunc-inference-api&gt;`_, and is</span>
<span class="sd">    returned by invoking the model&#39;s ``loader_module``.</span>

<span class="sd">    ``model_meta`` contains model metadata loaded from the MLmodel file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_meta</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span> <span class="n">model_impl</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">predict_fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;predict&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model_impl</span><span class="p">,</span> <span class="n">predict_fn</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model implementation is missing required </span><span class="si">{</span><span class="n">predict_fn</span><span class="si">}</span><span class="s2"> method.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model_meta</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span><span class="s2">&quot;Model is missing metadata.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_meta</span> <span class="o">=</span> <span class="n">model_meta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_impl</span> <span class="o">=</span> <span class="n">model_impl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predict_fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model_impl</span><span class="p">,</span> <span class="n">predict_fn</span><span class="p">)</span>

<div class="viewcode-block" id="PyFuncModel.predict"><a class="viewcode-back" href="../../python_api/mlflow.pyfunc.html#mlflow.pyfunc.PyFuncModel.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">PyFuncInput</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PyFuncOutput</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate model predictions.</span>

<span class="sd">        If the model contains signature, enforce the input schema first before calling the model</span>
<span class="sd">        implementation with the sanitized input. If the pyfunc model does not include model schema,</span>
<span class="sd">        the input is passed to the model implementation as is. See `Model Signature Enforcement</span>
<span class="sd">        &lt;https://www.mlflow.org/docs/latest/models.html#signature-enforcement&gt;`_ for more details.&quot;</span>

<span class="sd">        :param data: Model input as one of pandas.DataFrame, numpy.ndarray,</span>
<span class="sd">                     scipy.sparse.(csc.csc_matrix | csr.csr_matrix), List[Any], or</span>
<span class="sd">                     Dict[str, numpy.ndarray].</span>
<span class="sd">                     For model signatures with tensor spec inputs</span>
<span class="sd">                     (e.g. the Tensorflow core / Keras model), the input data type must be one of</span>
<span class="sd">                     `numpy.ndarray`, `List[numpy.ndarray]`, `Dict[str, numpy.ndarray]` or</span>
<span class="sd">                     `pandas.DataFrame`. If data is of `pandas.DataFrame` type and the model</span>
<span class="sd">                     contains a signature with tensor spec inputs, the corresponding column values</span>
<span class="sd">                     in the pandas DataFrame will be reshaped to the required shape with &#39;C&#39; order</span>
<span class="sd">                     (i.e. read / write the elements using C-like index order), and DataFrame</span>
<span class="sd">                     column values will be cast as the required tensor spec type.</span>

<span class="sd">        :param params: Additional parameters to pass to the model for inference.</span>

<span class="sd">                       .. Note:: Experimental: This parameter may change or be removed in a future</span>
<span class="sd">                                               release without warning.</span>

<span class="sd">        :return: Model predictions as one of pandas.DataFrame, pandas.Series, numpy.ndarray or list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">input_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get_input_schema</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">input_schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">_enforce_schema</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">input_schema</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Include error in message for backwards compatibility</span>
                <span class="k">raise</span> <span class="n">MlflowException</span><span class="o">.</span><span class="n">invalid_parameter_value</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to enforce schema of data &#39;</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;with schema &#39;</span><span class="si">{</span><span class="n">input_schema</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">_validate_params</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_predict</span><span class="p">():</span>
            <span class="c1"># Models saved prior to MLflow 2.5.0 do not support `params` in the pyfunc `predict()`</span>
            <span class="c1"># function definition, nor do they support `**kwargs`. Accordingly, we only pass</span>
            <span class="c1"># `params` to the `predict()` method if it defines the `params` argument</span>
            <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_predict_fn</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;params&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_fn</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
            <span class="n">_log_warning_if_params_not_in_predict_signature</span><span class="p">(</span><span class="n">_logger</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predict_fn</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;openai&quot;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span> <span class="ow">and</span> <span class="n">MLFLOW_OPENAI_RETRIES_ENABLED</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
            <span class="kn">from</span> <span class="nn">mlflow.openai.retry</span> <span class="kn">import</span> <span class="n">openai_auto_retry_patch</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">openai_auto_retry_patch</span><span class="p">():</span>
                    <span class="k">return</span> <span class="n">_predict</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_MLFLOW_TESTING</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
                    <span class="k">raise</span>

        <span class="k">return</span> <span class="n">_predict</span><span class="p">()</span></div>

<div class="viewcode-block" id="PyFuncModel.unwrap_python_model"><a class="viewcode-back" href="../../python_api/mlflow.pyfunc.html#mlflow.pyfunc.PyFuncModel.unwrap_python_model">[docs]</a>    <span class="nd">@experimental</span>
    <span class="k">def</span> <span class="nf">unwrap_python_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unwrap the underlying Python model object.</span>

<span class="sd">        This method is useful for accessing custom model functions, while still being able to</span>
<span class="sd">        leverage the MLflow designed workflow through the `predict()` method.</span>

<span class="sd">        :return: The underlying wrapped model object</span>

<span class="sd">        .. testcode:: python</span>
<span class="sd">            :caption: Example</span>

<span class="sd">            import mlflow</span>


<span class="sd">            # define a custom model</span>
<span class="sd">            class MyModel(mlflow.pyfunc.PythonModel):</span>
<span class="sd">                def predict(self, context, model_input, params=None):</span>
<span class="sd">                    return self.my_custom_function(model_input, params)</span>

<span class="sd">                def my_custom_function(self, model_input, params=None):</span>
<span class="sd">                    # do something with the model input</span>
<span class="sd">                    return 0</span>


<span class="sd">            some_input = 1</span>
<span class="sd">            # save the model</span>
<span class="sd">            with mlflow.start_run():</span>
<span class="sd">                model_info = mlflow.pyfunc.log_model(artifact_path=&quot;model&quot;, python_model=MyModel())</span>

<span class="sd">            # load the model</span>
<span class="sd">            loaded_model = mlflow.pyfunc.load_model(model_uri=model_info.model_uri)</span>
<span class="sd">            print(type(loaded_model))  # &lt;class &#39;mlflow.pyfunc.model.PyFuncModel&#39;&gt;</span>

<span class="sd">            unwrapped_model = loaded_model.unwrap_python_model()</span>
<span class="sd">            print(type(unwrapped_model))  # &lt;class &#39;__main__.MyModel&#39;&gt;</span>

<span class="sd">            # does not work, only predict() is exposed</span>
<span class="sd">            # print(loaded_model.my_custom_function(some_input))</span>

<span class="sd">            print(unwrapped_model.my_custom_function(some_input))  # works</span>

<span class="sd">            print(loaded_model.predict(some_input))  # works</span>

<span class="sd">            # works, but None is needed for context arg</span>
<span class="sd">            print(unwrapped_model.predict(None, some_input))</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">python_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_impl</span><span class="o">.</span><span class="n">python_model</span>
            <span class="k">if</span> <span class="n">python_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Expected python_model attribute not to be None.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span><span class="s2">&quot;Unable to retrieve base model object from pyfunc.&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">return</span> <span class="n">python_model</span></div>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">PyFuncModel</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_meta</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_model_meta</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Model metadata.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_meta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span><span class="s2">&quot;Model is missing metadata.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_meta</span>

    <span class="nd">@experimental</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">model_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Model&#39;s flavor configuration&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_meta</span><span class="o">.</span><span class="n">flavors</span><span class="p">[</span><span class="n">FLAVOR_NAME</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">MODEL_CONFIG</span><span class="p">,</span> <span class="p">{})</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_meta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_meta</span><span class="p">,</span> <span class="s2">&quot;run_id&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_meta</span><span class="o">.</span><span class="n">run_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">info</span><span class="p">[</span><span class="s2">&quot;run_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_meta</span><span class="o">.</span><span class="n">run_id</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_meta</span><span class="p">,</span> <span class="s2">&quot;artifact_path&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_meta</span><span class="o">.</span><span class="n">artifact_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">):</span>
                <span class="n">info</span><span class="p">[</span><span class="s2">&quot;artifact_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_meta</span><span class="o">.</span><span class="n">artifact_path</span>
            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;flavor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_meta</span><span class="o">.</span><span class="n">flavors</span><span class="p">[</span><span class="n">FLAVOR_NAME</span><span class="p">][</span><span class="s2">&quot;loader_module&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_dump</span><span class="p">({</span><span class="s2">&quot;mlflow.pyfunc.loaded_model&quot;</span><span class="p">:</span> <span class="n">info</span><span class="p">},</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_get_pip_requirements_from_model_path</span><span class="p">(</span><span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">req_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">_REQUIREMENTS_FILE_NAME</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">req_file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">req_str</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">_parse_requirements</span><span class="p">(</span><span class="n">req_file_path</span><span class="p">,</span> <span class="n">is_constraint</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>


<div class="viewcode-block" id="load_model"><a class="viewcode-back" href="../../python_api/mlflow.pyfunc.html#mlflow.pyfunc.load_model">[docs]</a><span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span>
    <span class="n">model_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">suppress_warnings</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">dst_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">model_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PyFuncModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a model stored in Python function format.</span>

<span class="sd">    :param model_uri: The location, in URI format, of the MLflow model. For example:</span>

<span class="sd">                      - ``/Users/me/path/to/local/model``</span>
<span class="sd">                      - ``relative/path/to/local/model``</span>
<span class="sd">                      - ``s3://my_bucket/path/to/model``</span>
<span class="sd">                      - ``runs:/&lt;mlflow_run_id&gt;/run-relative/path/to/model``</span>
<span class="sd">                      - ``models:/&lt;model_name&gt;/&lt;model_version&gt;``</span>
<span class="sd">                      - ``models:/&lt;model_name&gt;/&lt;stage&gt;``</span>
<span class="sd">                      - ``mlflow-artifacts:/path/to/model``</span>

<span class="sd">                      For more information about supported URI schemes, see</span>
<span class="sd">                      `Referencing Artifacts &lt;https://www.mlflow.org/docs/latest/concepts.html#</span>
<span class="sd">                      artifact-locations&gt;`_.</span>
<span class="sd">    :param suppress_warnings: If ``True``, non-fatal warning messages associated with the model</span>
<span class="sd">                              loading process will be suppressed. If ``False``, these warning</span>
<span class="sd">                              messages will be emitted.</span>
<span class="sd">    :param dst_path: The local filesystem path to which to download the model artifact.</span>
<span class="sd">                     This directory must already exist. If unspecified, a local output</span>
<span class="sd">                     path will be created.</span>
<span class="sd">    :param model_config: The model configuration to apply to the model. This configuration</span>
<span class="sd">                         is available during model loading.</span>

<span class="sd">                     .. Note:: Experimental: This parameter may change or be removed in a future</span>
<span class="sd">                                             release without warning.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">local_path</span> <span class="o">=</span> <span class="n">_download_artifact_from_uri</span><span class="p">(</span><span class="n">artifact_uri</span><span class="o">=</span><span class="n">model_uri</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="n">dst_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_warnings</span><span class="p">:</span>
        <span class="n">model_requirements</span> <span class="o">=</span> <span class="n">_get_pip_requirements_from_model_path</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
        <span class="n">warn_dependency_requirement_mismatches</span><span class="p">(</span><span class="n">model_requirements</span><span class="p">)</span>

    <span class="n">model_meta</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">MLMODEL_FILE_NAME</span><span class="p">))</span>

    <span class="n">conf</span> <span class="o">=</span> <span class="n">model_meta</span><span class="o">.</span><span class="n">flavors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FLAVOR_NAME</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Model does not have the &quot;</span><span class="si">{</span><span class="n">FLAVOR_NAME</span><span class="si">}</span><span class="s1">&quot; flavor&#39;</span><span class="p">,</span>
            <span class="n">RESOURCE_DOES_NOT_EXIST</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">model_py_version</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PY_VERSION</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_warnings</span><span class="p">:</span>
        <span class="n">_warn_potentially_incompatible_py_version_if_necessary</span><span class="p">(</span><span class="n">model_py_version</span><span class="o">=</span><span class="n">model_py_version</span><span class="p">)</span>

    <span class="n">_add_code_from_conf_to_system_path</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">code_key</span><span class="o">=</span><span class="n">CODE</span><span class="p">)</span>
    <span class="n">data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">conf</span><span class="p">[</span><span class="n">DATA</span><span class="p">])</span> <span class="k">if</span> <span class="p">(</span><span class="n">DATA</span> <span class="ow">in</span> <span class="n">conf</span><span class="p">)</span> <span class="k">else</span> <span class="n">local_path</span>
    <span class="n">model_config</span> <span class="o">=</span> <span class="n">_get_overridden_pyfunc_model_config</span><span class="p">(</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">MODEL_CONFIG</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">model_config</span><span class="p">,</span> <span class="n">_logger</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">model_config</span><span class="p">:</span>
            <span class="n">model_impl</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="n">MAIN</span><span class="p">])</span><span class="o">.</span><span class="n">_load_pyfunc</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">model_config</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model_impl</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="n">MAIN</span><span class="p">])</span><span class="o">.</span><span class="n">_load_pyfunc</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ModuleNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">conf</span><span class="p">[</span><span class="n">MAIN</span><span class="p">]</span> <span class="o">==</span> <span class="n">_DATABRICKS_FS_LOADER_MODULE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                <span class="s2">&quot;mlflow.pyfunc.load_model is not supported for Feature Store models. &quot;</span>
                <span class="s2">&quot;spark_udf() and predict() will not work as expected. Use &quot;</span>
                <span class="s2">&quot;score_batch for offline predictions.&quot;</span><span class="p">,</span>
                <span class="n">BAD_REQUEST</span><span class="p">,</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="n">predict_fn</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;predict_fn&quot;</span><span class="p">,</span> <span class="s2">&quot;predict&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">PyFuncModel</span><span class="p">(</span><span class="n">model_meta</span><span class="o">=</span><span class="n">model_meta</span><span class="p">,</span> <span class="n">model_impl</span><span class="o">=</span><span class="n">model_impl</span><span class="p">,</span> <span class="n">predict_fn</span><span class="o">=</span><span class="n">predict_fn</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">_ServedPyFuncModel</span><span class="p">(</span><span class="n">PyFuncModel</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_meta</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">server_pid</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model_meta</span><span class="o">=</span><span class="n">model_meta</span><span class="p">,</span> <span class="n">model_impl</span><span class="o">=</span><span class="n">client</span><span class="p">,</span> <span class="n">predict_fn</span><span class="o">=</span><span class="s2">&quot;invoke&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server_pid</span> <span class="o">=</span> <span class="n">server_pid</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param data: Model input data.</span>
<span class="sd">        :param params: Additional parameters to pass to the model for inference.</span>

<span class="sd">                       .. Note:: Experimental: This parameter may change or be removed in a future</span>
<span class="sd">                                               release without warning.</span>

<span class="sd">        :return: Model predictions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">invoke</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;params&quot;</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">get_predictions</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_log_warning_if_params_not_in_predict_signature</span><span class="p">(</span><span class="n">_logger</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">get_predictions</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_pid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span><span class="s2">&quot;Served PyFunc Model is missing server process ID.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_pid</span>


<span class="k">def</span> <span class="nf">_load_model_or_server</span><span class="p">(</span>
    <span class="n">model_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">env_manager</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a model with env restoration. If a non-local ``env_manager`` is specified, prepare an</span>
<span class="sd">    independent Python environment with the training time dependencies of the specified model</span>
<span class="sd">    installed and start a MLflow Model Scoring Server process with that model in that environment.</span>
<span class="sd">    Return a _ServedPyFuncModel that invokes the scoring server for prediction. Otherwise, load and</span>
<span class="sd">    return the model locally as a PyFuncModel using :py:func:`mlflow.pyfunc.load_model`.</span>

<span class="sd">    :param model_uri: The uri of the model.</span>
<span class="sd">    :param env_manager: The environment manager to load the model.</span>
<span class="sd">    :param model_config: The model configuration to use by the model, only if the model</span>
<span class="sd">                             accepts it.</span>
<span class="sd">    :return: A _ServedPyFuncModel for non-local ``env_manager``s or a PyFuncModel otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">mlflow.pyfunc.scoring_server.client</span> <span class="kn">import</span> <span class="n">ScoringServerClient</span><span class="p">,</span> <span class="n">StdinScoringServerClient</span>

    <span class="k">if</span> <span class="n">env_manager</span> <span class="o">==</span> <span class="n">_EnvManager</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">load_model</span><span class="p">(</span><span class="n">model_uri</span><span class="p">,</span> <span class="n">model_config</span><span class="o">=</span><span class="n">model_config</span><span class="p">)</span>

    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting model server for model environment restoration.&quot;</span><span class="p">)</span>

    <span class="n">local_path</span> <span class="o">=</span> <span class="n">_download_artifact_from_uri</span><span class="p">(</span><span class="n">artifact_uri</span><span class="o">=</span><span class="n">model_uri</span><span class="p">)</span>
    <span class="n">model_meta</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">MLMODEL_FILE_NAME</span><span class="p">))</span>

    <span class="n">is_port_connectable</span> <span class="o">=</span> <span class="n">check_port_connectivity</span><span class="p">()</span>
    <span class="n">pyfunc_backend</span> <span class="o">=</span> <span class="n">get_flavor_backend</span><span class="p">(</span>
        <span class="n">local_path</span><span class="p">,</span>
        <span class="n">env_manager</span><span class="o">=</span><span class="n">env_manager</span><span class="p">,</span>
        <span class="n">install_mlflow</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MLFLOW_HOME&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">create_env_root_dir</span><span class="o">=</span><span class="ow">not</span> <span class="n">is_port_connectable</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Restoring model environment. This can take a few minutes.&quot;</span><span class="p">)</span>
    <span class="c1"># Set capture_output to True in Databricks so that when environment preparation fails, the</span>
    <span class="c1"># exception message of the notebook cell output will include child process command execution</span>
    <span class="c1"># stdout/stderr output.</span>
    <span class="n">pyfunc_backend</span><span class="o">.</span><span class="n">prepare_env</span><span class="p">(</span><span class="n">model_uri</span><span class="o">=</span><span class="n">local_path</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="n">is_in_databricks_runtime</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">is_port_connectable</span><span class="p">:</span>
        <span class="n">server_port</span> <span class="o">=</span> <span class="n">find_free_port</span><span class="p">()</span>
        <span class="n">scoring_server_proc</span> <span class="o">=</span> <span class="n">pyfunc_backend</span><span class="o">.</span><span class="n">serve</span><span class="p">(</span>
            <span class="n">model_uri</span><span class="o">=</span><span class="n">local_path</span><span class="p">,</span>
            <span class="n">port</span><span class="o">=</span><span class="n">server_port</span><span class="p">,</span>
            <span class="n">host</span><span class="o">=</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">MLFLOW_SCORING_SERVER_REQUEST_TIMEOUT</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
            <span class="n">enable_mlserver</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">synchronous</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">ScoringServerClient</span><span class="p">(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="n">server_port</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scoring_server_proc</span> <span class="o">=</span> <span class="n">pyfunc_backend</span><span class="o">.</span><span class="n">serve_stdin</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">StdinScoringServerClient</span><span class="p">(</span><span class="n">scoring_server_proc</span><span class="p">)</span>

    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scoring server process started at PID: </span><span class="si">{</span><span class="n">scoring_server_proc</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">client</span><span class="o">.</span><span class="n">wait_server_ready</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">scoring_server_proc</span><span class="o">=</span><span class="n">scoring_server_proc</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span><span class="s2">&quot;MLflow model server failed to launch.&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

    <span class="k">return</span> <span class="n">_ServedPyFuncModel</span><span class="p">(</span>
        <span class="n">model_meta</span><span class="o">=</span><span class="n">model_meta</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span> <span class="n">server_pid</span><span class="o">=</span><span class="n">scoring_server_proc</span><span class="o">.</span><span class="n">pid</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_model_dependencies</span><span class="p">(</span><span class="n">model_uri</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;pip&quot;</span><span class="p">):</span>  <span class="c1"># pylint: disable=redefined-builtin</span>
    <span class="n">model_dir</span> <span class="o">=</span> <span class="n">_download_artifact_from_uri</span><span class="p">(</span><span class="n">model_uri</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_conda_yaml_path</span><span class="p">():</span>
        <span class="n">model_config</span> <span class="o">=</span> <span class="n">_get_flavor_configuration_from_ml_model_file</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="n">MLMODEL_FILE_NAME</span><span class="p">),</span> <span class="n">flavor_name</span><span class="o">=</span><span class="n">FLAVOR_NAME</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="n">_extract_conda_env</span><span class="p">(</span><span class="n">model_config</span><span class="p">[</span><span class="n">ENV</span><span class="p">]))</span>

    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;pip&quot;</span><span class="p">:</span>
        <span class="n">requirements_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_dir</span><span class="p">,</span> <span class="n">_REQUIREMENTS_FILE_NAME</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">requirements_file</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">requirements_file</span>

        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_REQUIREMENTS_FILE_NAME</span><span class="si">}</span><span class="s2"> is not found in the model directory. Falling back to&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; extracting pip requirements from the model&#39;s &#39;conda.yaml&#39; file. Conda&quot;</span>
            <span class="s2">&quot; dependencies will be ignored.&quot;</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">get_conda_yaml_path</span><span class="p">())</span> <span class="k">as</span> <span class="n">yf</span><span class="p">:</span>
            <span class="n">conda_yaml</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">yf</span><span class="p">)</span>

        <span class="n">conda_deps</span> <span class="o">=</span> <span class="n">conda_yaml</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dependencies&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">dep</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">conda_deps</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;pip&quot;</span> <span class="ow">in</span> <span class="n">dep</span><span class="p">:</span>
                <span class="n">pip_deps_index</span> <span class="o">=</span> <span class="n">index</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                <span class="s2">&quot;No pip section found in conda.yaml file in the model directory.&quot;</span><span class="p">,</span>
                <span class="n">error_code</span><span class="o">=</span><span class="n">RESOURCE_DOES_NOT_EXIST</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">pip_deps</span> <span class="o">=</span> <span class="n">conda_deps</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">pip_deps_index</span><span class="p">)[</span><span class="s2">&quot;pip&quot;</span><span class="p">]</span>
        <span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="n">pip_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">_REQUIREMENTS_FILE_NAME</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pip_file_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pip_deps</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">conda_deps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;The following conda dependencies have been excluded from the environment file:&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">conda_deps</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">pip_file_path</span>

    <span class="k">elif</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;conda&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">get_conda_yaml_path</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Illegal format argument &#39;</span><span class="si">{</span><span class="nb">format</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">,</span> <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span>
        <span class="p">)</span>


<div class="viewcode-block" id="get_model_dependencies"><a class="viewcode-back" href="../../python_api/mlflow.pyfunc.html#mlflow.pyfunc.get_model_dependencies">[docs]</a><span class="k">def</span> <span class="nf">get_model_dependencies</span><span class="p">(</span><span class="n">model_uri</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;pip&quot;</span><span class="p">):</span>  <span class="c1"># pylint: disable=redefined-builtin</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Downloads the model dependencies and returns the path to requirements.txt or conda.yaml file.</span>

<span class="sd">    .. warning::</span>
<span class="sd">        This API downloads all the model artifacts to the local filesystem. This may take</span>
<span class="sd">        a long time for large models. To avoid this overhead, use</span>
<span class="sd">        ``mlflow.artifacts.download_artifacts(&quot;&lt;model_uri&gt;/requirements.txt&quot;)`` or</span>
<span class="sd">        ``mlflow.artifacts.download_artifacts(&quot;&lt;model_uri&gt;/conda.yaml&quot;)`` instead.</span>

<span class="sd">    :param model_uri: The uri of the model to get dependencies from.</span>
<span class="sd">    :param format: The format of the returned dependency file. If the ``&quot;pip&quot;`` format is</span>
<span class="sd">                   specified, the path to a pip ``requirements.txt`` file is returned.</span>
<span class="sd">                   If the ``&quot;conda&quot;`` format is specified, the path to a ``&quot;conda.yaml&quot;``</span>
<span class="sd">                   file is returned . If the ``&quot;pip&quot;`` format is specified but the model</span>
<span class="sd">                   was not saved with a ``requirements.txt`` file, the ``pip`` section</span>
<span class="sd">                   of the model&#39;s ``conda.yaml`` file is extracted instead, and any</span>
<span class="sd">                   additional conda dependencies are ignored. Default value is ``&quot;pip&quot;``.</span>
<span class="sd">    :return: The local filesystem path to either a pip ``requirements.txt`` file</span>
<span class="sd">             (if ``format=&quot;pip&quot;``) or a ``conda.yaml`` file (if ``format=&quot;conda&quot;``)</span>
<span class="sd">             specifying the model&#39;s dependencies.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dep_file</span> <span class="o">=</span> <span class="n">_get_model_dependencies</span><span class="p">(</span><span class="n">model_uri</span><span class="p">,</span> <span class="nb">format</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;pip&quot;</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;%&quot;</span> <span class="k">if</span> <span class="n">_is_in_ipython_notebook</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;To install the dependencies that were used to train the model, run the &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;following command: &#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">pip install -r </span><span class="si">{</span><span class="n">dep_file</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">dep_file</span></div>


<div class="viewcode-block" id="load_pyfunc"><a class="viewcode-back" href="../../python_api/mlflow.pyfunc.html#mlflow.pyfunc.load_pyfunc">[docs]</a><span class="nd">@deprecated</span><span class="p">(</span><span class="s2">&quot;mlflow.pyfunc.load_model&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">load_pyfunc</span><span class="p">(</span><span class="n">model_uri</span><span class="p">,</span> <span class="n">suppress_warnings</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a model stored in Python function format.</span>

<span class="sd">    :param model_uri: The location, in URI format, of the MLflow model. For example:</span>

<span class="sd">                      - ``/Users/me/path/to/local/model``</span>
<span class="sd">                      - ``relative/path/to/local/model``</span>
<span class="sd">                      - ``s3://my_bucket/path/to/model``</span>
<span class="sd">                      - ``runs:/&lt;mlflow_run_id&gt;/run-relative/path/to/model``</span>
<span class="sd">                      - ``models:/&lt;model_name&gt;/&lt;model_version&gt;``</span>
<span class="sd">                      - ``models:/&lt;model_name&gt;/&lt;stage&gt;``</span>
<span class="sd">                      - ``mlflow-artifacts:/path/to/model``</span>

<span class="sd">                      For more information about supported URI schemes, see</span>
<span class="sd">                      `Referencing Artifacts &lt;https://www.mlflow.org/docs/latest/concepts.html#</span>
<span class="sd">                      artifact-locations&gt;`_.</span>

<span class="sd">    :param suppress_warnings: If ``True``, non-fatal warning messages associated with the model</span>
<span class="sd">                              loading process will be suppressed. If ``False``, these warning</span>
<span class="sd">                              messages will be emitted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">load_model</span><span class="p">(</span><span class="n">model_uri</span><span class="p">,</span> <span class="n">suppress_warnings</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_warn_potentially_incompatible_py_version_if_necessary</span><span class="p">(</span><span class="n">model_py_version</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compares the version of Python that was used to save a given model with the version</span>
<span class="sd">    of Python that is currently running. If a major or minor version difference is detected,</span>
<span class="sd">    logs an appropriate warning.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">model_py_version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;The specified model does not have a specified Python version. It may be&quot;</span>
            <span class="s2">&quot; incompatible with the version of Python that is currently running: Python </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">PYTHON_VERSION</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">get_major_minor_py_version</span><span class="p">(</span><span class="n">model_py_version</span><span class="p">)</span> <span class="o">!=</span> <span class="n">get_major_minor_py_version</span><span class="p">(</span><span class="n">PYTHON_VERSION</span><span class="p">):</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;The version of Python that the model was saved in, `Python </span><span class="si">%s</span><span class="s2">`, differs&quot;</span>
            <span class="s2">&quot; from the version of Python that is currently running, `Python </span><span class="si">%s</span><span class="s2">`,&quot;</span>
            <span class="s2">&quot; and may be incompatible&quot;</span><span class="p">,</span>
            <span class="n">model_py_version</span><span class="p">,</span>
            <span class="n">PYTHON_VERSION</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">_create_model_downloading_tmp_dir</span><span class="p">(</span><span class="n">should_use_nfs</span><span class="p">):</span>
    <span class="n">root_tmp_dir</span> <span class="o">=</span> <span class="n">get_or_create_nfs_tmp_dir</span><span class="p">()</span> <span class="k">if</span> <span class="n">should_use_nfs</span> <span class="k">else</span> <span class="n">get_or_create_tmp_dir</span><span class="p">()</span>

    <span class="n">root_model_cache_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_tmp_dir</span><span class="p">,</span> <span class="s2">&quot;models&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">root_model_cache_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">tmp_model_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">root_model_cache_dir</span><span class="p">)</span>
    <span class="c1"># mkdtemp creates a directory with permission 0o700</span>
    <span class="c1"># change it to be 0o777 to ensure it can be seen in spark UDF</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">tmp_model_dir</span><span class="p">,</span> <span class="mo">0o777</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tmp_model_dir</span>


<span class="n">_MLFLOW_SERVER_OUTPUT_TAIL_LINES_TO_KEEP</span> <span class="o">=</span> <span class="mi">200</span>


<span class="k">def</span> <span class="nf">_convert_spec_type_to_spark_type</span><span class="p">(</span><span class="n">spec_type</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">ArrayType</span><span class="p">,</span> <span class="n">StructField</span><span class="p">,</span> <span class="n">StructType</span>

    <span class="kn">from</span> <span class="nn">mlflow.types.schema</span> <span class="kn">import</span> <span class="n">Array</span><span class="p">,</span> <span class="n">DataType</span><span class="p">,</span> <span class="n">Object</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec_type</span><span class="p">,</span> <span class="n">DataType</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">spec_type</span><span class="o">.</span><span class="n">to_spark</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec_type</span><span class="p">,</span> <span class="n">Array</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ArrayType</span><span class="p">(</span><span class="n">_convert_spec_type_to_spark_type</span><span class="p">(</span><span class="n">spec_type</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec_type</span><span class="p">,</span> <span class="n">Object</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">StructType</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">StructField</span><span class="p">(</span>
                    <span class="nb">property</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">_convert_spec_type_to_spark_type</span><span class="p">(</span><span class="nb">property</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
                    <span class="c1"># we set nullable to True for all properties</span>
                    <span class="c1"># to avoid some errors like java.lang.NullPointerException</span>
                    <span class="c1"># when the signature is not inferred based on correct data.</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="nb">property</span> <span class="ow">in</span> <span class="n">spec_type</span><span class="o">.</span><span class="n">properties</span>
            <span class="p">]</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">_cast_output_spec_to_spark_type</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">ArrayType</span>

    <span class="kn">from</span> <span class="nn">mlflow.types.schema</span> <span class="kn">import</span> <span class="n">ColSpec</span><span class="p">,</span> <span class="n">DataType</span><span class="p">,</span> <span class="n">TensorSpec</span>

    <span class="c1"># TODO: handle optional output columns.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">ColSpec</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_convert_spec_type_to_spark_type</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">TensorSpec</span><span class="p">):</span>
        <span class="n">data_type</span> <span class="o">=</span> <span class="n">DataType</span><span class="o">.</span><span class="n">from_numpy_type</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Model output tensor spec type </span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2"> is not supported in spark_udf.&quot;</span><span class="p">,</span>
                <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ArrayType</span><span class="p">(</span><span class="n">data_type</span><span class="o">.</span><span class="n">to_spark</span><span class="p">())</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ArrayType</span><span class="p">(</span><span class="n">ArrayType</span><span class="p">(</span><span class="n">data_type</span><span class="o">.</span><span class="n">to_spark</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                <span class="s2">&quot;Only 1D or 2D tensors are supported as spark_udf &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;return value, but model output &#39;</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; has shape </span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
                <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unknown schema output spec </span><span class="si">{</span><span class="n">spec</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">_infer_spark_udf_return_type</span><span class="p">(</span><span class="n">model_output_schema</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StructField</span><span class="p">,</span> <span class="n">StructType</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_output_schema</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_cast_output_spec_to_spark_type</span><span class="p">(</span><span class="n">model_output_schema</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">StructType</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">StructField</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">dataType</span><span class="o">=</span><span class="n">_cast_output_spec_to_spark_type</span><span class="p">(</span><span class="n">spec</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_output_schema</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_parse_spark_datatype</span><span class="p">(</span><span class="n">datatype</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">udf</span>
    <span class="kn">from</span> <span class="nn">pyspark.sql.session</span> <span class="kn">import</span> <span class="n">SparkSession</span>

    <span class="n">return_type</span> <span class="o">=</span> <span class="s2">&quot;boolean&quot;</span> <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s2">&quot;bool&quot;</span> <span class="k">else</span> <span class="n">datatype</span>
    <span class="n">parsed_datatype</span> <span class="o">=</span> <span class="n">udf</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">returnType</span><span class="o">=</span><span class="n">return_type</span><span class="p">)</span><span class="o">.</span><span class="n">returnType</span>

    <span class="k">if</span> <span class="n">parsed_datatype</span><span class="o">.</span><span class="n">typeName</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;unparseddata&quot;</span><span class="p">:</span>
        <span class="c1"># For spark 3.5.x, `udf(lambda x: x, returnType=return_type).returnType`</span>
        <span class="c1"># returns UnparsedDataType, which is not compatible with signature inference.</span>
        <span class="c1"># Note: SparkSession.active only exists for spark &gt;= 3.5.0</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">SparkSession</span><span class="o">.</span><span class="n">active</span><span class="p">()</span>
            <span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">udf</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">returnType</span><span class="o">=</span><span class="n">return_type</span><span class="p">)(</span><span class="s2">&quot;id&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">schema</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">schema</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dataType</span>

    <span class="k">return</span> <span class="n">parsed_datatype</span>


<span class="k">def</span> <span class="nf">_is_none_or_nan</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="c1"># The condition `isinstance(value, float)` is needed to avoid error</span>
    <span class="c1"># from `np.isnan(value)` if value is a non-numeric type.</span>
    <span class="k">return</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_convert_array_values</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">result_type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert list or numpy array values to spark dataframe column values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">ArrayType</span><span class="p">,</span> <span class="n">StructType</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_type</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="o">.</span><span class="n">invalid_parameter_value</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;result_type must be ArrayType, got </span><span class="si">{</span><span class="n">result_type</span><span class="o">.</span><span class="n">simpleString</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">spark_primitive_type_to_np_type</span> <span class="o">=</span> <span class="n">_get_spark_primitive_type_to_np_type</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">result_type</span><span class="o">.</span><span class="n">elementType</span><span class="p">)</span> <span class="ow">in</span> <span class="n">spark_primitive_type_to_np_type</span><span class="p">:</span>
        <span class="n">np_type</span> <span class="o">=</span> <span class="n">spark_primitive_type_to_np_type</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">result_type</span><span class="o">.</span><span class="n">elementType</span><span class="p">)]</span>
        <span class="c1"># For array type result values, if provided value is None or NaN, regard it as a null array.</span>
        <span class="c1"># see https://github.com/mlflow/mlflow/issues/8986</span>
        <span class="k">return</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">_is_none_or_nan</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np_type</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_type</span><span class="o">.</span><span class="n">elementType</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">_convert_array_values</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">result_type</span><span class="o">.</span><span class="n">elementType</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_type</span><span class="o">.</span><span class="n">elementType</span><span class="p">,</span> <span class="n">StructType</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">_convert_struct_values</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">result_type</span><span class="o">.</span><span class="n">elementType</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>

    <span class="k">raise</span> <span class="n">MlflowException</span><span class="o">.</span><span class="n">invalid_parameter_value</span><span class="p">(</span>
        <span class="s2">&quot;Unsupported array type field with element type &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result_type</span><span class="o">.</span><span class="n">elementType</span><span class="o">.</span><span class="n">simpleString</span><span class="p">()</span><span class="si">}</span><span class="s2"> in Array type.&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="nd">@lru_cache</span>
<span class="k">def</span> <span class="nf">_get_spark_primitive_types</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">types</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">types</span><span class="o">.</span><span class="n">IntegerType</span><span class="p">,</span>
        <span class="n">types</span><span class="o">.</span><span class="n">LongType</span><span class="p">,</span>
        <span class="n">types</span><span class="o">.</span><span class="n">FloatType</span><span class="p">,</span>
        <span class="n">types</span><span class="o">.</span><span class="n">DoubleType</span><span class="p">,</span>
        <span class="n">types</span><span class="o">.</span><span class="n">StringType</span><span class="p">,</span>
        <span class="n">types</span><span class="o">.</span><span class="n">BooleanType</span><span class="p">,</span>
    <span class="p">)</span>


<span class="nd">@lru_cache</span>
<span class="k">def</span> <span class="nf">_get_spark_primitive_type_to_np_type</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">types</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="n">types</span><span class="o">.</span><span class="n">IntegerType</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span>
        <span class="n">types</span><span class="o">.</span><span class="n">LongType</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
        <span class="n">types</span><span class="o">.</span><span class="n">FloatType</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
        <span class="n">types</span><span class="o">.</span><span class="n">DoubleType</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
        <span class="n">types</span><span class="o">.</span><span class="n">BooleanType</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">,</span>
        <span class="n">types</span><span class="o">.</span><span class="n">StringType</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">str_</span><span class="p">,</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">_check_udf_return_struct_type</span><span class="p">(</span><span class="n">struct_type</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">ArrayType</span><span class="p">,</span> <span class="n">StructType</span>

    <span class="n">primitive_types</span> <span class="o">=</span> <span class="n">_get_spark_primitive_types</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">struct_type</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
        <span class="n">field_type</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">dataType</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_type</span><span class="p">,</span> <span class="n">primitive_types</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_type</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">)</span> <span class="ow">and</span> <span class="n">_check_udf_return_array_type</span><span class="p">(</span>
            <span class="n">field_type</span><span class="p">,</span> <span class="n">allow_struct</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">):</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_type</span><span class="p">,</span> <span class="n">StructType</span><span class="p">)</span> <span class="ow">and</span> <span class="n">_check_udf_return_struct_type</span><span class="p">(</span><span class="n">field_type</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">_check_udf_return_array_type</span><span class="p">(</span><span class="n">array_type</span><span class="p">,</span> <span class="n">allow_struct</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">ArrayType</span><span class="p">,</span> <span class="n">StructType</span>

    <span class="n">elem_type</span> <span class="o">=</span> <span class="n">array_type</span><span class="o">.</span><span class="n">elementType</span>
    <span class="n">primitive_types</span> <span class="o">=</span> <span class="n">_get_spark_primitive_types</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem_type</span><span class="p">,</span> <span class="n">primitive_types</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem_type</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_check_udf_return_array_type</span><span class="p">(</span><span class="n">elem_type</span><span class="p">,</span> <span class="n">allow_struct</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem_type</span><span class="p">,</span> <span class="n">StructType</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">allow_struct</span><span class="p">:</span>
            <span class="c1"># Array of struct values.</span>
            <span class="k">return</span> <span class="n">_check_udf_return_struct_type</span><span class="p">(</span><span class="n">elem_type</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">_check_udf_return_type</span><span class="p">(</span><span class="n">data_type</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">ArrayType</span><span class="p">,</span> <span class="n">StructType</span>

    <span class="n">primitive_types</span> <span class="o">=</span> <span class="n">_get_spark_primitive_types</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">primitive_types</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_check_udf_return_array_type</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">allow_struct</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">StructType</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_check_udf_return_struct_type</span><span class="p">(</span><span class="n">data_type</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">_convert_struct_values</span><span class="p">(</span>
    <span class="n">result</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">result_type</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert spark StructType values to spark dataframe column values.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">ArrayType</span><span class="p">,</span> <span class="n">StructType</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_type</span><span class="p">,</span> <span class="n">StructType</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="o">.</span><span class="n">invalid_parameter_value</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;result_type must be StructType, got </span><span class="si">{</span><span class="n">result_type</span><span class="o">.</span><span class="n">simpleString</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="o">.</span><span class="n">invalid_parameter_value</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unsupported result type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="si">}</span><span class="s2">, expected dict or pandas DataFrame&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">spark_primitive_type_to_np_type</span> <span class="o">=</span> <span class="n">_get_spark_primitive_type_to_np_type</span><span class="p">()</span>
    <span class="n">is_pandas_df</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
    <span class="n">result_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">result_type</span><span class="o">.</span><span class="n">fieldNames</span><span class="p">():</span>
        <span class="n">field_type</span> <span class="o">=</span> <span class="n">result_type</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">dataType</span>
        <span class="n">field_values</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">field_type</span><span class="p">)</span> <span class="ow">in</span> <span class="n">spark_primitive_type_to_np_type</span><span class="p">:</span>
            <span class="n">np_type</span> <span class="o">=</span> <span class="n">spark_primitive_type_to_np_type</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">field_type</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">is_pandas_df</span><span class="p">:</span>
                <span class="n">field_values</span> <span class="o">=</span> <span class="n">field_values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np_type</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">field_values</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">_is_none_or_nan</span><span class="p">(</span><span class="n">field_values</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">field_values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np_type</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_type</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">is_pandas_df</span><span class="p">:</span>
                <span class="n">field_values</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                    <span class="n">_convert_array_values</span><span class="p">(</span><span class="n">field_value</span><span class="p">,</span> <span class="n">field_type</span><span class="p">)</span> <span class="k">for</span> <span class="n">field_value</span> <span class="ow">in</span> <span class="n">field_values</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">field_values</span> <span class="o">=</span> <span class="n">_convert_array_values</span><span class="p">(</span><span class="n">field_values</span><span class="p">,</span> <span class="n">field_type</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_type</span><span class="p">,</span> <span class="n">StructType</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">is_pandas_df</span><span class="p">:</span>
                <span class="n">field_values</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">_convert_struct_values</span><span class="p">(</span><span class="n">field_value</span><span class="p">,</span> <span class="n">field_type</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">field_value</span> <span class="ow">in</span> <span class="n">field_values</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">field_values</span> <span class="o">=</span> <span class="n">_convert_struct_values</span><span class="p">(</span><span class="n">field_values</span><span class="p">,</span> <span class="n">field_type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="o">.</span><span class="n">invalid_parameter_value</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unsupported field type </span><span class="si">{</span><span class="n">field_type</span><span class="o">.</span><span class="n">simpleString</span><span class="p">()</span><span class="si">}</span><span class="s2"> in struct type.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">result_dict</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_values</span>

    <span class="k">if</span> <span class="n">is_pandas_df</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result_dict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result_dict</span>


<span class="k">def</span> <span class="nf">_is_spark_connect</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">pyspark.sql.utils</span> <span class="kn">import</span> <span class="n">is_remote</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">is_remote</span><span class="p">()</span>


<div class="viewcode-block" id="spark_udf"><a class="viewcode-back" href="../../python_api/mlflow.pyfunc.html#mlflow.pyfunc.spark_udf">[docs]</a><span class="k">def</span> <span class="nf">spark_udf</span><span class="p">(</span>
    <span class="n">spark</span><span class="p">,</span>
    <span class="n">model_uri</span><span class="p">,</span>
    <span class="n">result_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">env_manager</span><span class="o">=</span><span class="n">_EnvManager</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">extra_env</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Spark UDF that can be used to invoke the Python function formatted model.</span>

<span class="sd">    Parameters passed to the UDF are forwarded to the model as a DataFrame where the column names</span>
<span class="sd">    are ordinals (0, 1, ...). On some versions of Spark (3.0 and above), it is also possible to</span>
<span class="sd">    wrap the input in a struct. In that case, the data will be passed as a DataFrame with column</span>
<span class="sd">    names given by the struct definition (e.g. when invoked as my_udf(struct(&#39;x&#39;, &#39;y&#39;)), the model</span>
<span class="sd">    will get the data as a pandas DataFrame with 2 columns &#39;x&#39; and &#39;y&#39;).</span>

<span class="sd">    If a model contains a signature with tensor spec inputs, you will need to pass a column of</span>
<span class="sd">    array type as a corresponding UDF argument. The column values of which must be one dimensional</span>
<span class="sd">    arrays. The UDF will reshape the column values to the required shape with &#39;C&#39; order</span>
<span class="sd">    (i.e. read / write the elements using C-like index order) and cast the values as the required</span>
<span class="sd">    tensor spec type.</span>

<span class="sd">    If a model contains a signature, the UDF can be called without specifying column name</span>
<span class="sd">    arguments. In this case, the UDF will be called with column names from signature, so the</span>
<span class="sd">    evaluation dataframe&#39;s column names must match the model signature&#39;s column names.</span>

<span class="sd">    The predictions are filtered to contain only the columns that can be represented as the</span>
<span class="sd">    ``result_type``. If the ``result_type`` is string or array of strings, all predictions are</span>
<span class="sd">    converted to string. If the result type is not an array type, the left most column with</span>
<span class="sd">    matching type is returned.</span>

<span class="sd">    NOTE: Inputs of type ``pyspark.sql.types.DateType`` are not supported on earlier versions of</span>
<span class="sd">    Spark (2.4 and below).</span>

<span class="sd">    .. code-block:: python</span>
<span class="sd">        :caption: Example</span>

<span class="sd">        from pyspark.sql.functions import struct</span>

<span class="sd">        predict = mlflow.pyfunc.spark_udf(spark, &quot;/my/local/model&quot;)</span>
<span class="sd">        df.withColumn(&quot;prediction&quot;, predict(struct(&quot;name&quot;, &quot;age&quot;))).show()</span>

<span class="sd">    :param spark: A SparkSession object.</span>
<span class="sd">    :param model_uri: The location, in URI format, of the MLflow model with the</span>
<span class="sd">                      :py:mod:`mlflow.pyfunc` flavor. For example:</span>

<span class="sd">                      - ``/Users/me/path/to/local/model``</span>
<span class="sd">                      - ``relative/path/to/local/model``</span>
<span class="sd">                      - ``s3://my_bucket/path/to/model``</span>
<span class="sd">                      - ``runs:/&lt;mlflow_run_id&gt;/run-relative/path/to/model``</span>
<span class="sd">                      - ``models:/&lt;model_name&gt;/&lt;model_version&gt;``</span>
<span class="sd">                      - ``models:/&lt;model_name&gt;/&lt;stage&gt;``</span>
<span class="sd">                      - ``mlflow-artifacts:/path/to/model``</span>

<span class="sd">                      For more information about supported URI schemes, see</span>
<span class="sd">                      `Referencing Artifacts &lt;https://www.mlflow.org/docs/latest/concepts.html#</span>
<span class="sd">                      artifact-locations&gt;`_.</span>

<span class="sd">    :param result_type: the return type of the user-defined function. The value can be either a</span>
<span class="sd">        ``pyspark.sql.types.DataType`` object or a DDL-formatted type string. Only a primitive</span>
<span class="sd">        type, an array ``pyspark.sql.types.ArrayType`` of primitive type, or a struct type</span>
<span class="sd">        containing fields of above 2 kinds of types are allowed.</span>
<span class="sd">        If unspecified, it tries to infer result type from model signature</span>
<span class="sd">        output schema, if model output schema is not available, it fallbacks to use ``double``</span>
<span class="sd">        type.</span>

<span class="sd">        The following classes of result type are supported:</span>

<span class="sd">        - &quot;int&quot; or ``pyspark.sql.types.IntegerType``: The leftmost integer that can fit in an</span>
<span class="sd">          ``int32`` or an exception if there is none.</span>

<span class="sd">        - &quot;long&quot; or ``pyspark.sql.types.LongType``: The leftmost long integer that can fit in an</span>
<span class="sd">          ``int64`` or an exception if there is none.</span>

<span class="sd">        - ``ArrayType(IntegerType|LongType)``: All integer columns that can fit into the requested</span>
<span class="sd">          size.</span>

<span class="sd">        - &quot;float&quot; or ``pyspark.sql.types.FloatType``: The leftmost numeric result cast to</span>
<span class="sd">          ``float32`` or an exception if there is none.</span>

<span class="sd">        - &quot;double&quot; or ``pyspark.sql.types.DoubleType``: The leftmost numeric result cast to</span>
<span class="sd">          ``double`` or an exception if there is none.</span>

<span class="sd">        - ``ArrayType(FloatType|DoubleType)``: All numeric columns cast to the requested type or</span>
<span class="sd">          an exception if there are no numeric columns.</span>

<span class="sd">        - &quot;string&quot; or ``pyspark.sql.types.StringType``: The leftmost column converted to ``string``.</span>

<span class="sd">        - &quot;boolean&quot; or &quot;bool&quot; or ``pyspark.sql.types.BooleanType``: The leftmost column converted</span>
<span class="sd">          to ``bool`` or an exception if there is none.</span>

<span class="sd">        - ``ArrayType(StringType)``: All columns converted to ``string``.</span>

<span class="sd">        - &quot;field1 FIELD1_TYPE, field2 FIELD2_TYPE, ...&quot;: A struct type containing multiple fields</span>
<span class="sd">          separated by comma, each field type must be one of types listed above.</span>

<span class="sd">    :param env_manager: The environment manager to use in order to create the python environment</span>
<span class="sd">                        for model inference. Note that environment is only restored in the context</span>
<span class="sd">                        of the PySpark UDF; the software environment outside of the UDF is</span>
<span class="sd">                        unaffected. Default value is ``local``, and the following values are</span>
<span class="sd">                        supported:</span>

<span class="sd">                         - ``virtualenv``: Use virtualenv to restore the python environment that</span>
<span class="sd">                           was used to train the model.</span>
<span class="sd">                         - ``conda``: (Recommended) Use Conda to restore the software environment</span>
<span class="sd">                           that was used to train the model.</span>
<span class="sd">                         - ``local``: Use the current Python environment for model inference, which</span>
<span class="sd">                           may differ from the environment used to train the model and may lead to</span>
<span class="sd">                           errors or invalid predictions.</span>

<span class="sd">    :param params: Additional parameters to pass to the model for inference.</span>

<span class="sd">                   .. Note:: Experimental: This parameter may change or be removed in a future</span>
<span class="sd">                                           release without warning.</span>

<span class="sd">    :param extra_env: Extra environment variables to pass to the UDF executors.</span>
<span class="sd">    :return: Spark UDF that applies the model&#39;s ``predict`` method to the data and returns a</span>
<span class="sd">             type specified by ``result_type``, which by default is a double.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Scope Spark import to this method so users don&#39;t need pyspark to use non-Spark-related</span>
    <span class="c1"># functionality.</span>
    <span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">pandas_udf</span>
    <span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">ArrayType</span><span class="p">,</span>
        <span class="n">BooleanType</span><span class="p">,</span>
        <span class="n">DoubleType</span><span class="p">,</span>
        <span class="n">FloatType</span><span class="p">,</span>
        <span class="n">IntegerType</span><span class="p">,</span>
        <span class="n">LongType</span><span class="p">,</span>
        <span class="n">StringType</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StructType</span> <span class="k">as</span> <span class="n">SparkStructType</span>

    <span class="kn">from</span> <span class="nn">mlflow.pyfunc.spark_model_cache</span> <span class="kn">import</span> <span class="n">SparkModelCache</span>
    <span class="kn">from</span> <span class="nn">mlflow.utils._spark_utils</span> <span class="kn">import</span> <span class="n">_SparkDirectoryDistributor</span>

    <span class="n">is_spark_connect</span> <span class="o">=</span> <span class="n">_is_spark_connect</span><span class="p">()</span>
    <span class="c1"># Used in test to force install local version of mlflow when starting a model server</span>
    <span class="n">mlflow_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MLFLOW_HOME&quot;</span><span class="p">)</span>
    <span class="n">openai_env_vars</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">openai</span><span class="o">.</span><span class="n">_OpenAIEnvVar</span><span class="o">.</span><span class="n">read_environ</span><span class="p">()</span>
    <span class="n">mlflow_testing</span> <span class="o">=</span> <span class="n">_MLFLOW_TESTING</span><span class="o">.</span><span class="n">get_raw</span><span class="p">()</span>

    <span class="n">_EnvManager</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">env_manager</span><span class="p">)</span>

    <span class="c1"># Check whether spark is in local or local-cluster mode</span>
    <span class="c1"># this case all executors and driver share the same filesystem</span>
    <span class="n">is_spark_in_local_mode</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spark.master&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;local&quot;</span><span class="p">)</span>

    <span class="n">nfs_root_dir</span> <span class="o">=</span> <span class="n">get_nfs_cache_root_dir</span><span class="p">()</span>
    <span class="n">should_use_nfs</span> <span class="o">=</span> <span class="n">nfs_root_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">should_use_spark_to_broadcast_file</span> <span class="o">=</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="n">is_spark_in_local_mode</span> <span class="ow">or</span> <span class="n">should_use_nfs</span> <span class="ow">or</span> <span class="n">is_spark_connect</span>
    <span class="p">)</span>

    <span class="c1"># For spark connect mode,</span>
    <span class="c1"># If client code is executed in databricks runtime and NFS is available,</span>
    <span class="c1"># we save model to NFS temp directory in the driver</span>
    <span class="c1"># and load the model in the executor.</span>
    <span class="n">should_spark_connect_use_nfs</span> <span class="o">=</span> <span class="n">is_in_databricks_runtime</span><span class="p">()</span> <span class="ow">and</span> <span class="n">should_use_nfs</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="n">is_spark_connect</span>
        <span class="ow">and</span> <span class="n">env_manager</span> <span class="ow">in</span> <span class="p">(</span><span class="n">_EnvManager</span><span class="o">.</span><span class="n">VIRTUALENV</span><span class="p">,</span> <span class="n">_EnvManager</span><span class="o">.</span><span class="n">CONDA</span><span class="p">)</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">should_spark_connect_use_nfs</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="o">.</span><span class="n">invalid_parameter_value</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Environment manager </span><span class="si">{</span><span class="n">env_manager</span><span class="si">!r}</span><span class="s2"> is not supported in Spark connect mode &quot;</span>
            <span class="s2">&quot;when either non-Databricks environment is in use or NFS is unavailable.&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">local_model_path</span> <span class="o">=</span> <span class="n">_download_artifact_from_uri</span><span class="p">(</span>
        <span class="n">artifact_uri</span><span class="o">=</span><span class="n">model_uri</span><span class="p">,</span>
        <span class="n">output_path</span><span class="o">=</span><span class="n">_create_model_downloading_tmp_dir</span><span class="p">(</span><span class="n">should_use_nfs</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">env_manager</span> <span class="o">==</span> <span class="n">_EnvManager</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">:</span>
        <span class="c1"># Assume spark executor python environment is the same with spark driver side.</span>
        <span class="n">model_requirements</span> <span class="o">=</span> <span class="n">_get_pip_requirements_from_model_path</span><span class="p">(</span><span class="n">local_model_path</span><span class="p">)</span>
        <span class="n">warn_dependency_requirement_mismatches</span><span class="p">(</span><span class="n">model_requirements</span><span class="p">)</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s1">&#39;Calling `spark_udf()` with `env_manager=&quot;local&quot;` does not recreate the same &#39;</span>
            <span class="s2">&quot;environment that was used during training, which may lead to errors or inaccurate &quot;</span>
            <span class="s1">&#39;predictions. We recommend specifying `env_manager=&quot;conda&quot;`, which automatically &#39;</span>
            <span class="s2">&quot;recreates the environment that was used to train the model and performs inference &quot;</span>
            <span class="s2">&quot;in the recreated environment.&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;This UDF will use </span><span class="si">{</span><span class="n">env_manager</span><span class="si">}</span><span class="s2"> to recreate the model&#39;s software environment for &quot;</span>
            <span class="s2">&quot;inference. This may take extra time during execution.&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;linux&quot;</span><span class="p">):</span>
            <span class="c1"># TODO: support killing mlflow server launched in UDF task when spark job canceled</span>
            <span class="c1">#  for non-linux system.</span>
            <span class="c1">#  https://stackoverflow.com/questions/53208/how-do-i-automatically-destroy-child-processes-in-windows</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;In order to run inference code in restored python environment, PySpark UDF &quot;</span>
                <span class="s2">&quot;processes spawn MLflow Model servers as child processes. Due to system &quot;</span>
                <span class="s2">&quot;limitations with handling SIGKILL signals, these MLflow Model server child &quot;</span>
                <span class="s2">&quot;processes cannot be cleaned up if the Spark Job is canceled.&quot;</span>
            <span class="p">)</span>
    <span class="n">pyfunc_backend</span> <span class="o">=</span> <span class="n">get_flavor_backend</span><span class="p">(</span>
        <span class="n">local_model_path</span><span class="p">,</span>
        <span class="n">env_manager</span><span class="o">=</span><span class="n">env_manager</span><span class="p">,</span>
        <span class="n">install_mlflow</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MLFLOW_HOME&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">create_env_root_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">should_use_spark_to_broadcast_file</span><span class="p">:</span>
        <span class="c1"># Prepare restored environment in driver side if possible.</span>
        <span class="c1"># Note: In databricks runtime, because databricks notebook cell output cannot capture</span>
        <span class="c1"># child process output, so that set capture_output to be True so that when `conda prepare</span>
        <span class="c1"># env` command failed, the exception message will include command stdout/stderr output.</span>
        <span class="c1"># Otherwise user have to check cluster driver log to find command stdout/stderr output.</span>
        <span class="c1"># In non-databricks runtime, set capture_output to be False, because the benefit of</span>
        <span class="c1"># &quot;capture_output=False&quot; is the output will be printed immediately, otherwise you have</span>
        <span class="c1"># to wait conda command fail and suddenly get all output printed (included in error</span>
        <span class="c1"># message).</span>
        <span class="k">if</span> <span class="n">env_manager</span> <span class="o">!=</span> <span class="n">_EnvManager</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">:</span>
            <span class="n">pyfunc_backend</span><span class="o">.</span><span class="n">prepare_env</span><span class="p">(</span>
                <span class="n">model_uri</span><span class="o">=</span><span class="n">local_model_path</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="n">is_in_databricks_runtime</span><span class="p">()</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Broadcast local model directory to remote worker if needed.</span>
        <span class="n">archive_path</span> <span class="o">=</span> <span class="n">SparkModelCache</span><span class="o">.</span><span class="n">add_local_model</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="n">local_model_path</span><span class="p">)</span>

    <span class="n">model_metadata</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_model_path</span><span class="p">,</span> <span class="n">MLMODEL_FILE_NAME</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">result_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">model_output_schema</span> <span class="o">:=</span> <span class="n">model_metadata</span><span class="o">.</span><span class="n">get_output_schema</span><span class="p">():</span>
            <span class="n">result_type</span> <span class="o">=</span> <span class="n">_infer_spark_udf_return_type</span><span class="p">(</span><span class="n">model_output_schema</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;No &#39;result_type&#39; provided for spark_udf and the model does not &quot;</span>
                <span class="s2">&quot;have an output schema. &#39;result_type&#39; is set to &#39;double&#39; type.&quot;</span>
            <span class="p">)</span>
            <span class="n">result_type</span> <span class="o">=</span> <span class="n">DoubleType</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">result_type</span> <span class="o">=</span> <span class="n">_parse_spark_datatype</span><span class="p">(</span><span class="n">result_type</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">_check_udf_return_type</span><span class="p">(</span><span class="n">result_type</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="o">.</span><span class="n">invalid_parameter_value</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Invalid &#39;spark_udf&#39; result type: </span><span class="si">{</span><span class="n">result_type</span><span class="si">}</span><span class="s2">.</span>
<span class="s2">It must be one of the following types:</span>
<span class="s2">Primitive types:</span>
<span class="s2"> - int</span>
<span class="s2"> - long</span>
<span class="s2"> - float</span>
<span class="s2"> - double</span>
<span class="s2"> - string</span>
<span class="s2"> - boolean</span>
<span class="s2">Compound types:</span>
<span class="s2"> - ND array of primitives / structs.</span>
<span class="s2"> - struct&lt;field: primitive | array&lt;primitive&gt; | array&lt;array&lt;primitive&gt;&gt;, ...&gt;:</span>
<span class="s2">   A struct with primitive, ND array&lt;primitive/structs&gt;,</span>
<span class="s2">   e.g., struct&lt;a:int, b:array&lt;int&gt;&gt;.</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">_validate_params</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">model_metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_predict_row_batch</span><span class="p">(</span><span class="n">predict_fn</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">input_schema</span> <span class="o">=</span> <span class="n">model_metadata</span><span class="o">.</span><span class="n">get_input_schema</span><span class="p">()</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">pdf</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">input_schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">))]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="n">input_schema</span><span class="o">.</span><span class="n">input_names</span><span class="p">()</span>
                <span class="n">required_names</span> <span class="o">=</span> <span class="n">input_schema</span><span class="o">.</span><span class="n">required_input_names</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">required_names</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                        <span class="s2">&quot;Model input is missing required columns. Expected </span><span class="si">{}</span><span class="s2"> required&quot;</span>
                        <span class="s2">&quot; input columns </span><span class="si">{}</span><span class="s2">, but the model received only </span><span class="si">{}</span><span class="s2"> unnamed input columns&quot;</span>
                        <span class="s2">&quot; (Since the columns were passed unnamed they are expected to be in&quot;</span>
                        <span class="s2">&quot; the order specified by the schema).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">),</span> <span class="n">names</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
                    <span class="p">)</span>
            <span class="n">pdf</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                    <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="n">arg</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>
                    <span class="c1"># pandas_udf receives a StructType column as a pandas DataFrame.</span>
                    <span class="c1"># We need to convert it back to a dict of pandas Series.</span>
                    <span class="k">else</span> <span class="n">arg</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="p">},</span>
                <span class="n">columns</span><span class="o">=</span><span class="n">names</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">predict_fn</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_type</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_type</span><span class="o">.</span><span class="n">elementType</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">):</span>
            <span class="n">result_values</span> <span class="o">=</span> <span class="n">_convert_array_values</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">result_type</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">result_values</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">result</span><span class="p">])</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="k">else</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_type</span><span class="p">,</span> <span class="n">SparkStructType</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_convert_struct_values</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">result_type</span><span class="p">)</span>

        <span class="n">elem_type</span> <span class="o">=</span> <span class="n">result_type</span><span class="o">.</span><span class="n">elementType</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_type</span><span class="p">,</span> <span class="n">ArrayType</span><span class="p">)</span> <span class="k">else</span> <span class="n">result_type</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">elem_type</span><span class="p">)</span> <span class="o">==</span> <span class="n">IntegerType</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span>
                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">byte</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ubyte</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">short</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ushort</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">elem_type</span><span class="p">)</span> <span class="o">==</span> <span class="n">LongType</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">byte</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ubyte</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">short</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ushort</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">int64</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">elem_type</span><span class="p">)</span> <span class="o">==</span> <span class="n">FloatType</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">,))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">elem_type</span><span class="p">)</span> <span class="o">==</span> <span class="n">DoubleType</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">,))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">elem_type</span><span class="p">)</span> <span class="o">==</span> <span class="n">BooleanType</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">([</span><span class="nb">bool</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;The model did not produce any values compatible with the requested &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;type &#39;</span><span class="si">{</span><span class="n">elem_type</span><span class="si">}</span><span class="s2">&#39;. Consider requesting udf with StringType or &quot;</span>
                <span class="s2">&quot;Arraytype(StringType).&quot;</span><span class="p">,</span>
                <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">elem_type</span><span class="p">)</span> <span class="o">==</span> <span class="n">StringType</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">result_type</span><span class="p">)</span> <span class="o">==</span> <span class="n">ArrayType</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="n">result_type_hint</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_type</span><span class="p">,</span> <span class="n">SparkStructType</span><span class="p">)</span> <span class="k">else</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span>
    <span class="p">)</span>

    <span class="n">tracking_uri</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">get_tracking_uri</span><span class="p">()</span>

    <span class="nd">@pandas_udf</span><span class="p">(</span><span class="n">result_type</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">udf</span><span class="p">(</span>
        <span class="n">iterator</span><span class="p">:</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span> <span class="o">...</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">result_type_hint</span><span class="p">]:</span>
        <span class="c1"># importing here to prevent circular import</span>
        <span class="kn">from</span> <span class="nn">mlflow.pyfunc.scoring_server.client</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">ScoringServerClient</span><span class="p">,</span>
            <span class="n">StdinScoringServerClient</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Note: this is a pandas udf function in iteration style, which takes an iterator of</span>
        <span class="c1"># tuple of pandas.Series and outputs an iterator of pandas.Series.</span>
        <span class="n">update_envs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">mlflow_home</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">update_envs</span><span class="p">[</span><span class="s2">&quot;MLFLOW_HOME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mlflow_home</span>
        <span class="k">if</span> <span class="n">openai_env_vars</span><span class="p">:</span>
            <span class="n">update_envs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">openai_env_vars</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mlflow_testing</span><span class="p">:</span>
            <span class="n">update_envs</span><span class="p">[</span><span class="n">_MLFLOW_TESTING</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mlflow_testing</span>
        <span class="k">if</span> <span class="n">extra_env</span><span class="p">:</span>
            <span class="n">update_envs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra_env</span><span class="p">)</span>

        <span class="c1">#  use `modified_environ` to temporarily set the envs and restore them finally</span>
        <span class="k">with</span> <span class="n">modified_environ</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="n">update_envs</span><span class="p">):</span>
            <span class="n">scoring_server_proc</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># set tracking_uri inside udf so that with spark_connect</span>
            <span class="c1"># we can load the model from correct path</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tracking_uri</span><span class="p">(</span><span class="n">tracking_uri</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">env_manager</span> <span class="o">!=</span> <span class="n">_EnvManager</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">should_use_spark_to_broadcast_file</span><span class="p">:</span>
                    <span class="n">local_model_path_on_executor</span> <span class="o">=</span> <span class="n">_SparkDirectoryDistributor</span><span class="o">.</span><span class="n">get_or_extract</span><span class="p">(</span>
                        <span class="n">archive_path</span>
                    <span class="p">)</span>
                    <span class="c1"># Call &quot;prepare_env&quot; in advance in order to reduce scoring server launch time.</span>
                    <span class="c1"># So that we can use a shorter timeout when call `client.wait_server_ready`,</span>
                    <span class="c1"># otherwise we have to set a long timeout for `client.wait_server_ready` time,</span>
                    <span class="c1"># this prevents spark UDF task failing fast if other exception raised</span>
                    <span class="c1"># when scoring server launching.</span>
                    <span class="c1"># Set &quot;capture_output&quot; so that if &quot;conda env create&quot; command failed, the command</span>
                    <span class="c1"># stdout/stderr output will be attached to the exception message and included in</span>
                    <span class="c1"># driver side exception.</span>
                    <span class="n">pyfunc_backend</span><span class="o">.</span><span class="n">prepare_env</span><span class="p">(</span>
                        <span class="n">model_uri</span><span class="o">=</span><span class="n">local_model_path_on_executor</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">local_model_path_on_executor</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">check_port_connectivity</span><span class="p">():</span>
                    <span class="c1"># launch scoring server</span>
                    <span class="n">server_port</span> <span class="o">=</span> <span class="n">find_free_port</span><span class="p">()</span>
                    <span class="n">host</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
                    <span class="n">scoring_server_proc</span> <span class="o">=</span> <span class="n">pyfunc_backend</span><span class="o">.</span><span class="n">serve</span><span class="p">(</span>
                        <span class="n">model_uri</span><span class="o">=</span><span class="n">local_model_path_on_executor</span> <span class="ow">or</span> <span class="n">local_model_path</span><span class="p">,</span>
                        <span class="n">port</span><span class="o">=</span><span class="n">server_port</span><span class="p">,</span>
                        <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
                        <span class="n">timeout</span><span class="o">=</span><span class="n">MLFLOW_SCORING_SERVER_REQUEST_TIMEOUT</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span>
                        <span class="n">enable_mlserver</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">synchronous</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                        <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="n">client</span> <span class="o">=</span> <span class="n">ScoringServerClient</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">server_port</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">scoring_server_proc</span> <span class="o">=</span> <span class="n">pyfunc_backend</span><span class="o">.</span><span class="n">serve_stdin</span><span class="p">(</span>
                        <span class="n">model_uri</span><span class="o">=</span><span class="n">local_model_path_on_executor</span> <span class="ow">or</span> <span class="n">local_model_path</span><span class="p">,</span>
                        <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                        <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">client</span> <span class="o">=</span> <span class="n">StdinScoringServerClient</span><span class="p">(</span><span class="n">scoring_server_proc</span><span class="p">)</span>

                <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">client</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

                <span class="n">server_tail_logs</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">(</span>
                    <span class="n">maxlen</span><span class="o">=</span><span class="n">_MLFLOW_SERVER_OUTPUT_TAIL_LINES_TO_KEEP</span>
                <span class="p">)</span>

                <span class="k">def</span> <span class="nf">server_redirect_log_thread_func</span><span class="p">(</span><span class="n">child_stdout</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">child_stdout</span><span class="p">:</span>
                        <span class="n">decoded</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="n">line</span>
                        <span class="n">server_tail_logs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">decoded</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;[model server] &quot;</span> <span class="o">+</span> <span class="n">decoded</span><span class="p">)</span>

                <span class="n">server_redirect_log_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                    <span class="n">target</span><span class="o">=</span><span class="n">server_redirect_log_thread_func</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">scoring_server_proc</span><span class="o">.</span><span class="n">stdout</span><span class="p">,),</span>
                    <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">server_redirect_log_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">client</span><span class="o">.</span><span class="n">wait_server_ready</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">scoring_server_proc</span><span class="o">=</span><span class="n">scoring_server_proc</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;During spark UDF task execution, mlflow model server failed to launch. &quot;</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">server_tail_logs</span><span class="p">)</span> <span class="o">==</span> <span class="n">_MLFLOW_SERVER_OUTPUT_TAIL_LINES_TO_KEEP</span><span class="p">:</span>
                        <span class="n">err_msg</span> <span class="o">+=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Last </span><span class="si">{</span><span class="n">_MLFLOW_SERVER_OUTPUT_TAIL_LINES_TO_KEEP</span><span class="si">}</span><span class="s2"> &quot;</span>
                            <span class="s2">&quot;lines of MLflow model server output:</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">err_msg</span> <span class="o">+=</span> <span class="s2">&quot;MLflow model server output:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">err_msg</span> <span class="o">+=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">server_tail_logs</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

                <span class="k">def</span> <span class="nf">batch_predict_fn</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">invoke</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;params&quot;</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">get_predictions</span><span class="p">()</span>
                    <span class="n">_log_warning_if_params_not_in_predict_signature</span><span class="p">(</span><span class="n">_logger</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span><span class="o">.</span><span class="n">get_predictions</span><span class="p">()</span>

            <span class="k">elif</span> <span class="n">env_manager</span> <span class="o">==</span> <span class="n">_EnvManager</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_spark_connect</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">should_spark_connect_use_nfs</span><span class="p">:</span>
                    <span class="n">model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">(),</span>
                        <span class="s2">&quot;mlflow&quot;</span><span class="p">,</span>
                        <span class="n">insecure_hash</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">model_uri</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(),</span>
                    <span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">loaded_model</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">loaded_model</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">model_uri</span><span class="p">,</span> <span class="n">dst_path</span><span class="o">=</span><span class="n">model_path</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">should_use_spark_to_broadcast_file</span><span class="p">:</span>
                    <span class="n">loaded_model</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">SparkModelCache</span><span class="o">.</span><span class="n">get_or_load</span><span class="p">(</span><span class="n">archive_path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">loaded_model</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">local_model_path</span><span class="p">)</span>

                <span class="k">def</span> <span class="nf">batch_predict_fn</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">loaded_model</span><span class="o">.</span><span class="n">predict</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;params&quot;</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">loaded_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
                    <span class="n">_log_warning_if_params_not_in_predict_signature</span><span class="p">(</span><span class="n">_logger</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">loaded_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">input_batch</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
                    <span class="c1"># If the UDF is called with only multiple arguments,</span>
                    <span class="c1"># the `input_batch` is a tuple which composes of several pd.Series/pd.DataFrame</span>
                    <span class="c1"># objects.</span>
                    <span class="c1"># If the UDF is called with only one argument,</span>
                    <span class="c1"># the `input_batch` instance will be an instance of `pd.Series`/`pd.DataFrame`,</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_batch</span><span class="p">,</span> <span class="p">(</span><span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)):</span>
                        <span class="c1"># UDF is called with only one argument</span>
                        <span class="n">row_batch_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_batch</span><span class="p">,)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">row_batch_args</span> <span class="o">=</span> <span class="n">input_batch</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row_batch_args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">_predict_row_batch</span><span class="p">(</span><span class="n">batch_predict_fn</span><span class="p">,</span> <span class="n">row_batch_args</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">scoring_server_proc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">scoring_server_proc</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>

    <span class="n">udf</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">model_metadata</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">udf</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">udf_with_default_cols</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">input_schema</span> <span class="o">=</span> <span class="n">model_metadata</span><span class="o">.</span><span class="n">get_input_schema</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">input_schema</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_schema</span><span class="o">.</span><span class="n">optional_input_names</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Cannot apply UDF without column names specified when&quot;</span>
                    <span class="s2">&quot; model signature contains optional columns.&quot;</span><span class="p">,</span>
                    <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">input_schema</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_schema</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">input_schema</span><span class="o">.</span><span class="n">has_input_names</span><span class="p">():</span>
                    <span class="n">input_names</span> <span class="o">=</span> <span class="n">input_schema</span><span class="o">.</span><span class="n">input_names</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">udf</span><span class="p">(</span><span class="o">*</span><span class="n">input_names</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Cannot apply udf because no column names specified. The udf &quot;</span>
                        <span class="s2">&quot;expects </span><span class="si">{}</span><span class="s2"> columns with types: </span><span class="si">{}</span><span class="s2">. Input column names could not be &quot;</span>
                        <span class="s2">&quot;inferred from the model signature (column names not found).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="nb">len</span><span class="p">(</span><span class="n">input_schema</span><span class="o">.</span><span class="n">inputs</span><span class="p">),</span>
                            <span class="n">input_schema</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                    <span class="s2">&quot;Attempting to apply udf on zero columns because no column names were &quot;</span>
                    <span class="s2">&quot;specified as arguments or inferred from the model signature.&quot;</span><span class="p">,</span>
                    <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">udf</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">udf_with_default_cols</span></div>


<span class="k">def</span> <span class="nf">_validate_function_python_model</span><span class="p">(</span><span class="n">python_model</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">python_model</span><span class="p">,</span> <span class="n">PythonModel</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">callable</span><span class="p">(</span><span class="n">python_model</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="s2">&quot;`python_model` must be a PythonModel instance or a callable object&quot;</span><span class="p">,</span>
            <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">python_model</span><span class="p">):</span>
        <span class="n">num_args</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">python_model</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_args</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                <span class="s2">&quot;When `python_model` is a callable object, it must accept exactly one argument. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">num_args</span><span class="si">}</span><span class="s2"> arguments.&quot;</span><span class="p">,</span>
                <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
            <span class="p">)</span>


<div class="viewcode-block" id="save_model"><a class="viewcode-back" href="../../python_api/mlflow.pyfunc.html#mlflow.pyfunc.save_model">[docs]</a><span class="nd">@format_docstring</span><span class="p">(</span><span class="n">LOG_MODEL_PARAM_DOCS</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">package_name</span><span class="o">=</span><span class="s2">&quot;scikit-learn&quot;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span>
    <span class="n">path</span><span class="p">,</span>
    <span class="n">loader_module</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">data_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">code_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">conda_env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">mlflow_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">python_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">artifacts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">signature</span><span class="p">:</span> <span class="n">ModelSignature</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">input_example</span><span class="p">:</span> <span class="n">ModelInputExample</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pip_requirements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">extra_pip_requirements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">model_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">example_no_conversion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    save_model(path, loader_module=None, data_path=None, code_path=None, conda_env=None,\</span>
<span class="sd">               mlflow_model=Model(), python_model=None, artifacts=None)</span>

<span class="sd">    Save a Pyfunc model with custom inference logic and optional data dependencies to a path on the</span>
<span class="sd">    local filesystem.</span>

<span class="sd">    For information about the workflows that this method supports, please see :ref:`&quot;workflows for</span>
<span class="sd">    creating custom pyfunc models&quot; &lt;pyfunc-create-custom-workflows&gt;` and</span>
<span class="sd">    :ref:`&quot;which workflow is right for my use case?&quot; &lt;pyfunc-create-custom-selecting-workflow&gt;`.</span>
<span class="sd">    Note that the parameters for the second workflow: ``loader_module``, ``data_path`` and the</span>
<span class="sd">    parameters for the first workflow: ``python_model``, ``artifacts``, cannot be</span>
<span class="sd">    specified together.</span>

<span class="sd">    :param path: The path to which to save the Python model.</span>
<span class="sd">    :param loader_module: The name of the Python module that is used to load the model</span>
<span class="sd">                          from ``data_path``. This module must define a method with the prototype</span>
<span class="sd">                          ``_load_pyfunc(data_path)``. If not ``None``, this module and its</span>
<span class="sd">                          dependencies must be included in one of the following locations:</span>

<span class="sd">                          - The MLflow library.</span>
<span class="sd">                          - Package(s) listed in the model&#39;s Conda environment, specified by</span>
<span class="sd">                            the ``conda_env`` parameter.</span>
<span class="sd">                          - One or more of the files specified by the ``code_path`` parameter.</span>

<span class="sd">    :param data_path: Path to a file or directory containing model data.</span>
<span class="sd">    :param code_path: A list of local filesystem paths to Python file dependencies (or directories</span>
<span class="sd">                      containing file dependencies). These files are *prepended* to the system</span>
<span class="sd">                      path before the model is loaded.</span>
<span class="sd">    :param conda_env: {{ conda_env }}</span>
<span class="sd">    :param mlflow_model: :py:mod:`mlflow.models.Model` configuration to which to add the</span>
<span class="sd">                         **python_function** flavor.</span>
<span class="sd">    :param python_model:</span>
<span class="sd">        An instance of a subclass of :class:`~PythonModel` or a callable object with a single</span>
<span class="sd">        argument (see the examples below). The passed-in object is serialized using the CloudPickle</span>
<span class="sd">        library. Any dependencies of the class should be included in one of the following locations:</span>

<span class="sd">        - The MLflow library.</span>
<span class="sd">        - Package(s) listed in the model&#39;s Conda environment, specified by the ``conda_env``</span>
<span class="sd">          parameter.</span>
<span class="sd">        - One or more of the files specified by the ``code_path`` parameter.</span>

<span class="sd">        Note: If the class is imported from another module, as opposed to being defined in the</span>
<span class="sd">        ``__main__`` scope, the defining module should also be included in one of the listed</span>
<span class="sd">        locations.</span>

<span class="sd">        **Examples**</span>

<span class="sd">        Class model</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            from typing import List, Dict</span>
<span class="sd">            import mlflow</span>


<span class="sd">            class MyModel(mlflow.pyfunc.PythonModel):</span>
<span class="sd">                def predict(self, context, model_input: List[str], params=None) -&gt; List[str]:</span>
<span class="sd">                    return [i.upper() for i in model_input]</span>


<span class="sd">            mlflow.pyfunc.save_model(&quot;model&quot;, python_model=MyModel(), input_example=[&quot;a&quot;])</span>
<span class="sd">            model = mlflow.pyfunc.load_model(&quot;model&quot;)</span>
<span class="sd">            print(model.predict([&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]))  # -&gt; [&quot;A&quot;, &quot;B&quot;, &quot;C&quot;]</span>

<span class="sd">        Functional model</span>

<span class="sd">        .. note::</span>
<span class="sd">            Experimental: Functional model support is experimental and may change or be removed in</span>
<span class="sd">            a future release without warning.</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            from typing import List</span>
<span class="sd">            import mlflow</span>


<span class="sd">            def predict(model_input: List[str]) -&gt; List[str]:</span>
<span class="sd">                return [i.upper() for i in model_input]</span>


<span class="sd">            mlflow.pyfunc.save_model(&quot;model&quot;, python_model=predict, input_example=[&quot;a&quot;])</span>
<span class="sd">            model = mlflow.pyfunc.load_model(&quot;model&quot;)</span>
<span class="sd">            print(model.predict([&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]))  # -&gt; [&quot;A&quot;, &quot;B&quot;, &quot;C&quot;]</span>

<span class="sd">        If the `predict` method or function has type annotations, MLflow automatically constructs</span>
<span class="sd">        a model signature based on the type annotations (unless the ``signature`` argument is</span>
<span class="sd">        explicitly specified), and converts the input value to the specified type before passing</span>
<span class="sd">        it to the function. Currently, the following type annotations are supported:</span>

<span class="sd">            - ``List[str]``</span>
<span class="sd">            - ``List[Dict[str, str]]``</span>

<span class="sd">    :param artifacts: A dictionary containing ``&lt;name, artifact_uri&gt;`` entries. Remote artifact URIs</span>
<span class="sd">                      are resolved to absolute filesystem paths, producing a dictionary of</span>
<span class="sd">                      ``&lt;name, absolute_path&gt;`` entries. ``python_model`` can reference these</span>
<span class="sd">                      resolved entries as the ``artifacts`` property of the ``context`` parameter</span>
<span class="sd">                      in :func:`PythonModel.load_context() &lt;mlflow.pyfunc.PythonModel.load_context&gt;`</span>
<span class="sd">                      and :func:`PythonModel.predict() &lt;mlflow.pyfunc.PythonModel.predict&gt;`.</span>
<span class="sd">                      For example, consider the following ``artifacts`` dictionary::</span>

<span class="sd">                        {</span>
<span class="sd">                            &quot;my_file&quot;: &quot;s3://my-bucket/path/to/my/file&quot;</span>
<span class="sd">                        }</span>

<span class="sd">                      In this case, the ``&quot;my_file&quot;`` artifact is downloaded from S3. The</span>
<span class="sd">                      ``python_model`` can then refer to ``&quot;my_file&quot;`` as an absolute filesystem</span>
<span class="sd">                      path via ``context.artifacts[&quot;my_file&quot;]``.</span>

<span class="sd">                      If ``None``, no artifacts are added to the model.</span>

<span class="sd">    :param signature: :py:class:`ModelSignature &lt;mlflow.models.ModelSignature&gt;`</span>
<span class="sd">                      describes model input and output :py:class:`Schema &lt;mlflow.types.Schema&gt;`.</span>
<span class="sd">                      The model signature can be :py:func:`inferred &lt;mlflow.models.infer_signature&gt;`</span>
<span class="sd">                      from datasets with valid model input (e.g. the training dataset with target</span>
<span class="sd">                      column omitted) and valid model output (e.g. model predictions generated on</span>
<span class="sd">                      the training dataset), for example:</span>

<span class="sd">                      .. code-block:: python</span>

<span class="sd">                        from mlflow.models import infer_signature</span>

<span class="sd">                        train = df.drop_column(&quot;target_label&quot;)</span>
<span class="sd">                        predictions = ...  # compute model predictions</span>
<span class="sd">                        signature = infer_signature(train, predictions)</span>
<span class="sd">    :param input_example: {{ input_example }}</span>
<span class="sd">    :param pip_requirements: {{ pip_requirements }}</span>
<span class="sd">    :param extra_pip_requirements: {{ extra_pip_requirements }}</span>
<span class="sd">    :param metadata: Custom metadata dictionary passed to the model and stored in the MLmodel file.</span>

<span class="sd">                     .. Note:: Experimental: This parameter may change or be removed in a future</span>
<span class="sd">                                             release without warning.</span>
<span class="sd">    :param model_config: The model configuration to apply to the model. This configuration</span>
<span class="sd">                         is available during model loading.</span>

<span class="sd">                     .. Note:: Experimental: This parameter may change or be removed in a future</span>
<span class="sd">                                             release without warning.</span>
<span class="sd">    :param example_no_conversion: {{ example_no_conversion }}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_validate_env_arguments</span><span class="p">(</span><span class="n">conda_env</span><span class="p">,</span> <span class="n">pip_requirements</span><span class="p">,</span> <span class="n">extra_pip_requirements</span><span class="p">)</span>
    <span class="n">_validate_pyfunc_model_config</span><span class="p">(</span><span class="n">model_config</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">python_model</span><span class="p">:</span>
        <span class="n">_validate_function_python_model</span><span class="p">(</span><span class="n">python_model</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">python_model</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span>
            <span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">(</span><span class="n">input_example</span><span class="p">,</span> <span class="n">pip_requirements</span><span class="p">,</span> <span class="n">extra_pip_requirements</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                <span class="s2">&quot;If `python_model` is a callable object, at least one of `input_example`, &quot;</span>
                <span class="s2">&quot;`pip_requirements`, or `extra_pip_requirements` must be specified.&quot;</span>
            <span class="p">)</span>

    <span class="n">mlflow_model</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mlflow_model</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;save_model() got unexpected keyword arguments: </span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">code_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code_path</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Argument code_path should be a list, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">code_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">first_argument_set</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;loader_module&quot;</span><span class="p">:</span> <span class="n">loader_module</span><span class="p">,</span>
        <span class="s2">&quot;data_path&quot;</span><span class="p">:</span> <span class="n">data_path</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">second_argument_set</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;artifacts&quot;</span><span class="p">:</span> <span class="n">artifacts</span><span class="p">,</span>
        <span class="s2">&quot;python_model&quot;</span><span class="p">:</span> <span class="n">python_model</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">first_argument_set_specified</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">first_argument_set</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">second_argument_set_specified</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">second_argument_set</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">first_argument_set_specified</span> <span class="ow">and</span> <span class="n">second_argument_set_specified</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;The following sets of parameters cannot be specified together: </span><span class="si">{first_set_keys}</span><span class="s2">&quot;</span>
                <span class="s2">&quot; and </span><span class="si">{second_set_keys}</span><span class="s2">. All parameters in one set must be `None`. Instead, found&quot;</span>
                <span class="s2">&quot; the following values: </span><span class="si">{first_set_entries}</span><span class="s2"> and </span><span class="si">{second_set_entries}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">first_set_keys</span><span class="o">=</span><span class="n">first_argument_set</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                    <span class="n">second_set_keys</span><span class="o">=</span><span class="n">second_argument_set</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                    <span class="n">first_set_entries</span><span class="o">=</span><span class="n">first_argument_set</span><span class="p">,</span>
                    <span class="n">second_set_entries</span><span class="o">=</span><span class="n">second_argument_set</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">),</span>
            <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">loader_module</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">python_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Either `loader_module` or `python_model` must be specified. A `loader_module` &quot;</span>
            <span class="s2">&quot;should be a python module. A `python_model` should be a subclass of PythonModel&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">)</span>

    <span class="n">_validate_and_prepare_target_save_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mlflow_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mlflow_model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>

    <span class="n">hints</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">signature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mlflow_model</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="n">signature</span>
    <span class="k">elif</span> <span class="n">python_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">python_model</span><span class="p">):</span>
            <span class="n">input_arg_index</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># first argument</span>
            <span class="k">if</span> <span class="n">signature</span> <span class="o">:=</span> <span class="n">_infer_signature_from_type_hints</span><span class="p">(</span>
                <span class="n">python_model</span><span class="p">,</span> <span class="n">input_arg_index</span><span class="p">,</span> <span class="n">input_example</span><span class="o">=</span><span class="n">input_example</span>
            <span class="p">):</span>
                <span class="n">mlflow_model</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="n">signature</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">python_model</span><span class="p">,</span> <span class="n">PythonModel</span><span class="p">):</span>
            <span class="n">input_arg_index</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># second argument</span>
            <span class="k">if</span> <span class="n">signature</span> <span class="o">:=</span> <span class="n">_infer_signature_from_type_hints</span><span class="p">(</span>
                <span class="n">python_model</span><span class="o">.</span><span class="n">predict</span><span class="p">,</span>
                <span class="n">input_arg_index</span><span class="o">=</span><span class="n">input_arg_index</span><span class="p">,</span>
                <span class="n">input_example</span><span class="o">=</span><span class="n">input_example</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="n">mlflow_model</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="n">signature</span>
            <span class="k">elif</span> <span class="n">input_example</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mlflow_model</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="n">_infer_signature_from_input_example</span><span class="p">(</span>
                        <span class="n">input_example</span><span class="p">,</span> <span class="n">_PythonModelPyfuncWrapper</span><span class="p">(</span><span class="n">python_model</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to infer model signature from input example. </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">input_example</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_save_example</span><span class="p">(</span><span class="n">mlflow_model</span><span class="p">,</span> <span class="n">input_example</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">example_no_conversion</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mlflow_model</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>

    <span class="k">if</span> <span class="n">first_argument_set_specified</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_save_model_with_loader_module_and_data_path</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
            <span class="n">loader_module</span><span class="o">=</span><span class="n">loader_module</span><span class="p">,</span>
            <span class="n">data_path</span><span class="o">=</span><span class="n">data_path</span><span class="p">,</span>
            <span class="n">code_paths</span><span class="o">=</span><span class="n">code_path</span><span class="p">,</span>
            <span class="n">conda_env</span><span class="o">=</span><span class="n">conda_env</span><span class="p">,</span>
            <span class="n">mlflow_model</span><span class="o">=</span><span class="n">mlflow_model</span><span class="p">,</span>
            <span class="n">pip_requirements</span><span class="o">=</span><span class="n">pip_requirements</span><span class="p">,</span>
            <span class="n">extra_pip_requirements</span><span class="o">=</span><span class="n">extra_pip_requirements</span><span class="p">,</span>
            <span class="n">model_config</span><span class="o">=</span><span class="n">model_config</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">second_argument_set_specified</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_save_model_with_class_artifacts_params</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
            <span class="n">signature</span><span class="o">=</span><span class="n">signature</span><span class="p">,</span>
            <span class="n">hints</span><span class="o">=</span><span class="n">hints</span><span class="p">,</span>
            <span class="n">python_model</span><span class="o">=</span><span class="n">python_model</span><span class="p">,</span>
            <span class="n">artifacts</span><span class="o">=</span><span class="n">artifacts</span><span class="p">,</span>
            <span class="n">conda_env</span><span class="o">=</span><span class="n">conda_env</span><span class="p">,</span>
            <span class="n">code_paths</span><span class="o">=</span><span class="n">code_path</span><span class="p">,</span>
            <span class="n">mlflow_model</span><span class="o">=</span><span class="n">mlflow_model</span><span class="p">,</span>
            <span class="n">pip_requirements</span><span class="o">=</span><span class="n">pip_requirements</span><span class="p">,</span>
            <span class="n">extra_pip_requirements</span><span class="o">=</span><span class="n">extra_pip_requirements</span><span class="p">,</span>
            <span class="n">model_config</span><span class="o">=</span><span class="n">model_config</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="log_model"><a class="viewcode-back" href="../../python_api/mlflow.pyfunc.html#mlflow.pyfunc.log_model">[docs]</a><span class="nd">@format_docstring</span><span class="p">(</span><span class="n">LOG_MODEL_PARAM_DOCS</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">package_name</span><span class="o">=</span><span class="s2">&quot;scikit-learn&quot;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">log_model</span><span class="p">(</span>
    <span class="n">artifact_path</span><span class="p">,</span>
    <span class="n">loader_module</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">data_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">code_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">conda_env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">python_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">artifacts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">registered_model_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">signature</span><span class="p">:</span> <span class="n">ModelSignature</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">input_example</span><span class="p">:</span> <span class="n">ModelInputExample</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">await_registration_for</span><span class="o">=</span><span class="n">DEFAULT_AWAIT_MAX_SLEEP_SECONDS</span><span class="p">,</span>
    <span class="n">pip_requirements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">extra_pip_requirements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">model_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">example_no_conversion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Log a Pyfunc model with custom inference logic and optional data dependencies as an MLflow</span>
<span class="sd">    artifact for the current run.</span>

<span class="sd">    For information about the workflows that this method supports, see :ref:`Workflows for</span>
<span class="sd">    creating custom pyfunc models &lt;pyfunc-create-custom-workflows&gt;` and</span>
<span class="sd">    :ref:`Which workflow is right for my use case? &lt;pyfunc-create-custom-selecting-workflow&gt;`.</span>
<span class="sd">    You cannot specify the parameters for the second workflow: ``loader_module``, ``data_path``</span>
<span class="sd">    and the parameters for the first workflow: ``python_model``, ``artifacts`` together.</span>

<span class="sd">    :param artifact_path: The run-relative artifact path to which to log the Python model.</span>
<span class="sd">    :param loader_module: The name of the Python module that is used to load the model</span>
<span class="sd">                          from ``data_path``. This module must define a method with the prototype</span>
<span class="sd">                          ``_load_pyfunc(data_path)``. If not ``None``, this module and its</span>
<span class="sd">                          dependencies must be included in one of the following locations:</span>

<span class="sd">                          - The MLflow library.</span>
<span class="sd">                          - Package(s) listed in the model&#39;s Conda environment, specified by</span>
<span class="sd">                            the ``conda_env`` parameter.</span>
<span class="sd">                          - One or more of the files specified by the ``code_path`` parameter.</span>

<span class="sd">    :param data_path: Path to a file or directory containing model data.</span>
<span class="sd">    :param code_path: A list of local filesystem paths to Python file dependencies (or directories</span>
<span class="sd">                      containing file dependencies). These files are *prepended* to the system</span>
<span class="sd">                      path before the model is loaded.</span>
<span class="sd">    :param conda_env: {{ conda_env }}</span>
<span class="sd">    :param python_model:</span>
<span class="sd">        An instance of a subclass of :class:`~PythonModel` or a callable object with a single</span>
<span class="sd">        argument (see the examples below). The passed-in object is serialized using the CloudPickle</span>
<span class="sd">        library. Any dependencies of the class should be included in one of the following locations:</span>

<span class="sd">        - The MLflow library.</span>
<span class="sd">        - Package(s) listed in the model&#39;s Conda environment, specified by the ``conda_env``</span>
<span class="sd">          parameter.</span>
<span class="sd">        - One or more of the files specified by the ``code_path`` parameter.</span>

<span class="sd">        Note: If the class is imported from another module, as opposed to being defined in the</span>
<span class="sd">        ``__main__`` scope, the defining module should also be included in one of the listed</span>
<span class="sd">        locations.</span>

<span class="sd">        **Examples**</span>

<span class="sd">        Class model</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            from typing import List</span>
<span class="sd">            import mlflow</span>


<span class="sd">            class MyModel(mlflow.pyfunc.PythonModel):</span>
<span class="sd">                def predict(self, context, model_input: List[str], params=None) -&gt; List[str]:</span>
<span class="sd">                    return [i.upper() for i in model_input]</span>


<span class="sd">            with mlflow.start_run():</span>
<span class="sd">                model_info = mlflow.pyfunc.log_model(artifact_path=&quot;model&quot;, python_model=MyModel())</span>


<span class="sd">            loaded_model = mlflow.pyfunc.load_model(model_uri=model_info.model_uri)</span>
<span class="sd">            print(loaded_model.predict([&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]))  # -&gt; [&quot;A&quot;, &quot;B&quot;, &quot;C&quot;]</span>

<span class="sd">        Functional model</span>

<span class="sd">        .. note::</span>
<span class="sd">            Experimental: Functional model support is experimental and may change or be removed in</span>
<span class="sd">            a future release without warning.</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            from typing import List</span>
<span class="sd">            import mlflow</span>


<span class="sd">            def predict(model_input: List[str]) -&gt; List[str]:</span>
<span class="sd">                return [i.upper() for i in model_input]</span>


<span class="sd">            with mlflow.start_run():</span>
<span class="sd">                model_info = mlflow.pyfunc.log_model(</span>
<span class="sd">                    artifact_path=&quot;model&quot;, python_model=predict, input_example=[&quot;a&quot;]</span>
<span class="sd">                )</span>


<span class="sd">            loaded_model = mlflow.pyfunc.load_model(model_uri=model_info.model_uri)</span>
<span class="sd">            print(loaded_model.predict([&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]))  # -&gt; [&quot;A&quot;, &quot;B&quot;, &quot;C&quot;]</span>

<span class="sd">        If the `predict` method or function has type annotations, MLflow automatically constructs</span>
<span class="sd">        a model signature based on the type annotations (unless the ``signature`` argument is</span>
<span class="sd">        explicitly specified), and converts the input value to the specified type before passing</span>
<span class="sd">        it to the function. Currently, the following type annotations are supported:</span>

<span class="sd">            - ``List[str]``</span>
<span class="sd">            - ``List[Dict[str, str]]``</span>

<span class="sd">    :param artifacts: A dictionary containing ``&lt;name, artifact_uri&gt;`` entries. Remote artifact URIs</span>
<span class="sd">                      are resolved to absolute filesystem paths, producing a dictionary of</span>
<span class="sd">                      ``&lt;name, absolute_path&gt;`` entries. ``python_model`` can reference these</span>
<span class="sd">                      resolved entries as the ``artifacts`` property of the ``context`` parameter</span>
<span class="sd">                      in :func:`PythonModel.load_context() &lt;mlflow.pyfunc.PythonModel.load_context&gt;`</span>
<span class="sd">                      and :func:`PythonModel.predict() &lt;mlflow.pyfunc.PythonModel.predict&gt;`.</span>
<span class="sd">                      For example, consider the following ``artifacts`` dictionary::</span>

<span class="sd">                        {</span>
<span class="sd">                            &quot;my_file&quot;: &quot;s3://my-bucket/path/to/my/file&quot;</span>
<span class="sd">                        }</span>

<span class="sd">                      In this case, the ``&quot;my_file&quot;`` artifact is downloaded from S3. The</span>
<span class="sd">                      ``python_model`` can then refer to ``&quot;my_file&quot;`` as an absolute filesystem</span>
<span class="sd">                      path via ``context.artifacts[&quot;my_file&quot;]``.</span>

<span class="sd">                      If ``None``, no artifacts are added to the model.</span>
<span class="sd">    :param registered_model_name: This argument may change or be removed in a</span>
<span class="sd">                                  future release without warning. If given, create a model</span>
<span class="sd">                                  version under ``registered_model_name``, also creating a</span>
<span class="sd">                                  registered model if one with the given name does not exist.</span>

<span class="sd">    :param signature: :py:class:`ModelSignature &lt;mlflow.models.ModelSignature&gt;`</span>
<span class="sd">                      describes model input and output :py:class:`Schema &lt;mlflow.types.Schema&gt;`.</span>
<span class="sd">                      The model signature can be :py:func:`inferred &lt;mlflow.models.infer_signature&gt;`</span>
<span class="sd">                      from datasets with valid model input (e.g. the training dataset with target</span>
<span class="sd">                      column omitted) and valid model output (e.g. model predictions generated on</span>
<span class="sd">                      the training dataset), for example:</span>

<span class="sd">                      .. code-block:: python</span>

<span class="sd">                        from mlflow.models import infer_signature</span>

<span class="sd">                        train = df.drop_column(&quot;target_label&quot;)</span>
<span class="sd">                        predictions = ...  # compute model predictions</span>
<span class="sd">                        signature = infer_signature(train, predictions)</span>
<span class="sd">    :param input_example: {{ input_example }}</span>
<span class="sd">    :param await_registration_for: Number of seconds to wait for the model version to finish</span>
<span class="sd">                            being created and is in ``READY`` status. By default, the function</span>
<span class="sd">                            waits for five minutes. Specify 0 or None to skip waiting.</span>
<span class="sd">    :param pip_requirements: {{ pip_requirements }}</span>
<span class="sd">    :param extra_pip_requirements: {{ extra_pip_requirements }}</span>
<span class="sd">    :param metadata: Custom metadata dictionary passed to the model and stored in the MLmodel file.</span>

<span class="sd">                     .. Note:: Experimental: This parameter may change or be removed in a future</span>
<span class="sd">                                             release without warning.</span>
<span class="sd">    :param model_config: The model configuration to apply to the model. This configuration</span>
<span class="sd">                         is available during model loading.</span>

<span class="sd">                     .. Note:: Experimental: This parameter may change or be removed in a future</span>
<span class="sd">                                             release without warning.</span>
<span class="sd">    :param example_no_conversion: {{ example_no_conversion }}</span>
<span class="sd">    :return: A :py:class:`ModelInfo &lt;mlflow.models.model.ModelInfo&gt;` instance that contains the</span>
<span class="sd">             metadata of the logged model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Model</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
        <span class="n">artifact_path</span><span class="o">=</span><span class="n">artifact_path</span><span class="p">,</span>
        <span class="n">flavor</span><span class="o">=</span><span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="p">,</span>
        <span class="n">loader_module</span><span class="o">=</span><span class="n">loader_module</span><span class="p">,</span>
        <span class="n">data_path</span><span class="o">=</span><span class="n">data_path</span><span class="p">,</span>
        <span class="n">code_path</span><span class="o">=</span><span class="n">code_path</span><span class="p">,</span>
        <span class="n">python_model</span><span class="o">=</span><span class="n">python_model</span><span class="p">,</span>
        <span class="n">artifacts</span><span class="o">=</span><span class="n">artifacts</span><span class="p">,</span>
        <span class="n">conda_env</span><span class="o">=</span><span class="n">conda_env</span><span class="p">,</span>
        <span class="n">registered_model_name</span><span class="o">=</span><span class="n">registered_model_name</span><span class="p">,</span>
        <span class="n">signature</span><span class="o">=</span><span class="n">signature</span><span class="p">,</span>
        <span class="n">input_example</span><span class="o">=</span><span class="n">input_example</span><span class="p">,</span>
        <span class="n">await_registration_for</span><span class="o">=</span><span class="n">await_registration_for</span><span class="p">,</span>
        <span class="n">pip_requirements</span><span class="o">=</span><span class="n">pip_requirements</span><span class="p">,</span>
        <span class="n">extra_pip_requirements</span><span class="o">=</span><span class="n">extra_pip_requirements</span><span class="p">,</span>
        <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
        <span class="n">model_config</span><span class="o">=</span><span class="n">model_config</span><span class="p">,</span>
        <span class="n">example_no_conversion</span><span class="o">=</span><span class="n">example_no_conversion</span><span class="p">,</span>
    <span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_save_model_with_loader_module_and_data_path</span><span class="p">(</span>
    <span class="n">path</span><span class="p">,</span>
    <span class="n">loader_module</span><span class="p">,</span>
    <span class="n">data_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">code_paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">conda_env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">mlflow_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">pip_requirements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">extra_pip_requirements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">model_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Export model as a generic Python function model.</span>
<span class="sd">    :param path: The path to which to save the Python model.</span>
<span class="sd">    :param loader_module: The name of the Python module that is used to load the model</span>
<span class="sd">                          from ``data_path``. This module must define a method with the prototype</span>
<span class="sd">                          ``_load_pyfunc(data_path)``.</span>
<span class="sd">    :param data_path: Path to a file or directory containing model data.</span>
<span class="sd">    :param code_paths: A list of local filesystem paths to Python file dependencies (or directories</span>
<span class="sd">                      containing file dependencies). These files are *prepended* to the system</span>
<span class="sd">                      path before the model is loaded.</span>
<span class="sd">    :param conda_env: Either a dictionary representation of a Conda environment or the path to a</span>
<span class="sd">                      Conda environment yaml file. If provided, this decsribes the environment</span>
<span class="sd">                      this model should be run in.</span>
<span class="sd">    :return: Model configuration containing model info.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">data_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model_file</span> <span class="o">=</span> <span class="n">_copy_file_or_tree</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">data_path</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">dst_dir</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">model_file</span>

    <span class="n">code_dir_subpath</span> <span class="o">=</span> <span class="n">_validate_and_copy_code_paths</span><span class="p">(</span><span class="n">code_paths</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mlflow_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mlflow_model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>

    <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">add_to_model</span><span class="p">(</span>
        <span class="n">mlflow_model</span><span class="p">,</span>
        <span class="n">loader_module</span><span class="o">=</span><span class="n">loader_module</span><span class="p">,</span>
        <span class="n">code</span><span class="o">=</span><span class="n">code_dir_subpath</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
        <span class="n">conda_env</span><span class="o">=</span><span class="n">_CONDA_ENV_FILE_NAME</span><span class="p">,</span>
        <span class="n">python_env</span><span class="o">=</span><span class="n">_PYTHON_ENV_FILE_NAME</span><span class="p">,</span>
        <span class="n">model_config</span><span class="o">=</span><span class="n">model_config</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">:=</span> <span class="n">get_total_file_size</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">mlflow_model</span><span class="o">.</span><span class="n">model_size_bytes</span> <span class="o">=</span> <span class="n">size</span>
    <span class="n">mlflow_model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">MLMODEL_FILE_NAME</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">conda_env</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pip_requirements</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">default_reqs</span> <span class="o">=</span> <span class="n">get_default_pip_requirements</span><span class="p">()</span>
            <span class="c1"># To ensure `_load_pyfunc` can successfully load the model during the dependency</span>
            <span class="c1"># inference, `mlflow_model.save` must be called beforehand to save an MLmodel file.</span>
            <span class="n">inferred_reqs</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">infer_pip_requirements</span><span class="p">(</span>
                <span class="n">path</span><span class="p">,</span>
                <span class="n">FLAVOR_NAME</span><span class="p">,</span>
                <span class="n">fallback</span><span class="o">=</span><span class="n">default_reqs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">default_reqs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">inferred_reqs</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">default_reqs</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default_reqs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">conda_env</span><span class="p">,</span> <span class="n">pip_requirements</span><span class="p">,</span> <span class="n">pip_constraints</span> <span class="o">=</span> <span class="n">_process_pip_requirements</span><span class="p">(</span>
            <span class="n">default_reqs</span><span class="p">,</span>
            <span class="n">pip_requirements</span><span class="p">,</span>
            <span class="n">extra_pip_requirements</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">conda_env</span><span class="p">,</span> <span class="n">pip_requirements</span><span class="p">,</span> <span class="n">pip_constraints</span> <span class="o">=</span> <span class="n">_process_conda_env</span><span class="p">(</span><span class="n">conda_env</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">_CONDA_ENV_FILE_NAME</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">yaml</span><span class="o">.</span><span class="n">safe_dump</span><span class="p">(</span><span class="n">conda_env</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Save `constraints.txt` if necessary</span>
    <span class="k">if</span> <span class="n">pip_constraints</span><span class="p">:</span>
        <span class="n">write_to</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">_CONSTRAINTS_FILE_NAME</span><span class="p">),</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pip_constraints</span><span class="p">))</span>

    <span class="c1"># Save `requirements.txt`</span>
    <span class="n">write_to</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">_REQUIREMENTS_FILE_NAME</span><span class="p">),</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pip_requirements</span><span class="p">))</span>

    <span class="n">_PythonEnv</span><span class="o">.</span><span class="n">current</span><span class="p">()</span><span class="o">.</span><span class="n">to_yaml</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">_PYTHON_ENV_FILE_NAME</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">mlflow_model</span>
</pre></div>

              </div>
            </div>
            <footer>
  

  <hr/>

  <div role="contentinfo">
      <p class="copyright">
          &copy; MLflow Project, a Series of LF Projects, LLC. All rights reserved.
      </p>

  </div> 

</footer>
          </div>
        </div>
      </section>
    </main>
  </page>

  


  
  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
      URL_ROOT:'../../',
      VERSION:'2.9.3.dev0',
      COLLAPSE_INDEX:false,
      FILE_SUFFIX:'.html',
      LINK_SUFFIX: '.html',
      HAS_SOURCE:  true
    };
  </script>

  

  <script type="text/javascript" src="../../_static/js/clipboard.min.js"></script>
  <script type="text/javascript" src="../../_static/js/jquery.waypoints.min.js"></script>

  
  
  
  <script type="text/javascript">var CLIPPY_SVG_PATH = "../../_static/clippy.svg";</script>
  <script type="text/javascript" src="../../_static/js/custom.js"></script>
  

  
  
  <script type="text/javascript">
    jQuery(function () {
      SphinxRtdTheme.StickyNav.enable();
    });

  </script>
  

  
  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }
        // Get the code block designator class entries
        const allHighlights = document.querySelectorAll('.highlight');
        // Disable copyable links for notebook cell numbering and for cell outputs
        const highlights = Array.from(allHighlights).filter(highlight => !highlight.closest('.highlight-none') && 
            !highlight.closest('.nboutput'));
    
        highlights.forEach(function(highlight) {
            const copyIcon = document.createElement('span');
            copyIcon.classList.add('copy-icon');
            copyIcon.innerHTML = '&#xf0ea;';

            copyIcon.addEventListener('click', function() {
                const code = highlight.querySelector('pre').textContent;
                copyToClipboard(code);

                // Flash effect on click
                this.style.color = '#0194E2';
                setTimeout(() => {
                    this.style.color = ''; 
                }, 100);

                // Display "Code copied to clipboard" near the clicked icon
                const message = document.createElement('span');
                message.textContent = "Copied!";
                message.classList.add('copy-message'); 

                // Append the message to the icon
                this.appendChild(message);

                setTimeout(() => {
                    this.removeChild(message);
                }, 500);
            });

            highlight.appendChild(copyIcon);
        });
    });
  </script>


<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {
        // Force download for notebook-download-btn
        const downloadButtons = document.querySelectorAll('.notebook-download-btn');
        downloadButtons.forEach(function(button) {
            button.addEventListener('click', function(event) {
                event.preventDefault(); // Prevent default behavior

                // Fetch the raw content of the notebook from GitHub
                fetch(button.href)
                    .then(response => response.blob())
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.style.display = 'none';
                        link.href = url;
                        const filename = button.href.split('/').pop();
                        link.download = filename; 

                        document.body.appendChild(link);
                        link.click();

                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(link);
                    })
                    .catch(err => console.error('Error fetching the notebook:', err));
            });
        });
    });
</script> 
</body>
</html>