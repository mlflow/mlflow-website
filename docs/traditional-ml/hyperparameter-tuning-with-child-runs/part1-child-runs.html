
  

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Understanding Parent and Child Runs in MLflow &mdash; MLflow 2.9.3.dev0 documentation</title>
  
   
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="canonical" href="https://mlflow.org/docs/latest/traditional-ml/hyperparameter-tuning-with-child-runs/part1-child-runs.html">
  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    

    

  
    

  

  
  
    

  

  
  
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600" rel="stylesheet">
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/cards.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/grids.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/mobile.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/simple-cards.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/tabs.css" type="text/css" />
    
  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="MLflow 2.9.3.dev0 documentation" href="../../index.html"/>
        <link rel="up" title="Hyperparameter Tuning with MLflow and Optuna" href="index.html"/>
        <link rel="next" title="Leveraging Visualizations and MLflow for In-depth Model Analysis" href="/part2-logging-plots.html"/>
        <link rel="prev" title="Logging Visualizations with MLflow" href="/notebooks/logging-plots-in-mlflow.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>
<script type="text/javascript" src="../../_static/jquery.js"></script>
<script type="text/javascript" src="../../_static/underscore.js"></script>
<script type="text/javascript" src="../../_static/doctools.js"></script>
<script type="text/javascript" src="../../_static/languagesections.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>

<body class="wy-body-for-nav" role="document">
  

  
  <nav class="wy-nav-top header" role="navigation" aria-label="top navigation">
    <ul>
  <li class="menu-toggle">
    <i data-toggle="wy-nav-top" class="wy-nav-top-menu-button db-icon db-icon-menu pull-left"></i>
    <a href="../../index.html" class="wy-nav-top-logo"
      ><img src="../../_static/MLflow-logo-final-black.png" alt="MLflow"
    /></a>
    <span class="version">2.9.3.dev0</span>
  </li>
</ul>
  </nav>
  <page>
    

    <nav data-toggle="wy-nav-shift" class="wy-nav-side relative">
      <div class="wy-side-scroll">
  <div class="wy-side-nav-search">
    

    

    
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
  </form>
</div>


    
  </div>

  <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
    
      <a href="../../index.html" class="main-navigation-home"><img src="../../_static/icons/nav-home.svg"> MLflow</a>
    

    
      

      
        <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction/index.html">What is MLflow?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/index.html">Getting Started with MLflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../new-features/index.html">New Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../llms/index.html">LLMs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model-evaluation/index.html">Model Evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deep-learning/index.html">Deep Learning</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Traditional ML</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#native-library-support">Native Library Support</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#tutorials-and-guides">Tutorials and Guides</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Hyperparameter Tuning with MLflow and Optuna</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="notebooks/index.html">Full Notebooks</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">The Parent-Child relationship with runs</a></li>
<li class="toctree-l4"><a class="reference internal" href="part2-logging-plots.html">Logging plots with MLflow</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../creating-custom-pyfunc/index.html">Building Custom Python Function Models with MLflow</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#mlflow-tracking">MLflow Tracking</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#mlflow-recipes">MLflow Recipes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#mlflow-evaluate">MLflow Evaluate</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#model-registry">Model Registry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#deployment">Deployment</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../deployment/index.html">Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tracking.html">MLflow Tracking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../system-metrics/index.html">System Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../projects.html">MLflow Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../models.html">MLflow Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model-registry.html">MLflow Model Registry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../recipes.html">MLflow Recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plugins.html">MLflow Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../auth/index.html">MLflow Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli.html">Command-Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../search-runs.html">Search Runs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../search-experiments.html">Search Experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python_api/index.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../R-api.html">R API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../java_api/index.html">Java API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rest-api.html">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docker.html">Official MLflow Docker Image</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community-model-flavors.html">Community Model Flavors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials-and-examples/index.html">Tutorials and Examples</a></li>
</ul>

      
    
  </div>

  <div role="contentinfo">
    

    <p>
      <a id='feedbacklink' href="https://github.com/mlflow/mlflow/blob/master/CONTRIBUTING.md" target="_blank">Contribute</a>
    </p>
  </div>
</div>
    </nav>

    <main class="wy-grid-for-nav">
      <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
        <div class="wy-nav-content">
          <div class="rst-content">
            










<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Documentation</a> <span class="db-icon db-icon-chevron-right"></span></li>
    
        <li><a href="../index.html">Traditional ML</a> <span class="db-icon db-icon-chevron-right"></span></li>
    
        <li><a href="index.html">Hyperparameter Tuning with MLflow and Optuna</a> <span class="db-icon db-icon-chevron-right"></span></li>
    
    
      <li>Understanding Parent and Child Runs in MLflow</li>
    
    
    <!-- <li class="wy-breadcrumbs-aside">
      <a href="https://github.com/mlflow/mlflow/blob/master/docs/source/traditional-ml/hyperparameter-tuning-with-child-runs/part1-child-runs.rst" class="fa fa-github"> Edit on GitHub</a>
    </li> -->
    
  </ul>
</div>
            <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
              <div itemprop="articleBody">
                
  <div class="section" id="understanding-parent-and-child-runs-in-mlflow">
<h1>Understanding Parent and Child Runs in MLflow<a class="headerlink" href="#understanding-parent-and-child-runs-in-mlflow" title="Permalink to this headline"> </a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline"> </a></h2>
<p>Machine learning projects often involve intricate relationships. These connections can emerge at
various stages, be it the project’s conception, during data preprocessing, in the model’s architecture,
or even during the model’s tuning process. MLflow provides tools to efficiently capture and represent
these relationships.</p>
</div>
<div class="section" id="core-concepts-of-mlflow-tags-experiments-and-runs">
<h2>Core Concepts of MLflow: Tags, Experiments, and Runs<a class="headerlink" href="#core-concepts-of-mlflow-tags-experiments-and-runs" title="Permalink to this headline"> </a></h2>
<p>In our foundational MLflow tutorial, we highlighted a fundamental relationship: the association
between <strong>tags</strong>, <strong>experiments</strong>, and <strong>runs</strong>. This association is crucial when dealing with
complex ML projects, such as forecasting models for individual products in a supermarket, as
presented in our example. The diagram below offers a visual representation:</p>
<div class="figure align-center" id="id1">
<a class="reference internal image-reference" href="../../_images/tag-exp-run-relationship.svg"><img alt="Tags, experiments, and runs relationships" src="../../_images/tag-exp-run-relationship.svg" width="1024px" /></a>
<p class="caption"><span class="caption-text">A model grouping hierarchy</span><a class="headerlink" href="#id1" title="Permalink to this image"> </a></p>
</div>
<div class="section" id="key-aspects">
<h3>Key Aspects<a class="headerlink" href="#key-aspects" title="Permalink to this headline"> </a></h3>
<ul class="simple">
<li><p><strong>Tags</strong>: These are instrumental in defining business-level filtering keys. They aid in retrieving relevant experiments and their runs.</p></li>
<li><p><strong>Experiments</strong>: They set boundaries, both from a business perspective and data-wise. For instance, sales data for carrots wouldn’t be used to predict sales of apples without prior validation.</p></li>
<li><p><strong>Runs</strong>: Each run captures a specific hypothesis or iteration of training, nestled within the context of the experiment.</p></li>
</ul>
</div>
</div>
<div class="section" id="the-real-world-challenge-hyperparameter-tuning">
<h2>The Real-world Challenge: Hyperparameter Tuning<a class="headerlink" href="#the-real-world-challenge-hyperparameter-tuning" title="Permalink to this headline"> </a></h2>
<p>While the above model suffices for introductory purposes, real-world scenarios introduce complexities. One such complexity arises when tuning models.</p>
<p>Model tuning is paramount. Methods range from grid search (though typically not recommended due to
inefficiencies) to random searches, and more advanced approaches like automated hyperparameter tuning.
The objective remains the same: to optimally traverse the model’s parameter space.</p>
<div class="section" id="benefits-of-hyperparameter-tuning">
<h3>Benefits of Hyperparameter Tuning<a class="headerlink" href="#benefits-of-hyperparameter-tuning" title="Permalink to this headline"> </a></h3>
<ul class="simple">
<li><p><strong>Loss Metric Relationship</strong>: By analyzing the relationship between hyperparameters and optimization loss metrics, we can discern potentially irrelevant parameters.</p></li>
<li><p><strong>Parameter Space Analysis</strong>: Monitoring the range of tested values can indicate if we need to constrict or expand our search space.</p></li>
<li><p><strong>Model Sensitivity Analysis</strong>: Estimating how a model reacts to specific parameters can pinpoint potential feature set issues.</p></li>
</ul>
<p>But here lies the challenge: How do we systematically store the extensive data produced during hyperparameter tuning?</p>
<div class="figure align-center" id="id2">
<a class="reference internal image-reference" href="../../_images/what-to-do-with-hyperparam-runs.svg"><img alt="Challenges with hyperparameter data storage" src="../../_images/what-to-do-with-hyperparam-runs.svg" width="1024px" /></a>
<p class="caption"><span class="caption-text">The quandary of storing hyperparameter data</span><a class="headerlink" href="#id2" title="Permalink to this image"> </a></p>
</div>
<p>In the upcoming sections, we’ll delve deeper, exploring MLflow’s capabilities to address this
challenge, focusing on the concepts of Parent and Child Runs.</p>
</div>
</div>
<div class="section" id="what-are-parent-and-child-runs">
<h2>What are Parent and Child Runs?<a class="headerlink" href="#what-are-parent-and-child-runs" title="Permalink to this headline"> </a></h2>
<p>At its core, MLflow allows users to track experiments, which are essentially named groups of runs.
A “run” in this context refers to a single execution of a model training event, where you can log
parameters, metrics, tags, and artifacts associated with the training process.
The concept of Parent and Child Runs introduces a hierarchical structure to these runs.</p>
<p>Imagine a scenario where you’re testing a deep learning model with different architectures. Each
architecture can be considered a parent run, and every iteration of hyperparameter tuning for that
architecture becomes a child run nested under its respective parent.</p>
</div>
<div class="section" id="benefits">
<h2>Benefits<a class="headerlink" href="#benefits" title="Permalink to this headline"> </a></h2>
<ol class="arabic simple">
<li><p><strong>Organizational Clarity</strong>: By using Parent and Child Runs, you can easily group related runs together. For instance, if you’re running a hyperparameter search using a Bayesian approach on a particular model architecture, every iteration can be logged as a child run, while the overarching Bayesian optimization process can be the parent run.</p></li>
<li><p><strong>Enhanced Traceability</strong>: When working on large projects with a broad product hierarchy, child runs can represent individual products or variants, making it straightforward to trace back results, metrics, or artifacts to their specific run.</p></li>
<li><p><strong>Scalability</strong>: As your experiments grow in number and complexity, having a nested structure ensures that your tracking remains scalable. It’s much easier to navigate through a structured hierarchy than a flat list of hundreds or thousands of runs.</p></li>
<li><p><strong>Improved Collaboration</strong>: For teams, this approach ensures that members can easily understand the structure and flow of experiments conducted by their peers, promoting collaboration and knowledge sharing.</p></li>
</ol>
</div>
<div class="section" id="relationship-between-experiments-parent-runs-and-child-runs">
<h2>Relationship between Experiments, Parent Runs, and Child Runs<a class="headerlink" href="#relationship-between-experiments-parent-runs-and-child-runs" title="Permalink to this headline"> </a></h2>
<ul class="simple">
<li><p><strong>Experiments</strong>: Consider experiments as the topmost layer. They are named entities under which all related runs reside. For instance, an experiment named “Deep Learning Architectures” might contain runs related to various architectures you’re testing.</p></li>
<li><p><strong>Parent Runs</strong>: Within an experiment, a parent run represents a significant segment or phase of your workflow. Taking the earlier example, each specific architecture (like CNN, RNN, or Transformer) can be a parent run.</p></li>
<li><p><strong>Child Runs</strong>: Nested within parent runs are child runs. These are iterations or variations within the scope of their parent. For a CNN parent run, different sets of hyperparameters or slight architectural tweaks can each be a child run.</p></li>
</ul>
</div>
<div class="section" id="practical-example">
<h2>Practical Example<a class="headerlink" href="#practical-example" title="Permalink to this headline"> </a></h2>
<p>For this example, let’s image that we’re working through a fine-tuning exercise for a particular modeling solution.
We’re going through the tuning phase of rough adjustments initially, attempting to determine which parameter ranges and
categorical selection values that we might want to consider for a full hyperparameter tuning run with a much higher
iteration count.</p>
<div class="section" id="naive-approach-with-no-child-runs">
<h3>Naive Approach with no child runs<a class="headerlink" href="#naive-approach-with-no-child-runs" title="Permalink to this headline"> </a></h3>
<p>In this first phase, we will be trying relatively small batches of different combinations of parameters and
evaluating them within the MLflow UI to determine whether we should include or exempt certain values based on the
relatively performance amongst our iterative trials.</p>
<p>If we were to use each iteration as its own MLflow run, our code might look something like this:</p>
<div class="code-section docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">starmap</span>
<span class="kn">from</span> <span class="nn">more_itertools</span> <span class="kn">import</span> <span class="n">consume</span>


<span class="c1"># Define a function to log parameters and metrics</span>
<span class="k">def</span> <span class="nf">log_run</span><span class="p">(</span><span class="n">run_name</span><span class="p">,</span> <span class="n">test_no</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">(</span><span class="n">run_name</span><span class="o">=</span><span class="n">run_name</span><span class="p">):</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s2">&quot;param1&quot;</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">]))</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s2">&quot;param2&quot;</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">]))</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;metric1&quot;</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;metric2&quot;</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">gauss</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)))</span>


<span class="c1"># Generate run names</span>
<span class="k">def</span> <span class="nf">generate_run_names</span><span class="p">(</span><span class="n">test_no</span><span class="p">,</span> <span class="n">num_runs</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_test_</span><span class="si">{</span><span class="n">test_no</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_runs</span><span class="p">))</span>


<span class="c1"># Execute tuning function</span>
<span class="k">def</span> <span class="nf">execute_tuning</span><span class="p">(</span><span class="n">test_no</span><span class="p">):</span>
    <span class="c1"># Partial application of the log_run function</span>
    <span class="n">log_current_run</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">log_run</span><span class="p">,</span> <span class="n">test_no</span><span class="o">=</span><span class="n">test_no</span><span class="p">)</span>
    <span class="c1"># Generate run names and apply log_current_run function to each run name</span>
    <span class="n">runs</span> <span class="o">=</span> <span class="n">starmap</span><span class="p">(</span>
        <span class="n">log_current_run</span><span class="p">,</span> <span class="p">((</span><span class="n">run_name</span><span class="p">,)</span> <span class="k">for</span> <span class="n">run_name</span> <span class="ow">in</span> <span class="n">generate_run_names</span><span class="p">(</span><span class="n">test_no</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="c1"># Consume the iterator to execute the runs</span>
    <span class="n">consume</span><span class="p">(</span><span class="n">runs</span><span class="p">)</span>


<span class="c1"># Set the tracking uri and experiment</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">set_tracking_uri</span><span class="p">(</span><span class="s2">&quot;http://localhost:8080&quot;</span><span class="p">)</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="s2">&quot;No Child Runs&quot;</span><span class="p">)</span>

<span class="c1"># Execute 5 hyperparameter tuning runs</span>
<span class="n">consume</span><span class="p">(</span><span class="n">starmap</span><span class="p">(</span><span class="n">execute_tuning</span><span class="p">,</span> <span class="p">((</span><span class="n">x</span><span class="p">,)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))))</span>
</pre></div>
</div>
</div>
<p>After executing this, we can navigate to the MLflow UI to see the results of the iterations and compare each run’s
error metrics to the parameters that were selected.</p>
<div class="figure align-center" id="id3">
<a class="reference internal image-reference" href="../../_images/no-child-first.gif"><img alt="Hyperparameter tuning no child runs" src="../../_images/no-child-first.gif" style="width: 1024px;" /></a>
<p class="caption"><span class="caption-text">Initial Hyperparameter tuning execution</span><a class="headerlink" href="#id3" title="Permalink to this image"> </a></p>
</div>
<p>What happens when we need to run this again with some slight modifications?</p>
<p>Our code might change in-place with the values being tested:</p>
<div class="code-section docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">log_run</span><span class="p">(</span><span class="n">run_name</span><span class="p">,</span> <span class="n">test_no</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">(</span><span class="n">run_name</span><span class="o">=</span><span class="n">run_name</span><span class="p">):</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s2">&quot;param1&quot;</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">]))</span>  <span class="c1"># remove &#39;b&#39;</span>
        <span class="c1"># remainder of code ...</span>
</pre></div>
</div>
</div>
<p>When we execute this and navigate back to the UI, it is now significantly more difficult to determine
which run results are associated with a particular parameter grouping. For this example, it isn’t
particularly problematic since the features are identical and the parameter search space is a subset of the
original hyperparameter test.</p>
<p>This may become a serious problem for analysis if we:</p>
<ul class="simple">
<li><p>Add terms to the original hyperparameter search space</p></li>
<li><p>Modify the feature data (add or remove features)</p></li>
<li><p>Change the underlying model architecture (test 1 is a Random Forest model, while test 2 is a Gradient Boosted Trees model)</p></li>
</ul>
<p>Let’s take a look at the UI and see if it is clear which iteration a particular run is a member of.</p>
<div class="figure align-center" id="id4">
<a class="reference internal image-reference" href="../../_images/no-child-more.gif"><img alt="Adding more runs" src="../../_images/no-child-more.gif" style="width: 1024px;" /></a>
<p class="caption"><span class="caption-text">Challenges with iterative tuning without child run encapsulation</span><a class="headerlink" href="#id4" title="Permalink to this image"> </a></p>
</div>
<p>It’s not too hard to imagine how complicated this can become if there are thousands of runs in this experiment.</p>
<p>There is a solution for this, though. We can setup the exact same testing scenario with few small modifications to make it easy to find
related runs, declutter the UI, and greatly simplify the overall process of evaluating hyperparameter ranges and parameter inclusions
during the process of tuning. Only a few modification are needed:</p>
<ul class="simple">
<li><p>Use child runs by adding a nested <code class="docutils literal notranslate"><span class="pre">start_run()</span></code> context within a parent run’s context.</p></li>
<li><p>Add disambiguation information to the runs in the form of modifying the <code class="docutils literal notranslate"><span class="pre">run_name</span></code> of the parent run</p></li>
<li><p>Add tag information to the parent and child runs to enable searching on keys that identify a family of runs</p></li>
</ul>
</div>
<div class="section" id="adapting-for-parent-and-child-runs">
<h3>Adapting for Parent and Child Runs<a class="headerlink" href="#adapting-for-parent-and-child-runs" title="Permalink to this headline"> </a></h3>
<p>The code below demonstrates these modifications to our original hyperparameter tuning example.</p>
<div class="code-section docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">starmap</span>
<span class="kn">from</span> <span class="nn">more_itertools</span> <span class="kn">import</span> <span class="n">consume</span>


<span class="c1"># Define a function to log parameters and metrics and add tag</span>
<span class="c1"># logging for search_runs functionality</span>
<span class="k">def</span> <span class="nf">log_run</span><span class="p">(</span><span class="n">run_name</span><span class="p">,</span> <span class="n">test_no</span><span class="p">,</span> <span class="n">param1_choices</span><span class="p">,</span> <span class="n">param2_choices</span><span class="p">,</span> <span class="n">tag_ident</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">(</span><span class="n">run_name</span><span class="o">=</span><span class="n">run_name</span><span class="p">,</span> <span class="n">nested</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s2">&quot;param1&quot;</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">param1_choices</span><span class="p">))</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s2">&quot;param2&quot;</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">param2_choices</span><span class="p">))</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;metric1&quot;</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;metric2&quot;</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">gauss</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)))</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="s2">&quot;test_identifier&quot;</span><span class="p">,</span> <span class="n">tag_ident</span><span class="p">)</span>


<span class="c1"># Generate run names</span>
<span class="k">def</span> <span class="nf">generate_run_names</span><span class="p">(</span><span class="n">test_no</span><span class="p">,</span> <span class="n">num_runs</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_test_</span><span class="si">{</span><span class="n">test_no</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_runs</span><span class="p">))</span>


<span class="c1"># Execute tuning function, allowing for param overrides,</span>
<span class="c1"># run_name disambiguation, and tagging support</span>
<span class="k">def</span> <span class="nf">execute_tuning</span><span class="p">(</span>
    <span class="n">test_no</span><span class="p">,</span>
    <span class="n">param1_choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">],</span>
    <span class="n">param2_choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">],</span>
    <span class="n">test_identifier</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">ident</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">test_identifier</span> <span class="k">else</span> <span class="n">test_identifier</span>
    <span class="c1"># Use a parent run to encapsulate the child runs</span>
    <span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">(</span><span class="n">run_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;parent_run_test_</span><span class="si">{</span><span class="n">ident</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">test_no</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
        <span class="c1"># Partial application of the log_run function</span>
        <span class="n">log_current_run</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
            <span class="n">log_run</span><span class="p">,</span>
            <span class="n">test_no</span><span class="o">=</span><span class="n">test_no</span><span class="p">,</span>
            <span class="n">param1_choices</span><span class="o">=</span><span class="n">param1_choices</span><span class="p">,</span>
            <span class="n">param2_choices</span><span class="o">=</span><span class="n">param2_choices</span><span class="p">,</span>
            <span class="n">tag_ident</span><span class="o">=</span><span class="n">ident</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="s2">&quot;test_identifier&quot;</span><span class="p">,</span> <span class="n">ident</span><span class="p">)</span>
        <span class="c1"># Generate run names and apply log_current_run function to each run name</span>
        <span class="n">runs</span> <span class="o">=</span> <span class="n">starmap</span><span class="p">(</span>
            <span class="n">log_current_run</span><span class="p">,</span> <span class="p">((</span><span class="n">run_name</span><span class="p">,)</span> <span class="k">for</span> <span class="n">run_name</span> <span class="ow">in</span> <span class="n">generate_run_names</span><span class="p">(</span><span class="n">test_no</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="c1"># Consume the iterator to execute the runs</span>
        <span class="n">consume</span><span class="p">(</span><span class="n">runs</span><span class="p">)</span>


<span class="c1"># Set the tracking uri and experiment</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">set_tracking_uri</span><span class="p">(</span><span class="s2">&quot;http://localhost:8080&quot;</span><span class="p">)</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="s2">&quot;Nested Child Association&quot;</span><span class="p">)</span>

<span class="c1"># Define custom parameters</span>
<span class="n">param_1_values</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span>
<span class="n">param_2_values</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">]</span>

<span class="c1"># Execute hyperparameter tuning runs with custom parameter choices</span>
<span class="n">consume</span><span class="p">(</span>
    <span class="n">starmap</span><span class="p">(</span><span class="n">execute_tuning</span><span class="p">,</span> <span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">param_1_values</span><span class="p">,</span> <span class="n">param_2_values</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)))</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>We can view the results of executing this in the UI:</p>
<p>The real benefit of this nested architecture becomes much more apparent when we add additional runs
with different conditions of hyperparameter selection criteria.</p>
<div class="code-section docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Execute modified hyperparameter tuning runs with custom parameter choices</span>
<span class="n">param_1_values</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">]</span>
<span class="n">param_2_values</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">]</span>
<span class="n">ident</span> <span class="o">=</span> <span class="s2">&quot;params_test_2&quot;</span>
<span class="n">consume</span><span class="p">(</span>
    <span class="n">starmap</span><span class="p">(</span>
        <span class="n">execute_tuning</span><span class="p">,</span> <span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">param_1_values</span><span class="p">,</span> <span class="n">param_2_values</span><span class="p">,</span> <span class="n">ident</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>… and even more runs …</p>
<div class="code-section docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">param_1_values</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">]</span>
<span class="n">param_2_values</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">]</span>
<span class="n">ident</span> <span class="o">=</span> <span class="s2">&quot;params_test_3&quot;</span>
<span class="n">consume</span><span class="p">(</span>
    <span class="n">starmap</span><span class="p">(</span>
        <span class="n">execute_tuning</span><span class="p">,</span> <span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">param_1_values</span><span class="p">,</span> <span class="n">param_2_values</span><span class="p">,</span> <span class="n">ident</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>Once we execute these three tuning run tests, we can view the results in the UI:</p>
<div class="figure align-center" id="id5">
<a class="reference internal image-reference" href="../../_images/child-runs.gif"><img alt="Using child runs" src="../../_images/child-runs.gif" style="width: 860px;" /></a>
<p class="caption"><span class="caption-text">Encapsulating tests with child runs</span><a class="headerlink" href="#id5" title="Permalink to this image"> </a></p>
</div>
<p>In the above video, you can see that we purposefully avoided including the parent run in the run comparison.
This is due to the fact that no metrics or parameters were actually written to these parent runs; rather, they
were used purely for organizational purposes to limit the volume of runs visible within the UI.</p>
<p>In practice, it is best to store the best conditions found with a hyperparamter execution of child runs within
the parent’s run data.</p>
</div>
</div>
<div class="section" id="challenge">
<h2>Challenge<a class="headerlink" href="#challenge" title="Permalink to this headline"> </a></h2>
<p>As an exercise, if you are interested, you may download the notebook with these two examples and modify the
code within in order to achieve this.</p>
<a href="https://raw.githubusercontent.com/mlflow/mlflow/master/docs/source/traditional-ml/hyperparameter-tuning-with-child-runs/notebooks/parent-child-runs.ipynb" class="notebook-download-btn">Download the notebook</a><p>The notebook contains an example implementation of this, but it is
recommended to develop your own implementation that fulfills the following requirements:</p>
<ul class="simple">
<li><p>Record the lowest metric1 value amongst the children and the associated parameters with that child run in the parent run’s information.</p></li>
<li><p>Add the ability to specify an iteration count to the number of children created from the calling entry point.</p></li>
</ul>
<p>The results in the UI for this challenge are shown below.</p>
<div class="figure align-center" id="id6">
<a class="reference internal image-reference" href="../../_images/parent-child-challenge.gif"><img alt="Challenge" src="../../_images/parent-child-challenge.gif" style="width: 860px;" /></a>
<p class="caption"><span class="caption-text">Adding best child run data to parent run</span><a class="headerlink" href="#id6" title="Permalink to this image"> </a></p>
</div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline"> </a></h2>
<p>The usage of parent and child runs associations can greatly simplify iterative model development.
With repetitive and high-data-volume tasks such as hyperparameter tuning, encapsulating a training run’s
parameter search space or feature engineering evaluation runs can help to ensure that you’re comparing
exactly what you intend to compare, all with minimal effort.</p>
</div>
</div>


              </div>
            </div>
            <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="notebooks/logging-plots-in-mlflow.html" class="btn btn-neutral" title="Logging Visualizations with MLflow" accesskey="p"><span class="db-icon db-icon-chevron-left"></span> Previous</a>
      
      
        <a href="part2-logging-plots.html" class="btn btn-neutral" title="Leveraging Visualizations and MLflow for In-depth Model Analysis" accesskey="n">Next <span class="db-icon db-icon-chevron-right"></span></a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
      <p class="copyright">
          &copy; MLflow Project, a Series of LF Projects, LLC. All rights reserved.
      </p>

  </div> 

</footer>
          </div>
        </div>
      </section>
    </main>
  </page>

  


  
  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
      URL_ROOT:'../../',
      VERSION:'2.9.3.dev0',
      COLLAPSE_INDEX:false,
      FILE_SUFFIX:'.html',
      LINK_SUFFIX: '.html',
      HAS_SOURCE:  true
    };
  </script>

  

  <script type="text/javascript" src="../../_static/js/clipboard.min.js"></script>
  <script type="text/javascript" src="../../_static/js/jquery.waypoints.min.js"></script>

  
  
  
  <script type="text/javascript">var CLIPPY_SVG_PATH = "../../_static/clippy.svg";</script>
  <script type="text/javascript" src="../../_static/js/custom.js"></script>
  

  
  
  <script type="text/javascript">
    jQuery(function () {
      SphinxRtdTheme.StickyNav.enable();
    });

  </script>
  

  
  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }
        // Get the code block designator class entries
        const allHighlights = document.querySelectorAll('.highlight');
        // Disable copyable links for notebook cell numbering and for cell outputs
        const highlights = Array.from(allHighlights).filter(highlight => !highlight.closest('.highlight-none') && 
            !highlight.closest('.nboutput'));
    
        highlights.forEach(function(highlight) {
            const copyIcon = document.createElement('span');
            copyIcon.classList.add('copy-icon');
            copyIcon.innerHTML = '&#xf0ea;';

            copyIcon.addEventListener('click', function() {
                const code = highlight.querySelector('pre').textContent;
                copyToClipboard(code);

                // Flash effect on click
                this.style.color = '#0194E2';
                setTimeout(() => {
                    this.style.color = ''; 
                }, 100);

                // Display "Code copied to clipboard" near the clicked icon
                const message = document.createElement('span');
                message.textContent = "Copied!";
                message.classList.add('copy-message'); 

                // Append the message to the icon
                this.appendChild(message);

                setTimeout(() => {
                    this.removeChild(message);
                }, 500);
            });

            highlight.appendChild(copyIcon);
        });
    });
  </script>


<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {
        // Force download for notebook-download-btn
        const downloadButtons = document.querySelectorAll('.notebook-download-btn');
        downloadButtons.forEach(function(button) {
            button.addEventListener('click', function(event) {
                event.preventDefault(); // Prevent default behavior

                // Fetch the raw content of the notebook from GitHub
                fetch(button.href)
                    .then(response => response.blob())
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.style.display = 'none';
                        link.href = url;
                        const filename = button.href.split('/').pop();
                        link.download = filename; 

                        document.body.appendChild(link);
                        link.click();

                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(link);
                    })
                    .catch(err => console.error('Error fetching the notebook:', err));
            });
        });
    });
</script> 
</body>
</html>